<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF-Crypto要点, JackHCC">
    <meta name="description" content="CTF密码学学习要点">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CTF-Crypto要点 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF-Crypto要点</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF-Cryptography/">
                                <span class="chip bg-color">CTF-Cryptography</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    67.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    316 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="密码学简介"><a href="#密码学简介" class="headerlink" title="密码学简介"></a>密码学简介</h1><p>密码学（Cryptography）一般可分为古典密码学和现代密码学。</p>
<p>其中，古典密码学，作为一种实用性艺术存在，其编码和破译通常依赖于设计者和敌手的创造力与技巧，并没有对密码学原件进行清晰的定义。古典密码学主要包含以下几个方面：</p>
<ul>
<li>单表替换加密（Monoalphabetic Cipher）</li>
<li>多表替换加密（Polyalphabetic Cipher）</li>
<li>奇奇怪怪的加密方式</li>
</ul>
<p>而现代密码学则起源于 20 世纪中后期出现的大量相关理论，1949 年香农（C. E. Shannon）发表了题为《保密系统的通信理论》的经典论文标志着现代密码学的开始。现代密码学主要包含以下几个方面：</p>
<ul>
<li>对称加密（Symmetric Cryptography），以 DES，AES，RC4 为代表。</li>
<li>非对称加密（Asymmetric Cryptography），以 RSA，ElGamal，椭圆曲线加密为代表。</li>
<li>哈希函数（Hash Function），以 MD5，SHA-1，SHA-512 等为代表。</li>
<li>数字签名（Digital Signature），以 RSA 签名，ElGamal 签名，DSA 签名为代表。</li>
</ul>
<p>其中，对称加密体制主要分为两种方式：</p>
<ul>
<li>分组密码（Block Cipher），又称为块密码。</li>
<li>序列密码（Stream Cipher），又称为流密码。</li>
</ul>
<p>一般来说，密码设计者的根本目标是保障信息及信息系统的</p>
<ul>
<li>机密性（Confidentiality）</li>
<li>完整性（Integrity）</li>
<li>可用性（Availability）</li>
<li>认证性（Authentication）</li>
<li>不可否认性（Non-repudiation）</li>
</ul>
<p>其中，前三者被称为信息安全的 CIA 三要素 。</p>
<p>而对于密码破解者来说，一般是要想办法识别出密码算法，然后进行暴力破解，或者利用密码体制的漏洞进行破解。当然，也有可能通过构造虚假的哈希值或者数字签名来绕过相应的检测。</p>
<p>一般来说，我们都会假设攻击者已知待破解的密码体制，而攻击类型通常分为以下四种：</p>
<table>
<thead>
<tr>
<th align="left">攻击类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">唯密文攻击</td>
<td align="left">只拥有密文</td>
</tr>
<tr>
<td align="left">已知明文攻击</td>
<td align="left">拥有密文与对应的明文</td>
</tr>
<tr>
<td align="left">选择明文攻击</td>
<td align="left">拥有加密权限，能够对明文加密后获得相应密文</td>
</tr>
<tr>
<td align="left">选择密文攻击</td>
<td align="left">拥有解密权限，能够对密文解密后获得相应明文</td>
</tr>
</tbody></table>
<blockquote>
<p>Note</p>
<p>注：之前在这里曾写过这些攻击常见的场景，随着不断地学习，渐渐意识到这些攻击类型侧重描述攻击者的能力，有可能适用于各种各样的场景。故进行修正。</p>
</blockquote>
<p>这里推荐一些资料</p>
<ul>
<li><a href="http://open.163.com/special/Khan/moderncryptography.html" target="_blank" rel="noopener">可汗学院公开课</a></li>
<li><a href="https://github.com/yuankeyang/python/blob/master/《深入浅出密码学——常用加密技术原理与应用》.pdf" target="_blank" rel="noopener">深入浅出密码学——常用加密技术原理与应用</a></li>
<li><a href="https://cryptopals.com/，一堆密码学的练习题目。" target="_blank" rel="noopener">https://cryptopals.com/，一堆密码学的练习题目。</a></li>
</ul>
<h1 id="古典密码简介"><a href="#古典密码简介" class="headerlink" title="古典密码简介"></a>古典密码简介</h1><p>在古典密码学中，我们主要介绍单表替代密码，多表替代密码，以及一些其它比较有意思的密码。</p>
<p>值得一提的是，在古典密码学中，设计者主要考虑消息的保密性，使得只有相关密钥的人才可以解密密文获得消息的内容，对于消息的完整性和不可否认性则并没有进行太多的考虑。</p>
<ul>
<li>拓展阅读<ul>
<li><a href="http://www.tuicool.com/articles/2E3INnm" target="_blank" rel="noopener">CTF 中那些脑洞大开的编码和加密</a></li>
<li><a href="http://www.oscca.gov.cn/sca/zxfw/2017-04/24/content_1011709.shtml" target="_blank" rel="noopener">古典密码学发展史</a></li>
<li><a href="https://zh.wikipedia.org/wiki/古典密碼" target="_blank" rel="noopener">古典密码——维基百科</a></li>
</ul>
</li>
</ul>
<h1 id="单表代换加密"><a href="#单表代换加密" class="headerlink" title="单表代换加密"></a>单表代换加密</h1><h2 id="通用特点"><a href="#通用特点" class="headerlink" title="通用特点"></a>通用特点</h2><p>在单表替换加密中，所有的加密方式几乎都有一个共性，那就是明密文一一对应。所以说，一般有以下两种方式来进行破解</p>
<ul>
<li>在密钥空间较小的情况下，采用暴力破解方式</li>
<li>在密文长度足够长的时候，使用词频分析，<a href="http://quipqiup.com/" target="_blank" rel="noopener">http://quipqiup.com/</a></li>
</ul>
<p>当密钥空间足够大，而密文长度足够短的情况下，破解较为困难。</p>
<h2 id="凯撒密码"><a href="#凯撒密码" class="headerlink" title="凯撒密码"></a>凯撒密码</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>凯撒密码（Caesar）加密时会将明文中的 <strong>每个字母</strong> 都按照其在字母表中的顺序向后（或向前）移动固定数目（<strong>循环移动</strong>）作为密文。例如，当偏移量是左移 3 的时候（解密时的密钥就是 3）：</p>
<pre><code>明文字母表：ABCDEFGHIJKLMNOPQRSTUVWXYZ
密文字母表：DEFGHIJKLMNOPQRSTUVWXYZABC</code></pre><p>使用时，加密者查找明文字母表中需要加密的消息中的每一个字母所在位置，并且写下密文字母表中对应的字母。需要解密的人则根据事先已知的密钥反过来操作，得到原来的明文。例如：</p>
<pre><code>明文：THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG
密文：WKH TXLFN EURZQ IRA MXPSV RYHU WKH ODCB GRJ</code></pre><p>根据偏移量的不同，还存在<strong>若干特定的恺撒密码名称</strong>：</p>
<ul>
<li>偏移量为 10：Avocat （A→K）</li>
<li>偏移量为 13：<a href="https://zh.wikipedia.org/wiki/ROT13" target="_blank" rel="noopener">ROT13</a></li>
<li>偏移量为 -5：Cassis （K 6）</li>
<li>偏移量为 -6：Cassette （K 7）</li>
</ul>
<p>此外，还有还有一种基于密钥的凯撒密码 Keyed Caesar。其基本原理是 <strong>利用一个密钥，将密钥的每一位转换为数字（一般转化为字母表对应顺序的数字），分别以这一数字为密钥加密明文的每一位字母。</strong></p>
<p>这里以 <strong>XMan 一期夏令营分享赛宫保鸡丁队 Crypto 100</strong> 为例进行介绍。</p>
<pre><code>密文：s0a6u3u1s0bv1a
密钥：guangtou
偏移：6,20,0,13,6,19,14,20
明文：y0u6u3h1y0uj1u</code></pre><h3 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h3><ol>
<li>遍历 26 个偏移量，适用于普遍情况</li>
<li>利用词频分析，适用于密文较长的情况。</li>
</ol>
<p>其中，第一种方式肯定可以得到明文，而第二种方式则不一定可以得到正确的明文。</p>
<p>而对于基于密钥的凯撒密码来说，一般来说必须知道对应的密钥。</p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>一般我们有如下的工具，其中 JPK 比较通用。</p>
<ul>
<li>JPK，可解带密钥与不带密钥</li>
<li><a href="http://planetcalc.com/1434/" target="_blank" rel="noopener">http://planetcalc.com/1434/</a></li>
<li><a href="http://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php" target="_blank" rel="noopener">http://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php</a></li>
</ul>
<h2 id="移位密码"><a href="#移位密码" class="headerlink" title="移位密码"></a>移位密码</h2><p>与凯撒密码类似，区别在于移位密码不仅会处理字母，还会处理数字和特殊字符，常用 ASCII 码表进行移位。其破解方法也是遍历所有的可能性来得到可能的结果。</p>
<h2 id="Atbash-Cipher"><a href="#Atbash-Cipher" class="headerlink" title="Atbash Cipher"></a>Atbash Cipher</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>埃特巴什码（Atbash Cipher）其实可以视为下面要介绍的简单替换密码的特例，它使用字母表中的最后一个字母代表第一个字母，倒数第二个字母代表第二个字母。在罗马字母表中，它是这样出现的：</p>
<pre><code>明文：A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
密文：Z Y X W V U T S R Q P O N M L K J I H G F E D C B A</code></pre><p>下面给出一个例子：</p>
<pre><code>明文：the quick brown fox jumps over the lazy dog
密文：gsv jfrxp yildm ulc qfnkh levi gsv ozab wlt</code></pre><h3 id="破解-1"><a href="#破解-1" class="headerlink" title="破解"></a>破解</h3><p>可以看出其密钥空间足够短，同时当密文足够长时，仍然可以采用词频分析的方法解决。</p>
<h3 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://www.practicalcryptography.com/ciphers/classical-era/atbash-cipher/" target="_blank" rel="noopener">http://www.practicalcryptography.com/ciphers/classical-era/atbash-cipher/</a></li>
</ul>
<h2 id="简单替换密码"><a href="#简单替换密码" class="headerlink" title="简单替换密码"></a>简单替换密码</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>简单替换密码（Simple Substitution Cipher）加密时，将每个明文字母替换为与之唯一对应且不同的字母。它与恺撒密码之间的区别是其密码字母表的字母不是简单的移位，而是完全是混乱的，这也使得其破解难度要高于凯撒密码。 比如：</p>
<pre><code>明文字母 : abcdefghijklmnopqrstuvwxyz
密钥字母 : phqgiumeaylnofdxjkrcvstzwb</code></pre><p>a 对应 p，b 对应 h，以此类推。</p>
<pre><code>明文：the quick brown fox jumps over the lazy dog
密文：cei jvaql hkdtf udz yvoxr dsik cei npbw gdm</code></pre><p>而解密时，我们一般是知道了每一个字母的对应规则，才可以正常解密。</p>
<h3 id="破解-2"><a href="#破解-2" class="headerlink" title="破解"></a>破解</h3><p>由于这种加密方式导致其所有的密钥个数是26!26! ，所以几乎上不可能使用暴力的解决方式。所以我们 一般采用词频分析。</p>
<h3 id="工具-2"><a href="#工具-2" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://quipqiup.com/" target="_blank" rel="noopener">http://quipqiup.com/</a></li>
</ul>
<h2 id="仿射密码"><a href="#仿射密码" class="headerlink" title="仿射密码"></a>仿射密码</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><ul>
<li>仿射密码的加密函数是 E(x)=(ax+b)(mod m)，其中<ul>
<li>x 表示明文按照某种编码得到的数字</li>
<li>a 和 m 互质</li>
<li>m 是编码系统中字母的数目</li>
</ul>
</li>
</ul>
<p>解密函数是 D(x)=a^−1(x−b)(mod m)，其中 a^−1 是 a 在 Zm群的乘法逆元。</p>
<p>下面我们以 E(x)=(5x+8) mod 26函数为例子进行介绍，加密字符串为 <code>AFFINE CIPHER</code>，这里我们直接采用字母表 26 个字母作为编码系统</p>
<table>
<thead>
<tr>
<th align="left">明文</th>
<th align="left">A</th>
<th align="left">F</th>
<th align="left">F</th>
<th align="left">I</th>
<th align="left">N</th>
<th align="left">E</th>
<th align="left">C</th>
<th align="left">I</th>
<th align="left">P</th>
<th align="left">H</th>
<th align="left">E</th>
<th align="left">R</th>
</tr>
</thead>
<tbody><tr>
<td align="left">x</td>
<td align="left">0</td>
<td align="left">5</td>
<td align="left">5</td>
<td align="left">8</td>
<td align="left">13</td>
<td align="left">4</td>
<td align="left">2</td>
<td align="left">8</td>
<td align="left">15</td>
<td align="left">7</td>
<td align="left">4</td>
<td align="left">17</td>
</tr>
<tr>
<td align="left">y=5x+8</td>
<td align="left">8</td>
<td align="left">33</td>
<td align="left">33</td>
<td align="left">48</td>
<td align="left">73</td>
<td align="left">28</td>
<td align="left">18</td>
<td align="left">48</td>
<td align="left">83</td>
<td align="left">43</td>
<td align="left">28</td>
<td align="left">93</td>
</tr>
<tr>
<td align="left">y mod 26</td>
<td align="left">8</td>
<td align="left">7</td>
<td align="left">7</td>
<td align="left">22</td>
<td align="left">21</td>
<td align="left">2</td>
<td align="left">18</td>
<td align="left">22</td>
<td align="left">5</td>
<td align="left">17</td>
<td align="left">2</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">密文</td>
<td align="left">I</td>
<td align="left">H</td>
<td align="left">H</td>
<td align="left">W</td>
<td align="left">V</td>
<td align="left">C</td>
<td align="left">S</td>
<td align="left">W</td>
<td align="left">F</td>
<td align="left">R</td>
<td align="left">C</td>
<td align="left">P</td>
</tr>
</tbody></table>
<p>其对应的加密结果是 <code>IHHWVCSWFRCP</code>。</p>
<p>对于解密过程，正常解密者具有 a 与 b，可以计算得到 a−1 为 21，所以其解密函数是D(x)=21(x−8)(mod 26) ，解密如下</p>
<table>
<thead>
<tr>
<th align="left">密文</th>
<th>I</th>
<th>H</th>
<th align="left">H</th>
<th align="left">W</th>
<th align="left">V</th>
<th align="left">C</th>
<th align="left">S</th>
<th align="left">W</th>
<th align="left">F</th>
<th align="left">R</th>
<th align="left">C</th>
<th align="left">P</th>
</tr>
</thead>
<tbody><tr>
<td align="left">y</td>
<td>8</td>
<td>7</td>
<td align="left">7</td>
<td align="left">22</td>
<td align="left">21</td>
<td align="left">2</td>
<td align="left">18</td>
<td align="left">22</td>
<td align="left">5</td>
<td align="left">17</td>
<td align="left">2</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">x=21(y−8)</td>
<td>0</td>
<td>-21</td>
<td align="left">-21</td>
<td align="left">294</td>
<td align="left">273</td>
<td align="left">-126</td>
<td align="left">210</td>
<td align="left">294</td>
<td align="left">-63</td>
<td align="left">189</td>
<td align="left">-126</td>
<td align="left">147</td>
</tr>
<tr>
<td align="left">xmod26</td>
<td>0</td>
<td>5</td>
<td align="left">5</td>
<td align="left">8</td>
<td align="left">13</td>
<td align="left">4</td>
<td align="left">2</td>
<td align="left">8</td>
<td align="left">15</td>
<td align="left">7</td>
<td align="left">4</td>
<td align="left">17</td>
</tr>
<tr>
<td align="left">明文</td>
<td>A</td>
<td>F</td>
<td align="left">F</td>
<td align="left">I</td>
<td align="left">N</td>
<td align="left">E</td>
<td align="left">C</td>
<td align="left">I</td>
<td align="left">P</td>
<td align="left">H</td>
<td align="left">E</td>
<td align="left">R</td>
</tr>
</tbody></table>
<p>可以看出其特点在于只有 26 个英文字母。</p>
<h3 id="破解-3"><a href="#破解-3" class="headerlink" title="破解"></a>破解</h3><p>首先，我们可以看到的是，仿射密码对于任意两个不同的字母，其最后得到的密文必然不一样，所以其也具有最通用的特点。当密文长度足够长时，我们可以使用频率分析的方法来解决。</p>
<p>其次，我们可以考虑如何攻击该密码。可以看出当a=1时，仿射加密是凯撒加密。而一般来说，我们利用仿射密码时，其字符集都用的是字母表，一般只有 26 个字母，而不大于 26 的与 26 互素的个数一共有</p>
<p>ϕ(26)=ϕ(2)×ϕ(13)=12</p>
<p>算上 b 的偏移可能，一共有可能的密钥空间大小也就是</p>
<p>12×26=312</p>
<p>一般来说，对于该种密码，我们至少得是在已知部分明文的情况下才可以攻击。下面进行简单的分析。</p>
<p>这种密码由两种参数来控制，如果我们知道其中任意一个参数，那我们便可以很容易地快速枚举另外一个参数得到答案。</p>
<p>但是，假设我们已经知道采用的字母集，这里假设为 26 个字母，我们还有另外一种解密方式，我们只需要知道两个加密后的字母 y1,y2 即可进行解密。那么我们还可以知道</p>
<p>y1=(ax1+b)(mod 26) </p>
<p>y2=(ax2+b)(mod 26)</p>
<p>两式相减，可得</p>
<p>y1−y2=a(x1−x2)(mod 26)</p>
<p>这里 y1,y2已知，如果我们知道密文对应的两个不一样的字符 x1与 x2 ，那么我们就可以很容易得到 a ，进而就可以得到 b 了。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 TWCTF 2016 的 super_express 为例进行介绍。简单看一下给的源码</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys
key <span class="token operator">=</span> <span class="token string">'****CENSORED***************'</span>
flag <span class="token operator">=</span> <span class="token string">'TWCTF{*******CENSORED********}'</span>

<span class="token keyword">if</span> len<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Key Length Error"</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

n <span class="token operator">=</span> len<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
encrypted <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> flag<span class="token punctuation">:</span>
    c <span class="token operator">=</span> ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">for</span> a<span class="token punctuation">,</span> b <span class="token keyword">in</span> zip<span class="token punctuation">(</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span>n<span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> <span class="token punctuation">(</span>ord<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">*</span> c <span class="token operator">+</span> ord<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">251</span>
    encrypted <span class="token operator">+=</span> <span class="token string">'%02x'</span> <span class="token operator">%</span> c

<span class="token keyword">print</span> encrypted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现，虽然对于 flag 中的每个字母都加密了 n 次，如果我们仔细分析的话，我们可以发现</p>
<p>c1=a1c+b1</p>
<p>c2=a2c1+b2</p>
<p>=a1a2c+a2b1+b2</p>
<p>=kc+d</p>
<p>根据第二行的推导，我们可以得到其实 cn也是这样的形式，可以看成 cn=xc+y ，并且，我们可以知道的是，key 是始终不变化的，所以说，其实这个就是仿射密码。</p>
<p>此外，题目中还给出了密文以及部分部分密文对应的明文，那么我们就很容易利用已知明文攻击的方法来攻击了，利用代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy

key <span class="token operator">=</span> <span class="token string">'****CENSORED****************'</span>
flag <span class="token operator">=</span> <span class="token string">'TWCTF{*******CENSORED********}'</span>

f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'encrypted'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
encrypted <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
plaindelta <span class="token operator">=</span> ord<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> ord<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cipherdalte <span class="token operator">=</span> encrypted<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> encrypted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
a <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>plaindelta<span class="token punctuation">,</span> <span class="token number">251</span><span class="token punctuation">)</span> <span class="token operator">*</span> cipherdalte <span class="token operator">%</span> <span class="token number">251</span>
b <span class="token operator">=</span> <span class="token punctuation">(</span>encrypted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a <span class="token operator">*</span> ord<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">251</span>
a_inv <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">251</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> encrypted<span class="token punctuation">:</span>
    result <span class="token operator">+=</span> chr<span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> a_inv <span class="token operator">%</span> <span class="token number">251</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre><code>➜  TWCTF2016-super_express git:(master) ✗ python exploit.py
TWCTF{Faster_Than_Shinkansen!}</code></pre><h1 id="多表代换加密"><a href="#多表代换加密" class="headerlink" title="多表代换加密"></a>多表代换加密</h1><p>对于多表替换加密来说，加密后的字母几乎不再保持原来的频率，所以我们一般只能通过寻找算法实现对应的弱点进行破解。</p>
<h2 id="Playfair"><a href="#Playfair" class="headerlink" title="Playfair"></a>Playfair</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>Playfair 密码（Playfair cipher or Playfair square）是一种替换密码，1854 年由英国人查尔斯 · 惠斯通（Charles Wheatstone）发明，基本算法如下：</p>
<ol>
<li>选取一串英文字母，除去重复出现的字母，将剩下的字母逐个逐个加入 5 × 5 的矩阵内，剩下的空间由未加入的英文字母依 a-z 的顺序加入。注意，将 q 去除，或将 i 和 j 视作同一字。</li>
<li>将要加密的明文分成两个一组。若组内的字母相同，将 X（或 Q）加到该组的第一个字母后，重新分组。若剩下一个字，也加入 X 。</li>
<li>在每组中，找出两个字母在矩阵中的地方。<ul>
<li>若两个字母不同行也不同列，在矩阵中找出另外两个字母（第一个字母对应行优先），使这四个字母成为一个长方形的四个角。</li>
<li>若两个字母同行，取这两个字母右方的字母（若字母在最右方则取最左方的字母）。</li>
<li>若两个字母同列，取这两个字母下方的字母（若字母在最下方则取最上方的字母）。</li>
</ul>
</li>
</ol>
<p>新找到的两个字母就是原本的两个字母加密的结果。</p>
<p>以 playfair example 为密匙，得</p>
<pre><code>P L A Y F
I R E X M
B C D G H
K N O Q S
T U V W Z</code></pre><p>要加密的讯息为 Hide the gold in the tree stump</p>
<pre><code>HI DE TH EG OL DI NT HE TR EX ES TU MP</code></pre><p>就会得到</p>
<pre><code>BM OD ZB XD NA BE KU DM UI XM MO UV IF</code></pre><h3 id="工具-3"><a href="#工具-3" class="headerlink" title="工具"></a>工具</h3><ul>
<li>CAP4</li>
</ul>
<h2 id="Polybius"><a href="#Polybius" class="headerlink" title="Polybius"></a>Polybius</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>Polybius 密码又称为棋盘密码，其一般是将给定的明文加密为两两组合的数字，其常用密码表</p>
<table>
<thead>
<tr>
<th></th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th>5</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td align="left">A</td>
<td align="left">B</td>
<td align="left">C</td>
<td align="left">D</td>
<td>E</td>
</tr>
<tr>
<td>2</td>
<td align="left">F</td>
<td align="left">G</td>
<td align="left">H</td>
<td align="left">I/J</td>
<td>K</td>
</tr>
<tr>
<td>3</td>
<td align="left">L</td>
<td align="left">M</td>
<td align="left">N</td>
<td align="left">O</td>
<td>P</td>
</tr>
<tr>
<td>4</td>
<td align="left">Q</td>
<td align="left">R</td>
<td align="left">S</td>
<td align="left">T</td>
<td>U</td>
</tr>
<tr>
<td>5</td>
<td align="left">V</td>
<td align="left">W</td>
<td align="left">X</td>
<td align="left">Y</td>
<td>Z</td>
</tr>
</tbody></table>
<p>举个例子，明文 HELLO，加密后就是 23 15 31 31 34。</p>
<p>另一种密码表</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">A</th>
<th align="left">D</th>
<th align="left">F</th>
<th align="left">G</th>
<th align="left">X</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A</td>
<td align="left">b</td>
<td align="left">t</td>
<td align="left">a</td>
<td align="left">l</td>
<td align="left">p</td>
</tr>
<tr>
<td align="left">D</td>
<td align="left">d</td>
<td align="left">h</td>
<td align="left">o</td>
<td align="left">z</td>
<td align="left">k</td>
</tr>
<tr>
<td align="left">F</td>
<td align="left">q</td>
<td align="left">f</td>
<td align="left">v</td>
<td align="left">s</td>
<td align="left">n</td>
</tr>
<tr>
<td align="left">G</td>
<td align="left">g</td>
<td align="left">j</td>
<td align="left">c</td>
<td align="left">u</td>
<td align="left">x</td>
</tr>
<tr>
<td align="left">X</td>
<td align="left">m</td>
<td align="left">r</td>
<td align="left">e</td>
<td align="left">w</td>
<td align="left">y</td>
</tr>
</tbody></table>
<p>注意，这里字母的顺序被打乱了。</p>
<p>A D F G X 的由来：</p>
<blockquote>
<p>1918 年，第一次世界大战将要结束时，法军截获了一份德军电报，电文中的所有单词都由 A、D、F、G、X 五个字母拼成，因此被称为 ADFGX 密码。ADFGX 密码是 1918 年 3 月由德军上校 Fritz Nebel 发明的，是结合了 Polybius 密码和置换密码的双重加密方案。</p>
</blockquote>
<p>举个例子，HELLO，使用这个表格加密，就是 DD XF AG AG DF。</p>
<h3 id="工具-4"><a href="#工具-4" class="headerlink" title="工具"></a>工具</h3><ul>
<li>CrypTool</li>
</ul>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>这里以安恒杯 9 月 Crypto 赛题 Go 为例，题目为：</p>
<blockquote>
<p>密文：ilnllliiikkninlekile</p>
<p>压缩包给了一行十六进制：546865206c656e677468206f66207468697320706c61696e746578743a203130</p>
<p>请对密文解密</p>
</blockquote>
<p>首先对十六进制进行 hex 解码，得到字符串：”The length of this plaintext: 10”</p>
<p>密文长度为 20 ，而明文长度为 10 ，密文只有 “l”,”i”,”n”,”k”,”e” 这五个字符，联想到棋盘密码。</p>
<p>首先试一下五个字符按字母表顺序排列：</p>
<table>
<thead>
<tr>
<th></th>
<th align="left">e</th>
<th align="left">i</th>
<th align="left">k</th>
<th align="left">l</th>
<th>n</th>
</tr>
</thead>
<tbody><tr>
<td>e</td>
<td align="left">A</td>
<td align="left">B</td>
<td align="left">C</td>
<td align="left">D</td>
<td>E</td>
</tr>
<tr>
<td>i</td>
<td align="left">F</td>
<td align="left">G</td>
<td align="left">H</td>
<td align="left">I/J</td>
<td>K</td>
</tr>
<tr>
<td>k</td>
<td align="left">L</td>
<td align="left">M</td>
<td align="left">N</td>
<td align="left">O</td>
<td>P</td>
</tr>
<tr>
<td>l</td>
<td align="left">Q</td>
<td align="left">R</td>
<td align="left">S</td>
<td align="left">T</td>
<td>U</td>
</tr>
<tr>
<td>n</td>
<td align="left">V</td>
<td align="left">W</td>
<td align="left">X</td>
<td align="left">Y</td>
<td>Z</td>
</tr>
</tbody></table>
<p>根据密文解密得：iytghpkqmq。</p>
<p>这应该不是我们想要的 flag 答案。</p>
<p>看来这五个字符排列不是这么排列的，一共有 5! 种情况，写脚本爆破：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> itertools

key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
cipher <span class="token operator">=</span> <span class="token string">"ilnllliiikkninlekile"</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>permutations<span class="token punctuation">(</span><span class="token string">'ilnke'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> now_key <span class="token keyword">in</span> key<span class="token punctuation">:</span>
    solve_c <span class="token operator">=</span> <span class="token string">""</span>
    res <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> now_c <span class="token keyword">in</span> cipher<span class="token punctuation">:</span>
        solve_c <span class="token operator">+=</span> str<span class="token punctuation">(</span>now_key<span class="token punctuation">.</span>index<span class="token punctuation">(</span>now_c<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>solve_c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        now_ascii <span class="token operator">=</span> int<span class="token punctuation">(</span>solve_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5</span><span class="token operator">+</span>int<span class="token punctuation">(</span>solve_c<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">97</span>
        <span class="token keyword">if</span> now_ascii<span class="token operator">></span>ord<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            now_ascii<span class="token operator">+=</span><span class="token number">1</span>
        res <span class="token operator">+=</span> chr<span class="token punctuation">(</span>now_ascii<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"flag"</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>
        <span class="token keyword">print</span> now_key<span class="token punctuation">,</span>res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>脚本其实就是实现棋盘密码这个算法，只是这五个字符的顺序不定。</p>
<p>跑出下面两个结果：</p>
<blockquote>
<p>linke flagishere</p>
<p>linek flagkxhdwd</p>
</blockquote>
<p>显然第一个是我们想要的答案。</p>
<p>附上正确的密码表：</p>
<table>
<thead>
<tr>
<th></th>
<th align="left">l</th>
<th align="left">i</th>
<th align="left">n</th>
<th align="left">k</th>
<th>e</th>
</tr>
</thead>
<tbody><tr>
<td>l</td>
<td align="left">A</td>
<td align="left">B</td>
<td align="left">C</td>
<td align="left">D</td>
<td>E</td>
</tr>
<tr>
<td>i</td>
<td align="left">F</td>
<td align="left">G</td>
<td align="left">H</td>
<td align="left">I/J</td>
<td>K</td>
</tr>
<tr>
<td>n</td>
<td align="left">L</td>
<td align="left">M</td>
<td align="left">N</td>
<td align="left">O</td>
<td>P</td>
</tr>
<tr>
<td>k</td>
<td align="left">Q</td>
<td align="left">R</td>
<td align="left">S</td>
<td align="left">T</td>
<td>U</td>
</tr>
<tr>
<td>e</td>
<td align="left">V</td>
<td align="left">W</td>
<td align="left">X</td>
<td align="left">Y</td>
<td>Z</td>
</tr>
</tbody></table>
<h2 id="Vigenere-维吉尼亚密码"><a href="#Vigenere-维吉尼亚密码" class="headerlink" title="Vigenere 维吉尼亚密码"></a>Vigenere 维吉尼亚密码</h2><h3 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h3><p>维吉尼亚密码（Vigenere）是使用一系列凯撒密码组成密码字母表的加密算法，属于多表密码的一种简单形式。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/vigenere1.jpg" alt=""></p>
<p>下面给出一个例子</p>
<pre><code>明文：come greatwall
密钥：crypto</code></pre><p>首先，对密钥进行填充使其长度与明文长度一样。</p>
<table>
<thead>
<tr>
<th align="left">明文</th>
<th align="left">c</th>
<th align="left">o</th>
<th align="left">m</th>
<th align="left">e</th>
<th align="left">g</th>
<th align="left">r</th>
<th align="left">e</th>
<th align="left">a</th>
<th align="left">t</th>
<th align="left">w</th>
<th align="left">a</th>
<th align="left">l</th>
<th align="left">l</th>
</tr>
</thead>
<tbody><tr>
<td align="left">密钥</td>
<td align="left">c</td>
<td align="left">r</td>
<td align="left">y</td>
<td align="left">p</td>
<td align="left">t</td>
<td align="left">o</td>
<td align="left">c</td>
<td align="left">r</td>
<td align="left">y</td>
<td align="left">p</td>
<td align="left">t</td>
<td align="left">o</td>
<td align="left">c</td>
</tr>
</tbody></table>
<p>其次，查表得密文</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/vigenere2.jpg" alt=""></p>
<pre><code>明文：come greatwall
密钥：crypto
密文：efkt zferrltzn</code></pre><h3 id="破解-4"><a href="#破解-4" class="headerlink" title="破解"></a>破解</h3><p>对包括维吉尼亚密码在内的所有多表密码的破译都是以字母频率为基础的，但直接的频率分析却并不适用，这是因为在维吉尼亚密码中，一个字母可以被加密成不同的密文，因而简单的频率分析在这里并没有用。</p>
<p><strong>破译维吉尼亚密码的关键在于它的密钥是循环重复的。</strong> 如果我们知道了密钥的长度，那密文就可以被看作是交织在一起的凯撒密码，而其中每一个都可以单独破解。关于密码的长度，我们可以 使用卡西斯基试验和弗里德曼试验来获取。</p>
<p>卡西斯基试验是基于类似 the 这样的常用单词有可能被同样的密钥字母进行加密，从而在密文中重复出现。例如，明文中不同的 CRYPTO 可能被密钥 ABCDEF 加密成不同的密文：</p>
<pre><code>密钥：ABCDEF AB CDEFA BCD EFABCDEFABCD
明文：CRYPTO IS SHORT FOR CRYPTOGRAPHY
密文：CSASXT IT UKSWT GQU GWYQVRKWAQJB</code></pre><p>此时明文中重复的元素在密文中并不重复。然而，如果密钥相同的话，结果可能便为（使用密钥 ABCD）：</p>
<pre><code>密钥：ABCDAB CD ABCDA BCD ABCDABCDABCD
明文：CRYPTO IS SHORT FOR CRYPTOGRAPHY
密文：CSASTP KV SIQUT GQU CSASTPIUAQJB</code></pre><p>此时卡西斯基试验就能产生效果。对于更长的段落此方法更为有效，因为通常密文中重复的片段会更多。如通过下面的密文就能破译出密钥的长度：</p>
<pre><code>密文：DYDUXRMHTVDVNQDQNWDYDUXRMHARTJGWNQD</code></pre><p>其中，两个 DYDUXRMH 的出现相隔了 18 个字母。因此，可以假定密钥的长度是 18 的约数，即长度为 18、9、6、3 或 2。而两个 NQD 则相距 20 个字母，意味着密钥长度应为 20、10、5、4 或 2。取两者的交集，则可以基本确定密钥长度为 2。接下来就是进行进一步的操作了。</p>
<p>关于更加详细的破解原理，这里暂时不做过多的介绍。可以参考 <a href="http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-vigenere-cipher/" target="_blank" rel="noopener">http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-vigenere-cipher/</a>。</p>
<h3 id="工具-5"><a href="#工具-5" class="headerlink" title="工具"></a>工具</h3><ul>
<li>已知密钥<ul>
<li>Python 的 pycipher 库</li>
<li><a href="http://planetcalc.com/2468/" target="_blank" rel="noopener">在线解密 Vigenère cipher</a></li>
<li>CAP4</li>
</ul>
</li>
<li>未知密钥<ul>
<li><a href="http://www.mygeocachingprofile.com/codebreaker.vigenerecipher.aspx" target="_blank" rel="noopener">Vigenère Cipher Codebreaker</a></li>
<li><a href="https://www.guballa.de/vigenere-solver" target="_blank" rel="noopener">Vigenere Solver</a> ，不够完善。</li>
</ul>
</li>
</ul>
<h2 id="Nihilist"><a href="#Nihilist" class="headerlink" title="Nihilist"></a>Nihilist</h2><h3 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h3><p>Nihilist 密码又称关键字密码：明文 + 关键字 = 密文。以关键字 helloworld 为例。</p>
<p>首先利用密钥构造棋盘矩阵（类似 Polybius 密码） - 新建一个 5 × 5 矩阵 - 将字符不重复地依次填入矩阵 - 剩下部分按字母顺序填入 - 字母 i 和 j 等价</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th align="left">5</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">h</td>
<td align="left">e</td>
<td align="left">l</td>
<td align="left">o</td>
<td align="left">w</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">r</td>
<td align="left">d</td>
<td align="left">a</td>
<td align="left">b</td>
<td align="left">c</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">f</td>
<td align="left">g</td>
<td align="left">i / j</td>
<td align="left">k</td>
<td align="left">m</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">n</td>
<td align="left">p</td>
<td align="left">q</td>
<td align="left">s</td>
<td align="left">t</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">u</td>
<td align="left">v</td>
<td align="left">x</td>
<td align="left">y</td>
<td align="left">z</td>
</tr>
</tbody></table>
<p>对于加密过程参照矩阵 M 进行加密：</p>
<pre><code>a -&gt; M[2,3] -&gt; 23
t -&gt; M[4,5] -&gt; 45</code></pre><p>对于解密过程</p>
<p>参照矩阵 M 进行解密：</p>
<pre><code>23 -&gt; M[2,3] -&gt; a
45 -&gt; M[4,5] -&gt; t</code></pre><p>可以看出，密文的特征有如下几点</p>
<ul>
<li>纯数字</li>
<li>只包含 1 到 5</li>
<li>密文长度偶数。</li>
</ul>
<h2 id="Hill"><a href="#Hill" class="headerlink" title="Hill"></a>Hill</h2><h3 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h3><p>希尔密码（Hill）使用每个字母在字母表中的顺序作为其对应的数字，即 A=0，B=1，C=2 等，然后将明文转化为 n 维向量，跟一个 n × n 的矩阵相乘，再将得出的结果模 26。注意用作加密的矩阵（即密匙）在 Zn26必须是可逆的，否则就不可能解码。只有矩阵的行列式和 26 互质，才是可逆的。下面举一个例子</p>
<pre><code>明文：ACT</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/image-20210815235006081.png" alt=""></p>
<p>密文即为</p>
<pre><code>密文：POH</code></pre><h3 id="工具-6"><a href="#工具-6" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://www.practicalcryptography.com/ciphers/hill-cipher/" target="_blank" rel="noopener">http://www.practicalcryptography.com/ciphers/hill-cipher/</a></li>
<li>CAP4</li>
<li>Cryptool</li>
</ul>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 ISCC 2015 base decrypt 150 为例进行介绍，题目为</p>
<blockquote>
<p>密文： 22,09,00,12,03,01,10,03,04,08,01,17 （wjamdbkdeibr）</p>
<p>使用的矩阵是 1 2 3 4 5 6 7 8 10</p>
<p>请对密文解密.</p>
</blockquote>
<p>首先，矩阵是 3 × 3 的。说明每次加密 3 个字符。我们直接使用 Cryptool，需要注意的是，这个矩阵是按照列来排布的。即如下</p>
<pre><code>1 4 7
2 5 8
3 6 10</code></pre><p>最后的结果为 <code>overthehillx</code>。</p>
<h2 id="AutokeyCipher"><a href="#AutokeyCipher" class="headerlink" title="AutokeyCipher"></a>AutokeyCipher</h2><h3 id="原理-9"><a href="#原理-9" class="headerlink" title="原理"></a>原理</h3><p>自动密钥密码（Autokey Cipher）也是多表替换密码，与维吉尼亚密码密码类似，但使用不同的方法生成密钥。通常来说它要比维吉尼亚密码更安全。自动密钥密码主要有两种，关键词自动密钥密码和原文自动密钥密码。下面我们以关键词自动密钥为例：</p>
<pre><code>明文：THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG
关键词：CULTURE</code></pre><p>自动生成密钥：</p>
<pre><code>CULTURE THE QUICK BROWN FOX JUMPS OVER THE</code></pre><p>接下来的加密过程和维吉尼亚密码类似，从相应的表格可得：</p>
<p>密文</p>
<pre><code>VBP JOZGD IVEQV HYY AIICX CSNL FWW ZVDP WVK</code></pre><h3 id="工具-7"><a href="#工具-7" class="headerlink" title="工具"></a>工具</h3><ul>
<li>已知关键词<ul>
<li>Python 的 pycipher 库</li>
</ul>
</li>
<li>未知关键词<ul>
<li><a href="http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-autokey-cipher/" target="_blank" rel="noopener">http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-autokey-cipher/</a></li>
<li><strong>tools 文件夹下 break_autokey.py，待完成。</strong></li>
</ul>
</li>
</ul>
<h1 id="其它类型加密"><a href="#其它类型加密" class="headerlink" title="其它类型加密"></a>其它类型加密</h1><h2 id="培根密码"><a href="#培根密码" class="headerlink" title="培根密码"></a>培根密码</h2><h3 id="原理-10"><a href="#原理-10" class="headerlink" title="原理"></a>原理</h3><p>培根密码使用两种不同的字体，代表 A 和 B，结合加密表进行加解密。</p>
<table>
<thead>
<tr>
<th align="left">a</th>
<th align="left">AAAAA</th>
<th align="left">g</th>
<th align="left">AABBA</th>
<th align="left">n</th>
<th align="left">ABBAA</th>
<th align="left">t</th>
<th align="left">BAABA</th>
</tr>
</thead>
<tbody><tr>
<td align="left">b</td>
<td align="left">AAAAB</td>
<td align="left">h</td>
<td align="left">AABBB</td>
<td align="left">o</td>
<td align="left">ABBAB</td>
<td align="left">u-v</td>
<td align="left">BAABB</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">AAABA</td>
<td align="left">i-j</td>
<td align="left">ABAAA</td>
<td align="left">p</td>
<td align="left">ABBBA</td>
<td align="left">w</td>
<td align="left">BABAA</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">AAABB</td>
<td align="left">k</td>
<td align="left">ABAAB</td>
<td align="left">q</td>
<td align="left">ABBBB</td>
<td align="left">x</td>
<td align="left">BABAB</td>
</tr>
<tr>
<td align="left">e</td>
<td align="left">AABAA</td>
<td align="left">l</td>
<td align="left">ABABA</td>
<td align="left">r</td>
<td align="left">BAAAA</td>
<td align="left">y</td>
<td align="left">BABBA</td>
</tr>
<tr>
<td align="left">f</td>
<td align="left">AABAB</td>
<td align="left">m</td>
<td align="left">ABABB</td>
<td align="left">s</td>
<td align="left">BAAAB</td>
<td align="left">z</td>
<td align="left">BABBB</td>
</tr>
</tbody></table>
<p>上面的是常用的加密表。还有另外的一种加密表，可认为是将 26 个字母从 0 到 25 排序，以二进制表示，A 代表 0，B 代表 1。</p>
<p>下面这一段内容就是明文 steganography 加密后的内容，正常字体是 A，粗体是 B：</p>
<p><strong>T</strong>o en<strong>co</strong>de <strong>a</strong> mes<strong>s</strong>age e<strong>ac</strong>h letter <strong>of</strong> the <strong>pl</strong>a<strong>i</strong>nt<strong>ex</strong>t <strong>i</strong>s replaced b<strong>y a g</strong>rou<strong>p of f</strong>i<strong>ve</strong> of <strong>th</strong>e lett<strong>ers</strong> <strong>‘A’</strong> o<strong>r ‘B’</strong>.</p>
<p>可以看到，培根密码主要有以下特点</p>
<ul>
<li>只有两种字符</li>
<li>每一段的长度为 5</li>
<li>加密内容会有特殊的字体之分，亦或者大小写之分。</li>
</ul>
<h3 id="工具-8"><a href="#工具-8" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://rumkin.com/tools/cipher/baconian.php" target="_blank" rel="noopener">http://rumkin.com/tools/cipher/baconian.php</a></li>
</ul>
<h2 id="栅栏密码"><a href="#栅栏密码" class="headerlink" title="栅栏密码"></a>栅栏密码</h2><h3 id="原理-11"><a href="#原理-11" class="headerlink" title="原理"></a>原理</h3><p>栅栏密码把要加密的明文分成 N 个一组，然后把每组的第 1 个字连起来，形成一段无规律的话。这里给出一个例子</p>
<pre><code>明文：THERE IS A CIPHER</code></pre><p>去掉空格后变为</p>
<pre><code>THEREISACIPHER</code></pre><p>分成两栏，两个一组得到</p>
<pre><code>TH ER EI SA CI PH ER</code></pre><p>先取出第一个字母，再取出第二个字母</p>
<pre><code>TEESCPE
HRIAIHR</code></pre><p>连在一起就是</p>
<pre><code>TEESCPEHRIAIHR</code></pre><p>上述明文也可以分为 2 栏。</p>
<pre><code>THEREIS ACIPHER</code></pre><p>组合得到密文</p>
<pre><code>TAHCEIRPEHIESR</code></pre><h3 id="工具-9"><a href="#工具-9" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="https://www.qqxiuzi.cn/bianma/zhalanmima.php" target="_blank" rel="noopener">https://www.qqxiuzi.cn/bianma/zhalanmima.php</a></li>
</ul>
<h2 id="曲路密码"><a href="#曲路密码" class="headerlink" title="曲路密码"></a>曲路密码</h2><h3 id="原理-12"><a href="#原理-12" class="headerlink" title="原理"></a>原理</h3><p>曲路密码（Curve Cipher）是一种换位密码，需要事先双方约定密钥（也就是曲路路径）。下面给出一个例子</p>
<pre><code>明文：The quick brown fox jumps over the lazy dog</code></pre><p>填入 5 行 7 列表（事先约定填充的行列数）</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/qulu-table.png" alt=""></p>
<p>加密的回路线（事先约定填充的行列数）</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/qulu-road.png" alt=""></p>
<pre><code>密文：gesfc inpho dtmwu qoury zejre hbxva lookT</code></pre><h2 id="列移位加密"><a href="#列移位加密" class="headerlink" title="列移位加密"></a>列移位加密</h2><h3 id="原理-13"><a href="#原理-13" class="headerlink" title="原理"></a>原理</h3><p>列移位密码（Columnar Transposition Cipher）是一种比较简单，易于实现的换位密码，通过一个简单的规则将明文打乱混合成密文。下面给出一个例子。</p>
<p>我们以明文 <code>The quick brown fox jumps over the lazy dog</code>，密钥 <code>how are u</code> 为例：</p>
<p>将明文填入 5 行 7 列表（事先约定填充的行列数，如果明文不能填充完表格可以约定使用某个字母进行填充）</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/columnar-transposition-plaintext.png" alt=""></p>
<p>密钥： <code>how are u</code>，按 <code>how are u</code> 在字母表中的出现的先后顺序进行编号，我们就有 a 为 1，e 为 2，h 为 3，o 为 4，r 为 5，u 为 6，w 为 7，所以先写出 a 列，其次 e 列，以此类推写出的结果便是密文：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/columnar-transposition-key.png" alt=""></p>
<p>密文： <code>qoury inpho Tkool hbxva uwmtd cfseg erjez</code></p>
<h3 id="工具-10"><a href="#工具-10" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://www.practicalcryptography.com/ciphers/classical-era/columnar-transposition/" target="_blank" rel="noopener">http://www.practicalcryptography.com/ciphers/classical-era/columnar-transposition/</a> 行列数相等</li>
</ul>
<h2 id="01248-密码"><a href="#01248-密码" class="headerlink" title="01248 密码"></a>01248 密码</h2><h3 id="原理-14"><a href="#原理-14" class="headerlink" title="原理"></a>原理</h3><p>该密码又称为云影密码，使用 0，1，2，4，8 四个数字，其中 0 用来表示间隔，其他数字以加法可以表示出 如：28=10，124=7，18=9，再用 1-&gt;26 表示 A-&gt;Z。</p>
<p>可以看出该密码有以下特点</p>
<ul>
<li>只有 0，1，2，4，8</li>
</ul>
<h3 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 CFF 2016 影之密码为例进行介绍，题目</p>
<blockquote>
<p>8842101220480224404014224202480122</p>
</blockquote>
<p>我们按照 0 来进行分割，如下</p>
<table>
<thead>
<tr>
<th align="left">内容</th>
<th align="left">数字</th>
<th align="left">字符</th>
</tr>
</thead>
<tbody><tr>
<td align="left">88421</td>
<td align="left">8+8+4+2+1=23</td>
<td align="left">W</td>
</tr>
<tr>
<td align="left">122</td>
<td align="left">1+2+2=5</td>
<td align="left">E</td>
</tr>
<tr>
<td align="left">48</td>
<td align="left">4+8=12</td>
<td align="left">L</td>
</tr>
<tr>
<td align="left">2244</td>
<td align="left">2+2+4+4=12</td>
<td align="left">L</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">4</td>
<td align="left">D</td>
</tr>
<tr>
<td align="left">142242</td>
<td align="left">1+4+2+2+4+2=15</td>
<td align="left">O</td>
</tr>
<tr>
<td align="left">248</td>
<td align="left">2+4+8=14</td>
<td align="left">N</td>
</tr>
<tr>
<td align="left">122</td>
<td align="left">1+2+2=5</td>
<td align="left">E</td>
</tr>
</tbody></table>
<p>所以最后的 flag 为 WELLDONE。</p>
<h2 id="JSFuck"><a href="#JSFuck" class="headerlink" title="JSFuck"></a>JSFuck</h2><h3 id="原理-15"><a href="#原理-15" class="headerlink" title="原理"></a>原理</h3><p>JSFuck 可以只用 6 个字符 <code>[]()!+</code> 来编写 JavaScript 程序。比如我们想用 JSFuck 来实现 <code>alert(1)</code> 代码如下</p>
<pre><code>[][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]][([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[!+[]+!+[]+!+[]]]]+([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]]]+([][[]]+[])[+[[+!+[]]]]+(![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[+!+[]]]]+([][[]]+[])[+[[+[]]]]+([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]((![]+[])[+[[+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]+(!![]+[])[+[[+[]]]]+([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[+!+[]]]+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+[+!+[]]+([][(![]+[])[+[[+[]]]]+([][[]]+[])[+[[!+[]+!+[]+!+[]+!+[]+!+[]]]]+(![]+[])[+[[!+[]+!+[]]]]+(!![]+[])[+[[+[]]]]+(!![]+[])[+[[!+[]+!+[]+!+[]]]]+(!![]+[])[+[[+!+[]]]]]+[])[+[[+!+[]]]+[[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]]])()</code></pre><p>其他一些基本的表达：</p>
<pre><code>false       =&gt;  ![]
true        =&gt;  !![]
undefined   =&gt;  [][[]]
NaN         =&gt;  +[![]]
0           =&gt;  +[]
1           =&gt;  +!+[]
2           =&gt;  !+[]+!+[]
10          =&gt;  [+!+[]]+[+[]]
Array       =&gt;  []
Number      =&gt;  +[]
String      =&gt;  []+[]
Boolean     =&gt;  ![]
Function    =&gt;  []["filter"]
eval        =&gt;  []["filter"]["constructor"]( CODE )()
window      =&gt;  []["filter"]["constructor"]("return this")()</code></pre><h3 id="工具-11"><a href="#工具-11" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://www.jsfuck.com/" target="_blank" rel="noopener">JSFuck 在线加密网站</a></li>
</ul>
<h2 id="BrainFuck"><a href="#BrainFuck" class="headerlink" title="BrainFuck"></a>BrainFuck</h2><h3 id="原理-16"><a href="#原理-16" class="headerlink" title="原理"></a>原理</h3><p>Brainfuck，是一种极小化的计算机语言，它是由 Urban Müller 在 1993 年创建的。我们举一个例子，如果我们想要一个在屏幕上打印 Hello World！，那么对应的程序如下。对于其中的原理，感兴趣的可以自行网上搜索。</p>
<pre><code>++++++++++[&gt;+++++++&gt;++++++++++&gt;+++&gt;+&lt;&lt;&lt;&lt;-]
&gt;++.&gt;+.+++++++..+++.&gt;++.&lt;&lt;+++++++++++++++.
&gt;.+++.------.--------.&gt;+.&gt;.</code></pre><p>与其对应的还有 ook。</p>
<h3 id="工具-12"><a href="#工具-12" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="https://www.splitbrain.org/services/ook" target="_blank" rel="noopener">https://www.splitbrain.org/services/ook</a></li>
</ul>
<h2 id="猪圈密码"><a href="#猪圈密码" class="headerlink" title="猪圈密码"></a>猪圈密码</h2><h3 id="原理-17"><a href="#原理-17" class="headerlink" title="原理"></a>原理</h3><p>猪圈密码是一种以格子为基础的简单替代式密码，格子如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pigpen.png" alt=""></p>
<p>我们举一个例子，如明文为 <code>X marks the spot</code> ，那么密文如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pigpen_example.png" alt=""></p>
<h3 id="工具-13"><a href="#工具-13" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="http://www.simonsingh.net/The_Black_Chamber/pigpen.html" target="_blank" rel="noopener">http://www.simonsingh.net/The_Black_Chamber/pigpen.html</a></li>
</ul>
<h2 id="舞动的小人密码"><a href="#舞动的小人密码" class="headerlink" title="舞动的小人密码"></a>舞动的小人密码</h2><h3 id="原理-18"><a href="#原理-18" class="headerlink" title="原理"></a>原理</h3><p>这种密码出自于福尔摩斯探案集。每一个跳舞的小人实际上对应的是英文二十六个字母中的一个，而小人手中的旗子则表明该字母是单词的最后一个字母，如果仅仅是一个单词而不是句子，或者是句子中最后的一个单词，则单词中最后一个字母不必举旗。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/dancingman.jpg" alt=""></p>
<h2 id="键盘密码"><a href="#键盘密码" class="headerlink" title="键盘密码"></a>键盘密码</h2><p>所谓键盘密码，就是采用手机键盘或者电脑键盘进行加密。</p>
<h3 id="手机键盘密码"><a href="#手机键盘密码" class="headerlink" title="手机键盘密码"></a>手机键盘密码</h3><p>手机键盘加密方式，是每个数字键上有 3-4 个字母，用两位数字来表示字母，例如：ru 用手机键盘表示就是：7382，那么这里就可以知道了，手机键盘加密方式不可能用 1 开头，第二位数字不可能超过 4，解密的时候参考此</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/mobile.jpg" alt=""></p>
<p>关于手机键盘加密还有另一种方式，就是「音的」式（这一点可能根据手机的不同会有所不同），具体参照手机键盘来打，例如：「数字」表示出来就是：748 94。在手机键盘上面按下这几个数，就会出：「数字」的拼音。</p>
<h3 id="电脑键盘棋盘"><a href="#电脑键盘棋盘" class="headerlink" title="电脑键盘棋盘"></a>电脑键盘棋盘</h3><p>电脑键盘棋盘加密，利用了电脑的棋盘方阵。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/computer-chess.jpg" alt=""></p>
<h3 id="电脑键盘坐标"><a href="#电脑键盘坐标" class="headerlink" title="电脑键盘坐标"></a>电脑键盘坐标</h3><p>电脑键盘坐标加密，利用键盘上面的字母行和数字行来加密，例：bye 用电脑键盘 XY 表示就是：351613</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/computer-x-y.jpg" alt=""></p>
<h3 id="电脑键盘-QWE"><a href="#电脑键盘-QWE" class="headerlink" title="电脑键盘 QWE"></a>电脑键盘 QWE</h3><p>电脑键盘 QWE 加密法，就是用字母表替换键盘上面的排列顺序。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/crypto/classical/figure/computer-qwe.jpg" alt=""></p>
<h3 id="键盘布局加密"><a href="#键盘布局加密" class="headerlink" title="键盘布局加密"></a>键盘布局加密</h3><p>简单地说就是根据给定的字符在键盘上的样子来进行加密。</p>
<h3 id="0CTF-2014-classic"><a href="#0CTF-2014-classic" class="headerlink" title="0CTF 2014 classic"></a>0CTF 2014 classic</h3><blockquote>
<p>小丁丁发现自己置身于一个诡异的房间，面前只有一扇刻着奇怪字符的门。 他发现门边上还有一道密码锁，似乎要输入密码才能开门。。4esxcft5 rdcvgt 6tfc78uhg 098ukmnb</p>
</blockquote>
<p>发现这么乱，还同时包括数字和字母猜想可能是键盘密码，试着在键盘上按照字母顺序描绘一下，可得到 0ops 字样，猜测就是 flag 了。</p>
<h3 id="2017-年-xman-选拔赛——一二三，木头人"><a href="#2017-年-xman-选拔赛——一二三，木头人" class="headerlink" title="2017 年 xman 选拔赛——一二三，木头人"></a>2017 年 xman 选拔赛——一二三，木头人</h3><blockquote>
<p>我数 123 木头人，再不行动就要被扣分。</p>
<p>23731263111628163518122316391715262121</p>
<p>密码格式 xman{flag}</p>
</blockquote>
<p>题目中有很明显的提示 123，那么就自然需要联想到键盘密码中电脑键盘坐标密码，可以发现前几个数字第二个数字都是 1-3 范围内的，也验证了我们的猜测。于是</p>
<blockquote>
<p>23-x</p>
<p>73-m</p>
<p>12-a</p>
<p>63-n</p>
<p>11-q</p>
</blockquote>
<p>不对呀，密码格式是 <code>xman{</code>，第四个字符是 <code>{</code>，于是看了看 <code>{</code> 的位置，其并没有对应的横坐标，但是如果我们手动把它视为 11 的话，那么 111 就是 <code>{</code>。然后依次往后推，发现确实可行，，最后再把 121 视为 <code>}</code> 即可得到 flag。</p>
<pre><code>xman{hintisenough}</code></pre><p>从这里我们可以看出，我们还是要注意迁移性，不能单纯地照搬一些已有的知识。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="古典密码分析思路"><a href="#古典密码分析思路" class="headerlink" title="古典密码分析思路"></a>古典密码分析思路</h2><p>CTF 中有关古典密码的题目，通常是根据密文求出明文，因此采用<strong>唯密文攻击</strong>居多，基本分析思路总结如下：</p>
<ol>
<li>确定密码类型：根据题目提示、加密方式、密文字符集、密文展现形式等信息。</li>
<li>确定攻击方法：包括直接分析、蛮力攻击、统计分析等方法。对于无法确定类型的特殊密码，应根据其密码特性选用合适的攻击方法。</li>
<li>确定分析工具：以在线密码分析工具与 Python 脚本工具包为主，以离线密码分析工具与手工分析为辅。</li>
</ol>
<p>以上唯密文攻击方法的适用场景与举例如下：</p>
<table>
<thead>
<tr>
<th align="left">攻击方法</th>
<th align="left">适用场景</th>
<th align="left">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">直接分析法</td>
<td align="left">由密码类型可确定映射关系的代换密码</td>
<td align="left">凯撒密码、猪圈密码、键盘密码等</td>
</tr>
<tr>
<td align="left">蛮力攻击法</td>
<td align="left">密钥空间较小的代换密码或置换密码</td>
<td align="left">移位密码、栅栏密码等</td>
</tr>
<tr>
<td align="left">统计分析法</td>
<td align="left">密钥空间较大的代换密码</td>
<td align="left">简单替换密码、仿射密码、维吉尼亚密码等</td>
</tr>
</tbody></table>
<h2 id="实验吧-围在栅栏里的爱"><a href="#实验吧-围在栅栏里的爱" class="headerlink" title="实验吧 围在栅栏里的爱"></a>实验吧 围在栅栏里的爱</h2><p>题目描述</p>
<blockquote>
<p>最近一直在好奇一个问题，QWE 到底等不等于 ABC？</p>
<p>-.- .. –.- .-.. .– - ..-. -.-. –.- –. -. … — —</p>
<p>flag 格式：CTF{xxx}</p>
</blockquote>
<p>首先，根据密码样式判断是摩斯电码，解密后得到 <code>KIQLWTFCQGNSOO</code>，看着也不像 flag，题目中还有还有栅栏与 <code>QWE到底等不等于ABC</code>，两个都试了试之后，发现是先 QWE 然后栅栏可得到结果。</p>
<p>首先键盘 QWE 解密，试着解密得到 <code>IILYOAVNEBSAHR</code>。继而栅栏解密得到 <code>ILOVESHIYANBAR</code>。</p>
<h2 id="2017-SECCON-Vigenere3d"><a href="#2017-SECCON-Vigenere3d" class="headerlink" title="2017 SECCON Vigenere3d"></a>2017 SECCON Vigenere3d</h2><p>程序如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Vigenere3d.py</span>
<span class="token keyword">import</span> sys
<span class="token keyword">def</span> <span class="token function">_l</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> s<span class="token punctuation">[</span>idx<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span>idx<span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> k1<span class="token punctuation">,</span> k2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz_{}"</span>
    t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>_l<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    i1 <span class="token operator">=</span> <span class="token number">0</span>
    i2 <span class="token operator">=</span> <span class="token number">0</span>
    c <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> p<span class="token punctuation">:</span>
        c <span class="token operator">+=</span> t<span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>k1<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>k2<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        i1 <span class="token operator">=</span> <span class="token punctuation">(</span>i1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>k1<span class="token punctuation">)</span>
        i2 <span class="token operator">=</span> <span class="token punctuation">(</span>i2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>k2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token keyword">print</span> main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

$ python Vigenere3d<span class="token punctuation">.</span>py SECCON<span class="token punctuation">{</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>
POR4dnyTLHBfwbxAAZhe<span class="token punctuation">}</span><span class="token punctuation">}</span>ocZR3Cxcftw9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>解法一</strong>：</p>
<p>首先，我们先来分析一下 t 的构成 $$ t[i][j]=s[i+j:]+s[:i+j] \ t[i][k]=s[i+k:]+s[:i+k] $$</p>
<p>t[i][j][k]t[i][j][k] 为 t[i][j]t[i][j] 中的第 k 个字符，t[i][k][j]t[i][k][j] 为 t[i][k]t[i][k] 中的第 j 个字符。无论是 i+j+ki+j+k 是否超过 <code>len(s)</code> 两者都始终保持一致，即 t[i][j][k]=t[i][k][j]t[i][j][k]=t[i][k][j] 。</p>
<p>故而，其实对于相同的明文来说，可能有多个密钥使其生成相同的密文。</p>
<p>然而上面分析就是单纯地分析而已，，下面开始正题。</p>
<p>不难看出，密文的每一位只与明文的相应位相关，而且，密钥的每一位的空间最大也就是 s 的大小，所以我们可以使用爆破来获取密钥。这里根据上述命令行提示，可以知道密钥长度为 14，恰好明文前面 7 个字节已知。恢复密钥的 exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz_{}"</span>
    t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>_l<span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
         <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    i1 <span class="token operator">=</span> <span class="token number">0</span>
    i2 <span class="token operator">=</span> <span class="token number">0</span>
    key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">14</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i1 <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i2 <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> t<span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>plain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>s<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>s<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> cipher<span class="token punctuation">[</span>
                        i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i1<span class="token punctuation">]</span>
                    key<span class="token punctuation">[</span><span class="token number">13</span> <span class="token operator">-</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i2<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>恢复明文的脚本如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> k1<span class="token punctuation">,</span> k2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz_{}"</span>
    t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>_l<span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
         <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    i1 <span class="token operator">=</span> <span class="token number">0</span>
    i2 <span class="token operator">=</span> <span class="token number">0</span>
    plain <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> cipher<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>k1<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span>find<span class="token punctuation">(</span>k2<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">:</span>
                plain <span class="token operator">+=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token keyword">break</span>
        i1 <span class="token operator">=</span> <span class="token punctuation">(</span>i1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>k1<span class="token punctuation">)</span>
        i2 <span class="token operator">=</span> <span class="token punctuation">(</span>i2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">(</span>k2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> plain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到明文如下</p>
<pre><code>➜  2017_seccon_vigenere3d git:(master) python exp.py
SECCON{Welc0me_to_SECCON_CTF_2017}</code></pre><p><strong>解法二</strong></p>
<p>关于此题的分析：</p>
<ol>
<li>考虑到在程序正常运行下，数组访问不会越界，我们在讨论时做以下约定：arr[index]⇔arr[index%len(arr)]arr[index]⇔arr[index%len(arr)]</li>
<li>关于 python 程序中定义的 <code>_l</code> 函数，发现以下等价关系：_l(offset,arr)[index]⇔arr[index+offset]_l(offset,arr)[index]⇔arr[index+offset]</li>
<li>关于 python 的 main 函数中三维矩阵 t 的定义，发现以下等价关系：t[a][b][c]⇔_l(a+b,s)[c]t[a][b][c]⇔_l(a+b,s)[c]</li>
<li>综合第 2 第 3 点的观察，有如下等价关系：t[a][b][c]⇔s[a+b+c]t[a][b][c]⇔s[a+b+c]</li>
<li>我们将 s 视为一种编码格式，即：编码过程 s.find(x)，解码过程 s[x]。并直接使用其编码结果的数字替代其所代指的字符串，那么加密过程可以用以下公式表示：</li>
<li>e=f+k1+k2e=f+k1+k2</li>
<li>其中，e 是密文，f 是明文，k1 与 k2 是通过复制方法得到、与 f 长度一样的密钥，<strong>加法是向量加</strong>。</li>
</ol>
<p>所以我们只需要通过计算 <code>k1+k2</code> ，模拟密钥，即可解密。关于此题的解密 python 脚本：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># exp2.py</span>
enc_str <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz_{}'</span>
dec_dic <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span>v <span class="token keyword">for</span> v<span class="token punctuation">,</span>k <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>enc_str<span class="token punctuation">)</span><span class="token punctuation">}</span>
encrypt <span class="token operator">=</span> <span class="token string">'POR4dnyTLHBfwbxAAZhe}}ocZR3Cxcftw9'</span>
flag_bg <span class="token operator">=</span> <span class="token string">'SECCON{**************************}'</span>

sim_key <span class="token operator">=</span> <span class="token punctuation">[</span>dec_dic<span class="token punctuation">[</span>encrypt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">-</span>dec_dic<span class="token punctuation">[</span>flag_bg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 破解模拟密钥</span>
sim_key <span class="token operator">=</span> sim_key <span class="token operator">+</span> sim_key<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

flag_ed <span class="token operator">=</span> <span class="token punctuation">[</span>dec_dic<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">-</span>sim_key<span class="token punctuation">[</span>k<span class="token operator">%</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>encrypt<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 模拟密钥解密</span>
flag_ed <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>enc_str<span class="token punctuation">[</span>i<span class="token operator">%</span>len<span class="token punctuation">(</span>enc_str<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> flag_ed<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 解码</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag_ed<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到明文如下：</p>
<pre><code>$ python exp2.py
SECCON{Welc0me_to_SECCON_CTF_2017}</code></pre><h2 id="消失的三重密码"><a href="#消失的三重密码" class="headerlink" title="消失的三重密码"></a>消失的三重密码</h2><p>密文</p>
<pre><code>of zit kggd zitkt qkt ygxk ortfzoeqs wqlatzwqssl qfr zvg ortfzoeqs yggzwqssl. fgv oy ngx vqfz zg hxz zitd of gft soft.piv dgfn lgsxzogfl qkt zitkt? zohl:hstqlt eiqfut zit ygkd gy zit fxdwtk ngx utz.zit hkgukqddtkl!</code></pre><p>使用 quipquip 直接解密。</p>
<h1 id="流密码"><a href="#流密码" class="headerlink" title="流密码"></a>流密码</h1><p>流密码一般逐字节或者逐比特处理信息。一般来说</p>
<ul>
<li>流密码的密钥长度会与明文的长度相同。</li>
<li>流密码的密钥派生自一个较短的密钥，派生算法通常为一个伪随机数生成算法。</li>
</ul>
<p>需要注意的是，流加密目前来说都是对称加密。</p>
<p>伪随机数生成算法生成的序列的随机性越强，明文中的统计特征被覆盖的更好。</p>
<p>流密码加解密非常简单，在已知明文的情况下，可以非常容易地获取密钥流。</p>
<p>流密码的关键在于设计好的伪随机数生成器。一般来说，伪随机数生成器的基本构造模块为反馈移位寄存器。当然，也有一些特殊设计的流密码，比如 RC4。</p>
<h1 id="伪随机数生成器"><a href="#伪随机数生成器" class="headerlink" title="伪随机数生成器"></a>伪随机数生成器</h1><h2 id="伪随机数生成器介绍"><a href="#伪随机数生成器介绍" class="headerlink" title="伪随机数生成器介绍"></a>伪随机数生成器介绍</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>伪随机数生成器（pseudorandom number generator，PRNG），又称为确定性随机位生成器（deterministic random bit generator，DRBG），是用来生成<strong>接近于绝对随机数序列的数字序列</strong>的算法。一般来说，PRNG 会依赖于一个初始值，也称为种子，来生成对应的伪随机数序列。只要种子确定了，PRNG 所生成的随机数就是完全确定的，因此其生成的随机数序列并不是真正随机的。</p>
<p>就目前而言，PRNG 在众多应用都发挥着重要的作用，比如模拟（蒙特卡洛方法），电子竞技，密码应用。</p>
<h3 id="随机性的严格性"><a href="#随机性的严格性" class="headerlink" title="随机性的严格性"></a>随机性的严格性</h3><ul>
<li>随机性：随机数应该不存在统计学偏差，是完全杂乱的数列。</li>
<li>不可预测性：不能从过去的序列推测出下一个出现的数。</li>
<li>不可重现性：除非数列保存下来，否则不能重现相同的数列。</li>
</ul>
<p>这三个性质的严格性依次递增。</p>
<p>一般来说，随机数可以分为三类</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>随机性</th>
<th>不可预测性</th>
<th>不可重现性</th>
</tr>
</thead>
<tbody><tr>
<td>弱伪随机数</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>强伪随机数</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>真随机数</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
</tbody></table>
<p>一般来说，密码学中使用的随机数是第二种。</p>
<h3 id="周期"><a href="#周期" class="headerlink" title="周期"></a>周期</h3><p>正如我们之前所说，一旦 PRNG 所依赖的种子确定了，那么 PRNG 生成的随机数序列基本也就确定了。这里定义 PRNG 的周期如下：对于一个 PRNG 的<strong>所有可能起始状态</strong>，不重复序列的最长长度。显然，对于一个 PRNG 来说，其周期不会大于其所有可能的状态。但是，需要注意的是，并不是当我们遇到重复的输出时，就可以认为是 PRNG 的周期，因为 PRNG 的状态一般都是大于输出的位数的。</p>
<h3 id="评价标准"><a href="#评价标准" class="headerlink" title="评价标准"></a>评价标准</h3><p>参见维基百科，<a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator。" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pseudorandom_number_generator。</a></p>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>目前通用的伪随机数生成器主要有</p>
<ul>
<li>线性同余生成器，LCG</li>
<li>线性回归发生器</li>
<li><a href="https://en.wikipedia.org/wiki/Mersenne_Twister" target="_blank" rel="noopener">Mersenne Twister</a></li>
<li><a href="https://en.wikipedia.org/wiki/Xorshift" target="_blank" rel="noopener">xorshift</a> generators</li>
<li><a href="https://en.wikipedia.org/wiki/Well_Equidistributed_Long-period_Linear" target="_blank" rel="noopener">WELL</a> family of generators</li>
<li>Linear feedback shift register，LFSR，线性反馈移位寄存器</li>
</ul>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>通常来说，伪随机数生成器可能会有以下问题</p>
<ul>
<li>在某些种子的情况下，其生成的随机数序列的周期会比较小。</li>
<li>生成大数时，分配的不均匀。</li>
<li>连续值之间关联密切，知道后续值，可以知道之前的值。</li>
<li>输出序列的值的大小很不均匀。</li>
</ul>
<h2 id="密码安全伪随机数生成器"><a href="#密码安全伪随机数生成器" class="headerlink" title="密码安全伪随机数生成器"></a>密码安全伪随机数生成器</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>密码学安全伪随机数生成器（cryptographically secure pseudo-random number generator，CSPRNG），也称为密码学伪随机数生成器（cryptographic pseudo-random number generator，CPRNG），是一种特殊的伪随机数生成器。它需要满足满足一些必要的特性，以便于适合于密码学应用。</p>
<p>密码学的很多方面都需要随机数</p>
<ul>
<li>密钥生成</li>
<li>生成初始化向量，IV，用于分组密码的 CBC，CFB，OFB 模式</li>
<li>nounce，用于防止重放攻击以及分组密码的 CTR 模式等、</li>
<li><a href="https://en.wikipedia.org/wiki/One-time_pad" target="_blank" rel="noopener">one-time pads</a></li>
<li>某些签名方案中的盐，如 <a href="https://en.wikipedia.org/wiki/ECDSA" target="_blank" rel="noopener">ECDSA</a>， <a href="https://en.wikipedia.org/w/index.php?title=RSASSA-PSS&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">RSASSA-PSS</a></li>
</ul>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>毫无疑问，密码学安全伪随机数生成器的要求肯定比一般的伪随机数生成器要高。一般而言，CSPRNG 的要求可以分为两类</p>
<ul>
<li>通过统计随机性测试。CSPRNG 必须通过 <a href="https://en.wikipedia.org/wiki/Next-bit_test" target="_blank" rel="noopener">next-bit test</a>，也就是说，知道了一个序列的前 k 个比特，攻击者不可能在多项式时间内以大于 50% 的概率预测出来下一个比特位。这里特别提及一点，姚期智曾在 1982 年证明，如果一个生成器可以通过 <a href="https://en.wikipedia.org/wiki/Next-bit_test" target="_blank" rel="noopener">next-bit test</a>，那么它也可以通过所有其他的多项式时间统计测试。</li>
<li>必须能够抵抗足够强的攻击，比如当生成器的部分初始状态或者运行时的状态被攻击者获知时，攻击者仍然不能够获取泄漏状态之前的生成的随机数。</li>
</ul>
<h3 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h3><p>就目前而看， CSPRNG 的设计可以分为以下三类</p>
<ul>
<li>基于密码学算法，如密文或者哈希值。</li>
<li>基于数学难题</li>
<li>某些特殊目的的设计</li>
</ul>
<h2 id="2017-Tokyo-Westerns-CTF-3rd-Backpacker’s-Problem"><a href="#2017-Tokyo-Westerns-CTF-3rd-Backpacker’s-Problem" class="headerlink" title="2017 Tokyo Westerns CTF 3rd Backpacker’s Problem"></a>2017 Tokyo Westerns CTF 3rd Backpacker’s Problem</h2><p>题目中给了一个 cpp 文件，大概意思如下</p>
<pre><code>Given the integers a_1, a_2, ..., a_N, your task is to find a subsequence b of a
where b_1 + b_2 + ... + b_K = 0.

Input Format: N a_1 a_2 ... a_N
Answer Format: K b_1 b_2 ... b_K

Example Input:
4 -8 -2 3 5
Example Answer:
3 -8 3 5</code></pre><p>即是一个背包问题。其中，在本题中，我们需要解决 20 个这样的背包问题，背包大小依次是 1 * 10~20 * 10。而子集求和的背包问题是一个 NPC 问题，问题的时间复杂度随着随着背包大小而指数增长。这里背包的大小最大是 200，显然不可能使用暴力破解的方式。</p>
<h1 id="线性同余生成器"><a href="#线性同余生成器" class="headerlink" title="线性同余生成器"></a>线性同余生成器</h1><h2 id="2016-Google-CTF-woodman"><a href="#2016-Google-CTF-woodman" class="headerlink" title="2016 Google CTF woodman"></a>2016 Google CTF woodman</h2><p>程序的大概意思就是一个猜数游戏，如果连续猜中若干次，就算会拿到 flag，背后的生成相应数的核心代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SecurePrng</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># generate seed with 64 bits of entropy</span>
        self<span class="token punctuation">.</span>p <span class="token operator">=</span> 4646704883L
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>p
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>p
        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">^</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们显然，我们猜出前两轮还是比较容易的，毕竟概率也有 0.25。这里当我们猜出前两轮后，使用 Z3 来求解出初始的 x 和 y，那么我们就可以顺利的猜出剩下的值了。</p>
<p>具体的脚本如下，然而 Z3 在解决这样的问题时似乎是有问题的。。。</p>
<p>这里我们考虑另外一种方法，<strong>依次从低比特位枚举到高比特位获取 x 的值</strong>，之所以能够这样做，是依赖于这样的观察</p>
<ul>
<li>a + b = c，c 的第 i 比特位的值只受 a 和 b 该比特位以及更低比特位的影响。<strong>因为第 i 比特位进行运算时，只有可能收到低比特位的进位数值。</strong></li>
<li>a - b = c，c 的第 i 比特位的值只受 a 和 b 该比特位以及更低比特位的影响。<strong>因为第 i 比特位进行运算时，只有可能向低比特位的借位。</strong></li>
<li>a * b = c，c 的第 i 比特位的值只受 a 和 b 该比特位以及更低比特位的影响。因为这可以视作多次加法。</li>
<li>a % b = c，c 的第 i 比特位的值只受 a 和 b 该比特位以及更低比特位的影响。因为这可视为多次进行减法。</li>
<li>a ^ b = c，c 的第 i 比特位的值只受 a 和 b 该比特位的影响。这一点是显而易见的。</li>
</ul>
<p><strong>注：个人感觉这个技巧非常有用。</strong></p>
<p>此外，我们不难得知 p 的比特位为 33 比特位。具体利用思路如下</p>
<ol>
<li>首先获取两次猜到的值，这个概率有 0.25。</li>
<li>依次从低比特位到高比特位依次枚举<strong>第一次迭代后的 x 的相应比特位</strong>。</li>
<li>根据自己枚举的值分别计算出第二次的值，只有当对应比特位正确，可以将其加入候选正确值。需要注意的是，这里由于取模，所以我们需要枚举到底减了多少次。</li>
<li>此外，在最终判断时，仍然需要确保对应的值满足一定要求，因为之前对减了多少次进行了枚举。</li>
</ol>
<p>具体利用代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> product


<span class="token keyword">class</span> <span class="token class-name">SecurePrng</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># generate seed with 64 bits of entropy</span>
        self<span class="token punctuation">.</span>p <span class="token operator">=</span> 4646704883L  <span class="token comment" spellcheck="true"># 33bit</span>
        <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>x <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>x <span class="token operator">=</span> x
        <span class="token keyword">if</span> y <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>y <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>y <span class="token operator">=</span> y

    <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>p
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>p
        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">^</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">getbiti</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> bin<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sp <span class="token operator">=</span> SecurePrng<span class="token punctuation">(</span><span class="token punctuation">)</span>
    targetx <span class="token operator">=</span> sp<span class="token punctuation">.</span>x
    targety <span class="token operator">=</span> sp<span class="token punctuation">.</span>y
    <span class="token keyword">print</span> <span class="token string">"we would like to get x "</span><span class="token punctuation">,</span> targetx
    <span class="token keyword">print</span> <span class="token string">"we would like to get y "</span><span class="token punctuation">,</span> targety

    <span class="token comment" spellcheck="true"># suppose we have already guess two number</span>
    guess1 <span class="token operator">=</span> sp<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
    guess2 <span class="token operator">=</span> sp<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>

    p <span class="token operator">=</span> <span class="token number">4646704883</span>

    <span class="token comment" spellcheck="true"># newx = tmpx*2+3-kx*p</span>
    <span class="token keyword">for</span> kx<span class="token punctuation">,</span> ky <span class="token keyword">in</span> product<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        candidate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># only 33 bit</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">#print 'idx ', i</span>
            new_candidate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> old<span class="token punctuation">,</span> bit <span class="token keyword">in</span> product<span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true">#print old, bit</span>
                oldx <span class="token operator">=</span> old<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token comment" spellcheck="true">#oldy = old[1]</span>
                tmpx <span class="token operator">=</span> oldx <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#tmpy = oldy | ((bit / 2) &lt;&lt; i)</span>
                tmpy <span class="token operator">=</span> tmpx <span class="token operator">^</span> guess1
                newx <span class="token operator">=</span> tmpx <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">-</span> kx <span class="token operator">*</span> p <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">40</span><span class="token punctuation">)</span>
                newy <span class="token operator">=</span> tmpy <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">-</span> ky <span class="token operator">*</span> p <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">40</span><span class="token punctuation">)</span>
                tmp1 <span class="token operator">=</span> newx <span class="token operator">^</span> newy
                <span class="token comment" spellcheck="true">#print "tmpx:    ", bin(tmpx)</span>
                <span class="token comment" spellcheck="true">#print "targetx: ", bin(targetx)</span>
                <span class="token comment" spellcheck="true">#print "calculate:     ", bin(tmp1 + (1 &lt;&lt; 40))</span>
                <span class="token comment" spellcheck="true">#print "target guess2: ", bin(guess1 + (1 &lt;&lt; 40))</span>
                <span class="token keyword">if</span> getbiti<span class="token punctuation">(</span>guess2 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> getbiti<span class="token punctuation">(</span>
                        tmp1 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">[</span>tmpx<span class="token punctuation">]</span> <span class="token operator">not</span> <span class="token keyword">in</span> new_candidate<span class="token punctuation">:</span>
                        <span class="token comment" spellcheck="true">#print "got one"</span>
                        <span class="token comment" spellcheck="true">#print bin(tmpx)</span>
                        <span class="token comment" spellcheck="true">#print bin(targetx)</span>
                        <span class="token comment" spellcheck="true">#print bin(tmpy)</span>
                        new_candidate<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>tmpx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            candidate <span class="token operator">=</span> new_candidate
            <span class="token comment" spellcheck="true">#print len(candidate)</span>
            <span class="token comment" spellcheck="true">#print candidate</span>
        <span class="token keyword">print</span> <span class="token string">"candidate x for kx: "</span><span class="token punctuation">,</span> kx<span class="token punctuation">,</span> <span class="token string">" ky "</span><span class="token punctuation">,</span> ky
        <span class="token keyword">for</span> item <span class="token keyword">in</span> candidate<span class="token punctuation">:</span>
            tmpx <span class="token operator">=</span> candidate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            tmpy <span class="token operator">=</span> tmpx <span class="token operator">^</span> guess1
            <span class="token keyword">if</span> tmpx <span class="token operator">>=</span> p <span class="token operator">or</span> tmpx <span class="token operator">>=</span> p<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            mysp <span class="token operator">=</span> SecurePrng<span class="token punctuation">(</span>tmpx<span class="token punctuation">,</span> tmpy<span class="token punctuation">)</span>
            tmp1 <span class="token operator">=</span> mysp<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> tmp1 <span class="token operator">!=</span> guess2<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">print</span> tmpx<span class="token punctuation">,</span> tmpy
            <span class="token keyword">print</span><span class="token punctuation">(</span>targetx <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> p<span class="token punctuation">,</span> <span class="token punctuation">(</span>targety <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">%</span> p


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="反馈移位寄存器"><a href="#反馈移位寄存器" class="headerlink" title="反馈移位寄存器"></a>反馈移位寄存器</h1><p>一般的，一个 n 级反馈移位寄存器如下图所示</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/n-fsr.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/image-20210817225404246.png" alt=""></p>
<h2 id="线性反馈移位寄存器-LFSR"><a href="#线性反馈移位寄存器-LFSR" class="headerlink" title="线性反馈移位寄存器 - LFSR"></a>线性反馈移位寄存器 - LFSR</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>线性反馈移位寄存器的反馈函数一般如下</p>
<p>$$<br>a_{i+n}=\sum\limits_{j=1}^{n}c_ja_{i+n-j}<br>$$<br>其中，<br>$$<br>c_j<br>$$<br>均在某个有限域 $F_q$ 中。</p>
<p>既然线性空间是一个线性变换，我们可以得知这个线性变换为</p>
<p>$$<br> \begin{align<em>}<br>&amp;\left[<br>  a_{i+1},a_{i+2},a_{i+3}, …,a_{i+n}<br>\right]\\=&amp;\left[<br>  a_{i},a_{i+1},a_{i+2}, …,a_{i+n-1}<br>\right]\left[ \begin{matrix} 0   &amp; 0      &amp; \cdots &amp; 0 &amp; c_n     \ 1   &amp; 0      &amp; \cdots &amp; 0 &amp; c_{n-1}  \ 0   &amp; 1      &amp; \cdots &amp; 0 &amp; c_{n-2}\\vdots &amp; \vdots &amp; \ddots &amp; \vdots \ 0   &amp; 0      &amp; \cdots &amp; 1 &amp; c_1     \ \end{matrix} \right]\\=&amp;\left[<br>  a_{0},a_{1},a_{2}, …,a_{n-1}<br>\right]\left[ \begin{matrix} 0   &amp; 0      &amp; \cdots &amp; 0 &amp; c_n     \ 1   &amp; 0      &amp; \cdots &amp; 0 &amp; c_{n-1}  \ 0   &amp; 1      &amp; \cdots &amp; 0 &amp; c_{n-2}\\vdots &amp; \vdots &amp; \ddots &amp; \vdots \ 0   &amp; 0      &amp; \cdots &amp; 1 &amp; c_1     \ \end{matrix} \right]^{i+1}<br>\end{align</em>}<br>$$<br>进而，我们可以求得其特征多项式为</p>
<p>$$<br>f(x)=x^n-\sum\limits_{i=1}^{n}c_ix^{n-i}<br>$$<br>同时，我们定义其互反多项式为</p>
<p>$$<br>\overline f(x)=x^nf(\frac{1}{x})=1-\sum\limits_{i=1}^{n}c_ix^{i}<br>$$<br>我们也称互反多项式为线性反馈移位寄存器的联结多项式。</p>
<p>这里有一些定理需要我们记一下，感兴趣的可以自行推导。</p>
<h3 id="特征多项式与生成函数"><a href="#特征多项式与生成函数" class="headerlink" title="特征多项式与生成函数"></a>特征多项式与生成函数</h3><p>已知某个 n 级线性反馈移位寄存器的特征多项式，那么该序列对应的生成函数为</p>
<p>$$<br>A(x)=\frac{p(x)}{\overline f(x)}<br>$$</p>
<p>其中，$p(x)=\sum\limits_{i=1}^{n}(c_{n-i}x^{n-i}\sum\limits_{j=1}^{i}a_jx^{j-1})$。可以看出 p(x) 完全由初始状态和反馈函数的系数决定。</p>
<h3 id="序列周期与生成函数"><a href="#序列周期与生成函数" class="headerlink" title="序列周期与生成函数"></a>序列周期与生成函数</h3><p>序列的的周期为其生成函数的既约真分式的分母的周期。</p>
<p>对于 n 级线性反馈移位寄存器，最长周期为 $2^{n}-1$（排除全零）。达到最长周期的序列一般称为 m 序列。</p>
<h3 id="特殊性质"><a href="#特殊性质" class="headerlink" title="特殊性质"></a>特殊性质</h3><ul>
<li>将两个序列累加得到新的序列的周期为这两个序列的周期的和。</li>
<li>序列是 n 级 m 序列，当且仅当序列的极小多项式是 n 次本原多项式。</li>
</ul>
<h3 id="B-M-算法"><a href="#B-M-算法" class="headerlink" title="B-M 算法"></a>B-M 算法</h3><p>一般来说，我们可以从两种角度来考虑 LFSR</p>
<ul>
<li>密钥生成角度，一般我们希望使用级数尽可能低的 LFSR 来生成周期大，随机性好的序列。</li>
<li>密码分析角度，给定一个长度为 n 的序列 a，如何构造一个级数尽可能小的 LFSR 来生成它。其实这就是 B-M 算法的来源。</li>
</ul>
<p>一般来说，我们定义一个序列的线性复杂度如下</p>
<ul>
<li>若 s 为一个全零序列，则线性复杂度为0。</li>
<li>若没有 LFSR 能生成 s，则线性复杂度为无穷。</li>
<li>否则，s 的线性复杂度为生成 L(s) 的最小级的 LFSR。</li>
</ul>
<p>BM 算法的要求我们需要知道长度为 2n 的序列。其复杂度</p>
<ul>
<li>时间复杂度：O(n^2) 次比特操作</li>
<li>空间复杂度：O(n) 比特。</li>
</ul>
<p>关于 BM 算法的细节，后续添加，目前处于学习过程中。</p>
<p>但是其实如果我们知道了长度为 2n 的序列，我们也可以一种比较笨的方法来获取原先的序列。不妨假设已知的序列为$a_1,…,a_{2n}$，我们可以令</p>
<p>$S_1=(a_1,…,a_n)$</p>
<p>$S_2=(a_2,…,a_{n+1})$</p>
<p>….</p>
<p>$S_{n+1}=(a_{n+1},…,a_{2n})$</p>
<p>那么我们可以构造矩阵 $X=(S_1,…,S_n)$，那么</p>
<p>$S_{n+1}=(c_n,…,c_1)X$</p>
<p>所以</p>
<p>$(c_n,…,c_1)=S_{n+1}X^{-1}$</p>
<p>进而我们也就知道了 LFSR 的反馈表达式，进而我们就可以推出初始化种子。</p>
<h3 id="2018-强网杯-streamgame1"><a href="#2018-强网杯-streamgame1" class="headerlink" title="2018 强网杯 streamgame1"></a>2018 强网杯 streamgame1</h3><p>简单看一下题目</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> flag
<span class="token keyword">assert</span> flag<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"flag{"</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> flag<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> len<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">25</span>

<span class="token keyword">def</span> <span class="token function">lfsr</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> <span class="token punctuation">(</span>R <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffff</span>
    i<span class="token operator">=</span><span class="token punctuation">(</span>R<span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffffff</span>
    lastbit<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">while</span> i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        lastbit<span class="token operator">^</span><span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>
        i<span class="token operator">=</span>i<span class="token operator">>></span><span class="token number">1</span>
    output<span class="token operator">^</span><span class="token operator">=</span>lastbit
    <span class="token keyword">return</span> <span class="token punctuation">(</span>output<span class="token punctuation">,</span>lastbit<span class="token punctuation">)</span>



R<span class="token operator">=</span>int<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
mask    <span class="token operator">=</span>   <span class="token number">0b1010011000100011100</span>

f<span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span><span class="token string">"ab"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tmp<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span>R<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token operator">=</span>lfsr<span class="token punctuation">(</span>R<span class="token punctuation">,</span>mask<span class="token punctuation">)</span>
        tmp<span class="token operator">=</span><span class="token punctuation">(</span>tmp <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">^</span>out
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chr<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现，flag 的长度为25-5-1=19，所以可以暴力枚举。结果</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-强网杯-streamgame1 git:(master) ✗ python exp.py
12
0b1110101100001101011<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>因此 flag 为 flag{1110101100001101011}。</p>
<h3 id="2018-CISCN-初赛-oldstreamgame"><a href="#2018-CISCN-初赛-oldstreamgame" class="headerlink" title="2018 CISCN 初赛 oldstreamgame"></a>2018 CISCN 初赛 oldstreamgame</h3><p>简单看一下题目</p>
<pre class="line-numbers language-shell"><code class="language-shell">flag = "flag{xxxxxxxxxxxxxxxx}"
assert flag.startswith("flag{")
assert flag.endswith("}")
assert len(flag)==14

def lfsr(R,mask):
    output = (R << 1) & 0xffffffff
    i=(R&mask)&0xffffffff
    lastbit=0
    while i!=0:
        lastbit^=(i&1)
        i=i>>1
    output^=lastbit
    return (output,lastbit)

R=int(flag[5:-1],16)
mask = 0b10100100000010000000100010010100

f=open("key","w")
for i in range(100):
    tmp=0
    for j in range(8):
        (R,out)=lfsr(R,mask)
        tmp=(tmp << 1)^out
    f.write(chr(tmp))
f.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序很简单，仍然是一个 LFSR，但是初态是 32 比特位，当然，我们也可以选择爆破，但是这里不选择爆破。</p>
<p>这里给出两种做法。</p>
<p>第一种做法，程序输出的第 32 个比特是由程序输出的前 31 个比特和初始种子的第 1 个比特来决定的，因此我们可以知道初始种子的第一个比特，进而可以知道初始种子的第 2 个比特，依次类推。代码如下</p>
<pre class="line-numbers language-python"><code class="language-python">mask <span class="token operator">=</span> <span class="token number">0b10100100000010000000100010010100</span>
b <span class="token operator">=</span> <span class="token string">''</span>
N <span class="token operator">=</span> <span class="token number">32</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    b <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> ord<span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        key <span class="token operator">+=</span> str<span class="token punctuation">(</span>t <span class="token operator">>></span> j <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span>
idx <span class="token operator">=</span> <span class="token number">0</span>
ans <span class="token operator">=</span> <span class="token string">""</span>
key <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span>
<span class="token keyword">while</span> idx <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
    tmp <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> mask <span class="token operator">>></span> i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            tmp <span class="token operator">^</span><span class="token operator">=</span> int<span class="token punctuation">(</span>key<span class="token punctuation">[</span><span class="token number">31</span> <span class="token operator">-</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    ans <span class="token operator">=</span> str<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">+</span> ans
    idx <span class="token operator">+=</span> <span class="token number">1</span>
    key <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">]</span>
num <span class="token operator">=</span> int<span class="token punctuation">(</span>ans<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-CISCN-start-oldstreamgame git:(master) ✗ python exp1.py
0x926201d7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>第二种做法，我们可以考虑一下矩阵转换的过程，如果进行了 32 次线性变换，那么就可以得到输出流前 32 个比特。而其实，我们只需要前 32 个比特就可以恢复初始状态了。</p>
<pre class="line-numbers language-python"><code class="language-python">mask <span class="token operator">=</span> <span class="token number">0b10100100000010000000100010010100</span>

N <span class="token operator">=</span> <span class="token number">32</span>
F <span class="token operator">=</span> GF<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

b <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    b <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

R <span class="token operator">=</span> <span class="token punctuation">[</span>vector<span class="token punctuation">(</span>F<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    R<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> mask <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">31</span> <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    R<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
M <span class="token operator">=</span> Matrix<span class="token punctuation">(</span>F<span class="token punctuation">,</span> R<span class="token punctuation">)</span>
M <span class="token operator">=</span> M <span class="token operator">^</span> N

vec <span class="token operator">=</span> vector<span class="token punctuation">(</span>F<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
row <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> ord<span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        vec<span class="token punctuation">[</span>row<span class="token punctuation">]</span> <span class="token operator">=</span> t <span class="token operator">>></span> j <span class="token operator">&amp;</span> <span class="token number">1</span>
        row <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token keyword">print</span> rank<span class="token punctuation">(</span>M<span class="token punctuation">)</span>
num <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> list<span class="token punctuation">(</span>M<span class="token punctuation">.</span>solve_left<span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行脚本</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-CISCN-start-oldstreamgame git:(master) ✗ sage exp.sage
32
0x926201d7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从而 flag 为 flag{926201d7}。</p>
<p>还有一种做法是 TokyoWesterns 的，可以参考对应的文件夹的文件。</p>
<h2 id="非线性反馈移位寄存器"><a href="#非线性反馈移位寄存器" class="headerlink" title="非线性反馈移位寄存器"></a>非线性反馈移位寄存器</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>为了使得密钥流输出的序列尽可能复杂，会使用非线性反馈移位寄存器，常见的有三种</p>
<ul>
<li>非线性组合生成器，对多个 LFSR 的输出使用一个非线性组合函数</li>
<li>非线性滤波生成器，对一个 LFSR 的内容使用一个非线性组合函数</li>
<li>钟控生成器，使用一个（或多个）LFSR 的输出来控制另一个（或多个）LFSR 的时钟</li>
</ul>
<h3 id="非线性组合生成器"><a href="#非线性组合生成器" class="headerlink" title="非线性组合生成器"></a>非线性组合生成器</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>组合生成器一般如下图所示。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/combine-generator.png" alt=""></p>
<h4 id="Geffe"><a href="#Geffe" class="headerlink" title="Geffe"></a>Geffe</h4><p>这里我们以 Geffe 为例进行介绍。Geffe 包含 3 个线性反馈移位寄存器，非线性组合函数为<br>$$<br>F(x1,x2,x3)=(x1\andx2)⊕(┐x1\andx3)=(x1\andx2)⊕(x1\andx3)⊕x3F(x1,x2,x3)=(x1\andx2)⊕(⌝x1\andx3)=(x1\andx2)⊕(x1\andx3)⊕x3<br>$$</p>
<h5 id="2018-强网杯-streamgame3"><a href="#2018-强网杯-streamgame3" class="headerlink" title="2018 强网杯 streamgame3"></a>2018 强网杯 streamgame3</h5><p>简单看一下题目</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> flag
<span class="token keyword">assert</span> flag<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"flag{"</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> flag<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> len<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">24</span>

<span class="token keyword">def</span> <span class="token function">lfsr</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> <span class="token punctuation">(</span>R <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffff</span>
    i<span class="token operator">=</span><span class="token punctuation">(</span>R<span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffffff</span>
    lastbit<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">while</span> i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        lastbit<span class="token operator">^</span><span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>
        i<span class="token operator">=</span>i<span class="token operator">>></span><span class="token number">1</span>
    output<span class="token operator">^</span><span class="token operator">=</span>lastbit
    <span class="token keyword">return</span> <span class="token punctuation">(</span>output<span class="token punctuation">,</span>lastbit<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">single_round</span><span class="token punctuation">(</span>R1<span class="token punctuation">,</span>R1_mask<span class="token punctuation">,</span>R2<span class="token punctuation">,</span>R2_mask<span class="token punctuation">,</span>R3<span class="token punctuation">,</span>R3_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">(</span>R1_NEW<span class="token punctuation">,</span>x1<span class="token punctuation">)</span><span class="token operator">=</span>lfsr<span class="token punctuation">(</span>R1<span class="token punctuation">,</span>R1_mask<span class="token punctuation">)</span>
    <span class="token punctuation">(</span>R2_NEW<span class="token punctuation">,</span>x2<span class="token punctuation">)</span><span class="token operator">=</span>lfsr<span class="token punctuation">(</span>R2<span class="token punctuation">,</span>R2_mask<span class="token punctuation">)</span>
    <span class="token punctuation">(</span>R3_NEW<span class="token punctuation">,</span>x3<span class="token punctuation">)</span><span class="token operator">=</span>lfsr<span class="token punctuation">(</span>R3<span class="token punctuation">,</span>R3_mask<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>R1_NEW<span class="token punctuation">,</span>R2_NEW<span class="token punctuation">,</span>R3_NEW<span class="token punctuation">,</span><span class="token punctuation">(</span>x1<span class="token operator">*</span>x2<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x2<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>x3<span class="token punctuation">)</span><span class="token punctuation">)</span>

R1<span class="token operator">=</span>int<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
R2<span class="token operator">=</span>int<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
R3<span class="token operator">=</span>int<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> len<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>R1<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">17</span>
<span class="token keyword">assert</span> len<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">19</span>
<span class="token keyword">assert</span> len<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>R3<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">21</span>
R1_mask<span class="token operator">=</span><span class="token number">0x10020</span>
R2_mask<span class="token operator">=</span><span class="token number">0x4100c</span>
R3_mask<span class="token operator">=</span><span class="token number">0x100002</span>


<span class="token keyword">for</span> fi <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> fi
    tmp1mb<span class="token operator">=</span><span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp1kb<span class="token operator">=</span><span class="token string">""</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp<span class="token operator">=</span><span class="token number">0</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token punctuation">(</span>R1<span class="token punctuation">,</span>R2<span class="token punctuation">,</span>R3<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token operator">=</span>single_round<span class="token punctuation">(</span>R1<span class="token punctuation">,</span>R1_mask<span class="token punctuation">,</span>R2<span class="token punctuation">,</span>R2_mask<span class="token punctuation">,</span>R3<span class="token punctuation">,</span>R3_mask<span class="token punctuation">)</span>
                tmp <span class="token operator">=</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> out
            tmp1kb<span class="token operator">+=</span>chr<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        tmp1mb<span class="token operator">+=</span>tmp1kb
    f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"./output/"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ab"</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tmp1mb<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，该程序与 Geffe 生成器非常类似，这里我们使用相关攻击方法进行攻击，我们可以统计一下在三个 LFSR 输出不同的情况下，最后类 Geffe 生成器的输出，如下</p>
<table>
<thead>
<tr>
<th align="left">x1x1</th>
<th align="left">x2x2</th>
<th align="left">x3x3</th>
<th align="left">F(x1,x2,x3)F(x1,x2,x3)</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>可以发现</p>
<ul>
<li>Geffe 的输出与 x1x1 相同的概率为 0.75</li>
<li>Geffe 的输出与 x2x2 相同的概率为 0.5</li>
<li>Geffe 的输出与 x3x3 相同的概率为 0.75</li>
</ul>
<p>这说明输出与第一个和第三个的关联性非常大。 因此，我们可以暴力去枚举第一个和第三个 LFSR 的输出判断其与 类 Geffe 的输出相等的个数，如果大约在 75% 的话，就可以认为是正确的。第二个就直接暴力枚举了。</p>
<p>脚本如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#for x1 in range(2):</span>
<span class="token comment" spellcheck="true">#    for x2 in range(2):</span>
<span class="token comment" spellcheck="true">#        for x3 in range(2):</span>
<span class="token comment" spellcheck="true">#            print x1,x2,x3,(x1*x2)^((x2^1)*x3)</span>
<span class="token comment" spellcheck="true">#n = [17,19,21]</span>

<span class="token comment" spellcheck="true">#cycle = 1</span>
<span class="token comment" spellcheck="true">#for i in n:</span>
<span class="token comment" spellcheck="true">#    cycle = cycle*(pow(2,i)-1)</span>
<span class="token comment" spellcheck="true">#print cycle</span>


<span class="token keyword">def</span> <span class="token function">lfsr</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> <span class="token punctuation">(</span>R <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffff</span>
    i <span class="token operator">=</span> <span class="token punctuation">(</span>R <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffff</span>
    lastbit <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        lastbit <span class="token operator">^</span><span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">>></span> <span class="token number">1</span>
    output <span class="token operator">^</span><span class="token operator">=</span> lastbit
    <span class="token keyword">return</span> <span class="token punctuation">(</span>output<span class="token punctuation">,</span> lastbit<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">single_round</span><span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R1_mask<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> R2_mask<span class="token punctuation">,</span> R3<span class="token punctuation">,</span> R3_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">(</span>R1_NEW<span class="token punctuation">,</span> x1<span class="token punctuation">)</span> <span class="token operator">=</span> lfsr<span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R1_mask<span class="token punctuation">)</span>
    <span class="token punctuation">(</span>R2_NEW<span class="token punctuation">,</span> x2<span class="token punctuation">)</span> <span class="token operator">=</span> lfsr<span class="token punctuation">(</span>R2<span class="token punctuation">,</span> R2_mask<span class="token punctuation">)</span>
    <span class="token punctuation">(</span>R3_NEW<span class="token punctuation">,</span> x3<span class="token punctuation">)</span> <span class="token operator">=</span> lfsr<span class="token punctuation">(</span>R3<span class="token punctuation">,</span> R3_mask<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>R1_NEW<span class="token punctuation">,</span> R2_NEW<span class="token punctuation">,</span> R3_NEW<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">*</span> x2<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x3<span class="token punctuation">)</span><span class="token punctuation">)</span>


R1_mask <span class="token operator">=</span> <span class="token number">0x10020</span>
R2_mask <span class="token operator">=</span> <span class="token number">0x4100c</span>
R3_mask <span class="token operator">=</span> <span class="token number">0x100002</span>
n3 <span class="token operator">=</span> <span class="token number">21</span>
n2 <span class="token operator">=</span> <span class="token number">19</span>
n1 <span class="token operator">=</span> <span class="token number">17</span>


<span class="token keyword">def</span> <span class="token function">guess</span><span class="token punctuation">(</span>beg<span class="token punctuation">,</span> end<span class="token punctuation">,</span> num<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ansn <span class="token operator">=</span> range<span class="token punctuation">(</span>beg<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
    data <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./output/0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">+</span> ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> data<span class="token punctuation">)</span>
    now <span class="token operator">=</span> <span class="token number">0</span>
    res <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> ansn<span class="token punctuation">:</span>
        r <span class="token operator">=</span> i
        cnt <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            r<span class="token punctuation">,</span> lastbit <span class="token operator">=</span> lfsr<span class="token punctuation">(</span>r<span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
            lastbit <span class="token operator">=</span> str<span class="token punctuation">(</span>lastbit<span class="token punctuation">)</span>
            cnt <span class="token operator">+=</span> <span class="token punctuation">(</span>lastbit <span class="token operator">==</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cnt <span class="token operator">></span> now<span class="token punctuation">:</span>
            now <span class="token operator">=</span> cnt
            res <span class="token operator">=</span> i
            <span class="token keyword">print</span> now<span class="token punctuation">,</span> res
    <span class="token keyword">return</span> res


<span class="token keyword">def</span> <span class="token function">bruteforce2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./output/0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">+</span> ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> data<span class="token punctuation">)</span>
    <span class="token keyword">for</span> y <span class="token keyword">in</span> range<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        R1<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> R3 <span class="token operator">=</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z
        flag <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> R3<span class="token punctuation">,</span>
             out<span class="token punctuation">)</span> <span class="token operator">=</span> single_round<span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R1_mask<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> R2_mask<span class="token punctuation">,</span> R3<span class="token punctuation">,</span> R3_mask<span class="token punctuation">)</span>
            <span class="token keyword">if</span> str<span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">!=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                flag <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> y <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">'now: '</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z
        <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">'ans: '</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>


R1 <span class="token operator">=</span> guess<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> R1_mask<span class="token punctuation">)</span>
<span class="token keyword">print</span> R1
R3 <span class="token operator">=</span> guess<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> R3_mask<span class="token punctuation">)</span>
<span class="token keyword">print</span> R3
R1 <span class="token operator">=</span> <span class="token number">113099</span>
R3 <span class="token operator">=</span> <span class="token number">1487603</span>

bruteforce2<span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果如下</p>
<pre><code>➜  2018-CISCN-start-streamgame3 git:(master) ✗ python exp.py
161 65536
172 65538
189 65545
203 65661
210 109191
242 113099
113099
157 1048576
165 1048578
183 1048580
184 1049136
186 1049436
187 1049964
189 1050869
190 1051389
192 1051836
194 1053573
195 1055799
203 1060961
205 1195773
212 1226461
213 1317459
219 1481465
239 1487603
1487603
now:  113099 270000 1487603
now:  113099 280000 1487603
now:  113099 290000 1487603
now:  113099 300000 1487603
now:  113099 310000 1487603
now:  113099 320000 1487603
now:  113099 330000 1487603
now:  113099 340000 1487603
now:  113099 350000 1487603
now:  113099 360000 1487603
ans:  1b9cb 5979c 16b2f3</code></pre><p>从而 flag 为 flag{01b9cb05979c16b2f3}。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2017 WHCTF Bornpig</li>
<li>2018 Google CTF 2018 Betterzip</li>
</ul>
<h1 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h1><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>RSA 由 Ron Rivest 设计，最初隶属于 RSA 安全公司，是一个专利密码产品。它是面向字节的流密码，密钥长度可变，非常简单，但也很有效果。RC4 算法广泛应用于 SSL/TLS 协议和 WEP/WPA 协议。</p>
<h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><p>RC4 主要包含三个流程</p>
<ul>
<li>初始化 S 和 T 数组。</li>
<li>初始化置换 S。</li>
<li>生成密钥流。</li>
</ul>
<h3 id="初始化-S-和-T-数组"><a href="#初始化-S-和-T-数组" class="headerlink" title="初始化 S 和 T 数组"></a>初始化 S 和 T 数组</h3><p>初始化 S 和 T 的代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> to <span class="token number">255</span> do
    S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
    T<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> K<span class="token punctuation">[</span>i mod keylen<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/CTF/rc4_s_t.png" alt=""></p>
<h3 id="初始化置换-S"><a href="#初始化置换-S" class="headerlink" title="初始化置换 S"></a>初始化置换 S</h3><pre class="line-numbers language-python"><code class="language-python">j <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> to <span class="token number">255</span> do 
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> T<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mod <span class="token number">256</span><span class="token punctuation">)</span> 
    swap <span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/CTF/rc4_s.png" alt=""></p>
<h3 id="生成流密钥"><a href="#生成流密钥" class="headerlink" title="生成流密钥"></a>生成流密钥</h3><pre class="line-numbers language-python"><code class="language-python">i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span> 
<span class="token keyword">for</span> each message byte b
    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mod <span class="token number">256</span><span class="token punctuation">)</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mod <span class="token number">256</span><span class="token punctuation">)</span>
    swap<span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> <span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mod <span class="token number">256</span><span class="token punctuation">)</span> 
    <span class="token keyword">print</span> S<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/CTF/rc4_key.png" alt=""></p>
<p>我们一般称前两部分为 KSA ，最后一部分是 PRGA。</p>
<h1 id="块加密"><a href="#块加密" class="headerlink" title="块加密"></a>块加密</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>所谓块加密就是每次加密一块明文，常见的加密算法有</p>
<ul>
<li>IDEA 加密</li>
<li>DES 加密</li>
<li>AES 加密</li>
</ul>
<p>块加密也是对称加密。</p>
<p>其实，我们也可以把块加密理解一种特殊的替代密码，但是其每次替代的是一大块。而正是由于一大块，明文空间巨大，而且对于不同的密钥，我们无法做一个表进行对应相应的密文，因此必须得有 <strong>复杂</strong> 的加解密算法来加解密明密文。</p>
<p>而与此同时，明文往往可能很长也可能很短，因此在块加密时往往需要两个辅助</p>
<ul>
<li>padding，即 padding 到指定分组长度</li>
<li>分组加密模式，即明文分组加密的方式。</li>
</ul>
<h2 id="基本策略"><a href="#基本策略" class="headerlink" title="基本策略"></a>基本策略</h2><p>在分组密码设计时，充分使用了 Shannon 提出的两大策略：混淆与扩散两大策略。</p>
<h3 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h3><p>混淆，Confusion，将密文与密钥之间的统计关系变得尽可能复杂，使得攻击者即使获取了密文的一些统计特性，也无法推测密钥。一般使用复杂的非线性变换可以得到很好的混淆效果，常见的方法如下</p>
<ul>
<li>S 盒</li>
<li>乘法</li>
</ul>
<h3 id="扩散"><a href="#扩散" class="headerlink" title="扩散"></a>扩散</h3><p>扩散，Diffusion，使得明文中的每一位影响密文中的许多位。常见的方法有</p>
<ul>
<li>线性变换</li>
<li>置换</li>
<li>移位，循环移位</li>
</ul>
<h2 id="常见加解密结构"><a href="#常见加解密结构" class="headerlink" title="常见加解密结构"></a>常见加解密结构</h2><p>目前块加密中主要使用的是结构是</p>
<ul>
<li>迭代结构，这是因为迭代结构便于设计与实现，同时方便安全性评估。</li>
</ul>
<h3 id="迭代结构"><a href="#迭代结构" class="headerlink" title="迭代结构"></a>迭代结构</h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>迭代结构基本如下，一般包括三个部分</p>
<ul>
<li>密钥置换</li>
<li>轮加密函数</li>
<li>轮解密函数</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/CTF/iterated_cipher.png" alt=""></p>
<h4 id="轮函数"><a href="#轮函数" class="headerlink" title="轮函数"></a>轮函数</h4><p>目前来说，轮函数主要有主要有以下设计方法</p>
<ul>
<li>Feistel Network，由 Horst Feistel 发明，DES 设计者之一。<ul>
<li>DES</li>
</ul>
</li>
<li>Substitution-Permutation Network(SPN)<ul>
<li>AES</li>
</ul>
</li>
<li>其他方案</li>
</ul>
<h4 id="密钥扩展"><a href="#密钥扩展" class="headerlink" title="密钥扩展"></a>密钥扩展</h4><p>目前，密钥扩展的方法有很多，没有见到什么完美的密钥扩展方法，基本原则是使得密钥的每一个比特尽可能影响多轮的轮密钥。</p>
<h1 id="ARX-Add-Rotate-Xor"><a href="#ARX-Add-Rotate-Xor" class="headerlink" title="ARX: Add-Rotate-Xor"></a>ARX: Add-Rotate-Xor</h1><h2 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h2><p>ARX 运算是如下 3 种基本运算的统称 - Add 有限域上的模加 - Rotate 循环移位 - Xor 异或</p>
<p>有许多常见的块加密算法在轮函数中只用到了这 3 种基本运算，典型例子如 Salsa20、Speck 等。另外 IDEA 也采用了类似的基本运算来构建加解密操作，不过以乘法代替了移位。</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>操作简单，运算速度快</li>
<li>执行时间为常数，可以避免基于时间的测信道攻击</li>
<li>组合后的函数表达能力足够强（参见下方例题）</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>在三种基本运算当中，Rotate、Xor 对于单个 bit 来说均是完全线性的运算，可能会带来一定的脆弱性 (参见 <a href="https://en.wikipedia.org/wiki/Rotational_cryptanalysis" target="_blank" rel="noopener">Rotational cryptanalysis</a>)</li>
</ul>
<h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><h3 id="2018-ctf-primitive"><a href="#2018-ctf-primitive" class="headerlink" title="2018 *ctf primitive"></a>2018 *ctf primitive</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>本题要求我们组合一定数目以内的 Add-Rotate-Xor 运算，使得获得的加密算法能够将固定明文加密成指定的随机密文，即通过基础运算来构建任意置换函数。成功构建 3 次之后即可获得 flag。</p>
<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p>对于模 256 下的运算，一种典型的基于 ARX 的换位操作可以表示为如下组合</p>
<pre><code>RotateLeft_1(Add_255(RotateLeft_7(Add_2(x))))</code></pre><p>上述函数对应了一个将 254 和 255 进行交换，同时保持其它数字不变的置换运算。</p>
<p>直觉上来说，由于在第一步的模加 2 运算中，仅有输入为 254、255 时会发生进位，该组合函数得以区别对待这一情况。</p>
<p>利用上述原子操作，我们可以构造出任意两个数字 <code>a,b</code> 的置换，结合 Xor 操作，我们可以减少所需的基本操作数目，使其满足题目给出的限制。一种可能的操作步骤如下：</p>
<ol>
<li>对于 <code>a,b</code>，通过模加操作使得 <code>a</code> 为 0</li>
<li>通过右移使得 b 的最低位为 1</li>
<li>若 <code>b</code> 不为 1，进行 <code>Xor 1, Add 255</code> 操作，保持 <code>a</code> 仍然为 0，同时 <code>b</code> 的数值减小</li>
<li>重复操作 2-3 直至 <code>b</code> 为 1</li>
<li>进行 <code>Add 254</code> 及换位操作，交换 <code>a,b</code></li>
<li>对于换位以外的所有操作，加入对应的逆运算，确保 <code>a,b</code> 以外的数值不变</li>
</ol>
<p>完整的解题脚本如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> string
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha256

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token keyword">def</span> <span class="token function">dopow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    chal <span class="token operator">=</span> c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    post <span class="token operator">=</span> chal<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">]</span>
    tar <span class="token operator">=</span> chal<span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    c<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    found <span class="token operator">=</span> iters<span class="token punctuation">.</span>bruteforce<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>sha256<span class="token punctuation">(</span>x<span class="token operator">+</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>tar<span class="token punctuation">,</span> string<span class="token punctuation">.</span>ascii_letters<span class="token operator">+</span>string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>found<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#c = remote('127.0.0.1',10001)</span>
c <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'47.75.4.252'</span><span class="token punctuation">,</span><span class="token number">10001</span><span class="token punctuation">)</span>
dopow<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt<span class="token operator">=</span><span class="token string">'GoodCipher'</span>

<span class="token keyword">def</span> <span class="token function">doswap</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> a<span class="token operator">==</span>b<span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    <span class="token keyword">if</span> a<span class="token operator">></span>b<span class="token punctuation">:</span>
        tmp<span class="token operator">=</span>b
        b<span class="token operator">=</span>a
        a<span class="token operator">=</span>tmp
    ans<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token operator">-</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    b<span class="token operator">-=</span>a
    a<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">while</span> b<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">:</span>
        tmp<span class="token operator">=</span><span class="token number">0</span>
        lo<span class="token operator">=</span><span class="token number">1</span>
        <span class="token keyword">while</span> b<span class="token operator">&amp;</span>lo<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            lo<span class="token operator">&lt;&lt;</span><span class="token operator">=</span><span class="token number">1</span>
            tmp<span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">if</span> b<span class="token operator">==</span>lo<span class="token punctuation">:</span>
            ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">-</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span> tmp<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
            ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">-</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        b<span class="token operator">>></span><span class="token operator">=</span>tmp
        ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        b<span class="token operator">^</span><span class="token operator">=</span><span class="token number">1</span>
        ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        b<span class="token operator">-=</span><span class="token number">1</span>
    ans<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">254</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> a<span class="token punctuation">,</span>b <span class="token keyword">in</span> ans<span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%d %d'</span><span class="token operator">%</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> a<span class="token punctuation">,</span>b <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%d %d'</span><span class="token operator">%</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> a<span class="token punctuation">,</span>b <span class="token keyword">in</span> ans<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> a<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%d %d'</span><span class="token operator">%</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">256</span><span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> a<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%d %d'</span><span class="token operator">%</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> a<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%d %d'</span><span class="token operator">%</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> i
    m<span class="token operator">=</span>range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ciphertext is '</span><span class="token punctuation">)</span>
    ct<span class="token operator">=</span>c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ct<span class="token operator">=</span>ct<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> len<span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">10</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        a<span class="token operator">=</span>ord<span class="token punctuation">(</span>ct<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        b<span class="token operator">=</span>ord<span class="token punctuation">(</span>pt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#print m[a],b</span>
        doswap<span class="token punctuation">(</span>m<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">==</span>b<span class="token punctuation">:</span>
                m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>m<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
                m<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">=</span>b
                <span class="token keyword">break</span>
    c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'-1'</span><span class="token punctuation">)</span>

c<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your flag here.\n'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> c<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="DES"><a href="#DES" class="headerlink" title="DES"></a>DES</h1><h2 id="基本介绍-1"><a href="#基本介绍-1" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>Data Encryption Standard(DES)，数据加密标准，是典型的块加密，其基本信息如下</p>
<ul>
<li>输入 64 位。</li>
<li>输出 64 位。</li>
<li>密钥 64 位，使用 64 位密钥中的 56 位，剩余的 8 位要么丢弃，要么作为奇偶校验位。</li>
<li>Feistel 迭代结构<ul>
<li>明文经过 16 轮迭代得到密文。</li>
<li>密文经过类似的 16 轮迭代得到明文。</li>
</ul>
</li>
</ul>
<h2 id="基本流程-1"><a href="#基本流程-1" class="headerlink" title="基本流程"></a>基本流程</h2><p>给出一张简单的 DES 流程图 。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/des-162926557535513.gif" alt=""></p>
<h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><p>我们可以考虑一下每一轮的加密过程</p>
<p>$$<br>L_{i+1}=R_i<br>$$</p>
<p>$$<br>R_{i+1}=L_i\oplus F(R_i,K_i)<br>$$</p>
<p>那么在最后的 Permutation 之前，对应的密文为<br>$$<br>(R_{n+1},L_{n+1})<br>$$<br>。</p>
<h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>那么解密如何解密呢？首先我们可以把密文先进行逆置换，那么就可以得到最后一轮的输出。我们这时考虑每一轮</p>
<p>$$<br>R_i=L_{i+1}<br>$$</p>
<p>$$<br>L_i=R_{i+1}\oplus F(L_{i+1},K_i)<br>$$</p>
<p>因此，<br>$$<br>(L_0,R_0)<br>$$<br>就是加密时第一次置换后的明文。我们只需要再执行逆置换就可以获得明文了。</p>
<p>可以看出，DES 加解密使用同一套逻辑，只是密钥使用的顺序不一致。</p>
<h2 id="核心部件"><a href="#核心部件" class="headerlink" title="核心部件"></a>核心部件</h2><p>DES 中的核心部件主要包括（这里只给出加密过程的）</p>
<ul>
<li>初始置换</li>
<li>F 函数<ul>
<li>E 扩展函数</li>
<li>S 盒，设计标准未给出。</li>
<li>P 置换</li>
</ul>
</li>
<li>最后置换</li>
</ul>
<p>其中 F 函数如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/f-function-162926569404515.png" alt=""></p>
<p>如果对 DES 更加感兴趣，可以进行更加仔细地研究。欢迎提供 PR。</p>
<h2 id="衍生"><a href="#衍生" class="headerlink" title="衍生"></a>衍生</h2><p>在 DES 的基础上，衍生了以下两种加密方式</p>
<ul>
<li>双重 DES</li>
<li>三种 DES</li>
</ul>
<h3 id="双重-DES"><a href="#双重-DES" class="headerlink" title="双重 DES"></a>双重 DES</h3><p>双重 DES 使用两个密钥，长度为 112 比特。加密方式如下</p>
<p>$$<br>C=E_{k2}(E_{k1}(P))<br>$$<br>但是双重 DES 不能抵抗中间相遇攻击，我们可以构造如下两个集合</p>
<p>$$<br>I={E_{k1}(P)}<br>$$</p>
<p>$$<br>J=D_{k2}(C)<br>$$</p>
<p>即分别枚举 K1 和 K2 分别对 P 进行加密和对 C 进行解密。</p>
<p>在我们对 P 进行加密完毕后，可以对加密结果进行排序，这样的复杂度为<br>$$<br>2^nlog(2^n)=O(n2^n)<br>$$<br>当我们对 C 进行解密时，可以每解密一个，就去对应的表中查询。</p>
<p>总的复杂度为还是<br>$$<br>O(n2^n)<br>$$<br>。</p>
<h3 id="三重-DES"><a href="#三重-DES" class="headerlink" title="三重 DES"></a>三重 DES</h3><p>三重 DES 的加解密方式如下</p>
<p>$$<br>C=E_{k3}(D_{k2}(E_{k1}(P)))<br>$$</p>
<p>$$<br>P=D_{k1}(E_{k2}(D_{k3}(C)))<br>$$</p>
<p>在选择密钥时，可以有两种方法</p>
<ul>
<li>3 个不同的密钥，k1，k2，k3 互相独立，一共 168 比特。</li>
<li>2 个不同的密钥，k1 与 k2 独立，k3=k1，112 比特。</li>
</ul>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><ul>
<li>差分攻击</li>
<li>线性攻击</li>
</ul>
<h2 id="2018-N1CTF-N1ES"><a href="#2018-N1CTF-N1ES" class="headerlink" title="2018 N1CTF N1ES"></a>2018 N1CTF N1ES</h2><p>基本代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>
<span class="token keyword">def</span> <span class="token function">round_add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">+</span> y <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;</span> y<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">+=</span> chr<span class="token punctuation">(</span>f<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ord<span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res

<span class="token keyword">def</span> <span class="token function">permutate</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> block<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">string_to_bits</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> data<span class="token punctuation">]</span>
    l <span class="token operator">=</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span>
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> l
    pos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> ch <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            result<span class="token punctuation">[</span><span class="token punctuation">(</span>pos<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">>></span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span>
        pos <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> result

s_box <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">132</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">187</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">146</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">148</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">189</span><span class="token punctuation">,</span> <span class="token number">188</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">126</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">149</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">166</span><span class="token punctuation">,</span> <span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">133</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">162</span><span class="token punctuation">,</span> <span class="token number">142</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">143</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">129</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">,</span> <span class="token number">106</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">8</span>
<span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">157</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">166</span><span class="token punctuation">,</span> <span class="token number">171</span><span class="token punctuation">,</span> <span class="token number">122</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">113</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">141</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span>
 <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">171</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">164</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">188</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">141</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">162</span><span class="token punctuation">,</span> <span class="token number">186</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">158</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">145</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">169</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">158</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">186</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">166</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">189</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">:</span>
    k <span class="token operator">=</span> permutate<span class="token punctuation">(</span>s_box<span class="token punctuation">,</span>o<span class="token punctuation">)</span>
    b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pos <span class="token operator">=</span> <span class="token number">0</span>
        x <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            x <span class="token operator">+=</span> <span class="token punctuation">(</span>j<span class="token operator">&lt;&lt;</span>pos<span class="token punctuation">)</span>
            pos <span class="token operator">+=</span> <span class="token number">1</span>
        c<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x10001</span><span class="token operator">**</span>x<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">0x7f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c



<span class="token keyword">class</span> <span class="token class-name">N1ES</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">24</span> <span class="token operator">or</span> isinstance<span class="token punctuation">(</span>key<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"key must be 24 bytes long"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>key <span class="token operator">=</span> key
        self<span class="token punctuation">.</span>gen_subkey<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">gen_subkey</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        o <span class="token operator">=</span> string_to_bits<span class="token punctuation">(</span>self<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        k <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            o <span class="token operator">=</span> generate<span class="token punctuation">(</span>o<span class="token punctuation">)</span>
            k<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>o<span class="token punctuation">)</span>
            o <span class="token operator">=</span> string_to_bits<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Kn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>Kn<span class="token punctuation">.</span>append<span class="token punctuation">(</span>map<span class="token punctuation">(</span>chr<span class="token punctuation">,</span> k<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">:</span> i <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> plaintext<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">or</span> isinstance<span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"plaintext must be a multiple of 16 in length"</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            block <span class="token operator">=</span> plaintext<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">]</span>
            L <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>
            R <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> round_cnt <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                L<span class="token punctuation">,</span> R <span class="token operator">=</span> R<span class="token punctuation">,</span> <span class="token punctuation">(</span>round_add<span class="token punctuation">(</span>L<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Kn<span class="token punctuation">[</span>round_cnt<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            L<span class="token punctuation">,</span> R <span class="token operator">=</span> R<span class="token punctuation">,</span> L
            res <span class="token operator">+=</span> L <span class="token operator">+</span> R
        <span class="token keyword">return</span> res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显然，我们可以将其视为一个 Feistel 加密的方式，解密函数如下</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            block <span class="token operator">=</span> ciphertext<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">]</span>
            L <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>
            R <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> round_cnt <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                L<span class="token punctuation">,</span> R <span class="token operator">=</span>R<span class="token punctuation">,</span> <span class="token punctuation">(</span>round_add<span class="token punctuation">(</span>L<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Kn<span class="token punctuation">[</span><span class="token number">31</span><span class="token operator">-</span>round_cnt<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            L<span class="token punctuation">,</span>R<span class="token operator">=</span>R<span class="token punctuation">,</span>L
            res <span class="token operator">+=</span> L <span class="token operator">+</span> R
        <span class="token keyword">return</span> res<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后结果为</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  baby_N1ES cat challenge.py
from N1ES import N1ES
import base64
key = "wxy191iss00000000000cute"
n1es = N1ES(key)
flag = "N1CTF{*****************************************}"
cipher = n1es.encrypt(flag)
#print base64.b64encode(cipher)  # HRlgC2ReHW1/WRk2DikfNBo1dl1XZBJrRR9qECMNOjNHDktBJSxcI1hZIz07YjVx
cipher = 'HRlgC2ReHW1/WRk2DikfNBo1dl1XZBJrRR9qECMNOjNHDktBJSxcI1hZIz07YjVx'
cipher = base64.b64decode(cipher)
print n1es.decrypt(cipher)
➜  baby_N1ES python challenge.py
N1CTF{F3istel_n3tw0rk_c4n_b3_ea5i1y_s0lv3d_/--/}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2019-CISCN-part-des"><a href="#2019-CISCN-part-des" class="headerlink" title="2019 CISCN  part_des"></a>2019 CISCN  part_des</h2><p>题目只给了一个文件：</p>
<pre><code>Round n part_encode-&gt; 0x92d915250119e12b
Key map -&gt; 0xe0be661032d5f0b676f82095e4d67623628fe6d376363183aed373a60167af537b46abc2af53d97485591f5bd94b944a3f49d94897ea1f699d1cdc291f2d9d4a5c705f2cad89e938dbacaca15e10d8aeaed90236f0be2e954a8cf0bea6112e84</code></pre><p>考虑到题目名以及数据特征，<code>Round n part_encode</code> 为执行n轮des的中间结果，<code>Key map</code> 应为des的子密钥，要还原出明文只需进行n轮des加密的逆过程即可，解密时注意以下三点。</p>
<ul>
<li>子密钥的选取，对于只进行了n轮的加密结果，解密时应依次使用密钥 n, n-1…, 1。</li>
<li>des 最后一轮后的操作，未完成的 des 没有交换左右两部分和逆初始置换，因此解密时我们应先对密文进行这两步操作。</li>
<li>n 的选择，在本题中，我们并不知道 n，但这无关紧要，我们可以尝试所有可能的取值（0-15）flag应为ascii字符串。</li>
</ul>
<p>代码：</p>
<pre class="line-numbers language-python"><code class="language-python">kkk <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">def</span> <span class="token function">bit_rot_left</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> lst<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> lst<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">DES</span><span class="token punctuation">:</span>
    IP <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">58</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token number">62</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token number">57</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token number">61</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">7</span>
        <span class="token punctuation">]</span>
    IP_re <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">40</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span>
            <span class="token number">38</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span>
            <span class="token number">36</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span>
            <span class="token number">34</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">25</span>
        <span class="token punctuation">]</span>
    Pbox <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">25</span>
        <span class="token punctuation">]</span>
    E <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">32</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span>
            <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span>
            <span class="token number">24</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">1</span>
        <span class="token punctuation">]</span>
    PC1 <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token number">57</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span>
                <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span>
                <span class="token number">63</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span>
                <span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span>
        <span class="token punctuation">]</span>
    PC2 <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">14</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token number">23</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">41</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>
            <span class="token number">44</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">32</span>
        <span class="token punctuation">]</span>
    Sbox <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    rout <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>subkey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">permute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lst<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>lst<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> tb<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>riti<span class="token punctuation">,</span>subkeyi<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token operator">^</span>j <span class="token keyword">for</span> i<span class="token punctuation">,</span>j <span class="token keyword">in</span> zip<span class="token punctuation">(</span>subkeyi<span class="token punctuation">,</span>self<span class="token punctuation">.</span>permute<span class="token punctuation">(</span>riti<span class="token punctuation">,</span>DES<span class="token punctuation">.</span>E<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span>  self<span class="token punctuation">.</span>permute<span class="token punctuation">(</span>sum<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token keyword">for</span> l <span class="token keyword">in</span> str<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>DES<span class="token punctuation">.</span>Sbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>str<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>str<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> tmp<span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>DES<span class="token punctuation">.</span>Pbox<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">des_main</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>m<span class="token punctuation">,</span>mark<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sbkey <span class="token operator">=</span> self<span class="token punctuation">.</span>subkey<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">#if mark == 'e' else self.subkey[1]</span>
        <span class="token comment" spellcheck="true"># tmp =  self.permute([int(i) for i in list((m).ljust(64,"0"))],self.IP)</span>
        tmp <span class="token operator">=</span>  <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> list<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">global</span> kkk
        <span class="token keyword">print</span><span class="token punctuation">(</span>kkk<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>kkk<span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> tmp<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>j<span class="token operator">^</span>k <span class="token keyword">for</span> j<span class="token punctuation">,</span>k <span class="token keyword">in</span> zip<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>f<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sbkey<span class="token punctuation">[</span>i <span class="token keyword">if</span> mark <span class="token operator">!=</span> <span class="token string">'d'</span> <span class="token keyword">else</span> kkk<span class="token number">-1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>permute<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>IP_re<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">des_encipher</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>bin<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span>
        des_en <span class="token operator">=</span> self<span class="token punctuation">.</span>des_main<span class="token punctuation">(</span>m<span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>des_en<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">:</span>i<span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">des_decipher</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>bin<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span>
        des_de <span class="token operator">=</span> self<span class="token punctuation">.</span>des_main<span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>des_de<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">:</span>i<span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> base64
    <span class="token keyword">global</span> kkk
    <span class="token keyword">while</span> kkk <span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">:</span>
        desobj <span class="token operator">=</span> DES<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># cipher = desobj.des_encipher("12345678")</span>
        cipher <span class="token operator">=</span> <span class="token string">'\x01\x19\xe1+\x92\xd9\x15%'</span>
        message1 <span class="token operator">=</span> desobj<span class="token punctuation">.</span>des_decipher<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>message1<span class="token punctuation">)</span>
        kkk <span class="token operator">-=</span> <span class="token number">1</span>
<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span>

```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解密结果（部分）：</p>
<pre><code>14
t-ÏEÏx§
13
y0ur9Ood
12
µp^Ûé=¹
11
)Á`rûÕû</code></pre><p>可以看出n为13，flag为<code>flag{y0ur9Ood}</code></p>
<h1 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h1><h2 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h2><p><strong>国际数据加密算法</strong>（International Data Encryption Algorithm，IDEA），最早称为<strong>改良建议加密标准</strong>（Improved Proposed Encryption Standard，IPES），是密码学上一种对称密钥分组密码，由 James Massey 与来学嘉设计，在 1991 年首次提出。这个算法的提出，是为了取代旧有的数据加密标准 DES。</p>
<h2 id="基本流程-2"><a href="#基本流程-2" class="headerlink" title="基本流程"></a>基本流程</h2><h3 id="密钥生成"><a href="#密钥生成" class="headerlink" title="密钥生成"></a>密钥生成</h3><p>IDEA 在加密的每轮中使用 6 个密钥，然后最后输出轮使用 4 个密钥。所以一共有 52 个。</p>
<ol>
<li>前 8 个密钥来自与该算法最初的密钥，K1 取自密钥的高 16 比特，K8 取自密钥的低 16 比特。</li>
<li>将密钥循环左移 25 位获取下一轮密钥，然后再次分为 8 组。</li>
</ol>
<h3 id="加密流程"><a href="#加密流程" class="headerlink" title="加密流程"></a>加密流程</h3><p>IDEA 加密的数据块的大小为 64 比特，其使用的密钥长度为 128 比特。该算法会对输入的数据块进行 8 次相同的变换，只是每次使用的密钥不同，最后会进行一次输出变换。每一轮的操作</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/IDEA_Round.png" alt=""></p>
<p>可以输入和输出都是 16 比特位一组。每一轮的主要执行的运算有</p>
<ul>
<li>按位异或，⊕</li>
<li>模加，模数为 2^16 ，⊞</li>
<li>模乘，模数为 2^16+1，⊙。但是需要注意的是 0x0000 的输入会被修改为 2^16 ，2^16 的输出结果会被修改为 0x0000。</li>
</ul>
<p>这里我们称由 K5，K6 构成的中间那个方格的加密方式为 MA。这也是 IDEA 算法中重要的一部分，此外，我们称 MA_L 为该部分加密后的左侧结果，其最后会和最左边的 16 比特操作；MA_R 为该部分加密后的右半部分的结果，其最后会和第三个 16 比特操作。</p>
<p>在最后输出轮的操作如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/IDEA_Output_Trans.png" alt=""></p>
<h3 id="解密流程"><a href="#解密流程" class="headerlink" title="解密流程"></a>解密流程</h3><p>解密流程与加密流程相似，主要在于其密钥的选取</p>
<ul>
<li>第 i(1-9) 轮的解密的密钥的前 4 个子密钥由加密过程中第 10-i 轮的前 4 个子密钥得出</li>
<li>其中第 1 个和第 4 个解密子密钥为相应的子密钥关于 2^16+1的乘法逆元。</li>
<li>第 2 个和第 3 个子密钥的取法为<ul>
<li>当轮数为 2，…，8 时，取相应的第 3 个和第 2 个的子密钥的2^16的加密逆元。</li>
<li>当轮数为 1 或 9 时，取相应的第 2 个和第 3 个子密钥对应的2^16 的加密逆元。</li>
</ul>
</li>
<li>第 5 和第 6 个密钥不变。</li>
</ul>
<h3 id="总体流程"><a href="#总体流程" class="headerlink" title="总体流程"></a>总体流程</h3><p><img src="/images/loading.gif" data-original="../images/CTF/IDEA_All.png" alt=""></p>
<p>我们来证明一下算法的正确性，这里我们关注于解密算法的第一轮，首先我们先看一下Yi是如何得到的</p>
<p>Y1=W81⊙Z49</p>
<p>Y2=W83⊞Z50Y</p>
<p>Y3=W82⊞Z51</p>
<p>Y4=W83⊙Z52</p>
<p>解密时，第一轮直接进行的变换为</p>
<p>J11=Y1⊙U1=Y1⊙Z−149=W81</p>
<p>J12=Y2⊞U2=Y2⊞Z−150=W83</p>
<p>J13=Y3⊞U3=Y3⊞Z−151=W82</p>
<p>J14=Y4⊙U4=Y4⊙Z−152=W84</p>
<p>可以看出得到的结果只有中间的两个 16 位加密结果恰好相反。我们进一步看一下W8i是如何得到的。</p>
<p>W81=I81⊕MAR(I81⊕I83,I82⊕I84)</p>
<p>W82=I83⊕MAR(I81⊕I83,I82⊕I84)</p>
<p>W83=I82⊕MAL(I81⊕I83,I82⊕I84)</p>
<p>W84=I84⊕MAL(I81⊕I83,I82⊕I84)</p>
<p>那么对于 V11 来说</p>
<p>V11=J11⊕MAR(J11⊕J13,J12⊕J14)</p>
<p>通过简单带入已有的值，显然</p>
<p>V11=W81⊕MAR(I81⊕I83,I82⊕I84)=I81</p>
<p>对于其他的元素也类似，那么其实我们会发现第一轮解密后的结果恰好是I81,I83,I82,I84。</p>
<p>类似地，这个关系可以一直满足直到</p>
<p>V81=I11,V82=I13,V83=I12,V84=I14</p>
<p>那么最后再经过一次简单的输出变换，恰好得到最初加密的数值。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/IDEA_Round.png" alt=""></p>
<h1 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h1><h2 id="基本介绍-2"><a href="#基本介绍-2" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>Advanced Encryption Standard（AES），高级加密标准，是典型的块加密，被设计来取代 DES，由 Joan Daemen 和 Vincent Rijmen 所设计。其基本信息如下</p>
<ul>
<li>输入：128 比特。</li>
<li>输出：128 比特。</li>
<li>SPN 网络结构。</li>
</ul>
<p>其迭代轮数与密钥长度有关系，如下</p>
<table>
<thead>
<tr>
<th>密钥长度（比特）</th>
<th>迭代轮数</th>
</tr>
</thead>
<tbody><tr>
<td>128</td>
<td>10</td>
</tr>
<tr>
<td>192</td>
<td>12</td>
</tr>
<tr>
<td>256</td>
<td>14</td>
</tr>
</tbody></table>
<h2 id="基本流程-3"><a href="#基本流程-3" class="headerlink" title="基本流程"></a>基本流程</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>在 AES 加解密过程中，每一块都是 128 比特，所以我们这里明确一些基本概念。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_data_unit.png" alt=""></p>
<p>在 AES 中，块与 State 之间的转换过程如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_block2state.png" alt=""></p>
<p>所以，可以看出，每一个 block 中的字节是按照列排列进入到状态数组的。</p>
<p>而对于明文来说，一般我们会选择使用其十六进制进行编码。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_plain2state.png" alt=""></p>
<h3 id="加解密过程"><a href="#加解密过程" class="headerlink" title="加解密过程"></a>加解密过程</h3><p>基本的流程，每一轮主要包括</p>
<ul>
<li>轮密钥加，AddRoundKey</li>
<li>字节替换，SubBytes</li>
<li>行移位，ShiftRows</li>
<li>列混淆，MixColumns</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_details.jpg" alt=""></p>
<p>上面的列混淆的矩阵乘法等号左边的列向量应该在右边。</p>
<p>这里再给一张其加解密的全图，其解密算法的正确性很显然。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_enc_dec.png" alt=""></p>
<p>我们这里重点关注一下以下。</p>
<h4 id="字节替换"><a href="#字节替换" class="headerlink" title="字节替换"></a>字节替换</h4><p>在字节替换的背后，其实是有对应的数学规则来定义对应的替换表的，如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes_subbytes.png" alt=""></p>
<p>这里的运算均定义在 GF(28) 内。</p>
<h4 id="列混淆"><a href="#列混淆" class="headerlink" title="列混淆"></a>列混淆</h4><p>这里的运算也是定义在 GF(28)上，使用的模多项式为 x8+x4+x3+1。</p>
<h4 id="密钥扩展-1"><a href="#密钥扩展-1" class="headerlink" title="密钥扩展"></a>密钥扩展</h4><p><img src="/images/loading.gif" data-original="../images/CTF/aes_key_expansion.png" alt=""></p>
<h2 id="等价解密算法"><a href="#等价解密算法" class="headerlink" title="等价解密算法"></a>等价解密算法</h2><p>简单分析一下，我们可以发现</p>
<ul>
<li>交换逆向行移位和逆向字节代替并不影响结果。</li>
<li>交换轮密钥加和逆向列混淆并不影响结果，关键在于</li>
<li>首先可以把异或看成域上的多项式加法</li>
<li>然后多项式中乘法对加法具有分配率。</li>
</ul>
<h2 id="攻击方法-1"><a href="#攻击方法-1" class="headerlink" title="攻击方法"></a>攻击方法</h2><ul>
<li>积分攻击</li>
</ul>
<h2 id="2018-国赛-Crackmec"><a href="#2018-国赛-Crackmec" class="headerlink" title="2018 国赛 Crackmec"></a>2018 国赛 Crackmec</h2><p>通过简单分析这个算法，我们可以发现这个算法是一个简化版的 AES，其基本操作为</p>
<ul>
<li>9 轮迭代<ul>
<li>行移位</li>
<li>变种字节替换</li>
</ul>
</li>
</ul>
<p>如下</p>
<pre class="line-numbers language-python"><code class="language-python">  memcpy<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> plain<span class="token punctuation">,</span> 0x10uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> 0LL<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    shift_row<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> 0LL<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j <span class="token punctuation">)</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cipher<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j<span class="token punctuation">]</span> <span class="token operator">=</span>
        box<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>unsigned __int8<span class="token punctuation">)</span>cipher<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">^</span>
        box<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>unsigned __int8<span class="token punctuation">)</span>cipher<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">^</span>
        box<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>unsigned __int8<span class="token punctuation">)</span>cipher<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">^</span>
        box<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>unsigned __int8<span class="token punctuation">)</span>cipher<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  result <span class="token operator">=</span> shift_row<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> 0LL<span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> <span class="token number">0xF</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> subbytes<span class="token punctuation">[</span><span class="token number">256</span> <span class="token operator">*</span> k <span class="token operator">+</span> <span class="token punctuation">(</span>unsigned __int8<span class="token punctuation">)</span>cipher<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    cipher<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据程序流程，我们已知程序加密的结果，而 subbytes 和 shift_row 又是可逆的，所以我们可以获取最后一轮加密后的结果。此时，我们还知道 box 对应的常数，我们只是不知道上一轮中 <code>cipher[4*j]</code> 对应的值，一共 32 位，如果我们直接爆破的话，显然不可取，因为每一轮都需要这么爆破，时间不可接受。那么有没有其它办法呢？其实有的，我们可以考虑中间相遇攻击，即首先枚举所有的 <code>cipher[4*j]</code> 与<code>cipher[4*j+1]</code> 的字节组合，一共 256*256 种。在枚举剩下两个字节时，我们可以先计算出其与密文的异或值，然后去之前的组合中找，如果找到的话，我们就认为是正确的。这样复杂度瞬间降到 O(216)。</p>
<p>代码如下</p>
<pre class="line-numbers language-python"><code class="language-python">encflag <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0xCA</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xDA</span><span class="token punctuation">,</span> <span class="token number">0xC8</span><span class="token punctuation">,</span> <span class="token number">0xDE</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span>
    <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0xB2</span><span class="token punctuation">,</span> <span class="token number">0x25</span>
<span class="token punctuation">]</span>
subbytebox <span class="token operator">=</span> eval<span class="token punctuation">(</span>open<span class="token punctuation">(</span><span class="token string">'./subbytes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
box <span class="token operator">=</span> eval<span class="token punctuation">(</span>open<span class="token punctuation">(</span><span class="token string">'./box'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> subbytebox<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">inv_shift_row</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tmp <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp

    tmp <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp
    tmp <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp

    tmp <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>
    now<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp

    <span class="token keyword">return</span> now


<span class="token keyword">def</span> <span class="token function">byte2num</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    num <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        num <span class="token operator">=</span> num <span class="token operator">*</span> <span class="token number">256</span>
        num <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">return</span> num


<span class="token keyword">def</span> <span class="token function">getbytes</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    box[((4 * j + 3 + 16 * i) &lt;&lt; 8) + a2[4 * j + 3]]
    box[((4 * j + 2 + 16 * i) &lt;&lt; 8 )+ a2[4 * j + 2]]
    box[((4 * j + 1 + 16 * i) &lt;&lt; 8) + a2[4 * j + 1]]
    box[((4 * j + 16 * i) &lt;&lt; 8) + a2[4 * j]];
    """</span>
    box01 <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> c0 <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> c1 <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            num0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> c0
            num1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> c1
            num <span class="token operator">=</span> box<span class="token punctuation">[</span>num0<span class="token punctuation">]</span> <span class="token operator">^</span> box<span class="token punctuation">[</span>num1<span class="token punctuation">]</span>
            box01<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c0<span class="token punctuation">,</span> c1<span class="token punctuation">)</span>
    <span class="token keyword">for</span> c2 <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> c3 <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            num2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> c2
            num3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> c3
            num <span class="token operator">=</span> box<span class="token punctuation">[</span>num2<span class="token punctuation">]</span> <span class="token operator">^</span> box<span class="token punctuation">[</span>num3<span class="token punctuation">]</span>
            calc <span class="token operator">=</span> num <span class="token operator">^</span> target
            <span class="token keyword">if</span> calc <span class="token keyword">in</span> box01<span class="token punctuation">:</span>
                c0<span class="token punctuation">,</span> c1 <span class="token operator">=</span> box01<span class="token punctuation">[</span>calc<span class="token punctuation">]</span>
                <span class="token keyword">return</span> c0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3
    <span class="token keyword">print</span> <span class="token string">'not found'</span>
    <span class="token keyword">print</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> target<span class="token punctuation">,</span> calc
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">solve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">16</span>
    <span class="token triple-quoted-string string">"""
      for ( k = 0LL; k &lt;= 0xF; ++k )
      {
        result = subbytesbox[256 * k + a2[k]];
        a2[k] = result;
      }
    """</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tag <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> subbytebox<span class="token punctuation">[</span><span class="token number">256</span> <span class="token operator">*</span> i <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">==</span> encflag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true"># j = a2[k]</span>
                tag <span class="token operator">+=</span> <span class="token number">1</span>
                a2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j
                <span class="token keyword">if</span> tag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span> <span class="token string">'two number'</span><span class="token punctuation">,</span> i
                    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
      result = shift_row(a2);
    """</span>
    a2 <span class="token operator">=</span> inv_shift_row<span class="token punctuation">(</span>a2<span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
      for ( i = 0LL; i &lt;= 8; ++i )
      {
        shift_row(a2);
        for ( j = 0LL; j &lt;= 3; ++j )
          *(_DWORD *)&amp;a2[4 * j] = box[((4 * j + 3 + 16 * i) &lt;&lt; 8) + a2[4 * j + 3]] ^ box[((4 * j + 2 + 16 * i) &lt;&lt; 8)
                                                                                       + a2[4 * j + 2]] ^ box[((4 * j + 1 + 16 * i) &lt;&lt; 8) + a2[4 * j + 1]] ^ box[((4 * j + 16 * i) &lt;&lt; 8) + a2[4 * j]];
      }
    """</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">16</span>
        <span class="token keyword">print</span> <span class="token string">'round '</span><span class="token punctuation">,</span> i
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            num <span class="token operator">=</span> byte2num<span class="token punctuation">(</span>a2<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j<span class="token punctuation">:</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print num, a2[4 * j:4 * j + 4]</span>
            tmp<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j
               <span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> getbytes<span class="token punctuation">(</span>
                   i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> num
               <span class="token punctuation">)</span>
        a2 <span class="token operator">=</span> inv_shift_row<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
    <span class="token keyword">print</span> a2
    <span class="token keyword">print</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> a2<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    solve<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果</p>
<pre><code>➜  cracemec git:(master) ✗ python exp.py
211 3549048324
round  8
round  7
round  6
round  5
round  4
round  3
round  2
round  1
round  0
[67, 73, 83, 67, 78, 98, 35, 97, 100, 102, 115, 64, 70, 122, 57, 51]
CISCNb#adfs@Fz93</code></pre><h1 id="Simon-and-Speck-Block-Ciphers"><a href="#Simon-and-Speck-Block-Ciphers" class="headerlink" title="Simon and Speck Block Ciphers"></a>Simon and Speck Block Ciphers</h1><p>这是一组姐妹轻量级加密。</p>
<h2 id="Simon-Block-Cipher"><a href="#Simon-Block-Cipher" class="headerlink" title="Simon Block Cipher"></a>Simon Block Cipher</h2><h3 id="基本介绍-3"><a href="#基本介绍-3" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>Simon 块加密算法由 NSA 2013 年 6 月公布，主要在<strong>硬件实现</strong>上进行了优化。</p>
<p>Simon Block Cipher 是平衡的 <a href="https://en.wikipedia.org/wiki/Feistel_cipher" target="_blank" rel="noopener">Feistel cipher</a> 加密，一共有两块，若每块加密的大小为 n bits，那么明文的大小就是 2n bits。此外，一般来说，该加密中所使用的密钥长度是块长度的整数倍，比如 2n，4n 等。常见的 Simon 加密算法有</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/simon_cipher_mode.png" alt=""></p>
<p>一般来说，Simon 算法称之为 Simon 2<em>n</em>/nm，n 为块大小，m 是块大小与密钥之间的倍数。比如说 Simon 48/96 就是指明文是 48 比特，密钥是 96 比特的加密算法。</p>
<p>此外，对于 Simon 块加密算法来说，每轮的加密过程一样，如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/Simon_block_cipher.png" alt=""></p>
<p>当然，对于每一轮以及不同的 m 来说，密钥也会有所不同</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/simon_key_schedule.svg" alt=""></p>
<p>其中， zj 是由 Linear Feedback Shift Register (LFSR) 生成的，虽然对于不同的 zj的逻辑不同，但是初始向量是固定的。</p>
<table>
<thead>
<tr>
<th>Constant</th>
</tr>
</thead>
<tbody><tr>
<td>z0z0=11111010001001010110000111001101111101000100101011000011100110</td>
</tr>
<tr>
<td>z1z1=10001110111110010011000010110101000111011111001001100001011010</td>
</tr>
<tr>
<td>z2z2=10101111011100000011010010011000101000010001111110010110110011</td>
</tr>
<tr>
<td>z3z3=11011011101011000110010111100000010010001010011100110100001111</td>
</tr>
<tr>
<td>z4z4=11010001111001101011011000100000010111000011001010010011101111</td>
</tr>
</tbody></table>
<h3 id="2017-SECCON-Simon-and-Speck-Block-Ciphers"><a href="#2017-SECCON-Simon-and-Speck-Block-Ciphers" class="headerlink" title="2017 SECCON Simon and Speck Block Ciphers"></a>2017 SECCON Simon and Speck Block Ciphers</h3><p>题目描述如下</p>
<pre><code>Simon and Speck Block Ciphers

https://eprint.iacr.org/2013/404.pdf Simon_96_64, ECB, key="SECCON{xxxx}", plain=0x6d564d37426e6e71, cipher=0xbb5d12ba422834b5</code></pre><p>从名字中可以看出密钥是 96 比特（12 byte），明文是 64 比特（8 字节），而密钥已经给出了 8 个字节，只剩下四个字节未知。那我们可以使用暴力破解的方法。这里从 <a href="https://github.com/bozhu/NSA-ciphers/blob/master/simon.py" target="_blank" rel="noopener">https://github.com/bozhu/NSA-ciphers/blob/master/simon.py</a> 获取了一份 simon 加密算法。</p>
<p>具体如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> simon <span class="token keyword">import</span> SIMON

plain <span class="token operator">=</span> <span class="token number">0x6d564d37426e6e71</span>
cipher <span class="token operator">=</span> <span class="token number">0xbb5d12ba422834b5</span>


<span class="token keyword">def</span> <span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> <span class="token string">"SECCON{"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"}"</span>
    key <span class="token operator">=</span> key<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> int<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    my_simon <span class="token operator">=</span> SIMON<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    test <span class="token operator">=</span> my_simon<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
    <span class="token keyword">if</span> test <span class="token operator">==</span> cipher<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">def</span> <span class="token function">solve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    visible <span class="token operator">=</span> string<span class="token punctuation">.</span>uppercase <span class="token operator">+</span> string<span class="token punctuation">.</span>lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> string<span class="token punctuation">.</span>punctuation <span class="token operator">+</span> <span class="token string">" "</span>
    key <span class="token operator">=</span> pwnlib<span class="token punctuation">.</span>util<span class="token punctuation">.</span>iters<span class="token punctuation">.</span>mbruteforce<span class="token punctuation">(</span>compare<span class="token punctuation">,</span> visible<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"fixed"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> key


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    solve<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre><code>➜  2017_seccon_simon_and_speck_block_ciphers git:(master) python exp.py
[+] MBruteforcing: Found key: "6Pz0"</code></pre><h1 id="分组模式"><a href="#分组模式" class="headerlink" title="分组模式"></a>分组模式</h1><p>分组加密会将明文消息划分为固定大小的块，每块明文分别在密钥控制下加密为密文。当然并不是每个消息都是相应块大小的整数倍，所以我们可能需要进行填充。</p>
<h2 id="填充方式"><a href="#填充方式" class="headerlink" title="填充方式"></a>填充方式</h2><p>正如我们之前所说，在分组加密中，明文的长度往往并不满足要求，需要进行 padding，而如何 padding 目前也已经有了不少的规定。</p>
<p>常见的 <a href="https://www.di-mgt.com.au/cryptopad.html" target="_blank" rel="noopener">填充规则</a> 如下。<strong>需要注意的是，即使消息的长度是块大小的整数倍，仍然需要填充。</strong></p>
<p>一般来说，如果在解密之后发现 Padding 不正确，则往往会抛出异常。我们也因此可以知道 Paddig 是否正确。</p>
<h3 id="Pad-with-bytes-all-of-the-same-value-as-the-number-of-padding-bytes-PKCS5-padding"><a href="#Pad-with-bytes-all-of-the-same-value-as-the-number-of-padding-bytes-PKCS5-padding" class="headerlink" title="Pad with bytes all of the same value as the number of padding bytes (PKCS5 padding)"></a>Pad with bytes all of the same value as the number of padding bytes (PKCS5 padding)</h3><p>举例子如下</p>
<pre><code>DES INPUT BLOCK  = f  o  r  _  _  _  _  _
(IN HEX)           66 6F 72 05 05 05 05 05
KEY              = 01 23 45 67 89 AB CD EF
DES OUTPUT BLOCK = FD 29 85 C9 E8 DF 41 40</code></pre><h3 id="Pad-with-0x80-followed-by-zero-bytes-OneAndZeroes-Padding"><a href="#Pad-with-0x80-followed-by-zero-bytes-OneAndZeroes-Padding" class="headerlink" title="Pad with 0x80 followed by zero bytes (OneAndZeroes Padding)"></a>Pad with 0x80 followed by zero bytes (OneAndZeroes Padding)</h3><p>举例子如下</p>
<pre><code>DES INPUT BLOCK  = f  o  r  _  _  _  _  _
(IN HEX)           66 6F 72 80 00 00 00 00
KEY              = 01 23 45 67 89 AB CD EF
DES OUTPUT BLOCK = BE 62 5D 9F F3 C6 C8 40</code></pre><p>这里其实就是和 md5 和 sha1 的 padding 差不多。</p>
<h3 id="Pad-with-zeroes-except-make-the-last-byte-equal-to-the-number-of-padding-bytes"><a href="#Pad-with-zeroes-except-make-the-last-byte-equal-to-the-number-of-padding-bytes" class="headerlink" title="Pad with zeroes except make the last byte equal to the number of padding bytes"></a>Pad with zeroes except make the last byte equal to the number of padding bytes</h3><p>举例子如下</p>
<pre><code>DES INPUT BLOCK  = f  o  r  _  _  _  _  _
(IN HEX)           66 6f 72 00 00 00 00 05
KEY              = 01 23 45 67 89 AB CD EF
DES OUTPUT BLOCK = 91 19 2C 64 B5 5C 5D B8</code></pre><h3 id="Pad-with-zero-null-characters"><a href="#Pad-with-zero-null-characters" class="headerlink" title="Pad with zero (null) characters"></a>Pad with zero (null) characters</h3><p>举例子如下</p>
<pre><code>DES INPUT BLOCK  = f  o  r  _  _  _  _  _
(IN HEX)           66 6f 72 00 00 00 00 00
KEY              = 01 23 45 67 89 AB CD EF
DES OUTPUT BLOCK = 9E 14 FB 96 C5 FE EB 75</code></pre><h3 id="Pad-with-spaces"><a href="#Pad-with-spaces" class="headerlink" title="Pad with spaces"></a>Pad with spaces</h3><p>举例子如下</p>
<pre><code>DES INPUT BLOCK  = f  o  r  _  _  _  _  _
(IN HEX)           66 6f 72 20 20 20 20 20
KEY              = 01 23 45 67 89 AB CD EF
DES OUTPUT BLOCK = E3 FF EC E5 21 1F 35 25</code></pre><h3 id="2018-上海市大学生网络安全大赛-aessss"><a href="#2018-上海市大学生网络安全大赛-aessss" class="headerlink" title="2018 上海市大学生网络安全大赛 aessss"></a>2018 上海市大学生网络安全大赛 aessss</h3><p>有时候可以针对一些使用不当的 Padding 进行攻击。这里以 2018 上海市大学生网络安全大赛的一道题目为例：</p>
<p>题目脚本如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> string
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha256
<span class="token keyword">import</span> SocketServer
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> secret <span class="token keyword">import</span> FLAG<span class="token punctuation">,</span> IV<span class="token punctuation">,</span> KEY


<span class="token keyword">class</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>SocketServer<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">proof_of_work</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        proof <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters<span class="token operator">+</span>string<span class="token punctuation">.</span>digits<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print proof</span>
        digest <span class="token operator">=</span> sha256<span class="token punctuation">(</span>proof<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"sha256(XXXX+%s) == %s\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>proof<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> digest<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'Give me XXXX:'</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token operator">or</span> sha256<span class="token punctuation">(</span>x<span class="token operator">+</span>proof<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> digest<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">pad</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> chr<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'\x00'</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> pos <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>s_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'\x00'</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> pos <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>invs_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    s_box <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token number">0xF2</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0xC5</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0x2B</span><span class="token punctuation">,</span> <span class="token number">0xFE</span><span class="token punctuation">,</span> <span class="token number">0xD7</span><span class="token punctuation">,</span> <span class="token number">0xAB</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span>
        <span class="token number">0xCA</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xC9</span><span class="token punctuation">,</span> <span class="token number">0x7D</span><span class="token punctuation">,</span> <span class="token number">0xFA</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0xD4</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span> <span class="token number">0xAF</span><span class="token punctuation">,</span> <span class="token number">0x9C</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span>
        <span class="token number">0xB7</span><span class="token punctuation">,</span> <span class="token number">0xFD</span><span class="token punctuation">,</span> <span class="token number">0x93</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0xF7</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0xA5</span><span class="token punctuation">,</span> <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0xF1</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0xD8</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span>
        <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0xC7</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x96</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x9A</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0xEB</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">,</span> <span class="token number">0xB2</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span>
        <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">,</span> <span class="token number">0x6E</span><span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0xA0</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0xD6</span><span class="token punctuation">,</span> <span class="token number">0xB3</span><span class="token punctuation">,</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token number">0xE3</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span>
        <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0xD1</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xED</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xFC</span><span class="token punctuation">,</span> <span class="token number">0xB1</span><span class="token punctuation">,</span> <span class="token number">0x5B</span><span class="token punctuation">,</span> <span class="token number">0x6A</span><span class="token punctuation">,</span> <span class="token number">0xCB</span><span class="token punctuation">,</span> <span class="token number">0xBE</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0x4A</span><span class="token punctuation">,</span> <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0xCF</span><span class="token punctuation">,</span>
        <span class="token number">0xD0</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0xFB</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x4D</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span>
        <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x8F</span><span class="token punctuation">,</span> <span class="token number">0x92</span><span class="token punctuation">,</span> <span class="token number">0x9D</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0xF5</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0xB6</span><span class="token punctuation">,</span> <span class="token number">0xDA</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xF3</span><span class="token punctuation">,</span> <span class="token number">0xD2</span><span class="token punctuation">,</span>
        <span class="token number">0xCD</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0xEC</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">,</span> <span class="token number">0x97</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">0xC4</span><span class="token punctuation">,</span> <span class="token number">0xA7</span><span class="token punctuation">,</span> <span class="token number">0x7E</span><span class="token punctuation">,</span> <span class="token number">0x3D</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span>
        <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x4F</span><span class="token punctuation">,</span> <span class="token number">0xDC</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x2A</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0xEE</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0xDE</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> <span class="token number">0xDB</span><span class="token punctuation">,</span>
        <span class="token number">0xE0</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">,</span> <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0xC2</span><span class="token punctuation">,</span> <span class="token number">0xD3</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x91</span><span class="token punctuation">,</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span>
        <span class="token number">0xE7</span><span class="token punctuation">,</span> <span class="token number">0xC8</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x8D</span><span class="token punctuation">,</span> <span class="token number">0xD5</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0xA9</span><span class="token punctuation">,</span> <span class="token number">0x6C</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0xF4</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0xAE</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
        <span class="token number">0xBA</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">,</span> <span class="token number">0xA6</span><span class="token punctuation">,</span> <span class="token number">0xB4</span><span class="token punctuation">,</span> <span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">,</span> <span class="token number">0x4B</span><span class="token punctuation">,</span> <span class="token number">0xBD</span><span class="token punctuation">,</span> <span class="token number">0x8B</span><span class="token punctuation">,</span> <span class="token number">0x8A</span><span class="token punctuation">,</span>
        <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x3E</span><span class="token punctuation">,</span> <span class="token number">0xB5</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0xF6</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0xB9</span><span class="token punctuation">,</span> <span class="token number">0x86</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x9E</span><span class="token punctuation">,</span>
        <span class="token number">0xE1</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0xD9</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span> <span class="token number">0x94</span><span class="token punctuation">,</span> <span class="token number">0x9B</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0xCE</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xDF</span><span class="token punctuation">,</span>
        <span class="token number">0x8C</span><span class="token punctuation">,</span> <span class="token number">0xA1</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x2D</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0x16</span>
    <span class="token punctuation">]</span>

    invs_box <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x6A</span><span class="token punctuation">,</span> <span class="token number">0xD5</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xA5</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0x9E</span><span class="token punctuation">,</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0xF3</span><span class="token punctuation">,</span> <span class="token number">0xD7</span><span class="token punctuation">,</span> <span class="token number">0xFB</span><span class="token punctuation">,</span>
        <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0xE3</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x9B</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0xC4</span><span class="token punctuation">,</span> <span class="token number">0xDE</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0xCB</span><span class="token punctuation">,</span>
        <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token number">0x94</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">,</span> <span class="token number">0xA6</span><span class="token punctuation">,</span> <span class="token number">0xC2</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0x3D</span><span class="token punctuation">,</span> <span class="token number">0xEE</span><span class="token punctuation">,</span> <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0xFA</span><span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span>
        <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">,</span> <span class="token number">0xA1</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token number">0xD9</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0xB2</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x5B</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x8B</span><span class="token punctuation">,</span> <span class="token number">0xD1</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">,</span>
        <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0xF6</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x86</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0xD4</span><span class="token punctuation">,</span> <span class="token number">0xA4</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0xB6</span><span class="token punctuation">,</span> <span class="token number">0x92</span><span class="token punctuation">,</span>
        <span class="token number">0x6C</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0xFD</span><span class="token punctuation">,</span> <span class="token number">0xED</span><span class="token punctuation">,</span> <span class="token number">0xB9</span><span class="token punctuation">,</span> <span class="token number">0xDA</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0xA7</span><span class="token punctuation">,</span> <span class="token number">0x8D</span><span class="token punctuation">,</span> <span class="token number">0x9D</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span>
        <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xD8</span><span class="token punctuation">,</span> <span class="token number">0xAB</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0xD3</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0xF7</span><span class="token punctuation">,</span> <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xB3</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span>
        <span class="token number">0xD0</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">,</span> <span class="token number">0x8F</span><span class="token punctuation">,</span> <span class="token number">0xCA</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0xAF</span><span class="token punctuation">,</span> <span class="token number">0xBD</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0x8A</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span>
        <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x91</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x4F</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xDC</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0x97</span><span class="token punctuation">,</span> <span class="token number">0xF2</span><span class="token punctuation">,</span> <span class="token number">0xCF</span><span class="token punctuation">,</span> <span class="token number">0xCE</span><span class="token punctuation">,</span> <span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token number">0xB4</span><span class="token punctuation">,</span> <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span>
        <span class="token number">0x96</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0xE7</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0xDF</span><span class="token punctuation">,</span> <span class="token number">0x6E</span><span class="token punctuation">,</span>
        <span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0xF1</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token number">0xC5</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0xB7</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0xBE</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">,</span>
        <span class="token number">0xFC</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x3E</span><span class="token punctuation">,</span> <span class="token number">0x4B</span><span class="token punctuation">,</span> <span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0xD2</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x9A</span><span class="token punctuation">,</span> <span class="token number">0xDB</span><span class="token punctuation">,</span> <span class="token number">0xC0</span><span class="token punctuation">,</span> <span class="token number">0xFE</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0xCD</span><span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0xF4</span><span class="token punctuation">,</span>
        <span class="token number">0x1F</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0xC7</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0xB1</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0xEC</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">,</span>
        <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0xA9</span><span class="token punctuation">,</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token number">0xB5</span><span class="token punctuation">,</span> <span class="token number">0x4A</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x2D</span><span class="token punctuation">,</span> <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0x9F</span><span class="token punctuation">,</span> <span class="token number">0x93</span><span class="token punctuation">,</span> <span class="token number">0xC9</span><span class="token punctuation">,</span> <span class="token number">0x9C</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span>
        <span class="token number">0xA0</span><span class="token punctuation">,</span> <span class="token number">0xE0</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0x4D</span><span class="token punctuation">,</span> <span class="token number">0xAE</span><span class="token punctuation">,</span> <span class="token number">0x2A</span><span class="token punctuation">,</span> <span class="token number">0xF5</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">0xC8</span><span class="token punctuation">,</span> <span class="token number">0xEB</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x99</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">,</span>
        <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">0x2B</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x7E</span><span class="token punctuation">,</span> <span class="token number">0xBA</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0xD6</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">,</span> <span class="token number">0xE1</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x7D</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> IV<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>proof_of_work<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>
        req <span class="token operator">=</span> self<span class="token punctuation">.</span>request
        flag_len <span class="token operator">=</span> len<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>flag_len <span class="token operator">==</span> <span class="token number">33</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>flag <span class="token operator">=</span> self<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">256</span><span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>
                <span class="token string">'Welcome to AES(WXH) encrypt system.\n1. get encrypted flag.\n2. pad flag.\n3.Do some encrypt.\nYour choice:'</span><span class="token punctuation">)</span>
            cmd <span class="token operator">=</span> req<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                cmd <span class="token operator">=</span> int<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
                cmd <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">if</span> cmd <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                enc <span class="token operator">=</span> self<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'Here is the encrypted flag: 0x%s\n'</span> <span class="token operator">%</span> enc<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> cmd <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'Pad me something:'</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>flag <span class="token operator">=</span> self<span class="token punctuation">.</span>unpad<span class="token punctuation">(</span>self<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">[</span>
                    <span class="token punctuation">:</span>flag_len<span class="token punctuation">]</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>flag<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">256</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>flag <span class="token operator">=</span> self<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>self<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'Done.\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> cmd <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'What do you want to encrypt:'</span><span class="token punctuation">)</span>
                msg <span class="token operator">=</span> self<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>req<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">256</span><span class="token punctuation">)</span>
                enc <span class="token operator">=</span> self<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'Here is the encrypted message: 0x%s\n'</span> <span class="token operator">%</span> enc<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'Do not lose heart～ ！% Once WXH AK IOI 2019 can Solved! WXH is the first in the tianxia!'</span><span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>


<span class="token keyword">class</span> <span class="token class-name">ThreadedServer</span><span class="token punctuation">(</span>SocketServer<span class="token punctuation">.</span>ThreadingMixIn<span class="token punctuation">,</span> SocketServer<span class="token punctuation">.</span>TCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    HOST<span class="token punctuation">,</span> PORT <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">23333</span>
    <span class="token keyword">print</span> <span class="token string">'Run in port:23333'</span>
    server <span class="token operator">=</span> ThreadedServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> Task<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>这个题目问题出在 padding 的时候，由于不足 256 位要进行 padding，padding 的字节也就是缺的字节数，但是如果明文够 256 字节，那么按照代码逻辑就不进行 padding：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">pad</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> chr<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'\x00'</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> pos <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>s_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最大的问题出在 unpad 上，unpad 没有进行检查，仅仅通过最后一个字节来判断填充的字节数。</p>
<pre class="line-numbers language-python"><code class="language-python"> <span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'\x00'</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> index<span class="token punctuation">,</span> pos <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>invs_box<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以通过篡改最后一个字节来控制去掉的 padding 字节数。</p>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><ol>
<li>选择 choice2，追加 <code>256-33 =223</code>字节，使当前 flag 不需要填充，追加的最后一个字节设置成 <code>chr(256-32)</code>。</li>
<li>服务器对 flag 追加我们的信息，并进行 s 盒替换，结果赋给类中的 flag 变量。</li>
<li>我们再次选择 choice2，这里由于我们需要追加，服务器会将类中的 flag 变量取出进行逆 S 盒替换和 unpad，这样按照这个 unpad 算法会把后面 224 字节的全部当成 padding 去掉，明文剩下了真正 flag 的前 32 位。</li>
<li>我们此时输入一个字符 i, 那么此时加密的对象就是 <code>flag[:32]+i</code>。</li>
<li>选择 choice1 对当前 flag 加密，控制 i 进行爆破，如果得到的密文和最初的 flag 加密的密文一样，就得到了 flag 的最后一个字节。</li>
<li>逐字节爆破，直至获取全部的 flag。</li>
</ol>
<p>exp 如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha256
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> string
<span class="token keyword">import</span> itertools
HOST<span class="token operator">=</span><span class="token string">'106.75.13.64'</span>
PORT<span class="token operator">=</span><span class="token number">54321</span>
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">brute_force</span><span class="token punctuation">(</span>pad<span class="token punctuation">,</span> shavalue<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> str <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        str<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>str<span class="token punctuation">)</span>
        <span class="token keyword">if</span> sha256<span class="token punctuation">(</span>str <span class="token operator">+</span> pad<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> shavalue<span class="token punctuation">:</span>
            <span class="token keyword">print</span> str
            <span class="token keyword">return</span> str
<span class="token keyword">def</span> <span class="token function">choice1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"1\n"</span><span class="token punctuation">)</span>
    result<span class="token operator">=</span>sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token keyword">def</span> <span class="token function">choice2</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"2\n"</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pad<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">choice3</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"3\n"</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
    result<span class="token operator">=</span>sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
content <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
pad<span class="token operator">=</span>content<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span>
hash<span class="token operator">=</span>content<span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token operator">+</span><span class="token number">64</span><span class="token punctuation">]</span>
sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>brute_force<span class="token punctuation">(</span>pad<span class="token punctuation">,</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag_enc<span class="token operator">=</span>choice1<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">223</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span><span class="token number">224</span><span class="token operator">+</span>i<span class="token punctuation">)</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> string<span class="token punctuation">.</span>printable<span class="token punctuation">:</span>
        <span class="token keyword">print</span> c<span class="token operator">+</span>flag
        choice2<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        choice2<span class="token punctuation">(</span>c<span class="token operator">+</span>flag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> choice1<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> flag_enc<span class="token punctuation">:</span>
            flag<span class="token operator">=</span>c<span class="token operator">+</span>flag
            <span class="token keyword">print</span> <span class="token string">"success:"</span><span class="token punctuation">,</span>flag
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>flag{H4ve_fun_w1th_p4d_and_unp4d}</p>
</blockquote>
<h2 id="ECB"><a href="#ECB" class="headerlink" title="ECB"></a>ECB</h2><p>ECB 模式全称为电子密码本模式（Electronic codebook）。</p>
<h3 id="加密-1"><a href="#加密-1" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ecb_encryption.png" alt=""></p>
<h3 id="解密-1"><a href="#解密-1" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ecb_decryption.png" alt=""></p>
<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ol>
<li>实现简单。</li>
<li>不同明文分组的加密可以并行计算，速度很快。</li>
</ol>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>同样的明文块会被加密成相同的密文块，不会隐藏明文分组的统计规律。正如下图所示</li>
</ol>
<p><img src="/images/loading.gif" data-original="../images/CTF/ecb_bad_linux.png" alt="image-20180716215135907"></p>
<p>为了解决统一明文产生相同密文的问题，提出了其它的加密模式。</p>
<h3 id="典型应用"><a href="#典型应用" class="headerlink" title="典型应用"></a>典型应用</h3><ol>
<li>用于随机数的加密保护。</li>
<li>用于单分组明文的加密。</li>
</ol>
<h3 id="2016-ABCTF-aes-mess-75"><a href="#2016-ABCTF-aes-mess-75" class="headerlink" title="2016 ABCTF aes-mess-75"></a>2016 ABCTF aes-mess-75</h3><p>题目描述如下</p>
<pre><code>We encrypted a flag with AES-ECB encryption using a secret key, and got the hash: e220eb994c8fc16388dbd60a969d4953f042fc0bce25dbef573cf522636a1ba3fafa1a7c21ff824a5824c5dc4a376e75 However, we lost our plaintext flag and also lost our key and we can't seem to decrypt the hash back :(. Luckily we encrypted a bunch of other flags with the same key. Can you recover the lost flag using this?

[HINT] There has to be some way to work backwards, right?</code></pre><p>可以看出，这个加密是一个 ECB 加密，然后 AES 是 16 个字节一组，每个字节可以使用两个 16 进制字符表示，因此，我们每 32 个字符一组进行分组，然后去对应的 txt 文件中搜索即可。</p>
<p>对应 flag</p>
<pre><code>e220eb994c8fc16388dbd60a969d4953 abctf{looks_like
f042fc0bce25dbef573cf522636a1ba3 _you_can_break_a
fafa1a7c21ff824a5824c5dc4a376e75 es}</code></pre><p>最后一个显然在加密时进行了 padding。</p>
<h2 id="CBC"><a href="#CBC" class="headerlink" title="CBC"></a>CBC</h2><p>CBC 全称为密码分组链接（Cipher-block chaining） 模式，这里</p>
<ul>
<li>IV 不要求保密</li>
<li>IV 必须是不可预测的，而且要保证完整性。</li>
</ul>
<h3 id="加密-2"><a href="#加密-2" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/cbc_encryption.png" alt=""></p>
<h3 id="解密-2"><a href="#解密-2" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/cbc_decryption.png" alt=""></p>
<h3 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h3><h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ol>
<li>密文块不仅和当前密文块相关，而且和前一个密文块或 IV 相关，隐藏了明文的统计特性。</li>
<li>具有有限的两步错误传播特性，即密文块中的一位变化只会影响当前密文块和下一密文块。</li>
<li>具有自同步特性，即第 k 块起密文正确，则第 k+1 块就能正常解密。</li>
</ol>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>加密不能并行，解密可以并行。</li>
</ol>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>CBC 应用十分广泛</p>
<ul>
<li>常见的数据加密和 TLS 加密。</li>
<li>完整性认证和身份认证。</li>
</ul>
<h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><h4 id="字节反转攻击"><a href="#字节反转攻击" class="headerlink" title="字节反转攻击"></a>字节反转攻击</h4><h5 id="原理-19"><a href="#原理-19" class="headerlink" title="原理"></a>原理</h5><p>字节反转的原理十分简单，我们观察<strong>解密过程</strong>可以发现如下特性:</p>
<ul>
<li>IV 向量影响第一个明文分组</li>
<li>第 n 个密文分组可以影响第 n + 1 个明文分组</li>
</ul>
<p>假设第nn 个密文分组为CnCn，解密后的第nn 个明文分组为为PnPn。</p>
<p>然后Pn+1=Cn xor f(Cn+1)Pn+1=Cn xor f(Cn+1)。</p>
<p>其中ff 函数为图中的Block Cipher DecryptionBlock Cipher Decryption。</p>
<p>对于某个信息已知的原文和密文，然后我们可以修改第nn 个密文块CnCn 为Cn xor Pn+1 xor ACn xor Pn+1 xor A。然后再对这条密文进行解密，那么解密后的第nn 个明文快将会变成AA。</p>
<h5 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h5><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> FLAG
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto <span class="token keyword">import</span> Random
<span class="token keyword">import</span> base64

BLOCK_SIZE<span class="token operator">=</span><span class="token number">16</span>
IV <span class="token operator">=</span> Random<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span>BLOCK_SIZE<span class="token punctuation">)</span>
passphrase <span class="token operator">=</span> Random<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span>BLOCK_SIZE<span class="token punctuation">)</span>

pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BLOCK_SIZE<span class="token punctuation">)</span> <span class="token operator">*</span> chr<span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">-</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BLOCK_SIZE<span class="token punctuation">)</span>
unpad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>s<span class="token punctuation">[</span>len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

prefix <span class="token operator">=</span> <span class="token string">"flag="</span><span class="token operator">+</span>FLAG<span class="token operator">+</span><span class="token string">"&amp;userdata="</span>
suffix <span class="token operator">=</span> <span class="token string">"&amp;user=guest"</span>
<span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">"1. encrypt"</span>
    <span class="token keyword">print</span> <span class="token string">"2. decrypt"</span>
    <span class="token keyword">return</span> raw_input<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> raw_input<span class="token punctuation">(</span><span class="token string">"your data: "</span><span class="token punctuation">)</span>
    plain <span class="token operator">=</span> prefix<span class="token operator">+</span>data<span class="token operator">+</span>suffix
    aes <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>passphrase<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> IV<span class="token punctuation">)</span>
    <span class="token keyword">print</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pad<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> raw_input<span class="token punctuation">(</span><span class="token string">"input data: "</span><span class="token punctuation">)</span>
    aes <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>passphrase<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> IV<span class="token punctuation">)</span>
    plain <span class="token operator">=</span> unpad<span class="token punctuation">(</span>aes<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'DEBUG ====> '</span> <span class="token operator">+</span> plain
    <span class="token keyword">if</span> plain<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">"admin"</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> plain
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"you are not admin"</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> menu<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cmd<span class="token operator">==</span><span class="token string">"1"</span><span class="token punctuation">:</span>
            encrypt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> cmd<span class="token operator">==</span><span class="token string">"2"</span><span class="token punctuation">:</span>
            decrypt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见题目希望我们提供一个加密的字符串，如果这个字符串解密后最后的内容为 admin。程序将会输出明文。所以题目流程为先随便提供一个明文，然后将密文进行修改，使得解密后的字符串最后的内容为 admin, 我们可以枚举 flag 的长度来确定我们需要在什么位置进行修改。</p>
<p>以下是 exp.py</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> base64

pad <span class="token operator">=</span> <span class="token number">16</span>
data <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> pad
<span class="token keyword">for</span> x <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'xxx.xxx.xxx.xxx'</span><span class="token punctuation">,</span> <span class="token number">10004</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#r = process('./chall.sh')</span>

    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your data: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> list<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#print 'cipher ===>', ''.join(cipher)</span>

    BLOCK_SIZE <span class="token operator">=</span> <span class="token number">16</span>
    prefix <span class="token operator">=</span> <span class="token string">"flag="</span> <span class="token operator">+</span> <span class="token string">'a'</span> <span class="token operator">*</span> x <span class="token operator">+</span> <span class="token string">"&amp;userdata="</span>
    suffix <span class="token operator">=</span> <span class="token string">"&amp;user=guest"</span>
    plain <span class="token operator">=</span> prefix <span class="token operator">+</span> data <span class="token operator">+</span> suffix

    idx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">22</span> <span class="token operator">+</span> x <span class="token operator">+</span> pad<span class="token punctuation">)</span> <span class="token operator">%</span> BLOCK_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">22</span> <span class="token operator">+</span> x <span class="token operator">+</span> pad<span class="token punctuation">)</span> <span class="token operator">/</span> BLOCK_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_SIZE
    cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'m'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'input data: '</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    msg <span class="token operator">=</span> r<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'you are not admin'</span> <span class="token operator">not</span> <span class="token keyword">in</span> msg<span class="token punctuation">:</span>
        <span class="token keyword">print</span> msg
        <span class="token keyword">break</span>
    r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="PCBC"><a href="#PCBC" class="headerlink" title="PCBC"></a>PCBC</h2><p>PCBC 的全称为明文密码块链接（Plaintext cipher-block chaining）。也称为填充密码块链接（Propagating cipher-block chaining）。</p>
<h3 id="加密-3"><a href="#加密-3" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/pcbc_encryption.png" alt=""></p>
<h3 id="解密-3"><a href="#解密-3" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/pcbc_decryption.png" alt=""></p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>解密过程难以并行化</li>
<li>互换邻接的密文块不会对后面的密文块造成影响</li>
</ul>
<h2 id="CFB"><a href="#CFB" class="headerlink" title="CFB"></a>CFB</h2><p>CFB 全称为密文反馈模式（Cipher feedback）。</p>
<h3 id="加密-4"><a href="#加密-4" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/cfb_encryption.png" alt=""></p>
<h3 id="解密-4"><a href="#解密-4" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/cfb_decryption.png" alt=""></p>
<h3 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h3><h4 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h4><ul>
<li>适应于不同数据格式的要求</li>
<li>有限错误传播</li>
<li>自同步</li>
</ul>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>加密不能并行化，解密不能并行</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>该模式适应于数据库加密，无线通信加密等对数据格式有特殊要求的加密环境。</p>
<h2 id="OFB"><a href="#OFB" class="headerlink" title="OFB"></a>OFB</h2><p>OFB 全称为输出反馈模式（Output feedback），其反馈内容是分组加密后的内容而不是密文。</p>
<h3 id="加密-5"><a href="#加密-5" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ofb_encryption.png" alt=""></p>
<h3 id="解密-5"><a href="#解密-5" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ofb_decryption.png" alt=""></p>
<h3 id="优缺点-4"><a href="#优缺点-4" class="headerlink" title="优缺点"></a>优缺点</h3><h4 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h4><ol>
<li>不具有错误传播特性。</li>
</ol>
<h4 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>IV 无需保密，但是对每个消息必须选择不同的 IV。</li>
<li>不具有自同步能力。</li>
</ol>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><p>适用于一些明文冗余度比较大的场景，如图像加密和语音加密。</p>
<h2 id="CTR"><a href="#CTR" class="headerlink" title="CTR"></a>CTR</h2><p>CTR 全称为计数器模式（Counter mode），该模式由 Diffe 和 Hellman 设计。</p>
<h3 id="加密-6"><a href="#加密-6" class="headerlink" title="加密"></a>加密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ctr_encryption.png" alt=""></p>
<h3 id="解密-6"><a href="#解密-6" class="headerlink" title="解密"></a>解密</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ctr_encryption.png" alt=""></p>
<h1 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h1><h2 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h2><p>Padding Oracle Attack 攻击一般需要满足以下几个条件</p>
<ul>
<li>加密算法<ul>
<li>采用 PKCS5 Padding 的加密算法。 当然，非对称加密中 OAEP 的填充方式也有可能会受到影响。</li>
<li>分组模式为 CBC 模式。</li>
</ul>
</li>
<li>攻击者能力<ul>
<li>攻击者可以拦截上述加密算法加密的消息。</li>
<li>攻击者可以和 padding oracle（即服务器） 进行交互：客户端向服务器端发送密文，服务器端会以某种返回信息告知客户端 padding 是否正常。</li>
</ul>
</li>
</ul>
<p>Padding Oracle Attack 攻击可以达到的效果如下</p>
<ul>
<li>在不清楚 key 和 IV 的前提下解密任意给定的密文。</li>
</ul>
<h2 id="原理-20"><a href="#原理-20" class="headerlink" title="原理"></a>原理</h2><p>Padding Oracle Attack 攻击的基本原理如下</p>
<ul>
<li>对于很长的消息一块一块解密。</li>
<li>对于每一块消息，先解密消息的最后一个字节，然后解密倒数第二个字节，依次类推。</li>
</ul>
<p>这里我们回顾一下 CBC 的</p>
<ul>
<li>加密</li>
</ul>
<p>$$<br>C_i=E_K(P_i \oplus C_{i-1})\<br>C_0=IV<br>$$</p>
<ul>
<li>解密</li>
</ul>
<p>$$<br>P_{i}=D_{K}(C_{i})\oplus C_{i-1}\ C_{0}=IV<br>$$</p>
<p>我们主要关注于解密，这里我们并不知道 IV 和 key。这里我们假设密文块的长度为 n 个字节。</p>
<p>假设我们截获了密文 Y，以获取密文 Y 的最后一个字节为例子进行分析。为了获取 Y 的内容，我们首先需要伪造一块密文 F 以便于可以修改 Y 对应明文的最后一个字节。这是因为若我们构造密文 <code>F|Y</code> ，那么解密 Y 时具体为 $P=D_K(Y)\oplus F$ ，所以修改密文 F 的最后一个字节 $F_{n}$ 可以修改 Y 对应的明文的最后一个字节。下面给出获取 P 最后一个字节的过程</p>
<ol>
<li>i=0，设置 F 的每个字节为<strong>随机字节</strong>。</li>
<li>设置 $F_n=i \oplus 0x01$</li>
<li>将 F|Y 发送给服务器，如果 P 的最后一个字节是 i 的话，那么最后的 padding 就是 0x01，不会出现错误。否则，只有 P 的最后 $P_n \oplus i \oplus 0x01$ 字节都是 $P_n \oplus i \oplus 0x01$ 才不会报错。<strong>而且，需要注意的是 padding 的字节只能是 0 到 n。</strong> 因此，若想要使得在 F 随机地情况下，并且满足padding 字节大小的约束情况下还不报错<strong>概率很小</strong>。所以在服务器端不报错的情况下，我们可以认为我们确实获取了正确的字节。</li>
<li>在出现错误的情况下，i=i+1，跳转到2。</li>
</ol>
<p>当获取了 P 的最后一个字节后，我们可以继续获取 P 的倒数第二个字节，此时需要设置 $F_n=P_n\oplus 0x02$ ，同时设置 $F_{n-1}=i \oplus 0x02$ 去枚举 i。</p>
<p>所以，综上所示，Padding Oracle Attack 其实在一定程度上是一种具有很大概率成功的攻击方法。</p>
<p>然而，需要注意的是，往往遇到的一些现实问题并不是标准的 Padding Oracle Attack 模式，我们往往需要进行一些变形。</p>
<h2 id="2017-HITCON-Secret-Server"><a href="#2017-HITCON-Secret-Server" class="headerlink" title="2017 HITCON Secret Server"></a>2017 HITCON Secret Server</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>程序中采用的加密是 AES CBC，其中采用的 padding 与 PKCS5 类似</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">pad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pad_length <span class="token operator">=</span> <span class="token number">16</span><span class="token operator">-</span>len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">16</span>
    <span class="token keyword">return</span> msg<span class="token operator">+</span>chr<span class="token punctuation">(</span>pad_length<span class="token punctuation">)</span><span class="token operator">*</span>pad_length

<span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，在每次 unpad 时并没有进行检测，而是直接进行 unpad。</p>
<p>其中，需要注意的是，每次和用户交互的函数是</p>
<ul>
<li><code>send_msg</code> ，接受用户的明文，使用固定的 <code>2jpmLoSsOlQrqyqE</code> 作为 IV，进行加密，并将加密结果输出。</li>
<li><code>recv_msg</code> ，接受用户的 IV 和密文，对密文进行解密，并返回。根据返回的结果会有不同的操作</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python">            msg <span class="token operator">=</span> recv_msg<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'exit-here'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-flag'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-md5'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>MD5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-time'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>str<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-sha1'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>SHA<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-sha256'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> msg<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'get-hmac'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span>HMAC<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                send_msg<span class="token punctuation">(</span><span class="token string">'command not found'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="主要漏洞"><a href="#主要漏洞" class="headerlink" title="主要漏洞"></a>主要漏洞</h3><p>这里我们再简单总结一下我们已有的部分</p>
<ul>
<li>加密<ul>
<li>加密时的 IV 是固定的而且已知。</li>
<li><code>Welcome!!</code> 加密后的结果。</li>
</ul>
</li>
<li>解密<ul>
<li>我们可以控制 IV。</li>
</ul>
</li>
</ul>
<p>首先，既然我们知道 <code>Welcome!!</code> 加密后的结果，还可以控制 recv_msg 中的 IV，那么根据解密过程</p>
<p>$$<br>P_{i}=D_{K}(C_{i})\oplus C_{i-1}\ C_{0}=IV<br>$$</p>
<p>如果我们将 <code>Welcome!!</code> 加密后的结果输入给 recv_msg，那么直接解密后的结果便是 <code>（Welcome!!+'\x07'*7) xor iv</code>，如果我们<strong>恰当的控制解密过程中传递的 iv</strong>，那么我们就可以控制解密后的结果。也就是说我们可以执行<strong>上述所说的任意命令</strong>。从而，我们也就可以知道 <code>flag</code> 解密后的结果。</p>
<p>其次，在上面的基础之上，如果我们在任何密文 C 后面添加自定义的 IV 和 Welcome 加密后的结果，作为输入传递给 recv_msg，那么我们便可以控制解密之后的消息的最后一个字节，<strong>那么由于 unpad 操作，我们便可以控制解密后的消息的长度减小 0 到 255</strong>。</p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>基本利用思路如下</p>
<ol>
<li>绕过 proof of work</li>
<li>根据执行任意命令的方式获取加密后的 flag。</li>
<li>由于 flag 的开头是 <code>hitcon{</code>，一共有7个字节，所以我们任然可以通过控制 iv 来使得解密后的前 7 个字节为指定字节。这使得我们可以对于解密后的消息执行 <code>get-md5</code> 命令。而根据 unpad 操作，我们可以控制解密后的消息恰好在消息的第几个字节处。所以我们可以开始时将控制解密后的消息为 <code>hitcon{x</code>，即只保留<code>hitcon{</code> 后的一个字节。这样便可以获得带一个字节哈希后的加密结果。类似地，我们也可以获得带制定个字节哈希后的加密结果。</li>
<li>这样的话，我们可以在本地逐字节爆破，计算对应 <code>md5</code>，然后再次利用任意命令执行的方式，控制解密后的明文为任意指定命令，如果控制不成功，那说明该字节不对，需要再次爆破；如果正确，那么就可以直接执行对应的命令。</li>
</ol>
<p>具体代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf-8</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> base64<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random<span class="token punctuation">,</span> string
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA256<span class="token punctuation">,</span> MD5
<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>
<span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'REMOTE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'52.193.157.19'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">strxor</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>c1<span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c1<span class="token punctuation">,</span> c2 <span class="token keyword">in</span> zip<span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pad_length <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">16</span>
    <span class="token keyword">return</span> msg <span class="token operator">+</span> chr<span class="token punctuation">(</span>pad_length<span class="token punctuation">)</span> <span class="token operator">*</span> pad_length


<span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># 去掉pad</span>


<span class="token keyword">def</span> <span class="token function">flipplain</span><span class="token punctuation">(</span>oldplain<span class="token punctuation">,</span> newplain<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""flip oldplain to new plain, return proper iv"""</span>
    <span class="token keyword">return</span> strxor<span class="token punctuation">(</span>strxor<span class="token punctuation">(</span>oldplain<span class="token punctuation">,</span> newplain<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">bypassproof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'SHA256(XXXX+'</span><span class="token punctuation">)</span>
    lastdata <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">' == '</span><span class="token punctuation">)</span>
    digest <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nGive me XXXX:'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">proof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>s <span class="token operator">+</span> lastdata<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> digest

    data <span class="token operator">=</span> pwnlib<span class="token punctuation">.</span>util<span class="token punctuation">.</span>iters<span class="token punctuation">.</span>mbruteforce<span class="token punctuation">(</span>
        proof<span class="token punctuation">,</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'fixed'</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Done!\n'</span><span class="token punctuation">)</span>


iv_encrypt <span class="token operator">=</span> <span class="token string">'2jpmLoSsOlQrqyqE'</span>


<span class="token keyword">def</span> <span class="token function">getmd5enc</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> cipher_flag<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""return encrypt( md5( flag[7:7+i] ) )"""</span>
    <span class="token comment" spellcheck="true">## keep iv[7:] do not change, so decrypt won't change</span>
    new_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span><span class="token string">"hitcon{"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"get-md5"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>
        <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> new_iv <span class="token operator">+</span> cipher_flag
    <span class="token comment" spellcheck="true">## calculate the proper last byte number</span>
    last_byte_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>
        pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"a"</span> <span class="token operator">*</span> <span class="token number">15</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cipher_flag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> last_byte_iv <span class="token operator">+</span> cipher_welcome
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    bypassproof<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># result of encrypted Welcome!!</span>
    cipher <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    cipher_welcome <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"cipher welcome is : "</span> <span class="token operator">+</span> cipher_welcome<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># execute get-flag</span>
    get_flag_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pad<span class="token punctuation">(</span><span class="token string">"get-flag"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>get_flag_iv <span class="token operator">+</span> cipher_welcome<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    cipher_flag <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    flaglen <span class="token operator">=</span> len<span class="token punctuation">(</span>cipher_flag<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"cipher flag is : "</span> <span class="token operator">+</span> cipher_flag<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get command not found cipher</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv_encrypt <span class="token operator">+</span> cipher_welcome<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cipher_notfound <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    flag <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token comment" spellcheck="true"># brute force for every byte of flag</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>flaglen <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        md5_indexi <span class="token operator">=</span> getmd5enc<span class="token punctuation">(</span>i<span class="token punctuation">,</span> cipher_flag<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">)</span>
        md5_indexi <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>md5_indexi<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"get encrypt(md5(flag[7:7+i])): "</span> <span class="token operator">+</span> md5_indexi<span class="token punctuation">)</span>
        <span class="token keyword">for</span> guess <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># locally compute md5 hash</span>
            guess_md5 <span class="token operator">=</span> MD5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>flag <span class="token operator">+</span> chr<span class="token punctuation">(</span>guess<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># try to null out the md5 plaintext and execute a command</span>
            payload <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>guess_md5<span class="token punctuation">,</span> <span class="token string">'get-time'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                iv_encrypt<span class="token punctuation">)</span>
            payload <span class="token operator">+=</span> md5_indexi
            p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># if we receive the block for 'command not found', the hash was wrong</span>
            <span class="token keyword">if</span> res <span class="token operator">==</span> cipher_notfound<span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">'Guess {} is wrong.'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>guess<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># otherwise we correctly guessed the hash and the command was executed</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">'Found!'</span>
                flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>guess<span class="token punctuation">)</span>
                <span class="token keyword">print</span> <span class="token string">'Flag so far:'</span><span class="token punctuation">,</span> flag
                <span class="token keyword">break</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后结果如下</p>
<pre class="line-numbers language-Shell"><code class="language-Shell">Flag so far: Paddin9_15_ve3y_h4rd__!!}\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="2017-HITCON-Secret-Server-Revenge"><a href="#2017-HITCON-Secret-Server-Revenge" class="headerlink" title="2017 HITCON Secret Server Revenge"></a>2017 HITCON Secret Server Revenge</h2><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><pre><code>The password of zip is the flag of "Secret Server"</code></pre><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>这个程序时接着上面的程序继续搞的，不过这次进行的简单的修改</p>
<ul>
<li>加密算法的 iv 未知，不过可以根据 Welcome 加密后的消息推算出来。</li>
<li>程序多了一个 56 字节的 token。</li>
<li>程序最多能进行 340 操作，因此上述的爆破自然不可行</li>
</ul>
<p>程序的大概流程如下</p>
<ol>
<li>经过 proof of work</li>
<li>发送 “Welcome!!” 加密后的消息</li>
<li>在 340 次操作中，需要猜中 token 的值，然后会自动将 flag 输出。</li>
</ol>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>当然，在上个题目中存在的漏洞，在这个题目中仍然存在，即</p>
<ol>
<li>任意执行给定命令</li>
<li>长度截断</li>
</ol>
<h3 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h3><p>由于 340 的次数限制，虽然我们仍然可以获得 <code>md5(token[:i])</code> 加密后的值（<strong>这里需要注意的是这部分加密后恰好是 32 个字节，前 16 个字节是 md5 后加密的值，后面的 16 个字节完全是填充的加密后的字节。</strong>这里<code>md5(token[:i])</code>  特指前16个字节。）。但是，我们不能再次为了获得一个字符去爆破 256 次了。</p>
<p>既然不能够爆破，那么我们有没有可能一次获取一个字节的大小呢？这里，我们再来梳理一下该程序可能可以泄漏的信息</p>
<ol>
<li>某些消息的 md5 值加密后的值，这里我们可以获取 <code>md5(token[:i])</code> 加密后的值。</li>
<li>unpad 每次会对解密后的消息进行 unpad，这个字节是根据解密后的消息的最后一个字节来决定的。如果我们可以计算出这个字节的大小，那么我们就可能可以知道一个字节的值。</li>
</ol>
<p>这里我们深入分析一下 unpad 的信息泄漏。如果我们将加密 IV 和 <code>encrypt(md5(token[:i]))</code> 放在某个密文 C 的后面，构成 <code>C|IV|encrypt(md5(token[:i]))</code>，那么解密出来的消息的最后一个明文块就是 <code>md5(token[:i])</code>。进而，在 unpad 的时候就是利用 <code>md5(token[:i])</code> 的最后一个字节（ 0-255）进行 unpad，之后对 unpad 后的字符串执行指定的命令（比如md5）。那么，如果我们<strong>事先构造一些消息哈希后加密的样本</strong>，然后将上述执行后的结果与样本比较，如果相同，那么我们基本可以确定 <code>md5(token[:i])</code> 的<strong>最后一个字节</strong>。然而，如果 <code>md5(token[:i])</code> 的最后一个字节小于16，那么在 unpad 时就会利用一些 md5 中的值，而这部分值，由于对于不同长度的 <code>token[:i]</code> 几乎都不会相同。所以可能需要特殊处理。</p>
<p>我们已经知道了这个问题的关键，即生成与 unpad 字节大小对应的加密结果样本，以便于查表。</p>
<p>具体利用思路如下</p>
<ol>
<li>绕过 proof of work。</li>
<li>获取 token 加密后的结果 <code>token_enc</code> ，这里会在 token 前面添加 7 个字节 <code>"token: "</code> 。 因此加密后的长度为 64。</li>
<li>依次获取 <code>encrypt(md5(token[:i]))</code> 的结果，一共是 57 个，包括最后一个 token 的 padding。</li>
<li>构造与 unpad 大小对应的样本。这里我们构造密文 <code>token_enc|padding|IV_indexi|welcome_enc</code>。由于 <code>IV_indexi</code> 是为了修改最后一个明文块的最后一个字节，所以该字节处于变化之中。我们若想获取一些固定字节的哈希值，这部分自然不能添加。因此这里产生样本时 unpad 的大小范围为 17 ~ 255。如果最后测试时 <code>md5(token[:i])</code> 的最后一个字节小于17的话，基本就会出现一些未知的样本。很自然的一个想法是我们直接获取 255-17+1个这么多个样本，然而，如果这样做的话，根据上面 340 的次数（255-17+1+57+56&gt;340）限制，我们显然不能获取到 token 的所有字节。所以这里我们需要想办法复用一些内容，这里我们选择复用  <code>encrypt(md5(token[:i]))</code>  的结果。那么我们在补充 padding 时需要确保一方面次数够用，另一方面可以复用之前的结果。这里我们设置 unpad 的循环为 17 到 208，并使得 unpad 大于 208 时恰好 unpad 到我们可以复用的地方。这里需要注意的是，当 <code>md5(token[:i])</code> 的最后一个字节为 0 时，会将所有解密后的明文 unpad 掉，因此会出现 command not found 的密文。</li>
<li>再次构造密文 <code>token_enc|padding|IV|encrypt(md5(token[:i]))</code> ，那么，解密时即使用 <code>md5(token[:i])</code> 的最后一个字节进行 unpad。如果这个字节不小于17或者为0，则可以处理。如果这个字节小于17，那么显然，最后返回给用户的 md5 的结果并不在样本范围内，那么我们修改其最后一个字节的最高比特位，使其 unpad 后可以落在样本范围内。这样，我们就可以猜出 <code>md5(token[:i])</code> 的最后一个字节。</li>
<li>在猜出 <code>md5(token[:i])</code> 的最后一个字节后，我们可以在本地暴力破解 256 次，找出所有哈希值末尾为 <code>md5(token[:i])</code> 的最后一个字节的字符。</li>
<li>但是，在第六步中，对于一个 <code>md5(token[:i])</code>  可能会找出多个备选字符，因为我们只需要使得其末尾字节是给定字节即可。</li>
<li>那么，问题来了，如何删除一些多余的备选字符串呢？这里我就选择了一个小 trick，即在逐字节枚举时，同时枚举出 token 的 padding。由于 padding 是 0x01 是固定的，所以我们只需要过滤出所有结尾不是 0x01 的token 即可。</li>
</ol>
<p>这里，在测试时，将代码中 <code>sleep</code> 注释掉了。以便于加快交互速度。利用代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> base64<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random<span class="token punctuation">,</span> string
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA256<span class="token punctuation">,</span> MD5
<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">strxor</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>c1<span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c1<span class="token punctuation">,</span> c2 <span class="token keyword">in</span> zip<span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pad_length <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">16</span>
    <span class="token keyword">return</span> msg <span class="token operator">+</span> chr<span class="token punctuation">(</span>pad_length<span class="token punctuation">)</span> <span class="token operator">*</span> pad_length


<span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># remove pad</span>


<span class="token keyword">def</span> <span class="token function">flipplain</span><span class="token punctuation">(</span>oldplain<span class="token punctuation">,</span> newplain<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""flip oldplain to new plain, return proper iv"""</span>
    <span class="token keyword">return</span> strxor<span class="token punctuation">(</span>strxor<span class="token punctuation">(</span>oldplain<span class="token punctuation">,</span> newplain<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">bypassproof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'SHA256(XXXX+'</span><span class="token punctuation">)</span>
    lastdata <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">' == '</span><span class="token punctuation">)</span>
    digest <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nGive me XXXX:'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">proof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>s <span class="token operator">+</span> lastdata<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> digest

    data <span class="token operator">=</span> pwnlib<span class="token punctuation">.</span>util<span class="token punctuation">.</span>iters<span class="token punctuation">.</span>mbruteforce<span class="token punctuation">(</span>
        proof<span class="token punctuation">,</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'fixed'</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> iv <span class="token operator">+</span> cipher
    payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">getmd5enc</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> cipher_token<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""return encrypt( md5( token[:i+1] ) )"""</span>
    <span class="token comment" spellcheck="true">## keep iv[7:] do not change, so decrypt msg[7:] won't change</span>
    get_md5_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span><span class="token string">"token: "</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"get-md5"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>
        <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> cipher_token
    <span class="token comment" spellcheck="true">## calculate the proper last byte number</span>
    last_byte_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>
        pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"a"</span> <span class="token operator">*</span> <span class="token number">15</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cipher_token<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> last_byte_iv <span class="token operator">+</span> cipher_welcome
    sendmsg<span class="token punctuation">(</span>get_md5_iv<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token keyword">return</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_md5_token_indexi</span><span class="token punctuation">(</span>iv_encrypt<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">,</span> cipher_token<span class="token punctuation">)</span><span class="token punctuation">:</span>
    md5_token_idxi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>cipher_token<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"idx i: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> md5_indexi <span class="token operator">=</span> getmd5enc<span class="token punctuation">(</span>i<span class="token punctuation">,</span> cipher_token<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>md5_indexi<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># remove the last 16 byte for padding</span>
        md5_token_idxi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>md5_indexi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> md5_token_idxi


<span class="token keyword">def</span> <span class="token function">doin</span><span class="token punctuation">(</span>unpadcipher<span class="token punctuation">,</span> md5map<span class="token punctuation">,</span> candidates<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> unpadcipher <span class="token keyword">in</span> md5map<span class="token punctuation">:</span>
        lastbyte <span class="token operator">=</span> md5map<span class="token punctuation">[</span>unpadcipher<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        lastbyte <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        lastbyte <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">0x80</span>
    newcandidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> candidates<span class="token punctuation">:</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> MD5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>x <span class="token operator">+</span> chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chr<span class="token punctuation">(</span>lastbyte<span class="token punctuation">)</span><span class="token punctuation">:</span>
                newcandidates<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x <span class="token operator">+</span> chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
    candidates <span class="token operator">=</span> newcandidates
    <span class="token keyword">print</span> candidates
    <span class="token keyword">return</span> candidates


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    bypassproof<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># result of encrypted Welcome!!</span>
    iv_encrypt<span class="token punctuation">,</span> cipher_welcome <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"cipher welcome is : "</span> <span class="token operator">+</span> cipher_welcome<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># execute get-token</span>
    get_token_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pad<span class="token punctuation">(</span><span class="token string">"get-token"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
    sendmsg<span class="token punctuation">(</span>get_token_iv<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> cipher_token <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>
    token_len <span class="token operator">=</span> len<span class="token punctuation">(</span>cipher_token<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"cipher token is : "</span> <span class="token operator">+</span> cipher_token<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get command not found cipher</span>
    sendmsg<span class="token punctuation">(</span>iv_encrypt<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> cipher_notfound <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get encrypted(token[:i+1]),57 times</span>
    md5_token_idx_list <span class="token operator">=</span> get_md5_token_indexi<span class="token punctuation">(</span>iv_encrypt<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">,</span>
                                              cipher_token<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># get md5map for each unpadsize, 209-17 times</span>
    <span class="token comment" spellcheck="true"># when upadsize>208, it will unpad ciphertoken</span>
    <span class="token comment" spellcheck="true"># then we can reuse</span>
    md5map <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> unpadsize <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">209</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"get unpad size {} cipher"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>unpadsize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        get_md5_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span><span class="token string">"token: "</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"get-md5"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>
            <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">## padding 16*11 bytes</span>
        padding <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">11</span> <span class="token operator">*</span> <span class="token string">"a"</span>
        <span class="token comment" spellcheck="true">## calculate the proper last byte number, only change the last byte</span>
        <span class="token comment" spellcheck="true">## set last_byte_iv = iv_encrypted[:15] | proper byte</span>
        last_byte_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>
            pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span>unpadsize<span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
        cipher <span class="token operator">=</span> cipher_token <span class="token operator">+</span> padding <span class="token operator">+</span> last_byte_iv <span class="token operator">+</span> cipher_welcome
        sendmsg<span class="token punctuation">(</span>get_md5_iv<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> unpadcipher <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        md5map<span class="token punctuation">[</span>unpadcipher<span class="token punctuation">]</span> <span class="token operator">=</span> unpadsize

    <span class="token comment" spellcheck="true"># reuse encrypted(token[:i+1])</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">209</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        target <span class="token operator">=</span> md5_token_idx_list<span class="token punctuation">[</span><span class="token number">56</span> <span class="token operator">-</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">209</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        md5map<span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> i

    candidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># get the byte token[i], only 56 byte</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>token_len <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"get token[{}]"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        get_md5_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span><span class="token string">"token: "</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"get-md5"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>
            <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">## padding 16*11 bytes</span>
        padding <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">11</span> <span class="token operator">*</span> <span class="token string">"a"</span>
        cipher <span class="token operator">=</span> cipher_token <span class="token operator">+</span> padding <span class="token operator">+</span> iv_encrypt <span class="token operator">+</span> md5_token_idx_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        sendmsg<span class="token punctuation">(</span>get_md5_iv<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> unpadcipher <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># already in or md5[token[:i]][-1]='\x00'</span>
        <span class="token keyword">if</span> unpadcipher <span class="token keyword">in</span> md5map <span class="token operator">or</span> unpadcipher <span class="token operator">==</span> cipher_notfound<span class="token punctuation">:</span>
            candidates <span class="token operator">=</span> doin<span class="token punctuation">(</span>unpadcipher<span class="token punctuation">,</span> md5map<span class="token punctuation">,</span> candidates<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"unpad size 1-16"</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true"># flip most significant bit of last byte to move it in a good range</span>
            cipher <span class="token operator">=</span> cipher<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">+</span> strxor<span class="token punctuation">(</span>cipher<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\x80'</span><span class="token punctuation">)</span> <span class="token operator">+</span> cipher<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            sendmsg<span class="token punctuation">(</span>get_md5_iv<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span>
            _<span class="token punctuation">,</span> unpadcipher <span class="token operator">=</span> recvmsg<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> unpadcipher <span class="token keyword">in</span> md5map <span class="token operator">or</span> unpadcipher <span class="token operator">==</span> cipher_notfound<span class="token punctuation">:</span>
                candidates <span class="token operator">=</span> doin<span class="token punctuation">(</span>unpadcipher<span class="token punctuation">,</span> md5map<span class="token punctuation">,</span> candidates<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'oh my god,,,, it must be in...'</span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> len<span class="token punctuation">(</span>candidates<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># padding 0x01</span>
    candidates <span class="token operator">=</span> filter<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chr<span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidates<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># only 56 bytes</span>
    candidates <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> candidates<span class="token punctuation">]</span>
    <span class="token keyword">print</span> len<span class="token punctuation">(</span>candidates<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>candidates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">56</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># check-token</span>
    check_token_iv <span class="token operator">=</span> flipplain<span class="token punctuation">(</span>
        pad<span class="token punctuation">(</span><span class="token string">"Welcome!!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pad<span class="token punctuation">(</span><span class="token string">"check-token"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iv_encrypt<span class="token punctuation">)</span>
    sendmsg<span class="token punctuation">(</span>check_token_iv<span class="token punctuation">,</span> cipher_welcome<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Give me the token!\n"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>candidates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">...
79
1
hitcon{uNp@d_M3th0D_i5_am4Z1n9!}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Teaser-Dragon-CTF-2018-AES-128-TSB"><a href="#Teaser-Dragon-CTF-2018-AES-128-TSB" class="headerlink" title="Teaser Dragon CTF 2018 AES-128-TSB"></a>Teaser Dragon CTF 2018 AES-128-TSB</h2><p>这个题目还是蛮有意思的，题目描述如下</p>
<pre><code>Haven't you ever thought that GCM mode is overcomplicated and there must be a simpler way to achieve Authenticated Encryption? Here it is!

Server: aes-128-tsb.hackable.software 1337

server.py</code></pre><p>附件以及最后的 exp 自行到 ctf-challenge 仓库下寻找。</p>
<p>题目的基本流程为</p>
<ul>
<li>不断接收 a 和 b 两个字符串，其中 a 为明文，b 为密文，注意<ul>
<li>b 在解密后需要满足尾部恰好等于 iv。</li>
</ul>
</li>
<li>如果 a 和 b 相等，那么根据<ul>
<li>a 为 <code>gimme_flag</code> ，输出加密后的 flag。</li>
<li>否则，输出一串随机加密的字符串。</li>
</ul>
</li>
<li>否则输出一串明文的字符串。</li>
</ul>
<p>此外，我们还可以发现题目中的 unpad 存在问题，可以截断指定长度。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">unpad</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> msg<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span>ord<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>一开始，很直接的思路是 a 和 b 的长度都输入 0 ，那么可以直接绕过 <code>a==b</code> 检查，获取一串随机密文加密的字符串。然而似乎并没有什么作用，我们来分析一下加密的流程</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">tsb_encrypt</span><span class="token punctuation">(</span>aes<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> pad<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    iv <span class="token operator">=</span> get_random_bytes<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    prev_pt <span class="token operator">=</span> iv
    prev_ct <span class="token operator">=</span> iv
    ct <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> block <span class="token keyword">in</span> split_by<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span>iv<span class="token punctuation">]</span><span class="token punctuation">:</span>
        ct_block <span class="token operator">=</span> xor<span class="token punctuation">(</span>block<span class="token punctuation">,</span> prev_pt<span class="token punctuation">)</span>
        ct_block <span class="token operator">=</span> aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>ct_block<span class="token punctuation">)</span>
        ct_block <span class="token operator">=</span> xor<span class="token punctuation">(</span>ct_block<span class="token punctuation">,</span> prev_ct<span class="token punctuation">)</span>
        ct <span class="token operator">+=</span> ct_block
        prev_pt <span class="token operator">=</span> block
        prev_ct <span class="token operator">=</span> ct_block
    <span class="token keyword">return</span> iv <span class="token operator">+</span> ct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不妨假设 $P_0=iv,C_0=iv$，则</p>
<p> $C_i=C_{i-1}\oplus E(P_{i-1} \oplus P_i)$</p>
<p>那么，假设消息长度为 16，与我们想要得到的<code>gimme_flag</code> padding 后长度类似，则</p>
<p> $C_1=IV\oplus E( IV \oplus P_1)$</p>
<p> $C_2=C_1 \oplus E(P_1 \oplus IV)$</p>
<p>可以很容易的发现 $C_2=IV$。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/aes-tsb-encryption.png" alt=""></p>
<p>反过来想，如果我们向服务器发送 <code>iv+c+iv</code>，那么总能绕过 <code>tsb_decrypt</code> 的 mac 检查</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">tsb_decrypt</span><span class="token punctuation">(</span>aes<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    iv<span class="token punctuation">,</span> msg <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    prev_pt <span class="token operator">=</span> iv
    prev_ct <span class="token operator">=</span> iv
    pt <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> block <span class="token keyword">in</span> split_by<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pt_block <span class="token operator">=</span> xor<span class="token punctuation">(</span>block<span class="token punctuation">,</span> prev_ct<span class="token punctuation">)</span>
        pt_block <span class="token operator">=</span> aes<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>pt_block<span class="token punctuation">)</span>
        pt_block <span class="token operator">=</span> xor<span class="token punctuation">(</span>pt_block<span class="token punctuation">,</span> prev_pt<span class="token punctuation">)</span>
        pt <span class="token operator">+=</span> pt_block
        prev_pt <span class="token operator">=</span> pt_block
        prev_ct <span class="token operator">=</span> block
    pt<span class="token punctuation">,</span> mac <span class="token operator">=</span> pt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pt<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> mac <span class="token operator">!=</span> iv<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> CryptoError<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> unpad<span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么此时，服务器解密后的消息则是</p>
<p>$unpad(IV \oplus D(C_1 \oplus IV))$</p>
<h3 id="获取明文最后一个字节"><a href="#获取明文最后一个字节" class="headerlink" title="获取明文最后一个字节"></a>获取明文最后一个字节</h3><p>我们可以考虑控制 D 解密的消息为常数值，比如全零，即<code>C1=IV</code>，那么我们就可以从 0 到 255 枚举 IV 的最后一个字节，得到 $IV \oplus D(C_1 \oplus IV)$ 的最后一个字节也是 0<del>255。而只有是 1</del>15 的时候，<code>unpad</code> 操作过后，消息长度不为 0。因此，我们可以在枚举时统计究竟哪些数字导致了长度不为零，并标记为 1，其余标记为 0。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getlast_byte</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">:</span>
    iv_pre <span class="token operator">=</span> iv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span>
    iv_last <span class="token operator">=</span> ord<span class="token punctuation">(</span>iv<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    tmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get last byte'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        send_data<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        iv <span class="token operator">=</span> iv_pre <span class="token operator">+</span> chr<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        tmpblock <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span>i <span class="token operator">^</span> ord<span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> iv_last<span class="token punctuation">)</span>
        payload <span class="token operator">=</span> iv <span class="token operator">+</span> tmpblock <span class="token operator">+</span> iv
        send_data<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        length<span class="token punctuation">,</span> data <span class="token operator">=</span> recv_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'Looks'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            tmp<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            tmp<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    last_bytes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> tmp <span class="token operator">==</span> xor_byte_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            last_bytes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xor_byte_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'possible last byte is '</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>last_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> last_bytes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，我们可以在最初的时候打表获取最后一个字节所有的可能情况，记录在 xor_byte_map 中。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
every item is a pair [a,b]
a is the xor list
b is the idx which is zero when xored
"""</span>
xor_byte_map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    b <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> i <span class="token operator">^</span> j
        <span class="token keyword">if</span> tmp <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">and</span> tmp <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">:</span>
            a<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            a<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> tmp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            b <span class="token operator">=</span> j
    xor_byte_map<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过与这个表进行对比，我们就可以知道最后一个字节可能的情况。</p>
<h3 id="解密任意加密块"><a href="#解密任意加密块" class="headerlink" title="解密任意加密块"></a>解密任意加密块</h3><p>在获取了明文最后一个字节后，我们就可以利用  unpad 的漏洞，从长度 1 枚举到长度 15 来获得对应的明文内容。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dec_block</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">:</span>
    last_bytes <span class="token operator">=</span> getlast_byte<span class="token punctuation">(</span>iv<span class="token punctuation">,</span> block<span class="token punctuation">)</span>

    iv_pre <span class="token operator">=</span> iv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span>
    iv_last <span class="token operator">=</span> ord<span class="token punctuation">(</span>iv<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'try to get plain'</span><span class="token punctuation">)</span>
    plain0 <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> last_byte <span class="token keyword">in</span> last_bytes<span class="token punctuation">:</span>
        plain0 <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">'idx:'</span><span class="token punctuation">,</span> i
            tag <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                send_data<span class="token punctuation">(</span>plain0 <span class="token operator">+</span> chr<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>
                pad_size <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">-</span> i
                iv <span class="token operator">=</span> iv_pre <span class="token operator">+</span> chr<span class="token punctuation">(</span>pad_size <span class="token operator">^</span> last_byte<span class="token punctuation">)</span>
                tmpblock <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">+</span> chr<span class="token punctuation">(</span>
                    pad_size <span class="token operator">^</span> last_byte <span class="token operator">^</span> ord<span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> iv_last
                <span class="token punctuation">)</span>
                payload <span class="token operator">=</span> iv <span class="token operator">+</span> tmpblock <span class="token operator">+</span> iv
                send_data<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
                length<span class="token punctuation">,</span> data <span class="token operator">=</span> recv_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token string">'Looks'</span> <span class="token operator">not</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
                    <span class="token comment" spellcheck="true"># success</span>
                    plain0 <span class="token operator">+=</span> chr<span class="token punctuation">(</span>j<span class="token punctuation">)</span>
                    tag <span class="token operator">=</span> <span class="token boolean">True</span>
                    <span class="token keyword">break</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> tag<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token comment" spellcheck="true"># means the last byte is ok</span>
        <span class="token keyword">if</span> plain0 <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    plain0 <span class="token operator">+=</span> chr<span class="token punctuation">(</span>iv_last <span class="token operator">^</span> last_byte<span class="token punctuation">)</span>
    <span class="token keyword">return</span> plain0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="解密出指定明文"><a href="#解密出指定明文" class="headerlink" title="解密出指定明文"></a>解密出指定明文</h3><p>这一点比较简单，我们希望利用这一点来获取 <code>gimme_flag</code> 的密文</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get the cipher of flag'</span><span class="token punctuation">)</span>
    gemmi_iv1 <span class="token operator">=</span> xor<span class="token punctuation">(</span>pad<span class="token punctuation">(</span><span class="token string">'gimme_flag'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plain0<span class="token punctuation">)</span>
    gemmi_c1 <span class="token operator">=</span> xor<span class="token punctuation">(</span>gemmi_iv1<span class="token punctuation">,</span> cipher0<span class="token punctuation">)</span>
    payload <span class="token operator">=</span> gemmi_iv1 <span class="token operator">+</span> gemmi_c1 <span class="token operator">+</span> gemmi_iv1
    send_data<span class="token punctuation">(</span><span class="token string">'gimme_flag'</span><span class="token punctuation">)</span>
    send_data<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    flag_len<span class="token punctuation">,</span> flag_cipher <span class="token operator">=</span> recv_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 plain0 和 cipher0 是我们获取的 AES 加密的明密文对，不包括之前和之后的两个异或。</p>
<h3 id="解密-flag"><a href="#解密-flag" class="headerlink" title="解密 flag"></a>解密 flag</h3><p>这一点，其实就是利用解密任意加密块的功能实现的，如下</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'the flag cipher is '</span> <span class="token operator">+</span> flag_cipher<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    flag_cipher <span class="token operator">=</span> split_by<span class="token punctuation">(</span>flag_cipher<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'decrypt the blocks one by one'</span><span class="token punctuation">)</span>
    plain <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>flag_cipher<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'block: '</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            plain <span class="token operator">+=</span> dec_block<span class="token punctuation">(</span>flag_cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> flag_cipher<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            iv <span class="token operator">=</span> plain<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            cipher <span class="token operator">=</span> xor<span class="token punctuation">(</span>xor<span class="token punctuation">(</span>iv<span class="token punctuation">,</span> flag_cipher<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag_cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            plain <span class="token operator">+=</span> dec_block<span class="token punctuation">(</span>iv<span class="token punctuation">,</span> cipher<span class="token punctuation">)</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'now plain: '</span> <span class="token operator">+</span> plain<span class="token punctuation">)</span>
    <span class="token keyword">print</span> plain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以思考一下为什么第二块之后的密文操作会有所不同。</p>
<p>完整的代码参考 ctf-challenge 仓库。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">分组加密模式</a></li>
<li><a href="https://en.wikipedia.org/wiki/Padding_oracle_attack" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Padding_oracle_attack</a></li>
<li><a href="http://netifera.com/research/poet/PaddingOraclesEverywhereEkoparty2010.pdf" target="_blank" rel="noopener">http://netifera.com/research/poet/PaddingOraclesEverywhereEkoparty2010.pdf</a></li>
<li><a href="https://ctftime.org/writeup/7975" target="_blank" rel="noopener">https://ctftime.org/writeup/7975</a></li>
<li><a href="https://ctftime.org/writeup/7974" target="_blank" rel="noopener">https://ctftime.org/writeup/7974</a></li>
</ul>
<h1 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h1><p>在非对称密码中，加密者与解密者所使用的密钥并不一样，典型的有 RSA 加密，背包加密，椭圆曲线加密。</p>
<h1 id="RSA-介绍"><a href="#RSA-介绍" class="headerlink" title="RSA 介绍"></a>RSA 介绍</h1><p>RSA 加密算法是一种非对称加密算法。在公开密钥加密和电子商业中 RSA 被广泛使用。RSA 是 1977 年由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）一起提出的。RSA 就是他们三人姓氏开头字母拼在一起组成的。</p>
<p>RSA 算法的可靠性由极大整数因数分解的难度决定。换言之，对一极大整数做因数分解愈困难，RSA 算法愈可靠。假如有人找到一种快速因数分解的算法的话，那么用 RSA 加密的信息的可靠性就肯定会极度下降。但找到这样的算法的可能性是非常小的。如今，只有短的 RSA 密钥才可能被强力方式解破。到 2017 年为止，还没有任何可靠的攻击 RSA 算法的方式。</p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><h3 id="公钥与私钥的产生"><a href="#公钥与私钥的产生" class="headerlink" title="公钥与私钥的产生"></a>公钥与私钥的产生</h3><ol>
<li>随机选择两个不同大质数 $p$ 和 $q$，计算 $N = p \times q$</li>
<li>根据欧拉函数，求得 $\varphi (N)=\varphi (p)\varphi (q)=(p-1)(q-1)$</li>
<li>选择一个小于 $\varphi (N)$ 的整数 $e$，使 $e$ 和 $\varphi (N)$ 互质。并求得 $e$ 关于 $\varphi (N)$ 的模反元素，命名为 $d$，有 $ed\equiv 1 \pmod {\varphi (N)}$</li>
<li>将 $p$ 和 $q$ 的记录销毁</li>
</ol>
<p>此时，$(N,e)$ 是公钥，$(N,d)$ 是私钥。</p>
<h3 id="消息加密"><a href="#消息加密" class="headerlink" title="消息加密"></a>消息加密</h3><p>首先需要将消息 以一个双方约定好的格式转化为一个小于 $N$，且与 $N$ 互质的整数 $m$。如果消息太长，可以将消息分为几段，这也就是我们所说的块加密，后对于每一部分利用如下公式加密：</p>
<p>$$<br>m^{e}\equiv c\pmod N<br>$$</p>
<h3 id="消息解密"><a href="#消息解密" class="headerlink" title="消息解密"></a>消息解密</h3><p>利用密钥 $d$ 进行解密。</p>
<p>$$<br>c^{d}\equiv m\pmod N<br>$$</p>
<h3 id="正确性证明"><a href="#正确性证明" class="headerlink" title="正确性证明"></a>正确性证明</h3><p>即我们要证$m^{ed} \equiv m \bmod N$，已知$ed \equiv 1 \bmod \phi(N)$，那么 $ed=k\phi(N)+1$，即需要证明</p>
<p>$$<br>m^{k\phi(N)+1}  \equiv m \bmod N<br>$$</p>
<p>这里我们分两种情况证明</p>
<p>第一种情况 $gcd(m,N)=1$，那么 $m^{\phi(N)} \equiv 1 \bmod N$，因此原式成立。</p>
<p>第二种情况 $gcd(m,N)\neq 1$，那么 $m$ 必然是 $p$ 或者 $q$ 的倍数，并且 $n=m$ 小于 $N$。我们假设</p>
<p>$$<br>m=xp<br>$$</p>
<p>那么 $x$ 必然小于 $q$，又由于 $q$ 是素数。那么</p>
<p>$$<br>m^{\phi(q)} \equiv 1 \bmod q<br>$$</p>
<p>进而</p>
<p>$$<br>m^{k\phi(N)}=m^{k(p-1)(q-1)}=(m^{\phi(q)})^{k(p-1)} \equiv 1 \bmod q<br>$$</p>
<p>那么</p>
<p>$$<br>m^{k\phi(N)+1}=m+uqm<br>$$</p>
<p>进而</p>
<p>$$<br>m^{k\phi(N)+1}=m+uqxp=m+uxN<br>$$</p>
<p>所以原式成立。</p>
<h2 id="基本工具"><a href="#基本工具" class="headerlink" title="基本工具"></a>基本工具</h2><h3 id="RSAtool"><a href="#RSAtool" class="headerlink" title="RSAtool"></a>RSAtool</h3><ul>
<li><p>安装</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/ius/rsatool.git
<span class="token function">cd</span> rsatool
python rsatool.py -h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>生成私钥</p>
<pre class="line-numbers language-bash"><code class="language-bash">python rsatool.py -f PEM -o private.pem -p 1234567 -q 7654321<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h3 id="RSA-Converter"><a href="#RSA-Converter" class="headerlink" title="RSA Converter"></a>RSA Converter</h3><ul>
<li>根据给定密钥对，生成 pem 文件</li>
<li>根据 $n$，$e$，$d$ 得出 $p$，$q$</li>
</ul>
<h3 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h3><ul>
<li><p>查看公钥文件</p>
<pre class="line-numbers language-shell"><code class="language-shell">openssl rsa -pubin -in pubkey.pem -text -modulus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>解密</p>
<pre class="line-numbers language-shell"><code class="language-shell">rsautl -decrypt -inkey private.pem -in flag.enc -out flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>更加具体的细节请参考 <code>openssl --help</code>。</p>
<h3 id="分解整数工具"><a href="#分解整数工具" class="headerlink" title="分解整数工具"></a>分解整数工具</h3><ul>
<li>网站分解，<a href="http://factordb.com/" target="_blank" rel="noopener">factor.db</a></li>
<li>命令行分解，<a href="https://github.com/ryosan-470/factordb-pycli" target="_blank" rel="noopener">factordb-pycli</a>，借用 factordb 数据库。</li>
<li><a href="https://sourceforge.net/projects/yafu/" target="_blank" rel="noopener">yafu</a></li>
</ul>
<h3 id="python-库"><a href="#python-库" class="headerlink" title="python 库"></a>python 库</h3><h4 id="primefac"><a href="#primefac" class="headerlink" title="primefac"></a>primefac</h4><p>整数分解库，包含了很多整数分解的算法。</p>
<h4 id="gmpy"><a href="#gmpy" class="headerlink" title="gmpy"></a>gmpy</h4><ul>
<li><code>gmpy.root(a, b)</code>，返回一个元组 <code>(x, y)</code>，其中 <code>x</code> 为 <code>a</code> 开 <code>b</code> 次方的值，<code>y</code> 是判断 <code>x</code> 是否为整数的布尔型变量</li>
</ul>
<h4 id="gmpy2"><a href="#gmpy2" class="headerlink" title="gmpy2"></a>gmpy2</h4><p>安装时，可能会需要自己另行安装 mpfr 与 mpc 库。</p>
<ul>
<li><code>gmpy2.iroot(a, b)</code>，类似于 <code>gmpy.root(a,b)</code></li>
</ul>
<h4 id="pycrypto"><a href="#pycrypto" class="headerlink" title="pycrypto"></a>pycrypto</h4><ul>
<li><p>安装</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> pip <span class="token function">install</span> pycrypto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5

msg <span class="token operator">=</span> <span class="token string">'crypto here'</span>
p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
q <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
n <span class="token operator">=</span> p<span class="token operator">*</span>q
e <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
pubkey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
privatekey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span>
enc <span class="token operator">=</span> key<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>privatekey<span class="token punctuation">)</span>
msg <span class="token operator">=</span> key<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>enc<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h2 id="Jarvis-OJ-Basic-veryeasyRSA"><a href="#Jarvis-OJ-Basic-veryeasyRSA" class="headerlink" title="Jarvis OJ - Basic - veryeasyRSA"></a>Jarvis OJ - Basic - veryeasyRSA</h2><blockquote>
<p>p = 3487583947589437589237958723892346254777 q = 8767867843568934765983476584376578389</p>
<p>e = 65537</p>
<p>求 d = </p>
<p>请提交 <code>PCTF{d}</code></p>
</blockquote>
<p>直接根据 $ed\equiv 1 \pmod{\varphi (N)}$，其中 $\varphi (N)=\varphi (p)\varphi (q)=(p-1)(q-1)$，可得 $d$。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
p <span class="token operator">=</span> <span class="token number">3487583947589437589237958723892346254777</span>
q <span class="token operator">=</span> <span class="token number">8767867843568934765983476584376578389</span>
e <span class="token operator">=</span> <span class="token number">65537</span>
phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell"><code class="language-shell">➜  Jarvis OJ-Basic-veryeasyRSA git:(master) ✗ python exp.py       
19178568796155560423675975774142829153827883709027717723363077606260717434369<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="2018-CodeGate-CTF-Rsababy"><a href="#2018-CodeGate-CTF-Rsababy" class="headerlink" title="2018 CodeGate CTF Rsababy"></a>2018 CodeGate CTF Rsababy</h2><p>程序就是一个简单的 RSA，不过程序还生成了两个奇怪的数</p>
<pre class="line-numbers language-python"><code class="language-python">e <span class="token operator">=</span> <span class="token number">65537</span>
n <span class="token operator">=</span> p <span class="token operator">*</span> q
pi_n <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> mulinv<span class="token punctuation">(</span>e<span class="token punctuation">,</span> pi_n<span class="token punctuation">)</span>
h <span class="token operator">=</span> <span class="token punctuation">(</span>d<span class="token operator">+</span>p<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span>d<span class="token operator">-</span>p<span class="token punctuation">)</span>
g <span class="token operator">=</span> d<span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token number">-0xdeadbeef</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以，问题应该出自这里，所以我们就从此下手，不放这里先假设 <code>const = 0xdeadbeef</code>。那么</p>
<p>$$<br>eg = ed * (p-const)<br>$$</p>
<p>进而，根据 RSA 可知</p>
<p>$$<br>2^{eg}=2^{ed * (p-const)}=2^{p-const} \pmod n<br>$$</p>
<p>$$<br>2^{p-const} * 2^{const-1} = 2^{p-1} \pmod n<br>$$</p>
<p>所以</p>
<p>$$<br>2^{p-1} = 2^{eg} * 2^{const-1}+kn<br>$$</p>
<p>而与此同时根据费马小定理，我们知道</p>
<p>$$<br>2^{p-1} \equiv 1 \pmod p<br>$$</p>
<p>所以</p>
<p>$$<br>p|2^{p-1}-1 | 2^{eg+const-1}-1+kn<br>$$</p>
<p>进而</p>
<p>$$<br>p|2^{eg+const-1}-1<br>$$</p>
<p>所以</p>
<p>$$<br>p|gcd(2^{eg+const-1}-1,n)<br>$$</p>
<p>因此，代码如下</p>
<pre class="line-numbers language-python"><code class="language-python">tmp <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>e<span class="token operator">*</span>g<span class="token operator">+</span>const<span class="token number">-1</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
p <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
q <span class="token operator">=</span> n<span class="token operator">/</span>p
phin <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span>gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span>phin<span class="token punctuation">)</span>
plain <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>data<span class="token punctuation">,</span>d<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2018-国家安全周-pure-math"><a href="#2018-国家安全周-pure-math" class="headerlink" title="2018 国家安全周 pure math"></a>2018 国家安全周 pure math</h2><p>题目的基本描述是这个样子的</p>
<pre><code>1) p ** p % q = 1137973316343089029387365135250835133803975869258714714790597743585251681751361684698632609164883988455302237641489036138661596754239799122081528662395492
2) q ** q % p = 6901383184477756324584651464895743132603115552606852729050186289748558760692261058141015199261946483809004373728135568483701274908717004197776113227815323
3) (p ** q + q ** p) % (p*q) = 16791287391494893024031688699360885996180880807427715700800644759680986120242383930558410147341340225420991368114858791447699399702390358184412301644459406
4) (p+q) ** (p+q) % (p*q) = 63112211860889153729003401381621068190906433969243079543438386686621389392583849748240273643614258173423474299387234175508649197780206757067354426424570586101908571600743792328163163458500138799976944702155779196849585083397395750018148652864158388247163109077215394538930498877175474225571393901460434679279
5) FLAG ** 31337 % (p*q) = 6931243291746179589612148118911670244427928875888377273917973305632621316868302667641610838193899081089153471883271406133321321416064760200919958612671379845738048938060512995550639898688604592620908415248701721672948126507753670027043162669545932921683579001870526727737212722417683610956855529996310258030
Now, what’s the FLAG???</code></pre><p>我们的目的基本上就是求得 FLAG，那么怎么做呢?这个题目需要我们具有较好的数论功底。</p>
<p>根据题目中这样的内容，我们可以假设 $p$，$q$ 都是大素数，那么</p>
<p>$p^{q-1} \equiv  1\bmod q$</p>
<p>那么</p>
<p>$p^{q} \equiv p \bmod pq$</p>
<p>那么我们可以根据 3）知道</p>
<p>$p^q+q^p \equiv p+q \bmod pq$</p>
<p>而 $p+q$ 又显然小于 $pq$，所以我们就知道 $p+q$ 的数值。</p>
<p>进一步，我们假设1），2），3），4），5）对应的值分别为 $x_1$, $x_2$, $x_3$, $x_4$, $x_5$ 则</p>
<p>根据4），我们可以知道</p>
<p>$(p+q)^{p+q} \equiv p^{p+q}+q^{p+q} \bmod pq$</p>
<p>又因为1）和 2），则</p>
<p>$p^pp \equiv px_1\bmod pq$</p>
<p>$q^qq \equiv qx_2 \bmod pq$</p>
<p>因此</p>
<p>$px_1+qx_2 \equiv x_4 \bmod pq$</p>
<p>根据 $x_1$ 和 $x_2$ 的求得方式，我们可以知道这里也是等号，因此我们得到了一个二元一次方程组，直接求解即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
x1 <span class="token operator">=</span> <span class="token number">1137973316343089029387365135250835133803975869258714714790597743585251681751361684698632609164883988455302237641489036138661596754239799122081528662395492</span>
x2 <span class="token operator">=</span> <span class="token number">6901383184477756324584651464895743132603115552606852729050186289748558760692261058141015199261946483809004373728135568483701274908717004197776113227815323</span>
p_q <span class="token operator">=</span> <span class="token number">16791287391494893024031688699360885996180880807427715700800644759680986120242383930558410147341340225420991368114858791447699399702390358184412301644459406</span>
x4 <span class="token operator">=</span> <span class="token number">63112211860889153729003401381621068190906433969243079543438386686621389392583849748240273643614258173423474299387234175508649197780206757067354426424570586101908571600743792328163163458500138799976944702155779196849585083397395750018148652864158388247163109077215394538930498877175474225571393901460434679279</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>x4 <span class="token operator">-</span> x1 <span class="token operator">*</span> p_q<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">'True'</span>
q <span class="token operator">=</span> <span class="token punctuation">(</span>x4 <span class="token operator">-</span> x1 <span class="token operator">*</span> p_q<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span>
<span class="token keyword">print</span> q
p <span class="token operator">=</span> p_q <span class="token operator">-</span> q

c <span class="token operator">=</span> <span class="token number">6931243291746179589612148118911670244427928875888377273917973305632621316868302667641610838193899081089153471883271406133321321416064760200919958612671379845738048938060512995550639898688604592620908415248701721672948126507753670027043162669545932921683579001870526727737212722417683610956855529996310258030</span>

phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span><span class="token number">31337</span><span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
flag <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> p <span class="token operator">*</span> q<span class="token punctuation">)</span>
flag <span class="token operator">=</span> hex<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> flag<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>flag  如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-国家安全周第一场-puremath git:(master) ✗ python exp.py
True
7635093784603905632817000902311635311970645531806863592697496927519352405158721310359124595712780726701027634372170535318453656286180828724079479352052417
flag{6a66b8d5-6047-4299-a48e-4c4d1f874d12}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2018-Pwnhub-LHY"><a href="#2018-Pwnhub-LHY" class="headerlink" title="2018 Pwnhub LHY"></a>2018 Pwnhub LHY</h2><p>首先分析这段代码</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">assert</span> gmpy<span class="token punctuation">.</span>is_prime<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2016</span> <span class="token operator">+</span> gmpy<span class="token punctuation">.</span>is_prime<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2017</span> <span class="token operator">+</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> x <span class="token operator">*</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2018</span> <span class="token operator">==</span> <span class="token number">30097557298197417800049182668952226601954645169633891463401117760245367082644152355564014438095421962150109895432272944128252155287648477680131934943095113263121691874508742328500559321036238322775864636883202538152031804102118831278605474474352011895348919417742923873371980983336517409056008233804190890418285814476821890492630167665485823056526646050928460488168341721716361299816947722947465808004305806687049198633489997459201469227952552870291934919760829984421958853221330987033580524592596407485826446284220272614663464267135596497185086055090126893989371261962903295313304735911034185619611156742146</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>由于 <code>gmpy.is_prime</code> 要么返回1，要么返回 0，所以我们可以很容易地试出来 <code>y</code> 是素数，<code>x+1</code> 也是素数，并且</p>
<p>$(x^2-1)^2\equiv 0 \bmod (2xy-1)$</p>
<p>为了式子能够整除，猜测 $x=2y$ 。</p>
<p>于是，对于下面的内容</p>
<pre class="line-numbers language-python"><code class="language-python">p <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token operator">+</span> y<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span>
q <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">*</span> y <span class="token operator">+</span> y<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">*</span> x<span class="token punctuation">)</span>
n <span class="token operator">=</span> p <span class="token operator">*</span> q
phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span><span class="token number">0x10001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
enc <span class="token operator">=</span> pow<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10001</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'n ='</span><span class="token punctuation">,</span> n
<span class="token keyword">print</span> <span class="token string">'enc ='</span><span class="token punctuation">,</span> enc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>$p$ 和 $q$ 自然为</p>
<p>$p=next_prime(9y^3)$</p>
<p>$q=next_prime(6y^3)$</p>
<p>根据素数的间隔，可以知道 $p$ 和 $q$ 最多比括号里的数字大一点，这里一般不会超过 $1000$。</p>
<p>那么</p>
<p>$n \geq 54y^6$</p>
<p>所以我们知道了 $y$ 的上界，而对于 $y$ 的下界其实也不会离上界太远，我们大概减个几十万。进而，我们利用二分查找的方式来寻找 $p$ 和 $q$，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
tmp <span class="token operator">=</span> <span class="token number">30097557298197417800049182668952226601954645169633891463401117760245367082644152355564014438095421962150109895432272944128252155287648477680131934943095113263121691874508742328500559321036238322775864636883202538152031804102118831278605474474352011895348919417742923873371980983336517409056008233804190890418285814476821890492630167665485823056526646050928460488168341721716361299816947722947465808004305806687049198633489997459201469227952552870291934919760829984421958853221330987033580524592596407485826446284220272614663464267135596497185086055090126893989371261962903295313304735911034185619611156742146</span>

<span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>tmp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>tmp <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">)</span>

n <span class="token operator">=</span> <span class="token number">260272753019642842691231717156206014402348296256668058656902033827190888150939144319270903947159599144884859205368557385941127216969379550487700198771513118894125094678559478972591331182960004648132846372455712958337042783083099376871113795475285658106058675217077803768944674144803250791799957440111855021945690877200606577646234107957498370758707097662736662439460472126493593605957225541979181422479704018055731221681621886820626215670393536343427267329350730257979042198593215747542270975288047196483958369426727778580292311145109908665004662296440533724591193527886702374790526322791818523938910660223971454070731594803459613066617828657725704376475527288174777197739360634209448477565044519733575375490101670974499385760735451471034271880800081246883157088501597655371430353965493264345172541221268942926210055390568364981514774743693528424196241142665685211916330254113610598390909248626686397970038848966187547231199741</span>

y <span class="token operator">=</span> 191904757378974300059526915134037747982760255307942501070454569331878491189601823952845623286161325306079772871025816081849039036850918375408172174102720702781463514549851887084613000000L
y <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>y<span class="token punctuation">)</span>

enc <span class="token operator">=</span> <span class="token number">73933313646416156737449236838459526871566017180178176765840447023088664788672323530940171469589918772272559607026808711216932468486201094786991159096267208480969757088208089800600731106685561375522764783335332964711981392251568543122418192877756299395774738176188452197889668610818741062203831272066261677731889616150485770623945568369493256759711422067551058418926344060504112146971937651406886327429318390247733970549845424064244469193626197360072341969574784310397213033860597822010667926563087858301337091484951760613299203587677078666096526093414014637559237148644939541419075479462431789925219269815364529507771308181435591670281081465439913711912925412078002618729159141400730636976744132429329651487292506365655834202469178066850282850374067239317928012461993443785247524500680257923687511378073703423047348824611101206633407452837948194591695712958510124436821151767823443033286425729473563002691262316964646014201612</span>

end <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>n <span class="token operator">/</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
beg <span class="token operator">=</span> end <span class="token operator">-</span> <span class="token number">2000000</span>

mid <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">while</span> beg <span class="token operator">&lt;</span> end<span class="token punctuation">:</span>
    mid <span class="token operator">=</span> <span class="token punctuation">(</span>beg <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token keyword">if</span> gmpy2<span class="token punctuation">.</span>is_prime<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        mid <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
    p <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">*</span> mid<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> mid<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span>
    n1 <span class="token operator">=</span> p <span class="token operator">*</span> q
    <span class="token keyword">if</span> n1 <span class="token operator">==</span> n<span class="token punctuation">:</span>
        <span class="token keyword">print</span> p<span class="token punctuation">,</span> q
        phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span><span class="token number">0x10001</span><span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
        m <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>enc<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
        <span class="token keyword">print</span> hex<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'ok'</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> n1 <span class="token operator">&lt;</span> n<span class="token punctuation">:</span>
        beg <span class="token operator">=</span> mid
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        end <span class="token operator">=</span> mid
    <span class="token keyword">print</span> beg<span class="token punctuation">,</span> end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="模数相关攻击"><a href="#模数相关攻击" class="headerlink" title="模数相关攻击"></a>模数相关攻击</h1><h2 id="暴力分解-N"><a href="#暴力分解-N" class="headerlink" title="暴力分解 N"></a>暴力分解 N</h2><h3 id="攻击条件"><a href="#攻击条件" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>在 N 的比特位数小于 512 的时候，可以采用大整数分解的策略获取 p 和 q。</p>
<h3 id="JarvisOJ-Easy-RSA"><a href="#JarvisOJ-Easy-RSA" class="headerlink" title="JarvisOJ - Easy RSA"></a>JarvisOJ - Easy RSA</h3><p>这里我们以 “JarvisOJ - Easy RSA” 为例进行介绍，题目如下</p>
<blockquote>
<p>还记得 veryeasy RSA 吗？是不是不难？那继续来看看这题吧，这题也不难。<br>已知一段 RSA 加密的信息为：0xdc2eeeb2782c 且已知加密所用的公钥：<br>N=322831561921859 e = 23<br>请解密出明文，提交时请将数字转化为 ascii 码提交<br>比如你解出的明文是 0x6162，那么请提交字符串 ab<br>提交格式：<code>PCTF{明文字符串}</code></p>
</blockquote>
<p>可以看出，我们的 N 比较小，这里我们直接使用 factordb 进行分解，可以得到</p>
<p>$$<br>322831561921859 = 13574881 \times 23781539<br>$$</p>
<p>进而我们简单编写程序如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
p <span class="token operator">=</span> <span class="token number">13574881</span>
q <span class="token operator">=</span> <span class="token number">23781539</span>
n <span class="token operator">=</span> p <span class="token operator">*</span> q
e <span class="token operator">=</span> <span class="token number">23</span>
c <span class="token operator">=</span> <span class="token number">0xdc2eeeb2782c</span>
phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
p <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
tmp <span class="token operator">=</span> hex<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token keyword">print</span> tmp<span class="token punctuation">,</span> tmp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  Jarvis OJ-Basic-easyRSA git:(master) ✗ python exp.py
0x33613559 3a5Y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="p-amp-q-不当分解-N"><a href="#p-amp-q-不当分解-N" class="headerlink" title="p &amp; q 不当分解 N"></a>p &amp; q 不当分解 N</h2><h3 id="攻击条件-1"><a href="#攻击条件-1" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>当 RSA 中 p 和 q 选取不当时，我们也可以进行攻击。</p>
<h3 id="p-q-很大"><a href="#p-q-很大" class="headerlink" title="|p-q| 很大"></a>|p-q| 很大</h3><p>当 p-q 很大时，一定存在某一个参数较小，这里我们假设为 p，那么我们可以通过穷举的方法对模数进行试除，从而分解模数，得到保密参数与明文信息。基本来说，不怎么可行。</p>
<h3 id="p-q-较小"><a href="#p-q-较小" class="headerlink" title="|p-q| 较小"></a>|p-q| 较小</h3><p>首先</p>
<p>$$<br>\frac{(p+q)^2}{4}-n=\frac{(p+q)^2}{4}-pq=\frac{(p-q)^2}{4}<br>$$</p>
<p>既然 |p-q| 较小，那么 $\frac{(p-q)^2}{4}$ 自然也比较小，进而 $\frac{(p+q)^2}{4}$ 只是比 N 稍微大一点，所以 $\frac{p+q}{2}$ 与 $\sqrt{n}$ 相近。那么我们可以按照如下方法来分解</p>
<ul>
<li>顺序检查 $\sqrt{n}$ 的每一个整数 x，直到找到一个 x 使得 $x^2-n$ 是平方数，记为 $y^2$</li>
<li>那么 $x^2-n=y^2$，进而根据平方差公式即可分解 N</li>
</ul>
<h3 id="p-1-光滑"><a href="#p-1-光滑" class="headerlink" title="p - 1 光滑"></a>p - 1 光滑</h3><ul>
<li><p>光滑数(Smooth number)：指可以分解为小素数乘积的正整数</p>
</li>
<li><p>当$p$是$N$的因数，并且$p-1$是光滑数，可以考虑使用<code>Pollard's p-1</code>算法来分解$N$</p>
</li>
<li><p>根据费马小定理有</p>
<p>  $$若p\nmid a,\ 则a^{p-1}\equiv 1\pmod{p}$$</p>
<p>  则有</p>
<p>  $$a^{t(p-1)}\equiv 1^t \equiv 1\pmod{p}$$</p>
<p>  即</p>
<p>  $$a^{t(p-1)} - 1 = k*p$$</p>
</li>
<li><p>根据<code>Pollard's p-1</code>算法：</p>
<p>  如果$p$是一个$B-smooth\ number$，那么则存在</p>
<p>  $$M = \prod_{q\le{B}}{q^{\lfloor\log_q{B}\rfloor}}$$</p>
<p>  使得</p>
<p>  $$(p-1)\mid M$$</p>
<p>  成立，则有</p>
<p>  $$\gcd{(a^{M}-1, N)}$$</p>
<p>  如果结果不为$1$或$N$，那么就已成功分解$N$。</p>
<p>  因为我们只关心最后的gcd结果，同时<code>N</code>只包含两个素因子，则我们不需要计算$M$，考虑$n=2,3,\dots$，令$M = n!$即可覆盖正确的$M$同时方便计算。</p>
</li>
<li><p>在具体计算中，可以代入降幂进行计算</p>
<p>  $$<br>  a^{n!}\bmod{N}=\begin{cases}<br>  (a\bmod{N})^2\mod{N}&amp;n=2\<br>  (a^{(n-1)!}\bmod{N})^n\mod{N}&amp;n\ge{3}<br>  \end{cases}<br>  $$</p>
</li>
<li><p>Python代码实现</p>
<pre class="line-numbers language-python"><code class="language-python">  <span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> <span class="token operator">*</span>
  a <span class="token operator">=</span> <span class="token number">2</span>
  n <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
      a <span class="token operator">=</span> powmod<span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
      res <span class="token operator">=</span> gcd<span class="token punctuation">(</span>a<span class="token number">-1</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
      <span class="token keyword">if</span> res <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">and</span> res <span class="token operator">!=</span> N<span class="token punctuation">:</span>
          q <span class="token operator">=</span> n <span class="token operator">//</span> res
          d <span class="token operator">=</span> invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span>res<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          m <span class="token operator">=</span> powmod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
      n <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="p-1-光滑-1"><a href="#p-1-光滑-1" class="headerlink" title="p + 1 光滑"></a>p + 1 光滑</h3><ul>
<li><p>当$p$是$N$的因数，并且$p+1$是光滑数，可以考虑使用<code>Williams's p+1</code>算法来分解$N$</p>
</li>
<li><p>已知$N$的因数$p$，且$p+1$是一个光滑数</p>
<p>  $$<br>  p = \left(\prod_{i=1}^k{q_i^{\alpha_i}}\right)+1<br>  $$</p>
<p>  $q_i$即第$i$个素因数且有$q_i^{\alpha_i}\le B_1$, 找到$\beta_i$使得让$q_i^{\beta_i}\le B_1$且$q_i^{\beta_i+1}&gt; B_1$，然后令</p>
<p>  $$<br>  R = \prod_{i=1}^k{q_i^{\beta_i}}<br>  $$</p>
<p>  显然有$p-1\mid R$且当$(N, a) = 1$时有$a^{p-1}\equiv 1 \pmod{p}$，所以有$a^R\equiv 1\pmod{p}$，即</p>
<p>  $$<br>  p\mid(N, a^R-1)<br>  $$</p>
</li>
<li><p>令$P,Q$为整数，$\alpha,\beta$为方程$x^2-Px+Q=0$的根，定义如下类卢卡斯序列</p>
<p>  $$<br>  \begin{aligned}<br>  U_n(P, Q) &amp;= (\alpha^n -\beta^n)/(\alpha - \beta)\<br>  V_n(P, Q) &amp;= \alpha^n + \beta^n<br>  \end{aligned}<br>  $$</p>
<p>  同样有$\Delta = (\alpha - \beta)^2 = P^2-4Q$，则有</p>
<p>  $$<br>  \begin{cases}<br>  U_{n+1} &amp;= PU_n - QU_{n-1}\<br>  V_{n+1} &amp;= PV_n - QV_{n-1}<br>  \end{cases}\tag{2.2}<br>  $$</p>
<p>  $$<br>  \begin{cases}<br>  U_{2n} &amp;= V_nU_n\<br>  V_{2n} &amp;= V_n^2 - 2Q^n<br>  \end{cases}\tag{2.3}<br>  $$</p>
<p>  $$<br>  \begin{cases}<br>  U_{2n-1} &amp;= U_n^2 - QU_{n-1}^2\<br>  V_{2n-1} &amp;= V_nV_{n-1} - PQ^{n-1}<br>  \end{cases}\tag{2.4}<br>  $$</p>
<p>  $$<br>  \begin{cases}<br>  \Delta U_{n} &amp;= PV_n - 2QV_{n-1}\<br>  V_{n} &amp;= PU_n - 2QU_{n-1}<br>  \end{cases}\tag{2.5}<br>  $$</p>
<p>  $$<br>  \begin{cases}<br>  U_{m+n} &amp;= U_mU_{n+1} - QU_{m-1}U_n\<br>  \Delta U_{m+n} &amp;= V_mV_{n+1} - QV_{m-1}V_n<br>  \end{cases}\tag{2.6}<br>  $$</p>
<p>  $$<br>  \begin{cases}<br>  U_{n}(V_k(P, Q), Q^k) &amp;= U_{nk}(P, Q)/U_k(P, Q)\<br>  V_{n}(V_k(P, Q), Q^k) &amp;= V_n(P, Q)<br>  \end{cases}\tag{2.7}<br>  $$</p>
<p>  同时我们有如果$(N, Q) = 1$且$P^{‘}Q\equiv P^2-2Q\pmod{N}$，则有$P^{‘}\equiv \alpha/\beta + \beta/\alpha$以及$Q^{‘}\equiv \alpha/\beta + \beta/\alpha = 1$，即</p>
<p>  $$<br>  U_{2m}(P, Q)\equiv PQ^{m-1}U_m(P^{‘}, 1)\pmod{N}\tag{2.8}<br>  $$</p>
<p>  根据扩展卢卡斯定理</p>
<blockquote>
<p>如果p是奇素数，$p\nmid Q$且勒让德符号$(\Delta/p) = \epsilon$，则</p>
</blockquote>
<p>  $$<br>  \begin{aligned}<br>  U_{(p-\epsilon)m}(P, Q) &amp;\equiv 0\pmod{p}\<br>  V_{(p-\epsilon)m}(P, Q) &amp;\equiv 2Q^{m(1-\epsilon)/2}\pmod{p}<br>  \end{aligned}<br>  $$</p>
</li>
<li><p><code>第一种情况</code>：已知N的因数p，且p+1是一个光滑数</p>
<p>  $$<br>  p = \left(\prod_{i=1}^k{q_i^{\alpha_i}}\right)-1<br>  $$</p>
<p>  有$p+1\mid R$，当$(Q, N)=1$且$(\Delta/p) = -1$时有$p\mid U_R(P, Q)$，即$p\mid (U_R(P, Q), N)$</p>
<p>  为了找到$U_R(P, Q)$，<code>Guy</code>和<code>Conway</code>提出可以使用如下公式</p>
<p>  $$<br>  \begin{aligned}<br>  U_{2n-1} &amp;= U_n^2 - QU_n^2 - 1\<br>  U_{2n} &amp;= U_n(PU_n - 2QU_{n-1})\<br>  U_{2n+1} &amp;= PU_{2n} - QU_{2n-1}<br>  \end{aligned}<br>  $$</p>
<p>  但是上述公式值太大了，不便运算，我们可以考虑如下方法</p>
<p>  如果$p \mid U_R(P, 1)$，根据<code>公式2.3</code>有$p\mid U_{2R}(P, Q)$，所以根据<code>公式2.8</code>有$p \mid U_R(P^{‘}, 1)$，设$Q=1$，则有</p>
<p>  $$<br>  V_{(p-\epsilon)m}(P, 1) \equiv 2\pmod{p}<br>  $$</p>
<p>  即，如果$p\mid U_R(P, 1)$，则$p\mid(V_R(P, 1) -2)$.</p>
<p>  第一种情况可以归纳为：</p>
<p>  让$R = r_1r_2r_3\cdots r_m$，同时找到$P_0$使得$(P_0^2-4, N) = 1$，定义$V_n(P) = V_n(P, 1), U_n(P) = U_n(P, 1)$且</p>
<p>  $$<br>  P_j \equiv V_{r_j}(P_{j-1})\pmod{N}(j = 1,2,3,\dots,m)<br>  $$</p>
<p>  根据<code>公式2.7</code>，有</p>
<p>  $$<br>  P_m \equiv V_R(P_0)\pmod{N}\tag{3.1}<br>  $$</p>
<p>  要计算$V_r = V_r(P)$可以用如下公式</p>
<p>  根据<code>公式2.2</code>，<code>公式2.3</code>，<code>公式2.4</code>有</p>
<p>  $$<br>  \begin{cases}<br>  V_{2f-1}&amp;\equiv V_fV_{f-1}-P\<br>  V_{2f}&amp;\equiv V_f^2 - 2\<br>  V_{2f+1}&amp;\equiv PV_f^2-V_fV_{f-1}-P\pmod(N)<br>  \end{cases}<br>  $$</p>
<p>  令</p>
<p>  $$<br>  r = \sum_{i=0}^t{b_t2^{t-i}}\ \ \ \ (b_i=0,1)<br>  $$</p>
<p>  $f_0=1, f_{k+1}=2f_k+b_{k+1}$，则$f_t=r$，同样$V_0(P) = 2, V_1(P) = P$，则最终公式为</p>
<p>  $$<br>  (V_{f_{k+1}}, V_{f_{k+1}-1}) = \begin{cases}<br>  (V_{2f_k}, V_{2f_k-1})\ \ \ \ if\ b_{k+1}=0\<br>  (V_{2f_k+1}, V_{2f_k})\ \ \ \ if\ b_{k+1}=1<br>  \end{cases}<br>  $$</p>
</li>
<li><p><code>第二种情况</code>：已知p+1是一个光滑数</p>
<p>  $$<br>  p = s\left(\prod_{i=1}^k{q_i^{\alpha_i}}\right)-1<br>  $$</p>
<p>  当$s$是素数，且$B_1&lt;s\le B_2$，有$p\mid(a_m^s-1, N)，$定义$s_j$和$2d_j$</p>
<p>  $$<br>  2d_j = s_j+1-s_j<br>  $$</p>
<p>  如果$(\Delta/p) = -1$且$p\nmid P_m-2$，则根据<code>公式2.7</code>和<code>公式3.1</code>有$p\mid(U_s(P_m), N)$。</p>
<p>  令$U[n] \equiv U_n(P_m), V[n]\equiv V_n(P_m)\pmod{N}$，计算$U[2d_j-1], U[2d_j], U[2d_j+1]$通过</p>
<p>  $$U[0] = 0, U[1] = 1, U[n+1] = P_mU[n] - U[n-1]$$</p>
<p>  计算</p>
<p>  $$<br>  T[s_i] \equiv \Delta U_{s_i}(P_m) = \Delta U_{s_iR}(P_0)/U_R(P_0)\pmod{N}<br>  $$</p>
<p>  通过<code>公式2.6</code>，<code>公式2.7</code>和<code>公式3.1</code>有</p>
<p>  $$<br>  \begin{cases}<br>  T[s_1]&amp;\equiv P_mV[s_1]-2V[s_1-1]\<br>  T[s_1-1]&amp;\equiv 2V[s_1]-P_mV[s_1-1]\pmod{N}<br>  \end{cases}<br>  $$</p>
<p>  即</p>
<p>  $$<br>  \begin{cases}<br>  T[s_{i+1}]&amp;\equiv T[s_i]U[2d_i+1]-T[s_i-1]U[2d_i]\<br>  T[s_{i+1}-1]&amp;\equiv T[s_i]U[2d_i]-T[s_i-1]U[2d_i-1]\pmod{N}<br>  \end{cases}<br>  $$</p>
<p>  计算$T[s_i], i=1,2,3\dots$，然后计算</p>
<p>  $$<br>  H_t = (\prod_{i=0}^c{T[s_{i+t}], N})<br>  $$</p>
<p>  其中$t = 1, c+1, 2c+1, \dots, c[B_2/c]+1$，我们有$p\mid H_i$当$(\Delta/p)=-1$</p>
</li>
<li><p>python代码实现</p>
<pre class="line-numbers language-python"><code class="language-python">  <span class="token keyword">def</span> <span class="token function">mlucas</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">""" Helper function for williams_pp1().  Multiplies along a Lucas sequence modulo n. """</span>
      v1<span class="token punctuation">,</span> v2 <span class="token operator">=</span> v<span class="token punctuation">,</span> <span class="token punctuation">(</span>v<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> n
      <span class="token keyword">for</span> bit <span class="token keyword">in</span> bin<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span> v1<span class="token punctuation">,</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v1<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token punctuation">,</span> <span class="token punctuation">(</span>v1<span class="token operator">*</span>v2 <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token punctuation">)</span> <span class="token keyword">if</span> bit <span class="token operator">==</span> <span class="token string">"0"</span> <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v1<span class="token operator">*</span>v2 <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token punctuation">,</span> <span class="token punctuation">(</span>v2<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>
      <span class="token keyword">return</span> v1

  <span class="token keyword">for</span> v <span class="token keyword">in</span> count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">for</span> p <span class="token keyword">in</span> primegen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
          e <span class="token operator">=</span> ilog<span class="token punctuation">(</span>isqrt<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
          <span class="token keyword">if</span> e <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">break</span>
          <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span> v <span class="token operator">=</span> mlucas<span class="token punctuation">(</span>v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
          g <span class="token operator">=</span> gcd<span class="token punctuation">(</span>v<span class="token number">-2</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token number">1</span> <span class="token operator">&lt;</span> g <span class="token operator">&lt;</span> n<span class="token punctuation">:</span> <span class="token keyword">return</span> g <span class="token comment" spellcheck="true"># g|n</span>
          <span class="token keyword">if</span> g <span class="token operator">==</span> n<span class="token punctuation">:</span> <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="2017-SECCON-very-smooth"><a href="#2017-SECCON-very-smooth" class="headerlink" title="2017 SECCON very smooth"></a>2017 SECCON very smooth</h3><p>该程序给了一个 HTTPS 加密的流量包，首先从其中拿到证书</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2017_SECCON_verysmooth git:(master) binwalk -e s.pcap      

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
2292          0x8F4           Certificate in DER format (x509 v3), header length: 4, sequence length: 467
4038          0xFC6           Certificate in DER format (x509 v3), header length: 4, sequence length: 467
5541          0x15A5          Certificate in DER format (x509 v3), header length: 4, sequence length: 467

➜  2017_SECCON_verysmooth git:(master) ls
s.pcap  _s.pcap.extracted  very_smooth.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里分别查看三个证书，三个模数都一样，这里只给一个例子</p>
<pre><code>➜  _s.pcap.extracted git:(master) openssl x509 -inform DER -in FC6.crt  -pubkey -text -modulus -noout 
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDVRqqCXPYd6Xdl9GT7/kiJrYvy
8lohddAsi28qwMXCe2cDWuwZKzdB3R9NEnUxsHqwEuuGJBwJwIFJnmnvWurHjcYj
DUddp+4X8C9jtvCaLTgd+baSjo2eB0f+uiSL/9/4nN+vR3FliRm2mByeFCjppTQl
yioxCqbXYIMxGO4NcQIDAQAB
-----END PUBLIC KEY-----
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number: 11640506567126718943 (0xa18b630c7b3099df)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=JP, ST=Kawasaki, O=SRL
        Validity
            Not Before: Oct  8 02:47:17 2017 GMT
            Not After : Oct  8 02:47:17 2018 GMT
        Subject: C=JP, ST=Kawasaki, O=SRL
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (1024 bit)
                Modulus:
                    00:d5:46:aa:82:5c:f6:1d:e9:77:65:f4:64:fb:fe:
                    48:89:ad:8b:f2:f2:5a:21:75:d0:2c:8b:6f:2a:c0:
                    c5:c2:7b:67:03:5a:ec:19:2b:37:41:dd:1f:4d:12:
                    75:31:b0:7a:b0:12:eb:86:24:1c:09:c0:81:49:9e:
                    69:ef:5a:ea:c7:8d:c6:23:0d:47:5d:a7:ee:17:f0:
                    2f:63:b6:f0:9a:2d:38:1d:f9:b6:92:8e:8d:9e:07:
                    47:fe:ba:24:8b:ff:df:f8:9c:df:af:47:71:65:89:
                    19:b6:98:1c:9e:14:28:e9:a5:34:25:ca:2a:31:0a:
                    a6:d7:60:83:31:18:ee:0d:71
                Exponent: 65537 (0x10001)
    Signature Algorithm: sha256WithRSAEncryption
         78:92:11:fb:6c:e1:7a:f7:2a:33:b8:8b:08:a7:f7:5b:de:cf:
         62:0b:a0:ed:be:d0:69:88:38:93:94:9d:05:41:73:bd:7e:b3:
         32:ec:8e:10:bc:3a:62:b0:56:c7:c1:3f:60:66:a7:be:b9:46:
         f7:46:22:6a:f3:5a:25:d5:66:94:57:0e:fc:b5:16:33:05:1c:
         6f:f5:85:74:57:a4:a0:c6:ce:4f:fd:64:53:94:a9:83:b8:96:
         bf:5b:a7:ee:8b:1e:48:a7:d2:43:06:0e:4f:5a:86:62:69:05:
         e2:c0:bd:4e:89:c9:af:04:4a:77:a2:34:86:6a:b8:d2:3b:32:
         b7:39
Modulus=D546AA825CF61DE97765F464FBFE4889AD8BF2F25A2175D02C8B6F2AC0C5C27B67035AEC192B3741DD1F4D127531B07AB012EB86241C09C081499E69EF5AEAC78DC6230D475DA7EE17F02F63B6F09A2D381DF9B6928E8D9E0747FEBA248BFFDFF89CDFAF4771658919B6981C9E1428E9A53425CA2A310AA6D760833118EE0D71</code></pre><p>可以看出模数只有 1024 比特。而且，根据题目名 very smooth，应该是其中一个因子比较 smooth，这里我们利用 primefac 分别尝试 Pollard’s p − 1 与 Williams’s p + 1 算法，如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  _s.pcap.extracted git:(master) python -m primefac -vs -m=p+1  149767527975084886970446073530848114556615616489502613024958495602726912268566044330103850191720149622479290535294679429142532379851252608925587476670908668848275349192719279981470382501117310509432417895412013324758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897

149767527975084886970446073530848114556615616489502613024958495602726912268566044330103850191720149622479290535294679429142532379851252608925587476670908668848275349192719279981470382501117310509432417895412013324758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897: p+1 11807485231629132025602991324007150366908229752508016230400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001 12684117323636134264468162714319298445454220244413621344524758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897
Z309  =  P155 x P155  =  11807485231629132025602991324007150366908229752508016230400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001 x 12684117323636134264468162714319298445454220244413621344524758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现当使用 Williams’s <em>p</em> + 1 算法时，就直接分解出来了。按道理这个因子是 p-1 似乎更光滑，但是却并不能使用 Pollard’s p − 1 算法分解，这里进行进一步的测试</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  _s.pcap.extracted git:(master) python -m primefac -vs 1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002

1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002: 2 7 43 503 761429 5121103123294685745276806480148867612214394022184063853387799606010231770631857868979139305712805242051823263337587909550709296150544706624823
Z154  =  P1 x P1 x P2 x P3 x P6 x P142  =  2 x 7 x 43 x 503 x 761429 x 5121103123294685745276806480148867612214394022184063853387799606010231770631857868979139305712805242051823263337587909550709296150544706624823

➜  _s.pcap.extracted git:(master) python -m primefac -vs 1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 

1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000: 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5
Z154  =  P1^185 x P1^62 x P1^97  =  2^185 x 3^62 x 5^97<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，对于 p-1 确实有很多小因子，但是个数太多，这就会使得进行枚举的时候出现指数爆炸的情况，因此没有分解出来。</p>
<p>进而根据分解出来的数构造私钥</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">import</span> gmpy2


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> 149767527975084886970446073530848114556615616489502613024958495602726912268566044330103850191720149622479290535294679429142532379851252608925587476670908668848275349192719279981470382501117310509432417895412013324758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897L
    p <span class="token operator">=</span> 11807485231629132025602991324007150366908229752508016230400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001L
    q <span class="token operator">=</span> 12684117323636134264468162714319298445454220244413621344524758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897L
    e <span class="token operator">=</span> 65537L
    priv <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> long<span class="token punctuation">(</span>gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    open<span class="token punctuation">(</span><span class="token string">'private.pem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>priv<span class="token punctuation">.</span>exportKey<span class="token punctuation">(</span><span class="token string">'PEM'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，将私钥导入到 wireshark 中即可得到明文（Edit -&gt; Preferences -&gt; Protocols -&gt; SSL -&gt; RSA Key List）。</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Very smooth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>
Answer: One of these primes is very smooth.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>关于更多的一些分解模数 N 的方法可以参考 <a href="https://en.wikipedia.org/wiki/Integer_factorization。" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Integer_factorization。</a></p>
<h2 id="模不互素"><a href="#模不互素" class="headerlink" title="模不互素"></a>模不互素</h2><h3 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>当存在两个公钥的 N 不互素时，我们显然可以直接对这两个数求最大公因数，然后直接获得 p，q，进而获得相应的私钥。</p>
<h3 id="SCTF-RSA2"><a href="#SCTF-RSA2" class="headerlink" title="SCTF RSA2"></a>SCTF RSA2</h3><p>这里我们以 SCTF rsa2 为例进行介绍。直接打开 pcap 包，发现有一堆的消息，包含 N 和 e，然后试了试不同的 N 是否互素，我试了前两个</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
n1 <span class="token operator">=</span> <span class="token number">20823369114556260762913588844471869725762985812215987993867783630051420241057912385055482788016327978468318067078233844052599750813155644341123314882762057524098732961382833215291266591824632392867716174967906544356144072051132659339140155889569810885013851467056048003672165059640408394953573072431523556848077958005971533618912219793914524077919058591586451716113637770245067687598931071827344740936982776112986104051191922613616045102859044234789636058568396611030966639561922036712001911238552391625658741659644888069244729729297927279384318252191421446283531524990762609975988147922688946591302181753813360518031</span>
n2 <span class="token operator">=</span> <span class="token number">19083821613736429958432024980074405375408953269276839696319265596855426189256865650651460460079819368923576109723079906759410116999053050999183058013281152153221170931725172009360565530214701693693990313074253430870625982998637645030077199119183041314493288940590060575521928665131467548955951797198132001987298869492894105525970519287000775477095816742582753228905458466705932162641076343490086247969277673809512472546919489077884464190676638450684714880196854445469562733561723325588433285405495368807600668761929378526978417102735864613562148766250350460118131749533517869691858933617013731291337496943174343464943</span>
<span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果发现竟然不互素。</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  scaf-rsa2 git:(master) ✗ python exp.py
122281872221091773923842091258531471948886120336284482555605167683829690073110898673260712865021244633908982705290201598907538975692920305239961645109897081011524485706755794882283892011824006117276162119331970728229108731696164377808170099285659797066904706924125871571157672409051718751812724929680249712137<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>那么我们就可以直接来解密了，这里我们利用第一对公钥密码。代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5<span class="token punctuation">,</span> PKCS1_OAEP
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64decode
n1 <span class="token operator">=</span> <span class="token number">20823369114556260762913588844471869725762985812215987993867783630051420241057912385055482788016327978468318067078233844052599750813155644341123314882762057524098732961382833215291266591824632392867716174967906544356144072051132659339140155889569810885013851467056048003672165059640408394953573072431523556848077958005971533618912219793914524077919058591586451716113637770245067687598931071827344740936982776112986104051191922613616045102859044234789636058568396611030966639561922036712001911238552391625658741659644888069244729729297927279384318252191421446283531524990762609975988147922688946591302181753813360518031</span>
n2 <span class="token operator">=</span> <span class="token number">19083821613736429958432024980074405375408953269276839696319265596855426189256865650651460460079819368923576109723079906759410116999053050999183058013281152153221170931725172009360565530214701693693990313074253430870625982998637645030077199119183041314493288940590060575521928665131467548955951797198132001987298869492894105525970519287000775477095816742582753228905458466705932162641076343490086247969277673809512472546919489077884464190676638450684714880196854445469562733561723325588433285405495368807600668761929378526978417102735864613562148766250350460118131749533517869691858933617013731291337496943174343464943</span>
p1 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span>
q1 <span class="token operator">=</span> n1 <span class="token operator">/</span> p1
e <span class="token operator">=</span> <span class="token number">65537</span>
phin <span class="token operator">=</span> <span class="token punctuation">(</span>p1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
cipher <span class="token operator">=</span> <span class="token number">0x68d5702b70d18238f9d4a3ac355b2a8934328250efd4efda39a4d750d80818e6fe228ba3af471b27cc529a4b0bef70a2598b80dd251b15952e6a6849d366633ed7bb716ed63c6febd4cd0621b0c4ebfe5235de03d4ee016448de1afbbe61144845b580eed8be8127a8d92b37f9ef670b3cdd5af613c76f58ca1a9f6f03f1bc11addba30b61bb191efe0015e971b8f78375faa257a60b355050f6435d94b49eab07075f40cb20bb8723d02f5998d5538e8dafc80cc58643c91f6c0868a7a7bf3bf6a9b4b6e79e0a80e89d430f0c049e1db4883c50db066a709b89d74038c34764aac286c36907b392bc299ab8288f9d7e372868954a92cdbf634678f7294096c7</span>
plain <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n1<span class="token punctuation">)</span>
plain <span class="token operator">=</span> hex<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> len<span class="token punctuation">(</span>plain<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
    plain <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> plain
<span class="token keyword">print</span> plain<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后解密如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  scaf-rsa2 git:(master) ✗ python exp.py       
sH1R3_PRlME_1N_rsA_iS_4ulnEra5le<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>解压压缩包即可。</p>
<h2 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h2><h3 id="攻击条件-2"><a href="#攻击条件-2" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>当两个用户使用相同的模数 N、不同的私钥时，加密同一明文消息时即存在共模攻击。</p>
<h3 id="攻击原理-1"><a href="#攻击原理-1" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>设两个用户的公钥分别为 $e_1$ 和 $e_2$，且两者互质。明文消息为 $m$，密文分别为：</p>
<p>$$<br>c_1 = m^{e_1}\bmod N \<br>c_2 = m^{e_2}\bmod N<br>$$</p>
<p>当攻击者截获 $c_1$ 和 $c_2$ 后，就可以恢复出明文。用扩展欧几里得算法求出 $re_1+se_2=1\bmod n$ 的两个整数 $r$ 和 $s$，由此可得：</p>
<p>$$<br>\begin{align}<br>c_{1}^{r}c_{2}^{s} &amp;\equiv m^{re_1}m^{se_2}\bmod n\<br>&amp;\equiv m^{(re_1+se_2)} \bmod n\<br>&amp;\equiv m\bmod n<br>\end{align}<br>$$</p>
<h3 id="XMan-一期夏令营课堂练习"><a href="#XMan-一期夏令营课堂练习" class="headerlink" title="XMan 一期夏令营课堂练习"></a>XMan 一期夏令营课堂练习</h3><p>题目描述：</p>
<pre><code>{6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249,773}

{6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249,839}

message1=3453520592723443935451151545245025864232388871721682326408915024349804062041976702364728660682912396903968193981131553111537349

message2=5672818026816293344070119332536629619457163570036305296869053532293105379690793386019065754465292867769521736414170803238309535</code></pre><blockquote>
<p>题目来源：XMan 一期夏令营课堂练习 </p>
</blockquote>
<p>可以看出两个公钥的 N 是一样的，并且两者的 e 互素。写一个脚本跑一下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
n <span class="token operator">=</span> <span class="token number">6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249</span>
e1 <span class="token operator">=</span> <span class="token number">773</span>

e2 <span class="token operator">=</span> <span class="token number">839</span>

message1 <span class="token operator">=</span> <span class="token number">3453520592723443935451151545245025864232388871721682326408915024349804062041976702364728660682912396903968193981131553111537349</span>

message2 <span class="token operator">=</span> <span class="token number">5672818026816293344070119332536629619457163570036305296869053532293105379690793386019065754465292867769521736414170803238309535</span>
<span class="token comment" spellcheck="true"># s &amp; t</span>
gcd<span class="token punctuation">,</span> s<span class="token punctuation">,</span> t <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcdext<span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span>
<span class="token keyword">if</span> s <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token operator">-</span>s
    message1 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>message1<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token keyword">if</span> t <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> <span class="token operator">-</span>t
    message2 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>message2<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
plain <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>message1<span class="token punctuation">,</span> s<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>message2<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> n
<span class="token keyword">print</span> plain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  Xman-1-class-exercise git:(master) ✗ python exp.py
1021089710312311910410111011910111610410511010710511610511511211111511510598108101125<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这时候需要考虑当时明文是如何转化为这个数字了，一般来说是 16 进制转换，ASCII 字符转换，或者 Base64 解密。这个应该是 ASCII 字符转换，进而我们使用如下代码得到 flag</p>
<pre class="line-numbers language-python"><code class="language-python">i <span class="token operator">=</span> <span class="token number">0</span>
flag <span class="token operator">=</span> <span class="token string">""</span>
plain <span class="token operator">=</span> str<span class="token punctuation">(</span>plain<span class="token punctuation">)</span>
<span class="token keyword">while</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> plain<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
        flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>plain<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">3</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>plain<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">2</span>
<span class="token keyword">print</span> flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里之所以使用 1 来判断是否为三位长度，是因为 flag 一般都是明文字符，而 1 开头的长度为 1 或者 2 的数字，一般都是不可见字符。</p>
<p>flag</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  Xman-1-class-exercise git:(master) ✗ python exp.py
flag{whenwethinkitispossible}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="公钥指数相关攻击"><a href="#公钥指数相关攻击" class="headerlink" title="公钥指数相关攻击"></a>公钥指数相关攻击</h1><h2 id="小公钥指数攻击"><a href="#小公钥指数攻击" class="headerlink" title="小公钥指数攻击"></a>小公钥指数攻击</h2><h3 id="攻击条件-3"><a href="#攻击条件-3" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>e 特别小，比如 e 为 3。</p>
<h3 id="攻击原理-2"><a href="#攻击原理-2" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>假设用户使用的密钥 $e=3$。考虑到加密关系满足：</p>
<p>$$<br>c\equiv m^3 \bmod N<br>$$</p>
<p>则：</p>
<p>$$<br>\begin{align}<br>m^3 &amp;= c+k\times N\<br>m &amp;= \sqrt[3]{c+k\times n}<br>\end{align}<br>$$</p>
<p>攻击者可以从小到大枚举 $k$，依次开三次根，直到开出整数为止。</p>
<h3 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h3><p>这里我们以 XMan 一期夏令营课堂练习为例进行介绍（Jarvis OJ 有复现），附件中有一个 <code>flag.enc</code> 和 <code>pubkey.pem</code>，很明显是密文和公钥了，先用 <code>openssl</code> 读一下公钥。</p>
<pre class="line-numbers language-bash"><code class="language-bash">➜  Jarvis OJ-Extremely hard RSA git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ openssl rsa -pubin -in pubkey.pem -text -modulus       
Public-Key: <span class="token punctuation">(</span>4096 bit<span class="token punctuation">)</span>
Modulus:
    00:b0:be:e5:e3:e9:e5:a7:e8:d0:0b:49:33:55:c6:
    18:fc:8c:7d:7d:03:b8:2e:40:99:51:c1:82:f3:98:
    de:e3:10:45:80:e7:ba:70:d3:83:ae:53:11:47:56:
    56:e8:a9:64:d3:80:cb:15:7f:48:c9:51:ad:fa:65:
    db:0b:12:2c:a4:0e:42:fa:70:91:89:b7:19:a4:f0:
    d7:46:e2:f6:06:9b:af:11:ce:bd:65:0f:14:b9:3c:
    97:73:52:fd:13:b1:ee:a6:d6:e1:da:77:55:02:ab:
    ff:89:d3:a8:b3:61:5f:d0:db:49:b8:8a:97:6b:c2:
    05:68:48:92:84:e1:81:f6:f1:1e:27:08:91:c8:ef:
    80:01:7b:ad:23:8e:36:30:39:a4:58:47:0f:17:49:
    10:1b:c2:99:49:d3:a4:f4:03:8d:46:39:38:85:15:
    79:c7:52:5a:69:98:4f:15:b5:66:7f:34:20:9b:70:
    eb:26:11:36:94:7f:a1:23:e5:49:df:ff:00:60:18:
    83:af:d9:36:fe:41:1e:00:6e:4e:93:d1:a0:0b:0f:
    ea:54:1b:bf:c8:c5:18:6c:b6:22:05:03:a9:4b:24:
    13:11:0d:64:0c:77:ea:54:ba:32:20:fc:8f:4c:c6:
    ce:77:15:1e:29:b3:e0:65:78:c4:78:bd:1b:eb:e0:
    45:89:ef:9a:19:7f:6f:80:6d:b8:b3:ec:d8:26:ca:
    d2:4f:53:24:cc:de:c6:e8:fe:ad:2c:21:50:06:86:
    02:c8:dc:dc:59:40:2c:ca:c9:42:4b:79:00:48:cc:
    dd:93:27:06:80:95:ef:a0:10:b7:f1:96:c7:4b:a8:
    c3:7b:12:8f:9e:14:11:75:16:33:f7:8b:7b:9e:56:
    f7:1f:77:a1:b4:da:ad:3f:c5:4b:5e:7e:f9:35:d9:
    a7:2f:b1:76:75:97:65:52:2b:4b:bc:02:e3:14:d5:
    c0:6b:64:d5:05:4b:7b:09:6c:60:12:36:e6:cc:f4:
    5b:5e:61:1c:80:5d:33:5d:ba:b0:c3:5d:22:6c:c2:
    08:d8:ce:47:36:ba:39:a0:35:44:26:fa:e0:06:c7:
    fe:52:d5:26:7d:cf:b9:c3:88:4f:51:fd:df:df:4a:
    97:94:bc:fe:0e:15:57:11:37:49:e6:c8:ef:42:1d:
    ba:26:3a:ff:68:73:9c:e0:0e:d8:0f:d0:02:2e:f9:
    2d:34:88:f7:6d:eb:62:bd:ef:7b:ea:60:26:f2:2a:
    1d:25:aa:2a:92:d1:24:41:4a:80:21:fe:0c:17:4b:
    98:03:e6:bb:5f:ad:75:e1:86:a9:46:a1:72:80:77:
    0f:12:43:f4:38:74:46:cc:ce:b2:22:2a:96:5c:c3:
    0b:39:29
Exponent: 3 <span class="token punctuation">(</span>0x3<span class="token punctuation">)</span>
Modulus<span class="token operator">=</span>B0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929
writing RSA key
-----BEGIN PUBLIC KEY-----
MIICIDANBgkqhkiG9w0BAQEFAAOCAg0AMIICCAKCAgEAsL7l4+nlp+jQC0kzVcYY
/Ix9fQO4LkCZUcGC85je4xBFgOe6cNODrlMRR1ZW6Klk04DLFX9IyVGt+mXbCxIs
pA5C+nCRibcZpPDXRuL2BpuvEc69ZQ8UuTyXc1L9E7Huptbh2ndVAqv/idOos2Ff
0NtJuIqXa8IFaEiShOGB9vEeJwiRyO+AAXutI442MDmkWEcPF0kQG8KZSdOk9AON
Rjk4hRV5x1JaaZhPFbVmfzQgm3DrJhE2lH+hI+VJ3/8AYBiDr9k2/kEeAG5Ok9Gg
Cw/qVBu/yMUYbLYiBQOpSyQTEQ1kDHfqVLoyIPyPTMbOdxUeKbPgZXjEeL0b6+BF
ie+aGX9vgG24s+zYJsrST1MkzN7G6P6tLCFQBoYCyNzcWUAsyslCS3kASMzdkycG
gJXvoBC38ZbHS6jDexKPnhQRdRYz94t7nlb3H3ehtNqtP8VLXn75NdmnL7F2dZdl
UitLvALjFNXAa2TVBUt7CWxgEjbmzPRbXmEcgF0zXbqww10ibMII2M5HNro5oDVE
JvrgBsf+UtUmfc+5w4hPUf3f30qXlLz+DhVXETdJ5sjvQh26Jjr/aHOc4A7YD9AC
LvktNIj3betive976mAm8iodJaoqktEkQUqAIf4MF0uYA+a7X6114YapRqFygHcP
EkP0OHRGzM6yIiqWXMMLOSkCAQM<span class="token operator">=</span>
-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看到 $e=3$，很明显是小公钥指数攻击了。这里我们使用 Crypto 库来读取公钥，使用 multiprocessing 来加快破解速度。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#/usr/bin/python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./pubkey.pem'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    N <span class="token operator">=</span> key<span class="token punctuation">.</span>n
    e <span class="token operator">=</span> key<span class="token punctuation">.</span>e
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'flag.enc'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> int<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> j
    a<span class="token punctuation">,</span> b <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>cipher <span class="token operator">+</span> j <span class="token operator">*</span> N<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> a
        <span class="token keyword">print</span> <span class="token string">'{:x}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>int<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
        pool<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">SmallE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    inputs <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">130000000</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>map<span class="token punctuation">(</span>calc<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">'start'</span>
    SmallE<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>爆破时间有点长，，拿到 flag</p>
<pre><code>Didn't you know RSA padding is really important? Now you see a non-padding message is so dangerous. And you should notice this in future.Fl4g: flag{Sm4ll_3xpon3nt_i5_W3ak}</code></pre><h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><h2 id="RSA-衍生算法——Rabin-算法"><a href="#RSA-衍生算法——Rabin-算法" class="headerlink" title="RSA 衍生算法——Rabin 算法"></a>RSA 衍生算法——Rabin 算法</h2><h3 id="攻击条件-4"><a href="#攻击条件-4" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>Rabin 算法的特征在于 $e=2$。</p>
<h3 id="攻击原理-3"><a href="#攻击原理-3" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>密文：</p>
<p>$$<br>c = m^2\bmod n<br>$$</p>
<p>解密：</p>
<ul>
<li>计算出 $m_p$ 和 $m_q$：</li>
</ul>
<p>$$<br>\begin{align}<br>m_p &amp;= \sqrt{c} \bmod p\<br>m_q &amp;= \sqrt{c} \bmod q<br>\end{align}<br>$$</p>
<ul>
<li>用扩展欧几里得计算出 $y_p$ 和 $y_q$：</li>
</ul>
<p>$$<br>y_p \cdot p + y_q \cdot q = 1<br>$$</p>
<ul>
<li>解出四个明文：</li>
</ul>
<p>$$<br>\begin{align}<br>a &amp;= (y_p \cdot p \cdot m_q + y_q \cdot q \cdot m_p) \bmod n\<br>b &amp;= n - a\<br>c &amp;= (y_p \cdot p \cdot m_q - y_q \cdot q \cdot m_p) \bmod n\<br>d &amp;= n - c<br>\end{align}<br>$$</p>
<p>注意：如果 $p \equiv q \equiv 3 \pmod 4$，则</p>
<p>$$<br>\begin{align}<br>m_p &amp;= c^{\frac{1}{4}(p + 1)} \bmod p\<br>m_q &amp;= c^{\frac{1}{4}(q + 1)} \bmod q<br>\end{align}<br>$$</p>
<p>而一般情况下，$p \equiv q \equiv 3 \pmod 4$ 是满足的，对于不满足的情况下，请参考相应的算法解决。</p>
<h3 id="例子-4"><a href="#例子-4" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 XMan 一期夏令营课堂练习（Jarvis OJ 有复现）为例，读一下公钥。</p>
<pre class="line-numbers language-bash"><code class="language-bash">➜  Jarvis OJ-hard RSA git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ openssl rsa -pubin -in pubkey.pem -text -modulus 
Public-Key: <span class="token punctuation">(</span>256 bit<span class="token punctuation">)</span>
Modulus:
    00:c2:63:6a:e5:c3:d8:e4:3f:fb:97:ab:09:02:8f:
    1a:ac:6c:0b:f6:cd:3d:70:eb:ca:28:1b:ff:e9:7f:
    be:30:dd
Exponent: 2 <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
Modulus<span class="token operator">=</span>C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DD
writing RSA key
-----BEGIN PUBLIC KEY-----
MDowDQYJKoZIhvcNAQEBBQADKQAwJgIhAMJjauXD2OQ/+5erCQKPGqxsC/bNPXDr
yigb/+l/vjDdAgEC
-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>$e=2$，考虑 Rabin 算法。首先我们先分解一下 p 和 q，得到</p>
<pre class="line-numbers language-text"><code class="language-text">p=275127860351348928173285174381581152299
q=319576316814478949870590164193048041239<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>编写代码</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>
<span class="token keyword">import</span> gmpy2
<span class="token keyword">import</span> string
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA

<span class="token comment" spellcheck="true"># 读取公钥参数</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'pubkey.pem'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    N <span class="token operator">=</span> key<span class="token punctuation">.</span>n
    e <span class="token operator">=</span> key<span class="token punctuation">.</span>e
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'flag.enc'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> string<span class="token punctuation">.</span>atoi<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print cipher</span>
<span class="token keyword">print</span> <span class="token string">"please input p"</span>
p <span class="token operator">=</span> int<span class="token punctuation">(</span>raw_input<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'please input q'</span>
q <span class="token operator">=</span> int<span class="token punctuation">(</span>raw_input<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 计算yp和yq</span>
inv_p <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
inv_q <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>q<span class="token punctuation">,</span> p<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 计算mp和mq</span>
mp <span class="token operator">=</span> pow<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
mq <span class="token operator">=</span> pow<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> <span class="token punctuation">(</span>q <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 计算a,b,c,d</span>
a <span class="token operator">=</span> <span class="token punctuation">(</span>inv_p <span class="token operator">*</span> p <span class="token operator">*</span> mq <span class="token operator">+</span> inv_q <span class="token operator">*</span> q <span class="token operator">*</span> mp<span class="token punctuation">)</span> <span class="token operator">%</span> N
b <span class="token operator">=</span> N <span class="token operator">-</span> int<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
c <span class="token operator">=</span> <span class="token punctuation">(</span>inv_p <span class="token operator">*</span> p <span class="token operator">*</span> mq <span class="token operator">-</span> inv_q <span class="token operator">*</span> q <span class="token operator">*</span> mp<span class="token punctuation">)</span> <span class="token operator">%</span> N
d <span class="token operator">=</span> N <span class="token operator">-</span> int<span class="token punctuation">(</span>c<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> <span class="token string">'%x'</span> <span class="token operator">%</span> i
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> s
    <span class="token keyword">print</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拿到 flag，<code>PCTF{sp3ci4l_rsa}</code>。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h1 id="私钥-d-相关攻击"><a href="#私钥-d-相关攻击" class="headerlink" title="私钥 d 相关攻击"></a>私钥 d 相关攻击</h1><h2 id="d-泄露攻击"><a href="#d-泄露攻击" class="headerlink" title="d 泄露攻击"></a>d 泄露攻击</h2><h3 id="攻击原理-4"><a href="#攻击原理-4" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>首先当 $d$ 泄露之后，我们自然可以解密所有加密的消息。我们甚至还可以对模数 N 进行分解。其基本原理如下</p>
<p>我们知道 $ed \equiv 1 \bmod \varphi(n)$，那么存在一个 $k$ 使得 </p>
<p>$$<br>ed-1=k\varphi(n)<br>$$</p>
<p>又 $\forall a\in {Z}_n^*$，满足$a^{ed-1}\equiv1(\bmod n)$。令</p>
<p>$$<br>ed-1=2^st<br>$$</p>
<p>其中，$t$ 是一个奇数。然后可以证明对于至少一半的 $a\in {Z}_n^*$，存在一个 $i\in[1,s]$，使得 </p>
<p>$$<br>a^{2^{i-1}t}\not\equiv\pm1(\bmod n),a^{2^{i}t}\equiv1(\bmod n)<br>$$</p>
<p>成立。如果 $a,i$ 满足上述条件，$gcd(a^{2^{i-1}t}-1,n)$是 $n$ 的一个非平凡因子，所以可以对 $n$ 进行暴力分解。</p>
<h3 id="工具-14"><a href="#工具-14" class="headerlink" title="工具"></a>工具</h3><p>利用以下工具可以直接进行计算</p>
<ul>
<li>RsaConverter.exe (<a href="https://sourceforge.net/projects/rsaconverter/" target="_blank" rel="noopener">https://sourceforge.net/projects/rsaconverter/</a> , for windows )</li>
<li><a href="https://github.com/ius/rsatool/blob/master/rsatool.py" target="_blank" rel="noopener">rsatool.py</a>(分解原理如上)</li>
</ul>
<h3 id="2017-HITB-hack-in-the-card-II"><a href="#2017-HITB-hack-in-the-card-II" class="headerlink" title="2017 HITB - hack in the card II"></a>2017 HITB - hack in the card II</h3><blockquote>
<p>The second smart card sent to us has been added some countermeasures by that evil company. They also changed the public key(attachments -&gt; publickey.pem). However it seems that they missed something……<br>Can you decrypt the following hex-encoded ciphertext this time?  </p>
<pre><code>016d1d26a470fad51d52e5f3e90075ab77df69d2fb39905fe634ded81d10a5fd10c35e1277035a9efabb66e4d52fd2d1eaa845a93a4e0f1c4a4b70a0509342053728e89e977cfb9920d5150393fe9dcbf86bc63914166546d5ae04d83631594703db59a628de3b945f566bdc5f0ca7bdfa819a0a3d7248286154a6cc5199b99708423d0749d4e67801dff2378561dd3b0f10c8269dbef2630819236e9b0b3d3d8910f7f7afbbed29788e965a732efc05aef3194cd1f1cff97381107f2950c935980e8954f91ed2a653c91015abea2447ee2a3488a49cc9181a3b1d44f198ff9f0141badcae6a9ae45c6c75816836fb5f331c7f2eb784129a142f88b4dc22a0a977</code></pre></blockquote>
<p>这题是接续 2017 HITB - hack in the card I 的一道题，我们直接使用 <code>openssl</code> 查看 <code>publickey.pem</code> 的公钥，发现它的 N 与上一道题的 N 相同，并且上题的 N，e，d 已知。由此可直接使用上面的 <code>rsatool.py</code> 得到 p，q，并通过本题的 e 计算出 e 得到明文。</p>
<h2 id="Wiener’s-Attack"><a href="#Wiener’s-Attack" class="headerlink" title="Wiener’s Attack"></a>Wiener’s Attack</h2><h3 id="攻击条件-5"><a href="#攻击条件-5" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>在 d 比较小（$d&lt;\frac{1}{3}N^{\frac{1}{4}}$）时，攻击者可以使用 <strong>Wiener’s Attack</strong> 来获得私钥。</p>
<h3 id="攻击原理-5"><a href="#攻击原理-5" class="headerlink" title="攻击原理"></a>攻击原理</h3><ul>
<li><a href="https://en.wikipedia.org/wiki/Wiener%27s_attack" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Wiener%27s_attack</a></li>
<li><a href="https://sagi.io/2016/04/crypto-classics-wieners-rsa-attack/" target="_blank" rel="noopener">https://sagi.io/2016/04/crypto-classics-wieners-rsa-attack/</a></li>
</ul>
<h3 id="工具-15"><a href="#工具-15" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="https://github.com/pablocelayes/rsa-wiener-attack" target="_blank" rel="noopener">https://github.com/pablocelayes/rsa-wiener-attack</a></li>
<li><a href="https://github.com/orisano/owiener" target="_blank" rel="noopener">https://github.com/orisano/owiener</a></li>
</ul>
<h2 id="综合例子"><a href="#综合例子" class="headerlink" title="综合例子"></a>综合例子</h2><h3 id="2016-HCTF-RSA1"><a href="#2016-HCTF-RSA1" class="headerlink" title="2016 HCTF RSA1"></a>2016 HCTF RSA1</h3><p>这里我们以 2016 年 HCTF 中 RSA 1 - Crypto So Interesting 为例进行分析，<a href="https://github.com/Hcamael/ctf-library/tree/master/RSA1" target="_blank" rel="noopener">源代码链接</a>。</p>
<p>首先先绕过程序的 proof 部分，差不多使用一些随机的数据就可以绕过。</p>
<p>其次，我们来分析一下具体的代码部分，程序是根据我们的 token 来获取 flag 的，这里我们就直接利用源代码中提供的 token。</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">print</span> <span class="token string">"This is a RSA Decryption System"</span>
    <span class="token keyword">print</span> <span class="token string">"Please enter Your team token: "</span>
    token <span class="token operator">=</span> raw_input<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        flag <span class="token operator">=</span> get_flag<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> len<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">38</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"Token error!"</span>
        m_exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们首先知道 $n=pq$，我们再来你仔细分析一下这个 e，d 是如何得到的。</p>
<pre class="line-numbers language-python"><code class="language-python">    p<span class="token operator">=</span>getPrime<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
    q<span class="token operator">=</span>getPrime<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> p <span class="token operator">*</span> q
    e<span class="token punctuation">,</span> d <span class="token operator">=</span> get_ed<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"n: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"e: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>get_ed</code> 函数如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_ed</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    k <span class="token operator">=</span> cal_bit<span class="token punctuation">(</span>q<span class="token operator">*</span>p<span class="token punctuation">)</span>
    phi_n <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        u <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token operator">/</span><span class="token number">4</span> <span class="token operator">-</span> r<span class="token punctuation">)</span>
        <span class="token keyword">if</span> gcd<span class="token punctuation">(</span>u<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        t <span class="token operator">=</span> invmod<span class="token punctuation">(</span>u<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span>
        e <span class="token operator">=</span> pi_b<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token keyword">if</span> gcd<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    d <span class="token operator">=</span> invmod<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，我们得到的 u 的位数比 n 的位数的四分之一还要少，这里其实就差不多满足了 Wiener’s Attack 了。而且我们计算出来的 u，t，e，d 还满足以下条件</p>
<p>$$<br>\begin{align}<br>ut &amp;\equiv 1  \bmod \varphi(n) \<br>et &amp;\equiv 1 \bmod bt \<br>ed &amp;\equiv 1 \bmod \varphi(n)<br>\end{align}<br>$$</p>
<p>根据题中给出的条件，我们已经知道了 n，e，bt。</p>
<p>所以首先我们可以根据上面的第二个式子知道 e。这时候，可以利用第一个式子进行 Wiener’s Attack，获取 u。进而这时我们可以利用私钥指数泄露攻击的方法来分解 N 从而得到 p，q。进而我们就可以得到 d 了。</p>
<p>首先我们绕过 proof 得到了 N，e，加密后的 flag 如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">n:  0x4b4403cd5ac8bdfaa3bbf83decdc97db1fbc7615fd52f67a8acf7588945cd8c3627211ffd3964d979cb1ab3850348a453153710337c6fe3baa15d986c87fca1c97c6d270335b8a7ecae81ae0ebde48aa957e7102ce3e679423f29775eef5935006e8bc4098a52a168e07b75e431a796e3dcd29c98dab6971d3eac5b5b19fb4d2b32f8702ef97d92da547da2e22387f7555531af4327392ef9c82227c5a2479623dde06b525969e9480a39015a3ed57828162ca67e6d41fb7e79e1b25e56f1cff487c1d0e0363dc105512d75c83ad0085b75ede688611d489c1c2ea003c3b2f81722cdb307a3647f2da01fb3ba0918cc1ab88c67e1b6467775fa412de7be0b44f2e19036471b618db1415f6b656701f692c5e841d2f58da7fd2bc33e7c3c55fcb8fd980c9e459a6df44b0ef70b4b1d813a57530446aa054cbfb9d1a86ffb6074b6b7398a83b5f0543b910dcb9f111096b07a98830a3ce6da47cd36b7c1ac1b2104ea60dc198c34f1c50faa5b697f2f195afe8af5d455e8ac7ca6eda669a5a1e3bfbd290a4480376abd1ff21298d529b26a4e614ab24c776a10f5f5d8e8809467a3e81f04cf5d5b23eb4a3412886797cab4b3c5724c077354b2d11d19ae4e301cd2ca743e56456d2a785b650c7e1a727b1bd881ee85c8d109792393cc1a92a66b0bc23b164146548f4e184b10c80ec458b776df10405b65399e32d657bc83e1451
e:  0x10194521505692a64d043daaef7647e0efb1503ec89220a0e4148ab53ecf708146a8893a2e700e4f2f062be14a3ab4e46339a939d5c7289904cc0ab043320d3a4d7da868bf5736ae5f787d6c0e3d9b8cc4b81314ad6c5ff643bc0d8946fea7eb09bf707a54747a39df1cfc0c30849770578cb63de86621001ce86a11874c91419a4d07373e66e94f31b988cac3aeaff88c7abaf3b78468a434990f7854e734208a7461f8245660fa8301f979e85517d705302c797dbdf2938cc442b01c228939eb73aa29651a198a332af2bb982310699684e5a0595c7413ec01eefb3613a9ea4b59f1de984ad4bf6654960613c0f8104b4e41fb33384e07f715176d68f4bb7613b1258675e70dc774f701aee053830f0be28ba9f308c9fe1707a5ba07a2027d74144b8aeb4042df3c1d73d9c38c2d7d1a890fd70d6e38c72da5d075f3811c0354dcecdd836a59112a70be22757278c5e4973906aaeeadd6f61d0845d6f9761df191b0b2527d122dd07f8bd07f5cd14268246ac2b93b778c84b5157f7eb23a8eaa9f0f885f2a38e3fb8fd1012d9b6c841cea8d9d73b232bef298afd086c1063bdd11e0777c8d2ec91ae843a67a98039cb53fad0ee25040176841a017fabf79b98de21d40bc6985f82dd84406aad26e9ac9bc5f6e12385230d9620b888c201ca9c413cbf0f36b100a6c62c5c8f065934fcf9f9f0179eea35888cb357b704441c1
flag:  0x2517d1866acc5b7b802a51d6251673262e9e6b2d0e0e14a87b838c2751dee91e4ea29019b0a7877b849fddf9e08580d810622db538462b529412eba9d0f8a450fe1889021c0bbd12a62ccc3fff4627b1dbdebec3a356a066adc03f7650722a34fe41ea0a247cb480a12286fffc799d66b6631a220b8401f5f50daa12943856b35e59abf8457b2269efea14f1535fb95e56398fd5f3ac153e3ea1afd7b0bb5f02832883da46343404eb44594d04bbd254a9a35749af84eaf4e35ba1c5571d41cab4d58befa79b6745d8ecf93b64dd26056a6d1e82430afbff3dbc08d6c974364b57b30c8a8230c99f0ec3168ac4813c4205d9190481282ae14f7b94400caff3786ed35863b66fefcffbef1ad1652221746a5c8da083987b2b69689cf43e86a05ce4cf059934716c455a6410560e41149fbcf5fcea3c210120f106b8f6269b9a954139350626cf4dcb497ce86264e05565ec6c6581bf28c643bb4fab8677148c8034833cedacb32172b0ff21f363ca07de0fa2882ac896954251277adc0cdd0c3bd5a3f107dbebf5f4d884e43fe9b118bdd51dc80607608670507388ae129a71e0005826c7c82efccf9c86c96777d7d3b9b5cce425e3dcf9aec0643f003c851353e36809b9202ff3b79e8f33d40967c1d36f5d585ac9eba73611152fc6d3cf36fd9a60b4c621858ed1f6d4db86054c27828e22357fa3d7c71559d175ff8e8987df
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其次使用如下方法进行 Wiener’s Attack 得到 u，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    bt <span class="token operator">=</span> 536380958350616057242691418634880594502192106332317228051967064327642091297687630174183636288378234177476435270519631690543765125295554448698898712393467267006465045949611180821007306678935181142803069337672948471202242891010188677287454504933695082327796243976863378333980923047411230913909715527759877351702062345876337256220760223926254773346698839492268265110546383782370744599490250832085044856878026833181982756791595730336514399767134613980006467147592898197961789187070786602534602178082726728869941829230655559180178594489856595304902790182697751195581218334712892008282605180395912026326384913562290014629187579128041030500771670510157597682826798117937852656884106597180126028398398087318119586692935386069677459788971114075941533740462978961436933215446347246886948166247617422293043364968298176007659058279518552847235689217185712791081965260495815179909242072310545078116020998113413517429654328367707069941427368374644442366092232916196726067387582032505389946398237261580350780769275427857010543262176468343294217258086275244086292475394366278211528621216522312552812343261375050388129743012932727654986046774759567950981007877856194574274373776538888953502272879816420369255752871177234736347325263320696917012616273L
    e <span class="token operator">=</span> <span class="token number">0x10194521505692a64d043daaef7647e0efb1503ec89220a0e4148ab53ecf708146a8893a2e700e4f2f062be14a3ab4e46339a939d5c7289904cc0ab043320d3a4d7da868bf5736ae5f787d6c0e3d9b8cc4b81314ad6c5ff643bc0d8946fea7eb09bf707a54747a39df1cfc0c30849770578cb63de86621001ce86a11874c91419a4d07373e66e94f31b988cac3aeaff88c7abaf3b78468a434990f7854e734208a7461f8245660fa8301f979e85517d705302c797dbdf2938cc442b01c228939eb73aa29651a198a332af2bb982310699684e5a0595c7413ec01eefb3613a9ea4b59f1de984ad4bf6654960613c0f8104b4e41fb33384e07f715176d68f4bb7613b1258675e70dc774f701aee053830f0be28ba9f308c9fe1707a5ba07a2027d74144b8aeb4042df3c1d73d9c38c2d7d1a890fd70d6e38c72da5d075f3811c0354dcecdd836a59112a70be22757278c5e4973906aaeeadd6f61d0845d6f9761df191b0b2527d122dd07f8bd07f5cd14268246ac2b93b778c84b5157f7eb23a8eaa9f0f885f2a38e3fb8fd1012d9b6c841cea8d9d73b232bef298afd086c1063bdd11e0777c8d2ec91ae843a67a98039cb53fad0ee25040176841a017fabf79b98de21d40bc6985f82dd84406aad26e9ac9bc5f6e12385230d9620b888c201ca9c413cbf0f36b100a6c62c5c8f065934fcf9f9f0179eea35888cb357b704441c1</span>
    t <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> bt<span class="token punctuation">)</span>
    n <span class="token operator">=</span> <span class="token number">0x4b4403cd5ac8bdfaa3bbf83decdc97db1fbc7615fd52f67a8acf7588945cd8c3627211ffd3964d979cb1ab3850348a453153710337c6fe3baa15d986c87fca1c97c6d270335b8a7ecae81ae0ebde48aa957e7102ce3e679423f29775eef5935006e8bc4098a52a168e07b75e431a796e3dcd29c98dab6971d3eac5b5b19fb4d2b32f8702ef97d92da547da2e22387f7555531af4327392ef9c82227c5a2479623dde06b525969e9480a39015a3ed57828162ca67e6d41fb7e79e1b25e56f1cff487c1d0e0363dc105512d75c83ad0085b75ede688611d489c1c2ea003c3b2f81722cdb307a3647f2da01fb3ba0918cc1ab88c67e1b6467775fa412de7be0b44f2e19036471b618db1415f6b656701f692c5e841d2f58da7fd2bc33e7c3c55fcb8fd980c9e459a6df44b0ef70b4b1d813a57530446aa054cbfb9d1a86ffb6074b6b7398a83b5f0543b910dcb9f111096b07a98830a3ce6da47cd36b7c1ac1b2104ea60dc198c34f1c50faa5b697f2f195afe8af5d455e8ac7ca6eda669a5a1e3bfbd290a4480376abd1ff21298d529b26a4e614ab24c776a10f5f5d8e8809467a3e81f04cf5d5b23eb4a3412886797cab4b3c5724c077354b2d11d19ae4e301cd2ca743e56456d2a785b650c7e1a727b1bd881ee85c8d109792393cc1a92a66b0bc23b164146548f4e184b10c80ec458b776df10405b65399e32d657bc83e1451</span>
    solve<span class="token punctuation">(</span>n<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 solve 函数就是对应的 Wiener’s Attack 的函数。</p>
<p>我们得到了 u，如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  rsa-wiener-attack git:(master) ✗ python RSAwienerHacker.py
Testing Wiener Attack
Hacked!
('hacked_d = ', mpz(404713159471231711408151571380906751680333129144247165378555186876078301457022630947986647887431519481527070603810696638453560506186951324208972060991323925955752760273325044674073649258563488270334557390141102174681693044992933206572452629140703447755138963985034199697200260653L))
-------------------------
Hacked!
('hacked_d = ', mpz(404713159471231711408151571380906751680333129144247165378555186876078301457022630947986647887431519481527070603810696638453560506186951324208972060991323925955752760273325044674073649258563488270334557390141102174681693044992933206572452629140703447755138963985034199697200260653L))
-------------------------
Hacked!
('hacked_d = ', mpz(404713159471231711408151571380906751680333129144247165378555186876078301457022630947986647887431519481527070603810696638453560506186951324208972060991323925955752760273325044674073649258563488270334557390141102174681693044992933206572452629140703447755138963985034199697200260653L))
-------------------------
Hacked!
('hacked_d = ', mpz(404713159471231711408151571380906751680333129144247165378555186876078301457022630947986647887431519481527070603810696638453560506186951324208972060991323925955752760273325044674073649258563488270334557390141102174681693044992933206572452629140703447755138963985034199697200260653L))
-------------------------
Hacked!
('hacked_d = ', mpz(404713159471231711408151571380906751680333129144247165378555186876078301457022630947986647887431519481527070603810696638453560506186951324208972060991323925955752760273325044674073649258563488270334557390141102174681693044992933206572452629140703447755138963985034199697200260653L))
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着利用 RsaConverter 以及 u，t，n 获取对应的 p 和 q。如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">94121F49C0E7A37A60FDE4D13F021675ED91032EB16CB070975A3EECECE8697ED161A27D86BCBC4F45AA6CDC128EB878802E0AD3B95B2961138C8CD04D28471B558CD816279BDCCF8FA1513A444AF364D8FDA8176A4E459B1B939EBEC6BB164F06CDDE9C203C612541E79E8B6C266436AB903209F5C63C8F0DA192F129F0272090CBE1A37E2615EF7DFBB05D8D88B9C964D5A42A7E0D6D0FF344303C4364C894AB7D912065ABC30815A3B8E0232D1B3D7F6B80ED7FE4B71C3477E4D6C2C78D733CF23C694C535DB172D2968483E63CC031DFC5B27792E2235C625EC0CFDE33FD3E53915357772975D264D24A7F31308D72E1BD7656B1C16F58372E7682660381
8220863F1CFDA6EDE52C56B4036485DB53F57A4629F5727EDC4C5637603FE059EB44751FC49EC846C0B8B50966678DFFB1CFEB350EC44B57586A81D35E4887F1722367CE99116092463079A63E3F29D4F4BC416E7728B26248EE8CD2EFEA6925EC6F455DF966CEE13C808BC15CA2A6AAC7FEA69DB7C9EB9786B50EBD437D38B73D44F3687AEB5DF03B6F425CF3171B098AAC6708D534F4D3A9B3D43BAF70316812EF95FC7EBB7E224A7016D7692B52CB0958951BAB4FB5CB1ABB4DAC606F03FA15697CC3E9DF26DE5F6D6EC45A683CD5AAFD58D416969695067795A2CF7899F61669BC7543151AB700A593BF5A1E5C2AFBCE45A08A2A9CC1685FAF1F96B138D1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后我们直接去获得 d，进而就可以恢复明文</p>
<pre class="line-numbers language-python"><code class="language-python">    p <span class="token operator">=</span> <span class="token number">0x94121F49C0E7A37A60FDE4D13F021675ED91032EB16CB070975A3EECECE8697ED161A27D86BCBC4F45AA6CDC128EB878802E0AD3B95B2961138C8CD04D28471B558CD816279BDCCF8FA1513A444AF364D8FDA8176A4E459B1B939EBEC6BB164F06CDDE9C203C612541E79E8B6C266436AB903209F5C63C8F0DA192F129F0272090CBE1A37E2615EF7DFBB05D8D88B9C964D5A42A7E0D6D0FF344303C4364C894AB7D912065ABC30815A3B8E0232D1B3D7F6B80ED7FE4B71C3477E4D6C2C78D733CF23C694C535DB172D2968483E63CC031DFC5B27792E2235C625EC0CFDE33FD3E53915357772975D264D24A7F31308D72E1BD7656B1C16F58372E7682660381</span>
    q <span class="token operator">=</span> <span class="token number">0x8220863F1CFDA6EDE52C56B4036485DB53F57A4629F5727EDC4C5637603FE059EB44751FC49EC846C0B8B50966678DFFB1CFEB350EC44B57586A81D35E4887F1722367CE99116092463079A63E3F29D4F4BC416E7728B26248EE8CD2EFEA6925EC6F455DF966CEE13C808BC15CA2A6AAC7FEA69DB7C9EB9786B50EBD437D38B73D44F3687AEB5DF03B6F425CF3171B098AAC6708D534F4D3A9B3D43BAF70316812EF95FC7EBB7E224A7016D7692B52CB0958951BAB4FB5CB1ABB4DAC606F03FA15697CC3E9DF26DE5F6D6EC45A683CD5AAFD58D416969695067795A2CF7899F61669BC7543151AB700A593BF5A1E5C2AFBCE45A08A2A9CC1685FAF1F96B138D1</span>
    <span class="token keyword">if</span> p <span class="token operator">*</span> q <span class="token operator">==</span> n<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'true'</span>
    phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> <span class="token number">0x2517d1866acc5b7b802a51d6251673262e9e6b2d0e0e14a87b838c2751dee91e4ea29019b0a7877b849fddf9e08580d810622db538462b529412eba9d0f8a450fe1889021c0bbd12a62ccc3fff4627b1dbdebec3a356a066adc03f7650722a34fe41ea0a247cb480a12286fffc799d66b6631a220b8401f5f50daa12943856b35e59abf8457b2269efea14f1535fb95e56398fd5f3ac153e3ea1afd7b0bb5f02832883da46343404eb44594d04bbd254a9a35749af84eaf4e35ba1c5571d41cab4d58befa79b6745d8ecf93b64dd26056a6d1e82430afbff3dbc08d6c974364b57b30c8a8230c99f0ec3168ac4813c4205d9190481282ae14f7b94400caff3786ed35863b66fefcffbef1ad1652221746a5c8da083987b2b69689cf43e86a05ce4cf059934716c455a6410560e41149fbcf5fcea3c210120f106b8f6269b9a954139350626cf4dcb497ce86264e05565ec6c6581bf28c643bb4fab8677148c8034833cedacb32172b0ff21f363ca07de0fa2882ac896954251277adc0cdd0c3bd5a3f107dbebf5f4d884e43fe9b118bdd51dc80607608670507388ae129a71e0005826c7c82efccf9c86c96777d7d3b9b5cce425e3dcf9aec0643f003c851353e36809b9202ff3b79e8f33d40967c1d36f5d585ac9eba73611152fc6d3cf36fd9a60b4c621858ed1f6d4db86054c27828e22357fa3d7c71559d175ff8e8987df</span>
    flag <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token keyword">print</span> long_to_bytes<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到 flag</p>
<pre class="line-numbers language-shell"><code class="language-shell">true
hctf{d8e8fca2dc0f896fd7cb4cb0031ba249}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Coppersmith-相关攻击"><a href="#Coppersmith-相关攻击" class="headerlink" title="Coppersmith 相关攻击"></a>Coppersmith 相关攻击</h1><h2 id="基本原理-1"><a href="#基本原理-1" class="headerlink" title="基本原理"></a>基本原理</h2><p>Coppersmith 相关攻击与<a href="https://en.wikipedia.org/wiki/Don_Coppersmith" target="_blank" rel="noopener">Don Coppersmith</a> 紧密相关，他提出了一种针对于模多项式（单变量，二元变量，甚至多元变量）找所有小整数根的多项式时间的方法。</p>
<p>这里我们以单变量为主进行介绍，假设</p>
<ul>
<li>模数为 N ，N 具有一个因子 $b\geq N^{\beta},0&lt; \beta \leq 1$</li>
<li>多项式 F 的次数为 $\delta$</li>
</ul>
<p>那么该方法可以在$O(c\delta^5log^9(N))$ 的复杂度内找到该多项式所有的根$x_0$，这里我们要求 $|x_0|&lt;cN^{\frac{\beta^2}{\delta}}$ 。</p>
<p>在这个问题中，我们的目标是找到在模 N 意义下多项式所有的根，这一问题被认为是复杂的。<strong>Coppersmith method</strong> 主要是通过 <a href="https://en.wikipedia.org/wiki/Lenstra%E2%80%93Lenstra%E2%80%93Lov%C3%A1sz_lattice_basis_reduction_algorithm" target="_blank" rel="noopener">Lenstra–Lenstra–Lovász lattice basis reduction algorithm</a>（LLL）方法找到</p>
<ul>
<li>与该多项式具有相同根 $x_0$</li>
<li>更小系数</li>
<li>定义域为整数域</li>
</ul>
<p>的多项式 g，由于在整数域上找多项式的根是简单的（Berlekamp–Zassenhaus），从而我们就得到了原多项式在模意义下的整数根。</p>
<p>那么问题的关键就是如何将 f 转换到 g 呢？Howgrave-Graham 给出了一种思路</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/coppersmith-howgrave-graham.png" alt=""></p>
<p>也就是说我们需要找到一个具有“更小系数”的多项式 g，也就是下面的转换方式</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/coppersmith-f2g.png" alt=""></p>
<p>在 LLL 算法中，有两点是非常有用的</p>
<ul>
<li>只对原来的基向量进行整数线性变换，这可以使得我们在得到 g 时，仍然以原来的 $x_0$ 为根。</li>
<li>生成的新的基向量的模长是有界的，这可以使得我们利用 Howgrave-Graham 定理。</li>
</ul>
<p>在这样的基础之上，我们再构造出多项式族 g 就可以了。</p>
<p>关于更加细节的内容，请自行搜索。同时这部分内容也会不断更新。</p>
<p>需要注意的是，由于 Coppersmith 根的约束，在 RSA 中的应用时，往往只适用于 e 较小的情况。</p>
<h2 id="Basic-Broadcast-Attack"><a href="#Basic-Broadcast-Attack" class="headerlink" title="Basic Broadcast Attack"></a>Basic Broadcast Attack</h2><h3 id="攻击条件-6"><a href="#攻击条件-6" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>如果一个用户使用同一个加密指数 e 加密了同一个密文，并发送给了其他 e 个用户。那么就会产生广播攻击。这一攻击由 Håstad 提出。</p>
<h3 id="攻击原理-6"><a href="#攻击原理-6" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>这里我们假设 e 为 3，并且加密者使用了三个不同的模数 $n_1,n_2,n_3$ 给三个不同的用户发送了加密后的消息 m，如下</p>
<p>$$<br>\begin{align}<br>c_1&amp;=m^3\bmod n_1 \<br>c_2&amp;=m^3\bmod n_2 \<br>c_3&amp;=m^3\bmod n_3<br>\end{align}<br>$$</p>
<p>这里我们假设 $n_1,n_2,n_3$ 互素，不然，我们就可以直接进行分解，然后得到 d，进而然后直接解密。</p>
<p>同时，我们假设 $m&lt;n_i, 1\leq i \leq 3$。如果这个条件不满足的话，就会使得情况变得比较复杂，这里我们暂不讨论。</p>
<p>既然他们互素，那么我们可以根据中国剩余定理，可得$m^3 \equiv C \bmod n_1n_2n_3$。</p>
<p>此外，既然 $m&lt;n_i, 1\leq i \leq 3$，那么我们知道 $m^3 &lt; n_1n_2n_3$ 并且 $C&lt;m^3 &lt; n_1n_2n_3$，那么 $m^3 = C$，我们对 C 开三次根即可得到 m 的值。</p>
<p>对于较大的 e 来说，我们只是需要更多的明密文对。</p>
<h3 id="SCTF-RSA3-LEVEL4"><a href="#SCTF-RSA3-LEVEL4" class="headerlink" title="SCTF RSA3 LEVEL4"></a>SCTF RSA3 LEVEL4</h3><p>参考 <a href="http://ohroot.com/2016/07/11/rsa-in-ctf。" target="_blank" rel="noopener">http://ohroot.com/2016/07/11/rsa-in-ctf。</a></p>
<p>这里我们以 SCTF RSA3 中的 level4 为例进行介绍，首先编写代码提取 cap 包中的数据，如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">#!/usr/bin/env python

from scapy.all import *
import zlib
import struct

PA = 24
packets = rdpcap('./syc_security_system_traffic3.pcap')
client = '192.168.1.180'
list_n = []
list_m = []
list_id = []
data = []
for packet in packets:
    # TCP Flag PA 24 means carry data
    if packet[TCP].flags == PA or packet[TCP].flags == PA + 1:
        src = packet[IP].src
        raw_data = packet[TCP].load
        head = raw_data.strip()[:7]
        if head == "We have":
            n, e = raw_data.strip().replace("We have got N is ",
                                            "").split('\ne is ')
            data.append(n.strip())
        if head == "encrypt":
            m = raw_data.replace('encrypted messages is 0x', '').strip()
            data.append(str(int(m, 16)))

with open('./data.txt', 'w') as f:
    for i in range(0, len(data), 2):
        tmp = ','.join(s for s in data[i:i + 2])
        f.write(tmp + '\n')
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其次，利用得到的数据直接使用中国剩余定理求解。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> reduce
<span class="token keyword">import</span> gmpy
<span class="token keyword">import</span> json<span class="token punctuation">,</span> binascii


<span class="token keyword">def</span> <span class="token function">modinv</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>gmpy<span class="token punctuation">.</span>mpz<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> gmpy<span class="token punctuation">.</span>mpz<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">chinese_remainder</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sum <span class="token operator">=</span> <span class="token number">0</span>
    prod <span class="token operator">=</span> reduce<span class="token punctuation">(</span><span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b<span class="token punctuation">:</span> a <span class="token operator">*</span> b<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 并行运算</span>
    <span class="token keyword">for</span> n_i<span class="token punctuation">,</span> a_i <span class="token keyword">in</span> zip<span class="token punctuation">(</span>n<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> prod <span class="token operator">//</span> n_i
        sum <span class="token operator">+=</span> a_i <span class="token operator">*</span> modinv<span class="token punctuation">(</span>p<span class="token punctuation">,</span> n_i<span class="token punctuation">)</span> <span class="token operator">*</span> p
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>sum <span class="token operator">%</span> prod<span class="token punctuation">)</span>


nset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
cset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    now <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> now<span class="token punctuation">:</span>
        item <span class="token operator">=</span> item<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        nset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

m <span class="token operator">=</span> chinese_remainder<span class="token punctuation">(</span>nset<span class="token punctuation">,</span> cset<span class="token punctuation">)</span>
m <span class="token operator">=</span> int<span class="token punctuation">(</span>gmpy<span class="token punctuation">.</span>mpz<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span>root<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到密文，然后再次解密即可得到 flag。</p>
<pre class="line-numbers language-shell"><code class="language-shell">H1sTaDs_B40aDcadt_attaCk_e_are_same_and_smA9l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="题目-3"><a href="#题目-3" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2017 WHCTF OldDriver</li>
<li>2018 N1CTF easy_fs</li>
</ul>
<h2 id="Broadcast-Attack-with-Linear-Padding"><a href="#Broadcast-Attack-with-Linear-Padding" class="headerlink" title="Broadcast Attack with Linear Padding"></a>Broadcast Attack with Linear Padding</h2><p>对于具有线性填充的情况下，仍然可以攻击，这时候就会使用 <strong>Coppersmith method</strong> 的方法了，这里暂不介绍。可以参考</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Coppersmith%27s_attack#Generalizations" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Coppersmith%27s_attack#Generalizations</a></li>
</ul>
<h2 id="Related-Message-Attack"><a href="#Related-Message-Attack" class="headerlink" title="Related Message Attack"></a>Related Message Attack</h2><h3 id="攻击条件-7"><a href="#攻击条件-7" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>当 Alice 使用同一公钥对两个具有某种线性关系的消息 M1 与 M2 进行加密，并将加密后的消息 C1，C2 发送给了 Bob 时，我们就可能可以获得对应的消息 M1 与 M2。这里我们假设模数为 N，两者之间的线性关系如下</p>
<p>$$<br>M_1 \equiv f(M_2) \bmod N<br>$$</p>
<p>其中 f 为一个线性函数，比如说 $f=ax+b$。</p>
<p>在具有较小错误概率下的情况下，其复杂度为 $O(elog^2N)$。</p>
<p>这一攻击由 Franklin，Reiter 提出。</p>
<h3 id="攻击原理-7"><a href="#攻击原理-7" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>首先，我们知道 $C_1 \equiv M_1 ^e \bmod N$，并且 $M_1 \equiv f(M_2) \bmod N$，那么我们可以知道 $M_2$ 是 $f(x)^e \equiv C_1 \bmod N$ 的一个解，即它是方程 $f(x)^e-C_1$ 在模 N 意义下的一个根。同样的，$M_2$ 是 $x^e - C_2$ 在模 N 意义下的一个根。所以说 $x-M_2$ 同时整除以上两个多项式。因此，我们可以求得两个多项式的最大公因子，如果最大公因子恰好是线性的话，那么我们就求得了 $M_2$。需要注意的是，在 $e=3$ 的情况下，最大公因子一定是线性的。</p>
<p>这里我们关注一下 $e=3$，且 $f(x)=ax+b$ 的情况。首先我们有</p>
<p>$$<br>C_1 \equiv M_1 ^3 \bmod N,M_1 \equiv aM_2+b \bmod N<br>$$</p>
<p>那么我们有</p>
<p>$$<br>C_1 \equiv (aM_2+b)^3 \bmod N,C_2 \equiv M_2^3 \bmod N<br>$$</p>
<p>我们需要明确一下我们想要得到的是消息 m，所以需要将其单独构造出来。</p>
<p>首先，我们有式 1</p>
<p>$$<br>(aM_2+b)^3=a^3M_2^3+3a^2M^2b+3aM_2b^2+b^3<br>$$</p>
<p>再者我们构造如下式 2</p>
<p>$$<br>(aM_2)^3-b^3 \equiv (aM_2-b)(a^2M_2^2+aM_2b+b^2) \bmod N<br>$$</p>
<p>根据式 1 我们有</p>
<p>$$<br>a^3M_2^3-2b^3+3b(a^2M_2^2+aM_2b+b^2) \equiv C_1 \bmod N<br>$$</p>
<p>继而我们有式 3</p>
<p>$$<br>3b(a^2M_2^2+aM_2b+b^2) \equiv C_1-a^3C_2+2b^3 \bmod N<br>$$</p>
<p>那么我们根据式 2 与式 3 可得</p>
<p>$$<br>(a^3C_2-b^3)*3b \equiv (aM_2-b)( C_1-a^3C_2+2b^3 ) \bmod N<br>$$</p>
<p>进而我们有</p>
<p>$$<br>aM_2-b=\frac{3a^3bC_2-3b^4}{C_1-a^3C_2+2b^3}<br>$$</p>
<p>进而</p>
<p>$$<br>aM_2\equiv  \frac{2a^3bC_2-b^4+C_1b}{C_1-a^3C_2+2b^3}<br>$$</p>
<p>进而</p>
<p>$$<br>M_2 \equiv\frac{2a^3bC_2-b^4+C_1b}{aC_1-a^4C_2+2ab^3}=\frac{b}{a}\frac{C_1+2a^3C_2-b^3}{C_1-a^3C_2+2b^3}<br>$$</p>
<p>上面的式子中右边所有的内容都是已知的内容，所以我们可以直接获取对应的消息。</p>
<p>有兴趣的可以进一步阅读 <a href="https://www.iacr.org/archive/pkc2005/33860001/33860001.pdf" target="_blank" rel="noopener">A New Related Message Attack on RSA</a> 以及 <a href="https://www.cs.unc.edu/~reiter/papers/1996/Eurocrypt.pdf" target="_blank" rel="noopener">paper</a> 这里暂不做过多的讲解。</p>
<h3 id="SCTF-RSA3"><a href="#SCTF-RSA3" class="headerlink" title="SCTF RSA3"></a>SCTF RSA3</h3><p>这里我们以 SCTF RSA3 中的 level3 为例进行介绍。首先，跟踪 TCP 流可以知道，加密方式是将明文加上用户的 user id 进行加密，而且还存在多组。这里我们选择第 0 组和第 9 组，他们的模数一样，解密脚本如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
id1 <span class="token operator">=</span> <span class="token number">1002</span>
id2 <span class="token operator">=</span> <span class="token number">2614</span>

c1 <span class="token operator">=</span> 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718L
c2 <span class="token operator">=</span> 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c72722fe4fe5a901e2531b3dbcb87e5aa19bbceecbf9f32eacefe81777d9bdca781b1ec8f8b68799b4aa4c6ad120506222c7f0c3e11b37dd0ce08381fabf9c14bc74929bf524645989ae2df77c8608d0512c1cc4150765ab8350843b57a2464f848d8e08L
n <span class="token operator">=</span> <span class="token number">25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553</span>
a <span class="token operator">=</span> <span class="token number">1</span>
b <span class="token operator">=</span> id1 <span class="token operator">-</span> id2


<span class="token keyword">def</span> <span class="token function">getmessage</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    b3 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    part1 <span class="token operator">=</span> b <span class="token operator">*</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> c2 <span class="token operator">-</span> b3<span class="token punctuation">)</span> <span class="token operator">%</span> n
    part2 <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token punctuation">(</span>c1 <span class="token operator">-</span> c2 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> b3<span class="token punctuation">)</span> <span class="token operator">%</span> n
    part2 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>part2<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token keyword">return</span> part1 <span class="token operator">*</span> part2 <span class="token operator">%</span> n


message <span class="token operator">=</span> getmessage<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">-</span> id2
message <span class="token operator">=</span> hex<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> len<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> message

<span class="token keyword">print</span> message<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到明文</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  sctf-rsa3-level3 git:(master) ✗ python exp.py
F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>当然，我们也可以直接使用 sage 来做，会更加简单一点。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> binascii

<span class="token keyword">def</span> <span class="token function">attack</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> b<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">>=</span>PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    g1 <span class="token operator">=</span> x<span class="token operator">^</span>e <span class="token operator">-</span> c1
    g2 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">^</span>e <span class="token operator">-</span> c2

    <span class="token keyword">def</span> <span class="token function">gcd</span><span class="token punctuation">(</span>g1<span class="token punctuation">,</span> g2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> g2<span class="token punctuation">:</span>
            g1<span class="token punctuation">,</span> g2 <span class="token operator">=</span> g2<span class="token punctuation">,</span> g1 <span class="token operator">%</span> g2
        <span class="token keyword">return</span> g1<span class="token punctuation">.</span>monic<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>gcd<span class="token punctuation">(</span>g1<span class="token punctuation">,</span> g2<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

c1 <span class="token operator">=</span> 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718L
c2 <span class="token operator">=</span> 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c72722fe4fe5a901e2531b3dbcb87e5aa19bbceecbf9f32eacefe81777d9bdca781b1ec8f8b68799b4aa4c6ad120506222c7f0c3e11b37dd0ce08381fabf9c14bc74929bf524645989ae2df77c8608d0512c1cc4150765ab8350843b57a2464f848d8e08L
n <span class="token operator">=</span> <span class="token number">25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553</span>
e<span class="token operator">=</span><span class="token number">3</span>
a <span class="token operator">=</span> <span class="token number">1</span>
id1 <span class="token operator">=</span> <span class="token number">1002</span>
id2 <span class="token operator">=</span> <span class="token number">2614</span>
b <span class="token operator">=</span> id2 <span class="token operator">-</span> id1
m1 <span class="token operator">=</span> attack<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">,</span> b<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
<span class="token keyword">print</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span><span class="token string">"%x"</span> <span class="token operator">%</span> int<span class="token punctuation">(</span>m1 <span class="token operator">-</span> id1<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  sctf-rsa3-level3 git:(master) ✗ sage exp.sage
sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="题目-4"><a href="#题目-4" class="headerlink" title="题目"></a>题目</h3><ul>
<li>hitcon 2014 rsaha</li>
<li>N1CTF 2018 rsa_padding</li>
</ul>
<h2 id="Coppersmith’s-short-pad-attack"><a href="#Coppersmith’s-short-pad-attack" class="headerlink" title="Coppersmith’s short-pad attack"></a>Coppersmith’s short-pad attack</h2><h3 id="攻击条件-8"><a href="#攻击条件-8" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>目前在大部分消息加密之前都会进行 padding，但是如果 padding 的长度过短，也有<strong>可能</strong>被很容易地攻击。</p>
<p>这里所谓 padding 过短，其实就是对应的多项式的根会过小。</p>
<h3 id="攻击原理-8"><a href="#攻击原理-8" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>我们假设爱丽丝要给鲍勃发送消息，首先爱丽丝对要加密的消息 M 进行随机 padding，然后加密得到密文 C1，发送给鲍勃。这时，中间人皮特截获了密文。一段时间后，爱丽丝没有收到鲍勃的回复，再次对要加密的消息 M 进行随机 padding，然后加密得到密文 C2，发送给 Bob。皮特再一次截获。这时，皮特就<strong>可能</strong>可以利用如下原理解密。</p>
<p>这里我们假设模数 N 的长度为 k，并且 padding 的长度为 $m=\lfloor \frac{k}{e^2} \rfloor$。此外，假设要加密的消息的长度最多为 k-m 比特，padding 的方式如下</p>
<p>$$<br>M_1=2^mM+r_1, 0\leq r_1\leq 2^m<br>$$</p>
<p>消息 M2 的 padding 方式类似。</p>
<p>那么我们可以利用如下的方式来解密。</p>
<p>首先定义</p>
<p>$$<br>g_1(x,y)=x^e-C_1<br>g_2(x,y)=(x+y)^e-C_2<br>$$</p>
<p>其中 $y=r_2-r_1$。显然这两个方程具有相同的根 M1。然后还有一系列的推导。</p>
<h2 id="Known-High-Bits-Message-Attack"><a href="#Known-High-Bits-Message-Attack" class="headerlink" title="Known High Bits Message Attack"></a>Known High Bits Message Attack</h2><h3 id="攻击条件-9"><a href="#攻击条件-9" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>这里我们假设我们首先加密了消息 m，如下</p>
<p>$$<br>C\equiv m^d \bmod N<br>$$</p>
<p>并且我们假设我们知道消息 m 的很大的一部分 $m_0$，即 $m=m_0+x$，但是我们不知道 $x$。那么我们就有可能通过该方法进行恢复消息。这里我们不知道的 x 其实就是多项式的根，需要满足 Coppersmith 的约束。</p>
<p>可以参考 <a href="https://github.com/mimoo/RSA-and-LLL-attacks。" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks。</a></p>
<h2 id="Factoring-with-High-Bits-Known"><a href="#Factoring-with-High-Bits-Known" class="headerlink" title="Factoring with High Bits Known"></a>Factoring with High Bits Known</h2><h3 id="攻击条件-10"><a href="#攻击条件-10" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>当我们知道一个公钥中模数 N 的一个因子的较高位时，我们就有一定几率来分解 N。</p>
<h3 id="攻击工具"><a href="#攻击工具" class="headerlink" title="攻击工具"></a>攻击工具</h3><p>请参考 <a href="https://github.com/mimoo/RSA-and-LLL-attacks。上面有使用教程。关注下面的代码" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks。上面有使用教程。关注下面的代码</a></p>
<pre class="line-numbers language-python"><code class="language-python">beta <span class="token operator">=</span> <span class="token number">0.5</span>
dd <span class="token operator">=</span> f<span class="token punctuation">.</span>degree<span class="token punctuation">(</span><span class="token punctuation">)</span>
epsilon <span class="token operator">=</span> beta <span class="token operator">/</span> <span class="token number">7</span>
mm <span class="token operator">=</span> ceil<span class="token punctuation">(</span>beta<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">/</span> <span class="token punctuation">(</span>dd <span class="token operator">*</span> epsilon<span class="token punctuation">)</span><span class="token punctuation">)</span>
tt <span class="token operator">=</span> floor<span class="token punctuation">(</span>dd <span class="token operator">*</span> mm <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span>beta<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
XX <span class="token operator">=</span> ceil<span class="token punctuation">(</span>N<span class="token operator">**</span><span class="token punctuation">(</span><span class="token punctuation">(</span>beta<span class="token operator">**</span><span class="token number">2</span><span class="token operator">/</span>dd<span class="token punctuation">)</span> <span class="token operator">-</span> epsilon<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000000000000000000000000000000000</span>
roots <span class="token operator">=</span> coppersmith_howgrave_univariate<span class="token punctuation">(</span>f<span class="token punctuation">,</span> N<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> mm<span class="token punctuation">,</span> tt<span class="token punctuation">,</span> XX<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，</p>
<ul>
<li>必须满足 $q\geq N^{beta}$，所以这里给出了$beta=0.5$，显然两个因数中必然有一个是大于的。</li>
<li>XX 是 $f(x)=q’+x$ 在模 q 意义下的根的上界，自然我们可以选择调整它，这里其实也表明了我们已知的 $q’$ 与因数 q 之间可能的差距。</li>
</ul>
<h3 id="2016-HCTF-RSA2"><a href="#2016-HCTF-RSA2" class="headerlink" title="2016 HCTF RSA2"></a>2016 HCTF RSA2</h3><p>这里我们以 2016 年 HCTF 中的 RSA2 为例进行介绍。</p>
<p>首先程序的开头是一个绕过验证的，绕过即可，代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha512
sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
<span class="token keyword">def</span> <span class="token function">sha512_proof</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> verify<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    pading <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            i <span class="token operator">=</span> randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            pading <span class="token operator">+=</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>pading<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">200</span><span class="token punctuation">:</span>
                pading <span class="token operator">=</span> pading<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true">#print pading</span>
        <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        r <span class="token operator">=</span> sha512<span class="token punctuation">(</span>prefix <span class="token operator">+</span> pading<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> verify <span class="token keyword">in</span> r<span class="token punctuation">:</span>
            <span class="token keyword">return</span> pading


<span class="token keyword">def</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Prefix: "</span><span class="token punctuation">)</span>
    prefix <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> len<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
    prefix <span class="token operator">=</span> prefix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    prefix <span class="token operator">=</span> prefix<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    proof <span class="token operator">=</span> sha512_proof<span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> <span class="token string">"fffffff"</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>proof<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    verify<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'verify success'</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"token: "</span><span class="token punctuation">)</span>
    token <span class="token operator">=</span> <span class="token string">"5c9597f3c8245907ea71a89d9d39d08e"</span>
    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>token<span class="token punctuation">)</span>

    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"n: "</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> sh<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> int<span class="token punctuation">(</span>n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"e: "</span><span class="token punctuation">)</span>
    e <span class="token operator">=</span> sh<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    e <span class="token operator">=</span> int<span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"e2: "</span><span class="token punctuation">)</span>
    e2 <span class="token operator">=</span> sh<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    e2 <span class="token operator">=</span> int<span class="token punctuation">(</span>e2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"is: "</span><span class="token punctuation">)</span>
    enc_flag <span class="token operator">=</span> sh<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    enc_flag <span class="token operator">=</span> int<span class="token punctuation">(</span>enc_flag<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"n: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"e: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"e2: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>e2<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"flag: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>enc_flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们也已经得到 n，e，e2，加密后的 flag 了，如下</p>
<pre class="line-numbers language-python"><code class="language-python">n<span class="token punctuation">:</span>  <span class="token number">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
e<span class="token punctuation">:</span>  <span class="token number">0x10001</span>
e2<span class="token punctuation">:</span>  <span class="token number">0xf93b</span>
flag<span class="token punctuation">:</span>  <span class="token number">0xf11e932fa420790ca3976468dc4df1e6b20519ebfdc427c09e06940e1ef0ca566d41714dc1545ddbdcae626eb51c7fa52608384a36a2a021960d71023b5d0f63e6b38b46ac945ddafea42f01d24cc33ce16825df7aa61395d13617ae619dca2df15b5963c77d6ededf2fe06fd36ae8c5ce0e3c21d72f2d7f20cd9a8696fbb628df29299a6b836c418cbfe91e2b5be74bdfdb4efdd1b33f57ebb72c5246d5dce635529f1f69634d565a631e950d4a34a02281cbed177b5a624932c2bc02f0c8fd9afd332ccf93af5048f02b8bd72213d6a52930b0faa0926973883136d8530b8acf732aede8bb71cb187691ebd93a0ea8aeec7f82d0b8b74bcf010c8a38a1fa8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们来分析主程序。可以看出</p>
<pre class="line-numbers language-python"><code class="language-python">    p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e <span class="token operator">=</span> gen_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> p <span class="token operator">*</span> q
    phi_n <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> invmod<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        e2 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x10000</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gcd<span class="token punctuation">(</span>e2<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们得到的 $n=p \times q$。而 p，q 以及我们已知的 e 都在 <code>gen_key</code> 函数中生成。看一看 <code>gen_key</code> 函数</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gen_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> gcd<span class="token punctuation">(</span>e<span class="token punctuation">,</span> p<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    q_t <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    n_t <span class="token operator">=</span> p <span class="token operator">*</span> q_t
    t <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>n_t<span class="token punctuation">,</span> k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>n_t<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>k<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    p4 <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    u <span class="token operator">=</span> pi_b<span class="token punctuation">(</span>p4<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> long_to_bytes<span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">+</span> long_to_bytes<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> n <span class="token operator">/</span> p
    <span class="token keyword">if</span> q <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        q <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> isPrime<span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token operator">and</span> gcd<span class="token punctuation">(</span>e<span class="token punctuation">,</span> q<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        m <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        q <span class="token operator">^</span><span class="token operator">=</span> m
    <span class="token keyword">return</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中我们已知如下参数</p>
<p>$$<br>k=2048<br>e=0x10001<br>$$</p>
<p>首先，程序先得到了 1024 比特位的素数 p，并且 <code>gcd(2,p-1)=1</code>。</p>
<p>然后，程序又得到了一个 1024 比特位的素数 $q_t$，并且计算 $n_t=p \times q_t$。</p>
<p>下面多次调用了 <code>get_bit</code> 函数，我们来简单分析一下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_bit</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> n_bit<span class="token punctuation">,</span> dire<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    dire:
        1: left
        0: right
    '''</span>

    <span class="token keyword">if</span> dire<span class="token punctuation">:</span>
        sn <span class="token operator">=</span> size<span class="token punctuation">(</span>number<span class="token punctuation">)</span>
        <span class="token keyword">if</span> sn <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            sn <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> sn <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> number <span class="token operator">>></span> <span class="token punctuation">(</span>sn<span class="token operator">-</span>n_bit<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> number <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n_bit<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出根据 <code>dire(ction)</code> 的不同，会得到不同的数</p>
<ul>
<li><code>dire=1</code> 时，程序首先计算 <code>number</code> 的二进制位数 <code>sn</code>，如果不是 8 的整数倍的话，就将 <code>sn</code> 增大为 8 的整数倍，然后返回 <code>number</code> 右移 <code>sn-n_bit</code> 的数字。其实 就是最多保留 <code>number</code> 的 <code>n_bit</code> 位。</li>
<li><code>dire=0</code> 时，程序直接获取 <code>number</code> 的低 <code>n_bit</code> 位。</li>
</ul>
<p>然后我们再来看程序</p>
<pre class="line-numbers language-python"><code class="language-python">    t <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>n_t<span class="token punctuation">,</span> k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>n_t<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>k<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    p4 <span class="token operator">=</span> get_bit<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这三个操作分别做了如下的事情</p>
<ul>
<li><code>t</code> 为 <code>n_t</code> 的最多高 k/16 位，即 128 位，位数不固定。</li>
<li><code>y</code> 为 <code>n_t</code> 的低 5*k/8 位，即 1280 位，位数固定。</li>
<li><code>p4</code> 为 p 的最多高 5*k/16 位，即 640 位，位数不固定。</li>
</ul>
<p>此后，程序有如下操作</p>
<pre class="line-numbers language-python"><code class="language-python">    u <span class="token operator">=</span> pi_b<span class="token punctuation">(</span>p4<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>利用 <code>pi_b</code> 对 <code>p4</code> 进行了加密</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">pi_b</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    m:
        1: encrypt
        0: decrypt
    '''</span>
    enc <span class="token operator">=</span> DES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> m<span class="token punctuation">:</span>
        method <span class="token operator">=</span> enc<span class="token punctuation">.</span>encrypt
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        method <span class="token operator">=</span> enc<span class="token punctuation">.</span>decrypt
    s <span class="token operator">=</span> long_to_bytes<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    sp <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">[</span>a<span class="token punctuation">:</span>a<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    r <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> a <span class="token keyword">in</span> sp<span class="token punctuation">:</span>
        r <span class="token operator">+=</span> method<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">return</span> bytes_to_long<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，我们已知了密钥 key，所以只要我们有密文就可以解密。此外，可以看到的是程序是对传入的消息进行 8 字节分组，采用密码本方式加密，所以密文之间互不影响。</p>
<p>下面</p>
<pre class="line-numbers language-python"><code class="language-python">    n <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> long_to_bytes<span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">+</span> long_to_bytes<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    q <span class="token operator">=</span> n <span class="token operator">/</span> p
    <span class="token keyword">if</span> q <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        q <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> isPrime<span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token operator">and</span> gcd<span class="token punctuation">(</span>e<span class="token punctuation">,</span> q<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        m <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        q <span class="token operator">^</span><span class="token operator">=</span> m
    <span class="token keyword">return</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序将 t，u，y 拼接在一起得到 n，进而，程序得到了 q，并对 q 的低 k/16 位做了抑或，然后返回 <code>q'</code>。</p>
<p>在主程序里，再一次得到了 <code>n'=p*q'</code>。这里我们仔细分析一下</p>
<pre><code>n'=p * ( q + random(2^{k/16}))</code></pre><p>而 p 是 k/2 位的，所以说，random 的部分最多可以影响原来的 n 的最低的 $k/2+k/16=9k/16$ 比特位。</p>
<p>而，我们还知道 n 的最低的 5k/8=10k/16 比特为其实就是 y，所以其并没有影响到 u，即使影响到也就最多影响到一位。</p>
<p>所以我们首先可以利用我们得到的 n 来获取 u，如下</p>
<pre><code>u=hex(n)[2:-1][-480:-320]</code></pre><p>虽然，这样可能会获得较多位数的 u，但是这样并不影响，我们对 u 解密的时候每一分组都互不影响，所以我们只可能影响最高位数的 p4。而 p4 的的高 8 位也有可能是填充的。但这也并不影响，我们已经得到了因子 p 的的很多部分了，我们可以去尝试着解密了。如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> <span class="token number">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
    u <span class="token operator">=</span> hex<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">480</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">320</span><span class="token punctuation">]</span>
    u <span class="token operator">=</span> int<span class="token punctuation">(</span>u<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    p4 <span class="token operator">=</span> pi_b<span class="token punctuation">(</span>u<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解密结果如下</p>
<pre class="line-numbers language-python"><code class="language-python">➜  <span class="token number">2016</span><span class="token operator">-</span>HCTF<span class="token operator">-</span>RSA2 git<span class="token punctuation">:</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ python exp_p4<span class="token punctuation">.</span>py
0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde1362693L<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>下面，我们直接使用 sage 来解密，这里 sage 里面已经实现了这个攻击，我们直接拿来用就好</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sage<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> binascii
n <span class="token operator">=</span> <span class="token number">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
p4 <span class="token operator">=</span><span class="token number">0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde1362693</span>
cipher <span class="token operator">=</span> <span class="token number">0xf11e932fa420790ca3976468dc4df1e6b20519ebfdc427c09e06940e1ef0ca566d41714dc1545ddbdcae626eb51c7fa52608384a36a2a021960d71023b5d0f63e6b38b46ac945ddafea42f01d24cc33ce16825df7aa61395d13617ae619dca2df15b5963c77d6ededf2fe06fd36ae8c5ce0e3c21d72f2d7f20cd9a8696fbb628df29299a6b836c418cbfe91e2b5be74bdfdb4efdd1b33f57ebb72c5246d5dce635529f1f69634d565a631e950d4a34a02281cbed177b5a624932c2bc02f0c8fd9afd332ccf93af5048f02b8bd72213d6a52930b0faa0926973883136d8530b8acf732aede8bb71cb187691ebd93a0ea8aeec7f82d0b8b74bcf010c8a38a1fa8</span>
e2 <span class="token operator">=</span> <span class="token number">0xf93b</span>
pbits <span class="token operator">=</span> <span class="token number">1024</span>
kbits <span class="token operator">=</span> pbits <span class="token operator">-</span> p4<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> p4<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>
p4 <span class="token operator">=</span> p4 <span class="token operator">&lt;&lt;</span> kbits
PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
f <span class="token operator">=</span> x <span class="token operator">+</span> p4
roots <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> roots<span class="token punctuation">:</span>
    p <span class="token operator">=</span> p4<span class="token operator">+</span>int<span class="token punctuation">(</span>roots<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"p: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>int<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> n <span class="token operator">%</span> p <span class="token operator">==</span> <span class="token number">0</span>
    q <span class="token operator">=</span> n<span class="token operator">/</span>int<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"q: "</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>int<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> gcd<span class="token punctuation">(</span>p<span class="token punctuation">,</span>q<span class="token punctuation">)</span>
    phin <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> gcd<span class="token punctuation">(</span>e2<span class="token punctuation">,</span>phin<span class="token punctuation">)</span>
    d <span class="token operator">=</span> inverse_mod<span class="token punctuation">(</span>e2<span class="token punctuation">,</span>phin<span class="token punctuation">)</span>
    flag <span class="token operator">=</span> pow<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span>d<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
    flag <span class="token operator">=</span> hex<span class="token punctuation">(</span>int<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于 <code>small_roots</code> 的使用，可以参考 <a href="http://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polynomial_modn_dense_ntl.html#sage.rings.polynomial.polynomial_modn_dense_ntl.small_roots" target="_blank" rel="noopener">SAGE 说明</a>。</p>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2016-HCTF-RSA2 git:(master) ✗ sage payload.sage
sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
640
p:  0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde13626933aa6762057e1df53d27356ee6a09b17ef4f4986d862e3bb24f99446a0ab2385228295f4b776c1f391ab2a0d8c0dec1e5L
q:  0xb306030a7c6ace771db8adb45fae597f3c1be739d79fd39dfa6fd7f8c177e99eb29f0462c3f023e0530b545df6e656dadb984953c265b26f860b68aa6d304fa403b0b0e37183008592ec2a333c431e2906c9859d7cbc4386ef4c4407ead946d855ecd6a8b2067ad8a99b21111b26905fcf0d53a1b893547b46c3142b06061853L
1
1
hctf{d8e8fca2dc0f896fd7cb4cb0031ba249}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="题目-5"><a href="#题目-5" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2016 湖湘杯 简单的 RSA</li>
<li>2017 WHCTF Untitled</li>
</ul>
<h2 id="Boneh-and-Durfee-attack"><a href="#Boneh-and-Durfee-attack" class="headerlink" title="Boneh and Durfee attack"></a>Boneh and Durfee attack</h2><h3 id="攻击条件-11"><a href="#攻击条件-11" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>当 d 较小时，满足 $d &lt; N^{0.292}$ 时，我们可以利用该攻击，比 Wiener’s Attack 要强一些。</p>
<h3 id="攻击原理-9"><a href="#攻击原理-9" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>这里简单说一下原理。</p>
<p>首先</p>
<p>$$<br>ed \equiv 1 \bmod  \varphi(N)/2<br>$$</p>
<p>进而有</p>
<p>$$<br>ed +k\varphi(N)/2=1<br>$$</p>
<p>即</p>
<p>$$<br>k \varphi(N)/2 \equiv 1 \bmod e<br>$$</p>
<p>又</p>
<p>$$<br>\varphi(N)=(p-1)(q-1)=qp-p-q+1=N-p-q+1<br>$$</p>
<p>所以</p>
<p>$$<br>k(N-p-q+1)/2 \equiv 1 \bmod e<br>$$</p>
<p>假设 $A=\frac{N+1}{2}$，$y=\frac{-p-q}{2}$ ，原式可化为</p>
<p>$$<br>f(k,y)=k(A+y) \equiv 1 \bmod e<br>$$</p>
<p>其中</p>
<p>$|k|&lt;\frac{2ed}{\varphi(N)}&lt;\frac{3ed}{N}=3<em>\frac{e}{N}</em>d&lt;3<em>\frac{e}{N}</em>N^{delta}$</p>
<p>$|y|&lt;2*N^{0.5}$</p>
<p>y 的估计用到了 p、q 比较均匀的假设。这里 delta 为预估的小于 0.292 的值。</p>
<p>如果我们求得了该二元方程的根，那么我们自然也就可以解一元二次方程 $N=pq,p+q=-2y$ 来得到 p 与 q。</p>
<p>更加具体的推导，参考 New Results on the Cryptanalysis of Low Exponent RSA.</p>
<h3 id="攻击工具-1"><a href="#攻击工具-1" class="headerlink" title="攻击工具"></a>攻击工具</h3><p>请参考 <a href="https://github.com/mimoo/RSA-and-LLL-attacks" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks</a> 。上面有使用教程。</p>
<h3 id="2015-PlaidCTF-Curious"><a href="#2015-PlaidCTF-Curious" class="headerlink" title="2015 PlaidCTF Curious"></a>2015 PlaidCTF Curious</h3><p>这里我们以 2015 年 PlaidCTF Curious 为例进行介绍。</p>
<p>首先题目给了一堆 N，e，c。简单看一下可以发现该 e 比较大。这时候我们可以考虑使用 Wiener’s Attack，这里我们使用更强的目前介绍的攻击。</p>
<p>核心代码如下</p>
<pre class="line-numbers language-python"><code class="language-python">    nlist <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    elist <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    clist <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'captured'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># read the line {N : e : c} and do nothing with it</span>
        f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>N<span class="token punctuation">,</span> e<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" : "</span><span class="token punctuation">)</span>
            nlist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>long<span class="token punctuation">(</span>N<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            elist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>long<span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            clist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>long<span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>nlist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'index i'</span>
        n <span class="token operator">=</span> nlist<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        e <span class="token operator">=</span> elist<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        c <span class="token operator">=</span> clist<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        d <span class="token operator">=</span> solve<span class="token punctuation">(</span>n<span class="token punctuation">,</span>e<span class="token punctuation">)</span>
        <span class="token keyword">if</span> d<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            m <span class="token operator">=</span> power_mod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
            hex_string <span class="token operator">=</span> <span class="token string">"%x"</span> <span class="token operator">%</span> m
            <span class="token keyword">import</span> binascii
            <span class="token keyword">print</span> <span class="token string">"the plaintext:"</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>hex_string<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">=== solution found ===
private key found: 23974584842546960047080386914966001070087596246662608796022581200084145416583
the plaintext: flag_S0Y0UKN0WW13N3R$4TT4CK!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2019-Defcon-Quals-ASRybaB"><a href="#2019-Defcon-Quals-ASRybaB" class="headerlink" title="2019 Defcon Quals ASRybaB"></a>2019 Defcon Quals ASRybaB</h3><p>题目大概意思是，我们接收三对 RSA ，然后需要求出 d，然后对给定的数字 v[i] 加密，发送给服务器，只要时间在一定范围内，940s，即可。那难点自然在 create_key 函数了。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">send_challenges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    code <span class="token operator">=</span> marshal<span class="token punctuation">.</span>loads<span class="token punctuation">(</span><span class="token string">"63000000000d000000070000004300000073df010000740000721d0064010064020015000000000100640200157d00006e00007401007d01007c0100640300157d02006402007d0300786f007c03006a02008300007c01006b030072a400784c007403007296007404006a05007c02008301007d04007404006a05007c02008301007d05007406007c04007c0500188301006a02008300007c0100640400146b0400724b0050714b00714b00577c04007c0500147d0300713600577c0400640500187c050064050018147d06006406007d07006407007d080078090174030072ce017404006a07007408006403007409007c01007c0700148301008302007408006403007409007c01007c070014830100640500178302008302007d09007871007c09006a02008300007c01007c0800146b0000727b016402007d0a007844007404006a0a007c0a00830100736d017404006a0700740800640300640800830200740800640300640800830200740800640300640900830200178302007d0a00712a01577c09007c0a00397d0900710b01577404006a0b007c09007c06008302006405006b0300729a0171c6006e00007404006a0c007c09007c06008302007d0b007404006a0b007c0b007c06008302006405006b030072ca0171c6006e00005071c60057640a007d0c007c03007c0b0066020053280b0000004e690700000069000000006902000000675839b4c876bedf3f6901000000674e62105839b4d03f678d976e1283c0d23f692d000000690c0000006903000000280d000000740500000046616c736574050000004e53495a45740a0000006269745f6c656e67746874040000005472756574060000006e756d626572740e0000006765745374726f6e675072696d657403000000616273740e00000067657452616e646f6d52616e67657403000000706f777403000000696e74740700000069735072696d6574030000004743447407000000696e7665727365280d00000074010000007874050000004e73697a657406000000707173697a6574010000004e740100000070740100000071740300000070686974060000006c696d69743174060000006c696d697432740100000064740300000070707074010000006574030000007a7a7a2800000000280000000073150000002f6f726967696e616c6368616c6c656e67652e7079740a0000006372656174655f6b657917000000733e000000000106010a010d0206010a010601150109010f010f04200108010e0112020601060109013c0119010601120135020e011801060112011801060105020604"</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_key <span class="token operator">=</span> types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">(</span>code<span class="token punctuation">,</span> globals<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"create_key"</span><span class="token punctuation">)</span>

    ck <span class="token operator">=</span> create_key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以简单看看这个到底是在干啥</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> marshal
<span class="token operator">>></span><span class="token operator">></span> data<span class="token operator">=</span><span class="token string">"63000000000d000000070000004300000073df010000740000721d0064010064020015000000000100640200157d00006e00007401007d01007c0100640300157d02006402007d0300786f007c03006a02008300007c01006b030072a400784c007403007296007404006a05007c02008301007d04007404006a05007c02008301007d05007406007c04007c0500188301006a02008300007c0100640400146b0400724b0050714b00714b00577c04007c0500147d0300713600577c0400640500187c050064050018147d06006406007d07006407007d080078090174030072ce017404006a07007408006403007409007c01007c0700148301008302007408006403007409007c01007c070014830100640500178302008302007d09007871007c09006a02008300007c01007c0800146b0000727b016402007d0a007844007404006a0a007c0a00830100736d017404006a0700740800640300640800830200740800640300640800830200740800640300640900830200178302007d0a00712a01577c09007c0a00397d0900710b01577404006a0b007c09007c06008302006405006b0300729a0171c6006e00007404006a0c007c09007c06008302007d0b007404006a0b007c0b007c06008302006405006b030072ca0171c6006e00005071c60057640a007d0c007c03007c0b0066020053280b0000004e690700000069000000006902000000675839b4c876bedf3f6901000000674e62105839b4d03f678d976e1283c0d23f692d000000690c0000006903000000280d000000740500000046616c736574050000004e53495a45740a0000006269745f6c656e67746874040000005472756574060000006e756d626572740e0000006765745374726f6e675072696d657403000000616273740e00000067657452616e646f6d52616e67657403000000706f777403000000696e74740700000069735072696d6574030000004743447407000000696e7665727365280d00000074010000007874050000004e73697a657406000000707173697a6574010000004e740100000070740100000071740300000070686974060000006c696d69743174060000006c696d697432740100000064740300000070707074010000006574030000007a7a7a2800000000280000000073150000002f6f726967696e616c6368616c6c656e67652e7079740a0000006372656174655f6b657917000000733e000000000106010a010d0206010a010601150109010f010f04200108010e0112020601060109013c0119010601120135020e011801060112011801060105020604"</span>
<span class="token operator">>></span><span class="token operator">></span> code<span class="token operator">=</span>marshal<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> code<span class="token operator">=</span>marshal<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> dis
<span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
 <span class="token number">24</span>           <span class="token number">0</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
              <span class="token number">3</span> POP_JUMP_IF_FALSE       <span class="token number">29</span>

 <span class="token number">25</span>           <span class="token number">6</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
              <span class="token number">9</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token number">12</span> BINARY_DIVIDE
             <span class="token number">13</span> STOP_CODE
             <span class="token number">14</span> STOP_CODE
             <span class="token number">15</span> STOP_CODE
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">56</span>         <span class="token number">428</span> LOAD_GLOBAL              <span class="token number">4</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span>
            <span class="token number">431</span> LOAD_ATTR               <span class="token number">11</span> <span class="token punctuation">(</span>GCD<span class="token punctuation">)</span>
            <span class="token number">434</span> LOAD_FAST               <span class="token number">11</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token number">437</span> LOAD_FAST                <span class="token number">6</span> <span class="token punctuation">(</span>phi<span class="token punctuation">)</span>
            <span class="token number">440</span> CALL_FUNCTION            <span class="token number">2</span>
            <span class="token number">443</span> LOAD_CONST               <span class="token number">5</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token number">446</span> COMPARE_OP               <span class="token number">3</span> <span class="token punctuation">(</span><span class="token operator">!=</span><span class="token punctuation">)</span>
            <span class="token number">449</span> POP_JUMP_IF_FALSE      <span class="token number">458</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基本可以猜出来这是在生成 n，e，d，其实和我们最初的预期也差不多。我们来直接反编译一下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> uncompyle6 <span class="token keyword">import</span> code_deparse
<span class="token operator">>></span><span class="token operator">></span> code_deparse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
Instruction context<span class="token punctuation">:</span>

  <span class="token number">25</span>       <span class="token number">6</span>  LOAD_CONST            <span class="token number">1</span>  <span class="token number">7</span>
              <span class="token number">9</span>  LOAD_CONST            <span class="token number">2</span>  <span class="token number">0</span>
             <span class="token number">12</span>  BINARY_DIVIDE
<span class="token operator">-</span><span class="token operator">></span>           <span class="token number">13</span>  STOP_CODE
             <span class="token number">14</span>  STOP_CODE
             <span class="token number">15</span>  STOP_CODE
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
  File <span class="token string">"/usr/local/lib/python2.7/site-packages/uncompyle6/semantics/pysource.py"</span><span class="token punctuation">,</span> line <span class="token number">2310</span><span class="token punctuation">,</span> <span class="token keyword">in</span> code_deparse
    deparsed<span class="token punctuation">.</span>ast <span class="token operator">=</span> deparsed<span class="token punctuation">.</span>build_ast<span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> customize<span class="token punctuation">,</span> isTopLevel<span class="token operator">=</span>isTopLevel<span class="token punctuation">)</span>
  File <span class="token string">"/usr/local/lib/python2.7/site-packages/uncompyle6/semantics/pysource.py"</span><span class="token punctuation">,</span> line <span class="token number">2244</span><span class="token punctuation">,</span> <span class="token keyword">in</span> build_ast
    <span class="token keyword">raise</span> ParserError<span class="token punctuation">(</span>e<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span>
uncompyle6<span class="token punctuation">.</span>semantics<span class="token punctuation">.</span>parser_error<span class="token punctuation">.</span>ParserError<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> This code section failed<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">64</span>     <span class="token number">469</span>  LOAD_FAST             <span class="token number">3</span>  <span class="token string">'N'</span>
         <span class="token number">472</span>  LOAD_FAST            <span class="token number">11</span>  <span class="token string">'e'</span>
         <span class="token number">475</span>  BUILD_TUPLE_2         <span class="token number">2</span>  None
         <span class="token number">478</span>  RETURN_VALUE
          <span class="token operator">-</span><span class="token number">1</span>  RETURN_LAST

Parse error at <span class="token operator">or</span> near `STOP_CODE' instruction at offset <span class="token number">13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现 STOP_CODE，有点猫腻，如果仔细看最初的反汇编的话，我们可以发现最前面的那部分代码是在混淆</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
 <span class="token number">24</span>           <span class="token number">0</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
              <span class="token number">3</span> POP_JUMP_IF_FALSE       <span class="token number">29</span>

 <span class="token number">25</span>           <span class="token number">6</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
              <span class="token number">9</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token number">12</span> BINARY_DIVIDE
             <span class="token number">13</span> STOP_CODE
             <span class="token number">14</span> STOP_CODE
             <span class="token number">15</span> STOP_CODE

 <span class="token number">26</span>          <span class="token number">16</span> STOP_CODE
             <span class="token number">17</span> POP_TOP
             <span class="token number">18</span> STOP_CODE
             <span class="token number">19</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token number">22</span> BINARY_DIVIDE
             <span class="token number">23</span> STORE_FAST               <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
             <span class="token number">26</span> JUMP_FORWARD             <span class="token number">0</span> <span class="token punctuation">(</span>to <span class="token number">29</span><span class="token punctuation">)</span>

 <span class="token number">28</span>     <span class="token operator">>></span>   <span class="token number">29</span> LOAD_GLOBAL              <span class="token number">1</span> <span class="token punctuation">(</span>NSIZE<span class="token punctuation">)</span>
             <span class="token number">32</span> STORE_FAST               <span class="token number">1</span> <span class="token punctuation">(</span>Nsize<span class="token punctuation">)</span>

 <span class="token number">29</span>          <span class="token number">35</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>Nsize<span class="token punctuation">)</span>
             <span class="token number">38</span> LOAD_CONST               <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
             <span class="token number">41</span> BINARY_DIVIDE
             <span class="token number">42</span> STORE_FAST               <span class="token number">2</span> <span class="token punctuation">(</span>pqsize<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一直到</p>
<pre class="line-numbers language-python"><code class="language-python"> <span class="token number">29</span>          <span class="token number">35</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>Nsize<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>前面的都没有什么作用，感觉是出题者故意修改了代码。仔细分析一下这部分代码，感觉像是两部分</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># part 1</span>
 <span class="token number">25</span>           <span class="token number">6</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
              <span class="token number">9</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token number">12</span> BINARY_DIVIDE
             <span class="token number">13</span> STOP_CODE
             <span class="token number">14</span> STOP_CODE
             <span class="token number">15</span> STOP_CODE
<span class="token comment" spellcheck="true"># part 2</span>
 <span class="token number">26</span>          <span class="token number">16</span> STOP_CODE
             <span class="token number">17</span> POP_TOP
             <span class="token number">18</span> STOP_CODE
             <span class="token number">19</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token number">22</span> BINARY_DIVIDE
             <span class="token number">23</span> STORE_FAST               <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
             <span class="token number">26</span> JUMP_FORWARD             <span class="token number">0</span> <span class="token punctuation">(</span>to <span class="token number">29</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>正好是第 25 行和第 26 行，大概猜一猜，感觉两个都是 x=7/0，所以就想办法把这部分的代码修复一下，接下来就是定位这部分代码了。根据手册可以知道 STOP_CODE 是 0，从而我们可以定位第 25 行语句到 26 行语句为 t[6:26]，他们分别都是 10 字节(6-15,16-25)。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> t<span class="token operator">=</span>code<span class="token punctuation">.</span>co_code
<span class="token operator">>></span><span class="token operator">></span> t
<span class="token string">'t\x00\x00r\x1d\x00d\x01\x00d\x02\x00\x15\x00\x00\x00\x00\x01\x00d\x02\x00\x15}\x00\x00n\x00\x00t\x01\x00}\x01\x00|\x01\x00d\x03\x00\x15}\x02\x00d\x02\x00}\x03\x00xo\x00|\x03\x00j\x02\x00\x83\x00\x00|\x01\x00k\x03\x00r\xa4\x00xL\x00t\x03\x00r\x96\x00t\x04\x00j\x05\x00|\x02\x00\x83\x01\x00}\x04\x00t\x04\x00j\x05\x00|\x02\x00\x83\x01\x00}\x05\x00t\x06\x00|\x04\x00|\x05\x00\x18\x83\x01\x00j\x02\x00\x83\x00\x00|\x01\x00d\x04\x00\x14k\x04\x00rK\x00PqK\x00qK\x00W|\x04\x00|\x05\x00\x14}\x03\x00q6\x00W|\x04\x00d\x05\x00\x18|\x05\x00d\x05\x00\x18\x14}\x06\x00d\x06\x00}\x07\x00d\x07\x00}\x08\x00x\t\x01t\x03\x00r\xce\x01t\x04\x00j\x07\x00t\x08\x00d\x03\x00t\t\x00|\x01\x00|\x07\x00\x14\x83\x01\x00\x83\x02\x00t\x08\x00d\x03\x00t\t\x00|\x01\x00|\x07\x00\x14\x83\x01\x00d\x05\x00\x17\x83\x02\x00\x83\x02\x00}\t\x00xq\x00|\t\x00j\x02\x00\x83\x00\x00|\x01\x00|\x08\x00\x14k\x00\x00r{\x01d\x02\x00}\n\x00xD\x00t\x04\x00j\n\x00|\n\x00\x83\x01\x00sm\x01t\x04\x00j\x07\x00t\x08\x00d\x03\x00d\x08\x00\x83\x02\x00t\x08\x00d\x03\x00d\x08\x00\x83\x02\x00t\x08\x00d\x03\x00d\t\x00\x83\x02\x00\x17\x83\x02\x00}\n\x00q*\x01W|\t\x00|\n\x009}\t\x00q\x0b\x01Wt\x04\x00j\x0b\x00|\t\x00|\x06\x00\x83\x02\x00d\x05\x00k\x03\x00r\x9a\x01q\xc6\x00n\x00\x00t\x04\x00j\x0c\x00|\t\x00|\x06\x00\x83\x02\x00}\x0b\x00t\x04\x00j\x0b\x00|\x0b\x00|\x06\x00\x83\x02\x00d\x05\x00k\x03\x00r\xca\x01q\xc6\x00n\x00\x00Pq\xc6\x00Wd\n\x00}\x0c\x00|\x03\x00|\x0b\x00f\x02\x00S'</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">]</span>
<span class="token string">'d\x01\x00d\x02\x00\x15\x00\x00\x00\x00\x01\x00d\x02\x00\x15}\x00\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token string">'\x02\x00S'</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token operator">=</span><span class="token string">'d\x01\x00d\x02\x00\x15\x00\x00\x00\x00\x01\x00d\x02\x00\x15}\x00\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token string">'}\x00\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">+</span>t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token string">'d\x01\x00d\x02\x00\x15}\x00\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> _<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token string">'640100640200157d0000'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从而我们可以修复原 code</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> data<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'640100'</span><span class="token punctuation">)</span>
<span class="token number">56</span>
<span class="token operator">>></span><span class="token operator">></span> data1<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'640100640200157d0000640100640200157d0000'</span><span class="token operator">+</span>data<span class="token punctuation">[</span><span class="token number">56</span><span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> code1<span class="token operator">=</span>marshal<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> code_deparse<span class="token punctuation">(</span>code1<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">/</span> <span class="token number">0</span>
    x <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">/</span> <span class="token number">0</span>
Nsize <span class="token operator">=</span> NSIZE
pqsize <span class="token operator">=</span> Nsize <span class="token operator">/</span> <span class="token number">2</span>
N <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">while</span> N<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Nsize<span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> number<span class="token punctuation">.</span>getStrongPrime<span class="token punctuation">(</span>pqsize<span class="token punctuation">)</span>
        q <span class="token operator">=</span> number<span class="token punctuation">.</span>getStrongPrime<span class="token punctuation">(</span>pqsize<span class="token punctuation">)</span>
        <span class="token keyword">if</span> abs<span class="token punctuation">(</span>p <span class="token operator">-</span> q<span class="token punctuation">)</span><span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Nsize <span class="token operator">*</span> <span class="token number">0.496</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    N <span class="token operator">=</span> p <span class="token operator">*</span> q

phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
limit1 <span class="token operator">=</span> <span class="token number">0.261</span>
limit2 <span class="token operator">=</span> <span class="token number">0.293</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    d <span class="token operator">=</span> number<span class="token punctuation">.</span>getRandomRange<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>Nsize <span class="token operator">*</span> limit1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>Nsize <span class="token operator">*</span> limit1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> d<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> Nsize <span class="token operator">*</span> limit2<span class="token punctuation">:</span>
        ppp <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token operator">not</span> number<span class="token punctuation">.</span>isPrime<span class="token punctuation">(</span>ppp<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ppp <span class="token operator">=</span> number<span class="token punctuation">.</span>getRandomRange<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">+</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        d <span class="token operator">*=</span> ppp

    <span class="token keyword">if</span> number<span class="token punctuation">.</span>GCD<span class="token punctuation">(</span>d<span class="token punctuation">,</span> phi<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    e <span class="token operator">=</span> number<span class="token punctuation">.</span>inverse<span class="token punctuation">(</span>d<span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
    <span class="token keyword">if</span> number<span class="token punctuation">.</span>GCD<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">break</span>

zzz <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
 N<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token operator">&lt;</span>uncompyle6<span class="token punctuation">.</span>semantics<span class="token punctuation">.</span>pysource<span class="token punctuation">.</span>SourceWalker object at <span class="token number">0x10a0ea110</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到生成的 d 是故意超了 0.292 的，不过我们可以发现 ppp 范围很小，实际上我们可以测试得到这个范围的素数为 125 个。并且</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token number">1280</span><span class="token operator">*</span><span class="token number">0.261</span><span class="token operator">+</span><span class="token number">45</span><span class="token operator">=</span><span class="token number">379.08000000000004</span><span class="token operator">></span><span class="token number">375.03999999999996</span><span class="token operator">=</span><span class="token number">1280</span><span class="token operator">*</span><span class="token number">0.293</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>所以其实这里就乘了一个数，那么我们其实就可以枚举一下乘了什么，并修改 e1=e*ppp，其实就回归到标准的 Boneh and Durfee attack。</p>
<p>但是，如果我们直接使用 <a href="https://github.com/mimoo/RSA-and-LLL-attacks" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks</a> 的脚本也不行，必须得提高 m，基本得提到 8，这样仍然不是很稳定。</p>
<p>如果仔细尝试尝试的话，就会发现 e1&gt;N，这看起来问题不大，但是原脚本里假设的数值是 e&lt;N 的，所以我们需要进行适当的修改预估的上下界</p>
<pre class="line-numbers language-python"><code class="language-python">    X <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>floor<span class="token punctuation">(</span>N<span class="token operator">^</span>delta<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># this _might_ be too much</span>
    Y <span class="token operator">=</span> floor<span class="token punctuation">(</span>N<span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># correct if p, q are ~ same size</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>根据上述推导，上下界应该为</p>
<p>$ |k|&lt;\frac{2ed}{\varphi(N)}&lt;\frac{3ed}{N}=3<em>\frac{e}{N}</em>d&lt;3<em>\frac{e}{N}</em>N^{delta} $</p>
<p>$|y|&lt;2*N^{0.5}$</p>
<p>最后主要修改了 m 和 X 的上界</p>
<pre class="line-numbers language-python"><code class="language-python">    delta <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token number">262</span> <span class="token comment" spellcheck="true"># this means that d &lt; N^delta</span>

    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true"># Lattice (tweak those values)</span>
    <span class="token comment" spellcheck="true">#</span>

    <span class="token comment" spellcheck="true"># you should tweak this (after a first run), (e.g. increment it until a solution is found)</span>
    m <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment" spellcheck="true"># size of the lattice (bigger the better/slower)</span>

    <span class="token comment" spellcheck="true"># you need to be a lattice master to tweak these</span>
    t <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">*</span>delta<span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># optimization from Herrmann and May</span>
    X <span class="token operator">=</span> floor<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>e<span class="token operator">/</span>N<span class="token operator">*</span>N<span class="token operator">^</span>delta<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#4*floor(N^delta)  # this _might_ be too much</span>
    Y <span class="token operator">=</span> floor<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>N<span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># correct if p, q are ~ same size</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后可以得到结果</p>
<pre class="line-numbers language-shell"><code class="language-shell">[DEBUG] Received 0x1f bytes:
    'Succcess!\n'
    'OOO{Br3akingL!mits?}\n'
OOO{Br3akingL!mits?}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>不得不说这个题目，真的是需要<strong>多</strong>核服务器。</p>
<h1 id="RSA-选择明密文攻击"><a href="#RSA-选择明密文攻击" class="headerlink" title="RSA 选择明密文攻击"></a>RSA 选择明密文攻击</h1><h2 id="选择明文攻击"><a href="#选择明文攻击" class="headerlink" title="选择明文攻击"></a>选择明文攻击</h2><p>这里给出一个例子，假如我们有一个加密 oracle ，但是我们不知道 n 和 e，那</p>
<ol>
<li>我们可以通过加密 oracle 获取 n。</li>
<li>在 e 比较小（ $e&lt;2^{64}$）时，我们可以利用 <em>Pollard’s kangaroo algorithm</em> 算法获取 e。这一点比较显然。</li>
</ol>
<p>我们可以加密 2，4，8，16。那么我们可以知道</p>
<p>$c_2=2^{e} \bmod n$</p>
<p>$c_4=4^{e} \bmod n$</p>
<p>$c_8=8^{e} \bmod n$</p>
<p>那么</p>
<p>$c_2^2 \equiv c_4 \bmod n$</p>
<p>$c_2^3 \equiv c_8 \bmod n$</p>
<p>故而</p>
<p>$c_2^2-c_4=kn$</p>
<p>$c_2^3-c_8=tn$</p>
<p>我们可以求出 kn 和 tn 的最大公因数，很大概率就是 n 了。我们还可以构造更多的例子从来更加确定性地找 n。</p>
<h2 id="任意密文解密"><a href="#任意密文解密" class="headerlink" title="任意密文解密"></a>任意密文解密</h2><p>假设爱丽丝创建了密文 $C = P^e \bmod n$ 并且把 C 发送给鲍勃，同时假设我们要对爱丽丝加密后的任意密文解密，而不是只解密 C，那么我们可以拦截 C，并运用下列步骤求出 P：</p>
<ol>
<li>选择任意的 $X\in Z_n^{*}$，即 X 与 N 互素</li>
<li>计算 $Y=C \times X^e \bmod n$ </li>
<li>由于我们可以进行选择密文攻击，那么我们求得 Y 对应的解密结果 $Z=Y^d$</li>
<li>那么，由于 $Z=Y^d=(C \times X^e)^d=C^d X=P^{ed} X= P X\bmod n$，由于 X 与 N 互素，我们很容易求得相应的逆元，进而可以得到 P</li>
</ol>
<h2 id="RSA-parity-oracle"><a href="#RSA-parity-oracle" class="headerlink" title="RSA parity oracle"></a>RSA parity oracle</h2><p>假设目前存在一个 Oracle，它会对一个给定的密文进行解密，并且会检查解密的明文的奇偶性，并根据奇偶性返回相应的值，比如 1 表示奇数，0 表示偶数。那么给定一个加密后的密文，我们只需要 log(N) 次就可以知道这个密文对应的明文消息。</p>
<h3 id="原理-21"><a href="#原理-21" class="headerlink" title="原理"></a>原理</h3><p>假设</p>
<p>$C=P^e \bmod N$</p>
<p>第一次时，我们可以给服务器发送</p>
<p>$C*2^e=(2P)^e \bmod N$</p>
<p>服务器会计算得到</p>
<p>$2P \bmod N$</p>
<p>这里</p>
<ul>
<li>2P 是偶数，它的幂次也是偶数。</li>
<li>N 是奇数，因为它是由两个大素数相乘得到。</li>
</ul>
<p>那么</p>
<ul>
<li>服务器返回奇数，即 $2P \bmod N$ 为奇数，则说明 2P 大于 N，且减去了奇数个 N，又因为 $2P&lt;2N$，因此减去了一个N， 即 $\frac{N}{2} \leq P &lt; N$，我们还可以考虑向下取整。</li>
<li>服务器返回偶数，则说明 2P 小于 N。即 $0\leq P &lt; \frac{N}{2}$，我们还可以向下取整。</li>
</ul>
<p>这里我们使用数学归纳法，即假设在第 i 次时，$\frac{xN}{2^{i}} \leq P &lt; \frac{xN+N}{2^{i}}$</p>
<p>进一步，在第 i+1 次时，我们可以发送</p>
<p>$C*2^{(i+1)e}$</p>
<p>服务器会计算得到</p>
<p>$2^{i+1}P \bmod N=2^{i+1}P-kN$</p>
<p>$0 \leq 2^{i+1}P-kN&lt;N$ </p>
<p>$\frac{kN}{2^{i+1}} \leq P &lt; \frac{kN+N}{2^{i+1}}$</p>
<p>根据第 i 次的结果</p>
<p>$\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+2N}{2^{i+1}}$</p>
<p>那么</p>
<ul>
<li>服务器返回奇数，则 k 必然是一个奇数，k=2y+1， 那么 $\frac{2yN+N}{2^{i+1}} \leq P &lt; \frac{2yN+2N}{2^{i+1}}$。与此同时，由于 P 必然存在，所以第 i+1 得到的这个范围和第 i 次得到的范围必然存在交集。所以 y 必然与 x 相等。</li>
<li>服务器返回偶数，则 k 必然是一个偶数，k=2y，此时 y 必然也与 x 相等，那么 $\frac{2xN}{2^{i+1}} \leq P &lt; \frac{2xN+N}{2^{i+1}}$</li>
</ul>
<p>进一步我们可以这么归纳</p>
<pre class="line-numbers language-c"><code class="language-c">lb <span class="token operator">=</span> <span class="token number">0</span>
ub <span class="token operator">=</span> N
<span class="token keyword">if</span> server returns <span class="token number">1</span>
    lb <span class="token operator">=</span> <span class="token punctuation">(</span>lb<span class="token operator">+</span>ub<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    ub <span class="token operator">=</span> <span class="token punctuation">(</span>lb<span class="token operator">+</span>ub<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里虽然是整除， 即下取整，但是无所谓我们在最初时已经分析了这个问题。</p>
<h3 id="2018-Google-CTF-Perfect-Secrecy"><a href="#2018-Google-CTF-Perfect-Secrecy" class="headerlink" title="2018 Google CTF Perfect Secrecy"></a>2018 Google CTF Perfect Secrecy</h3><p>这里以 2018 年 Google CTF 的题目为例进行分析</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> random

<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> serialization
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend


<span class="token keyword">def</span> <span class="token function">ReadPrivateKey</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> serialization<span class="token punctuation">.</span>load_pem_private_key<span class="token punctuation">(</span>
      open<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token operator">=</span>None<span class="token punctuation">,</span> backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">RsaDecrypt</span><span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">assert</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span> <span class="token operator">&lt;=</span>
          <span class="token punctuation">(</span>private_key<span class="token punctuation">.</span>public_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key_size <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Ciphertext too large'</span>
  <span class="token keyword">return</span> pow<span class="token punctuation">(</span>
      int<span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      private_key<span class="token punctuation">.</span>private_numbers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>d<span class="token punctuation">,</span>
      private_key<span class="token punctuation">.</span>public_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>public_numbers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>n<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">Challenge</span><span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">try</span><span class="token punctuation">:</span>
    m0 <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    m1 <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    ciphertext <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span>private_key<span class="token punctuation">.</span>public_key<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key_size <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span>
    dice <span class="token operator">=</span> RsaDecrypt<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span>
    <span class="token keyword">for</span> rounds <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      p <span class="token operator">=</span> <span class="token punctuation">[</span>m0<span class="token punctuation">,</span> m1<span class="token punctuation">]</span><span class="token punctuation">[</span>dice <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">]</span>
      k <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      c <span class="token operator">=</span> <span class="token punctuation">(</span>ord<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span>
      writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>bytes<span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>

  <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  private_key <span class="token operator">=</span> ReadPrivateKey<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Challenge<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
  sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出</p>
<ul>
<li>我们可以给服务器两个数，服务器会根据解密后的密文内容来决定使用哪一个。</li>
<li>服务器会使用 <code>random.randint(0, 2)</code> 来生成随机数，并输出相关的随机 01 字节 c。</li>
</ul>
<p>乍一看，似乎是完全随机的，仔细查一下 <code>random.randint(0, 2)</code> 可以知道其生成随机数是包括边界的，因此其生成偶数的概率大于生成奇数的概率，那么 c 与 p 同奇偶的概率为 2/3。进而我们通过设置 m0 和 m1 就可以知道解密后的密文的最后一位是 0 还是 1 。这其实就是 RSA parity oracle。</p>
<p>exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
encflag <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./flag.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
encflag <span class="token operator">=</span> encflag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
encflag <span class="token operator">=</span> int<span class="token punctuation">(</span>encflag<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>
m <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'\x00'</span><span class="token punctuation">,</span> <span class="token string">'\x07'</span><span class="token punctuation">]</span>
n <span class="token operator">=</span> <span class="token number">0xDA53A899D5573091AF6CC9C9A9FC315F76402C8970BBB1986BFE8E29CED12D0ADF61B21D6C281CCBF2EFED79AA7DD23A2776B03503B1AF354E35BF58C91DB7D7C62F6B92C918C90B68859C77CAE9FDB314F82490A0D6B50C5DC85F5C92A6FDF19716AC8451EFE8BBDF488AE098A7C76ADD2599F2CA642073AFA20D143AF403D1</span>
e <span class="token operator">=</span> <span class="token number">65537</span>
flag <span class="token operator">=</span> <span class="token string">""</span>



<span class="token keyword">def</span> <span class="token function">guessvalue</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> cnt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> cnt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token number">1</span>


i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    cnt <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cnt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'perfect-secrecy.ctfcompetition.com'</span><span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    tmp <span class="token operator">=</span> pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    two_inv <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    two_cipher <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>two_inv<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    tmp <span class="token operator">=</span> encflag <span class="token operator">*</span> two_cipher <span class="token operator">%</span> n
    tmp <span class="token operator">=</span> hex<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
    tmp <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> tmp
    tmp <span class="token operator">=</span> tmp<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">128</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#print tmp</span>
    data <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">+=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        cnt<span class="token punctuation">[</span>u8<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> str<span class="token punctuation">(</span>guessvalue<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> flag
    <span class="token keyword">print</span> i<span class="token punctuation">,</span> flag
    i <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270 6533021797450432625003726192285181680054061843303961161444459679874621880787893445342698029728203298974356255732086344166897556918532195998159983477294838449903429031335408290610431938507208444225296242342845578895553611385588996615744823221415296689514934439749745119968629875229882861818946483594948270<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解码后就可以得到 flag</p>
<pre class="line-numbers language-shell"><code class="language-shell">CTF{h3ll0__17_5_m3_1_w45_w0nd3r1n6_1f_4f73r_4ll_7h353_y34r5_y0u_d_l1k3_70_m337}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="题目-6"><a href="#题目-6" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2016 Plaid CTF rabit</li>
<li>2016 sharif CTF lsb-oracle-150</li>
<li>2018 Backdoor CTF  BIT-LEAKER</li>
<li>2018 XMAN 选拔赛 baby RSA</li>
</ul>
<h2 id="RSA-Byte-Oracle"><a href="#RSA-Byte-Oracle" class="headerlink" title="RSA Byte Oracle"></a>RSA Byte Oracle</h2><p>假设目前存在一个 Oracle，它会对一个给定的密文进行解密，并且会给出明文的最后一个字节。那么给定一个加密后的密文，我们只需要 $\log_{256}n$ 次就可以知道这个密文对应的明文消息。</p>
<h3 id="原理-22"><a href="#原理-22" class="headerlink" title="原理"></a>原理</h3><p>这个其实算作 RSA parity Oracle 的扩展，既然可以泄露出最后一个字节，那么按道理我们获取密文对应明文的次数应该可以减少。</p>
<p>假设</p>
<p>$C=P^e \bmod N$</p>
<p>第一次时，我们可以给服务器发送</p>
<p>$C*256^e=(256P)^e \bmod N$</p>
<p>服务器会计算得到</p>
<p>$256P \bmod N$</p>
<p>这里</p>
<ul>
<li>256P 是偶数。</li>
<li>N 是奇数，因为它是由两个大素数相乘得到。</li>
</ul>
<p>由于 P 一般是小于 N 的，那么$256P \bmod N=256P-kn, k&lt;256$。而且对于两个不同的 $k_1,k_2$，我们有</p>
<p>$256P-k_1n \not\equiv 256P-k_2n \bmod 256$</p>
<p>我们可以利用反证法来证明上述不等式。同时 $256P-kn$ 的最后一个字节其实就是 $-kn$ 在模 256 的情况下获取的。那么，其实我们可以首先枚举出 0~255 情况下的最后一个字节，构造一个 k 和最后一个字节的映射表 map</p>
<p>当服务器返回最后一个字节 b，那么我们可以根据上述构造的映射表得知 k，即减去了 k 个N， 即 $kN \leq 256 P \leq (k+1)N$。</p>
<p>此后，我们使用数学归纳法来获取 P 的范围，即假设在第 i 次时，$\frac{xN}{256^{i}} \leq P &lt; \frac{xN+N}{256^{i}}$</p>
<p>进一步，在第 i+1 次时，我们可以发送</p>
<p>$C*256^{(i+1)e}$</p>
<p>服务器会计算得到</p>
<p>$256^{i+1}P \bmod N=256^{i+1}P-kN$</p>
<p>$0 \leq 256^{i+1}P-kN&lt;N$ </p>
<p>$\frac{kN}{256^{i+1}} \leq P &lt; \frac{kN+N}{256^{i+1}}$</p>
<p>根据第 i 次的结果</p>
<p>$\frac{256xN}{256^{i+1}} \leq P &lt; \frac{256xN+256N}{256^{i+1}}$</p>
<p>我们这里可以假设 $k=256y+t$， 而这里的 t 就是我们可以通过映射表获取的。</p>
<p> $\frac{256yN+tN}{256^{i+1}} \leq P &lt; \frac{256yN+(t+1)N}{256^{i+1}}$</p>
<p>与此同时，由于 P 必然存在，所以第 i+1 得到的这个范围和第 i 次得到的范围必然存在交集。</p>
<p>所以 y 必然与 x 相等。</p>
<p>进一步我们可以这么归纳，初始情况下</p>
<pre><code>lb = 0
ub = N</code></pre><p>假设服务器返回了 b，那么</p>
<pre class="line-numbers language-c"><code class="language-c">k <span class="token operator">=</span> mab<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
interval <span class="token operator">=</span> <span class="token punctuation">(</span>ub<span class="token operator">-</span>lb<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">256</span>
lb <span class="token operator">=</span> lb <span class="token operator">+</span> interval <span class="token operator">*</span> k
ub <span class="token operator">=</span> lb <span class="token operator">+</span> interval<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2018-HITCON-lost-key"><a href="#2018-HITCON-lost-key" class="headerlink" title="2018 HITCON lost key"></a>2018 HITCON lost key</h3><p>这是一个综合题目，首先没有给出 n，我们可以使用选择明文攻击的方式获取 n，当然我们也可以进一步获取 e，最后利用代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> fractions <span class="token keyword">import</span> Fraction
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rsa.py'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#p = remote('18.179.251.168', 21700)</span>
<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Here is the flag!\n'</span><span class="token punctuation">)</span>
flagcipher <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">long_to_hex</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> hex<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">:</span> s <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> s
    <span class="token keyword">return</span> s


<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'cmd: '</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'input: '</span><span class="token punctuation">,</span> long_to_hex<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># get n</span>
    cipher2 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    cipher4 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    nset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    nset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cipher2 <span class="token operator">*</span> cipher2 <span class="token operator">-</span> cipher4<span class="token punctuation">)</span>

    cipher3 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    cipher9 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
    nset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cipher3 <span class="token operator">*</span> cipher3 <span class="token operator">-</span> cipher9<span class="token punctuation">)</span>
    cipher5 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    cipher25 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
    nset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cipher5 <span class="token operator">*</span> cipher5 <span class="token operator">-</span> cipher25<span class="token punctuation">)</span>
    n <span class="token operator">=</span> nset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> nset<span class="token punctuation">:</span>
        n <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>item<span class="token punctuation">,</span> n<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get map between k and return byte</span>
    submap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        submap<span class="token punctuation">[</span><span class="token operator">-</span>n <span class="token operator">*</span> i <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> i

    <span class="token comment" spellcheck="true"># get cipher256</span>
    cipher256 <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>

    back <span class="token operator">=</span> flagcipher

    L <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    R <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> i
        flagcipher <span class="token operator">=</span> flagcipher <span class="token operator">*</span> cipher256 <span class="token operator">%</span> n
        b <span class="token operator">=</span> send<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> flagcipher<span class="token punctuation">)</span>
        k <span class="token operator">=</span> submap<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
        L<span class="token punctuation">,</span> R <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token punctuation">(</span>R <span class="token operator">-</span> L<span class="token punctuation">)</span> <span class="token operator">*</span> Fraction<span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">256</span>
                                     <span class="token punctuation">)</span><span class="token punctuation">,</span> L <span class="token operator">+</span> <span class="token punctuation">(</span>R <span class="token operator">-</span> L<span class="token punctuation">)</span> <span class="token operator">*</span> Fraction<span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    low <span class="token operator">=</span> int<span class="token punctuation">(</span>L <span class="token operator">*</span> n<span class="token punctuation">)</span>
    <span class="token keyword">print</span> long_to_hex<span class="token punctuation">(</span>low <span class="token operator">-</span> low <span class="token operator">%</span> <span class="token number">256</span> <span class="token operator">+</span> send<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> back<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="RSA-parity-oracle-variant"><a href="#RSA-parity-oracle-variant" class="headerlink" title="RSA parity oracle variant"></a>RSA parity oracle variant</h2><h3 id="原理-23"><a href="#原理-23" class="headerlink" title="原理"></a>原理</h3><p>如果oracle的参数会在一定时间、运行周期后改变，或者网络不稳定导致会话断开、重置，二分法就不再适用了，为了减少错误，应当考虑逐位恢复。<br>要恢复明文的第2低位，考虑</p>
<p>$$<br>{(c(2^{-1<em>e_1}\mod N_1))^{d_1}\mod N_1}\pmod2\equiv m</em>2^{-1}<br>$$</p>
<p>$$<br>\begin{aligned}<br>&amp;m<em>(2^{-1}\mod N_1)\mod2\<br>&amp;=(\displaystyle\sum_{i=0}^{logm-1}a_i</em>2^i)<em>2^{-1}\mod2\<br>&amp;=[2(\displaystyle\sum_{i=1}^{logm-1}a_i</em>2^{i-1})+a_0<em>2^0]</em>2^{-1}\mod 2\<br>&amp;=\displaystyle\sum_{i=1}^{logm-1}a_i<em>2^{i-1}+a_0</em>2^0<em>2^{-1}\mod2\<br>&amp;\equiv a_1+a_0</em>2^0*2^{-1}\equiv y\pmod2<br>\end{aligned}<br>$$</p>
<p>$$<br>y-(a_0<em>2^0)</em>2^{-1}=(m<em>2^{-1}\mod2)-(a_0</em>2^0)*2^{-1}\equiv a_1\pmod2<br>$$</p>
<p>类似的</p>
<p>$$<br>{(c(2^{-2<em>e_2}\mod N_2))^{d_2}\mod N_2}\pmod2\equiv m</em>2^{-2}<br>$$</p>
<p>$$<br>\begin{aligned}<br>&amp;m<em>(2^{-2}\mod N_2)\mod2\<br>&amp;=(\displaystyle\sum_{i=0}^{logm-1}a_i</em>2^i)<em>2^{-2}\mod2\<br>&amp;=[2^2(\displaystyle\sum_{i=2}^{logm-1}a_i</em>2^{i-2})+a_1<em>2^1+a_0</em>2^0]<em>2^{-2}\mod 2\<br>&amp;=\displaystyle\sum_{i=2}^{logm-1}a_i</em>2^{i-1}+(a_1<em>2^1+a_0</em>2^0)<em>2^{-2}\mod2\<br>&amp;\equiv a_2+(a_1</em>2^1+a_0<em>2^0)</em>2^{-2}\equiv y\pmod2<br>\end{aligned}<br>$$</p>
<p>$$<br>\begin{aligned}<br>&amp;y-(a_1<em>2^1+a_0</em>2^0)<em>2^{-2}\<br>&amp;=(m</em>2^{-2}\mod2)-(a_1<em>2^1+a_0</em>2^0)*2^{-2}\equiv a_2\pmod2<br>\end{aligned}<br>$$</p>
<p>我们就可以使用前i-1位与oracle的结果来得到第i位。注意这里的$2^{-1}$是$2^1$模$N_1$的逆元。所以对剩下的位，有</p>
<p>$$<br>\begin{aligned}<br>&amp;{(c(2^{-i<em>e_i}\mod N_i))^{d_i}\mod N_i}\pmod2\equiv m</em>2^{-i}\<br>&amp;a_i\equiv (m<em>2^{-i}\mod2) -\sum_{j=0}^{i-1}a_j</em>2^j\pmod2,i=1,2,…,logm-1<br>\end{aligned}<br>$$</p>
<p>其中$2^{-i}$是$2^i$模$N_i$的逆元。</p>
<p>就可以逐步恢复原文所有的位信息了。这样的时间复杂度为$O(logm)$。</p>
<p>exp:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
mm <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>b<span class="token string">'12345678'</span><span class="token punctuation">)</span>
l <span class="token operator">=</span> len<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>mm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span>

<span class="token keyword">def</span> <span class="token function">genkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
        q <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
        e <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> p <span class="token operator">*</span> q
        phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> GCD<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        d <span class="token operator">=</span> inverse<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
        <span class="token keyword">return</span> e<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n

e<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n <span class="token operator">=</span> genkey<span class="token punctuation">(</span><span class="token punctuation">)</span>
cc <span class="token operator">=</span> pow<span class="token punctuation">(</span>mm<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
f <span class="token operator">=</span> str<span class="token punctuation">(</span>pow<span class="token punctuation">(</span>cc<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">:</span>
    e<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n <span class="token operator">=</span> genkey<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cc <span class="token operator">=</span> pow<span class="token punctuation">(</span>mm<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    ss <span class="token operator">=</span> inverse<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span>i<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    cs <span class="token operator">=</span> <span class="token punctuation">(</span>cc <span class="token operator">*</span> pow<span class="token punctuation">(</span>ss<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> n
    lb <span class="token operator">=</span> pow<span class="token punctuation">(</span>cs<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span>
    bb <span class="token operator">=</span> <span class="token punctuation">(</span>lb <span class="token operator">-</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> ss <span class="token operator">%</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span>
    f <span class="token operator">=</span> str<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">+</span> f
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mm <span class="token operator">>></span> i<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> bb<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>int<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="RSA-侧信道攻击"><a href="#RSA-侧信道攻击" class="headerlink" title="RSA 侧信道攻击"></a>RSA 侧信道攻击</h1><p>能量分析攻击（侧信道攻击）是一种能够从密码设备中获取秘密信息的密码攻击方法．与其<br>他攻击方法不同：这种攻击利用的是密码设备的能量消耗特征，而非密码算法的数学特性．能量分析攻击是一种非入侵式攻击，攻击者可以方便地购买实施攻击所需要的设备：所以这种攻击对智能卡之类的密码设备的安全性造成了严重威胁。</p>
<p>能量分析攻击是安全领域内非常重要的一个部分，我们只在这里简单讨论下。</p>
<p>能量分析攻击分为：</p>
<ul>
<li>简单能量分析攻击（SPA），即对能量迹进行直观分析，肉眼看即可。</li>
<li>差分能量分析攻击（DPA），基于能量迹之间的相关系数进行分析。</li>
</ul>
<h2 id="攻击条件-12"><a href="#攻击条件-12" class="headerlink" title="攻击条件"></a>攻击条件</h2><p>攻击者可获取与加解密相关的侧信道信息，例如能量消耗、运算时间、电磁辐射等等。</p>
<h2 id="例子-5"><a href="#例子-5" class="headerlink" title="例子"></a>例子</h2><p>这里我们以 HITB 2017 的 Hack in the card I 作为例子。</p>
<p>题目给出了公钥文件 <code>publickey.pem</code>，密文，测量智能卡功率的电路图，和<strong>解密</strong>过程中智能卡消耗的功率变化（通过在线网站给出 <a href="http://47.74.147.53:20015/index.html" target="_blank" rel="noopener">trace</a>）。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/circuitdiagram.png" alt=""></p>
<p>密文：</p>
<pre><code>014b05e1a09668c83e13fda8be28d148568a2342aed833e0ad646bd45461da2decf9d538c2d3ab245b272873beb112586bb7b17dc4b30f0c5408d8b03cfbc8388b2bd579fb419a1cac38798da1c3da75dc9a74a90d98c8f986fd8ab8b2dc539768beb339cadc13383c62b5223a50e050cb9c6b759072962c2b2cf21b4421ca73394d9e12cfbc958fc5f6b596da368923121e55a3c6a7b12fdca127ecc0e8470463f6e04f27cd4bb3de30555b6c701f524c8c032fa51d719901e7c75cc72764ac00976ac6427a1f483779f61cee455ed319ee9071abefae4473e7c637760b4b3131f25e5eb9950dd9d37666e129640c82a4b01b8bdc1a78b007f8ec71e7bad48046</code></pre><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>由于网站只给出了一条能量迹，所以可以断定这是 Simple channel analysis（SPA）攻击。那么我们可以直接通过观察能量迹的高低电平来获得 RSA 解密过程的密钥 d。<br>RSA 可被 SPA 攻击的理论基础来自于 RSA 中包含的快速幂取余算法。</p>
<p>快速幂算法如下</p>
<ol>
<li>b 为偶数时，$a^b \bmod c = ({a^2}^{b/2}) \bmod c$。</li>
<li>b 为奇数时，$a^b \bmod c = ({a^2}^{b/2} \times a) \bmod c$。</li>
</ol>
<p>相应的 C 代码实现为：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">PowerMod</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ans <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> a <span class="token operator">%</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>b<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>b <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 当b为奇数时会多执行下面的指令</span>
            ans <span class="token operator">=</span> <span class="token punctuation">(</span>ans <span class="token operator">*</span> a<span class="token punctuation">)</span> <span class="token operator">%</span> c<span class="token punctuation">;</span>
        b <span class="token operator">=</span> b<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
        a <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> a<span class="token punctuation">)</span> <span class="token operator">%</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于快速幂的计算过程中会逐位判断指数的取值，并会采取不同的操作，所以可从能量迹中还原出 d 的取值（从上面可知，直接得到的值是 d 的二进制取值的<strong>逆序</strong>）。</p>
<p><strong>注意</strong>：</p>
<blockquote>
<p>有时候模乘也可能会从高位向低位进行模乘。这里是从低位向高位模乘。</p>
</blockquote>
<p><img src="/images/loading.gif" data-original="./figure/trace.png" alt=""></p>
<p>由此可给出还原 d 的脚本如下：</p>
<pre class="line-numbers language-python"><code class="language-python">f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./data.txt'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'point number:'</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

start_point <span class="token operator">=</span> <span class="token number">225</span>   <span class="token comment" spellcheck="true"># 开始分析的点</span>
mid <span class="token operator">=</span> <span class="token number">50</span>            <span class="token comment" spellcheck="true"># 采样点间隔</span>
fence <span class="token operator">=</span> <span class="token number">228</span>         <span class="token comment" spellcheck="true"># 高低电平分界线</span>

bin_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> point_index <span class="token keyword">in</span> range<span class="token punctuation">(</span>start_point<span class="token punctuation">,</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> float<span class="token punctuation">(</span>data<span class="token punctuation">[</span>point_index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> fence<span class="token punctuation">:</span>
        bin_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        bin_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

bin_array2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
flag1 <span class="token operator">=</span> <span class="token number">0</span>
flag2 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> bin_array<span class="token punctuation">:</span>
    <span class="token keyword">if</span> x<span class="token punctuation">:</span>
        <span class="token keyword">if</span> flag1<span class="token punctuation">:</span>
            flag2 <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flag1 <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> flag2<span class="token punctuation">:</span>
            bin_array2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            bin_array2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        flag1 <span class="token operator">=</span> <span class="token number">0</span>
        flag2 <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment" spellcheck="true"># d_bin = bin_array2[::-1]</span>
d_bin <span class="token operator">=</span> bin_array2
d <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>str<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> d_bin<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
d_int <span class="token operator">=</span> int<span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d_int<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="RSA-复杂题目"><a href="#RSA-复杂题目" class="headerlink" title="RSA 复杂题目"></a>RSA 复杂题目</h1><h2 id="2018-Tokyo-Western-Mixed-Cipher"><a href="#2018-Tokyo-Western-Mixed-Cipher" class="headerlink" title="2018 Tokyo Western Mixed Cipher"></a>2018 Tokyo Western Mixed Cipher</h2><p>题目给的信息如下所示：</p>
<ul>
<li>每次交互可以维持的时间长度约为 5 分钟</li>
<li>每次交互中中n是确定的 1024 bit，但是未知， e 为 65537</li>
<li>使用 aes 加密了 flag，密钥和 IV 均不知道</li>
<li>每次密钥是固定的，但是 IV 每次都会随机</li>
<li>可以使用 encrypt 功能随意使用 rsa 和 aes 进行加密，其中每次加密都会对 aes 的 iv 进行随机</li>
<li>可以使用 decrypt 对随意的密文进行解密，但是只能知道最后一个字节是什么</li>
<li>可以使用 print_flag 获取 flag 密文</li>
<li>可以使用 print_key 获取 rsa 加密的 aes 密钥</li>
</ul>
<p>本题目看似一个题目，实则是 3 个题目，需要分步骤解决。在此之前，我們準備好交互的函數</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_enc_key</span><span class="token punctuation">(</span>io<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"here is encrypted key :)n"</span><span class="token punctuation">)</span>
    c<span class="token operator">=</span>int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c

<span class="token keyword">def</span> <span class="token function">encrypt_io</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"input plain text: "</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"RSA: "</span><span class="token punctuation">)</span>
    rsa_c<span class="token operator">=</span>int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"AES: "</span><span class="token punctuation">)</span>
    aes_c<span class="token operator">=</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rsa_c<span class="token punctuation">,</span>aes_c

<span class="token keyword">def</span> <span class="token function">decrypt_io</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"input hexencoded cipher text: "</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"RSA: "</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> io<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="GCD-attack-n"><a href="#GCD-attack-n" class="headerlink" title="GCD attack n"></a>GCD attack n</h3><p>第一步我们需要把没有给出的 n 算出来，因为我们可以利用 encrypt 功能对我们输入的明文 x 进行 rsa 加密，那么可以利用整除的性质算 n</p>
<pre class="line-numbers language-python"><code class="language-python">因为x <span class="token operator">^</span> e <span class="token operator">=</span> c mod n
所以 n <span class="token operator">|</span> x <span class="token operator">^</span> e <span class="token operator">-</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们可以构造足够多的 x，算出最够多的 x ^ e - c，从而计算最大公约数，得到 n。</p>
<pre><code>def get_n(io):
    rsa_c,aes_c=encrypt_io(io,long_to_bytes(2))
    n=pow(2,65537)-rsa_c
    for i in range(3,6):
        rsa_c, aes_c = encrypt_io(io, long_to_bytes(i))
        n=primefac.gcd(n,pow(i,65537)-rsa_c)
    return n</code></pre><p>可以利用加密进行 check</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">check_n</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rsa_c<span class="token punctuation">,</span> aes_c <span class="token operator">=</span> encrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pow<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token operator">==</span>rsa_c<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="RSA-parity-oracle-1"><a href="#RSA-parity-oracle-1" class="headerlink" title="RSA parity oracle"></a>RSA parity oracle</h3><p>利用 leak 的的最后一个字节，我们可以进行选择密文攻击，使用 RSA parity oracle 回复 aes 的秘钥</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">guess_m</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    k<span class="token operator">=</span><span class="token number">1</span>
    lb<span class="token operator">=</span><span class="token number">0</span>
    ub<span class="token operator">=</span>n
    <span class="token keyword">while</span> ub<span class="token operator">!=</span>lb<span class="token punctuation">:</span>
        <span class="token keyword">print</span> lb<span class="token punctuation">,</span>ub
        tmp <span class="token operator">=</span> c <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> k<span class="token operator">*</span>e<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> n
        <span class="token keyword">if</span> ord<span class="token punctuation">(</span>decrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span>tmp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            lb <span class="token operator">=</span> <span class="token punctuation">(</span>lb <span class="token operator">+</span> ub<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ub <span class="token operator">=</span> <span class="token punctuation">(</span>lb <span class="token operator">+</span> ub<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        k<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token keyword">print</span> ub<span class="token punctuation">,</span>len<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>ub<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="PRNG-Predict"><a href="#PRNG-Predict" class="headerlink" title="PRNG Predict"></a>PRNG Predict</h3><p>这里我们可以解密 flag 的16字节之后的内容了，但是前16个字节没有 IV 是解密不了的。这时我们可以发现，IV 生成使用的随机数使用了 getrandbits，并且我们可以获取到足够多的随机数量，那么我们可以进行 PRNG 的 predict，从而直接获取随机数</p>
<p>这里使用了一个现成的的 java 进行 PRNG 的 Predict</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>

   <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> state<span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token keyword">int</span> currentIndex<span class="token punctuation">;</span>
40huo
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">624</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//    initialize(0);</span>

<span class="token comment" spellcheck="true">//    for (int i = 0; i &lt; 5; i++) {</span>
<span class="token comment" spellcheck="true">//       System.out.println(state[i]);</span>
<span class="token comment" spellcheck="true">//    }</span>

      <span class="token comment" spellcheck="true">// for (int i = 0; i &lt; 5; i++) {</span>
      <span class="token comment" spellcheck="true">// System.out.println(nextNumber());</span>
      <span class="token comment" spellcheck="true">// }</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">624</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"must be 624 args"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">624</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>


      <span class="token function">rev</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> 6240huo4<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//    System.out.println("currentIndex " + currentIndex);</span>
<span class="token comment" spellcheck="true">//    System.out.println("state[currentIndex] " + state[currentIndex]);</span>
<span class="token comment" spellcheck="true">//    System.out.println("next " + nextNumber());</span>

      <span class="token comment" spellcheck="true">// want -2065863258</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">nextState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Iterate through the state</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">624</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">// y is the first bit of the current number,</span>
         <span class="token comment" spellcheck="true">// and the last 31 bits of the next number</span>
         <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span>
               <span class="token operator">+</span> <span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">624</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// first bitshift y by 1 to the right</span>
         <span class="token keyword">int</span> next <span class="token operator">=</span> y <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// xor it with the 397th next number</span>
         next <span class="token operator">^=</span> state<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">397</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">624</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// if y is odd, xor with magic number</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">&amp;</span> 1L<span class="token punctuation">)</span> <span class="token operator">==</span> 1L<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next <span class="token operator">^=</span> <span class="token number">0x9908b0df</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment" spellcheck="true">// now we have the result</span>
         state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentIndex<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> tmp <span class="token operator">=</span> state<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      tmp <span class="token operator">^=</span> <span class="token punctuation">(</span>tmp <span class="token operator">>>></span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tmp <span class="token operator">^=</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x9d2c5680</span><span class="token punctuation">;</span>
      tmp <span class="token operator">^=</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xefc60000</span><span class="token punctuation">;</span>
      tmp <span class="token operator">^=</span> <span class="token punctuation">(</span>tmp <span class="token operator">>>></span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">int</span> seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment" spellcheck="true">// http://code.activestate.com/recipes/578056-mersenne-twister/</span>

      <span class="token comment" spellcheck="true">// global MT</span>
      <span class="token comment" spellcheck="true">// global bitmask_1</span>
      <span class="token comment" spellcheck="true">// MT[0] = seed</span>
      <span class="token comment" spellcheck="true">// for i in xrange(1,624):</span>
      <span class="token comment" spellcheck="true">// MT[i] = ((1812433253 * MT[i-1]) ^ ((MT[i-1] >> 30) + i)) &amp; bitmask_1</span>

      <span class="token comment" spellcheck="true">// copied Python 2.7's impl (probably uint problems)</span>
      state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> seed<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">624</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1812433253</span> <span class="token operator">*</span> state<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">unBitshiftRightXor</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> shift<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// we part of the value we are up to (with a width of shift bits)</span>
      <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// we accumulate the result here</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// iterate until we've done the full 32 bits</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> shift <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">// create a mask for this part</span>
         <span class="token keyword">int</span> partMask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> shift<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token punctuation">(</span>shift <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// obtain the part</span>
         <span class="token keyword">int</span> part <span class="token operator">=</span> value <span class="token operator">&amp;</span> partMask<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// unapply the xor from the next part of the integer</span>
         value <span class="token operator">^=</span> part <span class="token operator">>>></span> shift<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// add the part to the result</span>
         result <span class="token operator">|=</span> part<span class="token punctuation">;</span>
         i<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">unBitshiftLeftXor</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> shift<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// we part of the value we are up to (with a width of shift bits)</span>
      <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// we accumulate the result here</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// iterate until we've done the full 32 bits</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> shift <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">// create a mask for this part</span>
         <span class="token keyword">int</span> partMask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">>>></span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> shift<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>shift <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// obtain the part</span>
         <span class="token keyword">int</span> part <span class="token operator">=</span> value <span class="token operator">&amp;</span> partMask<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// unapply the xor from the next part of the integer</span>
         value <span class="token operator">^=</span> <span class="token punctuation">(</span>part <span class="token operator">&lt;&lt;</span> shift<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// add the part to the result</span>
         result <span class="token operator">|=</span> part<span class="token punctuation">;</span>
         i<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rev</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">624</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

         <span class="token keyword">int</span> value <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         value <span class="token operator">=</span> <span class="token function">unBitshiftRightXor</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         value <span class="token operator">=</span> <span class="token function">unBitshiftLeftXor</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0xefc60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         value <span class="token operator">=</span> <span class="token function">unBitshiftLeftXor</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x9d2c5680</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         value <span class="token operator">=</span> <span class="token function">unBitshiftRightXor</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>写了一个 python 直接调用 java</p>
<pre><code>from Crypto.Util.number import long_to_bytes,bytes_to_long



def encrypt_io(io,p):
    io.read_until("4: get encrypted keyn")
    io.writeline("1")
    io.read_until("input plain text: ")
    io.writeline(p)
    io.read_until("RSA: ")
    rsa_c=int(io.readline()[:-1],16)
    io.read_until("AES: ")
    aes_c=io.readline()[:-1].decode("hex")
    return rsa_c,aes_c
import subprocess
import random
def get_iv(io):
    rsa_c, aes_c=encrypt_io(io,"1")
    return bytes_to_long(aes_c[0:16])
def splitInto32(w128):
    w1 = w128 &amp; (2**32-1)
    w2 = (w128 &gt;&gt; 32) &amp; (2**32-1)
    w3 = (w128 &gt;&gt; 64) &amp; (2**32-1)
    w4 = (w128 &gt;&gt; 96)
    return w1,w2,w3,w4
def sign(iv):
    # converts a 32 bit uint to a 32 bit signed int
    if(iv&amp;0x80000000):
        iv = -0x100000000 + iv
    return iv
def get_state(io):
    numbers=[]
    for i in range(156):
        print i
        numbers.append(get_iv(io))
    observedNums = [sign(w) for n in numbers for w in splitInto32(n)]
    o = subprocess.check_output(["java", "Main"] + map(str, observedNums))
    stateList = [int(s) % (2 ** 32) for s in o.split()]
    r = random.Random()
    state = (3, tuple(stateList + [624]), None)
    r.setstate(state)
    return r.getrandbits(128)</code></pre><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>整体攻击代码如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> zio <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> primefac
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> long_to_bytes<span class="token punctuation">,</span>bytes_to_long
target<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"crypto.chal.ctf.westerns.tokyo"</span><span class="token punctuation">,</span><span class="token number">5643</span><span class="token punctuation">)</span>
e<span class="token operator">=</span><span class="token number">65537</span>

<span class="token keyword">def</span> <span class="token function">get_enc_key</span><span class="token punctuation">(</span>io<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"here is encrypted key :)n"</span><span class="token punctuation">)</span>
    c<span class="token operator">=</span>int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c

<span class="token keyword">def</span> <span class="token function">encrypt_io</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"input plain text: "</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"RSA: "</span><span class="token punctuation">)</span>
    rsa_c<span class="token operator">=</span>int<span class="token punctuation">(</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"AES: "</span><span class="token punctuation">)</span>
    aes_c<span class="token operator">=</span>io<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rsa_c<span class="token punctuation">,</span>aes_c

<span class="token keyword">def</span> <span class="token function">decrypt_io</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"4: get encrypted keyn"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"input hexencoded cipher text: "</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>writeline<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>read_until<span class="token punctuation">(</span><span class="token string">"RSA: "</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> io<span class="token punctuation">.</span>read_line<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_n</span><span class="token punctuation">(</span>io<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rsa_c<span class="token punctuation">,</span>aes_c<span class="token operator">=</span>encrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span>long_to_bytes<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n<span class="token operator">=</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">65537</span><span class="token punctuation">)</span><span class="token operator">-</span>rsa_c
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rsa_c<span class="token punctuation">,</span> aes_c <span class="token operator">=</span> encrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span> long_to_bytes<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        n<span class="token operator">=</span>primefac<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>n<span class="token punctuation">,</span>pow<span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">65537</span><span class="token punctuation">)</span><span class="token operator">-</span>rsa_c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> n

<span class="token keyword">def</span> <span class="token function">check_n</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rsa_c<span class="token punctuation">,</span> aes_c <span class="token operator">=</span> encrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pow<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token operator">==</span>rsa_c<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">import</span> gmpy2
<span class="token keyword">def</span> <span class="token function">guess_m</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    k<span class="token operator">=</span><span class="token number">1</span>
    lb<span class="token operator">=</span><span class="token number">0</span>
    ub<span class="token operator">=</span>n
    <span class="token keyword">while</span> ub<span class="token operator">!=</span>lb<span class="token punctuation">:</span>
        <span class="token keyword">print</span> lb<span class="token punctuation">,</span>ub
        tmp <span class="token operator">=</span> c <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> k<span class="token operator">*</span>e<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> n
        <span class="token keyword">if</span> ord<span class="token punctuation">(</span>decrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span>tmp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            lb <span class="token operator">=</span> <span class="token punctuation">(</span>lb <span class="token operator">+</span> ub<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            ub <span class="token operator">=</span> <span class="token punctuation">(</span>lb <span class="token operator">+</span> ub<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        k<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token keyword">print</span> ub<span class="token punctuation">,</span>len<span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>ub<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ub


io <span class="token operator">=</span> zio<span class="token punctuation">(</span>target<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span> print_read<span class="token operator">=</span>COLORED<span class="token punctuation">(</span>NONE<span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>print_write<span class="token operator">=</span>COLORED<span class="token punctuation">(</span>NONE<span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
n<span class="token operator">=</span>get_n<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token keyword">print</span> check_n<span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
c<span class="token operator">=</span>get_enc_key<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>decrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">16</span>


m<span class="token operator">=</span>guess_m<span class="token punctuation">(</span>io<span class="token punctuation">,</span>n<span class="token punctuation">,</span>c<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">50000</span><span class="token punctuation">,</span>m<span class="token operator">+</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> pow<span class="token punctuation">(</span>i<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token operator">==</span>c<span class="token punctuation">:</span>
        aeskey<span class="token operator">=</span>i
        <span class="token keyword">print</span> long_to_bytes<span class="token punctuation">(</span>aeskey<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>decrypt_io<span class="token punctuation">(</span>io<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span> <span class="token string">"found aes key"</span><span class="token punctuation">,</span>hex<span class="token punctuation">(</span>aeskey<span class="token punctuation">)</span>

<span class="token keyword">import</span> fuck_r
next_iv<span class="token operator">=</span>fuck_r<span class="token punctuation">.</span>get_state<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">"##########################################"</span>
<span class="token keyword">print</span> next_iv
<span class="token keyword">print</span> aeskey
io<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2016-ASIS-Find-the-flag"><a href="#2016-ASIS-Find-the-flag" class="headerlink" title="2016 ASIS Find the flag"></a>2016 ASIS Find the flag</h2><p>这里我们以 ASIS 2016 线上赛中 Find the flag 为例进行介绍。</p>
<p>文件解压出来，有一个密文，一个公钥，一个 py 脚本。看一下公钥。</p>
<pre class="line-numbers language-bash"><code class="language-bash">➜  RSA openssl rsa -pubin -in pubkey.pem -text -modulus
Public-Key: <span class="token punctuation">(</span>256 bit<span class="token punctuation">)</span>
Modulus:
    00:d8:e2:4c:12:b7:b9:9e:fe:0a:9b:c0:4a:6a:3d:
    f5:8a:2a:94:42:69:b4:92:b7:37:6d:f1:29:02:3f:
    20:61:b9
Exponent: 12405943493775545863 <span class="token punctuation">(</span>0xac2ac3e0ca0f5607<span class="token punctuation">)</span>
Modulus<span class="token operator">=</span>D8E24C12B7B99EFE0A9BC04A6A3DF58A2A944269B492B7376DF129023F2061B9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这么小的一个 $N$，先分解一下。</p>
<pre><code>p = 311155972145869391293781528370734636009
q = 315274063651866931016337573625089033553</code></pre><p>再看给的 py 脚本。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">import</span> gmpy
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5

flag <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">30</span>

<span class="token keyword">def</span> <span class="token function">ext_rsa_encrypt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> p <span class="token operator">*</span> q
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            d <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
            pubkey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            key <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span>
            enc <span class="token operator">=</span> key<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> enc
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>p<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> q<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
            q <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>p<span class="token operator">*</span>q<span class="token punctuation">)</span>
            e <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>e<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
q <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
n <span class="token operator">=</span> p<span class="token operator">*</span>q
e <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
pubkey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'pubkey.pem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pubkey<span class="token punctuation">.</span>exportKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
g <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'flag.enc'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
g<span class="token punctuation">.</span>write<span class="token punctuation">(</span>ext_rsa_encrypt<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑很简单，读取 flag，重复 30 遍为密文。随机取 $p$ 和 $q$，生成一个公钥，写入 <code>pubkey.pem</code>，再用脚本中的 <code>ext_rsa_encrypt</code> 函数进行加密，最后将密文写入 <code>flag.enc</code>。</p>
<p>尝试一下解密，提示密文过长，再看加密函数，原来当加密失败时，函数会跳到异常处理，以一定算法重新取更大的 $p$ 和 $q$，直到加密成功。</p>
<p>那么我们只要也写一个相应的解密函数即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token keyword">import</span> gmpy
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5

<span class="token keyword">def</span> <span class="token function">ext_rsa_decrypt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> p <span class="token operator">*</span> q
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            d <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
            privatekey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            key <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>privatekey<span class="token punctuation">)</span>
            de_error <span class="token operator">=</span> <span class="token string">''</span>
            enc <span class="token operator">=</span> key<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> de_error<span class="token punctuation">)</span>
            <span class="token keyword">return</span> enc
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> error<span class="token punctuation">:</span>
            <span class="token keyword">print</span> error
            p <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>p<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">+</span> q<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
            q <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>p<span class="token operator">*</span>q<span class="token punctuation">)</span>
            e <span class="token operator">=</span> gmpy<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>e<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> <span class="token number">311155972145869391293781528370734636009</span>
q <span class="token operator">=</span> <span class="token number">315274063651866931016337573625089033553</span>
n <span class="token operator">=</span> p<span class="token operator">*</span>q
e <span class="token operator">=</span> <span class="token number">12405943493775545863</span> 
<span class="token comment" spellcheck="true"># pubkey = RSA.construct((long(n), long(e)))</span>
<span class="token comment" spellcheck="true"># f = open('pubkey.pem', 'w')</span>
<span class="token comment" spellcheck="true"># f.write(pubkey.exportKey())</span>
g <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'flag.enc'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
msg <span class="token operator">=</span> g<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> ext_rsa_decrypt<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> e<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
<span class="token keyword">print</span> flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拿到 flag</p>
<pre><code>ASIS{F4ct0R__N_by_it3rat!ng!}</code></pre><h2 id="SCTF-RSA1"><a href="#SCTF-RSA1" class="headerlink" title="SCTF RSA1"></a>SCTF RSA1</h2><p>这里我们以 SCTF RSA1 为例进行介绍，首先解压压缩包后，得到如下文件</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level0 git:(master) ✗ ls -al
总用量 4
drwxrwxrwx 1 root root    0 7月  30 16:36 .
drwxrwxrwx 1 root root    0 7月  30 16:34 ..
-rwxrwxrwx 1 root root  349 5月   2  2016 level1.passwd.enc
-rwxrwxrwx 1 root root 2337 5月   6  2016 level1.zip
-rwxrwxrwx 1 root root  451 5月   2  2016 public.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>尝试解压缩了一下 level1.zip 现需要密码。然后根据 level1.passwd.enc 可知，应该是我们需要解密这个文件才能得到对应的密码。查看公钥</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level0 git:(master) ✗ openssl rsa -pubin -in public.key -text -modulus 
Public-Key: (2048 bit)
Modulus:
    00:94:a0:3e:6e:0e:dc:f2:74:10:52:ef:1e:ea:a8:
    89:d6:f9:8d:01:11:51:db:5e:90:92:48:fd:39:0c:
    70:87:24:d8:98:3c:f3:33:1c:ba:c5:61:c2:ce:2c:
    5a:f1:5e:65:b2:b2:46:91:56:b6:19:d5:d3:b2:a6:
    bb:a3:7d:56:93:99:4d:7e:4c:2f:aa:60:7b:3e:c8:
    fc:90:b2:00:62:4b:53:18:5b:a2:30:10:60:a8:21:
    ab:61:57:d7:e7:cc:67:1b:4d:cd:66:4c:7d:f1:1a:
    2a:1d:5e:50:80:c1:5e:45:12:3a:ba:4a:53:64:d8:
    72:1f:84:4a:ae:5c:55:02:e8:8e:56:4d:38:70:a5:
    16:36:d3:bc:14:3e:2f:ae:2f:31:58:ba:00:ab:ac:
    c0:c5:ba:44:3c:29:70:56:01:6b:57:f5:d7:52:d7:
    31:56:0b:ab:0a:e6:8d:ad:08:22:a9:1f:cb:6e:49:
    cc:01:4c:12:d2:ab:a3:a5:97:e5:10:49:19:7f:69:
    d9:3b:c5:53:53:71:00:18:60:cc:69:1a:06:64:3b:
    86:94:70:a9:da:82:fc:54:6b:06:23:43:2d:b0:20:
    eb:b6:1b:91:35:5e:53:a6:e5:d8:9a:84:bb:30:46:
    b8:9f:63:bc:70:06:2d:59:d8:62:a5:fd:5c:ab:06:
    68:81
Exponent: 65537 (0x10001)
Modulus=94A03E6E0EDCF2741052EF1EEAA889D6F98D011151DB5E909248FD390C708724D8983CF3331CBAC561C2CE2C5AF15E65B2B2469156B619D5D3B2A6BBA37D5693994D7E4C2FAA607B3EC8FC90B200624B53185BA2301060A821AB6157D7E7CC671B4DCD664C7DF11A2A1D5E5080C15E45123ABA4A5364D8721F844AAE5C5502E88E564D3870A51636D3BC143E2FAE2F3158BA00ABACC0C5BA443C297056016B57F5D752D731560BAB0AE68DAD0822A91FCB6E49CC014C12D2ABA3A597E51049197F69D93BC5535371001860CC691A06643B869470A9DA82FC546B0623432DB020EBB61B91355E53A6E5D89A84BB3046B89F63BC70062D59D862A5FD5CAB066881
writing RSA key
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlKA+bg7c8nQQUu8e6qiJ
1vmNARFR216Qkkj9OQxwhyTYmDzzMxy6xWHCzixa8V5lsrJGkVa2GdXTsqa7o31W
k5lNfkwvqmB7Psj8kLIAYktTGFuiMBBgqCGrYVfX58xnG03NZkx98RoqHV5QgMFe
RRI6ukpTZNhyH4RKrlxVAuiOVk04cKUWNtO8FD4vri8xWLoAq6zAxbpEPClwVgFr
V/XXUtcxVgurCuaNrQgiqR/LbknMAUwS0qujpZflEEkZf2nZO8VTU3EAGGDMaRoG
ZDuGlHCp2oL8VGsGI0MtsCDrthuRNV5TpuXYmoS7MEa4n2O8cAYtWdhipf1cqwZo
gQIDAQAB
-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现虽然说是 2048 位，但是显然模数没有那么长，尝试分解下，得到</p>
<pre><code>p=250527704258269
q=74891071972884336452892671945839935839027130680745292701175368094445819328761543101567760612778187287503041052186054409602799660254304070752542327616415127619185118484301676127655806327719998855075907042722072624352495417865982621374198943186383488123852345021090112675763096388320624127451586578874243946255833495297552979177208715296225146999614483257176865867572412311362252398105201644557511678179053171328641678681062496129308882700731534684329411768904920421185529144505494827908706070460177001921614692189821267467546120600239688527687872217881231173729468019623441005792563703237475678063375349</code></pre><p>然后就可以构造，并且解密，代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64decode
p <span class="token operator">=</span> <span class="token number">250527704258269</span>
q <span class="token operator">=</span> <span class="token number">74891071972884336452892671945839935839027130680745292701175368094445819328761543101567760612778187287503041052186054409602799660254304070752542327616415127619185118484301676127655806327719998855075907042722072624352495417865982621374198943186383488123852345021090112675763096388320624127451586578874243946255833495297552979177208715296225146999614483257176865867572412311362252398105201644557511678179053171328641678681062496129308882700731534684329411768904920421185529144505494827908706070460177001921614692189821267467546120600239688527687872217881231173729468019623441005792563703237475678063375349</span>
e <span class="token operator">=</span> <span class="token number">65537</span>
n <span class="token operator">=</span> p <span class="token operator">*</span> q


<span class="token keyword">def</span> <span class="token function">getprivatekey</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    phin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span>
    priviatekey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'private.pem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>priviatekey<span class="token punctuation">.</span>exportKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./level1.passwd.enc'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        cipher <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> b64decode<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./private.pem'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">print</span> key<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#getprivatekey(n, e, p, q)</span>
decrypt<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现不对</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level0 git:(master) ✗ python exp.py
一堆乱码。。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这时候就要考虑其他情况了，一般来说现实中实现的 RSA 都不会直接用原生的 RSA，都会加一些填充比如 OAEP，我们这里试试，修改代码</p>
<pre class="line-numbers language-shell"><code class="language-shell">def decrypt1():
    with open('./level1.passwd.enc') as f:
        cipher = f.read()
    cipher = b64decode(cipher)
    with open('./private.pem') as f:
        key = RSA.importKey(f)
        key = PKCS1_OAEP.new(key)
    print key.decrypt(cipher)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>果然如此，得到</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level0 git:(master) ✗ python exp.py
FaC5ori1ati0n_aTTA3k_p_tOO_sma11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>得到解压密码。继续，查看 level1 中的公钥</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level1 git:(master) ✗ openssl rsa -pubin -in public.key -text -modulus
Public-Key: (2048 bit)
Modulus:
    00:c3:26:59:69:e1:ed:74:d2:e0:b4:9a:d5:6a:7c:
    2f:2a:9e:c3:71:ff:13:4b:10:37:c0:6f:56:19:34:
    c5:cb:1f:6d:c0:e3:57:3b:47:c4:76:3e:21:a3:b0:
    11:11:78:d4:ee:4f:e8:99:2b:15:cb:cb:d7:73:e4:
    f9:a6:28:20:fd:db:8c:ea:16:ed:67:c2:48:12:6e:
    4b:01:53:4a:67:cb:22:23:3b:34:2e:af:13:ef:93:
    45:16:2b:00:9f:e0:4b:d1:90:c9:2c:27:9a:34:c3:
    3f:d7:ee:40:f5:82:50:39:aa:8c:e9:c2:7b:f4:36:
    e3:38:9d:04:50:db:a9:b7:3f:4b:2a:d6:8a:2a:5c:
    87:2a:eb:74:35:98:6a:9c:e4:52:cb:93:78:d2:da:
    39:83:f3:0c:d1:65:1e:66:9c:40:56:06:0d:58:fc:
    41:64:5e:06:da:83:d0:3b:06:42:70:da:38:53:e0:
    54:35:53:ce:de:79:4a:bf:f5:3b:e5:53:7f:6c:18:
    12:67:a9:de:37:7d:44:65:5e:68:0a:78:39:3d:bb:
    00:22:35:0e:a3:94:e6:94:15:1a:3d:39:c7:50:0e:
    b1:64:a5:29:a3:69:41:40:69:94:b0:0d:1a:ea:9a:
    12:27:50:ee:1e:3a:19:b7:29:70:b4:6d:1e:9d:61:
    3e:7d
Exponent: 65537 (0x10001)
Modulus=C3265969E1ED74D2E0B49AD56A7C2F2A9EC371FF134B1037C06F561934C5CB1F6DC0E3573B47C4763E21A3B0111178D4EE4FE8992B15CBCBD773E4F9A62820FDDB8CEA16ED67C248126E4B01534A67CB22233B342EAF13EF9345162B009FE04BD190C92C279A34C33FD7EE40F5825039AA8CE9C27BF436E3389D0450DBA9B73F4B2AD68A2A5C872AEB7435986A9CE452CB9378D2DA3983F30CD1651E669C4056060D58FC41645E06DA83D03B064270DA3853E0543553CEDE794ABFF53BE5537F6C181267A9DE377D44655E680A78393DBB0022350EA394E694151A3D39C7500EB164A529A36941406994B00D1AEA9A122750EE1E3A19B72970B46D1E9D613E7D
writing RSA key
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwyZZaeHtdNLgtJrVanwv
Kp7Dcf8TSxA3wG9WGTTFyx9twONXO0fEdj4ho7AREXjU7k/omSsVy8vXc+T5pigg
/duM6hbtZ8JIEm5LAVNKZ8siIzs0Lq8T75NFFisAn+BL0ZDJLCeaNMM/1+5A9YJQ
OaqM6cJ79DbjOJ0EUNuptz9LKtaKKlyHKut0NZhqnORSy5N40to5g/MM0WUeZpxA
VgYNWPxBZF4G2oPQOwZCcNo4U+BUNVPO3nlKv/U75VN/bBgSZ6neN31EZV5oCng5
PbsAIjUOo5TmlBUaPTnHUA6xZKUpo2lBQGmUsA0a6poSJ1DuHjoZtylwtG0enWE+
fQIDAQAB
-----END PUBLIC KEY-----
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>似乎还是不是很大，再次分解，然后试了 factordb 不行，试试 yafu。结果分解出来了。</p>
<pre class="line-numbers language-shell"><code class="language-shell">P309 = 156956618844706820397012891168512561016172926274406409351605204875848894134762425857160007206769208250966468865321072899370821460169563046304363342283383730448855887559714662438206600780443071125634394511976108979417302078289773847706397371335621757603520669919857006339473738564640521800108990424511408496383

P309 = 156956618844706820397012891168512561016172926274406409351605204875848894134762425857160007206769208250966468865321072899370821460169563046304363342283383730448855887559714662438206600780443071125634394511976108979417302078289773847706397371335621757603520669919857006339473738564640521800108990424511408496259
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可以发现这两个数非常相近，可能是 factordb 没有实现这类分解。</p>
<p>继而下面的操作类似于 level0。只是这次是直接解密就好，没啥填充，试了填充反而错</p>
<p>得到密码 <code>fA35ORI11TLoN_Att1Ck_cL0sE_PrI8e_4acTorS</code>。继续下一步，查看公钥</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level2 git:(master) ✗ openssl rsa -pubin -in public.key -text -modulus
Public-Key: (1025 bit)
Modulus:
    01:ba:0c:c2:45:b4:5c:e5:b5:f5:6c:d5:ca:a5:90:
    c2:8d:12:3d:8a:6d:7f:b6:47:37:fb:7c:1f:5a:85:
    8c:1e:35:13:8b:57:b2:21:4f:f4:b2:42:24:5f:33:
    f7:2c:2c:0d:21:c2:4a:d4:c5:f5:09:94:c2:39:9d:
    73:e5:04:a2:66:1d:9c:4b:99:d5:38:44:ab:13:d9:
    cd:12:a4:d0:16:79:f0:ac:75:f9:a4:ea:a8:7c:32:
    16:9a:17:d7:7d:80:fd:60:29:64:c7:ea:50:30:63:
    76:59:c7:36:5e:98:d2:ea:5b:b3:3a:47:17:08:2d:
    d5:24:7d:4f:a7:a1:f0:d5:73
Exponent:
    01:00:8e:81:dd:a0:e3:19:28:e8:ee:51:11:08:c7:
    50:5f:61:31:05:d2:e2:ff:9b:83:71:e4:29:c2:dd:
    92:70:65:d4:09:6d:58:c3:76:31:07:f1:d4:fc:cf:
    2d:b3:0a:6d:02:7c:56:61:7c:be:7e:0b:7e:d9:22:
    28:66:9e:fb:3d:2f:2c:20:59:3c:21:ef:ff:31:00:
    6a:fb:a7:68:de:4a:0a:4c:1a:a7:09:d5:48:98:c8:
    1f:cf:fb:dd:f7:9c:ae:ae:0b:15:f4:b2:c7:e0:bc:
    ba:31:4f:5e:07:83:ad:0e:7f:b9:82:a4:d2:01:fa:
    68:29:6d:66:7c:cf:57:b9:4b
Modulus=1BA0CC245B45CE5B5F56CD5CAA590C28D123D8A6D7FB64737FB7C1F5A858C1E35138B57B2214FF4B242245F33F72C2C0D21C24AD4C5F50994C2399D73E504A2661D9C4B99D53844AB13D9CD12A4D01679F0AC75F9A4EAA87C32169A17D77D80FD602964C7EA5030637659C7365E98D2EA5BB33A4717082DD5247D4FA7A1F0D573
writing RSA key
-----BEGIN PUBLIC KEY-----
MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKBgQG6DMJFtFzltfVs1cqlkMKN
Ej2KbX+2Rzf7fB9ahYweNROLV7IhT/SyQiRfM/csLA0hwkrUxfUJlMI5nXPlBKJm
HZxLmdU4RKsT2c0SpNAWefCsdfmk6qh8MhaaF9d9gP1gKWTH6lAwY3ZZxzZemNLq
W7M6RxcILdUkfU+nofDVcwKBgQEAjoHdoOMZKOjuUREIx1BfYTEF0uL/m4Nx5CnC
3ZJwZdQJbVjDdjEH8dT8zy2zCm0CfFZhfL5+C37ZIihmnvs9LywgWTwh7/8xAGr7
p2jeSgpMGqcJ1UiYyB/P+933nK6uCxX0ssfgvLoxT14Hg60Of7mCpNIB+mgpbWZ8
z1e5Sw==
-----END PUBLIC KEY-----
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现私钥 e 和 n 几乎一样大，考虑 d 比较小，使用 Wiener’s Attack。得到 d，当然也可以再次验证一遍。</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  level2 git:(master) ✗ python RSAwienerHacker.py
Testing Wiener Attack
Hacked!
('hacked_d = ', 29897859398360008828023114464512538800655735360280670512160838259524245332403L)
-------------------------
Hacked!
('hacked_d = ', 29897859398360008828023114464512538800655735360280670512160838259524245332403L)
-------------------------
Hacked!
('hacked_d = ', 29897859398360008828023114464512538800655735360280670512160838259524245332403L)
-------------------------
Hacked!
('hacked_d = ', 29897859398360008828023114464512538800655735360280670512160838259524245332403L)
-------------------------
Hacked!
('hacked_d = ', 29897859398360008828023114464512538800655735360280670512160838259524245332403L)
-------------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这时我们解密密文，解密代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5<span class="token punctuation">,</span> PKCS1_OAEP
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64decode
d <span class="token operator">=</span> 29897859398360008828023114464512538800655735360280670512160838259524245332403L
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./public.key'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    n <span class="token operator">=</span> key<span class="token punctuation">.</span>n
    e <span class="token operator">=</span> key<span class="token punctuation">.</span>e


<span class="token keyword">def</span> <span class="token function">getprivatekey</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    priviatekey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>construct<span class="token punctuation">(</span><span class="token punctuation">(</span>long<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> long<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'private.pem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>priviatekey<span class="token punctuation">.</span>exportKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./level3.passwd.enc'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        cipher <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./private.pem'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">print</span> key<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>


getprivatekey<span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
decrypt<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用末尾的字符串 <code>wIe6ER1s_1TtA3k_e_t00_larg3</code> 解密压缩包，注意去掉 B。至此全部解密结束，得到 flag。</p>
<h2 id="2018-WCTF-RSA"><a href="#2018-WCTF-RSA" class="headerlink" title="2018 WCTF RSA"></a>2018 WCTF RSA</h2><p>题目基本描述为</p>
<pre><code>Description:
Encrypted message for user "admin":

&lt;&lt;&lt;320881698662242726122152659576060496538921409976895582875089953705144841691963343665651276480485795667557825130432466455684921314043200553005547236066163215094843668681362420498455007509549517213285453773102481574390864574950259479765662844102553652977000035769295606566722752949297781646289262341623549414376262470908749643200171565760656987980763971637167709961003784180963669498213369651680678149962512216448400681654410536708661206594836597126012192813519797526082082969616915806299114666037943718435644796668877715954887614703727461595073689441920573791980162741306838415524808171520369350830683150672985523901&gt;&gt;&gt;

admin public key:

n = 483901264006946269405283937218262944021205510033824140430120406965422208942781742610300462772237450489835092525764447026827915305166372385721345243437217652055280011968958645513779764522873874876168998429546523181404652757474147967518856439439314619402447703345139460317764743055227009595477949315591334102623664616616842043021518775210997349987012692811620258928276654394316710846752732008480088149395145019159397592415637014390713798032125010969597335893399022114906679996982147566245244212524824346645297637425927685406944205604775116409108280942928854694743108774892001745535921521172975113294131711065606768927
e = 65537

Service: http://36.110.234.253
</code></pre><p>这个题目现在已经没有办法在线获取 binary 了，现在得到的 binary 是之前已经下载好的，我们当时需要登录用户的 admin 来下载对应的 generator。</p>
<p>通过简单逆向这个 generator，我们可以发现这个程序是这么工作的</p>
<ul>
<li>利用用户给定的 license（32 个字节），迭代解密某个<strong>固定位置</strong>之后的数据，每 32 个字节一组，与密钥相异或得到结果。</li>
<li>密钥的生成方法为 <ul>
<li>$k_1=key$</li>
<li>$k_2 =sha256(k_1)$</li>
<li>…</li>
<li>$k_n=sha256(k_{n-1})$</li>
</ul>
</li>
</ul>
<p>其中，固定位置就是在找源文件 <code>generator</code> 中第二次出现 <code>ENCRYPTED</code> 的位置，然后再次偏移 32 个字节。</p>
<pre class="line-numbers language-python"><code class="language-python">    _ENCRYPT_STR <span class="token operator">=</span> ENCRYPTED_STR<span class="token punctuation">;</span>
    v10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ENCRYPTED_LEN <span class="token operator">=</span> strlen<span class="token punctuation">(</span>ENCRYPTED_STR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    do
    <span class="token punctuation">{</span>
      do
        <span class="token operator">+</span><span class="token operator">+</span>v9<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> strncmp<span class="token punctuation">(</span><span class="token operator">&amp;</span>file_contents<span class="token punctuation">[</span>v9<span class="token punctuation">]</span><span class="token punctuation">,</span> _ENCRYPT_STR<span class="token punctuation">,</span> ENCRYPTED_LEN<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">+</span><span class="token operator">+</span>v10<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> v10 <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    v11 <span class="token operator">=</span> <span class="token operator">&amp;</span>file_start_off_32<span class="token punctuation">[</span>loc2 <span class="token operator">+</span> ENCRYPTED_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    v12 <span class="token operator">=</span> loc2 <span class="token operator">+</span> ENCRYPTED_LEN<span class="token punctuation">;</span>
    len <span class="token operator">=</span> file_size <span class="token operator">-</span> <span class="token punctuation">(</span>loc2 <span class="token operator">+</span> ENCRYPTED_LEN<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">;</span>
    decrypt<span class="token punctuation">(</span><span class="token operator">&amp;</span>file_start_off_32<span class="token punctuation">[</span>v12<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>license<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sha256_file_start<span class="token punctuation">(</span>v11<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> !memcmp<span class="token punctuation">(</span><span class="token operator">&amp;</span>output<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_contents<span class="token punctuation">[</span>v12<span class="token punctuation">]</span><span class="token punctuation">,</span> 0x20u<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v14 <span class="token operator">=</span> fopen<span class="token punctuation">(</span><span class="token string">"out.exe"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fwrite<span class="token punctuation">(</span>v11<span class="token punctuation">,</span> 1u<span class="token punctuation">,</span> len<span class="token punctuation">,</span> v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fclose<span class="token punctuation">(</span>v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sprintf<span class="token punctuation">(</span>byte_406020<span class="token punctuation">,</span> <span class="token string">"out.exe %s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      system<span class="token punctuation">(</span>byte_406020<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时，我们需要确保生成的文件的校验对应的哈希值恰好为指定的值，由于文件最后是一个 exe 文件，所以我们可以认为最后的文件头就是标准的 exe 文件，因此就不需要知道原始的 license 文件，进而我们可以编写 python 脚本生成 exe。</p>
<p>在生成的 exe 中，我们分析出程序的基本流程为</p>
<ol>
<li>读取 license</li>
<li>使用 license 作为 seed 分别生成 pq</li>
<li>利用 p，q 生成 n，e，d。</li>
</ol>
<p>其漏洞出现在生成 p，q 的方法上，而且生成 p 和 q 的方法类似。</p>
<p>我们如果仔细分析下生成素数的函数的话，可以看到每个素数都是分为两部分生成的</p>
<ol>
<li>生成左半部分 512 位。</li>
<li>生成右半部分 512 位。</li>
<li>左右构成 1024 比特位，判断是不是素数，是素数就成功，不是素数，继续生成。</li>
</ol>
<p>其中生成每部分的方式相同，方式为</p>
<pre class="line-numbers language-python"><code class="language-python">sha512<span class="token punctuation">(</span>const1<span class="token operator">|</span>const2<span class="token operator">|</span>const3<span class="token operator">|</span>const4<span class="token operator">|</span>const5<span class="token operator">|</span>const6<span class="token operator">|</span>const7<span class="token operator">|</span>const8<span class="token operator">|</span>v9<span class="token punctuation">)</span>
v9<span class="token operator">=</span>r<span class="token operator">%</span><span class="token number">1000000007</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p> 只有 v9 会有所变化，但是它的范围却是固定的。</p>
<p>那么，如果我们表示 p，q 为</p>
<p>$p=a*2^{512}+b$</p>
<p>$q=c*2^{512}+d$</p>
<p>那么</p>
<p>$n=pq=ac<em>2^{1024}+(ad+bc)</em>2^{512}+bd$</p>
<p>那么</p>
<p>$n \equiv bd \bmod 2^{512}$</p>
<p>而且由于 p 和 q 在生成时，a，b，c，d 均只有 1000000007 种可能性。</p>
<p>进而，我们可以枚举所有的可能性，首先计算出 b 可能的集合为 S，同时我们使用中间相遇攻击，计算</p>
<p>$n/d \equiv b \bmod 2^{512}$</p>
<p>这里由于 b 和 d 都是 p 的尾数，所以一定不会是 2 的倍数，进而必然存在逆元。</p>
<p>这样做虽然可以，然而，我们可以简单算一下存储空间</p>
<p>$64*1000000007 / 1024 / 1024 / 1024=59$</p>
<p>也就是说需要 59 G，太大了，，所以我们仍然需要进一步考虑</p>
<p>$n \equiv bd \bmod 2^{64}$</p>
<p>这样，我们的内存需求瞬间就降到了 8 G左右。我们仍然使用枚举的方法进行运算。</p>
<p>其次，我们不能使用 python，，python 占据空间太大，因此需要使用 c/c++ 编写。</p>
<p>枚举所有可能的 d 计算对应的值 $n/d$ 如果对应的值在集合 S 中，那么我们就可以认为找到了一对合法的 b 和 d，因此我们就可以恢复 p 和 q 的一半。</p>
<p>之后，我们根据</p>
<p>$n-bd=ac<em>2^{1024}+(ad+bc)</em>2^{512}$</p>
<p>可以得到</p>
<p>$\frac{n-bd}{2^{512}} = ac*2^{512}+ad+bc$</p>
<p>$\frac{n-bd}{2^{512}} \equiv ad+bc \bmod 2^{512}$</p>
<p>类似地，我们可以计算出 a 和 c，从而我们就可以完全恢复出 p 和 q。</p>
<p>在具体求解的过程中，在求 p 和 q 的一部分时，可以发现因为是模 $2^{64}$，所以可能存在碰撞（但其实就是一个是 p，另外一个是q，恰好对称。）。下面我们就求得了 b 对应的 v9。</p>
<p><strong>注意：这里枚举出来的空间大约占用 11 个 G（包括索引），所以请选择合适的位置。</strong></p>
<pre><code>b64: 9646799660ae61bd idx_b: 683101175 idx_d: 380087137
search 23000000
search 32000000
search 2b000000
search d000000
search 3a000000
search 1c000000
search 6000000
search 24000000
search 15000000
search 33000000
search 2c000000
search e000000
b64: 9c63259ccab14e0b idx_b: 380087137 idx_d: 683101175
search 1d000000
search 3b000000
search 7000000
search 16000000
search 25000000
search 34000000</code></pre><p>其实，我们在真正得到 p 或者 q 的一部分后，另外一部分完全可以使用暴力枚举的方式获取，因为计算量几乎都是一样的，最后结果为</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
hash <span class="token number">7000000</span>
hash <span class="token number">30000000</span>
p <span class="token operator">=</span> <span class="token number">13941980378318401138358022650359689981503197475898780162570451627011086685747898792021456273309867273596062609692135266568225130792940286468658349600244497842007796641075219414527752166184775338649475717002974228067471300475039847366710107240340943353277059789603253261584927112814333110145596444757506023869</span>
q <span class="token operator">=</span> <span class="token number">34708215825599344705664824520726905882404144201254119866196373178307364907059866991771344831208091628520160602680905288551154065449544826571548266737597974653701384486239432802606526550681745553825993460110874794829496264513592474794632852329487009767217491691507153684439085094523697171206345793871065206283</span>
plain text <span class="token number">13040004482825754828623640066604760502140535607603761856185408344834209443955563791062741885</span>
hash <span class="token number">16000000</span>
hash <span class="token number">25000000</span>
hash b000000
hash <span class="token number">34000000</span>
hash <span class="token number">1a000000</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
➜  <span class="token number">2018</span><span class="token operator">-</span>WCTF<span class="token operator">-</span>rsa git<span class="token punctuation">:</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ python
Python <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">14</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Mar <span class="token number">22</span> <span class="token number">2018</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">43</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>GCC <span class="token number">4.2</span><span class="token punctuation">.</span><span class="token number">1</span> Compatible Apple LLVM <span class="token number">9.0</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>clang<span class="token number">-900.0</span><span class="token punctuation">.</span><span class="token number">39.2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> on darwin
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token operator">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> p<span class="token operator">=</span><span class="token number">13040004482825754828623640066604760502140535607603761856185408344834209443955563791062741885</span>
<span class="token operator">>></span><span class="token operator">></span> hex<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
  File <span class="token string">"/usr/local/Cellar/python@2/2.7.14_3/Frameworks/Python.framework/Versions/2.7/lib/python2.7/encodings/hex_codec.py"</span><span class="token punctuation">,</span> line <span class="token number">42</span><span class="token punctuation">,</span> <span class="token keyword">in</span> hex_decode
    output <span class="token operator">=</span> binascii<span class="token punctuation">.</span>a2b_hex<span class="token punctuation">(</span>input<span class="token punctuation">)</span>
TypeError<span class="token punctuation">:</span> Odd<span class="token operator">-</span>length string
<span class="token operator">>></span><span class="token operator">></span> hex<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token string">'flag{fa6778724ed740396fc001b198f30313}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后我们便拿到 flag 了。</p>
<p><strong>详细的利用代码请参见 ctf-challenge 仓库。</strong></p>
<p>相关编译指令，需要链接相关的库。</p>
<pre class="line-numbers language-shell"><code class="language-shell">g++  exp2.cpp -std=c++11 -o main2 -lgmp -lcrypto -pthread<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="背包加密"><a href="#背包加密" class="headerlink" title="背包加密"></a>背包加密</h1><h2 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h2><p>首先，我们先来介绍一下背包问题，假定一个背包可以称重 W，现在有 n 个物品，其重量分别为 $a_1, a_2,…,a_n$ 我们想问一下装哪些物品可以恰好使得背包装满，并且每个物品只能被装一次。这其实就是在解这样的一个问题</p>
<p>$$<br>x_1a_1+x_2a_2+,…,+x_na_n=W<br>$$</p>
<p>其中所有的 $x_i$ 只能为 0 和 1。显然我们必须枚举所有的 n 个物品的组合才能解决这个问题，而复杂度也就是 $2^n$，这也就是背包加密的妙处所在。</p>
<p>在加密时，如果我们想要加密的明文为 x，那么我们可以将其表示为 n 位二进制数，然后分别乘上 $a_i$ 即可得到加密结果。</p>
<p>但是解密的时候，该怎么办呢？我们确实让其他人难以解密密文，但是我们自己也确实没有办法解密密文。</p>
<p>但是当 $a_i$ 是超递增的话，我们就有办法解了，所谓超递增是指序列满足如下条件</p>
<p>$$<br>a_i&gt;\sum_{k=1}^{i-1}a_k<br>$$</p>
<p>即第 i 个数大于前面所有数的和。</p>
<p>为什么满足这样的条件就可以解密了呢？这是因为如果加密后的结果大于 $a_n$ 的话，其前面的系数为必须 1 的。反之，无论如何也无法使得等式成立。因此，我们可以立马得到对应的明文。</p>
<p>但是，这样又出现了一个问题，由于 $a_i$ 是公开的，如果攻击者截获了密文，那么它也就很容易去破解这样的密码。为了弥补这样的问题，就出现了 Merkle–Hellman 这样的加密算法，我们可以使用初始的背包集作为私钥，变换后的背包集作为公钥，再稍微改动加密过程，即可。</p>
<p>这里虽然说了超递增序列，但是却没有说是如何生成的。</p>
<h2 id="Merkle–Hellman"><a href="#Merkle–Hellman" class="headerlink" title="Merkle–Hellman"></a>Merkle–Hellman</h2><h3 id="公私钥生成"><a href="#公私钥生成" class="headerlink" title="公私钥生成"></a>公私钥生成</h3><h4 id="生成私钥"><a href="#生成私钥" class="headerlink" title="生成私钥"></a>生成私钥</h4><p>私钥就是我们的初始的背包集，这里我们使用超递增序列，怎么生成呢？我们可以假设 $a_1=1$，那么 $a_2$ 大于 1 即可，类似的可以依次生成后面的值。</p>
<h4 id="生成公钥"><a href="#生成公钥" class="headerlink" title="生成公钥"></a>生成公钥</h4><p>在生成公钥的过程中主要使用了模乘的运算。</p>
<p>首先，我们生成模乘的模数 m，这里要确保</p>
<p>$$<br>m&gt;\sum_{i=1}^{i=n}a_i<br>$$</p>
<p>其次，我们选择模乘的乘数 w，作为私钥并且确保</p>
<p>$$<br>gcd(w,m)=1<br>$$</p>
<p>之后，我们便可以通过如下公式生成公钥</p>
<p>$$<br>b_i \equiv w a_i \bmod m<br>$$</p>
<p>并将这个新的背包集 $b_i$ 和 m 作为公钥。</p>
<h3 id="加解密"><a href="#加解密" class="headerlink" title="加解密"></a>加解密</h3><h4 id="加密-7"><a href="#加密-7" class="headerlink" title="加密"></a>加密</h4><p>假设我们要加密的明文为 v，其每一个比特位为 $v_i$，那么我们加密的结果为</p>
<p>$$<br>\sum_{i=1}^{i=n}b_iv_i \bmod m<br>$$</p>
<h4 id="解密-7"><a href="#解密-7" class="headerlink" title="解密"></a>解密</h4><p>对于解密方，首先可以求的 w 关于 m 的逆元 $w^{-1}$。</p>
<p>然后我们可以将得到的密文乘以 $w^{-1}$ 即可得到明文，这是因为</p>
<p>$$<br>\sum_{i=1}^{i=n}w^{-1}b_iv_i \bmod m=\sum_{i=1}^{i=n}a_iv_i \bmod m<br>$$</p>
<p>这里有</p>
<p>$$<br>b_i \equiv w a_i \bmod m<br>$$</p>
<p>对于每一块的加密的消息都是小于 m 的，所以求得结果自然也就是明文了。</p>
<h3 id="破解-5"><a href="#破解-5" class="headerlink" title="破解"></a>破解</h3><p>该加密体制在提出后两年后该体制即被破译，破译的基本思想是我们不一定要找出正确的乘数 w（即陷门信息），只需找出任意模数 <code>m′</code> 和乘数 <code>w′</code>，只要使用 <code>w′</code> 去乘公开的背包向量 B 时，能够产生超递增的背包向量即可。</p>
<h3 id="例子-6"><a href="#例子-6" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 2014 年 ASIS Cyber Security Contest Quals 中的 Archaic 为例，<a href="https://github.com/ctfs/write-ups-2014/tree/b02bcbb2737907dd0aa39c5d4df1d1e270958f54/asis-ctf-quals-2014/archaic" target="_blank" rel="noopener">题目链接</a>。</p>
<p>首先查看源程序</p>
<pre class="line-numbers language-python"><code class="language-python">secret <span class="token operator">=</span> <span class="token string">'CENSORED'</span>
msg_bit <span class="token operator">=</span> bin<span class="token punctuation">(</span>int<span class="token punctuation">(</span>secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>首先得到了 secret 的所有二进制位。</p>
<p>其次，利用如下函数得到 keypair，包含公钥与私钥。</p>
<pre class="line-numbers language-python"><code class="language-python">keyPair <span class="token operator">=</span> makeKey<span class="token punctuation">(</span>len<span class="token punctuation">(</span>msg_bit<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>仔细分析 makekey 函数，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">makeKey</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    privKey <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">**</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    s <span class="token operator">=</span> privKey<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        privKey<span class="token punctuation">.</span>append<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">**</span><span class="token punctuation">(</span>n <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        s <span class="token operator">+=</span> privKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    q <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>privKey<span class="token punctuation">[</span>n<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>privKey<span class="token punctuation">[</span>n<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
    <span class="token keyword">while</span> gmpy2<span class="token punctuation">.</span>gcd<span class="token punctuation">(</span>r<span class="token punctuation">,</span> q<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
    pubKey <span class="token operator">=</span> <span class="token punctuation">[</span> r<span class="token operator">*</span>w <span class="token operator">%</span> q <span class="token keyword">for</span> w <span class="token keyword">in</span> privKey <span class="token punctuation">]</span>
    <span class="token keyword">return</span> privKey<span class="token punctuation">,</span> q<span class="token punctuation">,</span> r<span class="token punctuation">,</span> pubKey<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出 prikey 是一个超递增序列，并且得到的 q 比 prikey 中所有数的和还要大，此外我们得到的 r，恰好与 q 互素，这一切都表明了该加密是一个背包加密。</p>
<p>果然加密函数就是对于消息的每一位乘以对应的公钥并求和。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> pubKey<span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg_bit <span class="token operator">=</span> msg
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> <span class="token number">0</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> bit <span class="token keyword">in</span> msg_bit<span class="token punctuation">:</span>
        cipher <span class="token operator">+=</span> int<span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token operator">*</span>pubKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> bin<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于破解的脚本我们直接使用 <a href="https://github.com/ctfs/write-ups-2014/tree/b02bcbb2737907dd0aa39c5d4df1d1e270958f54/asis-ctf-quals-2014/archaic" target="_blank" rel="noopener">GitHub</a> 上的脚本。进行一些简单的修改。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> binascii
<span class="token comment" spellcheck="true"># open the public key and strip the spaces so we have a decent array</span>
fileKey <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"pub.Key"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
pubKey <span class="token operator">=</span> fileKey<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'[]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
nbit <span class="token operator">=</span> len<span class="token punctuation">(</span>pubKey<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># open the encoded message</span>
fileEnc <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"enc.txt"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
encoded <span class="token operator">=</span> fileEnc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">"start"</span>
<span class="token comment" spellcheck="true"># create a large matrix of 0's (dimensions are public key length +1)</span>
A <span class="token operator">=</span> Matrix<span class="token punctuation">(</span>ZZ<span class="token punctuation">,</span> nbit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> nbit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># fill in the identity matrix</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>nbit<span class="token punctuation">)</span><span class="token punctuation">:</span>
    A<span class="token punctuation">[</span>i<span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment" spellcheck="true"># replace the bottom row with your public key</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>nbit<span class="token punctuation">)</span><span class="token punctuation">:</span>
    A<span class="token punctuation">[</span>i<span class="token punctuation">,</span> nbit<span class="token punctuation">]</span> <span class="token operator">=</span> pubKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># last element is the encoded message</span>
A<span class="token punctuation">[</span>nbit<span class="token punctuation">,</span> nbit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>int<span class="token punctuation">(</span>encoded<span class="token punctuation">)</span>

res <span class="token operator">=</span> A<span class="token punctuation">.</span>LLL<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> nbit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># print solution</span>
    M <span class="token operator">=</span> res<span class="token punctuation">.</span>row<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> M<span class="token punctuation">:</span>
        <span class="token keyword">if</span> m <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">and</span> m <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            flag <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">break</span>
    <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
        <span class="token keyword">print</span> i<span class="token punctuation">,</span> M
        M <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> M<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># remove the last bit</span>
        M <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        M <span class="token operator">=</span> hex<span class="token punctuation">(</span>int<span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span> M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出之后再解码下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token number">295</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">415349535f3962643364356664323432323638326331393536383830366130373036316365</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> binascii
<span class="token operator">>></span><span class="token operator">></span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span><span class="token string">'415349535f3962643364356664323432323638326331393536383830366130373036316365'</span><span class="token punctuation">)</span>
<span class="token string">'ASIS_9bd3d5fd2422682c19568806a07061ce'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，我们得到的 LLL 攻击得到的矩阵 res 的只包含 01 值的行才是我们想要的结果，因为我们对于明文加密时，会将其分解为二进制比特串。此外，我们还需要去掉对应哪一行的最后一个数字。</p>
<p>flag 是 <code>ASIS_9bd3d5fd2422682c19568806a07061ce</code>。</p>
<h1 id="离散对数"><a href="#离散对数" class="headerlink" title="离散对数"></a>离散对数</h1><h2 id="基本定义"><a href="#基本定义" class="headerlink" title="基本定义"></a>基本定义</h2><p>在了解离散对数时，我们先来了解几个基本定义。</p>
<p><strong>定义1</strong></p>
<p>在群 G 中，g 为 G 的生成元，也就是说群 G 中每一个元素都可以写成 $y=g^k$，我们称 k 为 y 在群 G 中的对数。</p>
<p><strong>定义2</strong></p>
<p>设 $m\geq 1$，$(a,m)=1$ ，使得 $a^d \equiv 1\pmod m$ 成立的最小正整数 d 称为 a 对模 m 的指数或者阶，我们一般将其记为 $\delta_m(a)$。</p>
<p><strong>定义3</strong></p>
<p>当 $\delta_m(a)=\varphi(m)$ 时，称 a 是模 m 的原根，简称 m 的原根。</p>
<h2 id="一些性质"><a href="#一些性质" class="headerlink" title="一些性质"></a>一些性质</h2><p><strong>性质1</strong></p>
<p>使得 $a^d \equiv 1\pmod m$ 成立的最小正整数 $d$ ，必有$d\mid\varphi(m)$。</p>
<p><strong>性质2</strong></p>
<p>模 $m$ 剩余系存在原根的充要条件是 $m=2,4,p^{\alpha},2p^{\alpha}$ ，其中 $p$ 为奇素数， $\alpha$ 为正整数。</p>
<h2 id="离散对数问题"><a href="#离散对数问题" class="headerlink" title="离散对数问题"></a>离散对数问题</h2><p>已知 $g,p,y$ ，对于方程 $y\equiv g^x \pmod p$ ，求解 $x$ 是一个难解问题。但是当 $p$ 具有一定的特性时就可能可以求解，比如，这个群的阶是一个光滑数。</p>
<p>正是上述这个问题构成了目前很大一部分现代密码学，包括 Diffie–Hellman 密钥交换， ElGamal 算法，ECC 等。</p>
<h2 id="离散对数求解方式"><a href="#离散对数求解方式" class="headerlink" title="离散对数求解方式"></a>离散对数求解方式</h2><h3 id="暴力破解"><a href="#暴力破解" class="headerlink" title="暴力破解"></a>暴力破解</h3><p>给定 $y\equiv g^x \pmod p$，我们可以暴力枚举 $x$ 从而得到真正的 $x$ 的值。</p>
<h3 id="Baby-step-giant-step"><a href="#Baby-step-giant-step" class="headerlink" title="Baby-step giant-step"></a>Baby-step giant-step</h3><p>这一方法通常被称为小步大步法，这一方法使用了中间相遇攻击的思想。</p>
<p>我们可以令 $x=im+j$，其中 $m= \lceil \sqrt n\rceil$ ，那么整数 i 和 j 都在 0 到 m 的范围内。</p>
<p>因此</p>
<p>$$y=g^x=g^{im+j}$$</p>
<p>也就是</p>
<p>$$y(g^{-m})^i=g^j$$</p>
<p>那么我们就可以枚举所有的 j 并进行计算，并将其存储到一个集合 S 中，然后我们再次枚举 i，计算 $y(g^{-m})^i$，一旦我们发现计算的结果在集合 S 中，则说明我们得到了一个碰撞，进而得到了 i 和 j。</p>
<p>这显然是一个时间与空间的折中的方式，我们将一个 $O(n)$ 的时间复杂度，$O(1)$ 空间复杂度的算法转换为了一个$O(\sqrt n)$的时间复杂度和$O(\sqrt n)$ 的空间复杂度的算法。</p>
<p>其中</p>
<ul>
<li>每一次 j 的增加表示“baby-step”，一次乘上 $g$。</li>
<li>每一次 i 的增加表示“giant-step”，一次乘上 $g^{-m}$ 。</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bsgs</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> y<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> int<span class="token punctuation">(</span>ceil<span class="token punctuation">(</span>sqrt<span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    S <span class="token operator">=</span> <span class="token punctuation">{</span>pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> j<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span> j <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">}</span>
    gs <span class="token operator">=</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> p <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> m<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> y <span class="token keyword">in</span> S<span class="token punctuation">:</span>
            <span class="token keyword">return</span> i <span class="token operator">*</span> m <span class="token operator">+</span> S<span class="token punctuation">[</span>y<span class="token punctuation">]</span>
        y <span class="token operator">=</span> y <span class="token operator">*</span> gs <span class="token operator">%</span> p
    <span class="token keyword">return</span> None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Pollard’s-ρ-algorithm"><a href="#Pollard’s-ρ-algorithm" class="headerlink" title="Pollard’s ρ algorithm"></a>Pollard’s ρ algorithm</h3><p>我们可以以$O(\sqrt n)$的时间复杂度和$O(1)$ 的空间复杂度来解决上述问题。具体原理请自行谷歌。</p>
<h3 id="Pollard’s-kangaroo-algorithm"><a href="#Pollard’s-kangaroo-algorithm" class="headerlink" title="Pollard’s kangaroo algorithm"></a>Pollard’s kangaroo algorithm</h3><p>如果我们知道 x 的范围为 $a \leq x \leq b$，那么我们可以以$O(\sqrt{b-a})$ 的时间复杂度解决上述问题。具体原理请自行谷歌。</p>
<h3 id="Pohlig-Hellman-algorithm"><a href="#Pohlig-Hellman-algorithm" class="headerlink" title="Pohlig-Hellman algorithm"></a>Pohlig-Hellman algorithm</h3><p>不妨假设上述所提到的群关于元素 $g$ 的阶为 $n$， $n$ 为一个光滑数： $n=\prod\limits_{i=1}^r p_i^{e_i}$。</p>
<ol>
<li>对于每个 $i \in {1,\ldots,r}$ ：<ol>
<li>计算 $g_i \equiv g^{n/p_i^{e_i}} \pmod m$。根据拉格朗日定理， $g_i$ 在群中的阶为 $p_i^{e_i}$ 。</li>
<li>计算 $y_i \equiv y^{n/p_i^{e_i}} \equiv g^{xn/p_i^{e_i}} \equiv g_i^{x} \equiv g_i^{x \bmod p_i^{e_i}} \equiv g_i^{x_i} \pmod m$，这里我们知道 $y_i,m,g_i$，而$x_i$ 的范围为$[0,p_i^{e_i})$，由 $n$ 是一个光滑数，可知其范围较小，因此我们可以使用 <em>Pollard’s kangaroo algorithm</em> 等方法快速求得$x_i$。</li>
</ol>
</li>
<li>根据上述的推导，我们可以得到对于 $i \in {1,\ldots,r}$ ，$x \equiv x_i \pmod{p_i^{e_i}}$ ，该式可用中国剩余定理求解。</li>
</ol>
<p>上述过程可用下图简单描述：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/Pohlig-Hellman-Diagram.png" alt=""></p>
<p>其复杂度为$O\left(\sum\limits _i e_i\left(\log n+\sqrt{p_i}\right)\right)$，可以看出复杂度还是很低的。</p>
<p>但当 $n$ 为素数，$m=2n+1$，那么复杂度和 $O(\sqrt m)$ 是几乎没有差别的。</p>
<h2 id="2018-国赛-crackme-java"><a href="#2018-国赛-crackme-java" class="headerlink" title="2018 国赛 crackme java"></a>2018 国赛 crackme java</h2><p>代码如下</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>math<span class="token punctuation">.</span>BigInteger<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test1</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> BigInteger two <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> BigInteger p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">"11360738295177002998495384057893129964980131806509572927886675899422214174408333932150813939357279703161556767193621832795605708456628733877084015367497711"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> BigInteger h<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">"7854998893567208831270627233155763658947405610938106998083991389307363085837028364154809577816577515021560985491707606165788274218742692875308216243966916"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     Alice write the below algorithm for encryption.
     The public key {p, h} is broadcasted to everyone.
    @param val: The plaintext to encrypt.
        We suppose val only contains lowercase letter {a-z} and numeric charactors, and is at most 256 charactors in length.
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">pkEnc</span><span class="token punctuation">(</span>String val<span class="token punctuation">)</span><span class="token punctuation">{</span>
        BigInteger<span class="token punctuation">[</span><span class="token punctuation">]</span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        BigInteger bVal<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BigInteger r <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>two<span class="token punctuation">.</span><span class="token function">modPow</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>h<span class="token punctuation">.</span><span class="token function">modPow</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>bVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"=="</span><span class="token operator">+</span>ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* Alice write the below algorithm for decryption. x is her private key, which she will never let you know.
    public static String skDec(String val,BigInteger x){
        if(!val.contains("==")){
            return null;
        }
        else {
            BigInteger val0=new BigInteger(val.split("==")[0],36);
            BigInteger val1=new BigInteger(val.split("==")[1],36);
            BigInteger s=val0.modPow(x,p).modInverse(p);
            return val1.multiply(s).mod(p).toString(36);
        }
    }
   */</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"You intercepted the following message, which is sent from Bob to Alice:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BigInteger bVal1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">"a9hgrei38ez78hl2kkd6nvookaodyidgti7d9mbvctx3jjniezhlxs1b1xz9m0dzcexwiyhi4nhvazhhj8dwb91e7lbbxa4ieco"</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BigInteger bVal2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token string">"2q17m8ajs7509yl9iy39g4znf08bw3b33vibipaa1xt5b8lcmgmk6i5w4830yd3fdqfbqaf82386z5odwssyo3t93y91xqd5jb0zbgvkb00fcmo53sa8eblgw6vahl80ykxeylpr4bpv32p7flvhdtwl4cxqzc"</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BigInteger r <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bVal1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bVal2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a9hgrei38ez78hl2kkd6nvookaodyidgti7d9mbvctx3jjniezhlxs1b1xz9m0dzcexwiyhi4nhvazhhj8dwb91e7lbbxa4ieco==2q17m8ajs7509yl9iy39g4znf08bw3b33vibipaa1xt5b8lcmgmk6i5w4830yd3fdqfbqaf82386z5odwssyo3t93y91xqd5jb0zbgvkb00fcmo53sa8eblgw6vahl80ykxeylpr4bpv32p7flvhdtwl4cxqzc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Please figure out the plaintext!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基本功能为计算</p>
<p>$r_0=2^r \bmod p$</p>
<p>$r_1 =b*h^r \bmod p$</p>
<p>可以发现，r 的范围为 $[0,2^{32})$，所以我们可以使用 BSGS 算法，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sage<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>

c1 <span class="token operator">=</span> int<span class="token punctuation">(</span>
    <span class="token string">'a9hgrei38ez78hl2kkd6nvookaodyidgti7d9mbvctx3jjniezhlxs1b1xz9m0dzcexwiyhi4nhvazhhj8dwb91e7lbbxa4ieco'</span><span class="token punctuation">,</span>
    <span class="token number">36</span>
<span class="token punctuation">)</span>
c2 <span class="token operator">=</span> int<span class="token punctuation">(</span>
    <span class="token string">'2q17m8ajs7509yl9iy39g4znf08bw3b33vibipaa1xt5b8lcmgmk6i5w4830yd3fdqfbqaf82386z5odwssyo3t93y91xqd5jb0zbgvkb00fcmo53sa8eblgw6vahl80ykxeylpr4bpv32p7flvhdtwl4cxqzc'</span><span class="token punctuation">,</span>
    <span class="token number">36</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span> c1<span class="token punctuation">,</span> c2
p <span class="token operator">=</span> <span class="token number">11360738295177002998495384057893129964980131806509572927886675899422214174408333932150813939357279703161556767193621832795605708456628733877084015367497711</span>
h <span class="token operator">=</span> <span class="token number">7854998893567208831270627233155763658947405610938106998083991389307363085837028364154809577816577515021560985491707606165788274218742692875308216243966916</span>
<span class="token comment" spellcheck="true"># generate the group</span>
const2 <span class="token operator">=</span> <span class="token number">2</span>
const2 <span class="token operator">=</span> Mod<span class="token punctuation">(</span>const2<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Mod<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Mod<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
h <span class="token operator">=</span> Mod<span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'2'</span><span class="token punctuation">,</span> bsgs<span class="token punctuation">(</span>const2<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> bounds<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">^</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r <span class="token operator">=</span> <span class="token number">152351913</span>

num <span class="token operator">=</span> long<span class="token punctuation">(</span>c2 <span class="token operator">/</span> <span class="token punctuation">(</span>h<span class="token operator">**</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> num<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ElGamal"><a href="#ElGamal" class="headerlink" title="ElGamal"></a>ElGamal</h1><h2 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h2><p>ElGamal算法的安全性是基于求解离散对数问题的困难性，于1984年提出，也是一种双钥密码体制，既可以用于加密又可用于数字签名。</p>
<p>如果我们假设p是至少是160位的十进制素数，<strong>并且p-1有大素因子</strong>，此外g是 $Z_p^<em>$  的生成元，并且 $y \in Z_p^</em>$  。那么如何找到一个唯一的整数x($0\leq x \leq p-2$) ，满足$g^x \equiv y \bmod p$ 在算法上是困难的，这里将x记为$x=log_gy$ 。</p>
<h2 id="基本原理-2"><a href="#基本原理-2" class="headerlink" title="基本原理"></a>基本原理</h2><p>这里我们假设A要给B发送消息m。</p>
<h3 id="密钥生成-1"><a href="#密钥生成-1" class="headerlink" title="密钥生成"></a>密钥生成</h3><p>基本步骤如下</p>
<ol>
<li>选取一个足够大的素数p，以便于在$Z_p$ 上求解离散对数问题是困难的。</li>
<li>选取$Z_p^*$ 的生成元g。</li>
<li>随机选取整数k,$0\leq k \leq p-2$ ，并计算$g^k \equiv y \bmod p$ 。</li>
</ol>
<p>其中私钥为{k}，公钥为{p,g,y} 。</p>
<h3 id="加密-8"><a href="#加密-8" class="headerlink" title="加密"></a>加密</h3><p>A选取随机数$r \in Z_{p-1}$ ，对明文加密$E_k(m,r)=(y_1,y_2)$ 。其中$y_1 \equiv g^r \bmod p$ ，$y_2 \equiv my^r \bmod p$ 。</p>
<h3 id="解密-8"><a href="#解密-8" class="headerlink" title="解密"></a>解密</h3><p>$D_k(y_1,y_2)=y_2(y_1^k)^-1 \bmod p \equiv m(g^k)^r(g^{rk})^{-1} \equiv m \bmod p$ 。</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><p>虽然我们知道了y1,但是我们却没有办法知道其对应的r。</p>
<h2 id="2015-MMA-CTF-Alicegame"><a href="#2015-MMA-CTF-Alicegame" class="headerlink" title="2015 MMA CTF Alicegame"></a>2015 MMA CTF Alicegame</h2><p>这里我们以2015年 MMA-CTF-2015 中的 Alicegame 为例进行介绍。这题最初在没有给出源码的时候却是比较难做，因为这个给一个 m，给一个 r 就得到加密结果，，这太难想。</p>
<p>我们来简单分析一下源码，首先程序最初生成了 pk 与 sk</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token punctuation">(</span>pk<span class="token punctuation">,</span> sk<span class="token punctuation">)</span> <span class="token operator">=</span> genkey<span class="token punctuation">(</span>PBITS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中genkey函数如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">genkey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
    g <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    x <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token number">-1</span><span class="token punctuation">)</span>
    h <span class="token operator">=</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    pk <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
    sk <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>pk<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>p为k位的素数，g为(2,p)范围内的书，x在(1,p-1)范围内。并且计算了$h \equiv g^x \bmod p$ 。看到这里，差不多就知道，这应该是一个数域上的ElGamal加密了。其中pk为公钥，sk为私钥。</p>
<p>接下来 程序输出了10次m和r。并且，利用如下函数加密</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>pk<span class="token punctuation">,</span> m<span class="token punctuation">,</span> r <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">(</span>p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token operator">=</span> pk
    <span class="token keyword">if</span> r <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        r <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token number">-1</span><span class="token punctuation">)</span>
    c1 <span class="token operator">=</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> r<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    c2 <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">*</span> pow<span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> p
    <span class="token keyword">return</span> <span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其加密方法确实是ElGamal方式的加密。</p>
<p>最后程序对flag进行了加密。此时的r是由程序自己random的。</p>
<p>分析一下，这里我们在十轮循环中可以控制m和r，并且</p>
<p>$c_1 \equiv g^r \bmod p$</p>
<p>$c_2 \equiv m * h^{r} \bmod p$</p>
<p>如果我们设置</p>
<ol>
<li>r=1，m=1，那么我们就可以获得$c_1=g,c_2=h$ 。</li>
<li>r=1，m=-1，那么我们就可以获得$c_1=g, c_2 = p-h$ 。进而我们就可以得到素数p。</li>
</ol>
<p>我们得到素数p有什么用呢?p的位数在201位左右，很大啊。</p>
<p>但是啊，它生成素数p之后，没有进行检查啊。我们在之前说过p-1必须有大素因子，如果有小的素因子的话，那我们就可以攻击了。其攻击主要是使用到了baby step-giant step 与 Pohlig-Hellman algorithm 算法，有兴趣的可以看看，这里sage本身自带的计算离散对数的函数已经可以处理这样的情况了，参见<a href="http://doc.sagemath.org/html/en/reference/groups/sage/groups/generic.html" target="_blank" rel="noopener">discrete_log</a> 。</p>
<p>具体代码如下，需要注意的是，，这个消耗内存比较大，，不要随便拿虚拟机跑。。。还有就是这尼玛交互让我头疼啊，，，</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> sage<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token keyword">def</span> <span class="token function">get_maxfactor</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> factor<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'factor done'</span>
    <span class="token keyword">return</span> f<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

maxnumber <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">70</span>
i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">'cycle: '</span><span class="token punctuation">,</span>i
    sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># get g,h</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"1\n"</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"1\n"</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> data
    <span class="token keyword">if</span> <span class="token string">'\n'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>data<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># receive m=</span>
        sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>g<span class="token punctuation">,</span>h<span class="token punctuation">)</span> <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get g,p</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"-1\n"</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"1\n"</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> data
    <span class="token keyword">if</span> <span class="token string">'\n'</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span>data<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># receive m=</span>
        sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>g<span class="token punctuation">,</span>tmp<span class="token punctuation">)</span> <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    p <span class="token operator">=</span> tmp<span class="token operator">+</span>h
    tmp <span class="token operator">=</span> get_maxfactor<span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> tmp<span class="token operator">&lt;</span>maxnumber<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'may be success'</span>
        <span class="token comment" spellcheck="true"># skip the for cycle</span>
        sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'quit\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'receive data: '</span><span class="token punctuation">,</span>data
        data <span class="token operator">=</span> data<span class="token punctuation">[</span>data<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">)</span><span class="token operator">=</span>eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># generate the group</span>
        g <span class="token operator">=</span> Mod<span class="token punctuation">(</span>g<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        h <span class="token operator">=</span> Mod<span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        c1 <span class="token operator">=</span> Mod<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        c2 <span class="token operator">=</span> Mod<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        x <span class="token operator">=</span> discrete_log<span class="token punctuation">(</span>h<span class="token punctuation">,</span> g<span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">"x = "</span><span class="token punctuation">,</span> x
        <span class="token keyword">print</span> <span class="token string">"Flag: "</span><span class="token punctuation">,</span> long_to_bytes<span class="token punctuation">(</span>long<span class="token punctuation">(</span>c2 <span class="token operator">/</span> <span class="token punctuation">(</span> c1 <span class="token operator">**</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">'quit\n'</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    i <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后迫于计算机内存不够，，没计算出来，，，有时候会崩，多运行几次。。</p>
<h2 id="2018-Code-Blue-lagalem"><a href="#2018-Code-Blue-lagalem" class="headerlink" title="2018 Code Blue lagalem"></a>2018 Code Blue lagalem</h2><p>题目描述如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> key <span class="token keyword">import</span> FLAG

size <span class="token operator">=</span> <span class="token number">2048</span>
rand_state <span class="token operator">=</span> getRandomInteger<span class="token punctuation">(</span>size <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">keygen</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> getPrime<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    k <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> q <span class="token operator">*</span> k <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> isPrime<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        k <span class="token operator">+=</span> <span class="token number">1</span>
    g <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> q<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        g <span class="token operator">+=</span> <span class="token number">1</span>
    A <span class="token operator">=</span> getRandomInteger<span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">%</span> q
    B <span class="token operator">=</span> getRandomInteger<span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">%</span> q
    x <span class="token operator">=</span> getRandomInteger<span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">%</span> q
    h <span class="token operator">=</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">rand</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> M<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> rand_state
    rand_state<span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token punctuation">(</span>A <span class="token operator">*</span> rand_state <span class="token operator">+</span> B<span class="token punctuation">)</span> <span class="token operator">%</span> M<span class="token punctuation">,</span> rand_state
    <span class="token keyword">return</span> ret


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q <span class="token operator">=</span> pubkey
    <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;</span> m <span class="token operator">&lt;=</span> p
    r <span class="token operator">=</span> rand<span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
    c1 <span class="token operator">=</span> pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> r<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    c2 <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">*</span> pow<span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> p
    <span class="token keyword">return</span> <span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># pubkey, privkey = keygen(size)</span>

m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>
c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
c1_<span class="token punctuation">,</span> c2_ <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>pubkey<span class="token punctuation">,</span> m<span class="token punctuation">)</span>

<span class="token keyword">print</span> pubkey
<span class="token keyword">print</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c1_<span class="token punctuation">,</span> c2_<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，该算法就是一个 ElGamal 加密，给了同一个明文两组加密后的结果，其特点在于使用的随机数 r 是通过线性同余生成器生成的，则我们知道</p>
<p>$c2 \equiv m * h^{r} \bmod p$</p>
<p>$c2_ \equiv m<em>h^{(Ar+B) \bmod q} \equiv m</em>h^{Ar+B}\bmod p$</p>
<p>则</p>
<p>$c2^A*h^B/c2_ \equiv m^{A-1}\bmod p$</p>
<p>其中，c2，c2_，A，B，h 均知道。则我们知道</p>
<p>$m^{A-1} \equiv t \bmod p$</p>
<p>我们假设已知 p 的一个原根 g，则我们可以假设</p>
<p>$g^x \equiv t$</p>
<p>$g^y \equiv m$</p>
<p>则</p>
<p>$g^{y(A-1)}\equiv g^x \bmod p$</p>
<p>则</p>
<p>$y(A-1) \equiv x \bmod p-1$</p>
<p>进而我们知道</p>
<p>$y(A-1)-k(p-1)=x$</p>
<p>这里我们知道 A，p，x，则我们可以利用扩展欧几里得定理求得</p>
<p>$s(A-1)+w(p-1)=gcd(A-1,t-1)$</p>
<p>如果gcd(A-1,t-1)=d，则我们直接计算</p>
<p>$t^s \equiv m^{s(A-1)} \equiv m^d \bmod p$</p>
<p>如果 d=1，则直接知道 m。</p>
<p>如果 d 不为1，则就有点麻烦了。。</p>
<p>这里这道题目中恰好 d=1，因此可以很容易进行求解。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> gmpy2
data <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./transcript.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
c1_<span class="token punctuation">,</span> c2_ <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

tmp <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> A<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>h<span class="token punctuation">,</span> B<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>c2_<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
tmp <span class="token operator">=</span> tmp <span class="token operator">%</span> p

<span class="token keyword">print</span> <span class="token string">'t='</span><span class="token punctuation">,</span> tmp
<span class="token keyword">print</span> <span class="token string">'A='</span><span class="token punctuation">,</span> A
<span class="token keyword">print</span> <span class="token string">'p='</span><span class="token punctuation">,</span> p
gg<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcdext<span class="token punctuation">(</span>A <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> gg

m <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> x<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>flag</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-CodeBlue-lagalem git:(master) ✗ python exp.py
t= 24200833701856688878756977616650401715079183425722900529883514170904572086655826119242478732147288453761668954561939121426507899982627823151671207325781939341536650446260662452251070281875998376892857074363464032471952373518723746478141532996553854860936891133020681787570469383635252298945995672350873354628222982549233490189069478253457618473798487302495173105238289131448773538891748786125439847903309001198270694350004806890056215413633506973762313723658679532448729713653832387018928329243004507575710557548103815480626921755313420592693751934239155279580621162244859702224854316335659710333994740615748525806865323
A= 22171697832053348372915156043907956018090374461486719823366788630982715459384574553995928805167650346479356982401578161672693725423656918877111472214422442822321625228790031176477006387102261114291881317978365738605597034007565240733234828473235498045060301370063576730214239276663597216959028938702407690674202957249530224200656409763758677312265502252459474165905940522616924153211785956678275565280913390459395819438405830015823251969534345394385537526648860230429494250071276556746938056133344210445379647457181241674557283446678737258648530017213913802458974971453566678233726954727138234790969492546826523537158
p= 36416598149204678746613774367335394418818540686081178949292703167146103769686977098311936910892255381505012076996538695563763728453722792393508239790798417928810924208352785963037070885776153765280985533615624550198273407375650747001758391126814998498088382510133441013074771543464269812056636761840445695357746189203973350947418017496096468209755162029601945293367109584953080901393887040618021500119075628542529750701055865457182596931680189830763274025951607252183893164091069436120579097006203008253591406223666572333518943654621052210438476603030156263623221155480270748529488292790643952121391019941280923396132717
1
CBCTF{183a3ce8ed93df613b002252dfc741b2}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ECC"><a href="#ECC" class="headerlink" title="ECC"></a>ECC</h1><h2 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h2><p>ECC 全称为椭圆曲线加密，EllipseCurve Cryptography，是一种基于椭圆曲线数学的公钥密码。与传统的基于大质数因子分解困难性的加密方法不同，ECC依赖于解决椭圆曲线离散对数问题的困难性。它的优势主要在于相对于其它方法，它可以在使用较短密钥长度的同时保持相同的密码强度。目前椭圆曲线主要采用的有限域有</p>
<ul>
<li>以素数为模的整数域GF(p)，通常在通用处理器上更为有效。</li>
<li>特征为 2 的伽罗华域GF（2^m），可以设计专门的硬件。</li>
</ul>
<h2 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h2><p>我们首先来了解一下有限域上的椭圆曲线，有限域上的椭圆曲线是指在椭圆曲线的定义式</p>
<p>$y^2+axy+by=x^3+cx^2+dx+e$</p>
<p>中所有的系数都是在某个有限域GF(p)中的元素，其中p为一个大素数。</p>
<p>当然，并不是所有的椭圆曲线都适合于加密，最为常用的方程如下</p>
<p>$y^2=x^3+ax+b$</p>
<p>其中$4a^3+27b^2 \bmod p \neq 0$</p>
<p>我们称该方程的所有解(x,y)，($x\in Fp , y \in Fp$)，以及一个称为“无穷远点”(O)组成的集合为定义在Fp上的一个椭圆曲线，记为E(Fp)。</p>
<p>一般定义椭圆曲线密码需要以下条件</p>
<p>假设E(Fp)对于点的运算$\oplus$ 形成一个able群（交换群，逆元存在，封闭性等），设$p\in E(Fq)$ ，且满足下列条件的t很大</p>
<p>$p \oplus p \oplus … \oplus p=O$</p>
<p>其中共有t个p参与运算。这里我们称t为p的周期。此外，对于$Q\in E(Fq)$ ，定有某个正整数m使得下列式子成立，定义$m=log_pq$</p>
<p>$Q=m\cdot p =p \oplus p \oplus … \oplus p$ （m个p参与运算）</p>
<p>此外，假设G是该$E_q (a,b)$ 的生成元，即可以生成其中的所有元素，其阶为满足$nG=O$ 的最小正整数n。</p>
<h2 id="ECC中的ElGamal"><a href="#ECC中的ElGamal" class="headerlink" title="ECC中的ElGamal"></a>ECC中的ElGamal</h2><p>这里我们假设用户B要把消息加密后传给用户A。</p>
<h3 id="密钥生成-2"><a href="#密钥生成-2" class="headerlink" title="密钥生成"></a>密钥生成</h3><p>用户A先选择一条椭圆曲线$E_q (a,b)$ ，然后选择其上的一个生成元G，假设其阶为n，之后再选择一个正整数$n_a$作为密钥，计算$P_a=n_aG$。</p>
<p>其中，$E_q(a,b), q,G$都会被公开。</p>
<p>公钥为$P_a$，私钥为$n_a $。</p>
<h3 id="加密-9"><a href="#加密-9" class="headerlink" title="加密"></a>加密</h3><p>用户B在向用户A发送消息m，这里假设消息m已经被编码为椭圆曲线上的点，其加密步骤如下</p>
<ol>
<li>查询用户A的公钥$E_q(a,b), q, P_a,G$ 。</li>
<li>在(1,q-1) 的区间内选择随机数k 。</li>
<li>根据A的公钥计算点$(x_1,y_1)=kG$ 。</li>
<li>计算点$(x_2,y_2)=kP_a$ ，如果为O，则从第二步重新开始。</li>
<li>计算$C=m+(x_2,y_2)$</li>
<li>将$((x_1,y_1),C)$ 发送给A。</li>
</ol>
<h3 id="解密-9"><a href="#解密-9" class="headerlink" title="解密"></a>解密</h3><p>解密步骤如下</p>
<ol>
<li>利用私钥计算点$n_a(x_1,y_1)=n_akG=kP_a=(x_2,y_2)$。</li>
<li>计算消息$m=C-(x_2,y_2)$ 。</li>
</ol>
<h3 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h3><p>这里的关键点在于我们即使知道了$(x_1,y_1)$ 也难以知道k，这是由离散对数的问题的难度决定的。</p>
<h2 id="2013-SECCON-CTF-quals-Cryptanalysis"><a href="#2013-SECCON-CTF-quals-Cryptanalysis" class="headerlink" title="2013 SECCON CTF quals Cryptanalysis"></a>2013 SECCON CTF quals Cryptanalysis</h2><p>这里我们以2013年SECCON CTF quals 中的 Cryptanalysis 为例，题目如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/2013-seccon-ctf-crypt-desp.png" alt=""></p>
<p>这里，我们已知椭圆曲线方程以及对应的生成元 base，还知道相应的模数以及公钥以及加密后的结果。</p>
<p>但是可以看出的我们的模数太小，我们暴力枚举获取结果。</p>
<p>这里直接参考 github上的 sage 程序，暴力跑出 secret key。之后便可以解密了。</p>
<pre class="line-numbers language-python"><code class="language-python">
a <span class="token operator">=</span> <span class="token number">1234577</span>
b <span class="token operator">=</span> <span class="token number">3213242</span>
n <span class="token operator">=</span> <span class="token number">7654319</span>

E <span class="token operator">=</span> EllipticCurve<span class="token punctuation">(</span>GF<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span>

base <span class="token operator">=</span> E<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5234568</span><span class="token punctuation">,</span> <span class="token number">2287747</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
pub <span class="token operator">=</span> E<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2366653</span><span class="token punctuation">,</span> <span class="token number">1424308</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

c1 <span class="token operator">=</span> E<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5081741</span><span class="token punctuation">,</span> <span class="token number">6744615</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> E<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">610619</span><span class="token punctuation">,</span> <span class="token number">6218</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

X <span class="token operator">=</span> base

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> X <span class="token operator">==</span> pub<span class="token punctuation">:</span>
        secret <span class="token operator">=</span> i
        <span class="token keyword">print</span> <span class="token string">"[+] secret:"</span><span class="token punctuation">,</span> i
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        X <span class="token operator">=</span> X <span class="token operator">+</span> base
        <span class="token keyword">print</span> i

m <span class="token operator">=</span> c2 <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">*</span> secret<span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">"[+] x:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">"[+] y:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">"[+] x+y:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>暴力跑出结果</p>
<pre class="line-numbers language-shell"><code class="language-shell">[+] secret: 1584718
[+] x: 2171002
[+] y: 3549912
[+] x+y: 5720914<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="格概述"><a href="#格概述" class="headerlink" title="格概述"></a>格概述</h1><p>格在数学上至少有两种含义</p>
<ul>
<li>定义在非空有限集合上的偏序集合 L，满足集合 L 中的任意元素 a，b，使得 a，b 在 L 中存在一个最大下界，和最小上界。具体参见<a href="https://en.wikipedia.org/wiki/Lattice_(order)。" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Lattice_(order)。</a></li>
<li>群论中的定义，是 $R^n$ 中的满足某种性质的子集。当然，也可以是其它群。</li>
</ul>
<p>目前关于格方面的研究主要有以下几大方向</p>
<ol>
<li>格中计算问题的困难性，即这些问题的计算复杂性，主要包括 <ol>
<li>SVP 问题</li>
<li>CVP 问题</li>
</ol>
</li>
<li>如何求解格中的困难性问题，目前既有近似算法，也有一些精确性算法。</li>
<li>基于格的密码分析，即如何利用格理论分析一些已有的密码学算法，目前有如下研究<ol>
<li>Knapsack cryptosystems</li>
<li>DSA nonce biases</li>
<li>Factoring RSA keys with bits known</li>
<li>Small RSA private exponents</li>
<li>Stereotyped messages with small RSA exponents</li>
</ol>
</li>
<li>如何基于格困难问题设计新的密码体制，这也是后量子密码时代的重要研究方向之一，目前有以下研究<ol>
<li>Fully homomorphic encryption</li>
<li>The Goldreich–Goldwasser–Halevi (GGH) cryptosystem</li>
<li>The NTRU cryptosystem</li>
<li>The Ajtai–Dwork cryptosystem and the LWE cryptosystem</li>
</ol>
</li>
</ol>
<h2 id="格定义"><a href="#格定义" class="headerlink" title="格定义"></a>格定义</h2><p>格是 m 维欧式空间 $R^m$ 的 n ($m\geq n$) 个线性无关向量$b_i(1\leq i \leq n)$ 的所有整系数的线性组合，即<br>$L(B)={\sum\limits_{i=1}^{n}x_ib_i:x_i \in Z,1\leq i \leq n}$</p>
<p>这里 B 就是 n 个向量的集合，我们称</p>
<ul>
<li>这 n 个向量是格 L 的一组基。</li>
<li>格 L 的秩为 n。</li>
<li>格 L 的位数为 m。</li>
</ul>
<p>如果 m=n，那么我们称这个格式满秩的。</p>
<p>当然，也可以是其它群，不是 $R^m$。</p>
<h2 id="格中若干基本定义"><a href="#格中若干基本定义" class="headerlink" title="格中若干基本定义"></a>格中若干基本定义</h2><h3 id="successive-minima"><a href="#successive-minima" class="headerlink" title="successive minima"></a>successive minima</h3><p>格是 m 维欧式空间 $R^m$ 的秩为 n 的格，那么 L 的连续最小长度(successive minima)为 $\lambda_1,…,\lambda_n \in R$，满足对于任意的 $1\leq i\leq n$，$\lambda_i$ 是满足格中 i 个线性无关的向量$v_i$， $||v_j||\leq \lambda_i,1\leq j\leq i$ 的最小值。</p>
<p>自然的 $\lambda_i \leq \lambda_j ,\forall i &lt;j$。</p>
<h2 id="格中计算困难性问题"><a href="#格中计算困难性问题" class="headerlink" title="格中计算困难性问题"></a>格中计算困难性问题</h2><p><strong>最短向量问题(Shortest Vector Problem，SVP)</strong>：给定格 L 及其基向量 B ，找到格 L 中的非零向量 v 使得对于格中的任意其它非零向量 u，$||v|| \leq ||u||$。</p>
<p><strong>$\gamma$-近似最短向量问题(SVP-$\gamma$)</strong>：给定格 L，找到格 L 中的非零向量 v 使得对于格中的任意其它非零向量 u，$||v|| \leq \gamma||u||$。</p>
<p><strong>连续最小长度问题(Successive Minima Problem, SMP)</strong>:给定秩为 n 的格 L，找到格 L 中 n 个线性无关向量 $s_i$，满足 $\lambda_i(L)=||s_i||, 1\leq i \leq n$。</p>
<p><strong>最短线性无关向量问题(Shortest Independent Vector Problem, SIVP)</strong>：给定一个秩为 n 的格 L，找到格 L 中 n 个线性无关向量 $s_i$，满足$||s_i|| \leq \lambda_n(L), 1\leq i \leq n$。</p>
<p><strong>唯一最短向量问题(Unique Shortest Vector Problem, uSVP-$\gamma$)</strong>：给定格 L，满足 $ \lambda_2(L) &gt; \gamma \lambda_1(L)$，找到该格的最短向量。</p>
<p><strong>最近向量问题(Closest Vector Problem，CVP)</strong>：给定格 L和目标向量 $t\in R^m$，找到一个格中的非零向量 v，使得对于格中的任意非零向量 u，满足 $||v-t|| \leq ||u-t||$ 。</p>
<h1 id="格基规约算法"><a href="#格基规约算法" class="headerlink" title="格基规约算法"></a>格基规约算法</h1><h2 id="Lenstra–Lenstra–Lovasz"><a href="#Lenstra–Lenstra–Lovasz" class="headerlink" title="Lenstra–Lenstra–Lovasz"></a>Lenstra–Lenstra–Lovasz</h2><h3 id="基本介绍-4"><a href="#基本介绍-4" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>LLL 算法就是在格上找到一组基，满足如下效果</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/lll-def.png" alt=""></p>
<p>而且，这种方法生成的基所具有的如下性质是非常有用的</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/lll-property.png" alt=""></p>
<h3 id="简单应用"><a href="#简单应用" class="headerlink" title="简单应用"></a>简单应用</h3><p>这里我举一下 LLL paper 中给的第二个例子。给定 n 个实数 $\alpha_i,…,\alpha_n$，找到这 n 个数的有理线性逼近，即找到 n 个数 $m_i$，使得 $\sum\limits_{i=1}^{n}m_i\alpha_i$ 尽可能等于 0。 我们可以构造这样的矩阵，这里 $a_i$ 为 $\alpha_i$ 的有理逼近。</p>
<p>$$ A = \left[ \begin{matrix} 1   &amp; 0 &amp; 0     &amp; \cdots &amp; 0 &amp; ca_1     \ 0   &amp; 1  &amp; 0    &amp; \cdots &amp; 0 &amp; c a_2  \ 0   &amp; 0   &amp; 1   &amp; \cdots &amp; 0 &amp; c a_3 \\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ 0   &amp; 0   &amp;0   &amp; \cdots &amp; 1 &amp; c a_n     \ \end{matrix} \right]$$</p>
<p>矩阵为 n*(n+1) 的，我们可以根据格求行列式的方法来求一下这个格对应的行列式。</p>
<p>$det(L)=\sqrt{AA^T}$</p>
<p>我们进一步考虑这样的矩阵</p>
<p>$$ A = \left[ \begin{matrix} 1   &amp; 0 &amp; 0     &amp; \cdots &amp; 0 &amp; a_1     \ 0   &amp; 1  &amp; 0    &amp; \cdots &amp; 0 &amp; a_2  \ 0   &amp; 0   &amp; 1   &amp; \cdots &amp; 0 &amp; a_3 \\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ 0   &amp; 0   &amp;0   &amp; \cdots &amp; 1 &amp; a_n     \ \end{matrix} \right]$$</p>
<p>那么</p>
<p>$$ AA^T = \left[ \begin{matrix} 1+a_1^2   &amp; a_1a_2   &amp; a_1a_3 &amp; \cdots  &amp; a_1a_n     \ a_2a_1   &amp; 1+a_2^2  &amp; a_2a_3 &amp; \cdots &amp; a_2a_n  \ a_3a_1   &amp; a_3a_2   &amp; 1+a_3^2   &amp; \cdots  &amp; a_3a_n \ \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ a_na_1   &amp; a_na_2   &amp;a_na_3   &amp; \cdots  &amp; 1+a_n^2     \ \end{matrix} \right]$$</p>
<p>进一步我们从低维到高维大概试一试（严格证明，可以考虑添加一行和一列，左上角为1），得到格的行列式为</p>
<p>$\sqrt{1+\sum\limits_{i=1}^n\alpha_i^2}$</p>
<p>可以参见考研宇哥的如下证明</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/lll-application2.png" alt=""></p>
<p>那么经过 LLL 算法后，我们可以获得</p>
<p>$||b_1|| \leq 2^{\frac{n-1}{4}} (1+\sum\limits_{i=1}^n\alpha_i^2)^{\frac{1}{2(n+1)}}$</p>
<p>一般来说后一项在开 n 次方时趋向于1，因为 $a_i$ 都是常数，一般不会和 n 相关，所以</p>
<p>$||b_1|| \leq 2^{\frac{n-1}{4}}*k$</p>
<p>k 比较小。此外，$b_1$ 又是原向量的线性组合，那么</p>
<p>$b_1[n]=\sum\limits_{i=1}^{n}m_ic<em>a_i=c\sum\limits_{i=1}^{n}m_i</em>a_i$</p>
<p>显然如果 c 足够大，那么后面的求和必须足够小，才可以满足上面的约束。</p>
<h1 id="CVP"><a href="#CVP" class="headerlink" title="CVP"></a>CVP</h1><p>CVP是Lattice-based cryptography中尤为重要的一个问题。</p>
<p>问题的基本定义如下：给定格$L$的一组基与向量$\mathbf{v}$，找到在$L$上离$\mathbf{v}$最近的一个向量。</p>
<!--
TODO: Add more Lattice-based cryptography (CVP specifically) application intro here.
TODO: Make intro more descriptive and rigorous.
-->

<h2 id="Algorithms"><a href="#Algorithms" class="headerlink" title="Algorithms"></a>Algorithms</h2><h3 id="Babai’s-nearest-plane-algorithm"><a href="#Babai’s-nearest-plane-algorithm" class="headerlink" title="Babai’s nearest plane algorithm"></a>Babai’s nearest plane algorithm</h3><!--
TODO: Add intro
-->

<p>该算法输入一组格$L$(秩为$n$)的基$B$和一个目标向量$\mathbf{t}$，输出CVP问题的近似解。</p>
<ul>
<li>近似因子为$\gamma = 2^{\frac{n}{2}}$</li>
</ul>
<p>具体算法：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/babai_1.png" alt=""></p>
<ul>
<li>其中$c_j$为Gram-schmidt正交化中的系数取整，也即$proj_{b_{j}}(b)$的取整。</li>
</ul>
<p>对于该算法第二步的个人理解：在格基规约和正交化过后的基$B$中找到一个最靠近$\mathbf{t}$的线性组合。</p>
<h3 id="Babai’s-Rounding-Technique"><a href="#Babai’s-Rounding-Technique" class="headerlink" title="Babai’s Rounding Technique"></a>Babai’s Rounding Technique</h3><p>该算法是<code>Babai's nearest plane algorithm</code>的一个变种。</p>
<p>步骤可以表示为：</p>
<pre><code>N = rank(B), w = target
- B' = LLL(B)
- Find a linear combination [l_0, ... l_N] such that w = sum(l_i * b'_i).
* (b'_i is the i-th vector in the LLL-reduced basis B')
- Round each l_i to it's closest integer l'_i.
- Result v = sum(l'_i * b'_i)</code></pre><h2 id="相关内容"><a href="#相关内容" class="headerlink" title="相关内容"></a>相关内容</h2><h3 id="Hidden-number-problem"><a href="#Hidden-number-problem" class="headerlink" title="Hidden number problem"></a>Hidden number problem</h3><p>HNP的定义如下：</p>
<p>给定质数$p$、许多$t \in \mathbb{F}<em>p$以及每一个对应的$MSB</em>{l,p}(\alpha t)$，找出对应的$\alpha$。</p>
<ul>
<li>$MSB_{l,p}(x)$表示任一满足 $\lvert (x \mod p) - u \rvert \le \frac{p}{2^{l+1}}$ 的整数 $u$，近似为取$x \mod p$的$l$个最高有效位。</li>
</ul>
<p>根据参考3中的描述，当$l \approx \log^{\frac{1}{2}}{p}$时，有如下算法可以解决HNP：</p>
<p>我们可以将此问题转化为一个由该矩阵生成的格上的CVP问题：</p>
<p>$\left[ \begin{matrix} p &amp; 0 &amp; \dots &amp; 0 &amp; 0 \ 0 &amp; p &amp; \ddots &amp; \vdots &amp; \vdots \ \vdots &amp; \ddots &amp; \ddots &amp; 0 &amp; \vdots \ 0 &amp; 0 &amp; \dots &amp; p &amp; 0 \ t_1 &amp; t_2 &amp; \dots &amp; t_{n} &amp; \frac{1}{2^{l+1}} \end{matrix} \right]$</p>
<p>我们需要找到在格上离$\mathbf{u}=(u_1, u_2, \dots, u_{n}, 0)$最近的向量，所以在这里，我们可以采用<code>Babai's nearest plane algorithm</code>。最终我们可以得到一组向量 $\mathbf{v}=(\alpha \cdot t_1 \mod p, \alpha \cdot t_2 \mod p, \dots, \frac{\alpha}{2^{l+1}})$，从而算出 $\alpha$。</p>
<h3 id="BCTF-2018-guess-number"><a href="#BCTF-2018-guess-number" class="headerlink" title="BCTF 2018 - guess_number"></a>BCTF 2018 - guess_number</h3><p>题目提供了服务器端的代码：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> random<span class="token punctuation">,</span> sys
<span class="token keyword">from</span> flag <span class="token keyword">import</span> FLAG
<span class="token keyword">import</span> gmpy2

<span class="token keyword">def</span> <span class="token function">msb</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> x<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    delta <span class="token operator">=</span> p <span class="token operator">>></span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    ui <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>x <span class="token operator">-</span> delta<span class="token punctuation">,</span> x <span class="token operator">+</span> delta<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ui

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">160</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        alpha <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print(alpha)</span>
        t <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        u <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        k <span class="token operator">=</span> <span class="token number">10</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            t<span class="token punctuation">.</span>append<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            u<span class="token punctuation">.</span>append<span class="token punctuation">(</span>msb<span class="token punctuation">(</span>k<span class="token punctuation">,</span> alpha <span class="token operator">*</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> p<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span>
        guess <span class="token operator">=</span> raw_input<span class="token punctuation">(</span><span class="token string">'Input your guess number: '</span><span class="token punctuation">)</span>
        guess <span class="token operator">=</span> int<span class="token punctuation">(</span>guess<span class="token punctuation">)</span>
        <span class="token keyword">if</span> guess <span class="token operator">!=</span> alpha<span class="token punctuation">:</span>
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，程序一共执行5轮。在每一轮，程序会生成一个随机的$\alpha$和22个随机的$t_i$。对于每一个$t_i$，程序会取$u_i = MSB_{10,p}(\alpha\cdot{t_i\mod{p}})$，随后发送给客户端。我们需要根据提供的$t_i$和$u_i$计算出对应的$\alpha$。可以看到，该问题是一个典型的Hidden number problem，于是可以使用上述算法解决：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> ast
<span class="token keyword">import</span> telnetlib

<span class="token comment" spellcheck="true">#HOST, PORT = 'localhost', 9999</span>
HOST<span class="token punctuation">,</span> PORT <span class="token operator">=</span> <span class="token string">'60.205.223.220'</span><span class="token punctuation">,</span> <span class="token number">9999</span>

s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>
f <span class="token operator">=</span> s<span class="token punctuation">.</span>makefile<span class="token punctuation">(</span><span class="token string">'rw'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">recv_until</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> delim<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    buf <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> buf<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>delim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        buf <span class="token operator">+=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> buf

p <span class="token operator">=</span> <span class="token number">1461501637330902918203684832716283019655932542983</span>
k <span class="token operator">=</span> <span class="token number">10</span>

<span class="token keyword">def</span> <span class="token function">solve_hnp</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># http://www.isg.rhul.ac.uk/~sdg/igor-slides.pdf</span>
    M <span class="token operator">=</span> Matrix<span class="token punctuation">(</span>RationalField<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        M<span class="token punctuation">[</span>i<span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> p
        M<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    M<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">babai</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">:</span>
        A <span class="token operator">=</span> A<span class="token punctuation">.</span>LLL<span class="token punctuation">(</span>delta<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">)</span>
        G <span class="token operator">=</span> A<span class="token punctuation">.</span>gram_schmidt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        t <span class="token operator">=</span> w
        <span class="token keyword">for</span> i <span class="token keyword">in</span> reversed<span class="token punctuation">(</span>range<span class="token punctuation">(</span>A<span class="token punctuation">.</span>nrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">*</span> G<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>G<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> G<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>round<span class="token punctuation">(</span><span class="token punctuation">)</span>
            t <span class="token operator">-=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> c
        <span class="token keyword">return</span> w <span class="token operator">-</span> t

    closest <span class="token operator">=</span> babai<span class="token punctuation">(</span>M<span class="token punctuation">,</span> vector<span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>closest<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> p

<span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span>f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    u <span class="token operator">=</span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span>f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alpha <span class="token operator">=</span> solve_hnp<span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
    recv_until<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">'number: '</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>alpha<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>

t <span class="token operator">=</span> telnetlib<span class="token punctuation">.</span>Telnet<span class="token punctuation">(</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>sock <span class="token operator">=</span> s
t<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h1><p>哈希函数（Hash Function）把消息或数据压缩成摘要，使得数据量变小。其一般模型如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/hash.png" alt=""></p>
<p>显然对于任何一个 hash 值，理论上存在若干个消息与之对应，即碰撞。</p>
<p>哈希函数的基本需求如下</p>
<table>
<thead>
<tr>
<th align="left">需求</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">输入长度可变</td>
<td align="left">hash 函数可以应用于任意长度的数据</td>
</tr>
<tr>
<td align="left">输出长度固定</td>
<td align="left">hash 函数的输出长度固定</td>
</tr>
<tr>
<td align="left">效率</td>
<td align="left">对于任意消息 xx，计算 H(x)H(x) 很容易</td>
</tr>
<tr>
<td align="left">单向性</td>
<td align="left">对于任意哈希值 h，想要找到满足H(x)=hH(x)=h 的 x 在计算上不可行。</td>
</tr>
<tr>
<td align="left">抗弱碰撞性</td>
<td align="left">对于任意消息 x，找到满足另一消息 y，满足H(x)=H(y)H(x)=H(y) ，在计算上不可行。</td>
</tr>
<tr>
<td align="left">抗强碰撞性</td>
<td align="left">找到任意一对满足 H(x)=H(y)H(x)=H(y) 的消息 x 和 y 在计算上不可行。</td>
</tr>
<tr>
<td align="left">伪随机性</td>
<td align="left">哈希函数的输出满足伪随机性测试标准。</td>
</tr>
</tbody></table>
<p>散列值的目的如下</p>
<ul>
<li>确保消息的完整性，即确保收到的数据确实和发送时的一样（即没有修改、插入、删除或重放），防止中间人篡改。</li>
<li>冗余校验</li>
<li>单向口令文件，比如 linux 系统的密码</li>
<li>入侵检测和病毒检测中的特征码检测</li>
</ul>
<p>目前的 Hash 函数主要有 MD5，SHA1，SHA256，SHA512。目前的大多数 hash 函数都是迭代性的，即使用同一个 hash 函数，不同的参数进行多次迭代运算。</p>
<table>
<thead>
<tr>
<th align="left">算法类型</th>
<th align="left">输出 Hash 值长度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">MD5</td>
<td align="left">128 bit / 256 bit</td>
</tr>
<tr>
<td align="left">SHA1</td>
<td align="left">160 bit</td>
</tr>
<tr>
<td align="left">SHA256</td>
<td align="left">256 bit</td>
</tr>
<tr>
<td align="left">SHA512</td>
<td align="left">512 bit</td>
</tr>
</tbody></table>
<h1 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h1><h2 id="基本描述"><a href="#基本描述" class="headerlink" title="基本描述"></a>基本描述</h2><p>MD5 的输入输出如下</p>
<ul>
<li>输入：任意长的消息，512 比特长的分组。</li>
<li>输出：128 比特的消息摘要。</li>
</ul>
<p>关于详细的介绍，请自行搜索。</p>
<p>此外，有时候我们获得到的 md5 是 16 位的，其实那 16 位是 32 位 md5 的长度，是从 32 位 md5 值来的。是将 32 位 md5 去掉前八位，去掉后八位得到的。</p>
<p>一般来说，我们可以通过函数的初始化来判断是不是 MD5 函数。一般来说，如果一个函数有如下四个初始化的变量，可以猜测该函数为 MD5 函数，因为这是 MD5 函数的初始化 IV。</p>
<pre><code>0x67452301，0xEFCDAB89，0x98BADCFE，0x10325476</code></pre><h2 id="破解-6"><a href="#破解-6" class="headerlink" title="破解"></a>破解</h2><p>目前可以说 md5 已经基本被攻破了，一般的 MD5 的碰撞都可以在如下网上获取到</p>
<ul>
<li><a href="http://www.cmd5.com/" target="_blank" rel="noopener">http://www.cmd5.com/</a></li>
<li><a href="http://www.ttmd5.com/" target="_blank" rel="noopener">http://www.ttmd5.com/</a></li>
<li><a href="http://pmd5.com/" target="_blank" rel="noopener">http://pmd5.com/</a></li>
<li><a href="https://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip" target="_blank" rel="noopener">https://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip</a> (生成指定前缀的 md5 碰撞)</li>
</ul>
<h1 id="SHA1"><a href="#SHA1" class="headerlink" title="SHA1"></a>SHA1</h1><h2 id="基本描述-1"><a href="#基本描述-1" class="headerlink" title="基本描述"></a>基本描述</h2><p>SHA1的输入输出如下</p>
<ul>
<li>输入：任意长的消息，分为 <strong>512 比特</strong>长的分组。首先在消息右侧补比特 1，然后再补若干个比特 0，直到消息的比特长度满足对 512 取模后余数是 448，使其与 448 模 512 同余。</li>
<li>输出：160 比特的消息摘要。</li>
</ul>
<p>关于详细的介绍，请自行搜索。</p>
<p>一般来说，我们可以通过函数的初始化来判断是不是 SHA1 函数。一般来说，如果一个函数有如下五个初始化的变量，可以猜测该函数为 SHA1 函数，因为这是 SHA1 函数的初始化IV。</p>
<pre><code>0x67452301
0xEFCDAB89
0x98BADCFE
0x10325476
0xC3D2E1F0</code></pre><p>前面四个与 MD5 类似，后面的是新加的。</p>
<h2 id="破解-7"><a href="#破解-7" class="headerlink" title="破解"></a>破解</h2><p>就目前而言，SHA1 已经不再安全了，因为之前谷歌公布了求得两个 sha1 值一样的 pdf，具体请参考 <a href="https://shattered.io/" target="_blank" rel="noopener">shattered</a> 。</p>
<p>这里还有一个比较有意思的网站：<a href="https://alf.nu/SHA1。" target="_blank" rel="noopener">https://alf.nu/SHA1。</a></p>
<h2 id="2017-SECCON-SHA1-is-dead"><a href="#2017-SECCON-SHA1-is-dead" class="headerlink" title="2017 SECCON SHA1 is dead"></a>2017 SECCON SHA1 is dead</h2><p>题目描述如下</p>
<ol>
<li>file1 != file2</li>
<li>SHA1(file1) == SHA1(file2)</li>
<li>SHA256(file1) &lt;&gt; SHA256(file2)</li>
<li>2017KiB &lt; sizeof(file1) &lt; 2018KiB</li>
<li>2017KiB &lt; sizeof(file2) &lt; 2018KiB</li>
</ol>
<p>其中 1KiB = 1024 bytes</p>
<p>即我们需要找到两个文件满足上述的约束。</p>
<p>这里立马就想到谷歌之前公布的文档，而且，非常重要的是，只要使用给定的前 320 字节，后面任意添加一样的字节获取的哈希仍然一样，这里我们测试如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2017_seccon_sha1_is_dead git:(master) dd bs=1 count=320 <shattered-1.pdf| sha1sum
记录了320+0 的读入
记录了320+0 的写出
320 bytes copied, 0.00796817 s, 40.2 kB/s
f92d74e3874587aaf443d1db961d4e26dde13e9c  -
➜  2017_seccon_sha1_is_dead git:(master) dd bs=1 count=320 <shattered-2.pdf| sha1sum
记录了320+0 的读入
记录了320+0 的写出
320 bytes copied, 0.00397215 s, 80.6 kB/s
f92d74e3874587aaf443d1db961d4e26dde13e9c  -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 进而我们直接写程序即可，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha1
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha256

pdf1 <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./shattered-1.pdf'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">)</span>
pdf2 <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'./shattered-2.pdf'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">)</span>
pdf1 <span class="token operator">=</span> pdf1<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">2017</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">"\00"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#padding pdf to 2017Kib + 1</span>
pdf2 <span class="token operator">=</span> pdf2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">2017</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token string">"\00"</span><span class="token punctuation">)</span>
open<span class="token punctuation">(</span><span class="token string">"upload1"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>pdf1<span class="token punctuation">)</span>
open<span class="token punctuation">(</span><span class="token string">"upload2"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>pdf2<span class="token punctuation">)</span>

<span class="token keyword">print</span> sha1<span class="token punctuation">(</span>pdf1<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> sha1<span class="token punctuation">(</span>pdf2<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> sha256<span class="token punctuation">(</span>pdf1<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> sha256<span class="token punctuation">(</span>pdf2<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Fowler–Noll–Vo-hash-function"><a href="#Fowler–Noll–Vo-hash-function" class="headerlink" title="Fowler–Noll–Vo hash function"></a>Fowler–Noll–Vo hash function</h1><p>具体请参见 <a href="https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function。" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function。</a></p>
<h2 id="2018-网鼎杯-hashcoll"><a href="#2018-网鼎杯-hashcoll" class="headerlink" title="2018 网鼎杯 hashcoll"></a>2018 网鼎杯 hashcoll</h2><p>其实这道题是从 NSU Crypto 抄过来的，<a href="https://nsucrypto.nsu.ru/archive/2017/problems_solution，具体的" target="_blank" rel="noopener">https://nsucrypto.nsu.ru/archive/2017/problems_solution，具体的</a> wp 之前 hellman 也写了，<a href="https://gist.github.com/hellman/9bf8376cd04e7a8dd2ec7be1947261e9。" target="_blank" rel="noopener">https://gist.github.com/hellman/9bf8376cd04e7a8dd2ec7be1947261e9。</a></p>
<p>简单看一下题目</p>
<pre class="line-numbers language-python"><code class="language-python">h0 <span class="token operator">=</span> <span class="token number">45740974929179720441799381904411404011270459520712533273451053262137196814399</span>

<span class="token comment" spellcheck="true"># 2**168 + 355</span>
g <span class="token operator">=</span> 374144419156711147060143317175368453031918731002211L


<span class="token keyword">def</span> <span class="token function">shitty_hash</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h <span class="token operator">=</span> h0
    msg <span class="token operator">=</span> map<span class="token punctuation">(</span>ord<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> msg<span class="token punctuation">:</span>
        h <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">*</span> g
        <span class="token comment" spellcheck="true"># This line is just to screw you up :))</span>
        h <span class="token operator">=</span> h <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span>

    <span class="token keyword">return</span> h <span class="token operator">-</span> <span class="token number">0xe6168647f636</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>题目希望我们给出两个消息，其哈希值相同。如果我们将该函数展开的话，那么</p>
<p>$hash(m)=h_0g^n+x_1g^n+x_2g_{n-1}+…+x_ng \bmod 2^{256}$</p>
<p>假设两个消息的 hash 值相同那么</p>
<p>$h_0g^n+x_1g^n+x_2g_{n-1}+…+x_ng  \equiv h_0g^n+y_1g^n+y_2g_{n-1}+…+y_ng\bmod 2^{256}$</p>
<p>进而</p>
<p>$(x_1-y_1)g^{n-1}+(x_2-y_2)g^{n-2}+…+(x_n-y_n)g^0 \equiv 0 \bmod 2^{256}$</p>
<p>即我们只需要找到一个 n 维向量 $z_i=x_i-y_i$，满足上述等式即可，我们可以进一步将其化为</p>
<p>$z_1g^{n-1}+z_2g^{n-2}+…+z_ng^0-k*2^{256}=0$</p>
<p>即找到一组向量满足上述这个式子。这可以认为是 LLL Paper 中第二个例子的简单情况（参见格问题部分）。</p>
<p>那么我们可以快速构造矩阵，如下</p>
<p>$$ A = \left[ \begin{matrix} 1   &amp; 0 &amp; 0     &amp; \cdots &amp; 0 &amp; Kg^{n-1}     \ 0   &amp; 1  &amp; 0    &amp; \cdots &amp; 0 &amp; Kg^{n-2}  \ 0   &amp; 0   &amp; 1   &amp; \cdots &amp; 0 &amp; Kg^{n-3} \\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \ 0   &amp; 0   &amp;0   &amp; \cdots &amp; 1 &amp; K*mod     \ \end{matrix} \right]$$</p>
<p>之后我们使用LLL 算法即可获得两个一样的哈希值</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sage<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>

mod <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">256</span>
h0 <span class="token operator">=</span> <span class="token number">45740974929179720441799381904411404011270459520712533273451053262137196814399</span>

g <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">168</span> <span class="token operator">+</span> <span class="token number">355</span>


<span class="token keyword">def</span> <span class="token function">shitty_hash</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h <span class="token operator">=</span> h0
    msg <span class="token operator">=</span> map<span class="token punctuation">(</span>ord<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> msg<span class="token punctuation">:</span>
        h <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">*</span> g
        <span class="token comment" spellcheck="true"># This line is just to screw you up :))</span>
        h <span class="token operator">=</span> h <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span>

    <span class="token keyword">return</span> h <span class="token operator">-</span> <span class="token number">0xe6168647f636</span>


K <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">200</span>
N <span class="token operator">=</span> <span class="token number">50</span>
base_str <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> N
base <span class="token operator">=</span> map<span class="token punctuation">(</span>ord<span class="token punctuation">,</span> base_str<span class="token punctuation">)</span>
m <span class="token operator">=</span> Matrix<span class="token punctuation">(</span>ZZ<span class="token punctuation">,</span> N <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> N <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>N <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ge <span class="token operator">=</span> ZZ<span class="token punctuation">(</span>pow<span class="token punctuation">(</span>g<span class="token punctuation">,</span> N <span class="token operator">-</span> i<span class="token punctuation">,</span> mod<span class="token punctuation">)</span><span class="token punctuation">)</span>
    m<span class="token punctuation">[</span>i<span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    m<span class="token punctuation">[</span>i<span class="token punctuation">,</span> N <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZZ<span class="token punctuation">(</span>ge <span class="token operator">*</span> K<span class="token punctuation">)</span>
m<span class="token punctuation">[</span>i<span class="token punctuation">,</span> N <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZZ<span class="token punctuation">(</span>K <span class="token operator">*</span> mod<span class="token punctuation">)</span>

ml <span class="token operator">=</span> m<span class="token punctuation">.</span>LLL<span class="token punctuation">(</span><span class="token punctuation">)</span>
ttt <span class="token operator">=</span> ml<span class="token punctuation">.</span>rows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">"result:"</span><span class="token punctuation">,</span> ttt
<span class="token keyword">if</span> ttt<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">"Zero not reached, increase K"</span>
    exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>base<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> ttt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"Need more bytes!"</span>
            quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> msg
    other <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>chr<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span> shitty_hash<span class="token punctuation">(</span>base_str<span class="token punctuation">)</span>
    <span class="token keyword">print</span> shitty_hash<span class="token punctuation">(</span>other<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意不能直接仅仅使用 pow(g, N - i, mod)，不然生成的数会在 mod 对应的域中，这真是个大坑。</p>
<p>如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  hashcoll sage exp.sage
result: (15, -14, 17, 14, 6, 0, 12, 21, 8, 29, 6, -4, -9, 10, -2, -12, -6, 0, -12, 13, -28, -28, -24, -3, 6, -5, -16, 15, 17, -14, 3, -2, -16, -25, 3, -21, -27, -9, 16, 5, -1, 0, -3, -4, -4, -19, 6, 8, 0, 0, 0, 0)
[112, 83, 114, 111, 103, 97, 109, 118, 105, 126, 103, 93, 88, 107, 95, 85, 91, 97, 85, 110, 69, 69, 73, 94, 103, 92, 81, 112, 114, 83, 100, 95, 81, 72, 100, 76, 70, 88, 113, 102, 96, 97, 94, 93, 93, 78, 103, 105, 97, 97]
106025341237231370726407656306665079105509255639964756437758376184556498283725
106025341237231370726407656306665079105509255639964756437758376184556498283725<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>即成功。</p>
<h1 id="Hash-Attack"><a href="#Hash-Attack" class="headerlink" title="Hash Attack"></a>Hash Attack</h1><p>常见的Hash函数的攻击方法主要有</p>
<ul>
<li>暴力攻击：不依赖于任何算法细节，仅与Hash值长度有关；<ul>
<li>生日攻击法(Birthday Attack)：没有利用Hash函数的结构和任何代数弱性质，只依赖于消息摘要的长度，即Hash值的长度。</li>
<li>中点交会攻击法(Meet-In-The-Middle)：是生日攻击的一种变形，不比较Hash值，而是比较中间变量。这种攻击主要适用于攻击具有分组链结构的Hash方案。</li>
</ul>
</li>
<li>密码分析：依赖于具体算法的设计缺点。</li>
</ul>
<h2 id="暴力攻击"><a href="#暴力攻击" class="headerlink" title="暴力攻击"></a>暴力攻击</h2><p> <strong>HashCat 工具</strong> 可以说是目前最好的基于 CPU 和 GPU 破解 Hash 的软件，相关链接如下</p>
<p><a href="http://www.hashcat.net/hashcat/" target="_blank" rel="noopener">HashCat 官网</a></p>
<p><a href="http://www.freebuf.com/sectool/112479.html" target="_blank" rel="noopener">HashCat 简单使用</a></p>
<h2 id="哈希长度拓展攻击（hash-length-extension-attacks）"><a href="#哈希长度拓展攻击（hash-length-extension-attacks）" class="headerlink" title="哈希长度拓展攻击（hash length extension attacks）"></a>哈希长度拓展攻击（hash length extension attacks）</h2><h3 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h3><p>基本定义如下，源自<a href="https://zh.wikipedia.org/wiki/%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB" target="_blank" rel="noopener">维基百科</a>。</p>
<p>哈希长度扩展攻击(Hash Length Extension Attacks)是指针对某些允许包含额外信息的加密散列函数的攻击手段。该攻击适用于在<strong>消息与密钥的长度已知</strong>的情形下，所有采取了 H(key ∥ message) 此类构造的散列函数。MD5和SHA-1 等基于 Merkle–Damgård 构造的算法均对此类攻击显示出脆弱性。</p>
<p>这类哈希函数有以下特点</p>
<ul>
<li>消息填充方式都比较类似，首先在消息后面添加一个1，然后填充若干个0，直至总长度与 448 同余，最后在其后附上64位的消息长度（填充前）。</li>
<li>每一块得到的链接变量都会被作为下一次执行hash函数的初始向量IV。在最后一块的时候，才会将其对应的链接变量转换为hash值。</li>
</ul>
<p>一般攻击时应满足如下条件</p>
<ul>
<li>我们已知 key 的长度，如果不知道的话，需要爆破出来</li>
<li>我们可以控制 message 的消息。</li>
<li>我们已经知道了包含 key 的一个消息的hash值。</li>
</ul>
<p>这样我们就可以得到一对(messge,x)满足x=H(key ∥ message)虽然我们并不清楚key的内容。</p>
<h3 id="攻击原理-10"><a href="#攻击原理-10" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>这里不妨假设我们我们知道了 hash(key+s) 的 hash 值，其中 s 是已知的，那么其本身在计算的时候，必然会进行填充。那么我们首先可以得到 key+s 扩展后的字符串 now，即</p>
<p>now=key|s|padding</p>
<p>那么如果我们在 now 的后面再次附加上一部分信息extra，即</p>
<p>key|s|padding|extra</p>
<p>这样再去计算hash值的时候，</p>
<ol>
<li>会对 extra 进行填充直到满足条件。</li>
<li>先计算 now 对应的链接变量 IV1，而我们已经知道这部分的 hash 值，并且链接变量产生 hash 值的算法是可逆的，所以我们可以得到链接变量。</li>
<li>下面会根据得到的链接变量 IV1，对 extra 部分进行哈希算法，并返回hash值。</li>
</ol>
<p>那么既然我们已经知道了第一部分的 hash 值，并且，我们还知道 extra 的值，那么我们便可以得到最后的hash值。</p>
<p>而之前我们也说了我们可以控制 message 的值。那么其实 s，padding，extra 我们都是可以控制的。所以我们自然可以找到对应的(message,x)满足x=hash(key|message)。</p>
<h3 id="例子-7"><a href="#例子-7" class="headerlink" title="例子"></a>例子</h3><p>似乎大都是web里面的，，不太懂web，暂时先不给例子了。</p>
<h3 id="工具-16"><a href="#工具-16" class="headerlink" title="工具"></a>工具</h3><ul>
<li><a href="https://github.com/bwall/HashPump" target="_blank" rel="noopener">hashpump</a></li>
</ul>
<p>如何使用请参考github上的readme。</p>
<h2 id="hash算法设计有误"><a href="#hash算法设计有误" class="headerlink" title="hash算法设计有误"></a>hash算法设计有误</h2><p>一些自定义的hash算法可能是可逆的。</p>
<h3 id="Hashinator"><a href="#Hashinator" class="headerlink" title="Hashinator"></a>Hashinator</h3><p>题目的逻辑很简单，从一个知名的密码字典”rockyou”挑选出一个<code>password</code>，并且使用多种hash算法随机的哈希32轮。我们需要从最后的hash结果中破解出原始的<code>password</code>。</p>
<h4 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h4><p>题目采用的hash算法有：<code>md5</code>，<code>sha1</code>，<code>blake</code>，<code>scrypt</code>。<br>关键的代码如下：</p>
<pre class="line-numbers language-python"><code class="language-python">    password <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_password<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># from rock_you.txt</span>
    salt <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_salt<span class="token punctuation">(</span>password<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 与password的长度有关</span>
    hash_rounds <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_rounds<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 生成进行hash算法的顺序</span>
    password_hash <span class="token operator">=</span> self<span class="token punctuation">.</span>calculate_hash<span class="token punctuation">(</span>salt <span class="token operator">+</span> password<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>程序首先通过从<code>rockyou.txt</code>中随机抽取一个<code>password</code>，作为加密的明文。</li>
<li>然后根据抽取的<code>password</code>的长度，生成一个长度为<code>128 - len(password)</code>的<code>salt</code>。</li>
<li>从之前列举的4种hash算法中抽取，组成32轮的哈希运算。</li>
<li>根据之前得到的<code>password</code>、<code>salt</code>计算出最后给我们的<code>password_hash</code>。</li>
</ol>
<p>很明显，我们不可能通过逆向hash算法来完成题目。<br>我们知道所有的可能的明文，首先考虑能否通过构造彩虹表来完成穷举。但是注意到<code>generate_salt()</code>函数中，<code>salt</code>和<code>password</code>的长度组合超过了128byte的长度，并且被注释了</p>
<pre><code>    msize = 128 # f-you hashcat :D</code></pre><p>so，只能无奈放弃。</p>
<p>那这样的话，只存在一种可能，也即算法可逆。查看<code>calculate_hash()</code>函数的具体实现，可以发现如下可疑的代码：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>hash_rounds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    interim_salt <span class="token operator">=</span> xor<span class="token punctuation">(</span>interim_salt<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>interim_hash<span class="token punctuation">)</span><span class="token punctuation">)</span>
    interim_hash <span class="token operator">=</span> xor<span class="token punctuation">(</span>interim_hash<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>interim_salt<span class="token punctuation">)</span><span class="token punctuation">)</span>
final_hash <span class="token operator">=</span> interim_salt <span class="token operator">+</span> interim_hash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>重新梳理一下我们知道的信息：</p>
<ol>
<li>hash_rounds中保存了32轮，即每轮要使用的hash函数句柄。</li>
<li>final_hash是最后给我们的hash结果。</li>
<li>hash_rounds中的内容也会在生成之后打印给我们。</li>
<li>我们希望得到<code>interim_salt</code>和<code>interim_hash</code>在第一轮的值。</li>
<li><code>interim_salt</code>和<code>interim_hash</code>的长度均为64byte。</li>
</ol>
<p>仔细观察一下<code>interim_salt</code>和<code>interim_hash</code>的计算方法，可以发现它是可逆的。</p>
<p>$$<br>interim_hash_1 = interim_hash_2 \oplus hash_rounds<a href="interim_salt_3">i</a><br>$$</p>
<p>这行代码里，我们已知 $interim_hash_1$ 和 $interim_salt_3$，由此可以推出$interim_hash_2$的值，而$interim_hash_2$则是上一轮的<code>interim_hash</code>。<br>以此方法逆推32次，则可以得到最初的<code>password</code>和<code>salt</code>。</p>
<p>具体的解密脚本为：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading
<span class="token comment" spellcheck="true"># import pyscrypt</span>
<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64encode<span class="token punctuation">,</span> b64decode
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">def</span> <span class="token function">md5</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">sha</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">blake</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>blake2b<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">scrypt</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> int<span class="token punctuation">(</span>len<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    salt <span class="token operator">=</span> bytestring<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span>
    p <span class="token operator">=</span> bytestring<span class="token punctuation">[</span>l<span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>scrypt<span class="token punctuation">(</span>p<span class="token punctuation">,</span> salt<span class="token operator">=</span>salt<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">16</span><span class="token punctuation">,</span> r<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> maxmem<span class="token operator">=</span><span class="token number">67111936</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># return pyscrypt.hash(p, salt, 2**16, 8, 1, dkLen=64)</span>
<span class="token keyword">def</span> <span class="token function">xor</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> b<span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>bytes<span class="token punctuation">(</span><span class="token punctuation">[</span>s1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> s2<span class="token punctuation">[</span>i <span class="token operator">%</span> len<span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># io = socket.socket(family=socket.AF_INET)</span>
    <span class="token comment" spellcheck="true"># io.connect(('47.88.216.38', 20013))</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'47.88.216.38'</span><span class="token punctuation">,</span> <span class="token number">20013</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ans_array <span class="token operator">=</span> bytearray<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        buf <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> buf<span class="token punctuation">:</span>
            ans_array<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
        <span class="token keyword">if</span> buf <span class="token operator">==</span> b<span class="token string">'!'</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    password_hash_base64 <span class="token operator">=</span> ans_array<span class="token punctuation">[</span>ans_array<span class="token punctuation">.</span>find<span class="token punctuation">(</span>b<span class="token string">"b'"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span> ans_array<span class="token punctuation">.</span>find<span class="token punctuation">(</span>b<span class="token string">"'\n"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    password_hash <span class="token operator">=</span> b64decode<span class="token punctuation">(</span>password_hash_base64<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'password:'</span><span class="token punctuation">,</span> password_hash<span class="token punctuation">)</span>
    method_bytes <span class="token operator">=</span> ans_array<span class="token punctuation">[</span>
        ans_array<span class="token punctuation">.</span>find<span class="token punctuation">(</span>b<span class="token string">'used:\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span> <span class="token punctuation">:</span> ans_array<span class="token punctuation">.</span>find<span class="token punctuation">(</span>b<span class="token string">'\nYour'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    methods <span class="token operator">=</span> method_bytes<span class="token punctuation">.</span>split<span class="token punctuation">(</span>b<span class="token string">'\n'</span><span class="token punctuation">)</span>
    methods <span class="token operator">=</span> <span class="token punctuation">[</span>bytes<span class="token punctuation">(</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span>b<span class="token string">'- '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> methods<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>methods<span class="token punctuation">)</span>
    in_salt <span class="token operator">=</span> password_hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">]</span>
    in_hash <span class="token operator">=</span> password_hash<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> pos<span class="token punctuation">,</span> neg <span class="token keyword">in</span> zip<span class="token punctuation">(</span>methods<span class="token punctuation">,</span> methods<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
            interim_salt = xor(interim_salt, hash_rounds[-1-i](interim_hash))
            interim_hash = xor(interim_hash, hash_rounds[i](interim_salt))
        '''</span>
        in_hash <span class="token operator">=</span> xor<span class="token punctuation">(</span>in_hash<span class="token punctuation">,</span> eval<span class="token punctuation">(</span><span class="token string">"{}(in_salt)"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>neg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        in_salt <span class="token operator">=</span> xor<span class="token punctuation">(</span>in_salt<span class="token punctuation">,</span> eval<span class="token punctuation">(</span><span class="token string">"{}(in_hash)"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>in_hash<span class="token punctuation">,</span> in_salt<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>in_hash<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="原hash算法"><a href="#原hash算法" class="headerlink" title="原hash算法"></a>原hash算法</h4><pre class="line-numbers language-python"><code class="language-python">
<span class="token keyword">import</span> os
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> time

<span class="token comment" spellcheck="true"># import pyscrypt</span>

<span class="token keyword">from</span> base64 <span class="token keyword">import</span> b64encode

<span class="token keyword">def</span> <span class="token function">md5</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">sha</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blake</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>blake2b<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">scrypt</span><span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> int<span class="token punctuation">(</span>len<span class="token punctuation">(</span>bytestring<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    salt <span class="token operator">=</span> bytestring<span class="token punctuation">[</span><span class="token punctuation">:</span>l<span class="token punctuation">]</span>
    p <span class="token operator">=</span> bytestring<span class="token punctuation">[</span>l<span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>scrypt<span class="token punctuation">(</span>p<span class="token punctuation">,</span> salt<span class="token operator">=</span>salt<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">16</span><span class="token punctuation">,</span> r<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> maxmem<span class="token operator">=</span><span class="token number">67111936</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># return pyscrypt.hash(p, salt, 2**16, 8, 1)</span>

<span class="token keyword">def</span> <span class="token function">xor</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> b<span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>bytes<span class="token punctuation">(</span><span class="token punctuation">[</span>s1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> s2<span class="token punctuation">[</span>i <span class="token operator">%</span> len<span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">HashHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    welcome_message <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
Welcome, young wanna-be Cracker, to the Hashinator.

To prove your worthiness, you must display the power of your cracking skills.

The test is easy:
1. We send you a password from the rockyou list, hashed using multiple randomly chosen algorithms.
2. You crack the hash and send back the original password.

As you already know the dictionary and won't need any fancy password rules, {} seconds should be plenty, right?

Please wait while we generate your hash...
    """</span>

    hashes <span class="token operator">=</span> <span class="token punctuation">[</span>md5<span class="token punctuation">,</span> sha<span class="token punctuation">,</span> blake<span class="token punctuation">,</span> scrypt<span class="token punctuation">]</span>
    timeout <span class="token operator">=</span> <span class="token number">10</span>
    total_rounds <span class="token operator">=</span> <span class="token number">32</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>self<span class="token punctuation">.</span>welcome_message<span class="token punctuation">.</span>format<span class="token punctuation">(</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        password <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_password<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># from rock_you.txt</span>
        salt <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_salt<span class="token punctuation">(</span>password<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># 与password的长度有关</span>
        hash_rounds <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_rounds<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 生成进行hash算法的顺序</span>
        password_hash <span class="token operator">=</span> self<span class="token punctuation">.</span>calculate_hash<span class="token punctuation">(</span>salt <span class="token operator">+</span> password<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate_delay<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Challenge password hash: {}\n"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>b64encode<span class="token punctuation">(</span>password_hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Rounds used:\n"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        test_rounds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> r <span class="token keyword">in</span> hash_rounds<span class="token punctuation">:</span>
            test_rounds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>

        <span class="token keyword">for</span> r <span class="token keyword">in</span> hash_rounds<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"- {}\n"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>r<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Your time starts now!\n"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> response<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Congratulations! You are a true cracking master!\n"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Welcome to the club: {}\n"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
        <span class="token keyword">except</span> socket<span class="token punctuation">.</span>timeout<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Your cracking skills are bad, and you should feel bad!"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">generate_password</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        rand <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"I"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        lines <span class="token operator">=</span> <span class="token number">14344391</span> <span class="token comment" spellcheck="true"># size of rockyou</span>
        line <span class="token operator">=</span> rand <span class="token operator">%</span> lines
        password <span class="token operator">=</span> <span class="token string">""</span>
        f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'rockyou.txt'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
            password <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> password<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">generate_salt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msize <span class="token operator">=</span> <span class="token number">128</span> <span class="token comment" spellcheck="true"># f-you hashcat :D</span>
        salt_size <span class="token operator">=</span> msize <span class="token operator">-</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token keyword">return</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span>salt_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">generate_rounds</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        rand <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"Q"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        rounds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>self<span class="token punctuation">.</span>total_rounds<span class="token punctuation">)</span><span class="token punctuation">:</span>
            rounds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hashes<span class="token punctuation">[</span>rand <span class="token operator">%</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hashes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            rand <span class="token operator">=</span> rand <span class="token operator">>></span> <span class="token number">2</span>
        <span class="token keyword">return</span> rounds

    <span class="token keyword">def</span> <span class="token function">calculate_hash</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">)</span><span class="token punctuation">:</span>
        interim_salt <span class="token operator">=</span> payload<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">]</span>
        interim_hash <span class="token operator">=</span> payload<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>hash_rounds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            interim_salt <span class="token operator">=</span> xor<span class="token punctuation">(</span>interim_salt<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>interim_hash<span class="token punctuation">)</span><span class="token punctuation">)</span>
            interim_hash <span class="token operator">=</span> xor<span class="token punctuation">(</span>interim_hash<span class="token punctuation">,</span> hash_rounds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>interim_salt<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token triple-quoted-string string">'''
            interim_hash = xor(
                interim_hash,
                hash_rounds[i](
                    xor(interim_salt, hash_rounds[-1-i](interim_hash))
                )
            )
            '''</span>
        final_hash <span class="token operator">=</span> interim_salt <span class="token operator">+</span> interim_hash
        <span class="token keyword">return</span> final_hash

    <span class="token keyword">def</span> <span class="token function">generate_delay</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        rand <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"I"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>rand <span class="token operator">/</span> <span class="token number">1000000000.0</span><span class="token punctuation">)</span>



<span class="token keyword">class</span> <span class="token class-name">ThreadedTCPServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>ThreadingMixIn<span class="token punctuation">,</span> socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>

PORT <span class="token operator">=</span> <span class="token number">1337</span>
HOST <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span>
flag <span class="token operator">=</span> <span class="token string">""</span>

<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    flag <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> ThreadedTCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> HashHandler<span class="token punctuation">)</span>
    server_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">)</span>
    server_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    server_thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="综合题目"><a href="#综合题目" class="headerlink" title="综合题目"></a>综合题目</h1><h2 id="2017-34c3-Software-update"><a href="#2017-34c3-Software-update" class="headerlink" title="2017 34c3 Software_update"></a>2017 34c3 Software_update</h2><p>可以看出，程序的大概意思是上传一个 zip 压缩包，然后对 signed_data 目录下的文件进行签名验证。其中，最后验证的手法是大概是将每一个文件进行 sha256 哈希，然后<strong>异或</strong>起来作为输入传递给 rsa 进行签名。如果通过验证的话，就会执行对应的 pre-copy.py 和 post-copy.py 文件。</p>
<p>很自然的想法是我们修改 pre-copy.py 或者 post-copy.py 文件，使其可以读取 flag，然后再次绕过签名即可。主要有两种思路</p>
<ol>
<li>根据给定的公钥文件获取对应的私钥，进而再修改文件后伪造签名，然后大概看了看公钥文件几乎不可破，所以这一点，基本上可以放弃。</li>
<li>修改对应文件后，利用<strong>异或的特性使得其哈希值仍然与原来相同</strong>，从而绕过签名检测。即使得 signed_data 目录下包含多个文件，使得这些文件的哈希值最后异或起来可以抵消修改 pre-copy.py 或者 post-copy.py文件所造成的哈希值的不同。</li>
</ol>
<p>这里，我们选择第二种方法，这里我们选择修改 pre-copy.py 文件，具体思路如下</p>
<ol>
<li>计算 pre-copy.py 的原 hash 值。</li>
<li>修改 pre-copy.py 文件，使其可以读取 flag。与此同时，计算新的 hash 值。将两者异或，求得异或差值 delta。</li>
<li>寻找一系列的文件，使其 hash 值异或起来正好为 delta。</li>
</ol>
<p>关键的步骤在于第三步，而其实这个文件可以看做是一个线性组合的问题，即寻找若干个 256 维01向量使其异或值为 delta。而<br>$$<br>(F={0,1},F^{256},\oplus ,\cdot)<br>$$<br>是一个 256 维的向量空间。如果我们可以求得该向量空间的一个基，那么我们就可以求得该空间中任意指定值的所需要的向量。</p>
<p>我们可以使用 sage 来辅助我们求，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># generage the base of &lt;{0,1},F^256,xor,*></span>
<span class="token keyword">def</span> <span class="token function">gen_gf2_256_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    v <span class="token operator">=</span> VectorSpace<span class="token punctuation">(</span>GF<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    tmphash <span class="token operator">=</span> compute_file_hash<span class="token punctuation">(</span><span class="token string">"0.py"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    tmphash_bin <span class="token operator">=</span> hash2bin<span class="token punctuation">(</span>tmphash<span class="token punctuation">)</span>
    base <span class="token operator">=</span> <span class="token punctuation">[</span>tmphash_bin<span class="token punctuation">]</span>
    filelist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'0.py'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span> base
    s <span class="token operator">=</span> v<span class="token punctuation">.</span>subspace<span class="token punctuation">(</span>base<span class="token punctuation">)</span>
    dim <span class="token operator">=</span> s<span class="token punctuation">.</span>dimension<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">while</span> dim <span class="token operator">!=</span> <span class="token number">256</span><span class="token punctuation">:</span>
        tmpfile <span class="token operator">=</span> str<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".py"</span>
        tmphash <span class="token operator">=</span> compute_file_hash<span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        tmphash_bin <span class="token operator">=</span> hash2bin<span class="token punctuation">(</span>tmphash<span class="token punctuation">)</span>
        old_dim <span class="token operator">=</span> dim
        s <span class="token operator">=</span> v<span class="token punctuation">.</span>subspace<span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token punctuation">[</span>tmphash_bin<span class="token punctuation">]</span><span class="token punctuation">)</span>
        dim <span class="token operator">=</span> s<span class="token punctuation">.</span>dimension<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> dim <span class="token operator">></span> old_dim<span class="token punctuation">:</span>
            base <span class="token operator">+=</span> <span class="token punctuation">[</span>tmphash_bin<span class="token punctuation">]</span>
            filelist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"dimension "</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>s<span class="token punctuation">.</span>dimension<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cnt <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span>
    m <span class="token operator">=</span> matrix<span class="token punctuation">(</span>GF<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span>
    m <span class="token operator">=</span> m<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> m<span class="token punctuation">,</span> filelist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于更加详细的解答，请参考 <code>exp.py</code>。</p>
<p>这里我修改 pre-copy 多输出  <code>!!!!come here!!!!</code> 字眼，如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  software_update git:(master) python3 installer.py now.zip
Preparing to copy data...
!!!!come here!!!!
Software update installed successfully.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>参考文献</p>
<ul>
<li><a href="https://sectt.github.io/writeups/34C3CTF/crypto_182_software_update/Readme" target="_blank" rel="noopener">https://sectt.github.io/writeups/34C3CTF/crypto_182_software_update/Readme</a></li>
<li><a href="https://github.com/OOTS/34c3ctf/blob/master/software_update/solution/exploit.py" target="_blank" rel="noopener">https://github.com/OOTS/34c3ctf/blob/master/software_update/solution/exploit.py</a></li>
</ul>
<h2 id="2019-36c3-SaV-ls-l-aaS"><a href="#2019-36c3-SaV-ls-l-aaS" class="headerlink" title="2019 36c3 SaV-ls-l-aaS"></a>2019 36c3 SaV-ls-l-aaS</h2><p>这个题的分类是 Crypto&amp;Web，捋一下流程：</p>
<p>60601端口开着一个Web服务，题目描述给了连接方法：</p>
<pre class="line-numbers language-bash"><code class="language-bash">url<span class="token operator">=</span><span class="token string">'http://78.47.240.226:60601'</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">=</span><span class="token punctuation">$(</span>curl -s <span class="token string">"<span class="token variable">$url</span>/ip"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sig<span class="token operator">=</span><span class="token punctuation">$(</span>curl -s -d <span class="token string">"cmd=ls -l&amp;ip=<span class="token variable">$ip</span>"</span> <span class="token string">"<span class="token variable">$url</span>/sign"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> curl --data-urlencode <span class="token string">"signature=<span class="token variable">$sig</span>"</span> <span class="token string">"<span class="token variable">$url</span>/exec"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以看到，先是访问 <code>/ip</code> 得到 ip，再向 <code>/sign</code> post 过去 ip 和我们要执行的命令，得到签名，最后向 <code>/exec</code> post signature 来执行命令。我们执行这一行可以发现回显了<code>ls -l</code>执行的结果，发现有个 flag.txt。</p>
<p>看源码，Web 服务是由 go 起的：</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"crypto/sha1"</span>
    <span class="token string">"encoding/json"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"io"</span>
    <span class="token string">"io/ioutil"</span>
    <span class="token string">"log"</span>
    <span class="token string">"net"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"strings"</span>
    <span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    m<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/ip"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    m<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/sign"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        remoteAddr <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        <span class="token keyword">if</span> remoteAddr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        ip <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">PostFormValue</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">)</span>
        signIP <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        <span class="token keyword">if</span> signIP <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>signIP<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>remoteAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"lol, not ip :>"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        cmd <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">PostFormValue</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cmd <span class="token operator">!=</span> <span class="token string">"ls -l"</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"lol, nope :>"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        msg <span class="token operator">:=</span> ip <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> cmd
        digest <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

        b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
        err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>digest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1/index.php?action=sign"</span><span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, hsm is down"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        body<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, hsm is bodyless?"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> signature <span class="token builtin">string</span>
        err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token operator">&amp;</span>signature<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, hsm is jsonless?"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> signature<span class="token operator">+</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    m<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/exec"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        remoteAddr <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
        <span class="token keyword">if</span> remoteAddr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        signature <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">PostFormValue</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">)</span>
        digest <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>signature<span class="token punctuation">[</span><span class="token number">172</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
        err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>signature<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">172</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>digest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, json encode"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1/index.php?action=verify"</span><span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, hsm is down?"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        body<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, hsm is bodyless?"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> valid <span class="token builtin">bool</span>
        err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token operator">&amp;</span>valid<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, json unmarshal"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> valid <span class="token punctuation">{</span>
            t <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>signature<span class="token punctuation">[</span><span class="token number">172</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"|"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, split"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            signIP <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> signIP <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>signIP<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>remoteAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"lol, not ip :>"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">DialTimeout</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:1024"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"oops, dial"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPConn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CloseWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    s <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
        Addr<span class="token punctuation">:</span>           <span class="token string">":60601"</span><span class="token punctuation">,</span>
        Handler<span class="token punctuation">:</span>        m<span class="token punctuation">,</span>
        ReadTimeout<span class="token punctuation">:</span>    <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        WriteTimeout<span class="token punctuation">:</span>   <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        MaxHeaderBytes<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码很容易看，限制了 cmd 只能是<code>ls -l</code>，其余不给签名，看样子我们是要伪造其他命令的签名来读flag，这里注意到签名和验签的过程是传给本地起的一个 php 来完成的，看一下这部分源码：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'ALGO'</span><span class="token punctuation">,</span> <span class="token string">'md5WithRSAEncryption'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$d</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span>'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input'), JSON_THROW_ON_ERROR);</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'sign'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$pkeyid</span> <span class="token operator">=</span> <span class="token function">openssl_pkey_get_private</span><span class="token punctuation">(</span>"file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///var/www/private_key.pem");</span>
    <span class="token function">openssl_sign</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">,</span> <span class="token variable">$signature</span><span class="token punctuation">,</span> <span class="token variable">$pkeyid</span><span class="token punctuation">,</span> <span class="token constant">ALGO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$signature</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">openssl_free_key</span><span class="token punctuation">(</span><span class="token variable">$pkeyid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'verify'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$pkeyid</span> <span class="token operator">=</span> <span class="token function">openssl_pkey_get_public</span><span class="token punctuation">(</span>"file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///var/www/public_key.pem");</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token function">openssl_verify</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$pkeyid</span><span class="token punctuation">,</span> <span class="token constant">ALGO</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">openssl_free_key</span><span class="token punctuation">(</span><span class="token variable">$pkeyid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>采用的是<code>md5WithRSAEncryption</code>的方式签名，本地试了一下，是把我们传入的 <code>$d</code> md5 后转为hex，填充到</p>
<pre><code>0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff003020300c06082a864886f70d020505000410</code></pre><p>后面，组成数字然后用RSA签名。</p>
<p>看样子整个逻辑找不到一点问题，用的都是标准库，基本无法攻击。有个思路是通过代理更换 ip，可以拿到两个 ip|ls -l 的签名，这样我们就拥有了两组 RSA 的 m 和 c，因为题目给了 dockerfile 给了生成公私钥的方法，使用 openssl 默认生成，e为65537，那么我们可以通过求公因数的方式来求出 n。</p>
<p>在得到两组签名后，我们要得到 RSA 的m，就是填充后的数，所以按照代码逻辑，在 go 里面先是 sha1:</p>
<pre class="line-numbers language-go"><code class="language-go">msg <span class="token operator">:=</span> ip <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> cmd
digest <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>digest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再 php 里的 md5，得到两组 m 和 c，但是总是求不出公因数 n，怀疑求的 m 不对。看代码发现 go 里把 sha1的结果用 json 编码，然后传到 php里 json 解码。这部分非常可疑，为何要用 json 编码（用 hex 传过去它不香么），本地搭一下环境跟一下。（题目给了dockerfile）</p>
<p>起个docker，改一下 index.php，加一个<code>var_dump($d);</code>，再改一下 go，返回一下 php 的结果：</p>
<pre class="line-numbers language-go"><code class="language-go">fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span><span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在让程序签名，返回结果：</p>
<pre><code>string(38) "    ��.���?-�KC��@�"
"K4FEmxz4yuTsjDAbRZQmHJ+MBiCSGaOnpZTLbThXpCkDYe3siAIPfihX6ppjN2Tz6XqOr4tF\/u1\/+ccfhj8NNLIL+2hknyDXbosmMBV8mEGYsMqQHAE0f+3OhDWlzN5RnteSMYNZbTipFErB8ZOWCiXmynWxsqJhyaN9J6\/\/h6I="
oops, hsm is jsonless?</code></pre><p>$d 竟然是长度为 38 的字符串，看来果然是这里编码有问题，我们需要看一下每个步骤的结果，先看一下 go 里 json编码后的 sha1 结果是什么：</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"crypto/sha1"</span>
    <span class="token string">"encoding/json"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg <span class="token operator">:=</span> <span class="token string">"172.17.0.1|ls -l"</span>
    digest <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

    b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
    json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>digest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行一下：</p>
<pre><code>"\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd"</code></pre><p>和正常的sha1的结果来比较一下：</p>
<pre class="line-numbers language-bash"><code class="language-bash">Python 2.7.16 <span class="token punctuation">(</span>default, Sep  2 2019, 11:59:44<span class="token punctuation">)</span>
<span class="token punctuation">[</span>GCC 4.2.1 Compatible Apple LLVM 10.0.1 <span class="token punctuation">(</span>clang-1001.0.46.4<span class="token punctuation">)</span><span class="token punctuation">]</span> on darwin
Type <span class="token string">"help"</span>, <span class="token string">"copyright"</span>, <span class="token string">"credits"</span> or <span class="token string">"license"</span> <span class="token keyword">for</span> <span class="token function">more</span> information.
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">"\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd"</span>
<span class="token string">'\\u000e\t\\u001d\\ufffd\\u0012\\ufffd.\\ufffd\\ufffd\\ufffd?-\\ufffdKC\\ufffd\\u0005\\ufffd@\\ufffd'</span>
<span class="token operator">>></span><span class="token operator">></span> from hashlib <span class="token function">import</span> *
<span class="token operator">>></span><span class="token operator">></span> sha1<span class="token punctuation">(</span><span class="token string">'172.17.0.1|ls -l'</span><span class="token punctuation">)</span>.digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'\x0e\t\x1d\xbd\x12\x90.\xca\xf0\xd9?-\x98KC\xeb\x05\xa1@\xd1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于 go 的 json 编码，很多不可见字符都被转为了 <code>U+fffd</code>，丢失了很多信息。</p>
<p>再经过 php 接口的接收，我们来看一下结果：</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$d</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span>'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input'), JSON_THROW_ON_ERROR);</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span>'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input'));</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果：</p>
<pre><code>string(89) ""\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd"
"
string(38) "    ��.���?-�KC��@�"
string(76) "0e091defbfbd12efbfbd2eefbfbdefbfbdefbfbd3f2defbfbd4b43efbfbd05efbfbd40efbfbd"
"K4FEmxz4yuTsjDAbRZQmHJ+MBiCSGaOnpZTLbThXpCkDYe3siAIPfihX6ppjN2Tz6XqOr4tF\/u1\/+ccfhj8NNLIL+2hknyDXbosmMBV8mEGYsMqQHAE0f+3OhDWlzN5RnteSMYNZbTipFErB8ZOWCiXmynWxsqJhyaN9J6\/\/h6I="
oops, hsm is jsonless?
</code></pre><p><code>U+fffd</code>变成了<code>\xef\xbf\xbd</code>。所以由于 go 的 json 编码问题，丢失了很多信息，造成了 md5 前的数据有很多相同字符。当时做题时往下并没有细想，得到 n 后总是想构造出任意命令的签名，也很疑惑如果构造出岂不是这种签名就不安全了？其实是无法得到的。</p>
<p>正解是 go 的这种问题 ，为碰撞创造了条件。我们可以碰撞出在这种编码情况下与 <code>ls -l</code>有相同结果的<code>cat *</code> 此类命令。但是问题是我们需要非常大量 ip 来提供碰撞的数据。</p>
<p>可以发现，go 取 ip 的时候，是先用<code>net.ParseIP</code>解析了 ip，我们在 ip 每个数字前面加 0 ，解析后还是原来的 ip 结果，每个数字最多添加 256 个 0，四个数字就已经产生了 <code>2^32</code>种不同的组合，足以碰撞出 <code>ls -l</code>与 <code>cat *</code>之间的冲突。</p>
<p>官方题解的 c++ 碰撞脚本我本地编译的有点问题，加了一些引入的头文件：</p>
<pre class="line-numbers language-c++"><code class="language-c++">// g++ -std=c++17 -march=native -O3 -lcrypto -lpthread gewalt.cpp -o gewalt

#include <cassert>
#include <iomanip>
#include <string>
#include <sstream>
#include <iostream>
#include <functional>
#include <random>
#include <unordered_map>
#include <algorithm>
#include <thread>
#include <atomic>
#include <mutex>
#include <array>
#include <openssl/sha.h>

const unsigned num_threads = std::thread::hardware_concurrency();



static std::string hash(std::string const& s)
{
    SHA_CTX ctx;
    if (!SHA1_Init(&ctx)) throw;
    if (!SHA1_Update(&ctx, s.data(), s.length())) throw;
    std::string d(SHA_DIGEST_LENGTH, 0);
    if (!SHA1_Final((uint8_t *) &d[0], &ctx)) throw;
    return d;
}

static std::u32string kapot(std::string const& s)
{
    std::u32string r(s.size(), 0);
    size_t o = 0;

    for (size_t i = 0; i < s.length(); ) {

        auto T = [](uint8_t c) {
            return (c < 0x80)         ? 1   /* ASCII */
                 : (c & 0xc0) == 0x80 ? 0   /* continuation */
                 : (c & 0xe0) == 0xc0 ? 2   /* 2-byte chunk */
                 : (c & 0xf0) == 0xe0 ? 3   /* 3-byte chunk */
                 : (c & 0xf8) == 0xf0 ? 4   /* 4-byte chunk */
                 : -1;
        };

        uint32_t c = s[i++];
        auto cont = [&]() { c = (c << 6) | (s[i++] & 0x3f); };

        switch (T(c)) {

        case -1:
        case  0:
        invalid: c = 0xfffd; /* fall through */

        case  1:
        valid:   r[o++] = c; break;

        case  2:
                 if (c &= 0x1f, i+0 >= s.size() || T(s[i+0]))
                     goto invalid;
                 goto one;

        case  3:
                 if (c &= 0x1f, i+1 >= s.size() || T(s[i+0]) || T(s[i+1]))
                     goto invalid;
                 goto two;

        case  4:
                 if (c &= 0x1f, i+2 >= s.size() || T(s[i+0]) || T(s[i+1]) || T(s[i+2]))
                     goto invalid;
                 cont();
        two:     cont();
        one:     cont();
                 goto valid;

        }

    }

    r.resize(o);

    return r;
}

std::atomic<uint64_t> hcount = 0, kcount = 0;
typedef std::unordered_map<std::u32string, std::string> tab_t;
tab_t tab0, tab1;
std::mutex mtx;

std::array<uint8_t,4> ip;
std::string cmd0, cmd1;

class stuffer_t
{
    private:
        std::array<size_t,4> cnts;
        size_t step;
        std::string cmd;
    public:
        stuffer_t(size_t t, size_t s, std::string c) : cnts{t}, step(s), cmd(c) {}
        std::string operator()()
        {
            //XXX this is by far not the most efficient way of doing this, but yeah
            if (++cnts[3] >= cnts[0]) {
                cnts[3] = 0;
                if (++cnts[2] >= cnts[0]) {
                    cnts[2] = 0;
                    if (++cnts[1] >= cnts[0]) {
                        cnts[1] = 0;
                        cnts[0] += step;
                    }
                }
            }
            std::stringstream o;
            for (size_t i = 0; i < 4; ++i)
                o << (i ? "." : "")
                  << std::string(cnts[i], '0')
                  << (unsigned) ip[i];
            o << "|" << cmd;
            return o.str();
        }
};

void go(size_t tid)
{
    //XXX tid stuff is a hack, but YOLO

    bool one = tid & 1;

    stuffer_t next(tid >> 1, (num_threads + 1) >> 1, one ? cmd1 : cmd0);

    tab_t& mytab = one ? tab1 : tab0;
    tab_t& thtab = one ? tab0 : tab1;

    uint64_t myhcount = 0, mykcount = 0;

    while (1) {

        std::string r = next();

        {

            ++myhcount;

            auto h = hash(r);
            if ((h.size()+3)/4 < (size_t) std::count_if(h.begin(), h.end(),
                                            [](unsigned char c) { return c < 0x80; }))
                continue;

            ++mykcount;

            auto k = kapot(h);
            if (k.size() > 3 + (size_t) std::count(k.begin(), k.end(), 0xfffd))
                continue;

            std::lock_guard<std::mutex> lck(mtx);

            hcount += myhcount, myhcount = 0;
            kcount += mykcount, mykcount = 0;

            if (thtab.find(k) != thtab.end()) {

                mytab[k] = r;

                std::cerr << "\r\x1b[K"
                          << "\x1b[32m";
                std::cout << tab0[k] << std::endl
                          << tab1[k] << std::endl;
                std::cerr << "\x1b[0m";

                std::cerr << std::hex;
                bool first = true;
                for (uint32_t c: k)
                    std::cerr << (first ? first = false, "" : " ") << c;
                std::cerr << std::endl;

                std::cerr << std::dec << "hash count:  \x1b[35m" << hcount << "\x1b[0m";
                {
                    std::stringstream s;
                    s << std::fixed << std::setprecision(2) << log(hcount|1)/log(2);
                    std::cerr << " (2^\x1b[35m" << std::setw(5) << s.str() << "\x1b[0m" << ")" << std::endl;
                }
                std::cerr << "kapot count: " << "\x1b[35m" << kcount << "\x1b[0m";
                {
                    std::stringstream s;
                    s << std::fixed << std::setprecision(2) << log(kcount|1)/log(2);
                    std::cerr << " (2^\x1b[35m" << std::setw(5) << s.str() << "\x1b[0m)" << std::endl;
                }
                std::cerr << "table sizes: \x1b[35m"
                          << tab0.size() << "\x1b[0m \x1b[35m"
                          << tab1.size() << "\x1b[0m" << std::endl;

                exit(0);

            }

            if (mytab.size() < (1 << 20))
                mytab[k] = r;

        }

        hcount += myhcount;
        kcount += mykcount;

    }
}

void status()
{
    while (1) {

        {
            std::lock_guard<std::mutex> lck(mtx);

            std::cerr << "\r\x1b[K";
            std::cerr << "hash count: \x1b[35m" << std::setw(12) << hcount << "\x1b[0m ";
            {
                std::stringstream s;
                s << std::fixed << std::setprecision(2) << log(hcount|1)/log(2);
                std::cerr << "(2^\x1b[35m" << std::setw(5) << s.str() << "\x1b[0m) | ";
            }
            std::cerr << "kapot count: \x1b[35m" << std::setw(12) << kcount << "\x1b[0m ";
            {
                std::stringstream s;
                s << std::fixed << std::setprecision(2) << log(kcount|1)/log(2);
                std::cerr << "(2^\x1b[35m" << std::setw(5) << s.str() << "\x1b[0m) | ";
            }
            std::cerr << "tables: \x1b[35m"
                      << std::setw(9) << tab0.size() << " "
                      << std::setw(9) << tab1.size() << "\x1b[0m "
                      << std::flush;
        }

        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
}

int main(int argc, char **argv)
{

    if (argc < 2) {
        std::cerr << "\x1b[31mneed IPv4 in argv[1]\x1b[0m" << std::endl;
        exit(1);
    }
    {
        std::stringstream ss(argv[1]);
        for (auto& v: ip) {
            std::string s;
            std::getline(ss, s, '.');
            int n = std::atoi(s.c_str());
            if (n < std::numeric_limits<uint8_t>::min() || n > std::numeric_limits<uint8_t>::max())
                goto bad_ip;
            v = n;
        }
        if (!ss) {
bad_ip:
            std::cerr << "\x1b[31mbad IPv4 given?\x1b[0m" << std::endl;
            exit(2);
        }
    }


    if (argc < 4) {
        std::cerr << "\x1b[31mneed commands in argv[2] and argv[3]\x1b[0m" << std::endl;
        exit(2);
    }
    cmd0 = argv[2];
    cmd1 = argv[3];


    std::thread status_thread(status);
    std::vector<std::thread> ts;
    for (unsigned i = 0; i < num_threads; ++i)
        ts.push_back(std::thread(go, i));
    for (auto& t: ts)
        t.join();

}

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译可能会找不到 <code>lcrypto</code>，编译命令加上 lcrypto 路径（我本地是 /usr/local/opt/openssl/lib）</p>
<pre class="line-numbers language-bash"><code class="language-bash">g++ -std<span class="token operator">=</span>c++17 -march<span class="token operator">=</span>native -O3 -lcrypto -lpthread gewalt.cpp -o gewalt -L/usr/local/opt/openssl/lib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>与 go 交互的脚本：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> sys<span class="token punctuation">,</span> requests<span class="token punctuation">,</span> subprocess

benign_cmd <span class="token operator">=</span> <span class="token string">'ls -l'</span>
exploit_cmd <span class="token operator">=</span> <span class="token string">'cat *'</span>

ip<span class="token punctuation">,</span> port <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
url <span class="token operator">=</span> <span class="token string">'http://{}:{}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

my_ip <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/ip'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] IP: '</span> <span class="token operator">+</span> my_ip<span class="token punctuation">)</span>

o <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./gewalt'</span><span class="token punctuation">,</span> my_ip<span class="token punctuation">,</span> benign_cmd<span class="token punctuation">,</span> exploit_cmd<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] gewalt:'</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> l <span class="token keyword">in</span> o<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ip<span class="token punctuation">,</span> cmd <span class="token operator">=</span> l<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span>
    payload<span class="token punctuation">[</span><span class="token string">'benign'</span> <span class="token keyword">if</span> cmd <span class="token operator">==</span> benign_cmd <span class="token keyword">else</span> <span class="token string">'pwn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ip<span class="token punctuation">,</span> cmd

<span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sig  <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/sign'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'ip'</span><span class="token punctuation">:</span> payload<span class="token punctuation">[</span><span class="token string">'benign'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'cmd'</span><span class="token punctuation">:</span> payload<span class="token punctuation">[</span><span class="token string">'benign'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] sig: '</span> <span class="token operator">+</span> sig<span class="token punctuation">)</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/exec'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'signature'</span><span class="token punctuation">:</span> sig<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">172</span><span class="token punctuation">]</span> <span class="token operator">+</span> payload<span class="token punctuation">[</span><span class="token string">'pwn'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">+</span> <span class="token string">'|'</span> <span class="token operator">+</span> payload<span class="token punctuation">[</span><span class="token string">'pwn'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash"> ⚙  SaV-ls-l-aaS  python solve.py 127.0.0.1 60601
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> IP: 172.17.0.1
fffd fffd fffd fffd fffd fffd 55 fffd fffd fffd fffd c fffd fffd fffd fffd fffd fffd fffd fffd
<span class="token function">hash</span> count:  168104875 <span class="token punctuation">(</span>2^27.32<span class="token punctuation">)</span>
kapot count: 3477222 <span class="token punctuation">(</span>2^21.73<span class="token punctuation">)</span>
table sizes: 8745 8856
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> gewalt:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001<span class="token operator">|</span><span class="token function">ls</span> -l
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.17.000000000000000000000000.0000000000000000000000000000000000000001<span class="token operator">|</span><span class="token function">cat</span> *

<span class="token punctuation">{</span><span class="token string">'pwn'</span><span class="token keyword">:</span> <span class="token punctuation">(</span>u<span class="token string">'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.17.000000000000000000000000.0000000000000000000000000000000000000001'</span>, u<span class="token string">'cat *'</span><span class="token punctuation">)</span>, <span class="token string">'benign'</span><span class="token keyword">:</span> <span class="token punctuation">(</span>u<span class="token string">'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001'</span>, u<span class="token string">'ls -l'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> sig: ODxSukwtu4rHICBpzT23WGD7DCJNawhA0DUN/tcyv1AgwNmS8OPUnO5FnBBDgiaVx5OTYd4OjH8LVbKiXUBUBuFx1OHDgKBKG5umkKMLt+350SlgMWY5qWny9tPIU3I+X0A9FcADCBCi6f0PkXfc0CSCZXuFu9rAKnVGsbmaUwY<span class="token operator">=</span>00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001<span class="token operator">|</span><span class="token function">ls</span> -l
hxp<span class="token punctuation">{</span>FLAG<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h1><p>在日常生活中，我们在参加某个活动的时候，可能会需要签名，以便于证明我们确实到场了，，，防止导员啥的，你懂得。。。但其实吧，这种签名很容易被伪造，随便找一个人代签一下，或者说找一个会模仿别人字迹的人帮忙签一下。在计算机世界中，我们可能会需要电子签名，因为我们大多数情况下会使用电子文件，那这时候怎么办呢？当然，我们仍然可以选择使用自己的名字。但其实还有另外一种方式，那就是采用数字签名，这种签名更加难以伪造，可信程度更高。数字签名的主要用处是确保消息确实来自于声称产生该消息的人。</p>
<p>数字签名（digital signature）主要用于对数字消息（digital message）进行签名，以防消息的冒名伪造或篡改，亦可以用于通信双方的身份鉴别。</p>
<p>数字签名依赖于非对称密码，因为我们必须确保一方能够做的事情，而另一方不能够做出这样的事情。其基本原理如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/Digital_Signature_diagram.png" alt=""></p>
<p>数字签名应当具有以下几个特性：</p>
<p>(1) 签名是可信的：任何人都可以验证签名的有效性。</p>
<p>(2) 签名是不可伪造的：除了合法的签名者之外，任何其他人伪造其签名是困难的。</p>
<p>(3) 签名是不可复制的：对一个消息的签名不能通过复制变为另一个消息的签名。如果对一个消息的签名是从别处复制得到的，则任何人都可以发现消息与签名之间的不一致性，从而可以拒绝签名的消息。</p>
<p>(4) 签名的消息是不可改变的：经签名的消息不能被篡改。一旦签名的消息被篡改，则任何人都可以发现消息与签名之间的不一致性。</p>
<p>(5) 签名是不可抵赖的：签名者事后不能否认自己的签名。</p>
<h1 id="RSA-数字签名"><a href="#RSA-数字签名" class="headerlink" title="RSA 数字签名"></a>RSA 数字签名</h1><h2 id="原理-24"><a href="#原理-24" class="headerlink" title="原理"></a>原理</h2><p>原理类似于 RSA 加密，只是这里使用私钥进行加密，将加密后的结果作为签名。</p>
<h2 id="2018-Backdoor-Awesome-mix1"><a href="#2018-Backdoor-Awesome-mix1" class="headerlink" title="2018 Backdoor Awesome mix1"></a>2018 Backdoor Awesome mix1</h2><p>首先，可以简单分析源码，这里程序使用 PKCS1_V1.5 进行了 RSA 签名，这会对明文消息进行扩展，具体扩展规则请参考 <a href="https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf" target="_blank" rel="noopener">https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf</a> 。这里给出对应扩展脚本，对应于题目中的 <code>from Util import PKCS1_pad as pad</code> </p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">PKCS1_pad</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    asn1 <span class="token operator">=</span> <span class="token string">"3021300906052b0e03021a05000414"</span>
    ans <span class="token operator">=</span> asn1 <span class="token operator">+</span> data
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>ans<span class="token punctuation">)</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'00'</span> <span class="token operator">+</span> <span class="token string">'01'</span> <span class="token operator">+</span> <span class="token string">'ff'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">-</span> n <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'00'</span> <span class="token operator">+</span> ans<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序希望我们给出 <code>n,e</code> 使得程序满足 </p>
<p>$h(m)^e mod \ n=pad(m)$</p>
<p>这里我们已经知道 <code>h(m)，pad(m)</code>。显然如果我们控制 <code>e=1</code>的话，那么</p>
<p>$h(m)-pad(m)=kn$</p>
<p>那么如果我们可以设置 k=1，既可以得到 n。</p>
<p>本地部署 <code>socat TCP4-LISTEN:12345,fork EXEC:./mix1.py</code>。</p>
<p>exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">from</span> Util <span class="token keyword">import</span> PKCS1_pad

<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> <span class="token number">12345</span>
    host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Message   -> '</span><span class="token punctuation">)</span>
    message <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n\nSignature -> '</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'message: '</span> <span class="token operator">+</span> message<span class="token punctuation">)</span>
    signature <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'signature: '</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span>

    h <span class="token operator">=</span> SHA<span class="token punctuation">.</span>new<span class="token punctuation">(</span>message<span class="token punctuation">)</span>

    m <span class="token operator">=</span> PKCS1_pad<span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    e <span class="token operator">=</span> <span class="token number">1</span>
    n <span class="token operator">=</span> int<span class="token punctuation">(</span>signature<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> m

    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter n:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter e:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2018-BackdoorCTF-Awesome-mix1 git:(master) python exp.py
[+] Opening connection to 127.0.0.1 on port 12345: Done
[*] message: super important information for admin only
[*] signature: 721af5bd401b5f2aff8e86bf811b827cdb5877ef12202f24fa914a26f235523f80c45fdbf0d3c9fa77278828ddd8ca0551a941bd57c97dd38654692568d1357a49e7a2a284d296508602ead24c91e5aa7f517b9e48422575f0dd373d00f267a206ba164ab104c488268b5f95daf490a048407773d4b1016de8ef508bf1aa678f
[*] Switching to interactive mode
CTF{cryp70_5ur3_15_w13rd}
[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2018-Backdoor-Awesome-mix2"><a href="#2018-Backdoor-Awesome-mix2" class="headerlink" title="2018 Backdoor Awesome mix2"></a>2018 Backdoor Awesome mix2</h2><p>本地部署 <code>socat TCP4-LISTEN:12345,fork EXEC:./service.py</code>。</p>
<p>题目类似于上面的题目，唯一的区别在于对于 e 有约束，必须大于 3，所以我们不能使用 1 了。</p>
<p>$h(m)^e mod \ n=pad(m)$</p>
<p>这里我们已经知道 <code>h(m)，pad(m)</code>。我们只需要构造剩下的数即可，这里我们构造 n 为素数，使得 n-1是一个光滑数，这样就可以使用 pohlig_hellman 算法了。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> is_prime
<span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">PKCS1_pad</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    asn1 <span class="token operator">=</span> <span class="token string">"3021300906052b0e03021a05000414"</span>
    ans <span class="token operator">=</span> asn1 <span class="token operator">+</span> data
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>ans<span class="token punctuation">)</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'00'</span> <span class="token operator">+</span> <span class="token string">'01'</span> <span class="token operator">+</span> <span class="token string">'ff'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">-</span> n <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'00'</span> <span class="token operator">+</span> ans<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>
<span class="token keyword">def</span> <span class="token function">gen_smooth_num</span><span class="token punctuation">(</span>plist<span class="token punctuation">,</span> minnum<span class="token operator">=</span>pow<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1020</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lenp <span class="token operator">=</span> len<span class="token punctuation">(</span>plist<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> <span class="token number">1</span>
        factors <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> minnum<span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lenp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            n <span class="token operator">*=</span> plist<span class="token punctuation">[</span>tmp<span class="token punctuation">]</span>
            <span class="token keyword">if</span> plist<span class="token punctuation">[</span>tmp<span class="token punctuation">]</span> <span class="token keyword">in</span> factors<span class="token punctuation">:</span>
                factors<span class="token punctuation">[</span>plist<span class="token punctuation">[</span>tmp<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                factors<span class="token punctuation">[</span>plist<span class="token punctuation">[</span>tmp<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1024</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> is_prime<span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> factors


<span class="token comment" spellcheck="true"># http://pythonexample.com/snippet/pohligpy_neuratron_python</span>
<span class="token comment" spellcheck="true"># solve g^x=h mod m</span>
<span class="token keyword">def</span> <span class="token function">log_prime_power</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> pe<span class="token punctuation">,</span> M<span class="token punctuation">)</span><span class="token punctuation">:</span>

    powers <span class="token operator">=</span> <span class="token punctuation">[</span>pf<span class="token operator">**</span>k <span class="token keyword">for</span> k <span class="token keyword">in</span> range<span class="token punctuation">(</span>pe<span class="token punctuation">)</span><span class="token punctuation">]</span>

    gamma <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>g<span class="token punctuation">,</span> powers<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">)</span>

    xk <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>mpz<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> range<span class="token punctuation">(</span>pe<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> k <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            hk <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>h<span class="token punctuation">,</span> powers<span class="token punctuation">[</span>pe <span class="token operator">-</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            gk <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>g<span class="token punctuation">,</span> xk <span class="token operator">*</span> <span class="token punctuation">(</span>M <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> M<span class="token punctuation">)</span>
            hk <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>gk <span class="token operator">*</span> h<span class="token punctuation">,</span> powers<span class="token punctuation">[</span>pe <span class="token operator">-</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">)</span>

        k_log_found <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">for</span> dk <span class="token keyword">in</span> range<span class="token punctuation">(</span>pf<span class="token punctuation">)</span><span class="token punctuation">:</span>
            yk <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>gamma<span class="token punctuation">,</span> dk<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
            <span class="token keyword">if</span> yk <span class="token operator">==</span> hk<span class="token punctuation">:</span>
                k_log_found <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">break</span>

        <span class="token keyword">if</span> <span class="token operator">not</span> k_log_found<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"can not solve"</span><span class="token punctuation">)</span>

        xk <span class="token operator">+=</span> gmpy2<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>powers<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> dk<span class="token punctuation">)</span>

    <span class="token keyword">return</span> xk


<span class="token keyword">def</span> <span class="token function">pohlig_hellman</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> M<span class="token punctuation">,</span> factors<span class="token punctuation">)</span><span class="token punctuation">:</span>
    M1 <span class="token operator">=</span> M <span class="token operator">-</span> <span class="token number">1</span>
    xs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> factors<span class="token punctuation">:</span>
        pf <span class="token operator">=</span> f
        pe <span class="token operator">=</span> factors<span class="token punctuation">[</span>f<span class="token punctuation">]</span>

        subgroup_exponent <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>div<span class="token punctuation">(</span>M1<span class="token punctuation">,</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>pf<span class="token punctuation">,</span> pe<span class="token punctuation">,</span> M<span class="token punctuation">)</span><span class="token punctuation">)</span>
        gi <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>g<span class="token punctuation">,</span> subgroup_exponent<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
        hi <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>h<span class="token punctuation">,</span> subgroup_exponent<span class="token punctuation">,</span> M<span class="token punctuation">)</span>

        xi <span class="token operator">=</span> log_prime_power<span class="token punctuation">(</span>gi<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> pe<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
        xs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xi<span class="token punctuation">)</span>
    crt_coeffs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> f <span class="token keyword">in</span> factors<span class="token punctuation">:</span>
        pf <span class="token operator">=</span> f
        pe <span class="token operator">=</span> factors<span class="token punctuation">[</span>f<span class="token punctuation">]</span>

        mi <span class="token operator">=</span> pf<span class="token operator">**</span>pe

        bi <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>div<span class="token punctuation">(</span>M<span class="token punctuation">,</span> mi<span class="token punctuation">)</span>
        bi_inv <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>bi<span class="token punctuation">,</span> mi<span class="token punctuation">)</span>
        crt_coeffs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gmpy2<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>bi<span class="token punctuation">,</span> bi_inv<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>crt_coeffs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>t_mod<span class="token punctuation">(</span>x <span class="token operator">+</span> gmpy2<span class="token punctuation">.</span>t_mod<span class="token punctuation">(</span>xs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> crt_coeffs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> M1<span class="token punctuation">)</span><span class="token punctuation">,</span> M1<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x


<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> <span class="token number">12345</span>
    host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Message   -> '</span><span class="token punctuation">)</span>
    message <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n\nSignature -> '</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'message: '</span> <span class="token operator">+</span> message<span class="token punctuation">)</span>
    signature <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'signature: '</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span>
    signature <span class="token operator">=</span> int<span class="token punctuation">(</span>signature<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    h <span class="token operator">=</span> SHA<span class="token punctuation">.</span>new<span class="token punctuation">(</span>message<span class="token punctuation">)</span>

    m <span class="token operator">=</span> PKCS1_pad<span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> m<span class="token punctuation">,</span> signature
    plist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> is_prime<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
            plist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            n<span class="token punctuation">,</span> factors <span class="token operator">=</span> gen_smooth_num<span class="token punctuation">(</span>plist<span class="token punctuation">,</span> signature<span class="token punctuation">)</span>
            e <span class="token operator">=</span> pohlig_hellman<span class="token punctuation">(</span>signature<span class="token punctuation">,</span> m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> factors<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">print</span> n<span class="token punctuation">,</span> e

    <span class="token keyword">print</span> m
    <span class="token keyword">print</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>signature<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter n:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Enter e:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有两点需要注意</p>
<ol>
<li>由于 $g^x=y$ 中的 g 和 y 都是给定的，我们新找到的 n，不一定 g 的幂次构成的群会包含 y，所以可能求解失败，所以需要多次求解。</li>
<li>源代码中虽然 <code>n.bit_length() &lt;= 1025</code>，但是其实 n 在满足不小于 signature 的条件时，必须满足如下条件（pycrypto 源码）</li>
</ol>
<pre class="line-numbers language-python"><code class="language-python">        modBits <span class="token operator">=</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number<span class="token punctuation">.</span>size<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
        k <span class="token operator">=</span> ceil_div<span class="token punctuation">(</span>modBits<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># Convert from bits to bytes</span>

        <span class="token comment" spellcheck="true"># Step 1</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">!=</span> k<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以我们最好设置 n 为1024 比特位。</p>
<h1 id="ElGamal-1"><a href="#ElGamal-1" class="headerlink" title="ElGamal"></a>ElGamal</h1><p>RSA的数字签名方案几乎与其加密方案完全一致，只是利用私钥进行了签名。但是，对于ElGamal来说，其签名方案与相应的加密方案具有很大区别。</p>
<h2 id="基本原理-3"><a href="#基本原理-3" class="headerlink" title="基本原理"></a>基本原理</h2><h3 id="密钥生成-3"><a href="#密钥生成-3" class="headerlink" title="密钥生成"></a>密钥生成</h3><p>基本步骤如下</p>
<ol>
<li>选取一个足够大的素数p（十进制位数不低于160），以便于在$Z_p$ 上求解离散对数问题是困难的。</li>
<li>选取$Z_p^*$ 的生成元g。</li>
<li>随机选取整数d,$0\leq d \leq p-2$ ，并计算$g^d \equiv y \bmod p$ 。</li>
</ol>
<p>其中私钥为{d}，公钥为{p,g,y} 。</p>
<h3 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h3><p>A选取随机数$k \in Z_{p-1}$ ，并且$gcd(k,p-1)=1$，对消息进行签名</p>
<p>$$<br>sig_d(m,k)=(r,s)<br>$$</p>
<p>其中$r \equiv g^k \bmod p$ ，$s \equiv (m-dr)k^{-1} \bmod p-1$ 。</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>如果 $g^m \equiv y^rr^s \bmod p$ ，那么验证成功，否则验证失败。这里验证成功的原理如下，首先我们有</p>
<p>$$<br>y^rr^s \equiv g^{dr}g^{ks} \equiv g^{dr+ks}<br>$$</p>
<p>又因为</p>
<p>$$<br>s \equiv (m-dr)k^{-1} \bmod p-1<br>$$</p>
<p>所以</p>
<p>$$<br>ks \equiv m-dr \bmod p-1<br>$$</p>
<p>进而</p>
<p>$$<br>ks+dr=a*(p-1)+m<br>$$</p>
<p>所以</p>
<p>$$<br>g^{ks+dr}=g^{a<em>(p-1)+m}=(g^{p-1})^a</em>g^m<br>$$</p>
<p>所以根据费马定理，可得</p>
<p>$$<br>g^{ks+dr} \equiv g^m \bmod p<br>$$</p>
<h2 id="常见攻击"><a href="#常见攻击" class="headerlink" title="常见攻击"></a>常见攻击</h2><h3 id="完全破译攻击"><a href="#完全破译攻击" class="headerlink" title="完全破译攻击"></a>完全破译攻击</h3><h4 id="攻击条件-13"><a href="#攻击条件-13" class="headerlink" title="攻击条件"></a>攻击条件</h4><ul>
<li>p太小或无大素因子</li>
</ul>
<p>如果$p$太小我们可以直接用大部小步算法分解, 或者如果其无大的素因子, 我们可以采用$Pohling: Hellman$算法计算离散对数即可进而求出私钥。</p>
<ul>
<li>随机数k复用</li>
</ul>
<p>如果签名者复用了随机数k，那么攻击者就可以轻而易举地计算出私钥。具体的原理如下：</p>
<p>假设目前有两个签名都是使用同一个随机数进行签名的。那么我们有</p>
<p>$$<br>r \equiv g^k \bmod p \\ s _1\equiv (m_1-dr)k^{-1} \bmod p-1\\ r \equiv g^k \bmod p \\ s_2 \equiv (m_2-dr)k^{-1} \bmod p-1<br>$$</p>
<p>进而有</p>
<p>$$<br>s_1k \equiv m_1-dr \bmod p-1 \\ s_2k \equiv m_2-dr \bmod p-1<br>$$</p>
<p>两式相减</p>
<p>$$<br>k(s_1-s_2) \equiv m_1-m_2 \bmod p-1<br>$$</p>
<p>这里，$s_1,s_2,m_1,m_2,p-1$ 均已知，所以我们可以很容易算出k。当然，如果$gcd(s_1-s_2,p-1)!=1$ 的话，可能会存在多个解，这时我们只需要多试一试。进而，我们可以根据s的计算方法得到私钥d，如下</p>
<p>$$<br>d \equiv \frac{m-ks}{r}<br>$$</p>
<h4 id="题目-7"><a href="#题目-7" class="headerlink" title="题目"></a>题目</h4><p>2016 LCTF Crypto 450</p>
<h3 id="通用伪造签名"><a href="#通用伪造签名" class="headerlink" title="通用伪造签名"></a>通用伪造签名</h3><h4 id="攻击条件-14"><a href="#攻击条件-14" class="headerlink" title="攻击条件"></a>攻击条件</h4><p>如果消息$m$没有取哈希，或者消息$m$没有指定消息格式的情况下攻击成立。</p>
<h4 id="原理-25"><a href="#原理-25" class="headerlink" title="原理"></a>原理</h4><p>在攻击者知道了某个人Alice的公钥之后，他可以伪造Alice的签名信息。具体原理如下:</p>
<p>这里我们假设，Alice的公钥为{p,g,y}。攻击者可以按照如下方式伪造</p>
<ol>
<li><p>选择整数 $i$，$j$，其中$gcd(j,p-1)=1$</p>
</li>
<li><p>计算签名，$r \equiv g^iy^j \bmod p$ ，$s\equiv -rj^{-1} \bmod p-1$</p>
</li>
<li><p>计算消息，$m\equiv si \bmod p-1$</p>
</li>
</ol>
<p>那么此时生成的签名与消息就是可以被正常通过验证，具体推导如下:</p>
<p>$y^rr^s \equiv g^{dr}g^{is}y^{js} \equiv g^{dr}g^{djs}g^{is} \equiv g^{dr+s(i+dj)} \equiv g^{dr} g^{-rj^{-1}(i+dj)} \equiv g^{dr-dr-rij^{-1}} \equiv g^{si} \bmod p$</p>
<p>又由于消息m的构造方式，所以</p>
<p>$$<br>g^{si} \equiv g^m \bmod p-1<br>$$</p>
<p>需要注意的是，攻击者可以伪造通过签名验证的消息，但是他却无法伪造指定格式的消息。而且，一旦消息进行了哈希操作，这一攻击就不再可行。</p>
<h3 id="已知签名伪造"><a href="#已知签名伪造" class="headerlink" title="已知签名伪造"></a>已知签名伪造</h3><h4 id="攻击条件-15"><a href="#攻击条件-15" class="headerlink" title="攻击条件"></a>攻击条件</h4><p>假设攻击者知道$(r, s)$是消息$M$的签名，则攻击者可利用它来伪造其它消息的签名。</p>
<h4 id="原理-26"><a href="#原理-26" class="headerlink" title="原理"></a>原理</h4><ol>
<li>选择整数$h, i, j \in[0, p-2]$且满足$\operatorname{gcd}(h r-j s, \varphi(p))=1$</li>
<li>计算下式<br>$\begin{array}{l}<br>r^{\prime}=r^{h} \alpha^{i} y_{A}^{j} \bmod p \<br>s^{\prime}=\operatorname{sr}(h r-j s)^{-1} \bmod \varphi(p) \<br>m^{\prime}=r^{\prime}(h m+i s)(h r-j s)^{-1} \bmod \varphi(p)<br>\end{array}$</li>
</ol>
<p>可得到$(r’,s’)$是$m’$的有效签名</p>
<p>证明如下:</p>
<p>已知Alice对消息$x$的签名$(\gamma,\delta)$满足$\beta^{\gamma} \gamma^{\delta} \equiv \alpha^{x}(\bmod p)$，所以我们目的为构造出$\left(x^{\prime}, \lambda, \mu\right)$满足</p>
<p>$$<br>\beta^{\lambda} \lambda^{\mu} \equiv \alpha^{x’}(\bmod p)<br>$$</p>
<p>那么，首先我们把$\lambda$表示为三个已知底$\alpha, \beta, \gamma$的形式: $\lambda=\alpha^{i} \beta^{j} \gamma^{h} \bmod p$,由条件可得</p>
<p>$$<br>\beta^{\gamma} \gamma^{\delta} \equiv \alpha^{x}(\bmod p) \Leftrightarrow \gamma=\left(\beta^{-\gamma} \alpha^{x}\right)^{\delta-1} \bmod p<br>$$</p>
<p>那么我们可以得到</p>
<p>$$<br>\lambda=\alpha^{i+x \delta^{-1} h} \beta^{j-\gamma \delta^{-1} h} \bmod p<br>$$</p>
<p>我们把$\lambda$的表达式代入一式中</p>
<p>$$<br>\begin{aligned}&amp; \beta^{\lambda}\left(\alpha^{i+x \delta^{-1} h} \beta^{j-\gamma \delta^{-1} h}\right)^{\mu} \equiv \alpha^{x^{\prime}}(\bmod p) \\Leftrightarrow &amp; \beta^{\lambda+\left(j-\gamma \delta^{-1} h\right) \mu} \equiv \alpha^{x^{\prime}-\left(i+x \delta^{-1} h\right) \mu}(\bmod p)\end{aligned}<br>$$</p>
<p>我们令两边指数为$0$, 即</p>
<p>$$<br>\left{\begin{matrix}\lambda+\left(j-\gamma \delta^{-1} h\right) \mu \equiv 0 \bmod p-1 \ x^{\prime}-\left(i+x \delta^{-1} h\right) \mu \equiv 0 \bmod p-1 \end{matrix}\right.<br>$$</p>
<p>可以得到</p>
<p>$$<br>\mu=\delta \lambda(h \gamma-j \delta)^{-1} \quad(\bmod p-1)  \<br>x^{\prime}=\lambda(h x+i \delta)(h \gamma-j \delta)^{-1}(\bmod p-1)<br>$$</p>
<p>其中</p>
<p>$$<br>\lambda=\alpha^{i} \beta^{j} \gamma^{h} \bmod p<br>$$</p>
<p>所以我们得到$(\lambda, \mu)$是 $x’$ 的有效签名。</p>
<p>此外,我们还可以借助CRT构造$m’$, 原理如下:</p>
<ol>
<li>$u=m^{\prime} m^{-1} \bmod \varphi(p), \quad s^{\prime}=s u \bmod \varphi(p)$</li>
<li>再计算$r^{\prime}, \quad r^{\prime} \equiv r u \bmod \varphi(p), r^{\prime} \equiv r \bmod p$</li>
</ol>
<p>显然可以使用CRT求解$r’$, 注意到 $y_{A}^{r’} r’^{s^{\prime}}=y_{A}^{ru} r^{s u}=\left(y_{A}^{r} r^{s}\right)^{u}=\alpha^{m u} \equiv \alpha^{m} \bmod p$ </p>
<p>所以$(r’,s’)$是消息$m’$的有效签名。</p>
<p>抵抗措施:在验证签名时, 检查$r &lt; p$。</p>
<h3 id="选择签名伪造"><a href="#选择签名伪造" class="headerlink" title="选择签名伪造"></a>选择签名伪造</h3><h4 id="攻击条件-16"><a href="#攻击条件-16" class="headerlink" title="攻击条件"></a>攻击条件</h4><p>如果我们可以选择我们消息进行签名，并且可以得到签名，那么我们可以对一个新的但是我们不能够选择签名的消息伪造签名。</p>
<h4 id="原理-27"><a href="#原理-27" class="headerlink" title="原理"></a>原理</h4><p>我们知道，最后验证的过程如下</p>
<p> $g^m \equiv y^rr^s \bmod p$ </p>
<p>那么只要我们选择一个消息m使其和我们所要伪造的消息$m’$模p-1同余，然后同时使用消息m的签名即可绕过。</p>
<h4 id="题目-8"><a href="#题目-8" class="headerlink" title="题目"></a>题目</h4><p>这里以2017年国赛mailbox为例，<strong>i春秋有复现</strong>。</p>
<p>首先，我们来分析一下程序，我们首先需要进行proof of work</p>
<pre class="line-numbers language-python"><code class="language-python">    proof <span class="token operator">=</span> b64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>
        <span class="token string">"Please provide your proof of work, a sha1 sum ending in 16 bit's set to 0, it must be of length %d bytes, starting with %s\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
        len<span class="token punctuation">(</span>proof<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> proof<span class="token punctuation">)</span><span class="token punctuation">)</span>

    test <span class="token operator">=</span> req<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span>
    ha <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ha<span class="token punctuation">.</span>update<span class="token punctuation">(</span>test<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">!=</span> proof <span class="token operator">or</span> ord<span class="token punctuation">(</span>ha<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">or</span> ord<span class="token punctuation">(</span>ha<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># or ord(ha.digest()[-3]) != 0 or ord(ha.digest()[-4]) != 0):</span>
        req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Check failed"</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们需要生成一个以proof开头的长度为proof长度加5的字符串，并且其sha1的值以16比特的0结束。</p>
<p>这里我们直接使用如下的方式来绕过。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> sha1<span class="token punctuation">(</span>prefix <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0\0'</span>


sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'106.75.66.195'</span><span class="token punctuation">,</span> <span class="token number">40001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># bypass proof</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'starting with '</span><span class="token punctuation">)</span>
prefix <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> string<span class="token punctuation">.</span>ascii_letters
s <span class="token operator">=</span> util<span class="token punctuation">.</span>iters<span class="token punctuation">.</span>mbruteforce<span class="token punctuation">(</span>f<span class="token punctuation">,</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'fixed'</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> prefix <span class="token operator">+</span> s
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用了pwntools中的util.iters.mbruteforce，这是一个利用给定字符集合以及指定长度进行多线程爆破的函数。其中，第一个参数为爆破函数，这里是sha1，第二个参数是字符集，第三个参数是字节数，第四个参数指的是我们只尝试字节数为第三个参数指定字节数的排列，即长度是固定的。更加具体的信息请参考pwntools。</p>
<p>绕过之后，我们继续分析程序，简单看下generate_keys函数，可以知道该函数是ElGamal生成公钥的过程，然后看了看verify函数，就是验证签名的过程。</p>
<p>继续分析</p>
<pre class="line-numbers language-python"><code class="language-python">            <span class="token keyword">if</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">></span> MSGLENGTH<span class="token punctuation">:</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"what r u do'in?"</span><span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token keyword">if</span> msg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"test"</span><span class="token punctuation">:</span>
                r<span class="token punctuation">,</span> s <span class="token operator">=</span> sign<span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> sk<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">)</span>
                req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Your signature is"</span> <span class="token operator">+</span> repr<span class="token punctuation">(</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> hex<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">"Th3_bery_un1que1i_ChArmIng_G3nji"</span> <span class="token operator">+</span> test<span class="token punctuation">:</span>
                    req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Signature:"</span><span class="token punctuation">)</span>
                    sig <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> len<span class="token punctuation">(</span>sig<span class="token punctuation">)</span> <span class="token operator">></span> MSGLENGTH<span class="token punctuation">:</span>
                        req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"what r u do'in?"</span><span class="token punctuation">)</span>
                        req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    sig_rs <span class="token operator">=</span> sig<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> len<span class="token punctuation">(</span>sig_rs<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
                        req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"yo what?"</span><span class="token punctuation">)</span>
                        req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    <span class="token comment" spellcheck="true"># print "Got sig", sig_rs</span>
                    <span class="token keyword">if</span> verify<span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>sig_rs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>sig_rs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pk<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Login Success.\nDr. Ziegler has a message for you: "</span> <span class="token operator">+</span> FLAG<span class="token punctuation">)</span>
                        <span class="token keyword">print</span> <span class="token string">"shipped flag"</span>
                        req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        req<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"You are not the Genji I knew!\n"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据这三个if条件可以知道</p>
<ul>
<li>我们的消息长度不能超过MSGLENGTH，40000。</li>
<li>我们可以对消息开头为test的消息进行签名。</li>
<li>我们需要使得以Th3_bery_un1que1i_ChArmIng_G3nji开头，以我们绕过proof的test为结尾的消息通过签名验证，其中，我们可以自己提供签名的值。</li>
</ul>
<p>分析到这里，其实就知道了，我们就是在选择指定签名进行伪造，这里我们自然要充分利用第二个if条件，只要我们确保我们输入的消息的开头为‘test’，并且该消息与以Th3_bery_un1que1i_ChArmIng_G3nji开头的固定消息模p-1同余，我们即可以通过验证。</p>
<p>那我们如何构造呢？既然消息的长度可以足够长，那么我们可以将’test’对应的16进制先左移得到比p-1大的数字a，然后用a对p-1取模，用a再减去余数，此时a模p-1余0了。这时再加上以Th3_bery_un1que1i_ChArmIng_G3nji开头的固定消息的值，即实现了模p-1同余。</p>
<p>具体如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># construct the message begins with 'test'</span>
target <span class="token operator">=</span> <span class="token string">"Th3_bery_un1que1i_ChArmIng_G3nji"</span> <span class="token operator">+</span> test
part1 <span class="token operator">=</span> <span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span><span class="token string">'test'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
victim <span class="token operator">=</span> part1 <span class="token operator">+</span> digitalize<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    tmp <span class="token operator">=</span> hex<span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> tmp<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token string">'\n'</span> <span class="token operator">not</span> <span class="token keyword">in</span> tmp<span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        part1 <span class="token operator">=</span> <span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span><span class="token string">'test'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>
            p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        victim <span class="token operator">=</span> part1 <span class="token operator">+</span> digitalize<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后的脚本如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha1
<span class="token keyword">import</span> string
<span class="token keyword">import</span> ast
<span class="token keyword">import</span> os
<span class="token keyword">import</span> binascii
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>


<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> sha1<span class="token punctuation">(</span>prefix <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0\0'</span>


<span class="token keyword">def</span> <span class="token function">digitalize</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>m<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>


sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'106.75.66.195'</span><span class="token punctuation">,</span> <span class="token number">40001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># bypass proof</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'starting with '</span><span class="token punctuation">)</span>
prefix <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> string<span class="token punctuation">.</span>ascii_letters
s <span class="token operator">=</span> util<span class="token punctuation">.</span>iters<span class="token punctuation">.</span>mbruteforce<span class="token punctuation">(</span>f<span class="token punctuation">,</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'fixed'</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> prefix <span class="token operator">+</span> s
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>test<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Current PK we are using: '</span><span class="token punctuation">)</span>
pubkey <span class="token operator">=</span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> pubkey<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
g <span class="token operator">=</span> pubkey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
pk <span class="token operator">=</span> pubkey<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># construct the message begins with 'test'</span>
target <span class="token operator">=</span> <span class="token string">"Th3_bery_un1que1i_ChArmIng_G3nji"</span> <span class="token operator">+</span> test
part1 <span class="token operator">=</span> <span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span><span class="token string">'test'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
victim <span class="token operator">=</span> part1 <span class="token operator">+</span> digitalize<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    tmp <span class="token operator">=</span> hex<span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> tmp<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token string">'\n'</span> <span class="token operator">not</span> <span class="token keyword">in</span> tmp<span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        part1 <span class="token operator">=</span> <span class="token punctuation">(</span>digitalize<span class="token punctuation">(</span><span class="token string">'test'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>
            p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        victim <span class="token operator">=</span> part1 <span class="token operator">+</span> digitalize<span class="token punctuation">(</span>target<span class="token punctuation">)</span>

<span class="token keyword">assert</span> <span class="token punctuation">(</span>victim <span class="token operator">%</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> digitalize<span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># get victim signature</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your signature is'</span><span class="token punctuation">)</span>
sig <span class="token operator">=</span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sig <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># get flag</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里还要说几个有意思的点就是</p>
<ul>
<li>int(x,0)只的是将x按照其字面对应的进制转换为对应的数字，比如说int(‘0x12’,0)=18，这里相应的字面必须有对应标志开头，比如说十六进制是0x,8进制是0，二进制是0b。因为如果没有的话，就不知道该如何识别了。</li>
<li>python(python2) 里面到底多大的数，计算出来最后才会带有L呢？正常情况下，大于int都会有L。但是这个里面的victim确实是没有的，， <strong>一个问题，待解决。。</strong></li>
</ul>
<h1 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h1><p>上面所描述的ElGamal签名算法在实际中并不常用，更常用的是其变体DSA。</p>
<h2 id="基本原理-4"><a href="#基本原理-4" class="headerlink" title="基本原理"></a>基本原理</h2><h3 id="密钥生成-4"><a href="#密钥生成-4" class="headerlink" title="密钥生成"></a>密钥生成</h3><ol>
<li>选择一个合适的哈希函数，目前一般选择SHA1，当前也可以选择强度更高的哈希函数H。</li>
<li>选择密钥的长度L和N，这两个值决定了签名的安全程度。在最初的DSS（<strong>Digital Signature Standard</strong> ）中建议L必须为64的倍数，并且$512 \leq L \leq 1024$ ，当然，也可以更大。N必须大小必须不大于哈希函数H输出的长度。FIPS 186-3给出了一些建议的L和N的取值例子：(1024, 160)， (2048, 224)， (2048, 256)，以及 (3,072, 256)。</li>
<li>选择N比特的素数q。</li>
<li>选择L比特的素数p，使得p-1是q的倍数。</li>
<li>选择满足$g^k \equiv 1 \bmod p$ 的最小正整数k为q的g，即在模p的背景下，ord(g)=q的g。即g在模p的意义下，其指数次幂可以生成具有q个元素的子群。这里，我们可以通过计算$g=h^{\frac{p-1}{q}} \bmod p$ 来得到g，其中$1&lt; h &lt; p-1$ 。</li>
<li>选择私钥x，$0&lt;x&lt;q$ ，计算$y \equiv g^x \bmod p$ 。</li>
</ol>
<p>公钥为(p,q,g,y)，私钥为(x)。</p>
<h3 id="签名-1"><a href="#签名-1" class="headerlink" title="签名"></a>签名</h3><p>签名步骤如下</p>
<ol>
<li>选择随机整数数k作为临时密钥，$0&lt;k&lt;q$ 。</li>
<li>计算$r\equiv (g^k \bmod p) \bmod q$</li>
<li>计算$s\equiv (H(m)+xr)k^{-1} \bmod q$</li>
</ol>
<p>签名结果为(r,s)。需要注意的是，这里与Elgamal很重要的不同是这里使用了哈希函数对消息进行了哈希处理。</p>
<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>验证过程如下</p>
<ol>
<li>计算辅助值，$w=s^{-1} \bmod q$</li>
<li>计算辅助值，$u_1=H(m)w \bmod q$</li>
<li>计算辅助值，$u_2=rw \bmod q$</li>
<li>计算$v=(g^{u_1}y^{u_2} \bmod p) \bmod q$</li>
<li>如果v与r相等，则校验成功。</li>
</ol>
<h3 id="正确性推导"><a href="#正确性推导" class="headerlink" title="正确性推导"></a>正确性推导</h3><p>首先，g 满足 $g^k \equiv 1 \bmod p$ 的最小正整数k为q。所以 $g^q \equiv 1 \bmod p$  。所以 $g^x \equiv g^{x \bmod q} \bmod p$ 。进而</p>
<p>$v=(g^{u_1}y^{u_2} \bmod p) \bmod q=g^{u_1}g^{xu_2} \equiv g^{H(m)w}g^{xrw} \equiv g^{H(m)w+xrw}$</p>
<p>又$s\equiv (H(m)+xr)k^{-1} \bmod q$ 且$w=s^{-1} \bmod q$ 所以</p>
<p>$k \equiv s^{-1}(H(m)+xr) \equiv H(m)w+xrw \bmod q$</p>
<p>所以$v \equiv g^k$ 。正确性得证。</p>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><h3 id="已知k"><a href="#已知k" class="headerlink" title="已知k"></a>已知k</h3><h4 id="原理-28"><a href="#原理-28" class="headerlink" title="原理"></a>原理</h4><p>如果知道了随机密钥k，那么我们就可以根据$s\equiv (H(m)+xr)k^{-1} \bmod q$ 计算私钥d，几乎攻破了DSA。</p>
<p>这里一般情况下，消息的hash值都会给出。</p>
<p>$x \equiv r^{-1}(ks-H(m)) \bmod q$</p>
<h3 id="k共享"><a href="#k共享" class="headerlink" title="k共享"></a>k共享</h3><h4 id="原理-29"><a href="#原理-29" class="headerlink" title="原理"></a>原理</h4><p>如果在两次签名的过程中共享了k，我们就可以进行攻击。</p>
<p>假设签名的消息为m1,m2，显然，两者的r的值一样，此外</p>
<p>$s_1\equiv (H(m_1)+xr)k^{-1} \bmod q$</p>
<p>$s_2\equiv (H(m_2)+xr)k^{-1} \bmod q$</p>
<p>这里我们除了x和k不知道剩下的均知道，那么</p>
<p>$s_1k \equiv H(m_1)+xr$</p>
<p>$s_2k \equiv H(m_2)+xr$</p>
<p>两式相减</p>
<p>$k(s_1-s_2) \equiv H(m_1)-H(m_2) \bmod q$</p>
<p>此时 即可解出k，进一步我们可以解出x。</p>
<h4 id="例子-8"><a href="#例子-8" class="headerlink" title="例子"></a>例子</h4><p>这里我们以湖湘杯的DSA为例，但是不能直接去做，，，因为发现在验证message4的时候签名不通过。源题目我没有了，。，，这里我以Jarvis OJ中经过修改的题目DSA为例</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2016湖湘杯DSA git:(master) ✗ openssl sha1 -verify dsa_public.pem -signature packet1/sign1.bin  packet1/message1  
Verified OK
➜  2016湖湘杯DSA git:(master) ✗ openssl sha1 -verify dsa_public.pem -signature packet2/sign2.bin  packet2/message1 
packet2/message1: No such file or directory
➜  2016湖湘杯DSA git:(master) ✗ openssl sha1 -verify dsa_public.pem -signature packet2/sign2.bin  packet2/message2 
Verified OK
➜  2016湖湘杯DSA git:(master) ✗ openssl sha1 -verify dsa_public.pem -signature packet3/sign3.bin  packet3/message3 
Verified OK
➜  2016湖湘杯DSA git:(master) ✗ openssl sha1 -verify dsa_public.pem -signature packet4/sign4.bin  packet4/message4
Verified OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出四则消息全部校验通过。这里之所以会联想到共享k是因为题目中提示了PS3的破解曾用到这个方法，从网上搜索可知该攻击。</p>
<p>下面，我们看一下签名后的值，这里使用的命令如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2016湖湘杯DSA git:(master) ✗ openssl asn1parse -inform der -in packet4/sign4.bin  
    0:d=0  hl=2 l=  44 cons: SEQUENCE          
    2:d=1  hl=2 l=  20 prim: INTEGER           :5090DA81FEDE048D706D80E0AC47701E5A9EF1CC
   24:d=1  hl=2 l=  20 prim: INTEGER           :5E10DED084203CCBCEC3356A2CA02FF318FD4123
➜  2016湖湘杯DSA git:(master) ✗ openssl asn1parse -inform der -in packet3/sign3.bin  
    0:d=0  hl=2 l=  44 cons: SEQUENCE          
    2:d=1  hl=2 l=  20 prim: INTEGER           :5090DA81FEDE048D706D80E0AC47701E5A9EF1CC
   24:d=1  hl=2 l=  20 prim: INTEGER           :30EB88E6A4BFB1B16728A974210AE4E41B42677D
➜  2016湖湘杯DSA git:(master) ✗ openssl asn1parse -inform der -in packet2/sign2.bin  
    0:d=0  hl=2 l=  44 cons: SEQUENCE          
    2:d=1  hl=2 l=  20 prim: INTEGER           :60B9F2A5BA689B802942D667ED5D1EED066C5A7F
   24:d=1  hl=2 l=  20 prim: INTEGER           :3DC8921BA26B514F4D991A85482750E0225A15B5
➜  2016湖湘杯DSA git:(master) ✗ openssl asn1parse -inform der -in packet1/sign1.bin  
    0:d=0  hl=2 l=  45 cons: SEQUENCE          
    2:d=1  hl=2 l=  21 prim: INTEGER           :8158B477C5AA033D650596E93653C730D26BA409
   25:d=1  hl=2 l=  20 prim: INTEGER           :165B9DD1C93230C31111E5A4E6EB5181F990F702
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，获取的第一个值是r，第二个值是s。可以看到第4个packet和第3个packet共享了k，因为他们的r一致。</p>
<p>这里我们可以使用openssl看下公钥</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2016湖湘杯DSA git:(master) ✗ openssl dsa -in dsa_public.pem -text -noout  -pubin 
read DSA key
pub: 
    45:bb:18:f6:0e:b0:51:f9:d4:82:18:df:8c:d9:56:
    33:0a:4f:f3:0a:f5:34:4f:6c:95:40:06:1d:53:83:
    29:2d:95:c4:df:c8:ac:26:ca:45:2e:17:0d:c7:9b:
    e1:5c:c6:15:9e:03:7b:cc:f5:64:ef:36:1c:18:c9:
    9e:8a:eb:0b:c1:ac:f9:c0:c3:5d:62:0d:60:bb:73:
    11:f1:cf:08:cf:bc:34:cc:aa:79:ef:1d:ad:8a:7a:
    6f:ac:ce:86:65:90:06:d4:fa:f0:57:71:68:57:ec:
    7c:a6:04:ad:e2:c3:d7:31:d6:d0:2f:93:31:98:d3:
    90:c3:ef:c3:f3:ff:04:6f
P:   
    00:c0:59:6c:3b:5e:93:3d:33:78:be:36:26:be:31:
    5e:e7:0c:a6:b5:b1:1a:51:9b:55:23:d4:0e:5b:a7:
    45:66:e2:2c:c8:8b:fe:c5:6a:ad:66:91:8b:9b:30:
    ad:28:13:88:f0:bb:c6:b8:02:6b:7c:80:26:e9:11:
    84:be:e0:c8:ad:10:cc:f2:96:be:cf:e5:05:05:38:
    3c:b4:a9:54:b3:7c:b5:88:67:2f:7c:09:57:b6:fd:
    f2:fa:05:38:fd:ad:83:93:4a:45:e4:f9:9d:38:de:
    57:c0:8a:24:d0:0d:1c:c5:d5:fb:db:73:29:1c:d1:
    0c:e7:57:68:90:b6:ba:08:9b
Q:   
    00:86:8f:78:b8:c8:50:0b:eb:f6:7a:58:e3:3c:1f:
    53:9d:35:70:d1:bd
G:   
    4c:d5:e6:b6:6a:6e:b7:e9:27:94:e3:61:1f:41:53:
    cb:11:af:5a:08:d9:d4:f8:a3:f2:50:03:72:91:ba:
    5f:ff:3c:29:a8:c3:7b:c4:ee:5f:98:ec:17:f4:18:
    bc:71:61:01:6c:94:c8:49:02:e4:00:3a:79:87:f0:
    d8:cf:6a:61:c1:3a:fd:56:73:ca:a5:fb:41:15:08:
    cd:b3:50:1b:df:f7:3e:74:79:25:f7:65:86:f4:07:
    9f:ea:12:09:8b:34:50:84:4a:2a:9e:5d:0a:99:bd:
    86:5e:05:70:d5:19:7d:f4:a1:c9:b8:01:8f:b9:9c:
    dc:e9:15:7b:98:50:01:79<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面，我们直接利用上面的原理编写程序即可，程序如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf8</span>
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> DSA
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha1
<span class="token keyword">import</span> gmpy2
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./dsa_public.pem'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    key <span class="token operator">=</span> DSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    y <span class="token operator">=</span> key<span class="token punctuation">.</span>y
    g <span class="token operator">=</span> key<span class="token punctuation">.</span>g
    p <span class="token operator">=</span> key<span class="token punctuation">.</span>p
    q <span class="token operator">=</span> key<span class="token punctuation">.</span>q
f3 <span class="token operator">=</span> open<span class="token punctuation">(</span>r<span class="token string">"packet3/message3"</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
f4 <span class="token operator">=</span> open<span class="token punctuation">(</span>r<span class="token string">"packet4/message4"</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
data3 <span class="token operator">=</span> f3<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
data4 <span class="token operator">=</span> f4<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
sha <span class="token operator">=</span> sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
sha<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data3<span class="token punctuation">)</span>
m3 <span class="token operator">=</span> int<span class="token punctuation">(</span>sha<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
sha <span class="token operator">=</span> sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
sha<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data4<span class="token punctuation">)</span>
m4 <span class="token operator">=</span> int<span class="token punctuation">(</span>sha<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> m3<span class="token punctuation">,</span> m4
s3 <span class="token operator">=</span> <span class="token number">0x30EB88E6A4BFB1B16728A974210AE4E41B42677D</span>
s4 <span class="token operator">=</span> <span class="token number">0x5E10DED084203CCBCEC3356A2CA02FF318FD4123</span>
r <span class="token operator">=</span> <span class="token number">0x5090DA81FEDE048D706D80E0AC47701E5A9EF1CC</span>
ds <span class="token operator">=</span> s4 <span class="token operator">-</span> s3
dm <span class="token operator">=</span> m4 <span class="token operator">-</span> m3
k <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>dm<span class="token punctuation">,</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>ds<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">)</span>
k <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>f_mod<span class="token punctuation">(</span>k<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
tmp <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>k<span class="token punctuation">,</span> s3<span class="token punctuation">)</span> <span class="token operator">-</span> m3
x <span class="token operator">=</span> tmp <span class="token operator">*</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>r<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
x <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>f_mod<span class="token punctuation">(</span>x<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
<span class="token keyword">print</span> int<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>我发现pip安装的pycrypto竟然没有DSA的importKey函数。。。只好从github上下载安装了pycrypto。。。</strong></p>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  2016湖湘杯DSA git:(master) ✗ python exp.py
1104884177962524221174509726811256177146235961550 943735132044536149000710760545778628181961840230
520793588153805320783422521615148687785086070744<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="攻击思想总结"><a href="#攻击思想总结" class="headerlink" title="攻击思想总结"></a>攻击思想总结</h1><h2 id="攻击模式"><a href="#攻击模式" class="headerlink" title="攻击模式"></a>攻击模式</h2><p>在我们攻击一个密码学系统时，我们或多或少会得到关于这个系统的一些信息。根据得到信息量的不同，我们可以采用的方法就可能不同。在当今的密码学分析时，一般我们都会假设攻击者知道密码学算法，这个假设是合理的，因为历史上有很多保密的算法最后都被人所知，比如 RC4。被知道的方式多重多样，比如间谍，逆向工程等。</p>
<p>这里我们根据攻击者获取密码学系统的信息的多少将攻击模式分为以下几类</p>
<ul>
<li><strong>唯密文攻击</strong>：攻击者仅能获得一些加密过的密文。</li>
<li><strong>已知明文攻击</strong>：攻击者有一些密文对应的明文。</li>
<li><strong>选择明文攻击</strong>：攻击者在开始攻击时可以选择一些明文，并获取加密后的密文。如果攻击者在攻击中途可以根据已经获取的信息选择新的明文并获取对应的密文，则称为适应性选择明文攻击。</li>
<li><strong>选择密文攻击</strong>：攻击者在开始攻击之前可以选择一些密文，并获取解密后的明文。如果攻击者在攻击图中可以根据已经获取的信息选择一些新的密文并获取对应的明文，则称为适应性选择密文攻击。</li>
<li><strong>相关密钥攻击</strong>：攻击者可以获得两个或多个相关密钥的加密或解密后的密文或明文。但是攻击者不知道这些密钥。</li>
</ul>
<h2 id="常见攻击方法"><a href="#常见攻击方法" class="headerlink" title="常见攻击方法"></a>常见攻击方法</h2><p>根据不同的攻击模式，可能会有不同的攻击方法，目前常见的攻击方法主要有</p>
<ul>
<li>暴力攻击</li>
<li>中间相遇攻击</li>
<li>线性分析</li>
<li>差分分析</li>
<li>不可能差分分析</li>
<li>积分分析</li>
<li>代数分析</li>
<li>相关密钥攻击</li>
<li>侧信道攻击</li>
</ul>
<h1 id="中间相遇攻击-MITM"><a href="#中间相遇攻击-MITM" class="headerlink" title="中间相遇攻击 - MITM"></a>中间相遇攻击 - MITM</h1><h2 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h2><p>中间相遇攻击是一种以空间换取时间的一种攻击方法，1977年由 Diffie 与 Hellman 提出。从个人角度看，者更多地指一种思想，不仅仅适用于密码学攻击，也适用于其他方面，可以降低算法的复杂度。</p>
<p>基本原理如下</p>
<p>假设 E 和 D 分别是加密函数和解密函数，k1 和 k2 分别是两次加密使用的密钥，则我们有</p>
<p>$C=E_{k_2}(E_{k_1}(P))$</p>
<p>$P=D_{k_2}(D_{k_1}(C))$</p>
<p>则我们可以推出</p>
<p>$E_{k_1}(P)=D_{k_2}(C)$</p>
<p>那么，当用户知道一对明文和密文时</p>
<ol>
<li>攻击者可以枚举所有的 k1，将 P 所有加密后的结果存储起来，并按照密文的大小进行排序。</li>
<li>攻击者进一步枚举所有的k2，将密文 C 进行解密得到 C1，在第一步加密后的结果中搜索 C1，如果搜索到，则我们在一定程度上可以认为我们找到了正确的 k1 和  k2。</li>
<li>如果觉得第二步中得到的结果不保险，则我们还可以再找一些明密文对进行验证。</li>
</ol>
<p>假设 k1 和 k2 的密钥长度都为 n，则原先我们暴力枚举需要 $O(n^2)$，现在我们只需要 $O(n log_2n)$。</p>
<p>这与 2DES 的中间相遇攻击类似。</p>
<h1 id="比特攻击"><a href="#比特攻击" class="headerlink" title="比特攻击"></a>比特攻击</h1><h2 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h2><p>简单地说，就是利用比特位之间的关系进行攻击。</p>
<h2 id="2018-Plaid-CTF-transducipher"><a href="#2018-Plaid-CTF-transducipher" class="headerlink" title="2018 Plaid CTF transducipher"></a>2018 Plaid CTF transducipher</h2><p>题目如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3.6</span>
<span class="token keyword">import</span> os

BLOCK_SIZE <span class="token operator">=</span> <span class="token number">64</span>

T <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">block2bin</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> length<span class="token operator">=</span>BLOCK_SIZE<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span>int<span class="token punctuation">,</span> bin<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">bin2block</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">transduce</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> b
    d<span class="token punctuation">,</span> t <span class="token operator">=</span> T<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
    b0<span class="token punctuation">,</span> bp <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>b0 <span class="token operator">^</span> t<span class="token punctuation">]</span> <span class="token operator">+</span> transduce<span class="token punctuation">(</span>bp<span class="token punctuation">,</span> s<span class="token operator">=</span>d<span class="token punctuation">[</span>b0<span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">transduceblock</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> bin2block<span class="token punctuation">(</span>transduce<span class="token punctuation">(</span>block2bin<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">swap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> BLOCK_SIZE <span class="token operator">//</span> <span class="token number">2</span>
    m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> l<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>b <span class="token operator">>></span> l<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> l<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Transducipher</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            k <span class="token operator">=</span> swap<span class="token punctuation">(</span>transduceblock<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>k<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            b <span class="token operator">^</span><span class="token operator">=</span> self<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            b <span class="token operator">=</span> transduceblock<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
            b <span class="token operator">=</span> swap<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token keyword">return</span> b


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    flag <span class="token operator">=</span> bytes<span class="token punctuation">.</span>hex<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    k <span class="token operator">=</span> int<span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    C <span class="token operator">=</span> Transducipher<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Your flag is PCTF{%s}"</span> <span class="token operator">%</span> flag<span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"data1.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pt <span class="token operator">=</span> int<span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>hex<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span>BLOCK_SIZE <span class="token operator">//</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
            ct <span class="token operator">=</span> C<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pt<span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>pt<span class="token punctuation">,</span> ct<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>题目给了 16 组明密文对</p>
<ul>
<li>明文大小 8 个字节</li>
<li>密文大小 8 个字节</li>
<li>密钥大小也是 8 个字节</li>
</ul>
<p>我们所需要求解的就是密钥。</p>
<p>可以看到这里主要有两种基本操作</p>
<ul>
<li>swap</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">swap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> BLOCK_SIZE <span class="token operator">//</span> <span class="token number">2</span>
    m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> l<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>b <span class="token operator">>></span> l<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> l<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>将给定的数据的高 32 位与低 32 位交换。</p>
<ul>
<li>transduce</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python">T <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">transduce</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> b
    d<span class="token punctuation">,</span> t <span class="token operator">=</span> T<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
    b0<span class="token punctuation">,</span> bp <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>b0 <span class="token operator">^</span> t<span class="token punctuation">]</span> <span class="token operator">+</span> transduce<span class="token punctuation">(</span>bp<span class="token punctuation">,</span> s<span class="token operator">=</span>d<span class="token punctuation">[</span>b0<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，</p>
<ul>
<li>b 是一个 01 数组，初始时刻大小为 64。</li>
<li>s 是一个下标。</li>
</ul>
<p>基本流程如下</p>
<ol>
<li>根据 s 选择使用 T 的哪个元素，进而将其分为 d 和 t。</li>
<li>将 b 分为两部分，一部分只包含头元素，另一部分包含其它的元素。</li>
<li>将头元素与 t 异或作为当前的头元素，然后继续转换剩下的部分。</li>
</ol>
<p>其实我们可以将该函数转换为迭代函数</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">transduce_iter</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> b<span class="token punctuation">:</span>
        d<span class="token punctuation">,</span> t <span class="token operator">=</span> T<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
        ans <span class="token operator">+=</span> <span class="token punctuation">[</span>c <span class="token operator">^</span> t<span class="token punctuation">]</span>
        s <span class="token operator">=</span> d<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
    <span class="token keyword">return</span> ans<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进而由于每次处理的是列表的第一个元素，其实该函数是可逆的，如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">invtransduce</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> b
    d<span class="token punctuation">,</span> t <span class="token operator">=</span> T<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
    b0<span class="token punctuation">,</span> bp <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>b0 <span class="token operator">^</span> t<span class="token punctuation">]</span> <span class="token operator">+</span> transduce<span class="token punctuation">(</span>bp<span class="token punctuation">,</span> s<span class="token operator">=</span>d<span class="token punctuation">[</span>b0 <span class="token operator">^</span> t<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面分析程序的核心流程，首先是生成密钥部分，该加密算法生成了 6 个密钥，每次生成的方法</p>
<ol>
<li>transduce 先前的密钥得到中间值 t</li>
<li>对 t 进行 swap</li>
<li>连续迭代 5 次</li>
</ol>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>k <span class="token operator">=</span> <span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            k <span class="token operator">=</span> swap<span class="token punctuation">(</span>transduceblock<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>k<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加密算法如下，一共迭代 6 轮，基本流程</p>
<ol>
<li>异或密钥 transduce</li>
<li>交换</li>
</ol>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            b <span class="token operator">^</span><span class="token operator">=</span> self<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            b <span class="token operator">=</span> transduceblock<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
            b <span class="token operator">=</span> swap<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token keyword">return</span> b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过分析程序，可知该加密算法是一个块加密，基本信息如下</p>
<ul>
<li>块大小为 8 个字节</li>
<li>轮数为 6 轮</li>
<li>加密算法的每轮的基本操作为 transduce 和 swap。</li>
<li>密钥的扩展也是与 transduce 和 swap 相关。</li>
</ul>
<p>更具体的</p>
<ol>
<li>swap 是将 8 字节的高 32 位与低 32 位进行调换。</li>
<li>transduce 是对于 8 字节的每个比特，逐比特与某个值进行异或。这个值与 T 有关。</li>
</ol>
<p>通过进一步地分析，我们可以发现这两个函数都是可逆的。也就是说，如果我们知道了最后的密文，那么我们其实可以将原来的轮数缩短为差不多 5 轮，因为最后一轮的 <code>transduce</code> 和<code>swap</code> 没有作用了。</p>
<p>我们可以定义如下变量</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>$k_{i,0}$</td>
<td>第 i 轮使用的密钥的高 32 位</td>
</tr>
<tr>
<td>$k_{i,1}$</td>
<td>第 i 轮使用的密钥的低 32 位</td>
</tr>
<tr>
<td>$d_{i,0}$</td>
<td>第 i 轮使用的输入的高 32 位</td>
</tr>
<tr>
<td>$d_{i,1}$</td>
<td>第 i 轮使用的输入的低 32 位</td>
</tr>
</tbody></table>
<p>由于其中有一个核心操作是 swap，只会操纵高或低 32 位，所以我们可以分为两部分考虑。简化定义如下</p>
<ul>
<li>Transduce 简化为 T，这里虽然与源代码里冲突，不过我们可以暂时理解一下。</li>
<li>Swap 简化为 S。</li>
</ul>
<p>则每一轮的明密文，密钥如下</p>
<table>
<thead>
<tr>
<th>轮数</th>
<th>左侧密钥</th>
<th>左侧密文</th>
<th>右侧密钥</th>
<th>右侧密文</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>$k_{0,0}$</td>
<td>$d_{1,0}=T(k_{0,1} \oplus d_{0,1} ,s)$</td>
<td>$k_{0,1}$</td>
<td>$d_{1,1}=T(k_{0,0} \oplus d_{0,0})$</td>
</tr>
<tr>
<td>1</td>
<td>$k_{1,0}=T(k_{0,1},s)$</td>
<td>$d_{2,0}=T(k_{1,1} \oplus d_{1,1} ,s)$</td>
<td>$k_{1,1}=T(k_{0,0})$</td>
<td>$d_{2,1}=T(k_{1,0} \oplus d_{1,0})$</td>
</tr>
<tr>
<td>2</td>
<td>$k_{2,0}=T(k_{1,1},s)$</td>
<td>$d_{3,0}=T(k_{2,1} \oplus d_{2,1} ,s)$</td>
<td>$k_{2,1}=T(k_{1,0})$</td>
<td>$d_{3,1}=T(k_{2,0} \oplus d_{2,0})$</td>
</tr>
<tr>
<td>3</td>
<td>$k_{3,0}=T(k_{2,1},s)$</td>
<td>$d_{4,0}=T(k_{3,1} \oplus d_{3,1} ,s)$</td>
<td>$k_{3,1}=T(k_{2,0})$</td>
<td>$d_{4,1}=T(k_{3,0} \oplus d_{3,0})$</td>
</tr>
<tr>
<td>4</td>
<td>$k_{4,0}=T(k_{3,1},s)$</td>
<td>$d_{5,0}=T(k_{4,1} \oplus d_{4,1} ,s)$</td>
<td>$k_{4,1}=T(k_{3,0})$</td>
<td>$d_{5,1}=T(k_{4,0} \oplus d_{4,0})$</td>
</tr>
<tr>
<td>5</td>
<td>$k_{5,0}=T(k_{4,1},s)$</td>
<td>$d_{6,0}=T(k_{5,1} \oplus d_{5,1} ,s)$</td>
<td>$k_{5,1}=T(k_{4,0})$</td>
<td>$d_{6,1}=T(k_{5,0} \oplus d_{5,0})$</td>
</tr>
</tbody></table>
<p>那么，我们可以逐比特位枚举 k 的高 32 位，同时枚举在进行 T 操作时的可能的 s 状态位，这样就可以获取高 32 位密钥。在进行逐位爆破之后，我们可以从获取两个可能结果</p>
<pre><code>[2659900894, 2659900895]</code></pre><p>再根据左边的结果，可以去获取右边可能的结果，利用 2659900894 获取的可能的结果如下</p>
<pre><code># 第一组明密文对对应的密钥可能太多。
# 第二组一共 6 个。
[2764038144, 2764038145, 2764038152, 2764038153, 2764038154, 2764038155]
# 第三组
[2764038144, 2764038145]</code></pre><p>然后其实我们就可以手工试一下加密所有的明密文，如果不对，就直接判断错误即可了。这样其实可以很快可以过滤。最后可以发现密钥是</p>
<pre><code>2659900894|2764038145</code></pre><p>也就是11424187353095200769。也就拿到了 flag。</p>
<p>当然，本题目也可以使用中间相遇的攻击方法，也就是说分别枚举第 0 轮使用的密钥和最后一轮使用的密钥使其在第三轮相遇产生碰撞。</p>
<h1 id="证书格式"><a href="#证书格式" class="headerlink" title="证书格式"></a>证书格式</h1><h2 id="PEM"><a href="#PEM" class="headerlink" title="PEM"></a>PEM</h2><p>PEM 以 <code>-----BEGIN</code> 开头，以 <code>-----END</code> 结尾，中间包含 ASN.1 格式的数据。ASN.1 是经过 base64 转码的二进制数据。<a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail" target="_blank" rel="noopener">Wikipedia</a> 上有完整 PEM 文件的例子。</p>
<p>用 Python 3 和 PyCryptodome 库可以与 PEM 文件交互并提取相关数据。例如我们想提取出模数 <code>n</code>：</p>
<pre><code>#!/usr/bin/env python3
from Crypto.PublicKey import RSA

with open("certificate.pem","r") as f:
    key = RSA.import_key(f.read())
    print(key.n)</code></pre><h2 id="DER"><a href="#DER" class="headerlink" title="DER"></a>DER</h2><p>DER 是 ASN.1 类型的二进制编码。后缀 <code>.cer</code> 或 <code>.crt</code> 的证书通常包含 DER 格式的数据，但 Windows 也可能会接受 PEM 格式的数据。</p>
<p>我们可以用 <code>openssl</code> 将 PEM 文件转化为 DER 文件：</p>
<pre><code>openssl x509 -inform DER -in certificate.der &gt; certificate.pem</code></pre><p>现在问题被简化成了如何读取 PEM 文件，所以我们可以重复使用上一小节中的 Python 代码。</p>
<h2 id="其他格式转换"><a href="#其他格式转换" class="headerlink" title="其他格式转换"></a>其他格式转换</h2><pre><code>openssl x509 -outform der -in certificate.pem -out certificate.der
openssl x509 -inform der -in certificate.cer -out certificate.pem</code></pre><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/ctf-crypto.html">https://jackhcc.github.io/posts/ctf-crypto.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF-Cryptography/">
                                    <span class="chip bg-color">CTF-Cryptography</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-08-15T23-23-13',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/bert.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/2.jpg" class="responsive-img" alt="Bert详解">
                        
                        <span class="card-title">Bert详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Bert学习记录
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/NLP/">
                        <span class="chip bg-color">NLP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/paper-bcsd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/12.jpg" class="responsive-img" alt="Binary Code Similarity Detection">
                        
                        <span class="card-title">Binary Code Similarity Detection</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            二进制代码相似性论文解读复现
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Paper/" class="post-category">
                                    Paper
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BCSD/">
                        <span class="chip bg-color">BCSD</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>


    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

