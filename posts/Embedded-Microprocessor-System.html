<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Embedded Microprocessor System笔记, JackHCC">
    <meta name="description" content="嵌入式微处理系统学习笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Embedded Microprocessor System笔记 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'todo';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Embedded Microprocessor System笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Microprocessor/">
                                <span class="chip bg-color">Microprocessor</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Embedded/" class="post-category">
                                Embedded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-09-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-12-18
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    38 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>👉网页版：<a href="https://blog.creativecc.cn/posts/Embedded-Microprocessor-System.html" target="_blank" rel="noopener">嵌入式知识点与笔记</a></p>
<h1 id="微处理器程序开发基础"><a href="#微处理器程序开发基础" class="headerlink" title="微处理器程序开发基础"></a>微处理器程序开发基础</h1><h2 id="程序开发过程与工具"><a href="#程序开发过程与工具" class="headerlink" title="程序开发过程与工具"></a>程序开发过程与工具</h2><p>处理器计算 a=b+c 的过程？</p>
<p>可执行代码是什么形式？如何产生的？</p>
<h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a><strong>指令</strong></h3><p><strong>形式</strong></p>
<p>机器语言：由CPU理解和执行的二进制代码</p>
<p>机器指令的格式（助记符）</p>
<p><img src="/images/loading.gif" data-original="../images/ML/image-20210926184409479.png" alt=""></p>
<h3 id="执行代码生成"><a href="#执行代码生成" class="headerlink" title="执行代码生成"></a><strong>执行代码生成</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926184506519.png" alt=""></p>
<h3 id="开发过程"><a href="#开发过程" class="headerlink" title="开发过程"></a><strong>开发过程</strong></h3><p><strong>PC程序开发</strong></p>
<p>编辑    编译    汇编    连接    调试</p>
<p><strong>嵌入式程序开发</strong></p>
<p>编辑    编译    汇编    连接    下载    调试</p>
<p><strong>如何下载程序？</strong></p>
<h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a><strong>开发工具</strong></h3><p><strong>集成开发环境</strong></p>
<ul>
<li><p>Keil MDK（<a href="http://www.arm.com/" target="_blank" rel="noopener">www.arm.com</a>）</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926184939724.png" alt=""></p>
</li>
<li><p>Arm Development Studio（DS-5）（<a href="http://www.arm.com/" target="_blank" rel="noopener">www.arm.com</a>）</p>
</li>
<li><p>Segger for Arm （<a href="http://www.segger.com/" target="_blank" rel="noopener">www.segger.com</a>）</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926184955365.png" alt=""></p>
</li>
</ul>
<p><strong>调试环境</strong></p>
<ul>
<li>物理处理器和开发板(Emulator)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185044913.png" alt=""></p>
<p><strong>没有开发板可以调试程序吗？</strong></p>
<ul>
<li>模拟处理器(Simulator)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185121855.png" alt=""></p>
<p><strong>目标处理器如何加载程序？</strong></p>
<ul>
<li><p><strong>目标地址</strong></p>
<ul>
<li>Linker-分配</li>
<li>Debugger-指定</li>
</ul>
</li>
<li><p><strong>加载方式</strong></p>
<ul>
<li>Debugger-下载</li>
<li>实际系统-ROM</li>
</ul>
</li>
<li><p><strong>启动方式</strong></p>
<ul>
<li>初始化<ul>
<li>Debugger-程序/Set</li>
<li>实际系统-程序</li>
</ul>
</li>
<li>程序入口<ul>
<li>Debugger-跳转/Set PC</li>
<li>实际系统 –跳转</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>还熟悉哪些处理器程序开发环境？</p>
<h2 id="处理器与程序"><a href="#处理器与程序" class="headerlink" title="处理器与程序"></a><strong>处理器与程序</strong></h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a><strong>问题</strong></h3><p><strong>处理器如何执行程序？</strong></p>
<h3 id="计算机系统"><a href="#计算机系统" class="headerlink" title="计算机系统"></a><strong>计算机系统</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926185459145.png" alt=""></p>
<h3 id="CPU内核"><a href="#CPU内核" class="headerlink" title="CPU内核"></a>CPU内核</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926185523421.png" alt=""></p>
<h3 id="CPU性能"><a href="#CPU性能" class="headerlink" title="CPU性能"></a>CPU性能</h3><ul>
<li>CPI-执行一条指令所需的平均时钟周期</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185613261.png" alt=""></p>
<ul>
<li>MIPS-每秒百万条指令</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185650498.png" alt=""></p>
<ul>
<li>MFLOPS-每秒百万次浮点运算次数</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185719089.png" alt=""></p>
<h3 id="执行时间"><a href="#执行时间" class="headerlink" title="执行时间"></a><strong>执行时间</strong></h3><p><strong>指令执行过程</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926185812967.png" alt=""></p>
<p>取指（IF）-&gt;译码 （ID） -&gt;执行（IE） -&gt;写回（WB）</p>
<p><strong>指令执行时间</strong></p>
<img src="/images/loading.gif" data-original="../images/development/image-20210926185912076.png" style="zoom:50%;">

<p><strong>程序执行时间</strong></p>
<img src="/images/loading.gif" data-original="../images/development/image-20210926185926141.png" style="zoom:33%;">

<p><strong>影响处理器程序运行速度的因素有哪些？</strong></p>
<h3 id="结构与性能"><a href="#结构与性能" class="headerlink" title="结构与性能"></a><strong>结构与性能</strong></h3><p><strong>总线结构</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926190257568.png" alt=""></p>
<p><strong>哪种结构的处理器速度更快？ 为什么？</strong></p>
<p><strong>处理器字长（ALU 及通用数据寄存器）</strong></p>
<ul>
<li><p><strong>8</strong> <strong>bits</strong>：<strong>8008, 89C51</strong></p>
</li>
<li><p><strong>16 bits</strong>：<strong>8086, Ti 54X</strong></p>
</li>
<li><p><strong>32 bits</strong>：<strong>80486, Ti C3X, C6X</strong>，<strong>ARM V3-6</strong></p>
</li>
<li><p><strong>64 bits</strong>：<strong>Itanium，PowerPC</strong> <strong>970, ARM V8</strong></p>
</li>
<li><p><strong>128 bits?</strong></p>
</li>
</ul>
<p>8位处理器可以通过程序进行32位数值运算吗？</p>
<p>如何用C语言编程实现？</p>
<p><strong>流水线</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926190543037.png" alt=""></p>
<ul>
<li>执行时间（n条指令）</li>
</ul>
<img src="/images/loading.gif" data-original="../images/development/image-20210926190608163.png" style="zoom:50%;">

<p><strong>影响流水线加速效果的因素？</strong></p>
<p><strong>能否通过程序验证处理器是否采用了流水线？</strong></p>
<p><strong>Cache</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926190658439.png" alt=""></p>
<p>程序可以直接访问Cache中指定的数据单元？</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926190736193.png" alt=""></p>
<p>Cache 的容量对大小对加速性能的影响？</p>
<p>能否通过程序验证处理器中Cache是否工作？</p>
<p><strong>Write buffer</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926190828810.png" alt=""></p>
<p>Write buffer 与 Cache的区别？</p>
<p><strong>指令执行过程中如何访问的数据？</strong></p>
<h3 id="寻址"><a href="#寻址" class="headerlink" title="寻址"></a><strong>寻址</strong></h3><p><strong>定义</strong>：<strong>执行单元获取数据（地址）的方式</strong></p>
<p><strong>编址单元宽度</strong></p>
<ul>
<li><p>字节（8bit，0x86，ARM<strong>）</strong></p>
</li>
<li><p>半字 （C54）</p>
</li>
<li><p>字 （C30）</p>
</li>
<li><p>双字</p>
</li>
</ul>
<p><strong>地址空间（独立编址）</strong></p>
<ul>
<li><p><strong>三个地址空间</strong></p>
<ul>
<li>通用寄存器</li>
<li>主存储器</li>
<li>I/O设备</li>
</ul>
</li>
<li><p><strong>两个地址空间</strong></p>
<ul>
<li>通用寄存器</li>
<li>主存储器与IO设备</li>
</ul>
</li>
<li><p><strong>一个地址空间</strong></p>
<ul>
<li>所有存储设备统一编址</li>
</ul>
</li>
</ul>
<p><strong>如果有多个地址空间，在程序中如何区分？</strong></p>
<p><strong>方式</strong></p>
<ul>
<li><strong>立即数寻址</strong></li>
</ul>
<p>ADD R4，#5 ；  reg（R4）〈- reg（R4）+5</p>
<ul>
<li><strong>寄存器寻址</strong></li>
</ul>
<p>ADD R4，R3 ； reg（R4）〈- reg（R4）+reg（R3）</p>
<ul>
<li><p><strong>直接寻址（绝对）</strong> </p>
<p>ADD R1，（1001）； reg（R1）〈- reg（R1）+ Mem（1001）</p>
</li>
</ul>
<p>注：1001是内存的地址，取出该地址对应的值</p>
<ul>
<li><strong>堆栈寻址</strong> </li>
</ul>
<p>PUSH R1</p>
<p>POP R1</p>
<p>注：堆栈操作的对象与内存有关</p>
<p><strong>隐含了什么地址？</strong></p>
<ul>
<li><p><strong>间接寻址</strong></p>
<ul>
<li><p>寄存器间接寻址  ADD R4，（R1）；reg（R4）〈- reg（R4）+ Mem（reg（R1））；</p>
<p>注：R1寄存器的数值对应为内存中的地址，取内存中该地址的数据（R1）</p>
</li>
<li><p>存储器间接寻址 ADD R1，@(R2)； reg（R1）〈- reg（R1）+ Mem[Mem[reg（R2）]]</p>
<p>注：R2寄存器数值对应为内存中的地址，改地址对应的数值所对应的地址，取内存中该地址的数据@（R2）</p>
</li>
</ul>
</li>
<li><p><strong>自动递增寻址</strong></p>
</li>
</ul>
<p>ADD R1，（R2）++ ；Reg(R1) 〈- reg（R4）+ Mem（reg(R2) ）; R2+1</p>
<ul>
<li><strong>自动递减寻址</strong></li>
</ul>
<p>ADD R1，- -（R2）；   R2-1 ; Reg(R1) 〈- reg（R1）+ Mem（reg(R2) ）</p>
<p>注：自动递增递减会改变所操作寄存器的值</p>
<ul>
<li><strong>偏移量寻址</strong></li>
</ul>
<p>ADD R4，±100（R1） ； reg（R4）〈- reg（R4）+  Mem（reg(R1) ± 100）</p>
<p>注：偏移量寻址不会改变所操作寄存器的值</p>
<p><strong>处理器如何处理异常（外部）事件？</strong></p>
<h3 id="事件响应"><a href="#事件响应" class="headerlink" title="事件响应"></a><strong>事件响应</strong></h3><p><strong>事件响应过程</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926195652510.png" alt=""></p>
<p><strong>检测事件？进入事件处理程序？</strong></p>
<p><strong>中断（interrupt）</strong></p>
<p><strong>定义</strong>：<strong>为导致程序正常执行流程发生改变的事件（不包括程序的分支情况）</strong></p>
<p><strong>来源</strong></p>
<ul>
<li><p><strong>外中断</strong>：由于CPU 外部的原因而改变程序执行流程的过程，属于异步事件，又称为硬件中断</p>
</li>
<li><p><strong>内中断</strong>：</p>
<ul>
<li>自陷（软中断，trap）：通过处理器所拥有的软件指令、可预期地使处理器正在执行的程序的执行流程发生变化，以执行特定的程序</li>
<li>异常：异常为CPU 自动产生的自陷（除0，非法指令，内存保护错误）</li>
</ul>
</li>
</ul>
<p><strong>可屏蔽性</strong></p>
<ul>
<li><p><strong>可屏蔽中断</strong></p>
<ul>
<li>能够被屏蔽掉的中断称为可屏蔽中断。</li>
<li>一般需要先通过CPU外部的中断控制器，再与CPU相应的引脚相连。</li>
</ul>
</li>
<li><p><strong>不可屏蔽中断</strong></p>
<ul>
<li>不能够被屏蔽掉的中断称为可屏蔽中断</li>
<li>例：复位（Reset）</li>
</ul>
</li>
</ul>
<p><strong>中断向量表</strong></p>
<ul>
<li><strong>中断向量与中断服务程序入口的对照表</strong></li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926200456886.png" alt=""></p>
<p><strong>支持多任务（多程序）的操作系统，如何为不同的任务分配存储空间？</strong></p>
<p><strong>虚拟地址 VS 物理地址？</strong></p>
<h3 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a><strong>内存映射</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926200633258.png" alt=""></p>
<ul>
<li><strong>地址转换</strong></li>
<li><strong>空间保护</strong></li>
</ul>
<p><strong>程序中如何实现地址转换？</strong></p>
<p><strong>上电后处理器是如何启动boot 程序？</strong></p>
<h3 id="系统启动"><a href="#系统启动" class="headerlink" title="系统启动"></a><strong>系统启动</strong></h3><p><strong>处理器启动</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926200802425.png" alt=""></p>
<p><strong>条件？</strong></p>
<ul>
<li><p>Memory（ROM） 可执行程序（指令）</p>
</li>
<li><p>PC指到程序入口</p>
</li>
</ul>
<h2 id="处理器系统"><a href="#处理器系统" class="headerlink" title="处理器系统"></a><strong>处理器系统</strong></h2><p>你知道哪些CPU？具体型号？</p>
<h3 id="CPU要满足系统需求"><a href="#CPU要满足系统需求" class="headerlink" title="CPU要满足系统需求"></a>CPU要满足系统需求</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926201116512.png" alt=""></p>
<h3 id="系统需求"><a href="#系统需求" class="headerlink" title="系统需求"></a><strong>系统需求</strong></h3><p><strong>资源</strong></p>
<ul>
<li><p>片内 (MCU, DSP, SoC)</p>
<ul>
<li>RAM，ROM，Programmable ROM<ul>
<li>DATA</li>
<li>INSTRUCTION</li>
</ul>
</li>
</ul>
</li>
<li><p>片外可扩展 (DSP, MPU)</p>
<ul>
<li>MEMORY<ul>
<li>DATA</li>
<li>INSTRUCTION</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>接口</strong></p>
<ul>
<li>IO 控制（GPIO）</li>
<li>通信（UART， Ether NET ，USB）</li>
<li>外设 （A/D，D/A，LCD，KEYBOARD，Video）</li>
</ul>
<p><strong>封装（尺寸, 工艺）</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202001957.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202050871.png" alt=""></p>
<h3 id="嵌入式系统需求"><a href="#嵌入式系统需求" class="headerlink" title="嵌入式系统需求"></a><strong>嵌入式系统需求</strong></h3><ul>
<li><p>功率低</p>
<p>设想一下，普通手机电池能够维持P4（75W）工作多长时间？</p>
<p>移动领域 X86 败于 ARM </p>
</li>
<li><p>稳定性好</p>
<p>卫星上的系统出错后如何复位？</p>
</li>
<li><p>体积小</p>
<p> PC中的处理器有多大？</p>
</li>
<li><p>成本低</p>
<p>最便宜的处理器价格？</p>
</li>
</ul>
<h3 id="嵌入式处理器"><a href="#嵌入式处理器" class="headerlink" title="嵌入式处理器"></a><strong>嵌入式处理器</strong></h3><p>嵌入式处理器？-满足嵌入式系统需求</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202343113.png" alt=""></p>
<p>AI芯片属于哪一类？</p>
<p><strong>嵌入式系统微处理器的发展</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202425634.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202532721.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202545339.png" alt=""></p>
<p><strong>What is next to ARM?</strong></p>
<h2 id="处理器发展"><a href="#处理器发展" class="headerlink" title="处理器发展"></a><strong>处理器发展</strong></h2><p><strong>微处理器结构上的第一</strong></p>
<p>First Computer ENIAC (University of Pennsylvania,46)</p>
<p>First general-purpose,single-chip microprocessor:Intel 4004,1971</p>
<p>First 8-bit architecture:Intel 8008,1972</p>
<p>First 16-bit architecture:Intel 8080,1974</p>
<p>First 32-bit architecture:Motorola 68000,1979</p>
<p>First RISC microprocessor: MIPS R2000, 1985</p>
<p>First microprocessor to provide integrated support for instruction &amp; data cache: MIPS R2000, 1985</p>
<p>First pipelined microprocessor (sustains 1 instruction/clock): MIPS R2000, 1985</p>
<p>First 64-bit architecture: MIPS R4000, 1991</p>
<p>First multiple issue（superscalar) microprocessor: Intel i860, 1991</p>
<p>First CMP processor: IBM Power 4,2001</p>
<p>First SMT processor: Intel Pentium IV Xeon,2003</p>
<p><strong>提高运行速度</strong></p>
<ul>
<li><p>提高主频</p>
</li>
<li><p>提高存储器速度</p>
</li>
<li><p>改进处理器结构-并行化/存储管理</p>
<ul>
<li>数据</li>
<li>步骤-&gt;pipe line</li>
<li>指令-&gt;Superscale</li>
<li>内核-&gt;Multicore</li>
<li>访存-&gt;Cache &amp;Write buffer</li>
</ul>
</li>
<li><p>降低能耗</p>
</li>
</ul>
<h3 id="并行化"><a href="#并行化" class="headerlink" title="并行化"></a><strong>并行化</strong></h3><p><strong>超流水线和超标量</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202824719.png" alt=""></p>
<p><strong>矢量计算？</strong></p>
<p><strong>多核</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202854014.png" alt=""></p>
<p><strong>比较两款处理器功耗</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926202912842.png" alt=""></p>
<p>Intel处理器败走移动领域的主要因素？</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a><strong>小结</strong></h2><ul>
<li><p><strong>处理器程序开发过程。</strong></p>
</li>
<li><p><strong>处理器结构提对程序执行速度影响。</strong></p>
</li>
<li><p><strong>嵌入式处理器特点。</strong></p>
</li>
</ul>
<h1 id="ARM-处理器"><a href="#ARM-处理器" class="headerlink" title="ARM 处理器"></a>ARM 处理器</h1><h2 id="例程：c-a-b"><a href="#例程：c-a-b" class="headerlink" title="例程：c=a+b"></a>例程：c=a+b</h2><p><img src="/images/loading.gif" data-original="../images/development/image-20210926203252890.png" alt=""></p>
<p><strong>观察寄存器</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926203323853.png" alt=""></p>
<p>va, vb, vc 地址？</p>
<p><strong>小端/大端？</strong></p>
<p>查看内存数值？</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926203452326.png" alt=""></p>
<p><strong>C=？</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926203533295.png" alt=""></p>
<p>R15？</p>
<h3 id="Option"><a href="#Option" class="headerlink" title="Option"></a><strong>Option</strong></h3><h4 id="Device"><a href="#Device" class="headerlink" title="Device"></a><strong>Device</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926203617534.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926203927530.png" alt=""></p>
<h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204025296.png" alt=""></p>
<h4 id="Output"><a href="#Output" class="headerlink" title="Output"></a><strong>Output</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204056926.png" alt=""></p>
<h4 id="Listing"><a href="#Listing" class="headerlink" title="Listing"></a><strong>Listing</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204145002.png" alt=""></p>
<h4 id="User"><a href="#User" class="headerlink" title="User"></a><strong>User</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204229124.png" alt=""></p>
<h4 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204307711.png" alt=""></p>
<h4 id="Asm"><a href="#Asm" class="headerlink" title="Asm"></a><strong>Asm</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204445454.png" alt=""></p>
<h4 id="Linker"><a href="#Linker" class="headerlink" title="Linker"></a><strong>Linker</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204509770.png" alt=""></p>
<h4 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a><strong>Debug</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204735885.png" alt=""></p>
<h4 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a><strong>Utilities</strong></h4><p><img src="/images/loading.gif" data-original="../images/development/image-20210926204807368.png" alt=""></p>
<h3 id="aplusb-ini"><a href="#aplusb-ini" class="headerlink" title="aplusb.ini"></a><strong>aplusb.ini</strong></h3><p><strong>去掉该文件重新调试，什么现象？</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205434772.png" alt=""></p>
<h3 id="aplusb-lst-armasm"><a href="#aplusb-lst-armasm" class="headerlink" title="aplusb.lst (armasm)"></a>aplusb.lst (armasm)</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926205451710.png" alt=""></p>
<h3 id="aplusb-map"><a href="#aplusb-map" class="headerlink" title="aplusb.map"></a>aplusb.map</h3><p><strong>Memory Map</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205553729.png" alt=""></p>
<p><strong>Size</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205758227.png" alt=""></p>
<h2 id="ARM9内核"><a href="#ARM9内核" class="headerlink" title="ARM9内核"></a>ARM9内核</h2><h3 id="内核结构"><a href="#内核结构" class="headerlink" title="内核结构"></a><strong>内核结构</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20210926205834349.png" alt=""></p>
<p><strong>桶形移位器</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205904206.png" alt=""></p>
<p><strong>调试程序，观察加运算前后处理器状态</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205937537.png" alt=""></p>
<p><strong>CPSR</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926205949259.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210003316.png" alt=""></p>
<p><strong>ALU</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210038934.png" alt=""></p>
<p><strong>特点</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210053378.png" alt=""></p>
<h2 id="异常与模式"><a href="#异常与模式" class="headerlink" title="异常与模式"></a>异常与模式</h2><h3 id="异常与模式-1"><a href="#异常与模式-1" class="headerlink" title="异常与模式"></a>异常与模式</h3><p><strong>调试程序，在nop处单步执行，观察pc的变化</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210148714.png" alt=""></p>
<p><strong>异常向量</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210159430.png" alt=""></p>
<p><strong>异常模式</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210242247.png" alt=""></p>
<p><strong>寄存器</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210302495.png" alt=""></p>
<p><strong>处理器异常处理</strong></p>
<ul>
<li>处理过程</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210321382.png" alt=""></p>
<p><strong>处理器处理过程不需要用程序实现吗！</strong></p>
<p><strong>如何恢复到异常发生前的状态？</strong></p>
<ul>
<li>复位(reset)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210413298.png" alt=""></p>
<ul>
<li>中断(irq) (fiq?)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210436785.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210442517.png" alt=""></p>
<ul>
<li>数据终止(abort)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210508796.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210516163.png" alt=""></p>
<ul>
<li>指令终止(undefined)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210533321.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210538959.png" alt=""></p>
<h2 id="存储系统"><a href="#存储系统" class="headerlink" title="存储系统"></a>存储系统</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a><strong>结构</strong></h3><p>按字节编址！</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20210926210617538.png" alt=""></p>
<p>TCM与Cache 的区别？</p>
<p><img src="/images/loading.gif" data-original="../images/ML/image-20211014221932255.png" alt=""></p>
<h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014222042315.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222052356.png" alt=""></p>
<h3 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h3><p><strong>ARM9的三类地址</strong>：</p>
<ul>
<li><p>虚拟地址（VA），是程序中的逻辑地址，0x00000000~0xFFFFFFFF。</p>
</li>
<li><p>改进的虚拟地址（MVA），由于多个进程执行，逻辑地址会重合。所以，跟据进程号将逻辑地址分布到整个内存中。MVA = (PID &lt;&lt; 25) | VA。PID占7位，所以最多只能有 128 个进程，每个进程只能分到 32MB 的逻辑地址空间。</p>
</li>
<li><p>物理地址（PA），MVA通过MMU转换后的地址。</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222149466.png" alt=""></p>
<p><strong>协处理器CP15</strong> </p>
<ul>
<li><p>内存管理单元(Memory Manage Unit，MMU)</p>
<ul>
<li>控制虚拟地址（VA）映射到物理地址（PA）</li>
<li>控制内存的访问权限</li>
<li>控制可缓存性和缓冲性</li>
</ul>
</li>
<li><p>内存保护单元(Protection Unit，PU)</p>
<ul>
<li>无MMU的简单内存保护</li>
</ul>
</li>
<li><p>使能Cache and Write Buffer</p>
</li>
<li><p>快速上下文(进程之间)切换扩展(Fast Context Switch Extension，FCSE)</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222312479.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222335760.png" alt=""></p>
<p><strong>段（section, 1MB）地址转换</strong></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222420960.png" alt=""></p>
<p><strong>内核扩展协处理器</strong></p>
<ul>
<li><p>协处理器接口，允许扩展16个协处理器</p>
</li>
<li><p>协处理器扩展（FFA10）</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222456230.png" alt=""></p>
<p>处理器如何访问协处理器？</p>
<h2 id="ARM发展历程"><a href="#ARM发展历程" class="headerlink" title="ARM发展历程"></a>ARM发展历程</h2><h3 id="ARM-Advanced-RISC-Machine"><a href="#ARM-Advanced-RISC-Machine" class="headerlink" title="ARM- Advanced RISC Machine"></a>ARM- Advanced RISC Machine</h3><ul>
<li><p>ARM的版本</p>
<ul>
<li>V1, V2, V3,</li>
<li>V4 (ARM 7，8，9),</li>
<li>V5 (ARM 10),</li>
<li>V6 (ARM 11)</li>
<li>V7(ARM-Cortex A8,9,15,17)</li>
<li>V8(Cortex-A/R/M/, 64/32bit)</li>
<li>V9</li>
</ul>
</li>
<li><p>扩展字母含义</p>
<ul>
<li>T:内含16位压缩指令集 Thumb</li>
<li>D:支持片内Debug调试</li>
<li>M:采用增强型乘法器（Multiplier)</li>
<li>I: 内含嵌入式ICE宏单元</li>
<li>E: 具有DSP功能</li>
<li>S:可综合的软核Software</li>
<li>J: Jazeller,允许直接执行Java字节码</li>
</ul>
</li>
</ul>
<h3 id="产品线"><a href="#产品线" class="headerlink" title="产品线"></a>产品线</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014222644267.png" alt=""></p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a><strong>架构</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014222702025.png" alt=""></p>
<ul>
<li>指令</li>
</ul>
<table>
<thead>
<tr>
<th><strong>处理器</strong></th>
<th><strong>流水线</strong></th>
<th><strong>指令集</strong></th>
<th><strong>存储管理</strong></th>
<th><strong>协处理器</strong></th>
<th><strong>多核</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ARM7</strong></td>
<td><strong>3</strong></td>
<td><strong>ARM/T</strong></td>
<td><strong>N</strong></td>
<td><strong>N</strong></td>
<td><strong>N</strong></td>
</tr>
<tr>
<td><strong>ARM9</strong></td>
<td><strong>5</strong></td>
<td><strong>ARM/T</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>N</strong></td>
</tr>
<tr>
<td><strong>ARM10</strong></td>
<td><strong>6</strong></td>
<td><strong>ARM/T</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>N</strong></td>
</tr>
<tr>
<td><strong>ARM11</strong></td>
<td><strong>8</strong></td>
<td><strong>Thumb-2</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>N</strong></td>
</tr>
<tr>
<td><strong>Cortex-A8</strong></td>
<td><strong>NEON</strong></td>
<td><strong>V7-A</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>N</strong></td>
</tr>
<tr>
<td><strong>Cortex-A9,1X</strong></td>
<td><strong>NEON</strong></td>
<td><strong>V7-A</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
</tr>
<tr>
<td><strong>Cortex-A5X</strong></td>
<td><strong>NEON</strong></td>
<td><strong>V8-A</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
<td><strong>Y</strong></td>
</tr>
</tbody></table>
<ul>
<li>总线</li>
</ul>
<table>
<thead>
<tr>
<th><strong>版本</strong></th>
<th><strong>处理器</strong></th>
<th><strong>发布时间</strong></th>
<th><strong>总线(bit)</strong></th>
<th><strong>总线结构</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>V1</strong>，<strong>V2</strong></td>
<td><strong>ARM1</strong></td>
<td><strong>未商业授权</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>V3</strong></td>
<td><strong>……</strong></td>
<td><strong>未商业授权</strong></td>
<td><strong>32</strong></td>
<td></td>
</tr>
<tr>
<td><strong>V4</strong></td>
<td><strong>ARM7/9</strong></td>
<td><strong>1996</strong></td>
<td><strong>32</strong></td>
<td><strong>7-Von  Neumann</strong>  <strong>9-Harvard</strong></td>
</tr>
<tr>
<td><strong>V5</strong></td>
<td><strong>ARM10</strong></td>
<td><strong>2000</strong></td>
<td><strong>32</strong></td>
<td><strong>Harvard</strong></td>
</tr>
<tr>
<td><strong>V6</strong></td>
<td><strong>ARM11</strong></td>
<td><strong>2002</strong></td>
<td><strong>32</strong></td>
<td><strong>Harvard</strong></td>
</tr>
<tr>
<td><strong>V7</strong></td>
<td><strong>Ax,  1X</strong></td>
<td><strong>2004</strong></td>
<td><strong>32</strong></td>
<td><strong>Harvard</strong></td>
</tr>
<tr>
<td><strong>V8</strong></td>
<td><strong>A53/57</strong></td>
<td><strong>2013</strong></td>
<td><strong>64</strong></td>
<td><strong>Harvard</strong></td>
</tr>
</tbody></table>
<h3 id="Cortex-A75-Core（Snapdragon-845）"><a href="#Cortex-A75-Core（Snapdragon-845）" class="headerlink" title="Cortex-A75-Core（Snapdragon 845）"></a>Cortex-A75-Core（Snapdragon 845）</h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014222824903.png" alt=""></p>
<h2 id="S3C2410A"><a href="#S3C2410A" class="headerlink" title="S3C2410A"></a>S3C2410A</h2><p>硬件工程师在设计包含处理器的电路板时需要掌握处理器的哪些信息？</p>
<p>数据手册（datasheet）</p>
<h3 id="datasheet"><a href="#datasheet" class="headerlink" title="datasheet"></a><strong>datasheet</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014222911825.png" alt=""></p>
<p>软件工程师在为处理器开发程序时需要掌握处理器的哪些信息？</p>
<p>使用手册（manual）</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014222945183.png" alt=""></p>
<h3 id="S3C2410"><a href="#S3C2410" class="headerlink" title="S3C2410"></a><strong>S3C2410</strong></h3><p><img src="/images/loading.gif" data-original="../images/development/image-20211014223007273.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014223016282.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014223032659.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014223045895.png" alt=""></p>
<p>Peripheral Registers</p>
<p><img src="/images/loading.gif" data-original="../images/development/image-20211014223102590.png" alt=""></p>
<h1 id="ARM汇编程序"><a href="#ARM汇编程序" class="headerlink" title="ARM汇编程序"></a>ARM汇编程序</h1><ol>
<li>Keil作为半主机模式如何导入导出数据？</li>
</ol>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019205214860.png" alt=""></p>
<ol start="2">
<li><p>如何测试处理器性能？</p>
</li>
<li><p>Keil工程中startup.s/S3c2410.s的作用？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019205422881.png" alt=""></p>
</li>
</ol>
<ul>
<li><p>Heap_size：动态分配空间</p>
</li>
<li><p>Heap_mem：需指定位置与大小</p>
</li>
<li><p>全局空间是link时自动分配的空间</p>
</li>
</ul>
<h2 id="汇编程序格式"><a href="#汇编程序格式" class="headerlink" title="汇编程序格式"></a>汇编程序格式</h2><h3 id="ARM汇编"><a href="#ARM汇编" class="headerlink" title="ARM汇编"></a><strong>ARM汇编</strong></h3><p><strong>Keiln(ARM ASM)</strong></p>
<pre><code>AREA    ARMex, CODE, READONLY                                    
        ENTRY
start
        MOV      r0, #10 
        MOV      r1, #3
        ADD      r0, r0, r1      

        END 
</code></pre><p><strong>Segger (gnu asm )</strong></p>
<pre><code>.weak _start
            .global __start
            .section .init, “ax”
            .type _start, function
            .code 32
            .balign 4
_start:
__start:
        //
        // Setup Stacks
        //for asm testing
        mov r0, #0x1000     
        mov r1, #0x300
        mov r2, #0x400
        add r1,r1,r2
        strb r1,[r0]
       //testing end
    ……
</code></pre><ul>
<li><p>ax （allocation execute）</p>
</li>
<li><p>.weak _start  有外部调用则调用外部，没有调用内部</p>
</li>
<li><p>.code 32 表示32位</p>
</li>
<li><p>.balign 4  对齐</p>
<ul>
<li>有b，表示四个字节对齐；</li>
<li>没有b，表示2的多少次方对齐。</li>
</ul>
</li>
<li><p>_start:缺省入口</p>
</li>
<li><p>__start:系统启动定义的</p>
</li>
</ul>
<h3 id="指令级程序"><a href="#指令级程序" class="headerlink" title="指令级程序"></a><strong>指令级程序</strong></h3><h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a><strong>格式</strong></h4><p><strong>ASM Directive</strong></p>
<ul>
<li><p>AREA</p>
<ul>
<li>Mark the start of a section</li>
<li>Names the section and sets its attributes. </li>
<li>The attributes are placed after the name, separated by commas</li>
</ul>
</li>
<li><p>ENTRY</p>
</li>
<li><p>Marks the first instruction to be executed</p>
</li>
<li><p>Initialization code and exception handlers also contain entry points.</p>
</li>
<li><p>END</p>
<ul>
<li>Instructs the assembler to stop processing this source file </li>
<li>On a line by itself.</li>
</ul>
</li>
</ul>
<p><strong>指令格式</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019210000605.png" alt=""></p>
<p><strong>助记符</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019210028217.png" alt=""></p>
<ul>
<li><p>GE：Cond，条件判断</p>
</li>
<li><p>S：状态位</p>
</li>
</ul>
<p><strong>语句格式</strong></p>
<ul>
<li>Lines in an ARM assembly language module is:</li>
</ul>
<p>{symbol} {instruction|directive|pseudo-instruction} {;commen}</p>
<ul>
<li><p>Examples</p>
<p>lable1 ADD r1，r2，r3 ;”+</p>
</li>
</ul>
<pre><code>AREA     ARMex, CODE, READONLY

        ENTRY     ; Mark first instruction to execute

start
        MOV      r0, #10        ; Set up parameters
        MOV      r1, #3
        ADD      r0, r0, r1      ; r0 = r0 + r1

        END                      ; Mark end of file
</code></pre><ul>
<li>标签最左边对齐</li>
<li>语句最左边需要空格</li>
</ul>
<h4 id="用汇编语言实现把下列C程序功能？"><a href="#用汇编语言实现把下列C程序功能？" class="headerlink" title="用汇编语言实现把下列C程序功能？"></a>用汇编语言实现把下列C程序功能？</h4><pre><code>int main(void)
{      int i, j;
    unsigned char Inimage[480][640];
    unsigned char Tmpimg[120][160];
    for(i=0;i&lt;120;i++)
         for(j=0;j&lt;160;j++)                
               Tmpimg[i][j]=Inimage[i*4+2][j*4+2];  
    memcpy(Inimage,Tmpimg,160*120);
    return 1;
}</code></pre><h2 id="汇编指令"><a href="#汇编指令" class="headerlink" title="汇编指令"></a>汇编指令</h2><p><img src="/images/loading.gif" data-original="../images/basic/image-20211019210553192.png" alt=""></p>
<ul>
<li>R0-R15和r0-r15</li>
<li>a1-a4(参数,结果或者临时寄存器,与r0-r3同意)</li>
<li>v1-v8(变量寄存器,与r4-r11同意)</li>
<li>sb和SB(静态基址寄存器,与r9同意)</li>
<li>sl和SL(堆栈限制寄存器,与r10同意)</li>
<li>fp和FP(帧指针,与r11同意)</li>
<li>ip和IP(过程调用中间临时寄存器,与r12同意)</li>
<li>sp和SP(堆栈指针,与r13同意)</li>
<li>lr和LR(连接寄存器,与r14同意)</li>
<li>pc和PC(程序计数器,与r15同意)</li>
<li>cpsr和CPSR(程序状态寄存器)</li>
<li>spsr和SPSR(程序状态寄存器)</li>
<li>f0-f7和F0-F7(FPA寄存器)</li>
<li>s0-s31和S0-S31(VFP单精度寄存器)</li>
<li>d0-d15和D0-D15(VFP双精度寄存器)</li>
<li>p0-p15(协处理器0-15)</li>
<li>c0-c15(协处理器寄存器0-15)</li>
</ul>
<h3 id="变量与数据"><a href="#变量与数据" class="headerlink" title="变量与数据"></a><strong>变量与数据</strong></h3><p>数据类型？ Byte，Halfword，Word，Doubleword，QuadWord ( Signed or unsigned？) – Only unsigned (except for MUL)</p>
<p>变量位置？ Memory (Stack，static), Register</p>
<p>变量赋值？ Address (immediate，memory，Register)</p>
<p>常量定义？ EQU</p>
<p>指令和寄存器大小写有区别？</p>
<p>MOV 立即数寻址可以装载任意数据？</p>
<ul>
<li><p>MOV 是ALU单元的操作，改变状态</p>
</li>
<li><p>MVN 按位取反再装载</p>
</li>
</ul>
<h4 id="Loading-immediate"><a href="#Loading-immediate" class="headerlink" title="Loading immediate"></a><strong>Loading immediate</strong></h4><ul>
<li>MOV<ul>
<li>8-bit ,0x0 to 0xFF (0-255).</li>
<li>Rotate by any even number.</li>
<li>MVN load “NOT” Value</li>
<li>Thumb： only 0x00-0xff </li>
</ul>
</li>
</ul>
<blockquote>
<p>理解8位或者偶数移位（<strong>Rotate by any</strong> <strong>even</strong> <strong>number</strong>）</p>
<p>例如260的二进制是100000100 可以由1000001循环右移30位或左移2位，位数位偶数，可以作为立即数</p>
<p>在比如258二进制是100000010 可以由10000001循环右移31位或左移1位，位数是奇数，不可以作为立即数</p>
</blockquote>
<p><strong>实际理解为为了将12位的数字映射到32位上，用8位作为基：0~255；4位作为rotate，循环右移2*rotate</strong></p>
<p>下列指令是否正确？</p>
<pre><code>MOV  rn ,#1025 错
MOV  rn ,#4096 对
MVN  rn ,#0x111 错
MVN  rn ,#0xffffffff 对</code></pre><h4 id="装载任意大小数值"><a href="#装载任意大小数值" class="headerlink" title="装载任意大小数值"></a><strong>装载任意大小数值</strong></h4><ul>
<li>LDR Rd, =const</li>
</ul>
<p>伪指令？</p>
<p>这里两条指令的执行过程与立即数寻址过程的查差别？</p>
<ul>
<li><p>LDR</p>
<ul>
<li><p>LDR -&gt; Appropriate instruction (by assember)</p>
</li>
<li><p>Constant is in the range of MOV or MVN</p>
<p>   LDR -&gt; MOV (MVN) </p>
<p><strong>MOV or MVN” depend on what?</strong></p>
</li>
<li><p>Constant is over the range of MOV or MVN</p>
<ul>
<li>Places the value in a literal pool</li>
<li>LDR instruction with a program-relative address that reads the constant from the literal pool.</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>LDR r0, =0x23
LDR r0, =0xffffff        ;MVN r0，#ff000000
LDR r0, =0x5555        ;？
;LDR   rn, [pc, #offset to literal pool]</code></pre><p>LDR对于不符合的立即数如何转换？</p>
<p>利用pc和literal pool读取</p>
<ul>
<li><p>How to put the “literal pool” in memory?</p>
<ul>
<li>Marking with “LTORG”<ul>
<li>After unconditional branch instructions</li>
<li>after the return instruction</li>
</ul>
</li>
</ul>
</li>
<li><p>By assembler</p>
<ul>
<li>After the end of “AREA”</li>
</ul>
</li>
<li><p>The offset from the pc to the constant</p>
<ul>
<li>ARM state<ul>
<li>Less than 4KB</li>
<li>Either direction</li>
</ul>
</li>
<li>Thumb state<ul>
<li>Less than 1KB</li>
<li>Forward </li>
</ul>
</li>
</ul>
</li>
</ul>
<p>为什么 “LTORG” 要放在跳转后或返回后？不会当作指令取进去.</p>
<p><strong>下列程序中 LDR 指令能否正确转换？</strong></p>
<pre><code>AREA   Loadcon, CODE, READONLY
        ENTRY

        LDR      r0, =42          ; =&gt; MOV R0, #42
       LDR      r1, =0x55555555 ; =&gt; LDR R1, [PC, #offset to Literal Pool 1]
       LDR      r2, =0xFFFFFFFF           ; =&gt; MVN R2, #0
        LTORG                           ; Literal Pool 1 contains
                                              ; literal Ox55555555
       LDR      r3, =0x55555555  ; =&gt; LDR R3, [PC, #offset                
                                             ；Literal Pool 1
       LDR      r4, =0x666 
       END                      
                   ; Literal Pool 2 contains 0x666
</code></pre><h4 id="寄存器常数装载方式"><a href="#寄存器常数装载方式" class="headerlink" title="寄存器常数装载方式"></a>寄存器常数装载方式</h4><table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MOV(MVN)</td>
<td>装载立即数</td>
<td>8bit</td>
</tr>
<tr>
<td>LDR</td>
<td>装载常数(伪)</td>
<td>32bit位常量</td>
</tr>
<tr>
<td>ADR（L）</td>
<td>装载地址(伪)</td>
<td>32bit  相对地址</td>
</tr>
</tbody></table>
<pre><code>MOV{&lt;cond&gt;}{S}   Rd, #const
LDR Rd, =const
ADR Rd, label</code></pre><ul>
<li><p>Load address</p>
<ul>
<li>ADR and ADRL<ul>
<li>Generate an address, within a certain range<ul>
<li>program-relative expression<ul>
<li>Label with an optional offset</li>
<li>Be relative to the current pc.</li>
</ul>
</li>
<li>Register-relative expression<ul>
<li>Label with an optional offset</li>
<li>Be relative to an address held in a specified general-purpose register.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>ADR</strong></p>
<ul>
<li>Converts ADR rn,label into a Single ADD or SUB instruction that loads the address, if it is in range</li>
<li>The offset range of ADR<ul>
<li>±255 bytes for an offset to a non word-aligned address.</li>
<li>±1 020 bytes (255 words) for an offset to a word-aligned address.</li>
</ul>
</li>
<li>An error message if the address cannot be reached in a single instruction</li>
</ul>
</li>
</ul>
<p><strong>分析下列两条ADR指令的转换结果</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019214813141.png" alt=""></p>
<ul>
<li><strong>ADRL</strong><ul>
<li>Converts an ADRL rn,label into two data-processing instructions that load the address, if it is in range </li>
<li>The range of an ADRL<ul>
<li>± 64KB for a non word-aligned address </li>
<li>± 256KB for a word-aligned address.</li>
</ul>
</li>
<li>An error message if the address cannot be constructed in two instructions.</li>
<li>There is no ADRL pseudo-instruction for Thumb.</li>
</ul>
</li>
</ul>
<p><strong>分析下列两条ADRL指令的转换结果</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019214953889.png" alt=""></p>
<h3 id="运算"><a href="#运算" class="headerlink" title="运算"></a><strong>运算</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211019215044449.png" alt=""></p>
<p><strong>运算符的操作数一定是寄存器或者立即数</strong></p>
<ul>
<li><p>ASR 算数右移</p>
</li>
<li><p>LSL 逻辑左移</p>
</li>
<li><p>LSR 逻辑右移</p>
</li>
<li><p>ROR 循环右移</p>
</li>
<li><p>RRX 带扩展的循环右移</p>
<ul>
<li><shifter_imm> <strong>L: 0-31; R: 1-32</strong>。</shifter_imm></li>
<li>RRX 只能移动一位</li>
</ul>
</li>
</ul>
<p><strong>分析下指令</strong></p>
<pre><code>ADD      r0, r1, #10
ADD   r11,r12,r3, ASR #5 
ADD   r11,r12,r3,LSL R4 
ADD     r5,r4, r3, RRX </code></pre><h4 id="算术指令"><a href="#算术指令" class="headerlink" title="算术指令"></a><strong>算术指令</strong></h4><ul>
<li><p>语法</p>
<p>Op{cond}{s} Rd, Rn, Operand2</p>
</li>
<li><p>标志位</p>
<p> N, Z, C,V</p>
</li>
<li><p>指令</p>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ADC</td>
<td>Rd=Rn  + Operand2+C</td>
</tr>
<tr>
<td>ADD</td>
<td>Rd=Rn  + Operand2</td>
</tr>
<tr>
<td>RSB</td>
<td>Rd=Operand2-Rn</td>
</tr>
<tr>
<td>RSC</td>
<td>Rd=Operand2-Rn-!C</td>
</tr>
<tr>
<td>SBC</td>
<td>Rd=Rn-Operand2-!C</td>
</tr>
<tr>
<td>SUB</td>
<td>Rd=Rn-Operand2</td>
</tr>
</tbody></table>
<p>当看溢出时，要把数据看成是有符号数，就是最高位的数字代表是符号，0正1负。如果次高位计算改变符号位则溢出。</p>
<p>当看进位时是将数据看成无符号数，全部是数据没有符号位，如果运算超出数的范围向前进位了，则进位标志置位。</p>
<p><strong>下列指令哪些时错误的？</strong></p>
<pre><code>ADC         r1, r1, #5    对
SUB         r11,r12,r3,ASR #5    对 
RSB         r5,r3,r4, LSR #32        对    
ADD            r3,r7,#1023       错             
SUB         r11,r12,r3,LSL #32    错 最多31
SBC         r5,r4, r4, RRX #3        错 最多1</code></pre><p><strong>给出指令的执行结果</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211019215615913.png" alt=""></p>
<ul>
<li>cpsr=nzcvqiFt_USER；指定当前个标志位状态，并且工作在用户模式</li>
</ul>
<h4 id="乘法指令"><a href="#乘法指令" class="headerlink" title="乘法指令"></a>乘法指令</h4><ul>
<li><p>MUL和MLA (32bit *32bit -&gt; least 32bit)</p>
<ul>
<li><p>语法</p>
<p>MUL<em>{<strong>cond</strong>}{S} Rd, Rm, Rs</em></p>
<p>MLA<em>{<strong>cond</strong>}{S} Rd, Rm, Rs, Rn</em></p>
</li>
<li><p>执行</p>
<p> MUL: Rs*Rm -&gt;Rd (least)</p>
<p> MLA: Rs*Rm+Rn -&gt; Rd (least)</p>
</li>
<li><p>标志位</p>
<p> N, Z</p>
</li>
</ul>
</li>
</ul>
<p>d!=m</p>
<blockquote>
<p>32位乘32位低32位！</p>
</blockquote>
<p><strong>分析下列指令</strong></p>
<pre><code>MUL     r10,r2,r5
MLA     r10,r2,r1,r5
MULS    r0,r2,r2

MUL     r15,r0,r3        ;错
MLA     r1,r1,r3, r6    ;错</code></pre><ul>
<li><p>U（S）MULL, U（S）MLAL(32bit *32bit -&gt; 64bit)</p>
<ul>
<li><p>语法</p>
<p>Op{cond}{S} RdLo, RdHi, Rm, Rs</p>
</li>
<li><p>执行</p>
<p> U（S）MULL: Rs*Rm -&gt;RdLo, RdHi</p>
<p> U（S）MLAL: Rs*Rm+(RdLo,RdHi) -&gt; RdLo , RdHi</p>
</li>
<li><p>标志位 </p>
<p> N, Z</p>
</li>
<li><p>例:</p>
<pre><code>UMULL       r0,r4,r5,r6
UMLALS     r4,r5,r3,r8
UMULL       r1,r15,r10,r2</code></pre><blockquote>
<p>目的寄存器需要用两个32位来存储一个64位</p>
</blockquote>
<p><strong>UMLAL</strong> <strong>与</strong> <strong>MLA</strong> <strong>操作的差别？</strong></p>
</li>
</ul>
</li>
</ul>
<p><strong>给出下列指令的执行结果</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028135420129.png" alt=""></p>
<h4 id="逻辑指令"><a href="#逻辑指令" class="headerlink" title="逻辑指令"></a><strong>逻辑指令</strong></h4><ul>
<li><p><strong>语法</strong></p>
<p>Op{cond}{s} Rd, Rn, Operand2</p>
</li>
<li><p>指令</p>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td>AND</td>
<td>Rd=Rn  &amp; Operand2;  shift_operand</td>
</tr>
<tr>
<td>ORR</td>
<td>Rd=Rn  | Operand2</td>
</tr>
<tr>
<td>EOR</td>
<td>Rd=Rn  ^ Operand2</td>
</tr>
<tr>
<td>BIC</td>
<td>Rd=Rn  &amp; (~Operand2)</td>
</tr>
</tbody></table>
<ul>
<li><p>例</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028135715652.png" alt=""></p>
</li>
</ul>
<h4 id="MOV"><a href="#MOV" class="headerlink" title="MOV"></a><strong>MOV</strong></h4><p><strong>寄存器间数据复制</strong></p>
<pre><code>PRE
    R0=0x80
    R1=0x50
    MOV  R0, R1

POST
    R0=? 0x50
    R1=? 0x50</code></pre><p><strong>使用桶形移位寄存器</strong></p>
<pre><code>PRE
    R0=0x80
    R1=0x50

    MOV  R0, R1, LSL #4

POST
    R0=? 0x500
    R1=? 0x50</code></pre><p><img src="/images/loading.gif" data-original="../images/basic/image-20211028135854829.png" alt=""></p>
<table>
<thead>
<tr>
<th><strong>移位操作</strong></th>
<th><strong>结果</strong></th>
<th><strong>Y**</strong>值范围**</th>
</tr>
</thead>
<tbody><tr>
<td>x  LSL y</td>
<td>x  &lt;&lt; y</td>
<td>#0-31  or Rs</td>
</tr>
<tr>
<td>x  LSR y</td>
<td>(unsigned)  x &gt;&gt; y</td>
<td>#1-32  or Rs</td>
</tr>
<tr>
<td>x  ASR y</td>
<td>(signed)  x &gt;&gt; y</td>
<td>#1-32  or Rs</td>
</tr>
<tr>
<td>x  ROR y</td>
<td>((unsigned)x  &gt;&gt;y)|(x&lt;&lt;(32-y))</td>
<td>#1-32  or Rx</td>
</tr>
<tr>
<td>x  RRX</td>
<td>(c  flag &lt;&lt;31)|((unsigned)x&gt;&gt;1)</td>
<td>none</td>
</tr>
</tbody></table>
<p><strong>移位对C标志的影响</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028135953614.png" alt=""></p>
<blockquote>
<p>状态寄存器小写0，大写1</p>
</blockquote>
<h4 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h4><pre><code>比较判断    r6&lt; Imageheight? ;  r5&lt;Imagewidth ?
    cmp r6, #Imageheight
    cmp r5, #Imagewidth</code></pre><ul>
<li><p>语法</p>
<p> CMP{cond} Rn, Operand2</p>
</li>
<li><p>第二操作数（Operand2）</p>
</li>
</ul>
<pre><code>#&lt;immediate&gt;
&lt;Rm&gt; </code></pre><blockquote>
<p>ALU_out[31]-&gt;N; alu_out=0, Z=1 else Z=0;</p>
<p>Not borrow from “Rn-Operand2 “ : C=1 else C=0;</p>
<p>Overflow from “ Rn-Operand2”: V=1 else V=0;</p>
</blockquote>
<blockquote>
<p>自动改变状态寄存器</p>
</blockquote>
<ul>
<li><p>语法</p>
<p>Op{cond} Rn, Operand2</p>
</li>
<li><p>指令</p>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td>CMN</td>
<td>flag of Rn + Operand2;&lt;Rm&gt;</td>
</tr>
<tr>
<td>CMP</td>
<td>flag of Rn - Operand2; &lt;Rm&gt;, <imm_8></imm_8></td>
</tr>
<tr>
<td>TEQ</td>
<td>flag of Rn ^ Operand2;&lt;shift_operand&gt;</td>
</tr>
<tr>
<td>TST</td>
<td>flag of Rn &amp; Operand2;&lt;Rm&gt;</td>
</tr>
</tbody></table>
<ul>
<li>例</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028140522389.png" alt=""></p>
<blockquote>
<p>不改变通用寄存器数值，自动改变状态寄存器状态</p>
</blockquote>
<h4 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h4><pre><code>跳转     for (;;)  
行内循环              cmp     r5, #Imagewidth
        bmi     Linecircle
行间循环
                  cmp     r6, #Imageheight
                            bmi     Framecircle</code></pre><ul>
<li>语法</li>
</ul>
<pre><code> B{&lt;cond&gt;} label</code></pre><ul>
<li><p>如果Imagewidth 或 Imageheight 大于0xff，如何处理？</p>
</li>
<li><p>label ？ 有什么要求？</p>
</li>
<li><p>支持哪些 cond？ 如何表达？ </p>
</li>
<li><p>语法</p>
</li>
</ul>
<pre><code>B{&lt;cond&gt;} label
BL{&lt;cond&gt;} label
BX{&lt;cond&gt;} Rm
BLX{&lt;cond&gt;} label|Rm</code></pre><ul>
<li>指令</li>
</ul>
<table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>B(跳转)</td>
<td>pc=label</td>
</tr>
<tr>
<td>BL(带返回跳转)</td>
<td>pc=label,  lr=BL 后面第一条指令地址</td>
</tr>
<tr>
<td>BX(切换状态跳转)</td>
<td>pc=Rm  &amp; 0xfffffffe, T=Rm &amp; 1</td>
</tr>
<tr>
<td>BLX</td>
<td>pc=  label, T=1  pc=Rm  &amp; 0xfffffffe, T=Rm &amp; 1  lr=BLX 后面的第一条指令地址</td>
</tr>
</tbody></table>
<ul>
<li><strong>B</strong></li>
</ul>
<pre><code>B     forward
backward
    ADD     r1, r2, #4
    ADD    r0, r6, #2
    ADD     r3, r7, #5
forward
    SUB    r1, r2, #4
    ADD    r1, r2, #4
    SUB    r1, r2, #4
    ADD    r4, r6, r7
    B     backward</code></pre><p>B 可以在4G空间任意范围内跳转吗？</p>
<p>±32MB</p>
<ul>
<li><strong>BX</strong></li>
</ul>
<pre><code>CODE32 
header
    MOV r0, #0                         
      ADR     r0, start + 1               
        BX      r0  

    CODE16                  
start
            ADD r1, r2
    SUB r2, #0x55
            CMP r0, r1                  
       ……</code></pre><ul>
<li><p>如何添加指令，从CODE16段跳到header</p>
</li>
<li><p>Thumb指令特点：</p>
<ul>
<li>使用ARM的r0-r7 8个通用寄存器</li>
<li>Thumb指令没有条件执行</li>
<li>指令自动更新标志，不需加（s）</li>
<li>仅有LDMIA（STMIA）<ul>
<li>只有IA一种形式</li>
<li>必须加“！”</li>
</ul>
</li>
<li>在数据运算指令中，不支持第二操作数移位</li>
</ul>
<blockquote>
<p>Thumb指令是16位的Arm指令集，可以理解为Arm的阉割版</p>
<p><a href="https://blog.csdn.net/qq_20880415/article/details/101037010" target="_blank" rel="noopener">https://blog.csdn.net/qq_20880415/article/details/101037010</a></p>
<p>指令操作16位</p>
<p>操作依然是32位</p>
</blockquote>
</li>
<li><p><strong>BL</strong></p>
</li>
</ul>
<pre><code>BL     subroutine
    CMP     r1, #5
    MOV     r1, #0
    ADD     r1, r2, #4
    ……
subroutine 
    ADD    r1, r2, #4
    SUB    r1, r2, #4
    MOV    pc, lr</code></pre><p>函数的返回方式？</p>
<blockquote>
<p>Lr是跳转前下一条指令的地址</p>
</blockquote>
<ul>
<li>条件类型</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028141148231.png" alt=""></p>
<ul>
<li>比较下列指令</li>
</ul>
<pre><code>ADD     r0, r1, r2    ; r0 = r1 + r2, don't update flags
ADDS    r0, r1, r2    ; r0 = r1 + r2, and update flags
ADDCSS  r0, r1, r2    ; If C flag set then r0 = r1 + r2,                 
                                   ;    and update flags
CMP     r0, r1        ; update flags based on r0-r1.</code></pre><ul>
<li><strong>下列程序中哪些指令不执行</strong></li>
</ul>
<pre><code>    MOV r0, #1
    MOV r1, #2
    CMP r0, r1    ;N=1
    SUBGT r0,r0,r1    ;不执行
    SUBLT r1,r1,r0    ;r1=1
    CMP r0,r1        ;z=1
    SUBGT r0,r0,r1    ;不执行
    SUBLT r1,r1,r0    ;不执行</code></pre><ul>
<li><p><strong>不同跳转方法的对比</strong></p>
<ul>
<li>实现方法</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028141314709.png" alt=""></p>
<ul>
<li>执行时间分析（condition branch)</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028141432965.png" alt=""></p>
<p>​        不执行的指令也占时间？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211028141503386.png" alt=""></p>
</li>
</ul>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><pre><code>//c/c++    
for(i=0;i&lt;120;i++)
{ 
    for(j=0;j&lt;160;j++){……}
} </code></pre><pre><code>Imageheight    equ    120
Imagewidth    equ    160

         area    ImScale , code , readonly                               
         entry        
        mov    r6, #0
Framcircle 
    mov    r5, #0
Linecircle
    ……    
        add r5, r5,#1
        cmp r5, #Imagewidth
      bmi  Linecircle
        add r6, r6, #1
        cmp r6, #Imageheight
        bmi Framecircle
        end</code></pre><h1 id="ARM汇编-1"><a href="#ARM汇编-1" class="headerlink" title="ARM汇编"></a>ARM汇编</h1><p>把下列C程序改成汇编程序 ：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>      <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Inimage<span class="token punctuation">[</span><span class="token number">480</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Tmpimg<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">160</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">120</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
         <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">160</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>                
               Tmpimg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>Inimage<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token function">memcpy</span><span class="token punctuation">(</span>Inimage<span class="token punctuation">,</span>Tmpimg<span class="token punctuation">,</span><span class="token number">160</span><span class="token operator">*</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="存储访问"><a href="#存储访问" class="headerlink" title="存储访问"></a><strong>存储访问</strong></h2><h3 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a><strong>内存分配</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211028142708487.png" alt=""></p>
<pre><code>//c/c++    
Tmpimg[120][160]；
Inimage[480][640];

//分配
Tmpimg    space        160*120    ;单位字节
Inimage    space        640*480

//语法
[label]        SPACE        expression
可用 %代替 SPACE</code></pre><p>“160×120”和“640×480”中的“×”运算在程序运行时完成吗？</p>
<h4 id="内存区域分配"><a href="#内存区域分配" class="headerlink" title="内存区域分配"></a><strong>内存区域分配</strong></h4><ul>
<li><p>DCX{U-对齐选项}</p>
<ul>
<li><p>种类</p>
<ul>
<li>DCB-(1byte)</li>
<li>DCD and DCDU-(4 bytes)</li>
<li>DCFD and DCFDU-(double-precision float point)</li>
<li>DCFS and DCFSU-(single-precision float point)</li>
<li>DCI-(like DCD and DCDU)</li>
<li>DCQ and DCQU-(8 bytes)</li>
<li>DCW and DCWU-(2 bytes)</li>
</ul>
</li>
<li><p>用法</p>
<p><em>{label}</em>   DCX{U}  <em>expression，{expression,<strong>……</strong>}</em></p>
</li>
<li><p>Example</p>
</li>
</ul>
</li>
</ul>
<pre><code>data        DCW     -225,2*number
              DCWU    number+4    ;number must be     defined
    DCQ     -225, 2_101
DCFD    1E308, -4E-100
DCFDU   10000, -.1, 3.1E26 </code></pre><pre><code>加“U” 不需要对齐
不同命令对其格式不一样
DCD-4Bytes
DCW-2Bytes</code></pre><h4 id="分析内存中数据存储状况"><a href="#分析内存中数据存储状况" class="headerlink" title="分析内存中数据存储状况"></a>分析内存中数据存储状况</h4><pre><code>    DCB     1，2，3
    DCDU 0x11223344
    DCW     0x2233，0x4455
    DCWU 0x677
    DCD 0x06070809</code></pre><ul>
<li><p>Endian 模式对存储状况的影响？大端小端</p>
</li>
<li><p>SPACE与 DCX使用上的区别？ DCX分配空间与写入值</p>
</li>
<li><p>程序中如何找到分配区域的起始地址？自定义标签</p>
</li>
</ul>
<blockquote>
<p>练习，画出内存中存储位置</p>
</blockquote>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a><strong>数据结构</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">//Declare </span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> Point
<span class="token punctuation">{</span>
        <span class="token keyword">float</span> x<span class="token punctuation">;</span>
      <span class="token keyword">float</span> y<span class="token punctuation">;</span>
    <span class="token keyword">float</span> z<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Point<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//Allocate space</span>
Point origin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>//Declare 
PointBase   RN      r11
                 MAP     0,PointBase    ;r11地址作为初始地址
Point_x     FIELD   4    
Point_y     FIELD   4
Point_z     FIELD   4

//Allocate space
origin      SPACE   12</code></pre><h3 id="内存访问"><a href="#内存访问" class="headerlink" title="内存访问"></a><strong>内存访问</strong></h3><pre class="line-numbers language-assembly"><code class="language-assembly">//c/c++    
    Tmpimg[i][j]; Inimage[i*4+2][j*4+2];

//i->r5; j->r6; Tmpimg-> r8; Inimage->r9;
    ldr    r8,    =Tmping
    ldr    r9,    =Inimage
//Tmpimg[i][j]->r10;
    mov    r0,    #Imagewidth
    mul    r10, r5, r0   ;i*Imagewidth
    add    r10, r10, r6   ;i*Imagewidth+j
//Inimage[i*4+2][j*4+2]-> r11
    mov    r1, r5, asl #2 ; i*4
    add    r1, r1, #2    ;i*4+2
    mul    r11, r1, r0    ;(i*4+2)*Imagewidth
    mov    r1, r6, asl #2 ;j*4
    add    r1, r1, #2    ;j*4+2
    add    r11, r11, r1; (i*4+2)*Imagewidth+4*j+2
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>//c/c++    
    Tmpimg[i][j]=Inimage[i*4+2][j*4+2];

//实现    
    ldrb    r0, [r11]    读取方式
    strb    r0, [r10]    存储数据

//语法    
LDR {&lt;cond&gt;}{B} Rd, addressing1
STR{&lt;cond&gt;}{B}  Rd, addressing1</code></pre><h4 id="读（Memory-gt-Register）"><a href="#读（Memory-gt-Register）" class="headerlink" title="读（Memory->Register）"></a>读（Memory-&gt;Register）</h4><table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>LDR</td>
<td>Rd&lt;-mem32[add]</td>
</tr>
<tr>
<td>LDRB</td>
<td>Rd&lt;-mem8[add]</td>
</tr>
<tr>
<td>LDRH</td>
<td>Rd&lt;-mem16[add]</td>
</tr>
<tr>
<td>LDRSB</td>
<td>Rd&lt;-SignExtend(mem8[add])</td>
</tr>
<tr>
<td>LDRSH</td>
<td>Rd&lt;-SignExtend(mem16[add])</td>
</tr>
</tbody></table>
<ul>
<li><p>指令形式</p>
<pre><code>LDR {&lt;cond&gt;}{B} Rd, address1
LDR {&lt;cond&gt;}SB|H|SH Rd, address2</code></pre></li>
<li><p>address</p>
<ul>
<li>基于寄存器的寻址</li>
<li>地址对齐要求？</li>
</ul>
</li>
</ul>
<p>LDR 可能改变状态寄存器状态位？</p>
<ul>
<li><p>Address1</p>
<ul>
<li>[Rn]</li>
<li>前偏移，Rn不变<ul>
<li>[Rn, # +/- offset_12] </li>
<li>[Rn, +/-Rm]</li>
<li>[Rn,+/-Rm, shift_imm]</li>
</ul>
</li>
<li>前偏移，Rn更新<ul>
<li>[Rn,#+/-offset_12]!  </li>
<li>[Rn,+/-Rm]!</li>
<li>[Rn,+/-Rm, shift_imm]!</li>
</ul>
</li>
<li>后偏移，Rn更新<ul>
<li>[Rn], # +/- offset_12  </li>
<li>[Rn], +/-Rm</li>
<li>[Rn],+/-Rm, shift_imm</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>带“！”表示需要更新Rn内寄存器的值</strong></p>
</li>
</ul>
<p><strong>解释下列指令</strong></p>
<pre><code>ldr r0, [r1, #0x04]!
ldr r0, [r1, r2]!                ;R1+r2-&gt;r0，更新r1
ldr r2,[r1, -r0, LSR #0x04]!    ;R0&lt;&lt;4 +r1-&gt;r2, 更新r1
ldr r0, [r1], #0x04                ;r1-&gt;r0，r0-&gt;r0+4
ldr r0,[r1],r2
rdr r0,[r1], -r0, LSL #0x04   
ldr r0, [r1, #0x04]
ldr r0, [r1, r2]
ldr r2,[r1, -r0, LSR #0x04]
</code></pre><p><strong>比较五条指令的执行结果</strong></p>
<pre><code>LDR r0, [r1, #4]    r0=0x3030303,r1=0x104
LDR r0, [r1, #4]!    R0=0x3030303,r1=0x108
LDR r0, [r1], #4    r0=0x80808080,r1=0x108
LDRB r0, [r1]        r0=0x00000080
LDRSB r0, [r1]        r0=0xFFFFFF80</code></pre><p><img src="/images/loading.gif" data-original="../images/basic/image-20211104181456533.png" alt=""></p>
<ul>
<li>address2(针对LDR(S)B)<ul>
<li>[Rn, #+/-offset_8]</li>
<li>[Rn,+/-Rm]</li>
<li>[Rn, #+/-offset_8]!</li>
<li>[Rn,+/-Rm]!</li>
<li>[Rn], #+/-offset_8</li>
<li>[Rn],+/-Rm</li>
</ul>
</li>
</ul>
<p><strong>下列指令，哪些是正确的？</strong></p>
<pre><code>LDR r1, r2, r3            错，r2加[]
LDR r1,[r2, #0x111]        对，符合12位
LDR r1,[r2], +#0x11111    错，超出12位
LDRSB r1,[r2], -#0x111    错，SB只支持8位
LDRH [r1],r2            对
LDRSH r1,[r2,r3]        对
LDRB r1,[r2,-r3]        对
</code></pre><h4 id="写（Register-gt-Memory）"><a href="#写（Register-gt-Memory）" class="headerlink" title="写（Register->Memory）"></a>写（Register-&gt;Memory）</h4><table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>STR</td>
<td>Rd-&gt;mem32[add]</td>
</tr>
<tr>
<td>STRB</td>
<td>Rd-&gt;mem8[add]</td>
</tr>
<tr>
<td>STRH</td>
<td>Rd-&gt;mem16[add]</td>
</tr>
</tbody></table>
<pre><code>STR{&lt;cond&gt;}{B} rd, addressing1
STR{&lt;cond&gt;}{H} rd, addressing2</code></pre><blockquote>
<p><strong>ldr  vs  str ?</strong> </p>
<p><strong>为什么没有strsb和strsh?</strong></p>
</blockquote>
<p><strong>双字访问</strong></p>
<p>语法</p>
<pre><code>LDR|STR{cond}D Rd, [Rn]
LDR|STR{cond}D Rd, [Rn, Offset]{!}
LDR|STR{cond}D Rd, label
LDR|STR{cond}D Rd, [Rn], Offset</code></pre><p>例：</p>
<pre><code>LDRD    r6,[r11]        ;隐含r7,r7 = r11+4
STRD    r4,[r9,#24]
STRD    r0,abcd
LDRD    r1,[r6]        ; Rd 必须为偶数
STRD    r14,[r9,#36]   ; Rd 不能是R14.读可以写不可以
STRD    r2,[r3],r6     ; Rn 不能是 Rd 或 R(d+1).</code></pre><blockquote>
<p>D表示读两个32位，两个字，第一个寄存器是偶数，一个字32位，半字16位</p>
<p>注：32位CPU的话，一个字是32位，正常16位CPU一个字16位</p>
<p>两个数字同时读取到寄存器中嘛？为什么？</p>
<p>一般一条总线或同一区间时，分先后</p>
</blockquote>
<p><strong>交换数据</strong></p>
<p>指令</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>Operation</th>
</tr>
</thead>
<tbody><tr>
<td>SWP</td>
<td>tmp=mem32[Rn]  Mem32[Rn]=Rm  Rd=tmp</td>
</tr>
<tr>
<td>SWPB</td>
<td>tmp=mem8[Rn]  Mem8[Rn]=Rm  Rd=tmp</td>
</tr>
</tbody></table>
<p>格式</p>
<pre><code>SWP {B} {&lt;cond&gt;} Rd, Rm, [Rn]</code></pre><p><strong>分析下列指令的执行结果</strong></p>
<pre><code>mem32[0x8000]=0x12345678
R0=0x00000000
R1=0x22223333
R2=0x8000

SWP r0, r1, [r2]

mem32[0x8000]=?    0x22223333
R0=?            0x12345678
R1=?            0x22223333
R2=?            0x8000</code></pre><p><strong>结构访问</strong></p>
<pre><code>//C
origin.x = 0;
origin.y = 2;
origin.z = 3;

//asm
        LDR     PointBase,=origin
        MOV    r0,#0
        STR     r0,Point_x
        MOV    r0,#2
        STR     r0,Point_y
        MOV    r0,#3
        STR     r0,Point_z</code></pre><p><strong>如何实现数据在内存中的移动？</strong></p>
<h3 id="批量读写"><a href="#批量读写" class="headerlink" title="批量读写"></a><strong>批量读写</strong></h3><pre><code>//c/c++    
    memcpy(Inimage,Tmpimg,160*120);

//asm    
    ldr     r10,     =160*120
memcpy    
    ldmia    r8! ,    {r0-r7}    ;r8!地址寄存器
    stmia    r9! ,    {r0-r7}
    subs    r10,r10, #8*4
    bgt    memcpy
</code></pre><h4 id="多存储器数据传送"><a href="#多存储器数据传送" class="headerlink" title="多存储器数据传送"></a><strong>多存储器数据传送</strong></h4><p>指令</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104193015915.png" alt=""></p>
<p>格式</p>
<ul>
<li>LDM|STM{cond}address-mode Rn{!},reg-list{^}<ul>
<li>Cond: condition code. </li>
<li>address-mode: the mode of change address.</li>
<li>Rn: base register for the load operation. </li>
<li>^ : includes lr and spsr ；注意，cpsr切换异常模式</li>
</ul>
</li>
</ul>
<p><strong>地址变化方式</strong></p>
<table>
<thead>
<tr>
<th><strong>符号</strong></th>
<th><strong>变化方式</strong></th>
<th><strong>数据起始地址</strong></th>
<th><strong>数据结束地址</strong></th>
<th><strong>Rn!</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>IA</strong></td>
<td><strong>后增加</strong></td>
<td><strong>Rn</strong></td>
<td><strong>Rn+4N-4</strong></td>
<td><strong>Rn+4N</strong></td>
</tr>
<tr>
<td><strong>IB</strong></td>
<td><strong>先增加</strong></td>
<td><strong>Rn+4</strong></td>
<td><strong>Rn+4N</strong></td>
<td><strong>Rn+4N</strong></td>
</tr>
<tr>
<td><strong>DA</strong></td>
<td><strong>后减少</strong></td>
<td><strong>Rn-4N+4</strong></td>
<td><strong>Rn</strong></td>
<td><strong>Rn-4N</strong></td>
</tr>
<tr>
<td><strong>DB</strong></td>
<td><strong>先减少</strong></td>
<td><strong>Rn-4N</strong></td>
<td><strong>Rn-4</strong></td>
<td><strong>Rn-4N</strong></td>
</tr>
</tbody></table>
<p><strong>解释下列指令</strong></p>
<pre><code>LDMIA r1, {r0, r2-r7}    ;共7个
STMIA r1!, {r2,r3}
LDMDA r3, {r4-r7}
STMDA r3!, {r4-r7}
LDMIB r1, {r2, r3}
STMIB r1!, {r2,r3,r7, r10}
LDMDB r3, {r4-r7}
STMDB r3!, {r4-r7}</code></pre><blockquote>
<p><strong>！表示寄存器读写完最后地址写入</strong></p>
</blockquote>
<p><strong>这两条指令的执行结果相同吗？</strong></p>
<pre><code>LDMIA r0, {r1, r2, r3, r4} 
LDMIA r0, {r4, r3, r1, r2}</code></pre><p>运行下列程序，看结果</p>
<pre><code>    area datarw , code , readonly, align=3
    entry    
    ldr r0,=dmem    
    LDMIA r0, {r1, r2, r3, r4}
    nop
    LDMIA r0, {r4, r3, r1, r2}
stop
        b stop
dmem     dcd 0x1234,0x2345,0x3456,0x5678
    end</code></pre><p><strong>内存中的地址顺序与寄存器序号对应，与列表中的次序无关！</strong></p>
<p><strong>根据图中内存和寄存器的初始值，分析下列指令的执行结果</strong></p>
<pre><code>R0=0x80020
R1=0x1111
R2=0x2222
R3=0x3333</code></pre><table>
<thead>
<tr>
<th><strong>Mem  add</strong></th>
<th><strong>data</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>0x80030</strong></td>
<td><strong>0x009</strong></td>
</tr>
<tr>
<td><strong>0x8002c</strong></td>
<td><strong>0x008</strong></td>
</tr>
<tr>
<td><strong>0x80028</strong></td>
<td><strong>0x007</strong></td>
</tr>
<tr>
<td><strong>0x80024</strong></td>
<td><strong>0x006</strong></td>
</tr>
<tr>
<td><strong>0x80020</strong></td>
<td><strong>0x005</strong></td>
</tr>
<tr>
<td><strong>0x8001c</strong></td>
<td><strong>0x004</strong></td>
</tr>
<tr>
<td><strong>0x80018</strong></td>
<td><strong>0x003</strong></td>
</tr>
<tr>
<td><strong>0x80014</strong></td>
<td><strong>0x002</strong></td>
</tr>
<tr>
<td><strong>0x8000c</strong></td>
<td><strong>0x001</strong></td>
</tr>
<tr>
<td><strong>0x80008</strong></td>
<td><strong>0x000</strong></td>
</tr>
</tbody></table>
<pre><code>LDMIA r0!,{r1-r3} r0=0x8002c,r1=0x005,r2=0x006
LDMDA r0, {r3,r2} 
LDMIB r0!,{r1-r3} r0=0x80030,r1=0x006,r2=0x007
LDMDB r0, {r3,r2}
STMIA r0!,{r1-r3}
STMDA r0, {r3,r2}
STMIB r0!,{r1-r3}
STMDB r0, {r3,r2}</code></pre><h4 id="堆栈操作"><a href="#堆栈操作" class="headerlink" title="堆栈操作"></a><strong>堆栈操作</strong></h4><ul>
<li><p>堆栈的物理位置？</p>
</li>
<li><p>sp?</p>
</li>
<li><p>属性 ：基址，指针和限制</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>符号</th>
<th>功能</th>
<th>pop</th>
<th>=LDM</th>
<th>push</th>
<th>=STM</th>
</tr>
</thead>
<tbody><tr>
<td>FA</td>
<td>Full  In</td>
<td>LDMFA</td>
<td>LDMDA</td>
<td>STMFA</td>
<td>STMIB</td>
</tr>
<tr>
<td>FD</td>
<td>Full de</td>
<td>LDMFD</td>
<td>LDMIA</td>
<td>STMFD</td>
<td>STMDB</td>
</tr>
<tr>
<td>EA</td>
<td>Empty  In</td>
<td>LDMEA</td>
<td>LDMDB</td>
<td>STMEA</td>
<td>STMIA</td>
</tr>
<tr>
<td>ED</td>
<td>Empty de</td>
<td>LDMED</td>
<td>LDMIB</td>
<td>STMED</td>
<td>STMDA</td>
</tr>
</tbody></table>
<pre><code>R1=0x005
R3=0x004
SP=0x80014

STMFD sp!,{r1, r3}</code></pre><p><img src="/images/loading.gif" data-original="../images/basic/image-20211104193640268.png" alt=""></p>
<p><strong>设定sp时如何确定初始值？</strong></p>
<p><strong>R13,必须有效内存空间</strong></p>
<h2 id="标签命名"><a href="#标签命名" class="headerlink" title="标签命名"></a>标签命名</h2><p>标签ARM 汇编程序中自定义符号（label, variables, constant等）有限制吗?</p>
<h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a><strong>规则</strong></h3><ul>
<li>Can use uppercase letters, lowercase letters, numeric characters, or the underscore character in symbol names.</li>
<li>Do not use numeric characters for the first character of symbol names, except in local labels (see Local labels).</li>
<li>Symbol names are case-sensitive.</li>
<li>All characters in the symbol name are significant.</li>
<li>Symbol names must be unique within their scope.</li>
<li>Symbols must not use built-in variable names or predefined symbol names </li>
</ul>
<p><strong>保留的（predefined）字</strong></p>
<ul>
<li><p>register names</p>
</li>
<li><p>r0-r15 and R0-R15</p>
</li>
<li><p>a1-a4 (argument, result, or scratch registers, synonyms for r0 to r3)</p>
</li>
<li><p>v1-v8 (variable registers, r4 to r11)</p>
</li>
<li><p>sb and SB (static base, r9)</p>
</li>
<li><p>sl and SL (stack limit, r10)</p>
</li>
<li><p>fp and FP (frame pointer, r11)</p>
</li>
<li><p>ip and IP (intra-procedure-call scratch register, r12)</p>
</li>
<li><p>sp and SP (stack pointer, r13)</p>
</li>
<li><p>lr and LR (link register, r14)</p>
</li>
<li><p>pc and PC (program counter, r15).</p>
</li>
<li><p>program status register names</p>
<ul>
<li>cpsr and CPSR (current program status register)</li>
<li>spsr and SPSR (saved program status register).</li>
</ul>
</li>
<li><p>floating-point register names</p>
<ul>
<li>f0-f7 and F0-F7 (FPA registers)</li>
<li>s0-s31 and S0-S31 (VFP single-precision registers)</li>
<li>d0-d15 and D0-D15 (VFP double-precision registers).</li>
</ul>
</li>
<li><p>coprocessor names</p>
<ul>
<li>p0-p15 (coprocessors 0-15)</li>
<li>c0-c15 (coprocessor registers 0-15).</li>
</ul>
</li>
</ul>
<p><strong>下列自定义符号哪些是正确的？</strong></p>
<pre><code>SPSR        错
Cpsr        对    
MOV
Add
Codesize
moV
||ASSERT||    对    ?
8_123d        错
102srd        错
</code></pre><h2 id="预计算"><a href="#预计算" class="headerlink" title="预计算"></a>预计算</h2><p><strong>指令 “ subs  r10, r10, #8<em>4”中，“ 8</em>4” 在什么时候计算？</strong></p>
<p><strong>汇编器中计算，非处理器计算</strong></p>
<h3 id="双目计算"><a href="#双目计算" class="headerlink" title="双目计算"></a><strong>双目计算</strong></h3><ul>
<li><p>算术运算：+，-，*，/，MOD</p>
<p> MOV r0, #(5*4)</p>
<p> LDR R0, =start+3*n</p>
</li>
<li><p>移位运算：ROL, ROR, SHL, SHR</p>
<p> A:ROL:B </p>
<p> (3: ROR:4)</p>
</li>
<li><p>逻辑运算：AND, OR, EOR</p>
<p> A: AND:B</p>
<p> (0xcc55:OR:0x55cc)</p>
</li>
<li><p>关系运算：=，&lt;, &gt;, &gt;=, &lt;=, &lt;&gt;, /=</p>
<p> A&lt;&gt;B</p>
<p> (7&lt;&gt;7)</p>
</li>
</ul>
<h3 id="单目运算"><a href="#单目运算" class="headerlink" title="单目运算"></a><strong>单目运算</strong></h3><table>
<thead>
<tr>
<th>运算符</th>
<th>用法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>？</td>
<td>？A</td>
<td>A所在行的代码长度</td>
</tr>
<tr>
<td>BASE</td>
<td>:BASE:A</td>
<td>（寄存器或程序相对表示）A的基地址寄存器</td>
</tr>
<tr>
<td>INDEX</td>
<td>:INDEX:A</td>
<td>（寄存器相对表示）A的偏移地址</td>
</tr>
<tr>
<td>+/-</td>
<td>+A, -A</td>
<td>正负号</td>
</tr>
<tr>
<td>NOT</td>
<td>:NOT:A</td>
<td>按位取反</td>
</tr>
<tr>
<td>LNOT</td>
<td>:LNOT:A</td>
<td>逻辑取反</td>
</tr>
<tr>
<td>DEF</td>
<td>:DEF:A</td>
<td>A是否定义，{TRUE/FALSE}</td>
</tr>
<tr>
<td>SB_OFFSET_19_12</td>
<td>:SB_OFFSET_19_12:label</td>
<td>label-sb的bits[19:12]</td>
</tr>
<tr>
<td>SB_OFFSET_11_0</td>
<td>:SB_OFFSET_11_0: label</td>
<td>label-sb的bits[11:0]</td>
</tr>
</tbody></table>
<p>确定运行时寄存器中的数据（汇编后的结果）</p>
<p>Example1</p>
<pre><code>     LDR r0, =? Mydata         ;10*4=40；
     (LDR r0, =mydata)?         ;没有？则读取的是label地址
     LDR r1, =? Mydata1         ;1*4=4

 mydata    DCD 1,2,3,4,5,6,7,8,9,0
 Mydata1   DCB ‘a’, ‘b’, ‘c’, ‘d’</code></pre><p>Example 2</p>
<pre><code>datastruc         SPACE   280    
                MAP        0,r8 ; (MAP datastruc) ?
       consta               FIELD   4
       constb             FIELD   4
         x                        FIELD   8
         y              FIELD   8
      string                 FIELD   256
              ……
                            LDR r3,=:BASE:y
                              LDR r4,=:INDEX:y
</code></pre><h3 id="逻辑变量"><a href="#逻辑变量" class="headerlink" title="逻辑变量"></a><strong>逻辑变量</strong></h3><ul>
<li>LAND  (处理器指令？）</li>
<li>LOR</li>
<li>LEOR</li>
</ul>
<p><strong>字符串变量</strong></p>
<p><strong>双目运算运算符</strong></p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>用法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LEFT</td>
<td>A:LEFT:B</td>
<td>返回字符串A中左起的B个字符</td>
</tr>
<tr>
<td>RIGHT</td>
<td>A:RIGHT:B</td>
<td>返回字符串A中右起的B个字符</td>
</tr>
<tr>
<td>CC</td>
<td>A:CC:B</td>
<td>A和B字符串相连接，A在左边</td>
</tr>
</tbody></table>
<p><strong>单目运算运算符</strong></p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>用法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LEN</td>
<td>:LEN:A</td>
<td>返回字符串A的长度</td>
</tr>
<tr>
<td>CHR</td>
<td>:CHR:A</td>
<td>反回字符A的ASCII码值，A是单个字符</td>
</tr>
<tr>
<td>STR</td>
<td>:STR:A</td>
<td>返回数值或逻辑A的字符串</td>
</tr>
</tbody></table>
<p><strong>Example</strong></p>
<ul>
<li>：LEN：”I am an excellent student!”</li>
<li>: CHR: ‘A’</li>
<li>What is the returned result?</li>
</ul>
<h2 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a><strong>宏定义</strong></h2><p><strong>封装汇编指令模块，作为用户定义的功能单元</strong></p>
<p>ARM格式</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104195426365.png" alt=""></p>
<p>GNU格式</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104195451041.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104195635651.png" alt=""></p>
<blockquote>
<p><strong>不建议在宏内使用固定寄存器，例如v8。</strong></p>
<p><strong>一般定义变量使用</strong></p>
</blockquote>
<h2 id="数值计算"><a href="#数值计算" class="headerlink" title="数值计算"></a><strong>数值计算</strong></h2><h3 id="64位整数加（减）法"><a href="#64位整数加（减）法" class="headerlink" title="64位整数加（减）法"></a>64位整数加（减）法</h3><ul>
<li><p>实现64位数0x2200330044和0x9876543210的加（减）法，相加后的结果保存在起始地址为0x20000000的存储空间里。设数据存储采用小端格式。</p>
</li>
<li><p>如何用32位加法器实现64位加法运算？</p>
</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">LDR R0, =0x00000022 ；加载第一个数的高32位放到R0中
LDR R1, =0x00330044  ；加载第一个数的低32位放到R1中
LDR R2, =0x00000098 
LDR R3, =0x76543210 
LDR R6, =0x20000000  ；把存储结果的内存地址放到R6中
ADDS R4, R1, R3（ SUBS R4, R1, R3 ） ;低32位加（减），R4存储低32位
ADC R5, R0, R2 （ SUBC R5, R0, R2 ） ;高32位加（减），R5存储高32位
STMIA R6!,{R4,R5}  ；将R4，R5的数据存储到R6指向的地址上，
                   ；R6值更新<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>一般寄存器大的放高位，这里反了</li>
<li>两数相减大于0，借位为1</li>
<li>借位：A-B-！C</li>
</ul>
<h3 id="64位乘法"><a href="#64位乘法" class="headerlink" title="64位乘法"></a>64位乘法</h3><p><strong>2个无符号64位数a 和 b相乘，得到64位结果</strong></p>
<ul>
<li><p>函数参数的传递方式</p>
<ul>
<li>寄存器 r0-r3 （数目&lt;=4）</li>
<li>堆栈 （&gt;4）</li>
</ul>
</li>
<li><p>返回</p>
<p>​    r0, r1</p>
</li>
<li><p>算法:</p>
<p> <code>H1L1 *H2L2=L1*L2 +(L1*H2)&lt;&lt;32+ (H1*L2)&lt;&lt;32+(H1*H2)&lt;&lt;64</code></p>
</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">a_0     RN    0       ;a low
a_1    RN     1    ;a high
b_0     RN    2    ;b low
b_1    RN     3    ;b high
c_0     RN    4    ;c low low
c_1    RN     5    ;c low high
c_2     RN    12    ;c high low
c_3    RN     14    ;c high high
Mul_64 to 64
        stmfd    sp!, {r4,r5,lr}
        umull    c_0,c_1, a_0, b_0     ;low *low 
        mla    c_1, a_0,b_1,c_1    ;low *high
        mla     c_1, a_1, b_0, c_1    ;high* low

        mov     r0, c_0
        mov    r1, c_1            ;return<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>2个有符号64位数a 和 b相乘，得到128位结果</strong></p>
<ul>
<li>算法:</li>
</ul>
<p><code>(S)H1L1 *(S)H2L2=L1*L2 +(L1*(S)H2)&lt;&lt;32+((S)H1*L2)&lt;&lt;32+((S)H1*(S)H2)&lt;&lt;64</code></p>
<ul>
<li><p>无符号乘法: UMULL, UMLAL</p>
</li>
<li><p>有符号乘法: SMULL, SMLAL</p>
</li>
<li><p>有符号* 无符号？</p>
</li>
</ul>
<p><strong>64位乘法</strong></p>
<p>设 A为无符号数， B为有符号数，用SMULL或SMLAL计算，则结果如何？</p>
<p>（1）如果A[31]=0，则<code>(S)A * (S)B= A*(S)B</code></p>
<p>（2）如果A[31]=1, 则<code>(S)A * (S)B= (A-232)*(S)B</code></p>
<pre><code>                                  `A*(S)B = (S)A * (S)B+(1&lt;&lt;32) *(S)B`</code></pre><p>宏定义 USMLAL（无符号*有符号）</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">MACRO
    USMLAL    $cl, $ch, $a, $b    
    ;signed $ch, $cl +=unsigned $a *signed $b
    SMULL        $cl, $ch, $a, $b
    ;c= (signed)a *(signed)b
    TST        $a, #1<<31
    ;if(signed)a<0
    ADDNE          $ch, $ch, $b
    ;c+=(b<<32)
    MEND    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly"><code class="language-assembly">    smul_64_to_128
    stmfd    sp!, {r4, r5, lr}
    umull     c_0, c_1, a_0, b_0     ;low*low
    mov     c_2, #0
    usmlal    c_1, c_2, a_0, b_1    ;low*high
    mov    c_3, #0
    usmlal    c_1, c_3, b_0, a_1    ;high*low
    mov    a_0, c_2, ASR #31
    adds     c_2, c_2, c_3
    adc    c_3, a_0, c_3, ASR #31
    smlal    c_2, c_3, a_1, b_1    ;high*high
    mov    r0, c_0
    mov    r1, c_1
    mov    r2, c_2
    mov    r3, c_3
    ldmfd    sp!,{r4, r5, pc}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>宏定义 USMLAL（无符号*有符号）</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">    MACRO
    USMLAL    $cl, $ch, $a, $b    
    ;signed $ch, $cl +=unsigned $a *signed $b
    SMULL        $cl, $ch, $a, $b
    ;c= (signed)a *(signed)b
    TST        $a, #1<<31
    ;if(signed)a<0
    ADDNE          $ch, $ch, $b
    ;c+=(b<<32)
    MEND    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="浮点计算"><a href="#浮点计算" class="headerlink" title="浮点计算"></a>浮点计算</h3><ul>
<li>IEEE754浮点格式</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104201237806.png" alt=""></p>
<ul>
<li>浮点数与实数的转换<ul>
<li>单精度转换公式</li>
<li><code>V=(-1)^S*2^(E（值）-127)*(1+M)  (指数位!=0)</code></li>
<li><code>V=(-1)^S*2^(1-127)*M (指数位=0)</code></li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104201344272.png" alt=""></p>
<h3 id="浮点加法"><a href="#浮点加法" class="headerlink" title="浮点加法"></a><strong>浮点加法</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211104201406193.png" alt=""></p>
<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a><strong>小结</strong></h2><p><img src="/images/loading.gif" data-original="../images/basic/image-20211104201417404.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211104201426223.png" alt=""></p>
<p><strong>分析下列程序的功能</strong></p>
<pre class="line-numbers language-assembly"><code class="language-assembly">    AREA    Block, CODE, READONLY    ; name this block of code
num       EQU     20                       ; set number of words to be copied
    ENTRY                            ; mark the first instruction to call
start
    LDR     r0, =src                 ; r0 = pointer to source block
    LDR     r1, =dst                 ; r1 = pointer to destination block
    MOV     r2, #num                 ; r2 = number of words to copy
    MOV     sp, #0x400               ; Set up stack pointer (r13)
blockcopy   
    MOVS    r3,r2, LSR #3     ; Number of eight word multiples
    BEQ     copywords                ; Less than eight words to move?
    STMFD   sp!, {r4-r11}            ; Save some working registers

octcopy  LDMIA   r0!, {r4-r11}            ; Load 8 words from the source
     STMIA   r1!, {r4-r11}            ; and put them at the destination
     SUBS    r3, r3, #1               ; Decrement the counter
     BNE     octcopy                  ; ... copy more
     LDMFD   sp!, {r4-r11}      ; Don't need these now - restore
                                                     ; originals
copywords   
    ANDS    r2, r2, #7               ; Number of odd words to copy
     BEQ     stop                     ; No words left to copy?

wordcopy    LDR     r3, [r0], #4     ; Load a word from the source  and
       STR     r3, [r1], #4             ; store it to the destination
       SUBS    r2, r2, #1               ; Decrement the counter
       BNE     wordcopy                 ; ... copy more
stop             MOV     r0, #0x18                ; 
       LDR     r1, =0x20026          ; ADP_Stopped_ApplicationExit
       SWI     0x123456                 ; ARM semihosting SWI

      AREA    BlockData, DATA, READWRITE
src               DCD     1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4
dst               DCD     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
                END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>C程序</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>      <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Inimage<span class="token punctuation">[</span><span class="token number">480</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> Tmpimg<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">160</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">120</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
         <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">160</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>                
               Tmpimg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>Inimage<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token function">memcpy</span><span class="token punctuation">(</span>Inimage<span class="token punctuation">,</span>Tmpimg<span class="token punctuation">,</span><span class="token number">160</span><span class="token operator">*</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>汇编</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">Imageheight    equ    120
Imagewidth    equ    160
InImagewidth     equ        640
         area    reset , code , readonly                               
         entry        
        mov    r6, #0
Framecircle 
    mov    r5, #0
Linecircle
;i->r5; j->r6; Tmpimg-> r8; Inimage->r9;
    ldr    r8,    =Tmpimg
    ldr    r9,    =Inimage
;Tmpimg[i][j]->r10;
    mov    r0,    #Imagewidth
    mul    r10, r6, r0   ;i*Imagewidth
    add    r10, r10, r5   ;i*Imagewidth+j
    add    r10,r8

;Inimage[i*4+2][j*4+2]-> r11
    mov r0, #InImagewidth
    mov    r1, r6, lsl #2 ; i*4
    add    r1, r1, #2    ;i*4+2
    mul    r11, r1, r0    ;(i*4+2)*InImagewidth
    mov    r1, r5, lsl #2 ;j*4
    add    r1, r1, #2    ;j*4+2
    add    r11, r11, r1; (i*4+2)*InImagewidth+4*j+2
    add    r11, r9
    ldrb    r0, [r11] ;read Inimage
    strb    r0, [r10] ;write Tmpimg
;circle control
        add r5, r5,#1
        cmp r5, #Imagewidth
      bmi  Linecircle
        add r6, r6, #1
        cmp r6, #Imageheight
        bmi Framecircle

; memcpy    
    ldr     r10,     =160*120
memcpy    
    ldmia    r8! ,    {r0-r7}
    stmia    r9! ,    {r0-r7}
    subs    r10,r10, #8*4
    bgt    memcpy
    ;end

    area  imscale，data, readwrite

Tmpimg    space        160*120
Inimage    space        640*480

    end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ARM程序基础"><a href="#ARM程序基础" class="headerlink" title="ARM程序基础"></a>ARM程序基础</h1><p>参考内容：</p>
<ul>
<li><p>ARM Architecture Reference Manual（V5）, Second Edition</p>
</li>
<li><p>Andrew N. Sloss 等，沈建华译，ARM嵌入式系统开发-软件设计与优化，北京航空航天大学出版社，2005年5月</p>
</li>
</ul>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a><strong>函数调用</strong></h2><h3 id="源文件内"><a href="#源文件内" class="headerlink" title="源文件内"></a><strong>源文件内</strong></h3><pre><code>    AREA  function, CODE, READONLY
    ENTRY
start
           MOV     r0, #10
        MOV     r1, #3         ;参数
        BL      doadd            ; call

    ……

doadd                               ;函数
        ADD     r0, r0, r1          ;结果
        MOV     pc, lr                ;返回

        END</code></pre><h3 id="不同源文件"><a href="#不同源文件" class="headerlink" title="不同源文件"></a><strong>不同源文件</strong></h3><ul>
<li>File1</li>
</ul>
<pre><code>AREA Main, CODE, READONLY
    IMPORT   Testprg
    ENTRY     
main        ……
        BL Testprg
        ……
        END</code></pre><ul>
<li>File2</li>
</ul>
<pre><code>    AREA  Test, CODE, READONLY
    EXPORT   Testprg
   Testprg
        ADD  r0, r1, r0
        MOV pc,lr
        END</code></pre><blockquote>
<p>汇编import的函数文件需要加export</p>
</blockquote>
<h3 id="ATPCS（ARM-Thumb-Procedure-Call-Standard）"><a href="#ATPCS（ARM-Thumb-Procedure-Call-Standard）" class="headerlink" title="ATPCS（ARM-Thumb Procedure Call Standard）"></a>ATPCS（ARM-Thumb Procedure Call Standard）</h3><ul>
<li><p>寄存器约定</p>
<ul>
<li><p>R0-r3 (a1-a4) 传递参数</p>
</li>
<li><p>R4-r11 (v1-v8)保存局部变量 （r4-r7 for Thumb)</p>
</li>
<li><p>R12 (ip) 过程间自定义数据交换</p>
</li>
<li><p>R13 (sp) 数据堆栈指针</p>
</li>
<li><p>R14 (lr) 保存子程序的返回地址</p>
</li>
<li><p>R15（pc）</p>
</li>
</ul>
</li>
<li><p>ATPCS规定数据栈为FD（满递减）类型，并且对数据栈的操作是8字节对齐。</p>
</li>
</ul>
<blockquote>
<p>向堆栈写数据，指针减小；数据栈8字节对齐</p>
</blockquote>
<ul>
<li>参数传输规则<ul>
<li>小于等于4， r0-r3,依次</li>
<li>大于4，存入数据栈，最后一个数据先入栈</li>
</ul>
</li>
</ul>
<p><code>function( char a, int *b, int c, short d, long f)</code></p>
<blockquote>
<ul>
<li>参数次序与所使用的寄存器？</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>寄存器的分配与类型（浮点除外）有关？</li>
</ul>
</blockquote>
<ul>
<li>浮点参数传递(顺序传递)<ul>
<li>FPA (Floating Point Arithmetic)：f0-f7 (s0-s7, d0-d7,e0-e7)</li>
<li>VFP (d0-d15, s0-s31)</li>
</ul>
</li>
</ul>
<p><code>float function(int v1, float v2, char *v3, int v4, float v5, double v6, short v7) ；</code></p>
<ul>
<li><p>v1, v3, v4, v7  =&gt; r0, r1, r2, r3</p>
</li>
<li><p>v2, v5 =&gt; s0, s1</p>
</li>
<li><p>v6 =&gt; d0</p>
</li>
</ul>
<blockquote>
<p>继承协处理器</p>
<p>注意参数传递：整形（字符），float，double</p>
</blockquote>
<ul>
<li><p>参数返回规则</p>
<ul>
<li><p>结果为32bit整数时，通过r0传递</p>
</li>
<li><p>结果为64bit整数时，通过r0和R1传递</p>
</li>
<li><p>结果为浮点数时，通过浮点寄存器返回(f0,d0)</p>
</li>
<li><p>更多的数据通过内存返回</p>
</li>
</ul>
</li>
</ul>
<h3 id="C调用汇编"><a href="#C调用汇编" class="headerlink" title="C调用汇编"></a>C调用汇编</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">strcopy</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ASM</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>       <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>srcstr <span class="token operator">=</span> <span class="token string">"First string - source "</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> dststr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Second string - destination "</span><span class="token punctuation">;</span>
        <span class="token function">strcopy</span><span class="token punctuation">(</span>dststr<span class="token punctuation">,</span>srcstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After copying:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  %s\n  %s\n"</span><span class="token punctuation">,</span>srcstr<span class="token punctuation">,</span>dststr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly"><code class="language-assembly">        AREA    SCopy, CODE, READONLY
            EXPORT strcopy
strcopy 
        LDRB r2, [r1],#1  ; Load byte and update address.
           STRB r2, [r0],#1  ; 
        CMP r2, #0        ; Check for zero terminator.
            BNE strcopy       ; Keep going if not.
            MOV pc,lr         ; Return.
            END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>参数传递过程？</strong></p>
<h3 id="汇编调用C"><a href="#汇编调用C" class="headerlink" title="汇编调用C"></a>汇编调用C</h3><pre class="line-numbers language-assembly"><code class="language-assembly">    AREA f, CODE, READONLY
        IMPORT  g
    ENTRY           
        LDR r4, =data
        LDR  r0, [r4], #4
    LDR  r1, [r4], #4
    LDR  r2, [r4], #4
    LDR  r3, [r4], #4
    LDR  r5, [r4]
    STR r5, [sp, #-4]! 
    BL  g               
       ADD sp, sp, #4     
       END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> d<span class="token punctuation">,</span> <span class="token keyword">int</span> e<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token operator">+</span> d <span class="token operator">+</span> e<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>STR r5, [sp, #-4]!     //栈初始满的，需要减去4字节腾出空间</p>
</blockquote>
<h3 id="C-调用汇编"><a href="#C-调用汇编" class="headerlink" title="C++调用汇编"></a>C++调用汇编</h3><pre class="line-numbers language-c++"><code class="language-c++">struct S { 
        S(int s) {i=s; }
        int i;
    }

extern "C" void asmfunc(S *);                                                     
int f() 
{
        S s(2);                 
        asmfunc(&s); 
    return s.i * 3;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-assembly"><code class="language-assembly">AREA   Asm, CODE
        EXPORT asmfunc
asmfunc            ; the definition of the Asm function
        LDR r1, [r0] 
    ADD r1, r1, #5
        STR r1, [r0]
        MOV pc, lr
        END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="汇编调用C-1"><a href="#汇编调用C-1" class="headerlink" title="汇编调用C++"></a>汇编调用C++</h3><pre class="line-numbers language-assembly"><code class="language-assembly">    AREA  Asm, CODE，READONLY
        IMPORT cppfunc
    ENTRY
    MOV    r0,#2
        STR    r0,[sp,#-4]! 
        MOV    r0,sp        
        BL     cppfunc 
    LDR    r0, [sp], #4
        ADD    r0, r0, r0,LSL #1
    END
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c++"><code class="language-c++">extern "C" void cppfunc(S * p) {
 // Definition of the C++ function to be called from ASM.
    p->i += 5;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="嵌入汇编"><a href="#嵌入汇编" class="headerlink" title="嵌入汇编"></a><strong>嵌入汇编</strong></h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">my_strcpy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span>
<span class="token punctuation">{</span>    <span class="token keyword">int</span> ch<span class="token punctuation">;</span>
        __asm<span class="token punctuation">{</span>
            loop<span class="token punctuation">:</span>
               LDRB    ch<span class="token punctuation">,</span> <span class="token punctuation">[</span>src<span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">1</span>
                      STRB    ch<span class="token punctuation">,</span> <span class="token punctuation">[</span>dst<span class="token punctuation">]</span><span class="token punctuation">,</span> #<span class="token number">1</span>
              CMP     ch<span class="token punctuation">,</span> #<span class="token number">0</span>
                     BNE     loop
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>嵌入 vs 汇编程序<ul>
<li>不支持 LDR Rn,= XXX 和 ADR, ADRL 伪指令</li>
<li>不支持 BX</li>
<li>用”&amp;”替代 “0x” 表示16位数据</li>
</ul>
</li>
</ul>
<blockquote>
<p>[src], [dst]  ？</p>
<p>ch ？</p>
<p>循环结束条件？</p>
<p>c中的变量？</p>
</blockquote>
<ul>
<li>小心使用寄存器，尽量不用 R0-R3，lr，ip 和CPSR 中的NZCV 标志位；不用r0-r3，用v1-v8</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c">__asm
<span class="token punctuation">{</span>
    MOV R0<span class="token punctuation">,</span> x
    ADD y<span class="token punctuation">,</span> R0<span class="token punctuation">,</span>  y
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>不要使用寄存器替代变量</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bad_f</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// x in R0</span>
<span class="token punctuation">{</span>          ……
            __asm <span class="token punctuation">{</span> 
               ADD R0<span class="token punctuation">,</span> R0<span class="token punctuation">,</span> #<span class="token number">1</span> ；wrongly asserts that x is still in R0    
           <span class="token punctuation">}</span>    
          <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// x in R0</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>无需保存和恢复寄存器</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>
           __asm<span class="token punctuation">{</span>
                STMFD sp<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>R0<span class="token punctuation">}</span> ；save R0 <span class="token operator">-</span> illegal<span class="token punctuation">:</span> read before write
                ADD R0<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">1</span>
                EOR x<span class="token punctuation">,</span> R0<span class="token punctuation">,</span> x
                LDMFD sp<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>R0<span class="token punctuation">}</span> ； restore R0 <span class="token operator">-</span> not needed<span class="token punctuation">.</span>    
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>汇编语言用“,”作为操作数分隔符。如果有C 或C++表达式作为操作数，必须用“( )”将其归约为一个汇编操作数。</li>
</ul>
<pre><code> __asm {ADD x, y, (f()+z)}</code></pre><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a><strong>异常处理</strong></h2><h3 id="异常向量表"><a href="#异常向量表" class="headerlink" title="异常向量表"></a><strong>异常向量表</strong></h3><table>
<thead>
<tr>
<th>向量地址</th>
<th>异常中断类型</th>
<th>异常中断模式</th>
<th>优先级</th>
</tr>
</thead>
<tbody><tr>
<td>0x0</td>
<td>Reset</td>
<td>特权（SVC)</td>
<td>1</td>
</tr>
<tr>
<td>0x4</td>
<td>Undefined  Instruction</td>
<td>未定义指令中止模式</td>
<td>6</td>
</tr>
<tr>
<td>0x08</td>
<td>SWI</td>
<td>特权模式</td>
<td>6</td>
</tr>
<tr>
<td>0x0c</td>
<td>Prefetch  Abort</td>
<td>中止模式</td>
<td>5</td>
</tr>
<tr>
<td>0x10</td>
<td>Data  Abort</td>
<td>中止模式</td>
<td>2</td>
</tr>
<tr>
<td>0x14</td>
<td>Reserved</td>
<td>未使用</td>
<td>未使用</td>
</tr>
<tr>
<td>0x18</td>
<td>IRQ中断</td>
<td>IRQ模式</td>
<td>4</td>
</tr>
<tr>
<td>0x1c</td>
<td>FIQ快速中断</td>
<td>FIQ模式</td>
<td>3</td>
</tr>
</tbody></table>
<p>确定优先级的作用？</p>
<ul>
<li><p>异常向量表特点</p>
<ul>
<li>异常事件与异常处理程序之间的对应关系；</li>
<li>向量表大小32个字节，每个异常向量占据4个字节；</li>
<li>每个字存放PC赋值的语句，或跳转指令；</li>
<li>通常存放在存储器地址的低端（或利用寄存器设置）</li>
</ul>
</li>
<li><p>向量表-LDR间接寻址</p>
</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">Vectors          LDR     PC, Reset_Addr           ；0x00  
                  LDR     PC, Undef_Addr
                   LDR     PC, SWI_Addr
                   LDR     PC, PAbt_Addr
                   LDR     PC, DAbt_Addr
                   NOP                                    ; Reserved Vector 
                   LDR     PC, IRQ_Addr
                   LDR     PC, FIQ_Addr
        ……                                 ; IRQ_Entry, 9条指令
        Reset_Addr          DCD     Reset_Handler
        Undef_Addr          DCD     Undef_Handler
        SWI_Addr            DCD     SWI_Handler
        PAbt_Addr           DCD     PAbt_Handler
        DAbt_Addr           DCD     DAbt_Handler
                    DCD     0                              ; Reserved Address 
        IRQ_Addr            DCD     IRQ_Handler
        FIQ_Addr            DCD     FIQ_Handler
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>LDR   PC, Reset_Addr 会相对寻址 Ldr [pc, #Reset_Addr to pc]</p>
<p>偏移不能超过4k</p>
</blockquote>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110203411716.png" alt=""></p>
<ul>
<li>向量表-B跳转</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">Vectors          
             B     Reset_Handler  ;0x00
              B     Undef_Handler
            B     SWI_Handler
               B     PAbt_Handler
               B     DAbt_Handler
            NOP                          ; Reserved Address 
            B     IRQ_Handler
            B     FIQ_Handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>B</p>
<ul>
<li><p>简单</p>
</li>
<li><p>跳转范围受限 （±32MB)</p>
</li>
</ul>
</li>
<li><p>使用LDR指令</p>
<ul>
<li><p>跳转范围不受限</p>
</li>
<li><p>额外空间存地址</p>
</li>
<li><p>地址存放在4KB范围以内</p>
</li>
</ul>
</li>
</ul>
<p>在这里， ”B” 能否改成”BL” ? </p>
<ul>
<li>向量表-伪指令LDR</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">Vectors          
              LDR PC, = Reset_Handler  ;0x00
               LDR PC, = Undef_Handler
            LDR PC, = SWI_Handler
                LDR PC, = PAbt_Handler
                LDR PC, = DAbt_Handler
            NOP                              ; Reserved Address 
             LDR PC, = IRQ_Handler
            LDR PC, = FIQ_Handler
                    ……                                 ; IRQ_Entry, 9条指令
        ltorg
        ;Reset_Addr          DCD     Reset_Handler
        ;Undef_Addr          DCD     Undef_Handler
        ;SWI_Addr            DCD     SWI_Handler
        ;PAbt_Addr           DCD     PAbt_Handler
        ;DAbt_Addr           DCD     DAbt_Handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>向量表/异常服务程序</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">        import  ISR_IRQ_Handler
Vectors          
             B     Reset_Handler  
              B     Undef_Handler
            B     SWI_Handler
               B     PAbt_Handler
               B     DAbt_Handler
            NOP    
            B     ISR_IRQ_Handler
            B     FIQ_Handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>中断服务程序一般没有参数不需要传回值，或通过内存传递</p>
</blockquote>
<p>能否在程序运行时注册（安装）异常服务程序？  </p>
<h3 id="注册异常服务程序"><a href="#注册异常服务程序" class="headerlink" title="注册异常服务程序"></a>注册异常服务程序</h3><p><strong>能直接写入文本格式程序源码？</strong></p>
<p>程序运行时，将指令 “B ISR_IRQ_Handler ”写入向量表中？ </p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110203822211.png" alt=""></p>
<blockquote>
<p>构建二进制指令，取高26位，偏移地址：中断向量-中断服务程序入口地址</p>
</blockquote>
<ul>
<li>步骤</li>
</ul>
<p>​    （1）读取中断处理程序的地址addr1</p>
<p>​    （2）将addr1减去该中断对应的中断向量的地址vector1</p>
<p>​    （3）addr=Addr1-vector1-8 (允许指令预取）</p>
<p>​    （4）addr LSR #2</p>
<p>​    （5）if(addr and 0xff000000 ==0)</p>
<p>​    （6）addr or 0xea00 0000</p>
<p>​    （7）结果写回中断向量表 </p>
<ul>
<li>安装函数</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">Install_Handler</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token operator">*</span>handlerloc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>vector<span class="token punctuation">)</span>
<span class="token punctuation">{</span>  
    <span class="token keyword">unsigned</span> vec<span class="token punctuation">,</span> oldvec<span class="token punctuation">;</span>
    vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>handlerloc <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>vector <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vec <span class="token operator">&amp;</span> <span class="token number">0xFF000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    vec <span class="token operator">=</span> <span class="token number">0xEa000000</span> <span class="token operator">|</span> vec<span class="token punctuation">;</span>
    oldvec <span class="token operator">=</span> <span class="token operator">*</span>vector<span class="token punctuation">;</span>
    <span class="token operator">*</span>vector <span class="token operator">=</span> vec<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>oldvec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token operator">*</span>irqvec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x18</span><span class="token punctuation">;</span>    
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> pIRQ_Handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>ISR_IRQ_handler    
<span class="token function">Install_Handler</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>pIRQ_Handler<span class="token punctuation">,</span> irqvec<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>中断向量表的基地址？</strong></p>
<p><strong>上述例程适用条件？跳转地址和向量表偏移地址不能超过正负32M</strong></p>
<p><strong>如果不能确定异常服务程序的地址范围，如何处理？</strong></p>
<p><strong>如果向量表采用”LDR”语句，需要修改”DCD” 后的地址, 如何做？</strong></p>
<ul>
<li>获取服务程序的入口地址；</li>
<li>确定异常向量对应的”DCD” 分配的存储地址；</li>
<li>将服务程序入口地址写入对应的存储单元；</li>
</ul>
<h3 id="中断向量扩展"><a href="#中断向量扩展" class="headerlink" title="中断向量扩展"></a><strong>中断向量扩展</strong></h3><p>实际处理器通常有多个外部中断 (IRQ, 外设， IO)，这些中断与其对应的服务程序如何关联？</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">INTOFFSET           EQU    0X4A000014  ;Address of Interrupt 
                            ;offset Register
IntVTAddress           EQU     0x33FFFF20

;Interrupt Vector Table Address                
HandleEINT0            EQU    IntVTAddress           
HandleEINT1            EQU    IntVTAddress +4
……
HandleTIMER0           EQU    IntVTAddress +4*10
HandleTIMER1           EQU    IntVTAddress +4*11
……
HandleUART1            EQU    IntVTAddress +4*23
……
HandleUART0           EQU    IntVTAddress +4*28
HandleADC             EQU    IntVTAddress +4*31<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c">IRQ_Entry
                          sub    sp<span class="token punctuation">,</span>sp<span class="token punctuation">,</span>#<span class="token number">4</span>       <span class="token punctuation">;</span>reserved <span class="token keyword">for</span> PC
                    stmfd    sp<span class="token operator">!</span><span class="token punctuation">,</span><span class="token punctuation">{</span>r8<span class="token operator">-</span>r9<span class="token punctuation">}</span>                
                    ldr    r9<span class="token punctuation">,</span><span class="token operator">=</span>INTOFFSET  <span class="token punctuation">;</span>中断序号
                    ldr    r9<span class="token punctuation">,</span><span class="token punctuation">[</span>r9<span class="token punctuation">]</span>
                    ldr    r8<span class="token punctuation">,</span><span class="token operator">=</span>HandleEINT0 <span class="token punctuation">;</span>中断扩展表首地址
                    add    r8<span class="token punctuation">,</span>r8<span class="token punctuation">,</span>r9<span class="token punctuation">,</span>lsl #<span class="token number">2</span> <span class="token punctuation">;</span> <span class="token operator">?</span>
                    ldr    r8<span class="token punctuation">,</span><span class="token punctuation">[</span>r8<span class="token punctuation">]</span>   <span class="token punctuation">;</span>Eintx_ Entry Add <span class="token operator">-></span>r8
                    str    r8<span class="token punctuation">,</span><span class="token punctuation">[</span>sp<span class="token punctuation">,</span>#<span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>r8<span class="token operator">-></span><span class="token function">SP</span><span class="token punctuation">(</span><span class="token operator">-</span>#<span class="token number">4</span><span class="token punctuation">)</span>

                    ldmfd    sp<span class="token operator">!</span><span class="token punctuation">,</span><span class="token punctuation">{</span>r8<span class="token operator">-</span>r9<span class="token punctuation">,</span>pc<span class="token punctuation">}</span><span class="token punctuation">;</span>Eintx_ Entry Add <span class="token operator">-></span>pc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="非嵌套中断"><a href="#非嵌套中断" class="headerlink" title="非嵌套中断"></a><strong>非嵌套中断</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204320420.png" alt=""></p>
<pre class="line-numbers language-assembly"><code class="language-assembly">interrupt_handler
    sub    r14, r14, #4 ; ?
    stmfd    sp!, {r0-r3, r12, r14}
    ldr    r1, =IRQStatus
    ldr    r0,[r1]
    tst    r0, #0x0080  ;测试中断源
    blne    my_isr1
    tst    r0, #0x0001 ；测试中断源
    blne    my_isr2
    ldmfd    sp!, {r0-r3, r12, r14}^
    ldr pc, lr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="嵌套中断"><a href="#嵌套中断" class="headerlink" title="嵌套中断"></a><strong>嵌套中断</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204357478.png" alt=""></p>
<h2 id="外设访问"><a href="#外设访问" class="headerlink" title="外设访问"></a><strong>外设访问</strong></h2><p>如何控制实验板上LED显示？</p>
<h3 id="LED连接"><a href="#LED连接" class="headerlink" title="LED连接"></a>LED连接</h3><p><strong>Mainboard</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204509420.png" alt=""></p>
<ul>
<li><p>LED连接</p>
<ul>
<li><p>LED1  -&gt; GPF4</p>
</li>
<li><p>LED2  -&gt; GPF5</p>
</li>
<li><p>LED3  -&gt; GPF6</p>
</li>
<li><p>LED4  -&gt; GPF7</p>
</li>
</ul>
</li>
<li><p>LED 控制</p>
<ul>
<li><p>n0  -&gt; on</p>
</li>
<li><p>n1  -&gt; off</p>
</li>
</ul>
</li>
<li><p>GPF控制</p>
<ul>
<li><strong>Registers</strong></li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204651064.png" alt=""></p>
<ul>
<li><p>The value of Registers</p>
<ul>
<li><p>GPFCON (4-7 Output)：0b 0101 0101 XXXX XXXX</p>
</li>
<li><p>GPFUP ( 4-7 No concern): 0b XXXX XXXX</p>
</li>
<li><p>GPFDAT (4-7 on): 0b 0000 XXXX</p>
</li>
<li><p>GPFDAT (4-7 off): 0b 1111 XXXX</p>
</li>
</ul>
</li>
</ul>
<h3 id="C-Code"><a href="#C-Code" class="headerlink" title="C Code"></a><strong>C Code</strong></h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token operator">*</span>rGPFCON <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x56000050</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>rGPFDAT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x56000054</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">*</span>rGPFCON<span class="token operator">=</span><span class="token number">0x5500</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>rGPFDAT <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token operator">*</span>rGPFDAT <span class="token operator">=</span> <span class="token number">0xf0</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>如何连接到目标板？</strong></p>
<h3 id="Emulator"><a href="#Emulator" class="headerlink" title="Emulator"></a><strong>Emulator</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204849739.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110204856786.png" alt=""></p>
<p>如何在目板RAM中运行程序？</p>
<h3 id="Run-in-RAM"><a href="#Run-in-RAM" class="headerlink" title="Run in RAM"></a>Run in RAM</h3><ul>
<li><p>Linker Configure</p>
<ul>
<li><p>RO Base=0x30000000</p>
</li>
<li><p>RW Base=0x30100000</p>
</li>
</ul>
</li>
<li><p>DRAM 初始化</p>
<ul>
<li>Debug Init</li>
</ul>
</li>
</ul>
<pre><code>//MEMMAP=0x01; 
map 0x48000000, 0x60000000 read write ;
_WDWORD(0x53000000,0x00000000);          //watchdog Timer Control register
_WDWORD(0x4a000008,0xffffffff);                 //Interrupt Mask Control
_WDWORD(0x4a00001c,0x000007ff);            //Interrupt sub mask
_WDWORD(0x4c000014,0x03);                       //Clock Divider Control Register
_WDWORD(0x4c000004,0x5c042);                 //MPLL Configuration Register
_WDWORD(0x48000000,0x22111110);          //Bus Width and Wait Status Ctrl
_WDWORD(0x48000004,0x00000700);          //Bank 0 Control Register
_WDWORD(0x48000008,0x00000700);          //Bank 1 Control Register
_WDWORD(0x4800000c,0x00000700);          //Bank 2 Control Register
_WDWORD(0x48000010,0x00000700);          //Bank 3 Control Register
_WDWORD(0x48000014,0x00000700);          //Bank 4 Control Register
_WDWORD(0x48000018,0x00000700);          //Bank 5 Control Register
_WDWORD(0x4800001c,0x00018005);          //Bank 6 Control Register
_WDWORD(0x48000020,0x00000700);          //Bank 7 Control Register
_WDWORD(0x48000024,0x008e0459);          //SDRAM Refresh Control Register 
_WDWORD(0x48000028,0x000000b2);          //Flexible Bank Size Register 
_WDWORD(0x4800002c,0x00000030);          //Bank 6 Mode Register
_WDWORD(0x48000030,0x00000030);          //Bank 7 Mode Register
_WDWORD(0x56000014,0x01);                      //Port B Data
_WDWORD(0x56000020,0xaaaa55aa);           //Port C Control
_WDWORD(0x56000028,0x0ffff);                      //Pull-up Control C
_WDWORD(0x56000024,0x00000000);          //Port C Data
_WDWORD(0x56000070,0x00280000);          //Port H Control
_WDWORD(0x56000078,0x00000000);          //Pull-up Control H
//pc=0x30000000</code></pre><p>需要在代码中加入初始化，上电后才能正常访问RAM</p>
<ul>
<li>下载到RAM </li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110205053747.png" alt=""></p>
<p>如何实现上电启动？</p>
<h3 id="Run-in-FLASH"><a href="#Run-in-FLASH" class="headerlink" title="Run in FLASH"></a>Run in FLASH</h3><ul>
<li>Linker Configure<ul>
<li>RO Base=0x00000000</li>
<li>RW Base=0x30000000</li>
</ul>
</li>
<li>Output Configure<ul>
<li>Create HEX file</li>
</ul>
</li>
<li>DRAM 初始化<ul>
<li>Initialization by code</li>
</ul>
</li>
</ul>
<p>Nor Flash</p>
<ul>
<li><p>Set Jumper    ( boot from Nor Flash )(16bit)</p>
<ul>
<li><p>SW104: OM0 (Open)</p>
</li>
<li><p>SW105: OM1 (Close)</p>
</li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110205239787.png" alt=""></p>
<h3 id="Linker-CMD"><a href="#Linker-CMD" class="headerlink" title="Linker CMD"></a>Linker CMD</h3><pre class="line-numbers language-assembly"><code class="language-assembly">LR_ROM1 0x00000000 
{    ; load region
     ER_ROM1 0x00000000 0x0200000  
    {  ; load address = execution address
       *.o (RESET, +First)
       *(InRoot$$Sections)
       .ANY (+RO)
   }
  RW_RAM1 0x30000000 0x4000000  
  {  ; RW data
       .ANY (+RW +ZI)
   }
   RW_IRAM1 0x40000000 0x00001000  
   {
       .ANY (+RW +ZI)
   }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211110205321127.png" alt=""></p>
<h2 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a><strong>小结</strong></h2><ul>
<li>函数调用</li>
<li>异常向量表</li>
<li>异常服务程序注册</li>
<li>外设访问</li>
</ul>
<h1 id="ARM程序分析"><a href="#ARM程序分析" class="headerlink" title="ARM程序分析"></a>ARM程序分析</h1><h2 id="启动程序"><a href="#启动程序" class="headerlink" title="启动程序"></a><strong>启动程序</strong></h2><h3 id="Start-s"><a href="#Start-s" class="headerlink" title="Start.s"></a>Start.s</h3><ul>
<li><strong>结构</strong></li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211117195255659.png" alt=""></p>
<ul>
<li><strong>Definitions</strong></li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211117195330316.png" alt=""></p>
<ul>
<li>PRESERVE8 8字节对齐</li>
</ul>
<pre class="line-numbers language-assembly"><code class="language-assembly">;/*****************************************************************************/
;/* S3C2410A.S: Startup file for Samsung S3C410A                              */
;/*****************************************************************************/
;/* <<< Use Configuration Wizard in Context Menu >>>                          */ 
;/*****************************************************************************/
;/* This file is part of the uVision/ARM development tools.                   */
;/* Copyright (c) 2005-2006 Keil Software. All rights reserved.               */
;/* This software may only be used under the terms of a valid, current,       */
;/* end user licence from KEIL for a compatible version of KEIL software      */
;/* development tools. Nothing else gives you the right to use this software. */
;/*****************************************************************************/


; *** Startup Code (executed after Reset) ***


; Standard definitions of Mode bits and Interrupt (I & F) flags in PSRs

Mode_USR        EQU     0x10
Mode_FIQ        EQU     0x11
Mode_IRQ        EQU     0x12
Mode_SVC        EQU     0x13
Mode_ABT        EQU     0x17
Mode_UND        EQU     0x1B
Mode_SYS        EQU     0x1F

I_Bit           EQU     0x80            ; when I bit is set, IRQ is disabled
F_Bit           EQU     0x40            ; when F bit is set, FIQ is disabled


;// <h> Stack Configuration (Stack Sizes in Bytes)
;//   <o0> Undefined Mode      <0x0-0xFFFFFFFF:8>
;//   <o1> Supervisor Mode     <0x0-0xFFFFFFFF:8>
;//   <o2> Abort Mode          <0x0-0xFFFFFFFF:8>
;//   <o3> Fast Interrupt Mode <0x0-0xFFFFFFFF:8>
;//   <o4> Interrupt Mode      <0x0-0xFFFFFFFF:8>
;//   <o5> User/System Mode    <0x0-0xFFFFFFFF:8>
;// </h>

;    Stack/Heap Definition 堆栈定义
UND_Stack_Size  EQU     0x00000000
SVC_Stack_Size  EQU     0x00000008
ABT_Stack_Size  EQU     0x00000000
FIQ_Stack_Size  EQU     0x00000000
IRQ_Stack_Size  EQU     0x00000080
USR_Stack_Size  EQU     0x00000400


; --------------------------------------------------------------------------
Stack_Size      EQU     (UND_Stack_Size + SVC_Stack_Size + ABT_Stack_Size + \
                         FIQ_Stack_Size + IRQ_Stack_Size + USR_Stack_Size)

                AREA    STACK, NOINIT, READWRITE, ALIGN=3
Stack_Mem       SPACE   Stack_Size

; ARM 栈初始位于栈顶 
Stack_Top       EQU     Stack_Mem + Stack_Size

;// <h> Heap Configuration
;//   <o>  Heap Size (in Bytes) <0x0-0xFFFFFFFF>
;// </h>

Heap_Size       EQU     0x00000000

                AREA    HEAP, NOINIT, READWRITE, ALIGN=3
Heap_Mem        SPACE   Heap_Size

; --------------------------------------------------------------------------



; Clock Management definitions
; Clock定义
CLK_BASE        EQU     0x4C000000      ; Clock Base Address
LOCKTIME_OFS    EQU     0x00            ; LOCKTIME Offset
MPLLCON_OFS     EQU     0x04            ; MPLLCON Offset
UPLLCON_OFS     EQU     0X08            ; UPLLCON Offset
CLKCON_OFS      EQU     0x0C            ; CLKCON Offset
CLKSLOW_OFS     EQU     0x10            ; CLKSLOW Offset
CLKDIVN_OFS     EQU     0X14            ; CLDKIVN Offset
CAMDIVN_OFS     EQU     0X18            ; CAMDIVN Offset



;// <e> Clock Management
;//   <h> MPLL Settings
;//   <i> Mpll = (m * Fin) / (p * 2^s)
;//     <o1.12..19> MDIV: Main divider <0x0-0xFF>
;//                 <i> m = MDIV + 8
;//     <o1.4..9>   PDIV: Pre-divider  <0x0-0x3F>
;//                 <i> p = PDIV + 2
;//     <o1.0..1>   SDIV: Post Divider <0x0-0x03>
;//                 <i> s = SDIV 
;//   </h>
;//   <h> UPLL Settings
;//   <i> Upll = ( m * Fin) / (p * 2^s),Uclk must be 48MHZ to USB device 
;//     <o2.12..19> MDIV: Main divider <0x1-0xF8>
;//                 <i> m = MDIV + 8,if Fin=12MHZ MDIV could be 0x38   
;//     <o2.4..9>   PDIV: Pre-divider  <0x1-0x3E>
;//                 <i> p = PDIV + 2,if Fin=12MHZ PDIV could be 0x2
;//     <o2.0..1>   SDIV: Post Divider <0x0-0x03>
;//                 <i> s = SDIV ,if Fin=12MHZ SDIV could be 0x2
;//   </h>
;//   <h>LOCK TIME 
;//      <o5.0..11>  LTIME CNT: MPLL Lock Time Count  <0x0-0xFFF>
;//      <o5.12..23>  LTIME CNT: UPLL Lock Time Count  <0x0-0xFFF>
;//   </h>
;//   <h> Master Clock
;//   <i> PLL Clock:  FCLK = FMPLL
;//   <i> Slow Clock: FCLK = Fin / (2 * SLOW_VAL), SLOW_VAL > 0
;//   <i> Slow Clock: FCLK = Fin, SLOW_VAL = 0
;//     <o4.7>      UCLK_ON: UCLK ON
;//                 <i> 0: UCLK ON(UPLL is also turned on) 1: UCLK OFF (UPLL is also turned off)      
;//     <o4.5>      MPLL_OFF: Turn off PLL
;//                 <i> 0: Turn on PLL.After PLL stabilization time (minimum 300us), SLOW_BIT can be cleared to 0. 1: Turn off PLL. PLL is turned off only when SLOW_BIT is 1.
;//     <o4.4>      SLOW_BIT: Slow Clock
;//     <o4.0..2>   SLOW_VAL: Slow Clock divider    <0x0-0x7>
;//   </h>
;//   <h> CLOCK DIVIDER CONTROL
;//     <o6.1>   HDIVN                            
;//                  <i> 0: HCLK = FCLK/1, 01 : HCLK = FCLK/2
;//     <o6.0>      PDIVN
;//                  <i> 0: PCLK has the clock same as the HCLK/1,1: PCLK has the clock same as the HCLK/2
;//    </h>
;//  <h> Clock Generation
;//     <o3.18>     SPI          <0=> Disable  <1=> Enable
;//     <o3.17>     IIS          <0=> Disable  <1=> Enable
;//     <o3.16>     IIC          <0=> Disable  <1=> Enable
;//     <o3.15>     ADC          <0=> Disable  <1=> Enable
;//     <o3.14>     RTC          <0=> Disable  <1=> Enable
;//     <o3.13>     GPIO         <0=> Disable  <1=> Enable
;//     <o3.12>     UART2        <0=> Disable  <1=> Enable
;//     <o3.11>     UART1        <0=> Disable  <1=> Enable
;//     <o3.10>     UART0        <0=> Disable  <1=> Enable
;//     <o3.9>      SDI          <0=> Disable  <1=> Enable
;//     <o3.8>      PWMTIMER     <0=> Disable  <1=> Enable
;//     <o3.7>      USB device   <0=> Disable  <1=> Enable
;//     <o3.6>      USB host     <0=> Disable  <1=> Enable
;//     <o3.5>      LCDC         <0=> Disable  <1=> Enable
;//     <o3.4>      NAND FLASH Controller       <0=> Disable  <1=> Enable
;//     <o3.3>      POWER-OFF    <0=> Disable  <1=> Enable
;//     <o3.2>      IDLE BIT     <0=> Disable  <1=> Enable
;//     <O3.0>      SM_BIT       <0=> Disable  <1=> Enable
;//   </h>
;// </e>
CLK_SETUP       EQU     1
MPLLCON_Val     EQU     0x0005C080
UPLLCON_Val     EQU     0x00028080
CLKCON_Val      EQU     0x0007FFF0
CLKSLOW_Val     EQU     0x00000004
LOCKTIME_Val    EQU     0x00FFFFFF
CLKDIVN_Val     EQU     0X00000000



;Interrupt  definitions
INTOFFSET          EQU    0X4A000014                      ;Address of Interrupt offset Register

;//<e> Interrupt Vector Table
;//  <o1.0..31> Interrupt Vector address     <0x20-0x3fffff78>
;//            <i> You could define Interuupt Vctor Table address.  
;//            <i> The Interrupt Vector Table address must be word aligned adress. 
;//</e>  
IntVT_SETUP      EQU     1
IntVTAddress    EQU     0x33FFFF20

; Watchdog Timer definitions
WT_BASE         EQU     0x53000000      ; WT Base Address
WTCON_OFS       EQU     0x00            ; WTCON Offset
WTDAT_OFS       EQU     0x04            ; WTDAT Offset
WTCNT_OFS       EQU     0x08            ; WTCNT Offset

;// <e> Watchdog Timer
;//   <o1.5>      Watchdog Timer Enable/Disable
;//   <o1.0>      Reset Enable/Disable
;//   <o1.2>      Interrupt Enable/Disable
;//   <o1.3..4>   Clock Select  
;//               <0=> 1/16  <1=> 1/32  <2=> 1/64  <3=> 1/128
;//               <i> Clock Division Factor
;//   <o1.8..15>  Prescaler Value <0x0-0xFF>
;//   <o2.0..15>  Time-out Value  <0x0-0xFFFF>
;// </e>
WT_SETUP        EQU     1
WTCON_Val       EQU     0x00008021      
WTDAT_Val       EQU     0x00008000


; Memory Controller definitions
MC_BASE         EQU     0x48000000      ; Memory Controller Base Address

;// <e> Memory Controller
MC_SETUP        EQU     1

;//   <h> Bank 0
;//     <o0.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o0.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o0.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o0.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o0.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o0.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o0.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 1
;//     <o8.4..5>   DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.6>      WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.7>      ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o1.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o1.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o1.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o1.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o1.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o1.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o1.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 2
;//     <o8.8..9>   DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.10>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.11>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o2.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o2.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o2.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o2.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o2.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o2.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o2.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 3
;//     <o8.12..13> DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.14>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.15>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o3.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o3.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o3.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o3.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o3.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o3.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o3.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 4
;//     <o8.16..17> DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.18>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.19>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o4.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o4.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o4.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o4.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o4.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o4.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o4.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 5
;//     <o8.20..21> DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.22>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.23>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o5.0..1>   PMC: Page Mode Configuration
;//                 <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//     <o5.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//     <o5.4..5>   Tcah: Address Holding Time after nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o5.6..7>   Toch: Chip Select Hold on nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o5.8..10>  Tacc: Access Cycle
;//                 <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                 <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//     <o5.11..12> Tcos: Chip Select Set-up nOE
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     <o5.13..14> Tacs: Address Set-up before nGCSn
;//                 <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//   </h>
;//
;//   <h> Bank 6
;//     <o10.0..2>  BK76MAP: Bank 6/7 Memory Map
;//                 <0=> 32M  <1=> 64M <2=> 128M <4=> 2M   <5=> 4M   <6=> 8M   <7=> 16M
;//     <o8.24..25> DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.26>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.27>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o6.15..16> MT: Memory Type
;//                 <0=> ROM or SRAM
;//                 <3=> SDRAM
;//     <h> ROM or SRAM
;//       <o6.0..1>   PMC: Page Mode Configuration
;//                   <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//       <o6.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//       <o6.4..5>   Tcah: Address Holding Time after nGCSn
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o6.6..7>   Toch: Chip Select Hold on nOE
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o6.8..10>  Tacc: Access Cycle
;//                   <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                   <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//       <o6.11..12> Tcos: Chip Select Set-up nOE
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o6.13..14> Tacs: Address Set-up before nGCSn
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     </h>
;//     <h> SDRAM
;//       <o6.0..1>   SCAN: Columnn Address Number
;//                   <0=> 8-bit   <1=> 9-bit   <2=> 10-bit  <3=> Rsrvd
;//       <o6.2..3>   Trcd: RAS to CAS Delay
;//                   <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> Rsrvd
;//       <o10.4>     SCKEEN: SCLK Selection (Bank 6/7)
;//                   <0=> Normal
;//                   <1=> Reduced Power   
;//       <o10.5>     SCLKEN: SDRAM power down mode (Bank 6/7)
;//                   <0=> DISABLE
;//                   <1=> ENABLE 
;//       <o10.7>     BURST_EN: ARM core burst operation (Bank 6/7)
;//                   <0=> DISABLE
;//                   <1=> ENABLE 
;//       <o11.0..2>  BL: Burst Length
;//                   <0=> 1
;//       <o11.3>     BT: Burst Type
;//                   <0=> Sequential
;//       <o11.4..6>  CL: CAS Latency
;//                   <0=> 1 clk   <1=> 2 clks  <2=> 3 clks
;//       <o11.7..8>  TM: Test Mode
;//                   <0=> Mode Register Set
;//       <o11.9>     WBL: Write Burst Length
;//                   <0=> 0
;//     </h>
;//   </h>
;//
;//   <h> Bank 7
;//     <o10.0..2>  BK76MAP: Bank 6/7 Memory Map
;//                 <0=> 32M  <1=> 64M <2=> 128M <4=> 2M   <5=> 4M   <6=> 8M   <7=> 16M
;//     <o8.28..29> DW: Data Bus Width
;//                 <0=> 8-bit   <1=> 16-bit  <2=> 32-bit  <3=> Rsrvd
;//     <o8.30>     WS: WAIT Status
;//                 <0=> WAIT Disable
;//                 <1=> WAIT Enable
;//     <o8.31>     ST: SRAM Type
;//                 <0=> Not using UB/LB
;//                 <1=> Using UB/LB
;//     <o7.15..16> MT: Memory Type
;//                 <0=> ROM or SRAM
;//                 <3=> SDRAM
;//     <h> ROM or SRAM
;//       <o7.0..1>   PMC: Page Mode Configuration
;//                   <0=> 1 Data  <1=> 4 Data  <2=> 8 Data  <3=> 16 Data
;//       <o7.2..3>   Tpac: Page Mode Access Cycle
;//                 <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> 6 clks
;//       <o7.4..5>   Tcah: Address Holding Time after nGCSn
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o7.6..7>   Toch: Chip Select Hold on nOE
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o7.8..10>  Tacc: Access Cycle
;//                   <0=> 1 clk   <1=> 2 clks  <2=> 3 clks  <3=> 4 clks
;//                   <4=> 6 clk   <5=> 8 clks  <6=> 10 clks <7=> 14 clks
;//       <o7.11..12> Tcos: Chip Select Set-up nOE
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//       <o7.13..14> Tacs: Address Set-up before nGCSn
;//                   <0=> 0 clk   <1=> 1 clk   <2=> 2 clks  <3=> 4 clks
;//     </h>
;//     <h> SDRAM
;//       <o7.0..1>   SCAN: Columnn Address Number
;//                   <0=> 8-bit   <1=> 9-bit   <2=> 10-bit  <3=> Rsrvd
;//       <o7.2..3>   Trcd: RAS to CAS Delay
;//                   <0=> 2 clks  <1=> 3 clks  <2=> 4 clks  <3=> Rsrvd
;//       <o10.4>     SCLKEN: SCLK Selection (Bank 6/7)
;//                   <0=> Normal
;//                   <1=> Reduced Power 
;//       <o10.5>     SCLKEN: SDRAM power down mode (Bank 6/7)
;//                   <0=> DISABLE
;//                   <1=> ENABLE 
;//       <o10.7>     BURST_EN: ARM core burst operation (Bank 6/7)
;//                   <0=> DISABLE
;//                   <1=> ENABLE 
;//       <o12.0..2>  BL: Burst Length
;//                   <0=> 1
;//       <o12.3>     BT: Burst Type
;//                   <0=> Sequential
;//       <o12.4..6>  CL: CAS Latency
;//                   <0=> 1 clk   <1=> 2 clks  <2=> 3 clks
;//       <o12.7..8>  TM: Test Mode
;//                   <0=> Mode Register Set
;//       <o12.9>     WBL: Write Burst Length
;//                   <0=> 0
;//     </h>
;//   </h>
;//
;//   <h> Refresh
;//     <o9.23>     REFEN: SDRAM Refresh
;//                 <0=> Disable <1=> Enable
;//     <o9.22>     TREFMD: SDRAM Refresh Mode
;//                 <0=> CBR/Auto Refresh
;//                 <1=> Self Refresh
;//     <o9.20..21> Trp: SDRAM RAS Pre-charge Time
;//                 <0=> 2 clks 
;//                 <1=> 3 clks 
;//                 <2=> 4 clks 
;//                 <3=> Rsrvd 
;//     <o9.18..19> Tsrc: SDRAM Semi Row cycle time
;//                <i> SDRAM Row cycle time: Trc=Tsrc+Trp
;//                 <0=> 4 clks  <1=> 5 clks  <2=> 6 clks  <3=> 7 clks
;//     <o9.0..10>  Refresh Counter <0x0-0x07FF>
;//                 <i> Refresh Period = (2^11 - Refresh Count + 1) / HCLK
;//   </h>
BANKCON0_Val    EQU     0x00000700
BANKCON1_Val    EQU     0x00000700
BANKCON2_Val    EQU     0x00000700
BANKCON3_Val    EQU     0x00000700
BANKCON4_Val    EQU     0x00000700
BANKCON5_Val    EQU     0x00000700
BANKCON6_Val    EQU     0x00018008
BANKCON7_Val    EQU     0x00018008
BWSCON_Val      EQU     0x00000000
REFRESH_Val     EQU     0x00ac0000
BANKSIZE_Val    EQU     0x00000000
MRSRB6_Val      EQU     0x00000020
MRSRB7_Val      EQU     0x00000000

;// </e> End of MC



; I/O Ports definitions
PIO_BASE        EQU     0x56000000      ; PIO Base Address
PCONA_OFS       EQU     0x00            ; PCONA Offset
PCONB_OFS       EQU     0x10            ; PCONB Offset
PCONC_OFS       EQU     0x20            ; PCONC Offset
PCOND_OFS       EQU     0x30            ; PCOND Offset
PCONE_OFS       EQU     0x40            ; PCONE Offset
PCONF_OFS       EQU     0x50            ; PCONF Offset
PCONG_OFS       EQU     0x60            ; PCONG Offset
PCONH_OFS       EQU     0x70            ; PCONH Offset
PCONJ_OFS       EQU     0xD0            ; PCONJ Offset
PUPB_OFS        EQU     0x18            ; PUPB Offset
PUPC_OFS        EQU     0x28            ; PUPC Offset
PUPD_OFS        EQU     0x38            ; PUPD Offset
PUPE_OFS        EQU     0x48            ; PUPE Offset
PUPF_OFS        EQU     0x58            ; PUPF Offset
PUPG_OFS        EQU     0x68            ; PUPG Offset
PUPH_OFS        EQU     0x78            ; PUPH Offset
PUPJ_OFS        EQU     0xD8            ; PUPJ Offset


;// <e> I/O Configuration
PIO_SETUP       EQU     1

;//   <e> Port A
;//     <o1.0>      PA0  <0=> Output   <1=> ADDR0
;//     <o1.1>      PA1  <0=> Output   <1=> ADDR16
;//     <o1.2>      PA2  <0=> Output   <1=> ADDR17
;//     <o1.3>      PA3  <0=> Output   <1=> ADDR18
;//     <o1.4>      PA4  <0=> Output   <1=> ADDR19
;//     <o1.5>      PA5  <0=> Output   <1=> ADDR20
;//     <o1.6>      PA6  <0=> Output   <1=> ADDR21
;//     <o1.7>      PA7  <0=> Output   <1=> ADDR22
;//     <o1.8>      PA8  <0=> Output   <1=> ADDR23
;//     <o1.9>      PA9  <0=> Output   <1=> ADDR24
;//     <o1.10>      PA0  <0=> Output   <1=> ADDR25
;//     <o1.11>      PA1  <0=> Output   <1=> ADDR26
;//     <o1.12>      PA2  <0=> Output   <1=> nGCS[1]
;//     <o1.13>      PA3  <0=> Output   <1=> nGCS[2]
;//     <o1.14>      PA4  <0=> Output   <1=> nGCS[3]
;//     <o1.15>      PA5  <0=> Output   <1=> nGCS[4]
;//     <o1.16>      PA6  <0=> Output   <1=> nGCS[5]
;//     <o1.17>      PA7  <0=> Output   <1=> CLE
;//     <o1.18>      PA8  <0=> Output   <1=> ALE
;//     <o1.19>      PA9  <0=> Output   <1=> nFWE
;//     <o1.20>      PA0  <0=> Output   <1=> nFRE
;//     <o1.21>      PA1  <0=> Output   <1=> nRSTOUT
;//     <o1.22>      PA2  <0=> Output   <1=> nFCE
;//   </e>
PIOA_SETUP      EQU     0
PCONA_Val       EQU     0x000003FF

;//   <e> Port B
;//     <o1.0..1>        PB0  <0=> Input   <1=> Output  <2=> TOUT0    <3=> Reserved 
;//     <o1.2..3>        PB1  <0=> Input   <1=> Output  <2=> TOUT1    <3=> Reserved 
;//     <o1.4..5>        PB2  <0=> Input   <1=> Output  <2=> TOUT2    <3=> Reserved 
;//     <o1.6..7>        PB3  <0=> Input   <1=> Output  <2=> TOUT3    <3=> Reserved 
;//     <o1.8..9>        PB4  <0=> Input   <1=> Output  <2=> TCLK[0]  <3=> Reserved 
;//     <o1.10..11>      PB5  <0=> Input   <1=> Output  <2=> nXBACK   <3=> Reserved 
;//     <o1.12..13>      PB6  <0=> Input   <1=> Output  <2=> nXBREQ   <3=> Reserved 
;//     <o1.14..15>      PB7  <0=> Input   <1=> Output  <2=> nXDACK1  <3=> Reserved 
;//     <o1.16..17>      PB8  <0=> Input   <1=> Output  <2=> nXDREQ1  <3=> Reserved 
;//     <o1.18..19>      PB9  <0=> Input   <1=> Output  <2=> nXDACK0  <3=> Reserved 
;//     <o1.20..21>      PB10 <0=> Input   <1=> Output  <2=> nXDREQ0  <3=> Reserved 
;//     <h> Pull-up Resistors                                        
;//       <o2.0>    PB0 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.1>    PB1 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.2>    PB2 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.3>    PB3 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.4>    PB4 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.5>    PB5 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.6>    PB6 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.7>    PB7 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.8>    PB8 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.9>    PB9 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.10>   PB10 Pull-up       <0=> Enabled  <1=> Disabled   
;//     </h>                                                         
;//   </e>
PIOB_SETUP      EQU     0
PCONB_Val       EQU     0x000007FF
PUPB_Val        EQU     0x00000000 

;//   <e> Port C
;//     <o1.0..1>          PC0  <0=> Input    <1=> Output  <2=> LEND          <3=> Reserved 
;//     <o1.2..3>          PC1  <0=> Input    <1=> Output  <2=> VCLK          <3=> Reserved 
;//     <o1.4..5>          PC2  <0=> Input    <1=> Output  <2=> VLINE         <3=> Reserved 
;//     <o1.6..7>          PC3  <0=> Input    <1=> Output  <2=> VFRAME        <3=> Reserved 
;//     <o1.8..9>          PC4  <0=> Input    <1=> Output  <2=> VM            <3=> Reserved 
;//     <o1.10..11>        PC5  <0=> Input    <1=> Output  <2=> LCDVF2     <3=> Reserved 
;//     <o1.12..13>        PC6  <0=> Input    <1=> Output  <2=> LCDVF1    <3=> Reserved 
;//     <o1.14..15>        PC7  <0=> Input    <1=> Output  <2=> LCDVF0   <3=> Reserved 
;//     <o1.16..17>        PC8  <0=> Input    <1=> Output  <2=> VD[0]         <3=> Reserved 
;//     <o1.18..19>        PC9  <0=> Input    <1=> Output  <2=> VD[1]         <3=> Reserved 
;//     <o1.20..21>        PC10 <0=> Input    <1=> Output  <2=> VD[2]         <3=> Reserved 
;//     <o1.22..23>        PC11  <0=> Input   <1=> Output  <2=> VD[3]         <3=> Reserved 
;//     <o1.24..25>        PC12  <0=> Input   <1=> Output  <2=> VD[4]         <3=> Reserved 
;//     <o1.26..27>        PC13  <0=> Input   <1=> Output  <2=> VD[5]         <3=> Reserved 
;//     <o1.28..29>        PC14  <0=> Input   <1=> Output  <2=> VD[6]         <3=> Reserved 
;//     <o1.30..31>        PC15  <0=> Input   <1=> Output  <2=> VD[7]         <3=> Reserved 
;//     <h> Pull-up Resistors                                        
;//       <o2.0>     PC0 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.1>     PC1 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.2>     PC2 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.3>     PC3 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.4>     PC4 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.5>     PC5 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.6>     PC6 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.7>     PC7 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.8>     PC8 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.9>     PC9 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.10>    PC10 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.11>    PC11 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.12>    PC12 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.13>    PC13 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.14>    PC14 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.15>    PC15 Pull-up        <0=> Enabled  <1=> Disabled  
;//     </h>                                                         
;//   </e>
PIOC_SETUP      EQU     0
PCONC_Val       EQU     0xAAAAAAAA
PUPC_Val        EQU     0x00000000

;//   <e> Port D
;//     <o1.0..1>          PD0  <0=> Input    <1=> Output  <2=> VD[8]         <3=> Reserved 
;//     <o1.2..3>          PD1  <0=> Input    <1=> Output  <2=> VD[9]         <3=> Reserved 
;//     <o1.4..5>          PD2  <0=> Input    <1=> Output  <2=> VD[10]         <3=> Reserved 
;//     <o1.6..7>          PD3  <0=> Input    <1=> Output  <2=> VD[11]         <3=> Reserved 
;//     <o1.8..9>          PD4  <0=> Input    <1=> Output  <2=> VD[12]         <3=> Reserved 
;//     <o1.10..11>        PD5  <0=> Input    <1=> Output  <2=> VD[13]         <3=> Reserved 
;//     <o1.12..13>        PD6  <0=> Input    <1=> Output  <2=> VD[14]         <3=> Reserved 
;//     <o1.14..15>        PD7  <0=> Input    <1=> Output  <2=> VD[15]         <3=> Reserved 
;//     <o1.16..17>        PD8  <0=> Input    <1=> Output  <2=> VD[16]         <3=> Reserved  
;//     <o1.18..19>        PD9  <0=> Input    <1=> Output  <2=> VD[17]         <3=> Reserved 
;//     <o1.20..21>        PD10 <0=> Input    <1=> Output  <2=> VD[18]         <3=> Reserved 
;//     <o1.22..23>        PD11  <0=> Input   <1=> Output  <2=> VD[19]         <3=> Reserved 
;//     <o1.24..25>        PD12  <0=> Input   <1=> Output  <2=> VD[20]         <3=> Reserved 
;//     <o1.26..27>        PD13  <0=> Input   <1=> Output  <2=> VD[21]         <3=> Reserved 
;//     <o1.28..29>        PD14  <0=> Input   <1=> Output  <2=> VD[22]          <3=> nSS1
;//     <o1.30..31>        PD15  <0=> Input   <1=> Output  <2=> VD[23]          <3=> nSS0 
;//     <h> Pull-up Resistors                                        
;//       <o2.0>     PD0 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.1>     PD1 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.2>     PD2 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.3>     PD3 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.4>     PD4 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.5>     PD5 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.6>     PD6 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.7>     PD7 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.8>     PD8 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.9>     PD9 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.10>    PD10 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.11>    PD11 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.12>    PD12 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.13>    PD13 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.14>    PD14 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.15>    PD15 Pull-up        <0=> Enabled  <1=> Disabled  
;//     </h>         
;//   </e>
PIOD_SETUP      EQU     0
PCOND_Val       EQU     0x00000000
PUPD_Val        EQU     0x00000000

;//   <e> Port E
;//     <o1.0..1>          PE0  <0=> Input    <1=> Output  <2=> I2SLRCK       <3=> Reserved 
;//     <o1.2..3>          PE1  <0=> Input    <1=> Output  <2=> I2SSCLK       <3=> Reserved  
;//     <o1.4..5>          PE2  <0=> Input    <1=> Output  <2=> CDCLK         <3=> Reserved 
;//     <o1.6..7>          PE3  <0=> Input    <1=> Output  <2=> I2SDI         <3=> nSS0 
;//     <o1.8..9>          PE4  <0=> Input    <1=> Output  <2=> I2SDO         <3=> I2SSDI 
;//     <o1.10..11>        PE5  <0=> Input    <1=> Output  <2=> SDCLK         <3=> Reserved 
;//     <o1.12..13>        PE6  <0=> Input    <1=> Output  <2=> SDCMD         <3=> Reserved 
;//     <o1.14..15>        PE7  <0=> Input    <1=> Output  <2=> SDDAT0        <3=> Reserved 
;//     <o1.16..17>        PE8  <0=> Input    <1=> Output  <2=> SDDAT1        <3=> Reserved
;//     <o1.18..19>        PE9  <0=> Input    <1=> Output  <2=> SDDAT2        <3=> Reserved
;//     <o1.20..21>        PE10 <0=> Input    <1=> Output  <2=> SDDAT3        <3=> Reserved
;//     <o1.22..23>        PE11  <0=> Input   <1=> Output  <2=> SPIMISO0      <3=> Reserved 
;//     <o1.24..25>        PE12  <0=> Input   <1=> Output  <2=> SPIMOSI0      <3=> Reserved 
;//     <o1.26..27>        PE13  <0=> Input   <1=> Output  <2=> SPICLK0       <3=> Reserved 
;//     <o1.28..29>        PE14  <0=> Input   <1=> Output  <2=> IICSCL        <3=> Reserved
;//     <o1.30..31>        PE15  <0=> Input   <1=> Output  <2=> IICSDA        <3=> Reserved
;//     <h> Pull-up Resistors                                                      
;//       <o2.0>     PE0 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.1>     PE1 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.2>     PE2 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.3>     PE3 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.4>     PE4 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.5>     PE5 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.6>     PE6 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.7>     PE7 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.8>     PE8 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.9>     PE9 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.10>    PE10 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.11>    PE11 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.12>    PE12 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.13>    PE13 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.14>    PE14 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.15>    PE15 Pull-up        <0=> Enabled  <1=> Disabled  
;//     </h>         
;//   </e>
PIOE_SETUP      EQU     0
PCONE_Val       EQU     0x00000000
PUPE_Val        EQU     0x00000000

;//   <e> Port F
;//     <o1.0..1>        PF0  <0=> Input   <1=> Output  <2=> EINT[0]  <3=> Reserved 
;//     <o1.2..3>        PF1  <0=> Input   <1=> Output  <2=> EINT[1]  <3=> Reserved 
;//     <o1.4..5>        PF2  <0=> Input   <1=> Output  <2=> EINT[2]  <3=> Reserved 
;//     <o1.6..7>        PF3  <0=> Input   <1=> Output  <2=> EINT[3]  <3=> Reserved 
;//     <o1.8..9>        PF4  <0=> Input   <1=> Output  <2=> EINT[4]  <3=> Reserved 
;//     <o1.10..11>      PF5  <0=> Input   <1=> Output  <2=> EINT[5]  <3=> Reserved 
;//     <o1.12..13>      PF6  <0=> Input   <1=> Output  <2=> EINT[6]  <3=> Reserved 
;//     <o1.14..15>      PF7  <0=> Input   <1=> Output  <2=> EINT[7]  <3=> Reserved 
;//     <h> Pull-up Resistors                                        
;//       <o2.0>    PF0 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.1>    PF1 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.2>    PF2 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.3>    PF3 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.4>    PF4 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.5>    PF5 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.6>    PF6 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.7>    PF7 Pull-up        <0=> Enabled  <1=> Disabled   
;//     </h> 
;//   </e>
PIOF_SETUP      EQU     1
PCONF_Val       EQU     0x0000511A
PUPF_Val        EQU     0x00000000

;//   <e> Port G
;//     <o1.0..1>          PG0  <0=> Input    <1=> Output  <2=> EINT[8]   <3=> Reserved 
;//     <o1.2..3>          PG1  <0=> Input    <1=> Output  <2=> EINT[9]   <3=> Reserved 
;//     <o1.4..5>          PG2  <0=> Input    <1=> Output  <2=> EINT[10]   <3=> nSS0 
;//     <o1.6..7>          PG3  <0=> Input    <1=> Output  <2=> EINT[11]   <3=> nSS1 
;//     <o1.8..9>          PG4  <0=> Input    <1=> Output  <2=> EINT[12]   <3=> LCD_PWRDN 
;//     <o1.10..11>        PG5  <0=> Input    <1=> Output  <2=> EINT[13]   <3=> SPIMISO1 
;//     <o1.12..13>        PG6  <0=> Input    <1=> Output  <2=> EINT[14]   <3=> SPIMOSI1
;//     <o1.14..15>        PG7  <0=> Input    <1=> Output  <2=> EINT[15]   <3=> SPICLK1 
;//     <o1.16..17>        PG8  <0=> Input    <1=> Output  <2=> EINT[16]   <3=> Reserved 
;//     <o1.18..19>        PG9  <0=> Input    <1=> Output  <2=> EINT[17]   <3=> Reserved 
;//     <o1.20..21>        PG10 <0=> Input    <1=> Output  <2=> EINT[18]   <3=> Reserved 
;//     <o1.22..23>        PG11  <0=> Input   <1=> Output  <2=> EINT[19]   <3=> TCLK1
;//     <o1.24..25>        PG12  <0=> Input   <1=> Output  <2=> EINT[20]   <3=> XMON
;//     <o1.26..27>        PG13  <0=> Input   <1=> Output  <2=> EINT[21]   <3=> nXPON 
;//     <o1.28..29>        PG14  <0=> Input   <1=> Output  <2=> EINT[22]   <3=> YMON
;//     <o1.30..31>        PG15  <0=> Input   <1=> Output  <2=> EINT[23]   <3=> nYPON
;//     <h> Pull-up Resistors                                        
;//       <o2.0>     PG0 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.1>     PG1 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.2>     PG2 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.3>     PG3 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.4>     PG4 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.5>     PG5 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.6>     PG6 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.7>     PG7 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.8>     PG8 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.9>     PG9 Pull-up         <0=> Enabled  <1=> Disabled   
;//       <o2.10>    PG10 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.11>    PG11 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.12>    PG12 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.13>    PG13 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.14>    PG14 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.15>    PG15 Pull-up        <0=> Enabled  <1=> Disabled  
;//     </h>                                                    
;//   </e>
PIOG_SETUP      EQU     0
PCONG_Val       EQU     0x00000000
PUPG_Val        EQU     0x00000000

;//   <e> Port H
;//     <o1.0..1>        PH0  <0=> Input   <1=> Output  <2=> nCTS0    <3=> Reserved 
;//     <o1.2..3>        PH1  <0=> Input   <1=> Output  <2=> nRTS0    <3=> Reserved 
;//     <o1.4..5>        PH2  <0=> Input   <1=> Output  <2=> TXD[0]    <3=> Reserved 
;//     <o1.6..7>        PH3  <0=> Input   <1=> Output  <2=> RXD[0]    <3=> Reserved 
;//     <o1.8..9>        PH4  <0=> Input   <1=> Output  <2=> TXD[1]  <3=> Reserved 
;//     <o1.10..11>      PH5  <0=> Input   <1=> Output  <2=> RXD[1]   <3=> Reserved 
;//     <o1.12..13>      PH6  <0=> Input   <1=> Output  <2=> TXD[2]   <3=> nRTS1
;//     <o1.14..15>      PH7  <0=> Input   <1=> Output  <2=> RXD[2]  <3=> nCTS1 
;//     <o1.16..17>      PH8  <0=> Input   <1=> Output  <2=> UCLK    <3=> Reserved 
;//     <o1.18..19>      PH9  <0=> Input   <1=> Output  <2=> CLKOUT0  <3=> Reserved 
;//     <o1.20..21>      PH10 <0=> Input   <1=> Output  <2=> CLKOUT1  <3=> Reserved 
;//     <h> Pull-up Resistors                                        
;//       <o2.0>    PH0 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.1>    PH1 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.2>    PH2 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.3>    PH3 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.4>    PH4 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.5>    PH5 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.6>    PH6 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.7>    PH7 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.8>    PH8 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.9>    PH9 Pull-up        <0=> Enabled  <1=> Disabled   
;//       <o2.10>   PH10 Pull-up       <0=> Enabled  <1=> Disabled   
;//     </h>                                                         
;//   </e>
PIOH_SETUP      EQU     0
PCONH_Val       EQU     0x000007FF
PUPH_Val        EQU     0x00000000 

;// </e>




                PRESERVE8


; Area Definition and Entry Point
;  Startup Code must be linked first at Address at which it expects to run.


                AREA    RESET, CODE, READONLY
                IMPORT INISDRAM
                ARM


; Exception Vectors
;  Mapped to Address 0.
;  Absolute addressing mode must be used.
;  Dummy Handlers are implemented as infinite loops which can be modified.


; --------------------------------------------------------------------------

Vectors         LDR     PC, Reset_Addr         
                LDR     PC, Undef_Addr
                LDR     PC, SWI_Addr
                LDR     PC, PAbt_Addr
                LDR     PC, DAbt_Addr
                NOP                            ; Reserved Vector 
                LDR     PC, IRQ_Addr
                LDR     PC, FIQ_Addr
; --------------------------------------------------------------------------



                IF      IntVT_SETUP <> 0

;Interrupt Vector Table Address                
HandleEINT0          EQU    IntVTAddress           
HandleEINT1          EQU    IntVTAddress +4
HandleEINT2          EQU    IntVTAddress +4*2
HandleEINT3          EQU    IntVTAddress +4*3
HandleEINT4_7      EQU    IntVTAddress +4*4
HandleEINT8_23    EQU    IntVTAddress +4*5
HandleReserved      EQU    IntVTAddress +4*6
HandleBATFLT      EQU    IntVTAddress +4*7
HandleTICK          EQU    IntVTAddress +4*8
HandleWDT          EQU    IntVTAddress +4*9
HandleTIMER0       EQU    IntVTAddress +4*10
HandleTIMER1       EQU    IntVTAddress +4*11
HandleTIMER2       EQU    IntVTAddress +4*12
HandleTIMER3       EQU    IntVTAddress +4*13
HandleTIMER4       EQU    IntVTAddress +4*14
HandleUART2        EQU    IntVTAddress +4*15
HandleLCD           EQU    IntVTAddress +4*16
HandleDMA0          EQU    IntVTAddress +4*17
HandleDMA1          EQU    IntVTAddress +4*18
HandleDMA2          EQU    IntVTAddress +4*19
HandleDMA3          EQU    IntVTAddress +4*20
HandleMMC          EQU    IntVTAddress +4*21
HandleSPI0          EQU    IntVTAddress +4*22
HandleUART1          EQU    IntVTAddress +4*23
;HandleReserved          EQU    IntVTAddress +4*24
HandleUSBD          EQU    IntVTAddress +4*25
HandleUSBH          EQU    IntVTAddress +4*26
HandleIIC          EQU    IntVTAddress +4*27
HandleUART0       EQU    IntVTAddress +4*28
HandleSPI1           EQU    IntVTAddress +4*39
HandleRTC           EQU    IntVTAddress +4*30
HandleADC           EQU    IntVTAddress +4*31

; --------------------------------------------------------------------------
; 分析寄存器过程
IRQ_Entry
                sub    sp,sp,#4       ;reserved for PC
                stmfd    sp!,{r8-r9}

                ldr    r9,=INTOFFSET  ;中断序号
                ldr    r9,[r9]
                ldr    r8,=HandleEINT0    ;中断扩展首地址
                add    r8,r8,r9,lsl #2    ;偏移量*4 + 基地址
                ldr    r8,[r8]            ;Eintx_Entry Add -> r8
                str    r8,[sp,#8]         ;r8 -> sp(-#4)
                ldmfd    sp!,{r8-r9,pc}  ;Eintx_Entry Add -> pc 

; --------------------------------------------------------------------------


                ENDIF

Reset_Addr      DCD     Reset_Handler
Undef_Addr      DCD     Undef_Handler
SWI_Addr        DCD     SWI_Handler
PAbt_Addr       DCD     PAbt_Handler
DAbt_Addr       DCD     DAbt_Handler
                DCD     0                      ; Reserved Address 
IRQ_Addr        DCD     IRQ_Handler
FIQ_Addr        DCD     FIQ_Handler

Undef_Handler   B       Undef_Handler
SWI_Handler     B       SWI_Handler
PAbt_Handler    B       PAbt_Handler
DAbt_Handler    B       DAbt_Handler

                IF      IntVT_SETUP <> 1
IRQ_Handler     B       IRQ_Handler
                ENDIF

                IF      IntVT_SETUP <> 0
IRQ_Handler     B       IRQ_Entry
                ENDIF

FIQ_Handler     B       FIQ_Handler



; Memory Controller Configuration
                IF      MC_SETUP <> 0
MC_CFG
                DCD     BWSCON_Val
                DCD     BANKCON0_Val
                DCD     BANKCON1_Val
                DCD     BANKCON2_Val
                DCD     BANKCON3_Val
                DCD     BANKCON4_Val
                DCD     BANKCON5_Val
                DCD     BANKCON6_Val
                DCD     BANKCON7_Val
                DCD     REFRESH_Val
                DCD     BANKSIZE_Val
                DCD     MRSRB6_Val
                DCD     MRSRB7_Val
                ENDIF


; Clock Management Configuration
                IF      CLK_SETUP <> 0
CLK_CFG
                DCD     LOCKTIME_Val     
                DCD     CLKDIVN_Val 
                DCD     MPLLCON_Val 
                DCD     UPLLCON_Val 
                DCD     CLKSLOW_Val 
                DCD     CLKCON_Val 
                ENDIF 


; Reset Handler

                EXPORT  Reset_Handler
Reset_Handler   

                IF      WT_SETUP <> 0
                LDR     R0, =WT_BASE
                LDR     R1, =WTCON_Val
                LDR     R2, =WTDAT_Val
                STR     R2, [R0, #WTCNT_OFS]
                STR     R2, [R0, #WTDAT_OFS]
                STR     R1, [R0, #WTCON_OFS]
                ENDIF


                IF      CLK_SETUP <> 0         
                LDR     R0, =CLK_BASE            
                ADR     R8, CLK_CFG
                LDMIA   R8, {R1-R6}            
                STR     R1, [R0, #LOCKTIME_OFS]
                STR     R2, [R0, #CLKDIVN_OFS]  
                STR     R3, [R0, #MPLLCON_OFS] 
                STR     R4, [R0, #UPLLCON_OFS]  
                STR     R5, [R0, #CLKSLOW_OFS]
                STR     R6, [R0, #CLKCON_OFS]
                ENDIF                          


                IF      MC_SETUP <> 0
                ADR     R14, MC_CFG
                LDMIA   R14, {R0-R12}
                LDR     R14, =MC_BASE
                STMIA   R14, {R0-R12}
                ENDIF                            


                IF      PIO_SETUP <> 0
                LDR     R14, =PIO_BASE

                IF      PIOA_SETUP <> 0
                LDR     R0, =PCONA_Val
                STR     R0, [R14, #PCONA_OFS]
                ENDIF

                IF      PIOB_SETUP <> 0
                LDR     R0, =PCONB_Val
                LDR     R1, =PUPB_Val
                STR     R0, [R14, #PCONB_OFS]
                STR     R1, [R14, #PUPB_OFS]
                ENDIF

                IF      PIOC_SETUP <> 0
                LDR     R0, =PCONC_Val
                LDR     R1, =PUPC_Val
                STR     R0, [R14, #PCONC_OFS]
                STR     R1, [R14, #PUPC_OFS]
                ENDIF

                IF      PIOD_SETUP <> 0
                LDR     R0, =PCOND_Val
                LDR     R1, =PUPD_Val
                STR     R0, [R14, #PCOND_OFS]
                STR     R1, [R14, #PUPD_OFS]
                ENDIF

                IF      PIOE_SETUP <> 0
                LDR     R0, =PCONE_Val
                LDR     R1, =PUPE_Val
                STR     R0, [R14, #PCONE_OFS]
                STR     R1, [R14, #PUPE_OFS]
                ENDIF

                IF      PIOF_SETUP <> 0
                LDR     R0, =PCONF_Val
                LDR     R1, =PUPF_Val
                STR     R0, [R14, #PCONF_OFS]
                STR     R1, [R14, #PUPF_OFS]
                ENDIF

                IF      PIOG_SETUP <> 0
                LDR     R0, =PCONG_Val
                LDR     R1, =PUPG_Val
                STR     R0, [R14, #PCONG_OFS]
                STR     R1, [R14, #PUPG_OFS]
                ENDIF

                IF      PIOH_SETUP <> 0
                LDR     R0, =PCONH_Val
                LDR     R1, =PUPH_Val
                STR     R0, [R14, #PCONH_OFS]
                STR     R1, [R14, #PUPH_OFS]
                ENDIF

                ENDIF

; ini sdram 

                BL INISDRAM


; Setup Stack for each mode

                LDR     R0, =Stack_Top

;  Enter Undefined Instruction Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_UND:OR:I_Bit:OR:F_Bit
                MOV     SP, R0
                SUB     R0, R0, #UND_Stack_Size

;  Enter Abort Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_ABT:OR:I_Bit:OR:F_Bit
                MOV     SP, R0
                SUB     R0, R0, #ABT_Stack_Size

;  Enter FIQ Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_FIQ:OR:I_Bit:OR:F_Bit
                MOV     SP, R0
                SUB     R0, R0, #FIQ_Stack_Size

;  Enter IRQ Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_IRQ:OR:I_Bit:OR:F_Bit
                MOV     SP, R0
                SUB     R0, R0, #IRQ_Stack_Size

;  Enter Supervisor Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_SVC:OR:I_Bit:OR:F_Bit
                MOV     SP, R0
                SUB     R0, R0, #SVC_Stack_Size

;  Enter User Mode and set its Stack Pointer
                MSR     CPSR_c, #Mode_USR
                MOV     SP, R0
                SUB     SL, SP, #USR_Stack_Size


; Enter the C code
; ！！！注意这里的__main是跳转到arm库函数中的init，然后再到用户写的main
                IMPORT  __main
                LDR     R0, =__main
                BX      R0


; User Initial Stack & Heap
                AREA    |.text|, CODE, READONLY

                IMPORT  __use_two_region_memory
                EXPORT  __user_initial_stackheap
__user_initial_stackheap

                LDR     R0, =  Heap_Mem
                LDR     R1, =(Stack_Mem + USR_Stack_Size)
                LDR     R2, = (Heap_Mem +      Heap_Size)
                LDR     R3, = Stack_Mem
                BX      LR


                END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Stack-Heap-Definition"><a href="#Stack-Heap-Definition" class="headerlink" title="Stack/Heap Definition"></a>Stack/Heap Definition</h4><pre><code>UND_Stack_Size      EQU     0x00000000
SVC_Stack_Size       EQU     0x00000008
ABT_Stack_Size       EQU     0x00000000
FIQ_Stack_Size       EQU     0x00000000
IRQ_Stack_Size       EQU     0x00000400
USR_Stack_Size      EQU     0x00010000

Stack_Size      EQU     (UND_Stack_Size + SVC_Stack_Size\
     + ABT_Stack_Size + FIQ_Stack_Size + IRQ_Stack_Size \
                 + USR_Stack_Size)

Heap_Size       EQU     0x00010000</code></pre><h4 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a><strong>Clock</strong></h4><pre><code>CLK_BASE                EQU     0x4C000000          ; Base Address
LOCKTIME_OFS        EQU     0x00                ; LOCKTIME Offset
MPLLCON_OFS        EQU     0x04               ; MPLLCON Offset
UPLLCON_OFS         EQU     0X08                ; UPLLCON Offset
CLKCON_OFS          EQU     0x0C                ; CLKCON Offset
CLKSLOW_OFS         EQU     0x10                ; CLKSLOW Offset
CLKDIVN_OFS         EQU     0X14                ; CLDKIVN Offset

CLK_SETUP               EQU     1
MPLLCON_Val         EQU     0x0005C080
UPLLCON_Val         EQU     0x00028080
CLKCON_Val          EQU     0x0007FFF0
CLKSLOW_Val         EQU     0x00000004
LOCKTIME_Val        EQU     0x00FFFFFF
CLKDIVN_Val         EQU     0X00000000</code></pre><h4 id="Watchdog-Timer"><a href="#Watchdog-Timer" class="headerlink" title="Watchdog Timer"></a><strong>Watchdog Timer</strong></h4><pre><code>WT_BASE           EQU     0x53000000      ; WT Base Address
WTCON_OFS         EQU     0x00                ; WTCON Offset
WTDAT_OFS      EQU     0x04               ; WTDAT Offset
WTCNT_OFS         EQU     0x08                ; WTCNT Offset

WT_SETUP            EQU     1
WTCON_Val          EQU     0x00008021
WTDAT_Val           EQU     0x00008000</code></pre><h4 id="Memory-Controller"><a href="#Memory-Controller" class="headerlink" title="Memory Controller"></a><strong>Memory Controller</strong></h4><pre><code>MC_BASE             EQU     0x48000000      ; Base Address
MC_SETUP            EQU     1

BANKCON0_Val    EQU     0x00000700    ; Bank Control
BANKCON1_Val    EQU     0x00000700
BANKCON2_Val    EQU     0x00000700
BANKCON3_Val    EQU     0x00000700
BANKCON4_Val    EQU     0x00000700
BANKCON5_Val    EQU     0x00000700
BANKCON6_Val    EQU     0x00018008
BANKCON7_Val    EQU     0x00018008
BWSCON_Val        EQU     0x00000000    ; Bus Width &amp; Wait Control 
REFRESH_Val        EQU     0x00ac0000    ; Refresh
BANKSIZE_Val      EQU     0x00000000    ; Banksize
MRSRB6_Val         EQU     0x00000020    ; SDRAM Mode Register Set 
MRSRB7_Val         EQU     0x00000000</code></pre><h4 id="IO-PORT"><a href="#IO-PORT" class="headerlink" title="IO PORT"></a><strong>IO PORT</strong></h4><pre><code>PIO_BASE            EQU     0x56000000          ; PIO Base Address
PCONA_OFS           EQU     0x00         ; PCONA Offset
……
PCONJ_OFS           EQU     0xD0       ; PCONJ Offset
PUPB_OFS            EQU     0x18                ; PUPB Offset
……
PUPJ_OFS            EQU     0xD8                ; PUPJ Offset
PIO_SETUP           EQU     1

PIOA_SETUP      EQU     0
PCONA_Val           EQU     0x000003FF

PIOB_SETUP        EQU     0
PCONB_Val           EQU     0x000007FF
PUPB_Val            EQU     0x00000000 </code></pre><h4 id="Area-Stack-Heap"><a href="#Area-Stack-Heap" class="headerlink" title="Area, Stack/Heap"></a><strong>Area, Stack/Heap</strong></h4><pre><code>        AREA    STACK, NOINIT, READWRITE, ALIGN=3

Stack_Mem          SPACE   Stack_Size

Stack_Top           EQU     Stack_Mem + Stack_Size

        AREA        HEAP, NOINIT, READWRITE, ALIGN=3
Heap_Mem        SPACE   Heap_Size</code></pre><ul>
<li>Arm栈满减</li>
</ul>
<h4 id="RESET"><a href="#RESET" class="headerlink" title="RESET"></a><strong>RESET</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117200011327.png" alt=""></p>
<h4 id="Vectors"><a href="#Vectors" class="headerlink" title="Vectors"></a><strong>Vectors</strong></h4><pre><code>Vectors      

    LDR     PC, Reset_Addr         
              LDR     PC, Undef_Addr
               LDR     PC, SWI_Addr
               LDR     PC, PAbt_Addr
               LDR     PC, DAbt_Addr
               NOP                            ; Reserved Vector 
               LDR     PC, IRQ_Addr
               LDR     PC, FIQ_Addr</code></pre><h4 id="IRQ-Entry"><a href="#IRQ-Entry" class="headerlink" title="IRQ_Entry"></a><strong>IRQ_Entry</strong></h4><pre><code>IRQ_Entry
                    sub    sp,sp,#4 ;reserved for PC      
                stmfd    sp!,{r8-r9}

                ldr    r9,=INTOFFSET
                ldr    r9,[r9]
                ldr    r8,=HandleEINT0
                add    r8,r8,r9,lsl #2
                ldr    r8,[r8]
                str    r8,[sp,#8]

                ldmfd    sp!,{r8-r9,pc} </code></pre><blockquote>
<p>LDMFD-&gt;LDMIA</p>
<p>STMFD-&gt;STMDB</p>
<p>只用r8，r9可以少备份</p>
</blockquote>
<h4 id="Reset-Handler"><a href="#Reset-Handler" class="headerlink" title="Reset_Handler"></a><strong>Reset_Handler</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117200129617.png" alt=""></p>
<h4 id="WT-Setup-MC-Setup"><a href="#WT-Setup-MC-Setup" class="headerlink" title="WT_Setup  MC_Setup"></a><strong>WT_Setup  MC_Setup</strong></h4><pre><code>    IF      WT_SETUP &lt;&gt; 0
    LDR     R0, =WT_BASE
        LDR     R1, =WTCON_Val
       LDR     R2, =WTDAT_Val
             STR     R2, [R0, #WTCNT_OFS]
              STR     R2, [R0, #WTDAT_OFS]
              STR     R1, [R0, #WTCON_OFS]  
    ENDIF

    IF      MC_SETUP &lt;&gt; 0        
    ADR         R14, MC_CFG
             LDMIA  R14, {R0-R12}
               LDR         R14, =MC_BASE
             STMIA  R14, {R0-R12}
    ENDIF </code></pre><h4 id="CLK-Setup"><a href="#CLK-Setup" class="headerlink" title="CLK_Setup"></a><strong>CLK_Setup</strong></h4><pre><code>    IF      CLK_SETUP &lt;&gt; 0        
    LDR     R0, =CLK_BASE            
    ADR     R8, CLK_CFG
       LDMIA   R8, {R1-R6}            
             STR     R1, [R0, #LOCKTIME_OFS]
              STR     R2, [R0, #CLKDIVN_OFS]  
             STR     R3, [R0, #MPLLCON_OFS] 
              STR     R4, [R0, #UPLLCON_OFS]  
             STR     R5, [R0, #CLKSLOW_OFS]
            STR     R6, [R0, #CLKCON_OFS]                
    ENDIF </code></pre><h4 id="PIO-Setup"><a href="#PIO-Setup" class="headerlink" title="PIO_Setup"></a><strong>PIO_Setup</strong></h4><pre><code>    IF      PIO_SETUP &lt;&gt; 0        
    LDR     R14, =PIO_BASE
    IF      PIOA_SETUP &lt;&gt; 0
    LDR     R0, =PCONA_Val
    STR     R0, [R14, #PCONA_OFS]
    ENDIF
     IF      PIOB_SETUP &lt;&gt; 0
            LDR     R0, =PCONB_Val
           LDR     R1, =PUPB_Val
          STR     R0, [R14, #PCONB_OFS]
           STR     R1, [R14, #PUPB_OFS]
             ENDIF
    ……
    ENDIF </code></pre><h4 id="Stack-Setup"><a href="#Stack-Setup" class="headerlink" title="Stack_Setup"></a><strong>Stack_Setup</strong></h4><pre><code>; Setup Stack for each mode
            LDR     R0, =Stack_Top
;  Enter Undefined Instruction Mode and set its Stack Pointer                
    MSR        CPSR_c, #Mode_UND:OR:I_Bit:OR:F_Bit
            MOV        SP, R0
              SUB         R0, R0, #UND_Stack_Size</code></pre><h4 id="Enter-C-Code"><a href="#Enter-C-Code" class="headerlink" title="Enter C Code"></a><strong>Enter C Code</strong></h4><pre><code>     IMPORT      __main
              LDR             R0, =__main
              BX              R0</code></pre><blockquote>
<p>Msr ：通用寄存器写到状态寄存器</p>
<p>Mrs：反过来</p>
<p>__mian调用arm库函数</p>
<p>__main -&gt; init -&gt; main</p>
</blockquote>
<h4 id="user-initial-stackheap"><a href="#user-initial-stackheap" class="headerlink" title="__user_initial_stackheap"></a>__user_initial_stackheap</h4><pre><code>    EXPORT  __user_initial_stackheap
__user_initial_stackheap
                LDR     R0, =  Heap_Mem
                LDR     R1, =(Stack_Mem + USR_Stack_Size)
                LDR     R2, = (Heap_Mem +      Heap_Size)
                LDR     R3, = Stack_Mem
                BX          LR</code></pre><h4 id="user-initial-stackheap-C"><a href="#user-initial-stackheap-C" class="headerlink" title="__user_initial_stackheap(C)"></a>__user_initial_stackheap(C)</h4><pre><code> struct __initial_stackheap {  
      unsigned heap_base;                 
        unsigned stack_base;              
       unsigned heap_limit;                
       unsigned stack_limit; 
    };  

_value_in_regs struct __initial_stackheap 
    __user_initial_stackheap(void);
/*
        __user_initial_stackheap(unsigned SP)  
     {  
    struct __initial_stackheap config;  
    config.stack_base = SP;  
    config.stack_limit = SP-STACK_SIZE;  
    config.heap_base  = (unsigned)(USER_HEAP_ADDRESS)    
    config.heap_limit = ((unsigned)(USER _HEAP_ADDRESS))
        +USER_SRAM_SIZE;  
    return config;   
}  
*/</code></pre><p>如果调试时无法进入main，可能的原因是什么？</p>
<h2 id="软中断"><a href="#软中断" class="headerlink" title="软中断"></a><strong>软中断</strong></h2><p>如何通过软中断方式调用一个函数，该函数计算4个整数的和。</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a><strong>过程</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117200805043.png" alt=""></p>
<blockquote>
<p>SWI：软中断指令</p>
<p>XXX：中断信号</p>
</blockquote>
<h3 id="SWI-Handler"><a href="#SWI-Handler" class="headerlink" title="SWI_Handler"></a><strong>SWI_Handler</strong></h3><h4 id="Get-SWI-Num"><a href="#Get-SWI-Num" class="headerlink" title="Get SWI Num"></a>Get SWI Num</h4><pre class="line-numbers language-assembly"><code class="language-assembly">        AREA TopSwi, CODE, READONLY
        IMPORT        C_SWI_Handler 
        EXPORT         SWI_Handler
SWI_Handler
        STMFD      sp!,{r0-r12,lr}
        LDR        r0,[lr,#-4]             ;获取 SWI 指令
        BIC        r0,r0,#0xff000000     ; 参数1，NUM
        MOV            R1, SP                   ;参数2，传递堆栈指针
         BL C_SWI_Handler                 ;To Function
           LDMFD        sp!, {r0-r12,pc}^
           END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>r0,[lr,#-4]  把swi指令读到r0</p>
<p>BIC清除高8位，得到中断号</p>
<p>这里用BL是因为lr已经备份到栈里面了</p>
<p>通常减8获取上一条指令，SWI特殊需要减4</p>
</blockquote>
<h4 id="Function-C"><a href="#Function-C" class="headerlink" title="Function (C)"></a>Function (C)</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">C_SWI_handler</span> <span class="token punctuation">(</span><span class="token keyword">int</span> swi_num<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>reg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>     <span class="token keyword">switch</span> <span class="token punctuation">(</span>swi_num<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0</span> <span class="token punctuation">:</span> 
            ……               <span class="token comment" spellcheck="true">/* SWI number 0 code */</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span> <span class="token punctuation">:</span>                 
            ……            <span class="token comment" spellcheck="true">/* SWI number 1 code */</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
        ……
            <span class="token keyword">default</span> <span class="token punctuation">:</span>   
            <span class="token keyword">break</span>；<span class="token comment" spellcheck="true">/* Unknown SWI - report error */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>R0:中断号</p>
<p>R1:栈指针</p>
</blockquote>
<h4 id="Function-asm"><a href="#Function-asm" class="headerlink" title="Function (asm)"></a>Function (asm)</h4><pre class="line-numbers language-assembly"><code class="language-assembly">         AREA SecondSwi, CODE, READONLY 
         EXPORT     C_SWI_Handler
C_SWI_Handler 
        STMFD      sp!,{r0-r12,lr}
    CMP    r0,#MaxSWI          ; Range check？
        LDRLE  pc, [pc,r0,LSL #2] ;(PC-〉DCD SWInum0)
       B          SWIOutOfRange 
SWIJumpTable    DCD    SWInum0
        DCD    SWInum1
SWInum0   ; SWI number 0 code
            B    EndofSWI
SWInum1   ; SWI number 1 code
            B    EndofSW
EndofSW    SUB lr, lr, #4
        LDMFD        sp!, {r0-r12,pc}^
           END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="SWI异常"><a href="#SWI异常" class="headerlink" title="SWI异常"></a>SWI异常</h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117201327667.png" alt=""></p>
<blockquote>
<p>Swi（0）关键字，产生软中断，0为中断信号</p>
<p>函数参数存到r0</p>
</blockquote>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="声明"><a href="#声明" class="headerlink" title="声明"></a><strong>声明</strong></h4><pre><code>__swi(0) int add_four(int, int, int, int);   〈- 寄存器传数据</code></pre><h4 id="调用"><a href="#调用" class="headerlink" title="调用"></a><strong>调用</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"swi.h"</span></span>
<span class="token keyword">unsigned</span> <span class="token operator">*</span>swi_vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x08</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">SWI_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>     
    <span class="token keyword">int</span> res<span class="token punctuation">;</span> 

    <span class="token function">Install_Handler</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> SWI_Handler<span class="token punctuation">,</span> swi_vec <span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token operator">=</span><span class="token function">add_four</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Install_Handler注册中断服务程序</li>
</ul>
<h4 id="函数体"><a href="#函数体" class="headerlink" title="函数体"></a><strong>函数体</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">C_SWI_Handler</span><span class="token punctuation">(</span> <span class="token keyword">int</span> swi_num<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span> swi_num <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>    
    <span class="token keyword">case</span>    <span class="token number">0</span><span class="token punctuation">:</span>
        ptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>ptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span>   <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">//(next page)</span>
            <span class="token keyword">break</span>；   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>之所以用栈指针是因为在软中断发生r0到r12和lr都存到了栈中，最低的地址就是r0；且返回结果就是栈底，即r0</li>
</ul>
<h4 id="返回结构体"><a href="#返回结构体" class="headerlink" title="返回结构体"></a><strong>返回结构体</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> four_results
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">__swi</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">struct</span> four_results <span class="token function">many_operations</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="函数体-1"><a href="#函数体-1" class="headerlink" title="函数体"></a><strong>函数体</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">case</span>    <span class="token number">1</span><span class="token punctuation">:</span>

    <span class="token keyword">int</span> w<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">;</span>

    w <span class="token operator">=</span> ptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            x <span class="token operator">=</span> ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            y <span class="token operator">=</span> ptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            z <span class="token operator">=</span> ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

           ptr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> w <span class="token operator">+</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z<span class="token punctuation">;</span>
            ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> w <span class="token operator">-</span> x <span class="token operator">-</span> y <span class="token operator">-</span> z<span class="token punctuation">;</span>
            ptr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> w <span class="token operator">*</span> x <span class="token operator">*</span> y <span class="token operator">*</span> z<span class="token punctuation">;</span>
            ptr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token punctuation">(</span>w <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="add-four"><a href="#add-four" class="headerlink" title="add_four"></a><strong>add_four</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117201734574.png" alt=""></p>
<h4 id="参数传递和结果返回"><a href="#参数传递和结果返回" class="headerlink" title="参数传递和结果返回"></a><strong>参数传递和结果返回</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117201800601.png" alt=""></p>
<h2 id="Build"><a href="#Build" class="headerlink" title="Build"></a><strong>Build</strong></h2><ul>
<li>armasm    </li>
<li>input file</li>
<li>-o filename //output file name</li>
<li>-16|-32 //Thumb or ARM Instruction</li>
<li>-cpu cpu // Set the target CPU</li>
<li>-bigend|-littleend</li>
<li>-FPU name // target float-point unit</li>
<li>-apcs // ARM/Thumb Procedure Call Standard</li>
</ul>
<blockquote>
<p>编译时的-16｜-32 与code里的命令不一样时，优先code</p>
</blockquote>
<h3 id="armlink"><a href="#armlink" class="headerlink" title="armlink"></a>armlink</h3><ul>
<li><p>-output file</p>
<ul>
<li>指定了输出文件名，该文件可能是部分链接的目标文件，也可能是可执行映像文件。</li>
</ul>
</li>
<li><p>-elf </p>
<ul>
<li>生成ELF格式的映像文件，armlink所支持的唯一的一种输出格式。</li>
</ul>
</li>
<li><p>-reloc</p>
<ul>
<li>生成可重定址的映像。程序地址使用相对地址</li>
</ul>
</li>
<li><p>-ro-base address </p>
<ul>
<li>包含有RO(Read-Only属性)输出段的加载地址和运行地址设置为address.</li>
</ul>
</li>
<li><p>-ropi</p>
<ul>
<li>使得包含有RO输出段的加载域和运行域是位置无关的。</li>
</ul>
</li>
<li><p>rw-base address </p>
<ul>
<li>设置包含RW(Read/Write属性)输出段的域的运行时地址.</li>
</ul>
</li>
<li><p>-rwpi</p>
<ul>
<li>使得包含有RW和ZI(Zero Initialization，初始化为0)属性的输出段的加载和运行时域为位置无关的。</li>
</ul>
</li>
<li><p>-split </p>
<ul>
<li>将包含RO和RW属性的输出段的加载域，分割成2个加载域。</li>
</ul>
</li>
<li><p>-scatter file </p>
<ul>
<li>使用在file中包含的分组和定位信息来创建映像内存映射。</li>
</ul>
</li>
<li><p>-debug </p>
<ul>
<li>使输出文件包含调试信息，调试信息包括，调试输入段，符号和字符串表。</li>
</ul>
</li>
<li><p>-entry location </p>
<ul>
<li><p>指定映像文件中唯一的初始化入口点。</p>
<ul>
<li><p>数值地址，如-entry 0x0；</p>
</li>
<li><p>符号所代表的地址处，如：-entry int_handler</p>
</li>
<li><p>段内偏移量，如：-entry offset+object(section)</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>-first section-id </p>
<ul>
<li>将被选择的输入段放在运行域的开始<ul>
<li>symbol 选择定义symbol的段。</li>
<li>object(section) 从目标文件中选择段放在映像文件的开始位置。例如： -first init.o(init)</li>
<li>object 选择只有一个输入段的目标文件。如： -first init.o  </li>
</ul>
</li>
</ul>
</li>
<li><p>-last section-id </p>
<ul>
<li>将所选择的输入段放在运行域的最后</li>
</ul>
</li>
<li><p>-map</p>
<ul>
<li>创建映像文件的信息图</li>
</ul>
</li>
</ul>
<h2 id="Scatter"><a href="#Scatter" class="headerlink" title="Scatter"></a><strong>Scatter</strong></h2><p>如何理解和编写.sct文件？</p>
<blockquote>
<p>分散加载文件</p>
<p>使用者：liner用的</p>
</blockquote>
<h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a><strong>组成</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117202237297.png" alt=""></p>
<h3 id="示例一："><a href="#示例一：" class="headerlink" title="示例一："></a>示例一：</h3><h4 id="文件"><a href="#文件" class="headerlink" title="文件"></a><strong>文件</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117202328750.png" alt=""></p>
<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a><strong>映射</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117202358905.png" alt=""></p>
<h3 id="示例二："><a href="#示例二：" class="headerlink" title="示例二："></a>示例二：</h3><h4 id="文件-1"><a href="#文件-1" class="headerlink" title="文件"></a><strong>文件</strong></h4><pre><code>ROM_LOAD 0x0
{    
    ROM_EXEC 0x0
    {     vectors.o (Vect, +First)
                * (+RO) 
    }        
    RAM 0x28000000     FIXED
    {    * (+RW,+ZI) }    
    HEAP +0 UNINIT
    {    heap.o (+ZI) }
    STACKS 0x28080000 UNINIT
    {    stack.o (+ZI) }    
    UART0 0x16000000 UNINIT
     {    uart.o (+ZI) }
   }</code></pre><blockquote>
<p>* (+RO) 所有RO属性的值</p>
<p>UART0</p>
</blockquote>
<h4 id="映射-1"><a href="#映射-1" class="headerlink" title="映射"></a><strong>映射</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117202605454.png" alt=""></p>
<h3 id="At-a-specific-address-without-scatter-loading"><a href="#At-a-specific-address-without-scatter-loading" class="headerlink" title="At a specific address without scatter-loading"></a><strong>At a specific address without scatter-loading</strong></h3><p><strong>main.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> gSquared <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0x5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Place at 0x5000</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     gSquared<span class="token operator">=</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value squared is: %d\n"</span><span class="token punctuation">,</span> gSquared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>function.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
      <span class="token keyword">return</span> n1<span class="token operator">*</span>n1<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>栈里全局变量，全局变量可以直接指定地址；局部变量需要用栈</li>
</ul>
<h3 id="In-a-named-section-with-scatter-loading"><a href="#In-a-named-section-with-scatter-loading" class="headerlink" title="In a named section with scatter-loading"></a><strong>In a named section with scatter-loading</strong></h3><p><strong>main.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">gsquaed__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span>“foo”<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>；<span class="token comment" spellcheck="true">//place in section “foo”</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     gSquared<span class="token operator">=</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value squared is: %d\n"</span><span class="token punctuation">,</span> gSquared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>scatter.sct</strong></p>
<pre><code>LR1 0x0000 0x20000
{  ……
   ER3 0x10000 0x2000{
     function.o
     *(foo) ; Place gSquared in ER3
    }
     ……}</code></pre><h3 id="At-a-specific-address-with-scatter-loading"><a href="#At-a-specific-address-with-scatter-loading" class="headerlink" title="At a specific address with scatter-loading"></a><strong>At a specific address with scatter-loading</strong></h3><p><strong>main.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> gValue <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".ARM.__at_0x10000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     gSquared<span class="token operator">=</span><span class="token function">sqr</span><span class="token punctuation">(</span>gValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value squared is: %d\n"</span><span class="token punctuation">,</span> gSquared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>scatter.sct</strong></p>
<pre><code>LR1 0x0000 0x20000
{  ……
   ER2 +0
   {
    function.o
      *(.ARM.__at_0x10000) ; Place gValue at 0x10000
    }    
     ……}</code></pre><h3 id="Placement-a-function-a-specific-address"><a href="#Placement-a-function-a-specific-address" class="headerlink" title="Placement a function a specific address"></a><strong>Placement a function a specific address</strong></h3><p><strong>function.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".ARM.__at_0x20000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
      <span class="token keyword">return</span> n1<span class="token operator">*</span>n1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// place flash_key in a section called .ARM.__at_0x8000</span>
<span class="token keyword">long</span> flash_key <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".ARM.__at_0x8000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>scatter.sct</strong></p>
<pre><code>ER_FLASH 0x8000 0x2000
{
        *(+RW)
       *(.ARM.__at_0x8000) ; key
}</code></pre><blockquote>
<p>C代码全局变量的设置地址一般放在sct文件中设置</p>
</blockquote>
<h3 id="place-a-named-section-with-scatter-loading"><a href="#place-a-named-section-with-scatter-loading" class="headerlink" title="place a named section with scatter-loading"></a><strong>place a named section with scatter-loading</strong></h3><p><strong>init.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">"INIT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>data.c</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">long</span> padding<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> z<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>scatter.sct</strong></p>
<pre><code>LR1 0x0 0x10000
{ ; Root Region, containing init code
      ER1 0x0 0x2000
     {
             init.o (INIT, +FIRST) ; place init code at exactly 0x0
    *(+RO) ; rest of code and read-only data
     }
; RW &amp; ZI data to be placed at 0x400000
     RAM_RW 0x400000 (0x1FF00-0x2000)
     {      *(+RW)  }
    RAM_ZI +0 { *(+ZI) 
      }
; execution region at 0x1FF00, maximum space available for table is 0xFF
    DATABLOCK 0x1FF00 0xFF
    { data.o(+RO-DATA) ; place RO data between 0x1FF00 and 0x1FFFF}    
}</code></pre><h3 id="Placement-of-unassigned-sections-with-the-ANY"><a href="#Placement-of-unassigned-sections-with-the-ANY" class="headerlink" title="Placement of unassigned sections with the .ANY"></a><strong>Placement of unassigned sections with the .ANY</strong></h3><p><strong>scatter.sct</strong></p>
<pre><code>lr1 0x8000 1024
{
    er1 +0 512
    {
        .ANY1(+RO) ; evenly distributed with er3
    }
    er2 +0 256
    {
        .ANY2(+RO) ; Highest priority, so filled first
    }
    er3 +0 256
    {
        .ANY1(+RO) ; evenly distributed with er1
    }
}</code></pre><h3 id="Placement-of-sections-with-overlays"><a href="#Placement-of-sections-with-overlays" class="headerlink" title="Placement of sections with overlays"></a><strong>Placement of sections with overlays</strong></h3><p><strong>scatter.sct</strong></p>
<pre><code>EMB_APP 0x8000
{
    …
    STATIC_RAM 0x0 ; contains most of the RW and ZI code/data
    {
        * (+RW,+ZI)
    }
    OVERLAY_A_RAM 0x1000 OVERLAY ; start address of overlay…
    {
        module1.o (+RW,+ZI)
    }
    OVERLAY_B_RAM 0x1000 OVERLAY
    {
        module2.o (+RW,+ZI)
    }
    … ; rest of scatter-loading description
}</code></pre><h3 id="Reserving-an-empty-region"><a href="#Reserving-an-empty-region" class="headerlink" title="Reserving an empty region"></a><strong>Reserving an empty region</strong></h3><p><strong>scatter.sct</strong></p>
<pre><code>EMB_APP 0x8000
{
    STACK 0x800000 EMPTY -0x10000 ; region     ;ends at 0x800000 because of the negative
    ; length. The start of the region is     ;calculated using the length.
    {
    ; Empty region for placing the stack
    }
    HEAP +0 EMPTY 0x10000 ; 
    ;region starts at the end of previous
    ; region. End of region calculated using
    ; positive length
    {
    ; Empty region for placing the heap
    }
    … ; rest of scatter-loading description
}</code></pre><p><img src="/images/loading.gif" data-original="../images/basic/image-20211117203328764.png" alt=""></p>
<h3 id="placing-ARM-C-library-code"><a href="#placing-ARM-C-library-code" class="headerlink" title="placing ARM C library code"></a><strong>placing ARM C library code</strong></h3><p><strong>scatter.sct</strong></p>
<pre><code>LR1 0x0
{
    ROM1 0
    {    * (InRoot$$Sections)
    * (+RO)
    }
    ROM2 0x1000
    {     *armlib/c_* (+RO) ; all ARM-supplied C library functions}
    ROM3 0x2000
    {    *armlib/h_* (+RO) ; just the ARM-supplied __ARM_*
    ; redistributable library functions
    }
    RAM1 0x3000
    {    *armlib* (+RO) ; all other ARM-supplied library code
    ; for example, floating-point libraries
     }
     RAM2 0x4000
     { * (+RW, +ZI)  }
}</code></pre><h3 id="placing-ARM-C-library-code-1"><a href="#placing-ARM-C-library-code-1" class="headerlink" title="placing ARM C++ library code"></a><strong>placing ARM C++ library code</strong></h3><pre><code>LR 0x0
{
    ER1 0x0
    {      *armlib*(+RO)  }
    ER2 +0
    {    *cpplib*(+RO)
    *(.init_array) ; Section .init_array must be placed explicitly,
    ; otherwise it is shared between two regions, and
    ; the linker is unable to decide where to place it.
    }
    ER3 +0
    {    *(+RO) }
    ER4 +0
    {    *(+RW,+ZI) }
}</code></pre><h3 id="Creation-of-regions-on-page-boundaries"><a href="#Creation-of-regions-on-page-boundaries" class="headerlink" title="Creation of regions on page boundaries"></a><strong>Creation of regions on page boundaries</strong></h3><pre><code>LR1 GetPageSize() + SizeOfHeaders()
{
    ER_RO +0
    {    *(+RO) }
    ER_RW AlignExpr(+0, GetPageSize())
    {    *(+RW)  }
    ER_ZI AlignExpr(+0, GetPageSize())
   {      *(+ZI) }
}</code></pre><h1 id="程序优化"><a href="#程序优化" class="headerlink" title="程序优化"></a>程序优化</h1><h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a><strong>问题</strong></h2><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203433221.png" alt=""></p>
<p>Hennessy and Patterson ,A New Golden Age for Computer Architecture: Domain-Specific Hardware/Software Co-Design, Enhanced Security, Open Instruction Sets, and Agile Chip Development, lecture, June 3, 2018</p>
<ul>
<li>Speed on different environments</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203458249.png" alt=""></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h2><p><strong>程序优化</strong></p>
<ul>
<li>指在不改变程序功能的情况下，根据处理器及系统的特性，通过修改原来程序的算法、结构，或利用软件开发工具对程序进行改进。使修改后的程序运行速度更快或占用空间更小或能耗最低。 </li>
</ul>
<p><strong>优化原则</strong></p>
<ul>
<li>等效原则，优化前后程序实现的功能一致。  </li>
<li>有效原则，优化后要比优化前运行速度快或占用存储空间小或能耗低，或三者兼有。  </li>
<li>经济原则，优化程序要付出较小的代价，取得较好的结果。</li>
</ul>
<p><strong>优化方法</strong></p>
<ul>
<li><p>算法优化</p>
<ul>
<li><p>选择一种高效的算法</p>
</li>
<li><p>对算法进行优化 </p>
</li>
<li><p>例：在数据搜索时，二分查找法要比顺序查找法快 </p>
</li>
</ul>
</li>
<li><p>数据结构优化</p>
<ul>
<li>采用访问比较快的数据结构</li>
<li>例：在一些无序的数据中多次进行插入、删除数据项操作，那么采用链表结构就会比较快 </li>
</ul>
</li>
<li><p>编译优化</p>
<ul>
<li>编译器有不同级别的优化选项，选用一种合适的优化方式。</li>
<li>针对体系结构进行了优化设计</li>
</ul>
</li>
<li><p>代码优化</p>
<ul>
<li>采用汇编语言或更精简的程序代码来代替原有的代码</li>
</ul>
</li>
</ul>
<h2 id="空间优化"><a href="#空间优化" class="headerlink" title="空间优化"></a><strong>空间优化</strong></h2><h3 id="Code-空间"><a href="#Code-空间" class="headerlink" title="Code 空间"></a>Code 空间</h3><p><strong>选择短长度指令集</strong></p>
<ul>
<li>ARM与THUMB</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203832806.png" alt=""></p>
<blockquote>
<p>减少rom空间</p>
<p>通过状态寄存器T来判断哪种指令</p>
</blockquote>
<p><strong>运算替换</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203911116.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203923732.png" alt=""></p>
<p><strong>循环替换</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124203941218.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204001844.png" alt=""></p>
<p><strong>数据类型</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204027011.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204038183.png" alt=""></p>
<blockquote>
<ul>
<li>const表示只读</li>
<li>Volatile（挥发）直接访问物理单元或IO端口，不是cache，保证读取数据的一致性</li>
<li>Register尽量将变量存进寄存器，否则局部变量存进栈</li>
</ul>
</blockquote>
<p><strong>内联函数</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204119955.png" alt=""></p>
<h3 id="Data-空间"><a href="#Data-空间" class="headerlink" title="Data 空间"></a>Data 空间</h3><p><strong>结构体</strong></p>
<ul>
<li><p>设处理器数据总线宽度为BUS_W，结构体中成员数据类型的最大宽度为 DATA_W，该结构体的自然边界为N，则 ：</p>
<ul>
<li>N=min(BUS_W, DATA_W)</li>
</ul>
</li>
<li><p>结构体内：</p>
<ul>
<li>成员类型宽度小于自然边界，以该类型宽度对齐；</li>
<li>成员类型宽度大于等于自然边界，以自然边界对齐。</li>
</ul>
</li>
<li><p>结构体之间：</p>
<ul>
<li>结构体的自然边界是该结构体中最大数据成员的自然边界。</li>
<li>结构体占用的空间是其自然边界的整数倍。</li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204234700.png" alt=""></p>
<p><strong>数据压缩</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204305188.png" alt=""></p>
<p><strong>数据类型</strong></p>
<ul>
<li>每个像素为 8bit，大小为 M 行 X N列的图像，选择不同的数据类型所占用的空间。</li>
</ul>
<pre><code>unsinged char image[M][N]; 

short image[M][N];

int image[M][N];</code></pre><p><strong>空间复用</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204420628.png" alt=""></p>
<p><strong>静态分配与动态分配</strong></p>
<p>下面两个使用数据空间的方式哪个更经济？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204450866.png" alt=""></p>
<blockquote>
<p>S3c2410A 的堆heap size初始为0，动态分配时需要注意修改，左边栈右边堆</p>
<p>软中断进入svc异常模式，不同模式对应不同堆栈，软中断的栈svc</p>
</blockquote>
<h2 id="降低能耗"><a href="#降低能耗" class="headerlink" title="降低能耗"></a><strong>降低能耗</strong></h2><p><strong>能耗与功率</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204538657.png" alt=""></p>
<p><strong>功率状态</strong></p>
<p>功率： Dynamic&gt;Standby（待机）&gt;Sleep(idle)&gt;off</p>
<p><strong>能耗管理</strong></p>
<ul>
<li><p>处理器工作状态（功耗状态，多核模式）；</p>
</li>
<li><p>系统工作状态（外设）；</p>
</li>
<li><p>系统工作时间。</p>
</li>
</ul>
<p><strong>程序优化</strong></p>
<ul>
<li>程序执行功耗<ul>
<li>减少指令数，减少执行时间（t)</li>
<li>选用功耗低的指令(P)</li>
</ul>
</li>
<li>系统管理（P）<ul>
<li>控制处理器<ul>
<li>降低主频</li>
<li>状态管理</li>
<li>模式管理</li>
</ul>
</li>
<li>控制系统<ul>
<li>减少内存访问次数</li>
<li>关断空闲外设</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>比较下列指令的功耗</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204812594.png" alt=""></p>
<blockquote>
<p>寄存器善良影响功耗</p>
<p>Mul &gt; Add</p>
<p>Add r0,r1,r2 &gt; add r0,r0,r0</p>
</blockquote>
<p><strong>功耗状态(S3C2410)</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204845711.png" alt=""></p>
<blockquote>
<p>这里power-off对应sleep，idle对应standby，只能外部事件中断唤醒，slow可通过程序进入normal</p>
</blockquote>
<h3 id="存储访问-1"><a href="#存储访问-1" class="headerlink" title="存储访问"></a><strong>存储访问</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124204934398.png" alt=""></p>
<h2 id="提高速度"><a href="#提高速度" class="headerlink" title="提高速度"></a><strong>提高速度</strong></h2><p><strong>目标</strong></p>
<ul>
<li>减少程序运行时实际执行的指令数；</li>
<li>减少指令执行时间。</li>
</ul>
<p><strong>途径</strong></p>
<ul>
<li>算法</li>
<li>数据类型</li>
<li>循环体</li>
<li>计算</li>
<li>存储访问</li>
</ul>
<p>对于处理器，如果某类型数的存访地址是自然边界的整数倍，则访问效率最高。</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a><strong>变量</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205130645.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205145391.png" alt=""></p>
<ul>
<li>对于char 数据类型，在i 和64比较之前，编译器增加了AND指令来保证i的范围在0-255之间；</li>
<li>计算过程中的局部变量应尽量避免使用char 和short 数据类型，除非需要使用char 和short的数据溢出特性。</li>
<li>存在主存中的数组和全局变量尽可能使用小尺寸的数据类型，以节省存储空间</li>
</ul>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a><strong>参数</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205226666.png" alt=""></p>
<ul>
<li><p>宽参数传递，被调用者把参数缩小到正确的范围。</p>
</li>
<li><p>宽返回，调用者把返回值缩小到正确的范围。</p>
</li>
<li><p>窄参数传递，调用者把参数缩小到正确的范围。</p>
</li>
<li><p>窄返回，被调用者把参数缩小到正确的范围。</p>
</li>
<li><p>GCC是宽参数传递和宽返回。</p>
</li>
<li><p>armcc 是窄参数传递与窄返回</p>
</li>
<li><p>尽量用int 或 unsigned int 型参数。</p>
</li>
<li><p>对于返回值尽量避免使用char和short类型。</p>
</li>
<li><p>防止编译器做不必要的类型转换</p>
</li>
</ul>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a><strong>类型转换</strong></h3><p>对于没有浮点运算指令的处理器，把浮点数转换成整数，用整数运算替代浮点运算，提高程序的执行速度。</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205403936.png" alt=""></p>
<p><strong>有符号数与无符号数</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205426380.png" alt=""></p>
<p>对于非负数的计算，采用无符号数类型效率更高</p>
<ul>
<li>ARM C中， 如果x 是负数，则x/2不是右移一位，而是加1后右移。例如：-3/2=-1。</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205451185.png" alt=""></p>
<ul>
<li><p>用右移计算除法时要考虑符号位</p>
</li>
<li><p>对于非负数的计算，采用无符号数类型效率更高。</p>
</li>
</ul>
<h3 id="循环体"><a href="#循环体" class="headerlink" title="循环体"></a><strong>循环体</strong></h3><ul>
<li>减少使整个循环过程中执行的指令数；</li>
<li>增加循环过程中连续顺序执行的指令数。</li>
</ul>
<p><strong>循环展开</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205547180.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205616295.png" alt=""></p>
<ul>
<li>通过循环展开，可以减少循环开销，提高程序执行速度；</li>
<li>展开循环可以减少程序的跳转，从而降低流水线中断的次数，提高程序执行的效率。</li>
</ul>
<p>循环展开后，循环开销从4N个周期，减少到4N/4=N个周期，提高速度。</p>
<p><strong>固定次数循环</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205709351.png" alt=""></p>
<ul>
<li><p>递加循环时增加一条CMP指令</p>
</li>
<li><p>尽量采用递减循环</p>
</li>
</ul>
<p><strong>不定次数循环</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205814024.png" alt=""></p>
<p><strong>减少重复运算</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205840383.png" alt=""></p>
<h3 id="计算替换"><a href="#计算替换" class="headerlink" title="计算替换"></a><strong>计算替换</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205903429.png" alt=""></p>
<h3 id="软件流水线"><a href="#软件流水线" class="headerlink" title="软件流水线"></a><strong>软件流水线</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205929499.png" alt=""></p>
<h3 id="计算替换-1"><a href="#计算替换-1" class="headerlink" title="计算替换"></a><strong>计算替换</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211124205954909.png" alt=""></p>
<p><strong>查找表</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210038167.png" alt=""></p>
<ul>
<li><p>对既消耗时间又消费资源的运算，应尽量使用查表的方式，并且将数据表置于程序存储区，但这需要预先计算出表的所有项。</p>
</li>
<li><p>如果表很大，则直接生成所需的表比较困难，此时可以在启动时的初始化函数中先计算，然后在数据存储器中生成所需的表，以后在程序运行直接查表就可以了，减少了程序执行过程中重复计算的工作量。 </p>
</li>
</ul>
<h3 id="存储管理-1"><a href="#存储管理-1" class="headerlink" title="存储管理"></a><strong>存储管理</strong></h3><p><strong>局部变量全局变量</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210138189.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210150988.png" alt=""></p>
<p><strong>边界不对齐</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210228961.png" alt=""></p>
<p><strong>巧用Cache</strong></p>
<p>一幅M行, N列的图像数据 AA，在内存中按行的顺序连续存放，下列哪段程序速度更快？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210310013.png" alt=""></p>
<p>右边是连续访问，提高cache命中率</p>
<p><strong>TCM</strong></p>
<ul>
<li><p>Atmel 公司的AT91SAM9G45内有64KB, 映射在内空间的起始地址为0x300000。设系统DDR2 RAM的容量为64MB, 映射到内存空间的起始地址为：0x70000000。</p>
</li>
<li><p>用该处理器实现DCT变换运算，连接时采用下列哪个.sct文件所生成的程序执行速度更快</p>
</li>
<li><p>将计算量较大的代码和常用数据放到片内RAM中</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210402247.png" alt=""></p>
<p><strong>减少存储器访问</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210419407.png" alt=""></p>
<ul>
<li>访问片外RAM或者Flash中的数据时，当需要多次读取或修改时，应遵循“读――改――写”模式，即首先读取片外RAM或者Flash中的数据，将其保存在片内RAM中，针对本地变量进行计算，计算完毕后再写回到片外RAM或者Flash中；而不是每修改一次就进行回写操作。 </li>
</ul>
<p><strong>去除相关性</strong></p>
<p>哪种更有效？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210505554.png" alt=""></p>
<ul>
<li>编译器不能确定写sum对in1和in2有无影响，从而in1和in2的读操作必须等到写sum操作完成之后才能进行，降低了流水效率 。</li>
<li>使用了关键字const，消除了指令之间的相关，从而使编译器能够判别内存操作之间的相关性，找到更好的指令执行方案。</li>
<li>消除数据之间的相关性，可以更有效地利用流水线提高程序的执行速度。</li>
</ul>
<p><strong>Register</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210540663.png" alt=""></p>
<p><strong>volatile</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210554442.png" alt=""></p>
<h3 id="分支跳转"><a href="#分支跳转" class="headerlink" title="分支跳转"></a><strong>分支跳转</strong></h3><ul>
<li><p>Switch-case</p>
</li>
<li><p>if- else</p>
</li>
<li><p>如果不同case值出现的频率不同，且可以预估。例如：ca1&lt;ca2&lt;ca3&lt;ca4, 则下判断语句，哪一个平均速度快？</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211124210833686.png" alt=""></p>
<ul>
<li>如何验证空间优化后的效果？</li>
<li>测试系统功耗的方法？</li>
<li>怎样观察程序的执行时间？</li>
</ul>
<h1 id="risc-v程序开发"><a href="#risc-v程序开发" class="headerlink" title="risc-v程序开发"></a>risc-v程序开发</h1><h2 id="RISC-V概述"><a href="#RISC-V概述" class="headerlink" title="RISC-V概述"></a>RISC-V概述</h2><h3 id="业界动态与发展过程"><a href="#业界动态与发展过程" class="headerlink" title="业界动态与发展过程"></a>业界动态与发展过程</h3><ul>
<li><p>RISC-I</p>
<ul>
<li>David A. Patterson and Carlo H. Sequin, RISC I: A reduced instruction set VLSI computer. In ISCA, 1981</li>
</ul>
</li>
<li><p>RISC-II</p>
<ul>
<li>Manolis G. H Katevenis, Robert W. Sherburne, Jr., David A. Patterson and Carlo H. Sequin, The RISC II micro-architecture. In Proceedings VLSI 83 Conference, 1983</li>
</ul>
</li>
<li><p>RISC-III(SOAR)</p>
<ul>
<li>David Ungar, Ricki Blau, Peter Foley, Dain Samples, and Patterson, Architecture of SOAR: Smalltalk on a RISC. In ISCA, 1984</li>
</ul>
</li>
<li><p>RISC-IV(SPUR)</p>
<ul>
<li>David D. Lee, Shing I. Kong, Mark D. Hill, Georges S. Taylor, David A. Hodges, Randy H. Katz, and David A. Patterson. A VLSI chip set for a multiprocessor workstation, IEEE JSSC, 1989</li>
</ul>
</li>
<li><p>RISC-V</p>
<ul>
<li>Krste Asanovic, 2010</li>
<li>V1.0, 2014</li>
<li>“V” , The fifth version, variation, vectors</li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/DL/image-20211130084818395.png" alt=""></p>
<h3 id="RISC-V-特点"><a href="#RISC-V-特点" class="headerlink" title="RISC-V 特点"></a>RISC-V 特点</h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130084955255.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085008588.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085021241.png" alt=""></p>
<h3 id="RISC-V-生态"><a href="#RISC-V-生态" class="headerlink" title="RISC-V 生态"></a>RISC-V 生态</h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085049355.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085100359.png" alt=""></p>
<h3 id="RISC-V-Software-Development"><a href="#RISC-V-Software-Development" class="headerlink" title="RISC-V Software Development"></a>RISC-V Software Development</h3><h4 id="开发过程-1"><a href="#开发过程-1" class="headerlink" title="开发过程"></a><strong>开发过程</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085134817.png" alt=""></p>
<h4 id="开发板"><a href="#开发板" class="headerlink" title="开发板"></a><strong>开发板</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085245626.png" alt=""></p>
<h4 id="开发环境和工具"><a href="#开发环境和工具" class="headerlink" title="开发环境和工具"></a><strong>开发环境和工具</strong></h4><p><strong>IDE</strong></p>
<ul>
<li>Nuclei Studio IDE, Nuclei</li>
</ul>
<p><a href="https://www.nucleisys.com/download.php" target="_blank" rel="noopener">https://www.nucleisys.com/download.php</a></p>
<ul>
<li>Freedom Studio, SiFive</li>
</ul>
<p><a href="https://www.sifive-china.com/site/Software_tools" target="_blank" rel="noopener">https://www.sifive-china.com/site/Software_tools</a></p>
<ul>
<li>RiscFree, Ashling</li>
</ul>
<p><a href="http://tools.emdoor.com/products/compiler/ashling/1693.html" target="_blank" rel="noopener">http://tools.emdoor.com/products/compiler/ashling/1693.html</a></p>
<ul>
<li>Embedded Studio, segger</li>
</ul>
<p><a href="https://www.segger.com/products/development-tools/embedded-studio/editions/risc-v/" target="_blank" rel="noopener">https://www.segger.com/products/development-tools/embedded-studio/editions/risc-v/</a></p>
<ul>
<li><p>IAR Embedded Workbench，IAR System</p>
<p><a href="https://www.iar.com/iar-embedded-workbench/" target="_blank" rel="noopener">https://www.iar.com/iar-embedded-workbench/</a></p>
</li>
</ul>
<p><strong>平台</strong></p>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Ubuntu</li>
</ul>
<p><a href="https://www.sifive-china.com/site/Software_tools" target="_blank" rel="noopener">https://www.sifive-china.com/site/Software_tools</a></p>
<h3 id="RISC-V-ISA"><a href="#RISC-V-ISA" class="headerlink" title="RISC-V ISA"></a>RISC-V ISA</h3><h4 id="架构特点"><a href="#架构特点" class="headerlink" title="架构特点"></a><strong>架构特点</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085447049.png" alt=""></p>
<h4 id="指令集模块"><a href="#指令集模块" class="headerlink" title="指令集模块"></a><strong>指令集模块</strong></h4><table>
<thead>
<tr>
<th><strong>基本指令集</strong></th>
<th><strong>指令数</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RV32I</td>
<td>47</td>
<td>32位地址空间、整数指令，32个寄存器</td>
</tr>
<tr>
<td>RV32E</td>
<td>47</td>
<td>RV32I子集，仅支持16个</td>
</tr>
<tr>
<td>RV64I</td>
<td>59</td>
<td>64位地址空间、整数指令，一部分32位整数指令</td>
</tr>
<tr>
<td>RV128I</td>
<td>71</td>
<td>128位地址空间、整数指令，一部分64、32位整数指令</td>
</tr>
<tr>
<td>扩展指令集</td>
<td></td>
<td></td>
</tr>
<tr>
<td>M</td>
<td>8</td>
<td>整数乘法与除法</td>
</tr>
<tr>
<td>A</td>
<td>11</td>
<td>存储器原子（atom）操作</td>
</tr>
<tr>
<td>F</td>
<td>26</td>
<td>单精度浮点</td>
</tr>
<tr>
<td>D</td>
<td>26</td>
<td>双精度浮点</td>
</tr>
<tr>
<td>C</td>
<td>46</td>
<td>压缩指令，16bit</td>
</tr>
<tr>
<td>Q</td>
<td>28</td>
<td>四精度浮点运算扩展</td>
</tr>
<tr>
<td>L</td>
<td></td>
<td>10进制浮点扩展</td>
</tr>
<tr>
<td>Zifencei</td>
<td>1</td>
<td>指令获取界限</td>
</tr>
</tbody></table>
<h4 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a><strong>Registers</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085532324.png" alt=""></p>
<blockquote>
<p>CSR寄存器是处理器内核内部的寄存器，使用专有的12位地址编码空间，对一个hart，可以配置4k的CSR寄存器。</p>
</blockquote>
<h4 id="addressing-mode"><a href="#addressing-mode" class="headerlink" title="addressing mode"></a>addressing mode</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085559247.png" alt=""></p>
<h4 id="Unprivileged-privileged-Mode"><a href="#Unprivileged-privileged-Mode" class="headerlink" title="Unprivileged /privileged Mode"></a><strong>Unprivileged /privileged Mode</strong></h4><p><strong>Levels</strong></p>
<table>
<thead>
<tr>
<th><strong>等级</strong></th>
<th><strong>编码</strong></th>
<th><strong>名称</strong></th>
<th><strong>缩写</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>0</strong></td>
<td>00</td>
<td>用户/应用模式（user/application  Mode）</td>
<td>U</td>
</tr>
<tr>
<td><strong>1</strong></td>
<td>01</td>
<td>监督者模式（supervisor  Mode）</td>
<td>S</td>
</tr>
<tr>
<td><strong>2</strong></td>
<td>10</td>
<td>管理者模式（Hypervisor  Mode）</td>
<td>H</td>
</tr>
<tr>
<td><strong>3</strong></td>
<td>11</td>
<td>机器模式（Machine  Mode）</td>
<td>M</td>
</tr>
</tbody></table>
<p><strong>Different Packages</strong></p>
<table>
<thead>
<tr>
<th><strong>模式数量</strong></th>
<th><strong>支持模式</strong></th>
<th><strong>目标应用</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>1</strong></td>
<td>M</td>
<td>简单嵌入式系统</td>
</tr>
<tr>
<td><strong>2</strong></td>
<td>M，U</td>
<td>安全嵌入式系统</td>
</tr>
<tr>
<td><strong>3</strong></td>
<td>M，S，U</td>
<td>支持Unix，Linux，Windows等操作系统</td>
</tr>
<tr>
<td><strong>4</strong></td>
<td>M，H，S，U</td>
<td>支持虚拟机系统</td>
</tr>
</tbody></table>
<h3 id="RISC-V-Processor"><a href="#RISC-V-Processor" class="headerlink" title="RISC-V Processor"></a><strong>RISC-V Processor</strong></h3><h4 id="RISC-V-core"><a href="#RISC-V-core" class="headerlink" title="RISC-V core"></a><strong>RISC-V core</strong></h4><ul>
<li>Rocket，Berkeley</li>
<li>Boom（Out-of-Order Machine），Berkeley</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085754944.png" alt=""></p>
<ul>
<li>SiFive</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085818789.png" alt=""></p>
<ul>
<li>RISC-V SOC</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085842349.png" alt=""></p>
<ul>
<li>Nuclei（芯来科技）</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130085905821.png" alt=""></p>
<h2 id="RV32I"><a href="#RV32I" class="headerlink" title="RV32I"></a>RV32I</h2><h3 id="RV32I指令"><a href="#RV32I指令" class="headerlink" title="RV32I指令"></a>RV32I指令</h3><h4 id="指令长度"><a href="#指令长度" class="headerlink" title="指令长度"></a><strong>指令长度</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090114868.png" alt=""></p>
<h4 id="指令类型"><a href="#指令类型" class="headerlink" title="指令类型"></a>指令类型</h4><ul>
<li>数值计算、存储访问、跳转控制、CSR访问、其他指令</li>
</ul>
<h3 id="RV32I-运算"><a href="#RV32I-运算" class="headerlink" title="RV32I-运算"></a>RV32I-运算</h3><h4 id="助记符"><a href="#助记符" class="headerlink" title="助记符"></a>助记符</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090251924.png" alt=""></p>
<h4 id="格式-1"><a href="#格式-1" class="headerlink" title="格式"></a><strong>格式</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090324619.png" alt=""></p>
<h4 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a><strong>算术运算</strong></h4><table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>示例</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>加法</strong></td>
<td><strong>add t0,t1,t2</strong></td>
<td><strong>t0=t1+t2</strong>；</td>
</tr>
<tr>
<td><strong>减法</strong></td>
<td><strong>sub t0,t1,t2</strong></td>
<td><strong>t0=t1-t2</strong>；</td>
</tr>
<tr>
<td><strong>立即数加法</strong></td>
<td><strong>addi t0,t1,200</strong></td>
<td><strong>t0=t1+200</strong>；</td>
</tr>
</tbody></table>
<ul>
<li>RV32I算术运算指令中，立即数的数值范围是imm[11:0]，12位</li>
</ul>
<h4 id="逻辑指令-1"><a href="#逻辑指令-1" class="headerlink" title="逻辑指令"></a><strong>逻辑指令</strong></h4><table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>示例</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>与</strong></td>
<td><strong>and t0,t1,t2</strong></td>
<td><strong>t0=t1&amp;t2</strong> ；按位与</td>
</tr>
<tr>
<td><strong>或</strong></td>
<td><strong>or t0,t1,t2</strong></td>
<td><strong>t0=t1|t2</strong>；按位或</td>
</tr>
<tr>
<td><strong>异或</strong></td>
<td><strong>xor</strong>  <strong>t0,t1,t2</strong></td>
<td><strong>t0=t1^t2</strong>；按位异或</td>
</tr>
<tr>
<td><strong>立即数与</strong></td>
<td><strong>andi</strong>  <strong>t0,t1,200</strong></td>
<td><strong>t0=t1&amp;200</strong>；按位与</td>
</tr>
<tr>
<td><strong>立即数或</strong></td>
<td><strong>ori t0,t1,200</strong></td>
<td><strong>t0=t1|200</strong>；按位或</td>
</tr>
<tr>
<td><strong>立即数异或</strong></td>
<td><strong>xori</strong>  <strong>t0,t1,200</strong></td>
<td><strong>t0=t1^200</strong>；按位异或</td>
</tr>
</tbody></table>
<ul>
<li>RV32I逻辑运算指令中立即数的数值范围是imm[11:0],12位</li>
</ul>
<h4 id="移位指令"><a href="#移位指令" class="headerlink" title="移位指令"></a><strong>移位指令</strong></h4><table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>示例</strong></th>
<th><strong>操作</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>逻辑左移</strong></td>
<td><strong>sll</strong>  <strong>t0,t1,t2</strong></td>
<td><strong>t0=t1&lt;&lt;t2</strong>；低位补0</td>
</tr>
<tr>
<td><strong>逻辑右移</strong></td>
<td><strong>srl</strong>  <strong>t0,t1,t2</strong></td>
<td><strong>t0=t1&gt;&gt;t2</strong>；高位补0</td>
</tr>
<tr>
<td><strong>算术右移</strong></td>
<td><strong>sar</strong>  <strong>t0,t1,t2</strong></td>
<td><strong>t0=t1&gt;&gt;t2</strong>；负数高位补1，正数高位补0</td>
</tr>
<tr>
<td><strong>立即数逻辑左移</strong></td>
<td><strong>slli</strong>  <strong>t0,t1,10</strong></td>
<td><strong>t0=t1&lt;&lt;10</strong>；低位补0</td>
</tr>
<tr>
<td><strong>立即数逻辑右移</strong></td>
<td><strong>srli</strong>  <strong>t0,t1,10</strong></td>
<td><strong>t0=t1&gt;&gt;10</strong>；高位补0</td>
</tr>
<tr>
<td><strong>立即数算术右移</strong></td>
<td><strong>srai t0,t1,10</strong></td>
<td><strong>t0=t1&gt;&gt;10</strong>；负数高位补1，正数高位补0</td>
</tr>
</tbody></table>
<ul>
<li>RV32I移位操作指令中立即数的数值范围imm[4:0],5位</li>
</ul>
<h3 id="RV32I-储存访问"><a href="#RV32I-储存访问" class="headerlink" title="RV32I-储存访问"></a>RV32I-储存访问</h3><h4 id="助记符-1"><a href="#助记符-1" class="headerlink" title="助记符"></a><strong>助记符</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090816209.png" alt=""></p>
<blockquote>
<p>选项U，设计扩展时才考虑</p>
</blockquote>
<h4 id="指令格式"><a href="#指令格式" class="headerlink" title="指令格式"></a><strong>指令格式</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090832235.png" alt=""></p>
<h4 id="访存"><a href="#访存" class="headerlink" title="访存"></a><strong>访存</strong></h4><table>
<thead>
<tr>
<th>指令</th>
<th>示例</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>装载字（32位）</td>
<td>lw t0, 50(t1)</td>
<td>t0=memory[t1+50]；将起始地址t1+50内存中4字节数写入t0。</td>
</tr>
<tr>
<td>装载半字（16位）</td>
<td>lh t0, 50(t1)</td>
<td>t0=memory[t1+50]；将起始地址t1+50内存中2字节数写入t0低16位；正数，高16位补0；负数，高16位补1。</td>
</tr>
<tr>
<td>装载半字（无符号）</td>
<td>lhu t0, 50(t1)</td>
<td>t0=memory[t1+50]；将起始地址t1+50内存中2字节数写入t0低16位；高16位补0。</td>
</tr>
<tr>
<td>装载字节（8位）</td>
<td>lb  t0, 50(t1)</td>
<td>t0=memory[t1+50]；将地址t1+50内存中1字节数写入t0；正数，高24位补0；负数，高24位补1。</td>
</tr>
<tr>
<td>装载字节（无符号）</td>
<td>lbu  t0, 50(t1)</td>
<td>t0=memory[t1+50]；将地址t1+50内存1字节数写入t0；高24位补0。</td>
</tr>
<tr>
<td>写字</td>
<td>sw  t0, 50(t1)</td>
<td>memory[t1+50]=t0；将t0中数据写入起始地址t1+50内存中。</td>
</tr>
<tr>
<td>写半字</td>
<td>sh  t0, 50(t1)</td>
<td>memory[t1+50]=t0；将t0中数据低16位写入起始地址t1+50内存中。</td>
</tr>
<tr>
<td>写字节</td>
<td>sb t0, 50(t1)</td>
<td>memory[t1+50]=t0；将t0中数据低8位写入地址t1+50内存中。</td>
</tr>
</tbody></table>
<blockquote>
<p>50不是4的倍数，有问题，lw是4字节对齐，lh是2字节对齐，lb无对齐</p>
</blockquote>
<ul>
<li>RV32I load和store指令中偏移量数值范围offset[11:0], 12位；</li>
<li>“lui”指令将立即数装载到目标寄存器的高20位，目标寄存器的低12位置0；</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130090942418.png" alt=""></p>
<ul>
<li>“auipc”指令将立即数加到pc的高20位；</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091016616.png" alt=""></p>
<ul>
<li>“lui”和“auipc”指令中立即数的范围是imm[19:0],20位。</li>
</ul>
<h3 id="RV32I-跳转"><a href="#RV32I-跳转" class="headerlink" title="RV32I-跳转"></a>RV32I-跳转</h3><h4 id="助记符-2"><a href="#助记符-2" class="headerlink" title="助记符"></a><strong>助记符</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091237078.png" alt=""></p>
<h4 id="指令格式-1"><a href="#指令格式-1" class="headerlink" title="指令格式"></a><strong>指令格式</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091326520.png" alt=""></p>
<h4 id="分支跳转-1"><a href="#分支跳转-1" class="headerlink" title="分支跳转"></a><strong>分支跳转</strong></h4><table>
<thead>
<tr>
<th>指令</th>
<th>示例</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>相等时分支</td>
<td>beq t0,t1,200</td>
<td>if（t0==t1) go to pc+200；pc相对跳转</td>
</tr>
<tr>
<td>不等时分支</td>
<td>bne t0,t1,200</td>
<td>if（t0！=t1) go to pc+200</td>
</tr>
<tr>
<td>小于时分支</td>
<td>blt t0,t1,200</td>
<td>if（t0&lt;t1) go to pc+200</td>
</tr>
<tr>
<td>大于等于时分支</td>
<td>bge t0,t1,200</td>
<td>if（t0&gt;=t1) go to pc+200</td>
</tr>
<tr>
<td>小于时分支（无符号）</td>
<td>bltu t0,t1,200</td>
<td>if（t0&lt;t1) go to pc+200；无符号数比较</td>
</tr>
<tr>
<td>大于小于时分支  （无符号）</td>
<td>bgeu t0,t1,200</td>
<td>if（t0&gt;=t1) go to pc+200；无符号数比较</td>
</tr>
</tbody></table>
<h4 id="无条件跳转"><a href="#无条件跳转" class="headerlink" title="无条件跳转"></a><strong>无条件跳转</strong></h4><table>
<thead>
<tr>
<th>指令</th>
<th>示例</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>带返回跳转</td>
<td>jal  ra,  200</td>
<td>ra= pc+4，保存下条指令指针  pc=pc+200， pc 相对跳转</td>
</tr>
<tr>
<td>带返回跳转（寄存器）</td>
<td>jalr  ra, 200（t0）</td>
<td>ra= pc+4，保存下条指令指针  pc=t0+200，寄存器相对跳转</td>
</tr>
</tbody></table>
<ul>
<li>无条件跳转指令包含两个操作数，返回指针寄存器（ra）和跳转目标地址。</li>
<li>对于指令jal，跳转目标地址是语句中的立即数表示与当前PC值之和。立即数的范围是imm[20:1],20位。</li>
<li>对于指令jalr，跳转的目标地址为地址寄存器（t0)中的值与偏移量之和。偏移量的数值范围是offset[11:0],12位。</li>
</ul>
<pre><code>1.start：
2.    add x10, x10, x22 
3.    lw x9, 0(x10) 
4.    bne x9, x24, end；if(x9!=x24) PC=PC+8 
5.    addi x12, x12, 1 
6.    beq x0, x0, start ; pc=pc-16
7. end:</code></pre><h3 id="RV32I-CSR"><a href="#RV32I-CSR" class="headerlink" title="RV32I-CSR"></a>RV32I-CSR</h3><h4 id="助记符-3"><a href="#助记符-3" class="headerlink" title="助记符"></a><strong>助记符</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091546525.png" alt=""></p>
<h4 id="格式-2"><a href="#格式-2" class="headerlink" title="格式"></a><strong>格式</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091604779.png" alt=""></p>
<table>
<thead>
<tr>
<th>指令</th>
<th>示例</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>先读后清除CSR</td>
<td>csrrc  t0, 0x123，t1</td>
<td>t0=[0x123]; [0x123]=t0 &amp; （~t1）;     把0x123中的值读入t0，然后用计算得到结果更新0x123中的值。</td>
</tr>
<tr>
<td>先读后置位CSR</td>
<td>csrrs  t0,0x123,t1</td>
<td>t0=[0x123];[0x123]=t0 | t1;  把0x123中的值读入t0，然后用计算得到结果更新0x123中的值。</td>
</tr>
<tr>
<td>先读后写CSR</td>
<td>csrrw  t0,0x123,t1</td>
<td>t0=[0x123];[0x123]=t1;  把0x123中的值读入t0，然后将t1中的值写入0x123中。</td>
</tr>
<tr>
<td>立即数先读后清除CSR</td>
<td>csrrci t0, 0x123，20</td>
<td>t0=[0x123]; [0x123]=t0 &amp; (~20);     把0x123中的值读入t0，然后用计算得到结果更新0x123中的值。</td>
</tr>
<tr>
<td>立即数先读后置位CSR</td>
<td>csrrsi t0,0x123,20</td>
<td>t0=[0x123];[0x123]=t0 | 20;  把0x123中的值读入t0，然后用计算得到结果更新0x123中的值。</td>
</tr>
<tr>
<td>立即数先读后写CSR</td>
<td>csrrwi t0,0x123,20</td>
<td>t0=[0x123];[0x123]=20;  把0x123中的值读入t0，然后将20中的值写入0x123中。</td>
</tr>
</tbody></table>
<h3 id="RV32I-其他"><a href="#RV32I-其他" class="headerlink" title="RV32I-其他"></a>RV32I-其他</h3><h4 id="助记符-4"><a href="#助记符-4" class="headerlink" title="助记符"></a><strong>助记符</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091750751.png" alt=""></p>
<h3 id="异常与中断"><a href="#异常与中断" class="headerlink" title="异常与中断"></a><strong>异常与中断</strong></h3><h4 id="异常响应过程"><a href="#异常响应过程" class="headerlink" title="异常响应过程"></a><strong>异常响应过程</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091901113.png" alt=""></p>
<ul>
<li>通过CSR寄存器管理处理器异常和中断事件的响应和处理过程。</li>
</ul>
<h4 id="特权模式转换"><a href="#特权模式转换" class="headerlink" title="特权模式转换"></a><strong>特权模式转换</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130091932598.png" alt=""></p>
<blockquote>
<p>不设委托模式，任何模式中断都回到机器模式，自己模式不能处理自己的异常，必须委托高一级处理</p>
</blockquote>
<table>
<thead>
<tr>
<th>操作</th>
<th>助记符</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>Machine-mode trap return</td>
<td>mret</td>
<td>M模式异常返回</td>
</tr>
<tr>
<td>Supervisor-mode trap return</td>
<td>sret</td>
<td>S模式异常返回</td>
</tr>
<tr>
<td>Supervisor-mode fence.virtual  memory address</td>
<td>sfence</td>
<td>S模式内存访问同步</td>
</tr>
</tbody></table>
<h4 id="异常和中断CSR"><a href="#异常和中断CSR" class="headerlink" title="异常和中断CSR"></a>异常和中断CSR</h4><table>
<thead>
<tr>
<th>符号</th>
<th>名称</th>
<th>功能描述</th>
<th>CSR空间地址</th>
</tr>
</thead>
<tbody><tr>
<td>mstatus</td>
<td>机器模式状态寄存器  （Machine Status Register）</td>
<td>寄存器中MIE和MPIE用于中断全局使能</td>
<td>0x300</td>
</tr>
<tr>
<td>mcause</td>
<td>机器模式异常原因寄存器  （Machine Cause Register）</td>
<td>进入异常的原因</td>
<td>0x342</td>
</tr>
<tr>
<td>mtvec</td>
<td>机器模式异常入口基地址寄存器  （Machine Trap-Vector Based-Address  Register）</td>
<td>中断向量表基地址，进入异常的PC地址</td>
<td>0x305</td>
</tr>
<tr>
<td>mtval</td>
<td>机器模式异常值寄存器  （Machine Trap Value Register）</td>
<td>进入异常的信息</td>
<td>0x343</td>
</tr>
<tr>
<td>mepc</td>
<td>机器模式异常PC寄存器  （Machine Exception Program Counter）</td>
<td>保存异常返回地址</td>
<td>0x341</td>
</tr>
<tr>
<td>mie</td>
<td>机器模式中断使能寄存器  （Machine Interrupt Enable Register）</td>
<td>中断局部使能</td>
<td>0x304</td>
</tr>
<tr>
<td>mip</td>
<td>机器模式中断等待寄存器  （Machine Interrupt Pending Register）</td>
<td>中断等待状态</td>
<td>0x344</td>
</tr>
</tbody></table>
<h4 id="进入异常-中断"><a href="#进入异常-中断" class="headerlink" title="进入异常/中断"></a>进入异常/中断</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130092029642.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130092040984.png" alt=""></p>
<h4 id="异常-vs-中断"><a href="#异常-vs-中断" class="headerlink" title="异常 vs 中断"></a>异常 vs 中断</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130092100954.png" alt=""></p>
<h2 id="GD32VF103"><a href="#GD32VF103" class="headerlink" title="GD32VF103"></a>GD32VF103</h2><h3 id="芯片"><a href="#芯片" class="headerlink" title="芯片"></a><strong>芯片</strong></h3><ul>
<li>BumleBee内核，32位RISC-V通用微控制器；</li>
<li>三条高速总线，即指令（I）总线、数据（D）总线和系统（System）总线；</li>
<li>采用哈佛体系结构，内存映射和高达4GB的内存空间；</li>
<li>32 KB的片上SRAM，地址0x2000 0000；</li>
<li>128KB 主FLASH ，地址0x0800 0000；</li>
<li>18KB 启动区，地址 0x000 000；</li>
<li>支持字节、半字（16位）和字（32位）访问</li>
</ul>
<h3 id="BumbleBee"><a href="#BumbleBee" class="headerlink" title="BumbleBee"></a><strong>BumbleBee</strong></h3><ul>
<li>支持RV32IMAC指令子集，机器模式（M）和用户模式（U）</li>
<li>两个私有64位计数器单元，时钟计数器（Timer) 和指令计数器（Counter)。</li>
<li>增强内核中断控制器（ECLIC）</li>
<li>软件中断、计时器中断和外部中断、支持16个中断级别、支持向量中断处理机制。</li>
<li>低功耗管理，支持WFI与WFE指令进入休眠模式，支持浅与深两级休眠模式。</li>
<li>不支持虚拟地址管理单元（MMU），所有地址访问操作都使用物理地址。</li>
</ul>
<h3 id="中断管理"><a href="#中断管理" class="headerlink" title="中断管理"></a><strong>中断管理</strong></h3><h4 id="内核中断控制器（Enhanced-Core-Local-Interrupt-Controller，ECLIC）"><a href="#内核中断控制器（Enhanced-Core-Local-Interrupt-Controller，ECLIC）" class="headerlink" title="内核中断控制器（Enhanced Core Local Interrupt Controller，ECLIC）"></a>内核中断控制器（Enhanced Core Local Interrupt Controller，ECLIC）</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130092427180.png" alt=""></p>
<h4 id="ECLIC-特点"><a href="#ECLIC-特点" class="headerlink" title="ECLIC 特点"></a>ECLIC 特点</h4><ul>
<li>可以支持4096个中断源（Interrupt Source），并为每个中断分配唯一编号（ID）；</li>
<li>控制每一个中断使能（IE）位，标志每一个中断的状态（IP）</li>
<li>设置每一个中断的电平或边沿属性（Level or Edge-Triggered）</li>
<li>设置中断级别和优先级（Level and Priority），</li>
<li>可以选择向量或非向量（Vector or Non-Vector Mode）中断响应方式。</li>
</ul>
<h4 id="ECLIC-寄存器"><a href="#ECLIC-寄存器" class="headerlink" title="ECLIC 寄存器"></a>ECLIC 寄存器</h4><p>CLIC寄存器映射在处理器内存地址空间，以访存方式进行读写。</p>
<table>
<thead>
<tr>
<th><strong>偏移量</strong></th>
<th><strong>属性</strong></th>
<th><strong>名称</strong></th>
<th><strong>宽度</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>0x0000</strong></td>
<td>可读可写</td>
<td>中断设置  cliccfg</td>
<td>8位</td>
</tr>
<tr>
<td><strong>0x0004</strong></td>
<td>只读，写忽略</td>
<td>中断信息  clicinfo</td>
<td>32位</td>
</tr>
<tr>
<td><strong>0x000b</strong></td>
<td>可读可写</td>
<td>阈值等级寄存器  mth</td>
<td>8位</td>
</tr>
<tr>
<td><strong>0x1000+4*i</strong></td>
<td>可读可写</td>
<td>中断标志寄存器  clicintip[i]</td>
<td>8位</td>
</tr>
<tr>
<td><strong>0x1001+4*i</strong></td>
<td>可读可写</td>
<td>中断使能寄存器  clicintie[i]</td>
<td>8位</td>
</tr>
<tr>
<td><strong>0x1002+4*i</strong></td>
<td>可读可写</td>
<td>中断属性寄存器  clicintattr[i]</td>
<td>8位</td>
</tr>
<tr>
<td><strong>0x1003+4*i</strong></td>
<td>可读可写</td>
<td>中断控制寄存器  clicintctl[i]</td>
<td>8位</td>
</tr>
</tbody></table>
<h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a><strong>Timer</strong></h4><ul>
<li>TIMER采用自动增加计数模式，其计数寄存器（mtime）由两个32位寄存器{mtime_hi，mtime_lo}拼成，分别保存计数的高32位和低32位。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>偏移量</strong></th>
<th><strong>属性</strong></th>
<th><strong>名称</strong></th>
<th><strong>功能描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>0x0</strong></td>
<td>可读写</td>
<td>mtime_lo</td>
<td>计时器mtime的低32位值</td>
</tr>
<tr>
<td><strong>0x4</strong></td>
<td>可读写</td>
<td>mtime_hi</td>
<td>计时器mtime的高32位值</td>
</tr>
<tr>
<td><strong>0x8</strong></td>
<td>可读写</td>
<td>mtimecmp_lo</td>
<td>计时器比较值mtimecmp低32位</td>
</tr>
<tr>
<td><strong>0xC</strong></td>
<td>可读写</td>
<td>mtimecmp_hi</td>
<td>计时器比较值mtimecmp高32位</td>
</tr>
<tr>
<td><strong>0xFF8</strong></td>
<td>可读写</td>
<td>mstop</td>
<td>计时器的暂停控制</td>
</tr>
<tr>
<td><strong>0xFFC</strong></td>
<td>可读写</td>
<td>msip</td>
<td>产生软件中断</td>
</tr>
</tbody></table>
<h2 id="键盘中断"><a href="#键盘中断" class="headerlink" title="键盘中断"></a><strong>键盘中断</strong></h2><h3 id="GD32VF103-EVAL"><a href="#GD32VF103-EVAL" class="headerlink" title="GD32VF103 -EVAL"></a>GD32VF103 -EVAL</h3><h4 id="EVAL-Board"><a href="#EVAL-Board" class="headerlink" title="EVAL Board"></a>EVAL Board</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130092943399.png" alt=""></p>
<h4 id="LED和KEY"><a href="#LED和KEY" class="headerlink" title="LED和KEY"></a>LED和KEY</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093003558.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093027263.png" alt=""></p>
<h4 id="GD-Linker-amp-Jtag"><a href="#GD-Linker-amp-Jtag" class="headerlink" title="GD-Linker &amp; Jtag"></a>GD-Linker &amp; Jtag</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093051847.png" alt=""></p>
<h3 id="中断处理"><a href="#中断处理" class="headerlink" title="中断处理"></a><strong>中断处理</strong></h3><h4 id="中断处理模式"><a href="#中断处理模式" class="headerlink" title="中断处理模式"></a><strong>中断处理模式</strong></h4><ul>
<li>向量中断处理模式和非向量中断处理模式。</li>
</ul>
<h4 id="向量中断"><a href="#向量中断" class="headerlink" title="向量中断"></a><strong>向量中断</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093147757.png" alt=""></p>
<p><strong>向量表</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093211843.png" alt=""></p>
<h4 id="非向量中断"><a href="#非向量中断" class="headerlink" title="非向量中断"></a>非向量中断</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093236400.png" alt=""></p>
<h4 id="GD32VF103中断机制"><a href="#GD32VF103中断机制" class="headerlink" title="GD32VF103中断机制"></a>GD32VF103中断机制</h4><ul>
<li>三层管理机制</li>
<li>RISC-V异常处理；</li>
<li>BumbleBee内核中断控制模块ECLIC；</li>
<li>外部中断和事件控制器（External interrupt and event，EXTI）。</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093317839.png" alt=""></p>
<h4 id="EXTI寄存器组"><a href="#EXTI寄存器组" class="headerlink" title="EXTI寄存器组"></a>EXTI寄存器组</h4><table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>地址偏移</strong></th>
<th><strong>初始值</strong></th>
<th><strong>功能</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>中断使能</strong>  <strong>EXTI_INTEN</strong></td>
<td>0x00</td>
<td>0x0000  0000</td>
<td>Bit  18:0, INT18:0使能  0：关闭；1：使能</td>
</tr>
<tr>
<td><strong>事件使能</strong>  <strong>EXTI_EVEN</strong></td>
<td>0x04</td>
<td>0x0000  0000</td>
<td>Bit  18:0, EV18:0使能  0：关闭；1：使能</td>
</tr>
<tr>
<td><strong>上升沿触发</strong>  <strong>EXTI_RTEN</strong></td>
<td>0x08</td>
<td>0x0000  0000</td>
<td>Bit  18:0, RT18:0使能  0：关闭；1：使能</td>
</tr>
<tr>
<td><strong>下降沿触发</strong>  <strong>EXTI_FTEN</strong></td>
<td>0x0c</td>
<td>0x0000  0000</td>
<td>Bit  18:0, FT18:0使能  0：关闭；1：使能</td>
</tr>
<tr>
<td><strong>软中断事件</strong>  <strong>EXTI_SWIEV</strong></td>
<td>0x10</td>
<td>0x0000  0000</td>
<td>Bit  18:0, SWI18:0使能  0：关闭；1：使能</td>
</tr>
<tr>
<td><strong>中断状态</strong>  <strong>EXTI_PD</strong></td>
<td>0x14</td>
<td>0x0000  0014</td>
<td>Bit  18:0, PD18:0使能  0：无触发；1：触发</td>
</tr>
</tbody></table>
<h4 id="GD32VF103中断向量"><a href="#GD32VF103中断向量" class="headerlink" title="GD32VF103中断向量"></a>GD32VF103中断向量</h4><ul>
<li>GD32VF103支持内核定时器中断，USART、I2C、ADC、DAC、FMC、SPI和RTC等所有芯片集成外设中断，以及EXIT[0:4]和EXTI[10:15]共11个外中断线。</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093422395.png" alt=""></p>
<h3 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a><strong>系统设置</strong></h3><h4 id="外中断请求路径"><a href="#外中断请求路径" class="headerlink" title="外中断请求路径"></a><strong>外中断请求路径</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130093504734.png" alt=""></p>
<h4 id="EXIT设置"><a href="#EXIT设置" class="headerlink" title="EXIT设置"></a>EXIT设置</h4><p><strong>初始化</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exti_init</span><span class="token punctuation">(</span>exti_line_enum linex<span class="token punctuation">,</span> exti_mode_enum mode<span class="token punctuation">,</span> exti_trig_type_enum trig_type<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//选则请求模式：中断/事件？</span>
        <span class="token keyword">case</span> EXTI_INTERRUPT<span class="token punctuation">:</span>
                EXTI_INTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>  <span class="token keyword">break</span>
        <span class="token keyword">case</span> EXTI_EVENT<span class="token punctuation">:</span>
                EXTI_EVEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>   <span class="token keyword">break</span><span class="token punctuation">;</span>
        …<span class="token punctuation">.</span>    <span class="token punctuation">}</span>
   <span class="token keyword">switch</span> <span class="token punctuation">(</span>trig_type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//选择触边沿：上升/下降/上升和下降</span>
        <span class="token keyword">case</span> EXTI_TRIG_RISING<span class="token punctuation">:</span>
                EXTI_RTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>
                EXTI_FTEN <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> EXTI_TRIG_FALLING<span class="token punctuation">:</span>
                EXTI_RTEN <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>
                EXTI_FTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> EXTI_TRIG_BOTH<span class="token punctuation">:</span>
                EXTI_RTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>
                EXTI_FTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>  <span class="token keyword">break</span><span class="token punctuation">;</span>
    ……<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>使能</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exti_interrupt_enable</span><span class="token punctuation">(</span>exti_line_enum linex<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    EXTI_INTEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//使能外中断: x=0...18</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">exti_event_enable</span><span class="token punctuation">(</span>exti_line_enum linex<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    EXTI_EVEN <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//事件使能</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>读取状态</strong></p>
<pre class="line-numbers language-c"><code class="language-c">FlagStatus <span class="token function">exti_flag_get</span><span class="token punctuation">(</span>exti_line_enum linex<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RESET <span class="token operator">!=</span> <span class="token punctuation">(</span>EXTI_PD <span class="token operator">&amp;</span> <span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span> linex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> SET<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> RESET<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ECLIC设置"><a href="#ECLIC设置" class="headerlink" title="ECLIC设置"></a>ECLIC设置</h4><p><strong>初始化</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_init</span><span class="token punctuation">(</span>uint32_t num_irq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">typedef</span> <span class="token keyword">volatile</span> uint32_t vuint32_t<span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_CFG_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//清除设置</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_MTH_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//清除设置</span>
         vuint32_t <span class="token operator">*</span> ptr<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//清除IP/IE/ATTR/CTRL位</span>
         vuint32_t <span class="token operator">*</span> base <span class="token operator">=</span> <span class="token punctuation">(</span>vuint32_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_INT_IP_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
         vuint32_t <span class="token operator">*</span> upper <span class="token operator">=</span> <span class="token punctuation">(</span>vuint32_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>base <span class="token operator">+</span> num_irq <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> base<span class="token punctuation">;</span> ptr <span class="token operator">&lt;</span> upper<span class="token punctuation">;</span> ptr <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
         <span class="token function">eclic_set_nlbits</span><span class="token punctuation">(</span>ECLIC_GROUP_LEVEL2_PRIO2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>中断使能</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_irq_enable</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t level<span class="token punctuation">,</span> uint8_t priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eclic_enable_interrupt</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//使能</span>
    <span class="token function">eclic_set_int_level</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设定源级</span>
    <span class="token function">eclic_set_int_priority</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> priority<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设定优先级</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>设置中断级</strong></p>
<pre class="line-numbers language-c"><code class="language-c">uint8_t <span class="token function">eclic_set_int_level</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t level<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//设定中断级</span>
    uint8_t nlbits <span class="token operator">=</span> <span class="token function">eclic_get_nlbits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取特定位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nlbits <span class="token operator">></span> ECLICINTCTLBITS<span class="token punctuation">)</span> <span class="token punctuation">{</span> nlbits <span class="token operator">=</span> ECLICINTCTLBITS<span class="token punctuation">;</span> <span class="token punctuation">}</span>
     level <span class="token operator">=</span> level <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> nlbits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//移位</span>
     uint8_t current_intctrl <span class="token operator">=</span> <span class="token function">eclic_get_intctrl</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//写入控制位</span>
     current_intctrl <span class="token operator">=</span> current_intctrl <span class="token operator">&lt;&lt;</span> nlbits<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//移位</span>
      current_intctrl <span class="token operator">=</span> current_intctrl <span class="token operator">>></span> nlbits<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//移位</span>
     <span class="token function">eclic_set_intctrl</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">(</span>current_intctrl <span class="token operator">|</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>设置优先级</strong></p>
<pre class="line-numbers language-c"><code class="language-c">uint8_t <span class="token function">eclic_set_int_priority</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint8_t nlbits <span class="token operator">=</span> <span class="token function">eclic_get_nlbits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nlbits <span class="token operator">>=</span> ECLICINTCTLBITS<span class="token punctuation">)</span> <span class="token punctuation">{</span>nlbits <span class="token operator">=</span> ECLICINTCTLBITS<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    priority <span class="token operator">=</span> priority <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> ECLICINTCTLBITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint8_t current_intctrl <span class="token operator">=</span> <span class="token function">eclic_get_intctrl</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    current_intctrl <span class="token operator">=</span> current_intctrl <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">-</span>nlbits<span class="token punctuation">)</span><span class="token punctuation">;</span>
    current_intctrl <span class="token operator">=</span> current_intctrl <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">-</span>nlbits<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eclic_set_intctrl</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">(</span>current_intctrl <span class="token operator">|</span> priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> priority<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>初始相关寄存器</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_set_intctrl</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t intctrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//中断源控制寄存器</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_INT_CTRL_OFFSET <span class="token operator">+</span> source <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span>     
     intctrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">eclic_set_intattr</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t intattr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//中断源属性寄存器</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_INT_ATTR_OFFSET <span class="token operator">+</span> source <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            intattr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">eclic_set_ecliccfg</span><span class="token punctuation">(</span>uint8_t ecliccfg<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 配置寄存器</span>
     <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_CFG_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> ecliccfg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">eclic_set_mth</span><span class="token punctuation">(</span>uint8_t mth<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//阈值</span>
     <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_MTH_OFFSET<span class="token punctuation">)</span> <span class="token operator">=</span> mth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">eclic_enable_interrupt</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//使能中断源</span>
       <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> uint8_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ECLIC_ADDR_BASE <span class="token operator">+</span> ECLIC_INT_IE_OFFSET <span class="token operator">+</span> source <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="CORE设置"><a href="#CORE设置" class="headerlink" title="CORE设置"></a>CORE设置</h4><p><strong>全局中断</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_global_interrupt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//使能全局中断</span>
<span class="token punctuation">{</span>
     <span class="token function">set_csr</span><span class="token punctuation">(</span>mstatus<span class="token punctuation">,</span> MSTATUS_MIE<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>设置中断处理方式（ECLIC/普通）</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_mode_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                       
    uint32_t mtvec_value <span class="token operator">=</span> <span class="token function">read_csr</span><span class="token punctuation">(</span>mtvec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mtvec_value <span class="token operator">=</span> mtvec_value <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFC0</span><span class="token punctuation">;</span>
    mtvec_value <span class="token operator">=</span> mtvec_value <span class="token operator">|</span> <span class="token number">0x00000003</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//ECLIC中断方式</span>
    <span class="token function">write_csr</span><span class="token punctuation">(</span>mtvec<span class="token punctuation">,</span> mtvec_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>设置向量响应方式（向量/非向量）</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">eclic_set_shv</span><span class="token punctuation">(</span>uint32_t source<span class="token punctuation">,</span> uint8_t shv<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//shv=1， 向量中断</span>
    uint8_t attr <span class="token operator">=</span> <span class="token function">eclic_get_intattr</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attr <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        <span class="token function">eclic_set_intattr</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="键盘中断-1"><a href="#键盘中断-1" class="headerlink" title="键盘中断"></a><strong>键盘中断</strong></h3><h4 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a><strong>原理图</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130094119832.png" alt=""></p>
<h4 id="中断向量表"><a href="#中断向量表" class="headerlink" title="中断向量表"></a><strong>中断向量表</strong></h4><pre class="line-numbers language-assembly"><code class="language-assembly">.section .vectors, "ax"                  //向量段
   ……
  .weak  EXTI5_9_IRQHandler           //声明中断ID5至ID9处理程序
    ……
  .weak  EXTI10_15_IRQHandler         //声明中断ID10至ID15处理程序
    ……
.globl vector_base
vector_base:                     //中断向量表基地址
  j Reset_Handler                //跳转到复位处理程序
  .align    2                 //四字节对齐
   ……
  .word     EXTI5_9_IRQHandler      //中断ID5至ID9处理程序入口地址
   ……
  .word     EXTI10_15_IRQHandler    //中断ID10到15处理程序入口地址，Int59
   ……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="选择向量EXTI13中断模式"><a href="#选择向量EXTI13中断模式" class="headerlink" title="选择向量EXTI13中断模式"></a>选择向量EXTI13中断模式</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> ECLIC_ADDR_BASE      0xd2000000    </span><span class="token comment" spellcheck="true">//ECLIC 映射基地址</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ECLIC_INT_ATTR_OFFSET  _AC(0x1002,UL) </span><span class="token comment" spellcheck="true">//中断属性寄存器偏移</span>
<span class="token function">eclic_set_shv</span><span class="token punctuation">(</span>EXTI10_15<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//设为向量中断型, EXTI10_15=59</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="开启中断"><a href="#开启中断" class="headerlink" title="开启中断"></a><strong>开启中断</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">//使能全局中断</span>
<span class="token function">global_interrupt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//函数调用</span>
<span class="token function">eclic_enable_interrupt</span><span class="token punctuation">(</span><span class="token function">eclic_set_shv</span><span class="token punctuation">(</span>EXTI10_15<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="设置向量表基址-ECLIC"><a href="#设置向量表基址-ECLIC" class="headerlink" title="设置向量表基址(ECLIC)"></a>设置向量表基址(ECLIC)</h4><pre class="line-numbers language-assembly"><code class="language-assembly"> //将向量表基地址写入寄存器t0
la t0, vector_base
//写入CSR寄存器, ECLIC 向量基址寄存器
csrw CSR_MTVT, t0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="中断服务程序"><a href="#中断服务程序" class="headerlink" title="中断服务程序"></a><strong>中断服务程序</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>interrupt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">EXTI10_15_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>RESET <span class="token operator">!=</span> <span class="token function">exti_interrupt_flag_get</span><span class="token punctuation">(</span>EXTI_13<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//EXTI_13？</span>
        <span class="token function">exti_interrupt_flag_clear</span><span class="token punctuation">(</span>EXTI_13<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//清除中断状态  </span>
        <span class="token function">led_flash</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true">//执行中断任务，LED闪烁 </span>
        <span class="token punctuation">}</span>  
      <span class="token function">eclic_global_interrupt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//打开全局中断使能</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a><strong>主程序</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//初始化连接LED的GPIO引脚</span>
    <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//初始化LED</span>
    <span class="token comment" spellcheck="true">//使能引脚时钟</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>RCU_GPIOC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//开启GPIO时钟</span>
    <span class="token function">rcu_periph_clock_enable</span><span class="token punctuation">(</span>RCU_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//开启功能引脚时钟</span>
    <span class="token function">eclic_set_shv</span><span class="token punctuation">(</span>EXTI10_15<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//设为向量中断型, EXTI10_15=59</span>
    <span class="token function">global_interrupt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//使能全局中断</span>
    <span class="token function">eclic_priority_group_set</span><span class="token punctuation">(</span>ECLIC_PRIGROUP_LEVEL3_PRIO1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设优先级</span>
    <span class="token function">gpio_init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> GPIO_MODE_IN_FLOATING<span class="token punctuation">,</span> GPIO_OSPEED_50MHZ<span class="token punctuation">,</span>                         GPIO_PIN_13<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设置PC13属性</span>
    <span class="token function">gpio_exti_source_select</span><span class="token punctuation">(</span>GPIO_PORT_SOURCE_GPIOC<span class="token punctuation">,</span>                             GPIO_PIN_SOURCE_13<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将PC13设为中断</span>
    <span class="token function">eclic_irq_enable</span><span class="token punctuation">(</span>EXTI10_15_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//使能中断 EXTI10-15</span>
    <span class="token function">exti_init</span><span class="token punctuation">(</span>EXTI_13<span class="token punctuation">,</span> EXTI_INTERRUPT<span class="token punctuation">,</span> EXTI_TRIG_FALLING<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设置触发方式</span>
    <span class="token function">exti_interrupt_flag_clear</span><span class="token punctuation">(</span>EXTI_13<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//清除中断状态位</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">__asm</span><span class="token punctuation">(</span>“wfi”<span class="token punctuation">)</span>； <span class="token punctuation">}</span>          <span class="token comment" spellcheck="true">//等待        </span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a><strong>小结</strong></h2><h3 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a><strong>Lab</strong></h3><ul>
<li><strong>在评估版上调试键盘中断程序（可选触屏）</strong></li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211130094447046.png" alt=""></p>
<h3 id="Embedded-studio"><a href="#Embedded-studio" class="headerlink" title="Embedded studio"></a><strong>Embedded</strong> <strong>studio</strong></h3><ul>
<li><p>在三实验中选择一个，编译，调试。</p>
</li>
<li><p>修改参考程序（界面或功能），重新编译，调试。</p>
</li>
</ul>
<h3 id="课后"><a href="#课后" class="headerlink" title="课后"></a><strong>课后</strong></h3><ul>
<li>安装 OpenMP开发环境，并调试运行下列程序。 </li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"omp.h"</span></span>
<span class="token keyword">int</span> <span class="token function">_tmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> _TCHAR<span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from serial.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread number = %d\n"</span><span class="token punctuation">,</span>
    <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//serial</span>
    <span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel        </span><span class="token comment" spellcheck="true">//parallel</span>
    <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from parallel.Thread number = %d\n"</span><span class="token punctuation">,</span>
        <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from serial again.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Programming-with-VS"><a href="#Programming-with-VS" class="headerlink" title="Programming with VS"></a><strong>Programming with VS</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211130094622677.png" alt=""></p>
<h1 id="多核处理器-OpenMP"><a href="#多核处理器-OpenMP" class="headerlink" title="多核处理器-OpenMP"></a>多核处理器-OpenMP</h1><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181307320.png" alt=""></p>
<h2 id="并行计算"><a href="#并行计算" class="headerlink" title="并行计算"></a><strong>并行计算</strong></h2><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181332691.png" alt=""></p>
<h3 id="处理器结构"><a href="#处理器结构" class="headerlink" title="处理器结构"></a><strong>处理器结构</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181444176.png" alt=""></p>
<h3 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a><strong>存储结构</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181529615.png" alt=""></p>
<h3 id="线程映射"><a href="#线程映射" class="headerlink" title="线程映射"></a><strong>线程映射</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181617087.png" alt=""></p>
<ul>
<li>HAL：硬件抽象层</li>
<li>多核必须操作系统支持</li>
</ul>
<h3 id="ARM-MPcore"><a href="#ARM-MPcore" class="headerlink" title="ARM MPcore"></a><strong>ARM</strong> <strong>MPcore</strong></h3><p><strong>Accelerator Coherency Port, ACP</strong></p>
<p><strong>Snoop Control Unit，SCU</strong></p>
<p>MPIDR：内核 ID 寄存器</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181713644.png" alt=""></p>
<blockquote>
<p>Advanced Custom Extension (ACE)</p>
<p>提供一个额外的PE（process element）识别机制属性：MPIDR_EL1是一个64位的寄存器MPIDR_EL1是一个64位的寄存器。</p>
<p>域值：</p>
<p>[63:40]：Reserved, RES0；</p>
<p>[39:32]：Affinity level3；</p>
<p>[31]：Reserved, RES1.</p>
<p>[30]：U 表示一个单处理器系统，与多处理器系统中的pe0不同。这个位的可能值是:0b0 ：处理器是多处理器系统的一部分。0b1 ：处理器是单处理器系统的一部分[29:25]：Reserved, RES0.</p>
<p>[24]：MT指示关联的最低级别是否由使用多线程类型方法实现的逻辑PEs组成。这个位的值可能是：0b0 当PEs的性能关联级别最低，或者使用MPIDR_EL1.MT的PEs被设置为1时，级别0的不同值或者级别1的相同值或更高级别，是相互独立的0b1 当PEs的性能关联级别最低，或者使用MPIDR_EL1.MT的PEs被设置为1时，级别0的不同值或者级别1的相同值或更高级别的相关性非常高。</p>
<p>[23:16]：Affinity level 2.</p>
<p>[15:8]：Affinity level 1. [11:8], 0x00-0x07: Core0-core7</p>
<p>[7:0]：Affinity level 0. 这个Affinity等级对于确定PE行为最为重要。更高级别的affinity 等级的重要性越低。分配给MPIDR的值的域的集合{Aff2, Aff1, Aff0}在整个系统中必须是不同的访问MPIDR_EL1：MRS , MPIDR_EL1</p>
</blockquote>
<h4 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a><strong>Interrupt</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181757722.png" alt=""></p>
<h4 id="Power-on-flow"><a href="#Power-on-flow" class="headerlink" title="Power on flow"></a><strong>Power on</strong> <strong>flow</strong></h4><p>可以用CPU1作为启动核吗？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206181830045.png" alt=""></p>
<h4 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a><strong>Bootloader</strong></h4><pre class="line-numbers language-assembly"><code class="language-assembly">     /*CPU0 */
    mrs  x4, mpidr_el1    //读取 寄存器    
     tst    x4,#15               //testwether the current cpu is CPU0,                    //ie. mpidr_el1=15         
    b.eq 2f
    /*  Secondary CPUs */
1: 
               wfe
    ldr x4, mbox               
    cbz x4, 1b        //if x4==0(ie. The value in address of mbox                   
                        //is 0) dead loop,or jump to x4
    br x4                // branch to thegiven address 
2:
                ……                  //UART initialisation<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>mbox的地址在Makefile中写定，保存在dts 文件中。</li>
<li>dts即Device Tree Source 设备树源码, DeviceTree是一种描述硬件的数据结构.</li>
</ul>
<blockquote>
<p>el0：用户模式</p>
<p>el1：管理员模式（什么中断，复位以后的模式，最常用的）</p>
<p>el2：虚拟机</p>
<p>el3：更高级的安全模式</p>
</blockquote>
<h4 id="Secondary-holding-pen"><a href="#Secondary-holding-pen" class="headerlink" title="Secondary_holding_pen()"></a><strong>Secondary_holding_pen()</strong></h4><pre class="line-numbers language-assembly"><code class="language-assembly">/* provides a"holding pen" to hold all secondary cores */      ENTRY(secondary_holding_pen)         
    bl      el2_setup                          // Drop to EL1         
    mrs  x0, mpidr_el1         
    and  x0, x0, #15                        // CPU number         
    adr   x1, 1b         
    ldp   x2, x3, [x1]         
    sub   x1, x1, x2         
    add  x3, x3, x1
pen:     
    ldr    x4, [x3]         
    cmp x4,x0         
    b.eq secondary_startup         
    wfe         
    b       pen
    ENDPROC(secondary_holding_pen)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ldp x1 , x0, [x1] ; 将[x1]中的值取出来, 放入x1 和 x0.</li>
</ul>
<h4 id="Fetching-Instructions"><a href="#Fetching-Instructions" class="headerlink" title="Fetching Instructions"></a><strong>Fetching Instructions</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206182146337.png" alt=""></p>
<h3 id="软件架构"><a href="#软件架构" class="headerlink" title="软件架构"></a><strong>软件架构</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206182231238.png" alt=""></p>
<h3 id="并行方法"><a href="#并行方法" class="headerlink" title="并行方法"></a><strong>并行方法</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206182311778.png" alt=""></p>
<h2 id="OpenMP"><a href="#OpenMP" class="headerlink" title="OpenMP"></a><strong>OpenMP</strong></h2><ul>
<li><p>直接控制共享内存式并行编程的应用程序接口（API)</p>
</li>
<li><p>由三个主要的API组成:</p>
<ul>
<li>编译指令</li>
<li>运行库 Runtime Library Routines</li>
<li>环境变量 Environment Variables</li>
</ul>
</li>
<li><p><strong>特点</strong></p>
<ul>
<li><p>可移植性Portable:</p>
</li>
<li><p>适合C/C++和Fortran的API</p>
</li>
<li><p>已在多种主要系统实现（ Unix/Linux platforms and Windows NT ）</p>
</li>
<li><p>由主要的硬件及软件厂家共同制定和支持</p>
</li>
<li><p>主流 SMP 并行程序开发库 </p>
</li>
</ul>
</li>
</ul>
<h3 id="程序结构"><a href="#程序结构" class="headerlink" title="程序结构"></a><strong>程序结构</strong></h3><p><strong>Fork-Joint Mode</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206182519353.png" alt=""></p>
<h3 id="编程"><a href="#编程" class="headerlink" title="编程"></a><strong>编程</strong></h3><ul>
<li>Implementation<ul>
<li>#pragma</li>
<li>Run time library</li>
</ul>
</li>
<li>Using Environment varies to control program execution threads. </li>
</ul>
<p>For example: OMP_NUM_THREADS</p>
<h3 id="例程"><a href="#例程" class="headerlink" title="例程"></a><strong>例程</strong></h3><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"omp.h"</span></span>
<span class="token keyword">int</span> <span class="token function">_tmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> _TCHAR<span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from serial.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread number = %d\n"</span><span class="token punctuation">,</span>
    <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//serial</span>
    <span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel        </span><span class="token comment" spellcheck="true">//parallel</span>
    <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from parallel.Thread number = %d\n"</span><span class="token punctuation">,</span>
        <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello from serial again.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="指令-1"><a href="#指令-1" class="headerlink" title="指令"></a><strong>指令</strong></h3><ul>
<li><p><strong>#pragma</strong></p>
<ul>
<li><p>parallel：表示这段代码将被并行执行。</p>
</li>
<li><p>for：表示将循环计算任务分配到多个线程中并行执行。</p>
</li>
<li><p>sections：用于实现多个结构块语句的任务分担。</p>
</li>
<li><p>parallel sections：类似于parallel for；</p>
</li>
<li><p>single：表示一段只被单个线程执行的代码；</p>
</li>
<li><p>critical：保证每次只有一个OpenMP线程进入；</p>
</li>
<li><p>flush：保证各个OpenMP线程的数据映像的一致性；</p>
</li>
<li><p>barrier：用于并行域内代码的线程同步，线程执行到barrier时要停下等待，直到所有线程都执行到barrier时才继续往下执行；atomic：用于指定一个数据操作需要原子性地完成；</p>
</li>
<li><p>master：用于指定一段代码由主线程执行；</p>
</li>
<li><p>Thread private：用于指定一个或多个变量是线程专用。</p>
</li>
</ul>
</li>
</ul>
<p><strong>后面会解释线程专有和私有的区别。</strong></p>
<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a><strong>循环</strong></h2><p>The results of two program ？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206182814300.png" alt=""></p>
<p>Are these two code segments equivalent？</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206183049247.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206183113472.png" alt=""></p>
<h3 id="Loop-restrictions"><a href="#Loop-restrictions" class="headerlink" title="Loop restrictions"></a><strong>Loop restrictions</strong></h3><ul>
<li><p>The loop variable must be type of <em>signed integer</em> (v2.5) .</p>
</li>
<li><p>The comparison operation must be in the form <em>loop_variable</em></p>
<ul>
<li>&lt;, &lt;=, &gt;, or &gt;=<em>loop_invariant_integer.</em></li>
</ul>
</li>
<li><p>The increment portion of the for loop must be <em>integer addition</em> or <em>integer subtraction</em> and by <em>a</em> <em>loop_invariant_value</em>.</p>
</li>
<li><p>The loop must be <em>a single entry</em> and <em>single exit,</em> meaning no jump from the inside of loop to outside or outside to the inside are permitted with the exception of the exit statement. No use <em>break, return and</em> <em>goto</em>.</p>
</li>
</ul>
<h2 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a><strong>变量</strong></h2><p>Any problem for parallelizing next loop？</p>
<pre class="line-numbers language-c"><code class="language-c">bool <span class="token function">calsum</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>image<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>sum<span class="token punctuation">)</span>
<span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> in hist<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">;</span>i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>    hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token operator">*</span><span class="token punctuation">(</span>sum<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    i<span class="token operator">=</span>IMAGE_WIDTH<span class="token operator">*</span>IMAGE_HEIGHT<span class="token punctuation">;</span>    
     <span class="token comment" spellcheck="true">//需要用for</span>
    <span class="token keyword">do</span><span class="token punctuation">{</span>  i<span class="token operator">--</span><span class="token punctuation">;</span>
        hist<span class="token punctuation">[</span><span class="token operator">*</span>image<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     image<span class="token operator">=</span>image<span class="token operator">-</span>IMAGE_WIDTH<span class="token operator">*</span>IMAGE_HEIGHT<span class="token punctuation">;</span> 
    <span class="token operator">*</span>sum<span class="token operator">=</span>hist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//for循环不能将i计算</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">256</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>   <span class="token operator">*</span><span class="token punctuation">(</span>sum<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">=</span>hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">*</span><span class="token punctuation">(</span>sum<span class="token operator">+</span>i<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Challenge？</p>
<p><em>Loop-carrier dependency</em></p>
<p><strong>下列程序哪个执行时间短？</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206183354289.png" alt=""></p>
<blockquote>
<p>共享数据打架，并行反而更慢</p>
</blockquote>
<ul>
<li>In parallel region, default behavior is that all variables are <em>shared</em> except loop index<ul>
<li>All threads read and write the same memory location for each variable</li>
<li>This is ok if threads are accessing different elements of an array</li>
<li>Problem if threads write same scalar or array element</li>
<li>Loop index is <em>private</em>, so each thread has its own copy</li>
</ul>
</li>
</ul>
<p>看看下列程序的执行时间</p>
<pre class="line-numbers language-c"><code class="language-c">ifirst <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> k<span class="token punctuation">[</span><span class="token number">600</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">60</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for private(i2)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">6000000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
     i2 <span class="token operator">=</span> i<span class="token operator">-</span><span class="token punctuation">(</span>i<span class="token operator">/</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">600</span><span class="token punctuation">;</span>
     k<span class="token punctuation">[</span>i2<span class="token punctuation">]</span> <span class="token operator">=</span> ifirst <span class="token operator">+</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="private"><a href="#private" class="headerlink" title="private"></a><strong>private</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206183456235.png" alt=""></p>
<p>How about variables in function？ </p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">mycalc</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>how about x, y ?</p>
<p><strong>试试这个程序</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> a<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for private(sum)</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sum <span class="token operator">+</span><span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>编译错误？</strong></p>
<p>试试（shared）</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> a<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">For</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
    sum<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for shared(sum)</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sum <span class="token operator">+</span><span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>“j<span class="token operator">=</span><span class="token operator">%</span>d<span class="token punctuation">,</span> sum<span class="token operator">=</span><span class="token operator">%</span>f\n”<span class="token punctuation">,</span>j<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>每次结果相同？为什么？</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> a<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
    sum<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sum <span class="token operator">+</span><span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>“j<span class="token operator">=</span><span class="token operator">%</span>d<span class="token punctuation">,</span> sum<span class="token operator">=</span><span class="token operator">%</span>f\n”<span class="token punctuation">,</span>j<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Critical"><a href="#Critical" class="headerlink" title="Critical"></a><strong>Critical</strong></h3><p><strong>Solution 1</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
flaot a<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sum<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for shared(sum)</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">#<span class="token directive keyword">pragma</span> omp critical    </span><span class="token comment" spellcheck="true">//让每次输出结果相同</span>
         sum <span class="token operator">+</span><span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>“j<span class="token operator">=</span><span class="token operator">%</span>d<span class="token punctuation">,</span> sum<span class="token operator">=</span><span class="token operator">%</span>f\n”<span class="token punctuation">,</span>j<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> sum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Critical-Construct"><a href="#Critical-Construct" class="headerlink" title="Critical Construct"></a><strong>Critical Construct</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206184254169.png" alt=""></p>
<blockquote>
<p>加锁：RES_lock</p>
</blockquote>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">dequeue</span><span class="token punctuation">(</span>NODE <span class="token operator">*</span> node<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
   <span class="token macro property">#<span class="token directive keyword">pragma</span> omp critical(x)</span>
   <span class="token punctuation">{</span>
    node<span class="token operator">=</span>node<span class="token operator">-></span>next<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">do_work</span><span class="token punctuation">(</span>NODE <span class="token operator">*</span>node<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp critical(x)</span>
   <span class="token punctuation">{</span>
    node<span class="token operator">-></span>next<span class="token operator">-></span>data<span class="token operator">=</span><span class="token function">fn1</span><span class="token punctuation">(</span>node<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">=</span><span class="token function">dequeue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>What’s wrong? Deadlock!</strong></p>
<h3 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a><strong>Atomic</strong></h3><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for shared(x, y, index, n)</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token macro property">#<span class="token directive keyword">pragma</span> omp atomic</span>
        x<span class="token punctuation">[</span>index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">work1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      y<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">work2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Special case of a critical section </li>
<li>Applies only to <strong>simple update of memory location</strong></li>
</ul>
<h3 id="reduction"><a href="#reduction" class="headerlink" title="reduction"></a><strong>reduction</strong></h3><p><strong>Solution 2</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">float</span> <span class="token function">dot_prod</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for reduction(+:sum)</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sum <span class="token operator">+</span><span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>Each thread performs <strong>its own reduction</strong> (sum, in this case);</p>
</li>
<li><p>Results from all threads are automatically reduced (summed) <strong>at the end of the loop</strong></p>
</li>
</ul>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a><strong>线程</strong></h2><h3 id="Any-program-paralleled"><a href="#Any-program-paralleled" class="headerlink" title="Any program paralleled?"></a>Any program paralleled?</h3><p>Fibonacci Sequence 0, 1, 1, 2, 3, 5, 8, 13…… </p>
<pre class="line-numbers language-c"><code class="language-c">a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i<span class="token number">-2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>程序运行结果？</strong></p>
<pre class="line-numbers language-c"><code class="language-c">doube a<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a[%d]= %f\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>为什么？</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206184632571.png" alt=""></p>
<h3 id="线程-1"><a href="#线程-1" class="headerlink" title="线程"></a><strong>线程</strong></h3><ul>
<li><strong>Assigning Iterations</strong><ul>
<li><strong>Which Schedule to Use</strong></li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206184700856.png" alt=""></p>
<ul>
<li>Assigning Iterations<ul>
<li><strong>schedule(static [,chunk])</strong><ul>
<li>Blocks of iterations of size “chunk” to threads</li>
<li>Round robin distribution</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for schedule (static, 8)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>i<span class="token operator">*</span>i<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"static_a[%d]= %d, num=%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>Iterations are divided into chunks of 8</p>
</li>
<li><p>If start = 0, then first chunk is </p>
<ul>
<li>thread0{0, 1,2,3,4,5,6,7}</li>
<li>thread1{8, 9,2,10,11,12,13,14,15}</li>
<li>thread2{16,16,18,19}</li>
</ul>
</li>
<li><p><strong>schedule(dynamic[,chunk])</strong></p>
<ul>
<li><p>Threads grab “chunk” iterations</p>
</li>
<li><p>When done with iterations, thread requests next set</p>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for schedule (dynamic, 8)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>i<span class="token operator">*</span>i<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"static_a[%d]= %d, num=%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>Iterations are divided into chunks of 8</p>
</li>
<li><p>If start = 0, then first chunk is </p>
<ul>
<li>thread0{0, 1,2,3,4,5,6,7}</li>
<li>thread2{8, 9,2,10,11,12,13,14,15}</li>
<li>thread3{16,16,18,19}</li>
</ul>
</li>
<li><p><strong>schedule(guided[,chunk])</strong></p>
<ul>
<li>Dynamic schedule starting with large block </li>
<li>Size of the blocks shrink; no smaller than “chunk”</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for schedule (guided)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>i<span class="token operator">*</span>i<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"static_a[%d]= %d, num=%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token function">omp_get_thread_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>thread0{0, 1,2,3,4}</li>
<li>thread1{9, 10,11}</li>
<li>thread2{5,6,7,8} {14,15,16,17,18,19}</li>
<li>thread3{12,13}</li>
</ul>
<h4 id="Section"><a href="#Section" class="headerlink" title="Section"></a><strong>Section</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185039828.png" alt=""></p>
<h4 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a><strong>Barrier</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel private(myid,istart,iend)</span>
<span class="token function">myrange</span><span class="token punctuation">(</span>myid<span class="token punctuation">,</span>istart<span class="token punctuation">,</span>iend<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>istart<span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>iend<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> – b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp barrier</span>
myval<span class="token punctuation">[</span>myid<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>istart<span class="token punctuation">]</span> <span class="token operator">+</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p><strong>Barrier synchronizes threads</strong></p>
</li>
<li><p>Here barrier assures that a[istart] or a[0] is available before computing myval</p>
</li>
</ul>
<h4 id="Nowait"><a href="#Nowait" class="headerlink" title="Nowait"></a><strong>Nowait</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185140178.png" alt=""></p>
<h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a><strong>Master</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel private(myid, istart, iend)</span>
 <span class="token function">myrange</span><span class="token punctuation">(</span>myid<span class="token punctuation">,</span> istart<span class="token punctuation">,</span> iend<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>istart<span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>iend<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> – b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp barrier</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp master</span>
 <span class="token function">fwrite</span><span class="token punctuation">(</span>fid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iend<span class="token operator">-</span>istart<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp end master</span>
 <span class="token function">do_work</span><span class="token punctuation">(</span>istart<span class="token punctuation">,</span> iend<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp end parallel </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>If you want part of code to be executed only on master thread, use master directive</p>
</li>
<li><p>“non-master” threads will skip over master region and continue</p>
</li>
</ul>
<h4 id="Single"><a href="#Single" class="headerlink" title="Single"></a><strong>Single</strong></h4><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel</span>
<span class="token punctuation">{</span>
   <span class="token function">DoManyThings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> omp single</span>
   <span class="token punctuation">{</span>
     <span class="token function">ExchangeBoundaries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// threads wait here for single</span>
   <span class="token function">DoManyMoreThings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Denotes block of code to be executed by only one thread</li>
<li>First thread to arrive is chosen</li>
<li>Implicit barrier at end</li>
</ul>
<p>Unequal work loads lead to idle threads and wasted time.</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185320317.png" alt=""></p>
<h4 id="Load-Balancing"><a href="#Load-Balancing" class="headerlink" title="Load Balancing"></a><strong>Load Balancing</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185351637.png" alt=""></p>
<h4 id="Lost-time-waiting-for-locks"><a href="#Lost-time-waiting-for-locks" class="headerlink" title="Lost time waiting for locks"></a>Lost time waiting for locks</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185417635.png" alt=""></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h3><h4 id="Numerical-Integration"><a href="#Numerical-Integration" class="headerlink" title="Numerical Integration"></a><strong>Numerical Integration</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185455140.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206185513696.png" alt=""></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">long</span> num_steps<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span> 
<span class="token keyword">double</span> step<span class="token punctuation">,</span> pi<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span>    
   <span class="token keyword">double</span> x<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

   step <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> num_steps<span class="token punctuation">;</span>
 <span class="token macro property">#<span class="token directive keyword">pragma</span> omp parallel for private(x) reduction(+:sum)</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> num_steps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      x <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">*</span>step<span class="token punctuation">;</span>
      sum <span class="token operator">=</span> sum <span class="token operator">+</span> <span class="token number">4.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">+</span> x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   pi <span class="token operator">=</span> step <span class="token operator">*</span> sum<span class="token punctuation">;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span>“Pi <span class="token operator">=</span> <span class="token operator">%</span>f\n”<span class="token punctuation">,</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a><strong>小结</strong></h2><p>请下载并安装CUDA</p>
<h1 id="Heterogeneous-Multi-core"><a href="#Heterogeneous-Multi-core" class="headerlink" title="Heterogeneous Multi-core"></a><strong>Heterogeneous Multi-core</strong></h1><p><strong>reference</strong></p>
<p><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html" target="_blank" rel="noopener">https://</a><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html" target="_blank" rel="noopener">docs.nvidia.com/cuda/cuda-c-programming-guide/index.html</a></p>
<p><a href="http://blog.csdn.net/kkk584520/article/details/9413973" target="_blank" rel="noopener">http</a><a href="http://blog.csdn.net/kkk584520/article/details/9413973" target="_blank" rel="noopener">://blog.csdn.net/kkk584520/article/details/9413973</a></p>
<h2 id="AMP"><a href="#AMP" class="headerlink" title="AMP"></a><strong>AMP</strong></h2><h3 id="Kirin9000"><a href="#Kirin9000" class="headerlink" title="Kirin9000"></a><strong>Kirin9000</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206190934459.png" alt=""></p>
<h3 id="A15-bionic"><a href="#A15-bionic" class="headerlink" title="A15 bionic"></a><strong>A15 bionic</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206191000726.png" alt=""></p>
<h3 id="OMAP3530-Ti"><a href="#OMAP3530-Ti" class="headerlink" title="OMAP3530 (Ti)"></a><strong>OMAP3530 (Ti)</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206191035714.png" alt=""></p>
<h3 id="AMP-存储架构"><a href="#AMP-存储架构" class="headerlink" title="AMP 存储架构"></a><strong>AMP</strong> <strong>存储架构</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206191110556.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206192640767.png" alt=""></p>
<h2 id="AMP编程"><a href="#AMP编程" class="headerlink" title="AMP编程"></a>AMP编程</h2><p>Multi-thread for AMP？</p>
<ul>
<li><p>The method of Programming for SMP？</p>
<p>Multi- thread (parallelizing).</p>
</li>
<li><p>Is “Multi-thread”method available for AMP programming？ Why？</p>
<p>No！ </p>
<p>Different architecture processors with different Instructions .</p>
</li>
<li><p>Programming for different processors？</p>
</li>
</ul>
<p>​    Independent</p>
<p>​    Integrated</p>
<ul>
<li>How to download binary code to different processors?</li>
</ul>
<p>​    Master and Coprocessor independently by tools </p>
<p>​    From Master to coprocessor</p>
<ul>
<li>How to start up the different processors?</li>
</ul>
<p>​    Master – Power(reset)</p>
<p>​    Coprocessor – Set by master</p>
<h3 id="Independent-Programming"><a href="#Independent-Programming" class="headerlink" title="Independent Programming"></a><strong>Independent Programming</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206193249543.png" alt=""></p>
<h3 id="Integrated-Programming"><a href="#Integrated-Programming" class="headerlink" title="Integrated Programming"></a><strong>Integrated Programming</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206193341198.png" alt=""></p>
<h3 id="Programming-OMAP3530"><a href="#Programming-OMAP3530" class="headerlink" title="Programming OMAP3530"></a><strong>Programming OMAP3530</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206193359592.png" alt=""></p>
<ul>
<li>xDM算法接口；IPC：Inter-Process Communication</li>
</ul>
<h3 id="HSA"><a href="#HSA" class="headerlink" title="HSA"></a><strong>HSA</strong></h3><p>HSA（Heterogeneous System Architecture）</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206194558828.png" alt=""></p>
<ul>
<li>APU：Accelerated Processing Unit ; NUMA: Non Uniform Memory Access Architecture; UMA Uniform Memory Architecture</li>
</ul>
<p><strong>Programming</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206194703138.png" alt=""></p>
<h2 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a><strong>GPU</strong></h2><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h3><ul>
<li>Manuals </li>
<li>Programming Guide </li>
<li>Best Practice Guide </li>
<li>Books </li>
<li>CUDA By Examples, Tsinghua University Press </li>
<li>Training videos </li>
<li>GTC talks online: optimization, advanced optimization + hundreds of other GPU computing talks <a href="http://www.gputechconf.com/gtcnew/on-demand-gtc.php" target="_blank" rel="noopener">http://www.gputechconf.com/gtcnew/on-demand-gtc.php</a></li>
<li>NVIDIA GPU Computing webinars <a href="http://developer.nvidia.com/gpu-computing-webinars" target="_blank" rel="noopener">http://developer.nvidia.com/gpu-computing-webinars</a></li>
</ul>
<p><strong>GPU</strong></p>
<ul>
<li>GPUs are massively multithreaded many core chips</li>
<li>Hundreds of scalar processors</li>
<li>Tens of thousands of concurrent threads</li>
<li>n TFLOP peak performance</li>
<li>Fine-grained data-parallel computation</li>
<li>Suppliers</li>
<li>Intel: Iris™ Pro Graphics[, i740</li>
<li>NVIDIA: Geforce, Telsa, Tegra</li>
<li>AMD(ATI)：RX, FirePro</li>
<li>Matrox</li>
<li>3dfx</li>
<li>SiS</li>
<li>VIA</li>
</ul>
<h3 id="GPU-Applications"><a href="#GPU-Applications" class="headerlink" title="GPU Applications"></a><strong>GPU Applications</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195811873.png" alt=""></p>
<h3 id="CPU-vs-GPU"><a href="#CPU-vs-GPU" class="headerlink" title="CPU vs GPU"></a><strong>CPU vs GPU</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195825543.png" alt=""></p>
<h3 id="A-GPU-Device-G80"><a href="#A-GPU-Device-G80" class="headerlink" title="A GPU Device(G80)"></a><strong>A GPU Device(G80)</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195843264.png" alt=""></p>
<ul>
<li>Vtx =Vertex , 线的顶点；Geom=Geometry</li>
</ul>
<h3 id="Texture-Processor-Cluster"><a href="#Texture-Processor-Cluster" class="headerlink" title="Texture Processor Cluster"></a><strong>Texture Processor Cluster</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195912989.png" alt=""></p>
<h3 id="GPU-in-System"><a href="#GPU-in-System" class="headerlink" title="GPU in System"></a><strong>GPU in System</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195925836.png" alt=""></p>
<h3 id="GPU-in-System-1"><a href="#GPU-in-System-1" class="headerlink" title="GPU in System"></a><strong>GPU in System</strong></h3><p>Connected to CPU chipset by PCIe</p>
<p>PCIe x16 Gen 2: 8 GB/s in one direction, 16 GB/s bi-directionally </p>
<p>  <a href="http://arstechnica.com/old/content/2004/07/pcie.ars" target="_blank" rel="noopener">http://arstechnica.com/old/content/2004/07/pcie.ars</a></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206195955185.png" alt=""></p>
<h2 id="CUDA"><a href="#CUDA" class="headerlink" title="CUDA"></a><strong>CUDA</strong></h2><h3 id="What-is-CUDA"><a href="#What-is-CUDA" class="headerlink" title="What is CUDA"></a><strong>What is CUDA</strong></h3><ul>
<li>CUDA is the acronym for Compute Unified Device Architecture.<ul>
<li>A parallel computing architecture developed by NVIDIA.</li>
<li>The computing engine in GPU.</li>
<li>CUDA can be accessible to software developers through industry standard programming languages. </li>
</ul>
</li>
<li>CUDA gives developers access to the instruction set and memory of the parallel computation elements in GPUs. </li>
</ul>
<h3 id="Processing-Flow"><a href="#Processing-Flow" class="headerlink" title="Processing Flow"></a><strong>Processing Flow</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200219166.png" alt=""></p>
<h3 id="CUDA-Environment"><a href="#CUDA-Environment" class="headerlink" title="CUDA Environment"></a><strong>CUDA Environment</strong></h3><p>Installing CUDA.</p>
<ul>
<li>Windows – VSXXXX</li>
<li>Linux – gcc</li>
</ul>
<p><a href="https://developer.nvidia.com/cuda-downloads" target="_blank" rel="noopener">https://developer.nvidia.com/cuda-downloads</a></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200325131.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200335656.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200415114.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200427229.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200436763.png" alt=""></p>
<p><strong>新建例程，运行例程，结果？</strong></p>
<p><strong>源程序的扩展名？</strong></p>
<p><strong>哪一段代码是在GPU上运行的？</strong></p>
<p><strong>如何调试GPU上运行的程序？</strong></p>
<h3 id="Cuda-test"><a href="#Cuda-test" class="headerlink" title="Cuda_test"></a><strong>Cuda_test</strong></h3><p><strong>Testing-CPU</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// hello_world.c: </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span>

<span class="token keyword">void</span> <span class="token function">hello_world_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
    <span class="token function">printf</span><span class="token punctuation">(</span>“Hello World\n”<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">hello_world_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Testing-GPU</strong></p>
<pre><code>//hello_world.cu: 
#include &lt;stdio.h&gt; 

__global__ void hello_world_kernel()
{ 
    printf(“Hello World\n”); 
}

int main() 
{ 
     hello_world_kernel&lt;&lt;&lt;1,1&gt;&gt;&gt;(); 
}</code></pre><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200624898.png" alt=""></p>
<p>What’s Wrong？ </p>
<p>Why？</p>
<h2 id="CUDA-编程"><a href="#CUDA-编程" class="headerlink" title="CUDA 编程"></a><strong>CUDA</strong> <strong>编程</strong></h2><h3 id="CUDA-Kernel-program"><a href="#CUDA-Kernel-program" class="headerlink" title="CUDA Kernel program"></a><strong>CUDA Kernel program</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200713282.png" alt=""></p>
<h3 id="CUDA-Programming-Mode"><a href="#CUDA-Programming-Mode" class="headerlink" title="CUDA Programming Mode"></a><strong>CUDA Programming Mode</strong></h3><ul>
<li><p>CUDA C extends C by allowing the programmer to define C functions, called kernels.</p>
</li>
<li><p>When called, kernels are executed N times in parallel by N different <em>CUDA</em> threads.</p>
</li>
<li><p>A kernel is defined using the __global__ . </p>
</li>
<li><p>The number of CUDA threads that execute the kernels is specified using &lt;&lt;&lt;…&gt;&gt;&gt; （Threads）</p>
<ul>
<li>cuda_kernel&lt;&lt;&lt;nBlk, nTid&gt;&gt;&gt;(…)</li>
</ul>
</li>
<li><p>Each thread that executes the kernel is given a unique thread ID. </p>
</li>
<li><p>A thread block is a batch of threads</p>
</li>
<li><p>All threads run the same code</p>
</li>
<li><p>Each thread has an ID that it uses to compute memory addresses and make control decision</p>
</li>
<li><p>Threads can cooperate with each other by</p>
</li>
<li><p>sharing data and synchronizing their execution</p>
</li>
<li><p>Threads from different blocks cannot cooperate</p>
</li>
<li><p>There is a limit to the number of threads per block</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200842658.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200854133.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200904854.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200923385.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206200937740.png" alt=""></p>
<h4 id="Thread-ID"><a href="#Thread-ID" class="headerlink" title="Thread ID"></a><strong>Thread ID</strong></h4><pre><code>BlockID= blockIdx.y*gridDim.x+blockIdx.x

ThreadID=BlockID*blockDim.x*blockDim.y*blockDim.z
    +threadIdx.z*blockdIm.x*blockDim.y*
    +threadIdx.y*blockDim.x
    +threadIdx.x</code></pre><p>How about 2D or 1D blocks?</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201022204.png" alt=""></p>
<pre><code>dim3 grid(3,2) ；dim3 block(12,1,1)；
gridDim.x=3; gridDim.y=2; 
blockDim.x=12; blockDim.y=1; blockDim.z=1;
blockIdx.x=1; blockIdx.y=1;
threadIdx.x=4, threadIdx.y=0; threadIdx.z=0;
threadID=(1*3+1)*12+4=52</code></pre><h4 id="Data-Partition-example"><a href="#Data-Partition-example" class="headerlink" title="Data Partition-example"></a><strong>Data Partition-example</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201052741.png" alt=""></p>
<h4 id="Example-1D-Block"><a href="#Example-1D-Block" class="headerlink" title="Example (1D-Block)"></a>Example (1D-Block)</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Kernel definition</span>
__global__ <span class="token keyword">void</span> <span class="token function">VecAdd</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> B<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> C<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    C<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> B<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// Kernel invocation with N threads</span>
    VecAdd<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> N<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Example-2D-Block"><a href="#Example-2D-Block" class="headerlink" title="Example (2D-Block)"></a>Example (2D-Block)</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Kernel definition</span>
__global__ <span class="token keyword">void</span> <span class="token function">MatAdd</span><span class="token punctuation">(</span><span class="token keyword">float</span> A<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span> B<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token keyword">float</span> C<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    C<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> B<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// Kernel invocation with one block of N * N * 1 threads</span>
    <span class="token keyword">int</span> numBlocks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    dim3 <span class="token function">threadsPerBlock</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MatAdd<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>numBlocks<span class="token punctuation">,</span> threadsPerBlock<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Example (Multi-blocks)</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Kernel definition</span>
__global__ <span class="token keyword">void</span> <span class="token function">MatAdd</span><span class="token punctuation">(</span><span class="token keyword">float</span> A<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span> B<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token keyword">float</span> C<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>y <span class="token operator">*</span> blockDim<span class="token punctuation">.</span>y <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> N <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">)</span>
        C<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> B<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// Kernel invocation</span>
    dim3 <span class="token function">threadsPerBlock</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dim3 <span class="token function">numBlocks</span><span class="token punctuation">(</span>N <span class="token operator">/</span> threadsPerBlock<span class="token punctuation">.</span>x<span class="token punctuation">,</span> N <span class="token operator">/</span> threadsPerBlock<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MatAdd<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>numBlocks<span class="token punctuation">,</span> threadsPerBlock<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Programming"><a href="#Programming" class="headerlink" title="Programming"></a><strong>Programming</strong></h3><h4 id="Heterogeneous-Programming"><a href="#Heterogeneous-Programming" class="headerlink" title="Heterogeneous Programming"></a>Heterogeneous Programming</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201303621.png" alt=""></p>
<h4 id="GPU-Input-and-Output"><a href="#GPU-Input-and-Output" class="headerlink" title="GPU Input and Output"></a><strong>GPU Input and Output</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201328710.png" alt=""></p>
<h4 id="GPU-Memory"><a href="#GPU-Memory" class="headerlink" title="GPU Memory"></a><strong>GPU Memory</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201359301.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201409406.png" alt=""></p>
<h4 id="Global-Memory"><a href="#Global-Memory" class="headerlink" title="Global Memory"></a>Global Memory</h4><ul>
<li>Accessible by all threads as well as host (CPU)</li>
<li>Data lifetime = from allocation to deallocation</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201503998.png" alt=""></p>
<h4 id="Shared-Memory"><a href="#Shared-Memory" class="headerlink" title="Shared Memory"></a>Shared Memory</h4><ul>
<li><p>Accessible by all threads in the block</p>
</li>
<li><p>Data lifetime = the longest thread lifetime</p>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201511263.png" alt=""></p>
<h4 id="Register-amp-Local-memory"><a href="#Register-amp-Local-memory" class="headerlink" title="Register &amp; Local memory"></a>Register &amp; Local memory</h4><ul>
<li>Automatic variables (scalar/array) inside kernels</li>
<li>Spills to local memory</li>
<li>Data lifetime = thread lifetime</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201548840.png" alt=""></p>
<h4 id="Memory-Allocation"><a href="#Memory-Allocation" class="headerlink" title="Memory Allocation"></a><strong>Memory Allocation</strong></h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201620757.png" alt=""></p>
<h4 id="Memory-Copies"><a href="#Memory-Copies" class="headerlink" title="Memory Copies"></a>Memory Copies</h4><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201736906.png" alt=""></p>
<h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a><strong>示例</strong></h2><h3 id="Arrays-Plus"><a href="#Arrays-Plus" class="headerlink" title="Arrays Plus"></a><strong>Arrays Plus</strong></h3><pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"cuda_runtime.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

cudaError_t <span class="token function">addWithCuda</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> 
            <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

__global__ <span class="token keyword">void</span> <span class="token function">addKernel</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> arraySize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> a<span class="token punctuation">[</span>arraySize<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> b<span class="token punctuation">[</span>arraySize<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">[</span>arraySize<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Add vectors in parallel.</span>
    cudaError_t cudaStatus <span class="token operator">=</span> <span class="token function">addWithCuda</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> arraySize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span>"<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span> <span class="token operator">+</span> <span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">}</span> <span class="token operator">=</span> 
             <span class="token punctuation">{</span><span class="token operator">%</span>d<span class="token punctuation">,</span><span class="token operator">%</span>d<span class="token punctuation">,</span><span class="token operator">%</span>d<span class="token punctuation">,</span><span class="token operator">%</span>d<span class="token punctuation">,</span><span class="token operator">%</span>d<span class="token punctuation">}</span>\n"<span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   cudaStatus <span class="token operator">=</span> <span class="token function">cudaDeviceReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


cudaError_t <span class="token function">addWithCuda</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> 
                <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>dev_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">int</span> <span class="token operator">*</span>dev_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">int</span> <span class="token operator">*</span>dev_c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cudaError_t cudaStatus<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Allocate GPU buffers for three vectors (two input, one output)    .</span>
    cudaStatus <span class="token operator">=</span> <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dev_c<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span> 

    cudaStatus <span class="token operator">=</span> <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dev_a<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>

    cudaStatus <span class="token operator">=</span> <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dev_b<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Copy input vectors from host memory to GPU buffers.</span>
    cudaStatus <span class="token operator">=</span> <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>dev_a<span class="token punctuation">,</span> a<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>

     cudaStatus <span class="token operator">=</span> <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>dev_b<span class="token punctuation">,</span> b<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                cudaMemcpyHostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Launch a kernel on the GPU with one thread for each element.</span>
    addKernel<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>dev_c<span class="token punctuation">,</span> dev_a<span class="token punctuation">,</span> dev_b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Check for any errors launching the kernel</span>
    cudaStatus <span class="token operator">=</span> <span class="token function">cudaGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// cudaDeviceSynchronize waits for the kernel to finish, and returns</span>
    <span class="token comment" spellcheck="true">// any errors encountered during the launch.</span>
    cudaStatus <span class="token operator">=</span> <span class="token function">cudaDeviceSynchronize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Copy output vector from GPU buffer to host memory.</span>
    cudaStatus <span class="token operator">=</span> <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> dev_c<span class="token punctuation">,</span> size <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                cudaMemcpyDeviceToHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cudaStatus <span class="token operator">!=</span> cudaSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">goto</span> Error<span class="token punctuation">;</span><span class="token punctuation">}</span>
Error<span class="token punctuation">:</span>
    <span class="token function">cudaFree</span><span class="token punctuation">(</span>dev_c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">cudaFree</span><span class="token punctuation">(</span>dev_a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">cudaFree</span><span class="token punctuation">(</span>dev_b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> cudaStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Run the code !</strong></p>
<h3 id="一维信号均值滤波"><a href="#一维信号均值滤波" class="headerlink" title="一维信号均值滤波"></a><strong>一维信号均值滤波</strong></h3><p>Case</p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206201939285.png" alt=""></p>
<ul>
<li>Using global memory<ul>
<li>One element per thread</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">stencil</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> in<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> out<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
    <span class="token keyword">int</span> globIdx <span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">*</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">+</span>     
            threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>

    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token operator">-</span>RADIUS<span class="token punctuation">;</span> offset <span class="token operator">&lt;=</span> RADIUS<span class="token punctuation">;</span>     
                offset<span class="token operator">++</span><span class="token punctuation">)</span>
        value <span class="token operator">+</span><span class="token operator">=</span> in<span class="token punctuation">[</span>globIdx <span class="token operator">+</span> offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
    out<span class="token punctuation">[</span>globIdx<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>A lot of redundant read in neighboring threads.</p>
<ul>
<li><p>Using shared memory</p>
<ul>
<li><p>One element per thread</p>
</li>
<li><p>Read (BLOCK_SIZE + 2 * RADIUS) elements from global memory to shared memory</p>
</li>
<li><p>Compute BLOCK_SIZE output elements in shared memory</p>
</li>
<li><p>Write BLOCK_SIZE output elements to global memory</p>
</li>
</ul>
</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206202107662.png" alt=""></p>
<p><strong>Shared Memory</strong></p>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206202131095.png" alt=""></p>
<pre class="line-numbers language-c"><code class="language-c">__global__ <span class="token keyword">void</span> <span class="token function">stencil</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> in<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> out<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
    __shared__ <span class="token keyword">int</span> shared<span class="token punctuation">[</span>BLOCK_SIZE <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> RADIUS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> globIdx<span class="token operator">=</span> blockIdx<span class="token punctuation">.</span>x<span class="token operator">*</span> blockDim<span class="token punctuation">.</span>x<span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> locIdx<span class="token operator">=</span> threadIdx<span class="token punctuation">.</span>x<span class="token operator">+</span> RADIUS<span class="token punctuation">;</span>

    shared<span class="token punctuation">[</span>locIdx<span class="token punctuation">]</span> <span class="token operator">=</span> in<span class="token punctuation">[</span>globIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadIdx<span class="token punctuation">.</span>x<span class="token operator">&lt;</span> RADIUS<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        shared<span class="token punctuation">[</span>locIdx–RADIUS<span class="token punctuation">]</span> <span class="token operator">=</span> in<span class="token punctuation">[</span>globIdx–RADIUS<span class="token punctuation">]</span><span class="token punctuation">;</span>  
        shared<span class="token punctuation">[</span>locIdx<span class="token operator">+</span> blockDim<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> in<span class="token punctuation">[</span>globIdx<span class="token operator">+</span> 
                BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__syncthreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token operator">-</span>RADIUS<span class="token punctuation">;</span> offset <span class="token operator">&lt;=</span> RADIUS<span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">)</span>
        value <span class="token operator">+</span><span class="token operator">=</span> shared<span class="token punctuation">[</span>locIdx<span class="token operator">+</span> offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
    out<span class="token punctuation">[</span>globIdx<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Matrix-Multiplication"><a href="#Matrix-Multiplication" class="headerlink" title="Matrix Multiplication"></a><strong>Matrix Multiplication</strong></h3><p><img src="/images/loading.gif" data-original="../images/basic/image-20211206202158259.png" alt=""></p>
<pre class="line-numbers language-c"><code class="language-c">__int <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">//allocate and initialize the matrices M, N, P</span>
      <span class="token comment" spellcheck="true">//IO to read the input matrices M, N</span>
   ……
      <span class="token comment" spellcheck="true">//M * N on the device</span>
      <span class="token function">MatrixMultiplication</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">,</span> P<span class="token punctuation">,</span> Width<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
      <span class="token comment" spellcheck="true">// IO to write the Output Matrices P</span>
      <span class="token comment" spellcheck="true">// Free M, N, P </span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">MatrixMulOnHost</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> M<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> N<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> Width<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> 
       <span class="token punctuation">{</span>
    <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
               <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> Width<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
       <span class="token keyword">double</span> a <span class="token operator">=</span> M<span class="token punctuation">[</span>i <span class="token operator">*</span> width <span class="token operator">+</span> k<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token keyword">double</span> b <span class="token operator">=</span> N<span class="token punctuation">[</span>k <span class="token operator">*</span> width <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>
       sum <span class="token operator">+</span><span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
              P<span class="token punctuation">[</span>i <span class="token operator">*</span> Width <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> sum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206202239792.png" alt=""></p>
<p><strong>Allocating Memory on GPU</strong></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">MatrixMultiplication</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> M<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> N<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> P<span class="token punctuation">,</span> <span class="token keyword">int</span> Width<span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">int</span> size<span class="token operator">=</span>Width<span class="token operator">*</span>Width<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">float</span> <span class="token operator">*</span> Md<span class="token punctuation">,</span> Nd<span class="token punctuation">,</span> Pd<span class="token punctuation">;</span>
      dim3 <span class="token function">grid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> dim3 <span class="token function">block</span><span class="token punctuation">(</span>Width<span class="token punctuation">,</span>Width<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Allocate device memory</span>
      <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&amp;</span>Md<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&amp;</span>Nd<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> 
       <span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&amp;</span>Pd<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//transfer M,N from host to device</span>
       <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>Md<span class="token punctuation">,</span> M<span class="token punctuation">,</span>size<span class="token punctuation">,</span> HostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>Nd<span class="token punctuation">,</span> N<span class="token punctuation">,</span>size<span class="token punctuation">,</span> HostToDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//kernel innovation code</span>
     MatrixMulOnKernel<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>grid<span class="token punctuation">,</span> block <span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>Md<span class="token punctuation">,</span> Nd<span class="token punctuation">,</span> Pd<span class="token punctuation">,</span> Width<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//transfer p from device to host</span>
      <span class="token function">cudaMemcpy</span><span class="token punctuation">(</span>P<span class="token punctuation">,</span> Pd<span class="token punctuation">,</span>size<span class="token punctuation">,</span> DeviceToHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">cudaFree</span><span class="token punctuation">(</span>Md<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">cudaFree</span><span class="token punctuation">(</span>Nd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">cudaFree</span><span class="token punctuation">(</span>Pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Kernel</strong> <strong>on GPU</strong> </p>
<pre class="line-numbers language-c"><code class="language-c">__global__void <span class="token function">MatrixMulOnKernel</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> Md<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> Nd<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> Pd<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//2D threadID</span>
    <span class="token keyword">int</span> tx<span class="token operator">=</span>threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ty<span class="token operator">=</span>threadIdx<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">// pvalue stores the pdelement</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>width<span class="token punctuation">;</span><span class="token operator">++</span>k<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>    
         <span class="token keyword">float</span> Mdelement<span class="token operator">=</span>Md<span class="token punctuation">[</span>ty<span class="token operator">*</span>width<span class="token operator">+</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">float</span> Ndelement<span class="token operator">=</span>Nd<span class="token punctuation">[</span>k<span class="token operator">*</span>width<span class="token operator">+</span>tx<span class="token punctuation">]</span><span class="token punctuation">;</span>
         pvalue<span class="token operator">+</span><span class="token operator">=</span>Mdelement<span class="token operator">*</span>Ndelement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment" spellcheck="true">//write pvalue to device memory</span>
    Pd<span class="token punctuation">[</span>ty<span class="token operator">*</span>width<span class="token operator">+</span>tx<span class="token punctuation">]</span><span class="token operator">=</span>pvalue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/basic/image-20211206202331017.png" alt=""></p>
<p>写个程序计算5x5矩阵相乘，并运行！</p>
<p>©北京大学 <a href="https://github.com/JackHCC" target="_blank" rel="noopener">JackHCC</a> </p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/Embedded-Microprocessor-System.html">https://jackhcc.github.io/posts/Embedded-Microprocessor-System.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Microprocessor/">
                                    <span class="chip bg-color">Microprocessor</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-09-26T18-38-19',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/blog-python20.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="Python Key Knowledge Summary">
                        
                        <span class="card-title">Python Key Knowledge Summary</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Python重点知识总结
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-09-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Python/" class="post-category">
                                    Python
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/Lesson-CS-Multimodal-Machine-Learning.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/6.jpg" class="responsive-img" alt="CS-Multimodal Machine Learning">
                        
                        <span class="card-title">CS-Multimodal Machine Learning</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Multimodal Machine Learning Notes
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Multimodal-Machine-Learning/">
                        <span class="chip bg-color">Multimodal Machine Learning</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

