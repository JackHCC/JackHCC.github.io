<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="F2PY-Fortran与Python接口, JackHCC">
    <meta name="description" content="f2py接口详解">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>F2PY-Fortran与Python接口 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">F2PY-Fortran与Python接口</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/f2py/">
                                <span class="chip bg-color">f2py</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Python/" class="post-category">
                                Python
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-01
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-11-06
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    12.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    59 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="打包的三种方法-入门"><a href="#打包的三种方法-入门" class="headerlink" title="打包的三种方法 - 入门"></a>打包的三种方法 - 入门</h1><p>使用F2PY将Fortran或C函数包装到Python包含以下步骤：</p>
<ul>
<li>创建所谓的签名文件，其中包含对Fortran或C函数的包装器的描述，也称为函数的签名。对于Fortran例程，F2PY可以通过扫描Fortran源代码并捕获创建包装函数所需的所有相关信息来创建初始签名文件。</li>
<li>可选地，可以编辑F2PY创建的签名文件以优化包装器功能，使它们“更智能”和更“Pythonic”。</li>
<li>F2PY读取签名文件并编写包含Fortran / C / Python绑定的Python C / API模块。</li>
<li>F2PY编译所有源并构建包含包装器的扩展模块。在构建扩展模块时，F2PY使用 <code>numpy_distutils</code>它支持许多Fortran 77/90/95编译器，包括Gnu，Intel，Sun Fortre，SGI MIPSpro，Absoft，NAG，Compaq等编译器。</li>
</ul>
<p>根据具体情况，这些步骤可以通过一个命令或一步一步执行，一些步骤可以省略或与其他步骤组合。</p>
<p>下面我将描述使用F2PY的三种典型方法。以下示例 <code>Fortran 77代码</code> 将说明：</p>
<pre class="line-numbers language-fortran"><code class="language-fortran">C <span class="token keyword">FILE</span><span class="token punctuation">:</span> FIB1.F
      <span class="token keyword">SUBROUTINE</span> FIB<span class="token punctuation">(</span>A<span class="token punctuation">,</span>N<span class="token punctuation">)</span>
C
C     CALCULATE FIRST N FIBONACCI NUMBERS
C
      <span class="token keyword">INTEGER</span> N
      <span class="token keyword">REAL</span><span class="token operator">*</span><span class="token number">8</span> A<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
      <span class="token keyword">DO</span> I<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>N
         <span class="token keyword">IF</span> <span class="token punctuation">(</span>I.EQ<span class="token number">.1</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0D0</span>
         <span class="token keyword">ELSEIF</span> <span class="token punctuation">(</span>I.EQ<span class="token number">.2</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0D0</span>
         <span class="token keyword">ELSE</span> 
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> A<span class="token punctuation">(</span>I<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">+</span> A<span class="token punctuation">(</span>I<span class="token number">-2</span><span class="token punctuation">)</span>
         <span class="token keyword">ENDIF</span>
      <span class="token keyword">ENDDO</span>
      <span class="token keyword">END</span>
C <span class="token keyword">END FILE</span> FIB1.F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="快捷的方式"><a href="#快捷的方式" class="headerlink" title="快捷的方式"></a>快捷的方式</h2><p>将Fortran子例程包装<code>FIB</code>到Python 的最快方法是运行</p>
<pre class="line-numbers language-python"><code class="language-python">python <span class="token operator">-</span>m numpy<span class="token punctuation">.</span>f2py <span class="token operator">-</span>c fib1<span class="token punctuation">.</span>f <span class="token operator">-</span>m fib1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此命令构建（参见<code>-c</code>flag，不带参数执行以查看命令行选项的说明）扩展模块（请参阅标志）到当前目录。现在，在Python中，可以通过以下方式访问Fortran子例程：<code>python -m numpy.f2py</code>fib1.so<code>-m</code>FIB<code>fib1.fib</code></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> fib1
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">.</span>__doc__
fib <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  fib<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> input rank<span class="token number">-1</span> array<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">with</span> bounds <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
Optional arguments<span class="token punctuation">:</span>
  n <span class="token punctuation">:</span><span class="token operator">=</span> len<span class="token punctuation">(</span>a<span class="token punctuation">)</span> input int

<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">5</span><span class="token punctuation">.</span>   <span class="token number">8</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意</p>
<ul>
<li>请注意，F2PY发现第二个参数<code>n</code>是第一个数组参数的维度<code>a</code>。由于默认情况下所有参数都是仅输入参数，因此F2PY <code>n</code>可以使用默认值作为可选参数<code>len(a)</code>。</li>
<li>可以使用不同的值来选择<code>n</code>：</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a1 <span class="token operator">=</span> numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">(</span>a1<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a1
<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">2</span><span class="token punctuation">.</span>  <span class="token number">3</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是当它与输入数组不兼容时会引发异常<code>a</code>：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
fib<span class="token punctuation">:</span>n<span class="token operator">=</span><span class="token number">10</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> ?
fib<span class="token punctuation">.</span>error<span class="token punctuation">:</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">>=</span>n<span class="token punctuation">)</span> failed <span class="token keyword">for</span> 1st keyword n
<span class="token operator">>></span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这展示了F2PY中的一个有用功能，即F2PY实现相关参数之间的基本兼容性检查，以避免任何意外崩溃。</p>
<ul>
<li>当一个NumPy数组（即Fortran连续且具有与假定的Fortran类型相对应的dtype）用作输入数组参数时，其C指针将直接传递给Fortran。</li>
</ul>
<p>否则，F2PY会生成输入数组的连续副本（具有正确的dtype），并将副本的C指针传递给Fortran子例程。因此，对输入数组（副本）的任何可能更改都不会影响原始参数，如下所示：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> numpy<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>显然，这不是预期的行为。上述示例使用的事实<code>dtype=float</code>被认为是偶然的。</p>
<p>F2PY提供<code>intent(inplace)</code>了将修改输入数组属性的属性，以便Fortran例程所做的任何更改也将在输入参数中生效。例如，如果指定（见下文，如何），则上面的示例将为：<code>intent(inplace) a</code></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> numpy<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> fib1<span class="token punctuation">.</span>fib<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">5</span><span class="token punctuation">.</span>   <span class="token number">8</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，将Fortran子例程所做的更改返回到python的推荐方法是使用<code>intent(out)</code>属性。它更有效，更清洁。</p>
<ul>
<li><code>fib1.fib</code>Python中的用法与<code>FIB</code>在Fortran中使用非常相似 。但是，在Python中使用 <em>原位</em> 输出参数表明样式很差，因为Python中没有关于错误参数类型的安全机制。使用Fortran或C时，编译器自然会在编译期间发现任何类型不匹配，但在Python中，必须在运行时检查类型。因此，在Python中使用 <em>原位</em> 输出参数可能会导致难以发现错误，更不用说在实现所有必需的类型检查时代码将不太可读。</li>
</ul>
<p>虽然将Fortran例程包装到Python的演示方法非常简单，但它有几个缺点（参见上面的注释）。这些缺点是由于F2PY无法确定一个或另一个参数的实际意图，输入或输出参数，或两者，或其他东西。因此，F2PY保守地假定所有参数都是默认的输入参数。</p>
<p>但是，有一些方法（见下文）如何“教导”F2PY关于函数参数的真实意图（以及其他内容）; 然后F2PY能够为Fortran函数生成更多Pythonic（更明确，更易于使用，更不容易出错）的包装器。</p>
<h2 id="聪明的方式"><a href="#聪明的方式" class="headerlink" title="聪明的方式"></a>聪明的方式</h2><p>让我们逐个应用将Fortran函数包装到Python的步骤。</p>
<ul>
<li><p>首先，我们<code>fib1.f</code>通过运行创建一个签名文件</p>
<pre class="line-numbers language-python"><code class="language-python">python <span class="token operator">-</span>m numpy<span class="token punctuation">.</span>f2py fib1<span class="token punctuation">.</span>f <span class="token operator">-</span>m fib2 <span class="token operator">-</span>h fib1<span class="token punctuation">.</span>pyf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>签名文件保存到<code>fib1.pyf</code>（见<code>-h</code>标志），其内容如下所示。</p>
<pre class="line-numbers language-fortran"><code class="language-fortran"><span class="token comment" spellcheck="true">!    -*- f90 -*-</span>
python <span class="token keyword">module</span> fib2 <span class="token comment" spellcheck="true">! in </span>
    <span class="token keyword">interface</span>  <span class="token comment" spellcheck="true">! in :fib2</span>
        <span class="token keyword">subroutine</span> fib<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">! in :fib2:fib1.f</span>
            <span class="token keyword">real</span><span class="token operator">*</span><span class="token number">8</span> <span class="token keyword">dimension</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">::</span> a
            <span class="token keyword">integer</span> <span class="token keyword">optional</span><span class="token punctuation">,</span>check<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">>=</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">::</span> n<span class="token operator">=</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token keyword">end subroutine</span> fib
    <span class="token keyword">end interface</span> 
<span class="token keyword">end</span> python <span class="token keyword">module</span> fib2

<span class="token comment" spellcheck="true">! This file was auto-generated with f2py (version:2.28.198-1366).</span>
<span class="token comment" spellcheck="true">! See http://cens.ioc.ee/projects/f2py2e/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>接下来，我们将教导F2PY参数<code>n</code>是一个输入参数（use <code>intent(in)</code>属性），结果，即<code>a</code>调用Fortran函数后的内容<code>FIB</code>，应该返回给Python（use <code>intent(out)</code>属性）。此外，<code>a</code>应使用input参数给出的大小动态创建数组<code>n</code>（use <code>depend(n)</code>属性表示依赖关系）。</p>
<p>修改后的版本<code>fib1.pyf</code>（保存为 <code>fib2.pyf</code>）的内容如下：</p>
<pre class="line-numbers language-python"><code class="language-python">!    <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> f90 <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>
python module fib2 
    interface
        subroutine fib<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
            real<span class="token operator">*</span><span class="token number">8</span> dimension<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>intent<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a
            integer intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n
        end subroutine fib
    end interface 
end python module fib2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>最后，我们通过运行构建扩展模块</p>
<pre class="line-numbers language-python"><code class="language-python">python <span class="token operator">-</span>m numpy<span class="token punctuation">.</span>f2py <span class="token operator">-</span>c fib2<span class="token punctuation">.</span>pyf fib1<span class="token punctuation">.</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> fib2
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> fib2<span class="token punctuation">.</span>fib<span class="token punctuation">.</span>__doc__
fib <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  a <span class="token operator">=</span> fib<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  n <span class="token punctuation">:</span> input int
Return objects<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> rank<span class="token number">-1</span> array<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">with</span> bounds <span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> fib2<span class="token punctuation">.</span>fib<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">5</span><span class="token punctuation">.</span>   <span class="token number">8</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意</p>
<ul>
<li>显然，<code>fib2.fib</code>现在的签名<code>FIB</code>更接近Fortran子程序的意图：给定数字<code>n</code>，<code>fib2.fib</code>将第一个<code>n</code>Fibonacci数作为NumPy数组返回。此外，新的Python签名<code>fib2.fib</code> 排除了我们遇到的任何意外<code>fib1.fib</code>。</li>
<li>请注意，默认情况下使用single <code>intent(out)</code>也意味着 <code>intent(hide)</code>。具有<code>intent(hide)</code>指定属性的参数将不会列在包装函数的参数列表中。</li>
</ul>
<h2 id="快捷而聪明的方式"><a href="#快捷而聪明的方式" class="headerlink" title="快捷而聪明的方式"></a>快捷而聪明的方式</h2><p>如上所述，包装Fortran函数的“智能方法”适用于包装（例如第三方）Fortran代码，对其源代码的修改是不可取的，甚至也不可能。</p>
<p>但是，如果编辑Fortran代码是可以接受的，则在大多数情况下可以跳过生成中间签名文件。即，可以使用所谓的F2PY指令将F2PY特定属性直接插入到Fortran源代码中。F2PY指令定义了特殊注释行（<code>Cf2py</code>例如，从Fortran编译器开始），但是F2PY将它们解释为普通行。</p>
<p>下面显示了示例Fortran代码的修改版本，保存为<code>fib3.f</code>：</p>
<pre class="line-numbers language-fortran"><code class="language-fortran">C <span class="token keyword">FILE</span><span class="token punctuation">:</span> FIB3.F
      <span class="token keyword">SUBROUTINE</span> FIB<span class="token punctuation">(</span>A<span class="token punctuation">,</span>N<span class="token punctuation">)</span>
C
C     CALCULATE FIRST N FIBONACCI NUMBERS
C
      <span class="token keyword">INTEGER</span> N
      <span class="token keyword">REAL</span><span class="token operator">*</span><span class="token number">8</span> A<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
Cf2py <span class="token keyword">intent</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> n
Cf2py <span class="token keyword">intent</span><span class="token punctuation">(</span><span class="token keyword">out</span><span class="token punctuation">)</span> a
Cf2py depend<span class="token punctuation">(</span>n<span class="token punctuation">)</span> a
      <span class="token keyword">DO</span> I<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>N
         <span class="token keyword">IF</span> <span class="token punctuation">(</span>I.EQ<span class="token number">.1</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0D0</span>
         <span class="token keyword">ELSEIF</span> <span class="token punctuation">(</span>I.EQ<span class="token number">.2</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0D0</span>
         <span class="token keyword">ELSE</span> 
            A<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">=</span> A<span class="token punctuation">(</span>I<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">+</span> A<span class="token punctuation">(</span>I<span class="token number">-2</span><span class="token punctuation">)</span>
         <span class="token keyword">ENDIF</span>
      <span class="token keyword">ENDDO</span>
      <span class="token keyword">END</span>
C <span class="token keyword">END FILE</span> FIB3.F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在可以在一个命令中执行构建扩展模块：</p>
<pre class="line-numbers language-python"><code class="language-python">python <span class="token operator">-</span>m numpy<span class="token punctuation">.</span>f2py <span class="token operator">-</span>c <span class="token operator">-</span>m fib3 fib3<span class="token punctuation">.</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>请注意，生成的包装器与<code>FIB</code>前一种情况一样“智能”：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> fib3
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> fib3<span class="token punctuation">.</span>fib<span class="token punctuation">.</span>__doc__
fib <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  a <span class="token operator">=</span> fib<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  n <span class="token punctuation">:</span> input int
Return objects<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> rank<span class="token number">-1</span> array<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">with</span> bounds <span class="token punctuation">(</span>n<span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> fib3<span class="token punctuation">.</span>fib<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">1</span><span class="token punctuation">.</span>   <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">5</span><span class="token punctuation">.</span>   <span class="token number">8</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="签名文件"><a href="#签名文件" class="headerlink" title="签名文件"></a>签名文件</h1><p>签名文件（.pyf文件）的语法规范借鉴了Fortran 90/95语言规范。几乎所有的Fortran 90/95标准结构都以免费和固定格式被理解（回想一下Fortran 77是Fortran 90/95的子集）。F2PY 还引入了Fortran 90/95语言规范的一些扩展，有助于将Fortran设计为Python接口，使其更加“Pythonic”。</p>
<p>签名文件可能包含任意Fortran代码（因此Fortran代码可以被视为签名文件）。F2PY 默默地忽略与创建接口无关的Fortran构造。但是，这也包括语法错误。所以，小心不要制作;-)。</p>
<p>通常，签名文件的内容区分大小写。扫描Fortran代码并写入签名文件时，除多行块或使用 <code>--no-lower</code> 选项外，F2PY 会自动降低所有情况。</p>
<p>签名文件的语法如下所示。</p>
<h2 id="Python模块块"><a href="#Python模块块" class="headerlink" title="Python模块块"></a>Python模块块</h2><p>签名文件可能包含一个（推荐）或更多 <code>python模块</code> 块。 <code>python模块</code> 块描述了F2PY生成的Python / C扩展模块 <code>module.c</code>的内容。</p>
<p>例外：如果 <code>&lt;modulename&gt;</code> 包含子字符串 <code>__user__</code> ，则相应的 <code>python模块</code> 块描述所谓的回调函数的签名。</p>
<p>python模块块具有以下结构：</p>
<pre class="line-numbers language-python"><code class="language-python">python module <span class="token operator">&lt;</span>modulename<span class="token operator">></span>
  <span class="token punctuation">[</span><span class="token operator">&lt;</span>usercode statement<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">[</span>
  interface
    <span class="token operator">&lt;</span>usercode statement<span class="token operator">></span>
    <span class="token operator">&lt;</span>Fortran block data signatures<span class="token operator">></span>
    <span class="token operator">&lt;</span>Fortran<span class="token operator">/</span>C routine signatures<span class="token operator">></span>
  end <span class="token punctuation">[</span>interface<span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">[</span>
  interface
    module <span class="token operator">&lt;</span>F90 modulename<span class="token operator">></span>
      <span class="token punctuation">[</span><span class="token operator">&lt;</span>F90 module data type declarations<span class="token operator">></span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token operator">&lt;</span>F90 module routine signatures<span class="token operator">></span><span class="token punctuation">]</span>
    end <span class="token punctuation">[</span>module <span class="token punctuation">[</span><span class="token operator">&lt;</span>F90 modulename<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  end <span class="token punctuation">[</span>interface<span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
end <span class="token punctuation">[</span>python module <span class="token punctuation">[</span><span class="token operator">&lt;</span>modulename<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里括号 <code>[]</code> 表示可选部分，点 <code>...</code> 表示前一部分中的一个或多个。 因此，<code>[]...</code> 读取前一部分的零个或多个。</p>
<h2 id="Fortran-C-的例程签名"><a href="#Fortran-C-的例程签名" class="headerlink" title="Fortran / C 的例程签名"></a>Fortran / C 的例程签名</h2><p>Fortran例程的签名具有以下结构：</p>
<pre class="line-numbers language-fortran"><code class="language-fortran">[<span class="token operator">&lt;</span>typespec<span class="token operator">></span>] <span class="token keyword">function</span> | <span class="token keyword">subroutine</span> <span class="token operator">&lt;</span>routine name<span class="token operator">></span> \
              [ <span class="token punctuation">(</span> [<span class="token operator">&lt;</span>arguments<span class="token operator">></span>] <span class="token punctuation">)</span> ] [ <span class="token keyword">result</span> <span class="token punctuation">(</span> <span class="token operator">&lt;</span>entityname<span class="token operator">></span> <span class="token punctuation">)</span> ]
  [<span class="token operator">&lt;</span>argument<span class="token operator">/</span>variable <span class="token keyword">type</span> declarations<span class="token operator">></span>]
  [<span class="token operator">&lt;</span>argument<span class="token operator">/</span>variable attribute statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span><span class="token keyword">use</span> statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span><span class="token keyword">common</span> block statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span>other statements<span class="token operator">></span>]
<span class="token keyword">end</span> [ <span class="token keyword">function</span> | <span class="token keyword">subroutine</span> [<span class="token operator">&lt;</span>routine name<span class="token operator">></span>] ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从Fortran例程签名中，F2PY生成具有以下签名的 Python/C 扩展函数：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token operator">&lt;</span>routine name<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&lt;</span>required arguments<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>optional arguments<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token keyword">return</span> variables<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Fortran块数据的签名具有以下结构：</p>
<pre class="line-numbers language-fortran"><code class="language-fortran"><span class="token keyword">block data</span> [ <span class="token operator">&lt;</span><span class="token keyword">block data</span> name<span class="token operator">></span> ]
  [<span class="token operator">&lt;</span>variable <span class="token keyword">type</span> declarations<span class="token operator">></span>]
  [<span class="token operator">&lt;</span>variable attribute statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span><span class="token keyword">use</span> statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span><span class="token keyword">common</span> block statements<span class="token operator">></span>]
  [<span class="token operator">&lt;</span><span class="token keyword">include</span> statements<span class="token operator">></span>]
<span class="token keyword">end</span> [ <span class="token keyword">block data</span> [<span class="token operator">&lt;</span><span class="token keyword">block data</span> name<span class="token operator">></span>] ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="类型声明"><a href="#类型声明" class="headerlink" title="类型声明"></a>类型声明</h3><p><code>&lt;argument/variable type declaration&gt;</code> 部分的定义是：</p>
<pre class="line-numbers language-fortran"><code class="language-fortran"><span class="token operator">&lt;</span>typespec<span class="token operator">></span> [ [<span class="token operator">&lt;</span>attrspec<span class="token operator">></span>] <span class="token operator">::</span> ] <span class="token operator">&lt;</span>entitydecl<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当</p>
<pre class="line-numbers language-fortran"><code class="language-fortran"><span class="token operator">&lt;</span>typespec<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> byte | <span class="token keyword">character</span> [<span class="token operator">&lt;</span>charselector<span class="token operator">></span>]
           | <span class="token keyword">complex</span> [<span class="token operator">&lt;</span>kindselector<span class="token operator">></span>] | <span class="token keyword">real</span> [<span class="token operator">&lt;</span>kindselector<span class="token operator">></span>]
           | double <span class="token keyword">complex</span> | <span class="token keyword">double precision</span>
           | <span class="token keyword">integer</span> [<span class="token operator">&lt;</span>kindselector<span class="token operator">></span>] | <span class="token keyword">logical</span> [<span class="token operator">&lt;</span>kindselector<span class="token operator">></span>]

<span class="token operator">&lt;</span>charselector<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">*</span> <span class="token operator">&lt;</span>charlen<span class="token operator">></span>
               | <span class="token punctuation">(</span> [len<span class="token operator">=</span>] <span class="token operator">&lt;</span>len<span class="token operator">></span> [ <span class="token punctuation">,</span> [<span class="token keyword">kind</span><span class="token operator">=</span>] <span class="token operator">&lt;</span><span class="token keyword">kind</span><span class="token operator">></span>] <span class="token punctuation">)</span>
               | <span class="token punctuation">(</span> <span class="token keyword">kind</span><span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">kind</span><span class="token operator">></span> [ <span class="token punctuation">,</span> len<span class="token operator">=</span> <span class="token operator">&lt;</span>len<span class="token operator">></span> ] <span class="token punctuation">)</span>
<span class="token operator">&lt;</span>kindselector<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">*</span> <span class="token operator">&lt;</span>intlen<span class="token operator">></span> | <span class="token punctuation">(</span> [<span class="token keyword">kind</span><span class="token operator">=</span>] <span class="token operator">&lt;</span><span class="token keyword">kind</span><span class="token operator">></span> <span class="token punctuation">)</span>

<span class="token operator">&lt;</span>entitydecl<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&lt;</span>name<span class="token operator">></span> [ [ <span class="token operator">*</span> <span class="token operator">&lt;</span>charlen<span class="token operator">></span> ] [ <span class="token punctuation">(</span> <span class="token operator">&lt;</span>arrayspec<span class="token operator">></span> <span class="token punctuation">)</span> ]
                      | [ <span class="token punctuation">(</span> <span class="token operator">&lt;</span>arrayspec<span class="token operator">></span> <span class="token punctuation">)</span> ] <span class="token operator">*</span> <span class="token operator">&lt;</span>charlen<span class="token operator">></span> ]
                     | [ <span class="token operator">/</span> <span class="token operator">&lt;</span>init_expr<span class="token operator">></span> <span class="token operator">/</span> | <span class="token operator">=</span> <span class="token operator">&lt;</span>init_expr<span class="token operator">></span> ] \
                       [ <span class="token punctuation">,</span> <span class="token operator">&lt;</span>entitydecl<span class="token operator">></span> ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并且</p>
<ul>
<li><code>&lt;attrspec&gt;</code> is a comma separated list of attributes;</li>
<li><code>&lt;arrayspec&gt;</code> is a comma separated list of dimension bounds;</li>
<li><code>&lt;init_expr&gt;</code> is a C expression.</li>
<li><code>&lt;intlen&gt;</code> may be negative integer for <code>integer</code> type specifications. In such cases <code>integer*</code> represents unsigned C integers.</li>
</ul>
<p>如果参数没有 <code>&lt;argument type Declaration&gt;</code>，则通过对其名称应用<code>隐式（implicit）</code>规则来确定其类型。</p>
<h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><ul>
<li><p>属性声明：</p>
<p>The <code>&lt;argument/variable attribute statement&gt;</code> is <code>&lt;argument/variable type declaration&gt;</code> without <code>&lt;typespec&gt;</code>. In addition, in an attribute statement one cannot use other attributes, also <code>&lt;entitydecl&gt;</code> can be only a list of names.</p>
</li>
<li><p>使用声明：</p>
<p>The definition of the <code>&lt;use statement&gt;</code> part is</p>
<pre class="line-numbers language-python"><code class="language-python">use <span class="token operator">&lt;</span>modulename<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span>rename_list<span class="token operator">></span> <span class="token operator">|</span> <span class="token punctuation">,</span> ONLY <span class="token punctuation">:</span> <span class="token operator">&lt;</span>only_list<span class="token operator">></span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>where</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">&lt;</span>rename_list<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&lt;</span>local_name<span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&lt;</span>use_name<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span>rename_list<span class="token operator">></span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Currently F2PY uses <code>use</code> statement only for linking call-back modules and <code>external</code> arguments (call-back functions).</p>
</li>
<li><p>Common block statements:</p>
<p>The definition of the <code>&lt;common block statement&gt;</code> part is</p>
<pre class="line-numbers language-python"><code class="language-python">common <span class="token operator">/</span> <span class="token operator">&lt;</span>common name<span class="token operator">></span> <span class="token operator">/</span> <span class="token operator">&lt;</span>shortentitydecl<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>where</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">&lt;</span>shortentitydecl<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">(</span> <span class="token operator">&lt;</span>arrayspec<span class="token operator">></span> <span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token operator">&lt;</span>shortentitydecl<span class="token operator">></span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>If a <code>python module</code> block contains two or more <code>common</code> blocks with the same name, the variables from the additional declarations are appended. The types of variables in <code>&lt;shortentitydecl&gt;</code> are defined using <code>&lt;argument type declarations&gt;</code>. Note that the corresponding <code>&lt;argument type declarations&gt;</code> may contain array specifications; then you don’t need to specify these in <code>&lt;shortentitydecl&gt;</code>.</p>
</li>
<li><p>Other statements:</p>
<p>The <code>&lt;other statement&gt;</code> part refers to any other Fortran language constructs that are not described above. F2PY ignores most of them except</p>
<ul>
<li><p><code>call</code> statements and function calls of <code>external</code> arguments;</p>
</li>
<li><p><code>include</code> statements</p>
<pre class="line-numbers language-python"><code class="language-python">include <span class="token string">'&lt;filename>'</span>
include <span class="token string">"&lt;filename>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>If a file <code>&lt;filename&gt;</code> does not exist, the <code>include</code> statement is ignored. Otherwise, the file <code>&lt;filename&gt;</code> is included to a signature file. <code>include</code> statements can be used in any part of a signature file, also outside the Fortran/C routine signature blocks.</p>
</li>
<li><p><code>implicit</code> statements</p>
<pre class="line-numbers language-python"><code class="language-python">implicit none
implicit <span class="token operator">&lt;</span>list of implicit maps<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>where</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">&lt;</span>implicit map<span class="token operator">></span> <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token operator">&lt;</span>typespec<span class="token operator">></span> <span class="token punctuation">(</span> <span class="token operator">&lt;</span>list of letters <span class="token operator">or</span> range of letters<span class="token operator">></span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Implicit rules are used to determine the type specification of a variable (from the first-letter of its name) if the variable is not defined using <code>&lt;variable type declaration&gt;</code>. Default implicit rule is given by</p>
<pre class="line-numbers language-python"><code class="language-python">implicit real <span class="token punctuation">(</span>a<span class="token operator">-</span>h<span class="token punctuation">,</span>o<span class="token operator">-</span>z<span class="token punctuation">,</span>$_<span class="token punctuation">)</span><span class="token punctuation">,</span> integer <span class="token punctuation">(</span>i<span class="token operator">-</span>m<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>entry</code> statements</p>
<pre class="line-numbers language-python"><code class="language-python">entry <span class="token operator">&lt;</span>entry name<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>arguments<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>F2PY generates wrappers to all entry names using the signature of the routine block.</p>
<p>Tip: <code>entry</code> statement can be used to describe the signature of an arbitrary routine allowing F2PY to generate a number of wrappers from only one routine block signature. There are few restrictions while doing this: <code>fortranname</code> cannot be used, <code>callstatement</code> and <code>callprotoargument</code> can be used only if they are valid for all entry routines, etc.</p>
</li>
</ul>
<p>In addition, F2PY introduces the following statements:</p>
<ul>
<li><p><code>threadsafe</code></p>
<p>Use <code>Py_BEGIN_ALLOW_THREADS .. Py_END_ALLOW_THREADS</code> block around the call to Fortran/C function.</p>
</li>
<li><p><code>callstatement &lt;C-expr|multi-line block&gt;</code></p>
<p>Replace F2PY generated call statement to Fortran/C function with <code>&lt;C-expr|multi-line block&gt;</code>. The wrapped Fortran/C function is available as <code>(*f2py_func)</code>. To raise an exception, set <code>f2py_success = 0</code> in <code>&lt;C-expr|multi-line block&gt;</code>.</p>
</li>
<li><p><code>callprotoargument &lt;C-typespecs&gt;</code></p>
<p>When <code>callstatement</code> statement is used then F2PY may not generate proper prototypes for Fortran/C functions (because <code>&lt;C-expr&gt;</code> may contain any function calls and F2PY has no way to determine what should be the proper prototype). With this statement you can explicitly specify the arguments of the corresponding prototype:</p>
<pre class="line-numbers language-python"><code class="language-python">extern <span class="token operator">&lt;</span><span class="token keyword">return</span> type<span class="token operator">></span> FUNC_F<span class="token punctuation">(</span><span class="token operator">&lt;</span>routine name<span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span>ROUTINE NAME<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>callprotoargument<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>fortranname [&lt;actual Fortran/C routine name&gt;]</code></p>
<p>You can use arbitrary <code>&lt;routine name&gt;</code> for a given Fortran/C function. Then you have to specify <code>&lt;actual Fortran/C routine name&gt;</code> with this statement.</p>
<p>If <code>fortranname</code> statement is used without <code>&lt;actual Fortran/C routine name&gt;</code> then a dummy wrapper is generated.</p>
</li>
<li><p><code>usercode</code></p>
<p>When used inside <code>python module</code> block, then given C code will be inserted to generated C/API source just before wrapper function definitions. Here you can define arbitrary C functions to be used in initialization of optional arguments, for example. If <code>usercode</code> is used twice inside <code>python module</code> block then the second multiline block is inserted after the definition of external routines.</p>
<p>When used inside <code>&lt;routine signature&gt;</code>, then given C code will be inserted to the corresponding wrapper function just after declaring variables but before any C statements. So, <code>usercode</code> follow-up can contain both declarations and C statements.</p>
<p>When used inside the first <code>interface</code> block, then given C code will be inserted at the end of the initialization function of the extension module. Here you can modify extension modules dictionary. For example, for defining additional variables etc.</p>
</li>
<li><p><code>pymethoddef &lt;multiline block&gt;</code></p>
<p>Multiline block will be inserted to the definition of module methods <code>PyMethodDef</code>-array. It must be a comma-separated list of C arrays (see <a href="https://docs.python.org/extending/index.html" target="_blank" rel="noopener">Extending and Embedding</a> Python documentation for details). <code>pymethoddef</code> statement can be used only inside <code>python module</code> block.</p>
</li>
</ul>
</li>
</ul>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>The following attributes are used by F2PY:</p>
<ul>
<li><p><code>optional</code></p>
<p>The corresponding argument is moved to the end of <code>&lt;optional arguments&gt;</code> list. A default value for an optional argument can be specified <code>&lt;init_expr&gt;</code>, see <code>entitydecl</code> definition. Note that the default value must be given as a valid C expression.</p>
<p>Note that whenever <code>&lt;init_expr&gt;</code> is used, <code>optional</code> attribute is set automatically by F2PY.</p>
<p>For an optional array argument, all its dimensions must be bounded.</p>
</li>
<li><p><code>required</code></p>
<p>The corresponding argument is considered as a required one. This is default. You need to specify <code>required</code> only if there is a need to disable automatic <code>optional</code> setting when <code>&lt;init_expr&gt;</code> is used.</p>
<p>If Python <code>None</code> object is used as a required argument, the argument is treated as optional. That is, in the case of array argument, the memory is allocated. And if <code>&lt;init_expr&gt;</code> is given, the corresponding initialization is carried out.</p>
</li>
<li><p><code>dimension(&lt;arrayspec&gt;)</code></p>
<p>The corresponding variable is considered as an array with given dimensions in <code>&lt;arrayspec&gt;</code>.</p>
</li>
<li><p><code>intent(&lt;intentspec&gt;)</code></p>
<p>This specifies the “intention” of the corresponding argument. <code>&lt;intentspec&gt;</code> is a comma separated list of the following keys:</p>
<ul>
<li><p><code>in</code></p>
<p>The argument is considered as an input-only argument. It means that the value of the argument is passed to Fortran/C function and that function is expected not to change the value of an argument.</p>
</li>
<li><p><code>inout</code></p>
<p>The argument is considered as an input/output or <em>in situ</em> output argument. <code>intent(inout)</code> arguments can be only “contiguous” NumPy arrays with proper type and size. Here “contiguous” can be either in Fortran or C sense. The latter one coincides with the contiguous concept used in NumPy and is effective only if <code>intent(c)</code> is used. Fortran contiguity is assumed by default.</p>
<p>Using <code>intent(inout)</code> is generally not recommended, use <code>intent(in,out)</code> instead. See also <code>intent(inplace)</code> attribute.</p>
</li>
<li><p><code>inplace</code></p>
<p>The argument is considered as an input/output or <em>in situ</em> output argument. <code>intent(inplace)</code> arguments must be NumPy arrays with proper size. If the type of an array is not “proper” or the array is non-contiguous then the array will be changed in-place to fix the type and make it contiguous.</p>
<p>Using <code>intent(inplace)</code> is generally not recommended either. For example, when slices have been taken from an <code>intent(inplace)</code> argument then after in-place changes, slices data pointers may point to unallocated memory area.</p>
</li>
<li><p><code>out</code></p>
<p>The argument is considered as a return variable. It is appended to the <code>&lt;returned variables&gt;</code> list. Using <code>intent(out)</code> sets <code>intent(hide)</code> automatically, unless also <code>intent(in)</code> or <code>intent(inout)</code> were used.</p>
<p>By default, returned multidimensional arrays are Fortran-contiguous. If <code>intent(c)</code> is used, then returned multidimensional arrays are C-contiguous.</p>
</li>
<li><p><code>hide</code></p>
<p>The argument is removed from the list of required or optional arguments. Typically <code>intent(hide)</code> is used with <code>intent(out)</code> or when <code>&lt;init_expr&gt;</code> completely determines the value of the argument like in the following example:</p>
<pre class="line-numbers language-python"><code class="language-python">integer intent<span class="token punctuation">(</span>hide<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n <span class="token operator">=</span> len<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
real intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dimension<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p><code>c</code></p>
<p>The argument is treated as a C scalar or C array argument. In the case of a scalar argument, its value is passed to C function as a C scalar argument (recall that Fortran scalar arguments are actually C pointer arguments). In the case of an array argument, the wrapper function is assumed to treat multidimensional arrays as C-contiguous arrays.</p>
<p>There is no need to use <code>intent(c)</code> for one-dimensional arrays, no matter if the wrapped function is either a Fortran or a C function. This is because the concepts of Fortran- and C contiguity overlap in one-dimensional cases.</p>
<p>If <code>intent(c)</code> is used as a statement but without an entity declaration list, then F2PY adds the <code>intent(c)</code> attribute to all arguments.</p>
<p>Also, when wrapping C functions, one must use <code>intent(c)</code> attribute for <code>&lt;routine name&gt;</code> in order to disable Fortran specific <code>F_FUNC(..,..)</code> macros.</p>
</li>
<li><p><code>cache</code></p>
<p>The argument is treated as a junk of memory. No Fortran nor C contiguity checks are carried out. Using <code>intent(cache)</code> makes sense only for array arguments, also in connection with <code>intent(hide)</code> or <code>optional</code> attributes.</p>
</li>
<li><p><code>copy</code></p>
<p>Ensure that the original contents of <code>intent(in)</code> argument is preserved. Typically used in connection with <code>intent(in,out)</code> attribute. F2PY creates an optional argument <code>overwrite_</code> with the default value <code>0</code>.</p>
</li>
<li><p><code>overwrite</code></p>
<p>The original contents of the <code>intent(in)</code> argument may be altered by the Fortran/C function. F2PY creates an optional argument <code>overwrite_</code> with the default value <code>1</code>.</p>
</li>
<li><p><code>out=</code></p>
<p>Replace the return name with <code>&lt;new name&gt;</code> in the <code>__doc__</code> string of a wrapper function.</p>
</li>
<li><p><code>callback</code></p>
<p>Construct an external function suitable for calling Python function from Fortran. <code>intent(callback)</code> must be specified before the corresponding <code>external</code> statement. If ‘argument’ is not in argument list then it will be added to Python wrapper but only initializing external function.</p>
<p>Use <code>intent(callback)</code> in situations where a Fortran/C code assumes that a user implements a function with given prototype and links it to an executable. Don’t use <code>intent(callback)</code> if function appears in the argument list of a Fortran routine.</p>
<p>With <code>intent(hide)</code> or <code>optional</code> attributes specified and using a wrapper function without specifying the callback argument in argument list then call-back function is looked in the namespace of F2PY generated extension module where it can be set as a module attribute by a user.</p>
</li>
<li><p><code>aux</code></p>
<p>Define auxiliary C variable in F2PY generated wrapper function. Useful to save parameter values so that they can be accessed in initialization expression of other variables. Note that <code>intent(aux)</code> silently implies <code>intent(c)</code>.</p>
</li>
</ul>
<p>The following rules apply:</p>
<ul>
<li>If no <code>intent(in | inout | out | hide)</code> is specified, <code>intent(in)</code> is assumed.</li>
<li><code>intent(in,inout)</code> is <code>intent(in)</code>.</li>
<li><code>intent(in,hide)</code> or <code>intent(inout,hide)</code> is <code>intent(hide)</code>.</li>
<li><code>intent(out)</code> is <code>intent(out,hide)</code> unless <code>intent(in)</code> or <code>intent(inout)</code> is specified.</li>
<li>If <code>intent(copy)</code> or <code>intent(overwrite)</code> is used, then an additional optional argument is introduced with a name <code>overwrite_</code> and a default value 0 or 1, respectively.</li>
<li><code>intent(inout,inplace)</code> is <code>intent(inplace)</code>.</li>
<li><code>intent(in,inplace)</code> is <code>intent(inplace)</code>.</li>
<li><code>intent(hide)</code> disables <code>optional</code> and <code>required</code>.</li>
</ul>
</li>
<li><p><code>check([&lt;C-booleanexpr&gt;])</code></p>
<p>Perform consistency check of arguments by evaluating <code>&lt;C-booleanexpr&gt;</code>; if <code>&lt;C-booleanexpr&gt;</code> returns 0, an exception is raised.</p>
<p>If <code>check(..)</code> is not used then F2PY generates few standard checks (e.g. in a case of an array argument, check for the proper shape and size) automatically. Use <code>check()</code> to disable checks generated by F2PY.</p>
</li>
<li><p><code>depend([&lt;names&gt;])</code></p>
<p>This declares that the corresponding argument depends on the values of variables in the list <code>&lt;names&gt;</code>. For example, <code>&lt;init_expr&gt;</code> may use the values of other arguments. Using information given by <code>depend(..)</code> attributes, F2PY ensures that arguments are initialized in a proper order. If <code>depend(..)</code> attribute is not used then F2PY determines dependence relations automatically. Use <code>depend()</code> to disable dependence relations generated by F2PY.</p>
<p>When you edit dependence relations that were initially generated by F2PY, be careful not to break the dependence relations of other relevant variables. Another thing to watch out is cyclic dependencies. F2PY is able to detect cyclic dependencies when constructing wrappers and it complains if any are found.</p>
</li>
<li><p><code>allocatable</code></p>
<p>The corresponding variable is Fortran 90 allocatable array defined as Fortran 90 module data.</p>
</li>
<li><p><code>external</code></p>
<p>The corresponding argument is a function provided by user. The signature of this so-called call-back function can be defined</p>
<ul>
<li>in <code>__user__</code> module block,</li>
<li>or by demonstrative (or real, if the signature file is a real Fortran code) call in the <code>&lt;other statements&gt;</code> block.</li>
</ul>
<p>For example, F2PY generates from</p>
<pre class="line-numbers language-python"><code class="language-python">external cb_sub<span class="token punctuation">,</span> cb_fun
integer n
real a<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>r
call cb_sub<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
r <span class="token operator">=</span> cb_fun<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>the following call-back signatures:</p>
<pre class="line-numbers language-python"><code class="language-python">subroutine cb_sub<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
    real dimension<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a
    integer optional<span class="token punctuation">,</span>check<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">>=</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n<span class="token operator">=</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
end subroutine cb_sub
function cb_fun<span class="token punctuation">(</span>e_4_e<span class="token punctuation">)</span> result <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    integer <span class="token punctuation">:</span><span class="token punctuation">:</span> e_4_e
    real <span class="token punctuation">:</span><span class="token punctuation">:</span> r
end function cb_fun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The corresponding user-provided Python function are then:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">cb_sub</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span>
<span class="token keyword">def</span> <span class="token function">cb_fun</span><span class="token punctuation">(</span>e_4_e<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>See also <code>intent(callback)</code> attribute.</p>
</li>
<li><p><code>parameter</code></p>
<p>The corresponding variable is a parameter and it must have a fixed value. F2PY replaces all parameter occurrences by their corresponding values.</p>
</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><h3 id="F2PY-指令"><a href="#F2PY-指令" class="headerlink" title="F2PY 指令"></a>F2PY 指令</h3><p>The so-called F2PY directives allow using F2PY signature file constructs also in Fortran 77/90 source codes. With this feature you can skip (almost) completely intermediate signature file generations and apply F2PY directly to Fortran source codes.</p>
<p>F2PY directive has the following form:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">&lt;</span>comment char<span class="token operator">></span>f2py <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>where allowed comment characters for fixed and free format Fortran codes are <code>cC*!#</code> and <code>!</code>, respectively. Everything that follows <code>f2py</code> is ignored by a compiler but read by F2PY as a normal Fortran, non-comment line:</p>
<pre class="line-numbers language-python"><code class="language-python">When F2PY finds a line <span class="token keyword">with</span> F2PY directive<span class="token punctuation">,</span> the directive <span class="token keyword">is</span> first replaced by <span class="token number">5</span> spaces <span class="token operator">and</span> then the line <span class="token keyword">is</span> reread<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>For fixed format Fortran codes, <code>&lt;comment char&gt;</code> must be at the first column of a file, of course. For free format Fortran codes, F2PY directives can appear anywhere in a file.</p>
<h3 id="C-表达式"><a href="#C-表达式" class="headerlink" title="C 表达式"></a>C 表达式</h3><p>C expressions are used in the following parts of signature files:</p>
<ul>
<li><code>&lt;init_expr&gt;</code> of variable initialization;</li>
<li><code>&lt;C-booleanexpr&gt;</code> of the <code>check</code> attribute;</li>
<li><code>&lt;arrayspec&gt;</code> of the <code>dimension</code> attribute;</li>
<li><code>callstatement</code> statement, here also a C multiline block can be used.</li>
</ul>
<p>A C expression may contain:</p>
<ul>
<li>standard C constructs;</li>
<li>functions from <code>math.h</code> and <code>Python.h</code>;</li>
<li>variables from the argument list, presumably initialized before</li>
</ul>
<p>according to given dependence relations;</p>
<ul>
<li>the following CPP macros:<ul>
<li><code>rank(&lt;name&gt;)</code> Returns the rank of an array <code>&lt;name&gt;</code>.</li>
<li><code>shape(&lt;name&gt;,&lt;n&gt;)</code> Returns the <code>&lt;n</code>-th dimension of an array <code>&lt;name&gt;</code>.</li>
<li><code>len(&lt;name&gt;)</code> Returns the length of an array <code>&lt;name&gt;</code>.</li>
<li><code>size(&lt;name&gt;)</code> Returns the size of an array <code>&lt;name&gt;</code>.</li>
<li><code>slen(&lt;name&gt;)</code> Returns the length of a string <code>&lt;name&gt;</code>.</li>
</ul>
</li>
</ul>
<p>For initializing an array <code>&lt;array name&gt;</code>, F2PY generates a loop over all indices and dimensions that executes the following pseudo-statement:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">&lt;</span>array name<span class="token operator">></span><span class="token punctuation">(</span>_i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>_i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>init_expr<span class="token operator">></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>where <code>_i[&lt;i&gt;]</code> refers to the <code>&lt;i&gt;</code>-th index value and that runs from <code>0</code> to <code>shape(&lt;array name&gt;,&lt;i&gt;)-1</code>.</p>
<p>For example, a function <code>myrange(n)</code> generated from the following signature</p>
<pre class="line-numbers language-python"><code class="language-python">subroutine myrange<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
  fortranname        ! myrange <span class="token keyword">is</span> a dummy wrapper
  integer intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n
  real<span class="token operator">*</span><span class="token number">8</span> intent<span class="token punctuation">(</span>c<span class="token punctuation">,</span>out<span class="token punctuation">)</span><span class="token punctuation">,</span>dimension<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a <span class="token operator">=</span> _i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
end subroutine myrange<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>is equivalent to <code>numpy.arange(n,dtype=float)</code>.</p>
<p>Warning</p>
<p>F2PY may lower cases also in C expressions when scanning Fortran codes (see <code>--[no]-lower</code> option).</p>
<h3 id="多行块"><a href="#多行块" class="headerlink" title="多行块"></a>多行块</h3><p>A multiline block starts with <code>'''</code> (triple single-quotes) and ends with <code>'''</code> in some <em>strictly</em> subsequent line. Multiline blocks can be used only within .pyf files. The contents of a multiline block can be arbitrary (except that it cannot contain <code>'''</code>) and no transformations (e.g. lowering cases) are applied to it.</p>
<p>Currently, multiline blocks can be used in the following constructs:</p>
<ul>
<li>as a C expression of the <code>callstatement</code> statement;</li>
<li>as a C type specification of the <code>callprotoargument</code> statement;</li>
<li>as a C code block of the <code>usercode</code> statement;</li>
<li>as a list of C arrays of the <code>pymethoddef</code> statement;</li>
<li>as documentation string.</li>
</ul>
<h1 id="在Python中使用F2PY构建"><a href="#在Python中使用F2PY构建" class="headerlink" title="在Python中使用F2PY构建"></a>在Python中使用F2PY构建</h1><p>Fortran / C例程，公共块或F2PY生成的Fortran 90模块数据的所有包装器都作为<code>fortran</code> 类型对象公开给Python 。 例程包装器是可调用<code>fortran</code>类型对象，而Fortran数据包装器具有引用数据对象的属性。</p>
<p>所有<code>fortran</code>类型对象都具有<code>_cpointer</code>包含CObject的属性，该CObject引用相应Fortran / C函数的C指针或C级别的变量。当这些函数的计算部分在C或Fortran中实现并用F2PY（或任何其他工具）包装时，这些CObject可以用作F2PY生成函数的回调参数，以绕过从Fortran或C调用Python函数的Python C / API层。能够提供功能的CObject）。</p>
<p>考虑一个Fortran 77文件<code>ftype.f</code>：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> FTYPE<span class="token punctuation">.</span>F
      SUBROUTINE FOO<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
      INTEGER N
Cf2py integer optional<span class="token punctuation">,</span>intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n <span class="token operator">=</span> <span class="token number">13</span>
      REAL A<span class="token punctuation">,</span>X
      COMMON <span class="token operator">/</span>DATA<span class="token operator">/</span> A<span class="token punctuation">,</span>X<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"IN FOO: N="</span><span class="token punctuation">,</span>N<span class="token punctuation">,</span><span class="token string">" A="</span><span class="token punctuation">,</span>A<span class="token punctuation">,</span><span class="token string">" X=["</span><span class="token punctuation">,</span>X<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>X<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>X<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"]"</span>
      END
C END OF FTYPE<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用。构建一个包装器。<code>f2py -c ftype.f -m ftype</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ftype
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> ftype<span class="token punctuation">.</span>__doc__
This module <span class="token string">'ftype'</span> <span class="token keyword">is</span> auto<span class="token operator">-</span>generated <span class="token keyword">with</span> f2py <span class="token punctuation">(</span>version<span class="token punctuation">:</span><span class="token number">2.28</span><span class="token punctuation">.</span><span class="token number">198</span><span class="token operator">-</span><span class="token number">1366</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
Functions<span class="token punctuation">:</span>
  foo<span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
COMMON blocks<span class="token punctuation">:</span>
  <span class="token operator">/</span>data<span class="token operator">/</span> a<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>ftype<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span>type<span class="token punctuation">(</span>ftype<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token operator">&lt;</span>type <span class="token string">'fortran'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>type <span class="token string">'fortran'</span><span class="token operator">></span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 IN FOO<span class="token punctuation">:</span> N<span class="token operator">=</span> <span class="token number">13</span> A<span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">.</span> X<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 IN FOO<span class="token punctuation">:</span> N<span class="token operator">=</span> <span class="token number">13</span> A<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span> X<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">2</span><span class="token punctuation">.</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">45</span>  
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>
 IN FOO<span class="token punctuation">:</span> N<span class="token operator">=</span> <span class="token number">24</span> A<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span> X<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">45</span><span class="token punctuation">.</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> ftype<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x
array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="标量参数"><a href="#标量参数" class="headerlink" title="标量参数"></a>标量参数</h2><p>通常，F2PY生成的包装函数的标量参数可以是普通的Python标量（整数，浮点数，复数）以及标量的任意序列对象（列表，元组，数组，字符串）。在后一种情况下，序列对象的第一个元素作为标量参数传递给Fortran例程。</p>
<p>请注意，当需要进行类型转换并且可能丢失信息时（例如，当将类型转换浮动为整数或复数转换为浮动时），F2PY不会引发任何异常。在复杂到真实的类型转换中，仅使用复数的实部。</p>
<p><code>intent(inout)</code>标量参数被假定为数组对象，以便 <em>原位</em> 更改生效。建议使用具有适当类型的数组，但也可以使用其他类型的数组。</p>
<p>考虑以下Fortran 77代码：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> SCALAR<span class="token punctuation">.</span>F
      SUBROUTINE FOO<span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span>
      REAL<span class="token operator">*</span><span class="token number">8</span> A<span class="token punctuation">,</span> B
Cf2py intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> a
Cf2py intent<span class="token punctuation">(</span>inout<span class="token punctuation">)</span> b
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"    A="</span><span class="token punctuation">,</span>A<span class="token punctuation">,</span><span class="token string">" B="</span><span class="token punctuation">,</span>B
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"INCREMENT A AND B"</span>
      A <span class="token operator">=</span> A <span class="token operator">+</span> <span class="token number">1D0</span>
      B <span class="token operator">=</span> B <span class="token operator">+</span> <span class="token number">1D0</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"NEW A="</span><span class="token punctuation">,</span>A<span class="token punctuation">,</span><span class="token string">" B="</span><span class="token punctuation">,</span>B
      END
C END OF FILE SCALAR<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m scalar scalar.f</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> scalar
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> scalar<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>__doc__
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> input float
  b <span class="token punctuation">:</span> <span class="token keyword">in</span><span class="token operator">/</span>output rank<span class="token number">-0</span> array<span class="token punctuation">(</span>float<span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> scalar<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>   
     A<span class="token operator">=</span>  <span class="token number">2</span><span class="token punctuation">.</span> B<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span>
 INCREMENT A AND B
 NEW A<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span> B<span class="token operator">=</span>  <span class="token number">4</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy
<span class="token operator">>></span><span class="token operator">></span> a<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true"># these are integer rank-0 arrays</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> scalar<span class="token punctuation">.</span>foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
     A<span class="token operator">=</span>  <span class="token number">2</span><span class="token punctuation">.</span> B<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span>
 INCREMENT A AND B
 NEW A<span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">.</span> B<span class="token operator">=</span>  <span class="token number">4</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a<span class="token punctuation">,</span>b            <span class="token comment" spellcheck="true"># note that only b is changed in situ</span>
<span class="token number">2</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="字符串参数"><a href="#字符串参数" class="headerlink" title="字符串参数"></a>字符串参数</h2><p>F2PY生成的包装函数接受（几乎）任何Python对象作为字符串参数，<code>str</code>应用于非字符串对象。例外是NumPy数组必须具有类型代码<code>'c'</code>或 <code>'1'</code>用作字符串参数。</p>
<p>当将字符串用作F2PY生成的包装函数的字符串参数时，字符串可以具有任意长度。如果长度大于预期，则字符串将被截断。如果长度小于预期，则分配并填充额外的内存<code>\0</code>。</p>
<p>因为Python字符串是不可变的，所以<code>intent(inout)</code>参数需要字符串的数组版本才能使 <em>原位</em> 更改生效。</p>
<p>考虑以下Fortran 77代码：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> STRING<span class="token punctuation">.</span>F
      SUBROUTINE FOO<span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>C<span class="token punctuation">,</span>D<span class="token punctuation">)</span>
      CHARACTER<span class="token operator">*</span><span class="token number">5</span> A<span class="token punctuation">,</span> B
      CHARACTER<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> C<span class="token punctuation">,</span>D
Cf2py intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">)</span> a<span class="token punctuation">,</span>c
Cf2py intent<span class="token punctuation">(</span>inout<span class="token punctuation">)</span> b<span class="token punctuation">,</span>d
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"A="</span><span class="token punctuation">,</span>A
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"B="</span><span class="token punctuation">,</span>B
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"C="</span><span class="token punctuation">,</span>C
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"D="</span><span class="token punctuation">,</span>D
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"CHANGE A,B,C,D"</span>
      A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'A'</span>
      B<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'B'</span>
      C<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'C'</span>
      D<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'D'</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"A="</span><span class="token punctuation">,</span>A
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"B="</span><span class="token punctuation">,</span>B
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"C="</span><span class="token punctuation">,</span>C
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"D="</span><span class="token punctuation">,</span>D
      END
C END OF FILE STRING<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m mystring string.f</code></p>
<p>Python会话：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> mystring
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> mystring<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>__doc__
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> input string<span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
  b <span class="token punctuation">:</span> <span class="token keyword">in</span><span class="token operator">/</span>output rank<span class="token number">-0</span> array<span class="token punctuation">(</span>string<span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span>
  c <span class="token punctuation">:</span> input string<span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  d <span class="token punctuation">:</span> <span class="token keyword">in</span><span class="token operator">/</span>output rank<span class="token number">-0</span> array<span class="token punctuation">(</span>string<span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy
<span class="token operator">>></span><span class="token operator">></span> a<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token operator">=</span>numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> mystring<span class="token punctuation">.</span>foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
 A<span class="token operator">=</span><span class="token number">123</span>
 B<span class="token operator">=</span><span class="token number">123</span>
 C<span class="token operator">=</span><span class="token number">123</span>
 D<span class="token operator">=</span><span class="token number">123</span>
 CHANGE A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>C<span class="token punctuation">,</span>D
 A<span class="token operator">=</span>A23
 B<span class="token operator">=</span>B23
 C<span class="token operator">=</span>C23
 D<span class="token operator">=</span>D23
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>tostring<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>tostring<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>c<span class="token punctuation">.</span>tostring<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>d<span class="token punctuation">.</span>tostring<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'B23'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'D23'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="数组参数"><a href="#数组参数" class="headerlink" title="数组参数"></a>数组参数</h2><p>通常，F2PY生成的包装函数的数组参数接受可以转换为NumPy数组对象的任意序列。一个例外是<code>intent(inout)</code>数组参数，它们必须始终是正确连续的并且具有正确的类型，否则会引发异常。另一个例外是<code>intent(inplace)</code>数组参数，如果参数的类型与预期不同，则属性将在原位更改（<code>intent(inplace)</code>有关更多信息，请参阅属性）。</p>
<p>通常，如果NumPy数组是正确连续的并且具有适当的类型，那么它将直接传递给包装的Fortran / C函数。否则，将生成输入数组的元素副本，并将正确连续且具有适当类型的副本用作数组参数。</p>
<p>有两种类型的适当连续的NumPy数组：</p>
<ul>
<li>当数据按列存储时，Fortran连续数组，即存储在存储器中的数据索引从最低维开始;</li>
<li>当数据以行方式存储时，C-连续或简单连续的数组，即存储在存储器中的数据的索引从最高维度开始。</li>
</ul>
<p>对于一维数组，这些概念重合。</p>
<p>例如，如果2x2数组<code>A</code>的元素按以下顺序存储在内存中，则它是Fortran连续的：</p>
<pre class="line-numbers language-python"><code class="language-python">A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果订单如下，则为C-contiguous：</p>
<pre class="line-numbers language-python"><code class="language-python">A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>要测试数组是否为C-contiguous，请使用<code>.iscontiguous()</code> NumPy数组的方法。为了测试Fortran连续性，所有F2PY生成的扩展模块都提供了一个功能 <code>has_column_major_storage()</code>。此功能相当于 <code>.flags.f_contiguous</code>但效率更高。</p>
<p>通常不需要担心数组如何存储在内存中以及包装函数（Fortran函数还是C函数）是否采用一个或另一个存储顺序。F2PY自动确保包装函数以适当的存储顺序获取参数; 相应的算法被设计为仅在绝对必要时才复制数组。但是，当处理大小接近计算机中物理内存大小的非常大的多维输入数组时，必须注意始终使用适当连续且正确的类型参数。</p>
<p>要在将输入数组传递给Fortran例程之前将其转换为列主存储顺序，请使用<code>as_column_major_storage()</code>由所有F2PY生成的扩展模块提供的函数 。</p>
<p>考虑Fortran 77代码：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> ARRAY<span class="token punctuation">.</span>F
      SUBROUTINE FOO<span class="token punctuation">(</span>A<span class="token punctuation">,</span>N<span class="token punctuation">,</span>M<span class="token punctuation">)</span>
C
C     INCREMENT THE FIRST ROW AND DECREMENT THE FIRST COLUMN OF A
C
      INTEGER N<span class="token punctuation">,</span>M<span class="token punctuation">,</span>I<span class="token punctuation">,</span>J
      REAL<span class="token operator">*</span><span class="token number">8</span> A<span class="token punctuation">(</span>N<span class="token punctuation">,</span>M<span class="token punctuation">)</span>
Cf2py intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">,</span>out<span class="token punctuation">,</span>copy<span class="token punctuation">)</span> a
Cf2py integer intent<span class="token punctuation">(</span>hide<span class="token punctuation">)</span><span class="token punctuation">,</span>depend<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> n<span class="token operator">=</span>shape<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token operator">=</span>shape<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
      DO J<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>M
         A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>J<span class="token punctuation">)</span> <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>J<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1D0</span>
      ENDDO
      DO I<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>N
         A<span class="token punctuation">(</span>I<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> A<span class="token punctuation">(</span>I<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1D0</span>
      ENDDO
      END
C END OF FILE ARRAY<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m arr array.f -DF2PY_REPORT_ON_ARRAY_COPY=1</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> arr
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> numpy <span class="token keyword">import</span> array
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> arr<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>__doc__
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  a <span class="token operator">=</span> foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span>overwrite_a<span class="token punctuation">]</span><span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> input rank<span class="token number">-2</span> array<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">with</span> bounds <span class="token punctuation">(</span>n<span class="token punctuation">,</span>m<span class="token punctuation">)</span>
Optional arguments<span class="token punctuation">:</span>
  overwrite_a <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token number">0</span> input int
Return objects<span class="token punctuation">:</span>
  a <span class="token punctuation">:</span> rank<span class="token number">-2</span> array<span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">with</span> bounds <span class="token punctuation">(</span>n<span class="token punctuation">,</span>m<span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> a<span class="token operator">=</span>arr<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
copied an array using PyArray_CopyFromObject<span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> elsize<span class="token operator">=</span><span class="token number">8</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">3</span><span class="token punctuation">.</span>  <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>iscontiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>has_column_major_storage<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">=</span>arr<span class="token punctuation">.</span>foo<span class="token punctuation">(</span>a<span class="token punctuation">)</span>              <span class="token comment" spellcheck="true"># even if a is proper-contiguous</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                           <span class="token comment" spellcheck="true"># and has proper type, a copy is made</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                           <span class="token comment" spellcheck="true"># forced by intent(copy) attribute</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                           <span class="token comment" spellcheck="true"># to preserve its original contents</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
copied an array using copy_ND_array<span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> elsize<span class="token operator">=</span><span class="token number">8</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">3</span><span class="token punctuation">.</span>  <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> b
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">4</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token operator">=</span>arr<span class="token punctuation">.</span>foo<span class="token punctuation">(</span>a<span class="token punctuation">,</span>overwrite_a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># a is passed directly to Fortran</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                            <span class="token comment" spellcheck="true"># routine and its contents is discarded</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> a
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">4</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> b
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">4</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">.</span>  <span class="token number">5</span><span class="token punctuation">.</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> a <span class="token keyword">is</span> b                       <span class="token comment" spellcheck="true"># a and b are actually the same objects</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> arr<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># different rank arrays are allowed</span>
copied an array using PyArray_CopyFromObject<span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> elsize<span class="token operator">=</span><span class="token number">8</span>
<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> arr<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
copied an array using PyArray_CopyFromObject<span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> elsize<span class="token operator">=</span><span class="token number">8</span>
<span class="token punctuation">[</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token comment" spellcheck="true"># Creating arrays with column major data storage order:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> arr<span class="token punctuation">.</span>as_column_major_storage<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
copied an array using copy_ND_array<span class="token punctuation">:</span> size<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> elsize<span class="token operator">=</span><span class="token number">4</span>
<span class="token operator">>></span><span class="token operator">></span> arr<span class="token punctuation">.</span>has_column_major_storage<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> s
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> arr<span class="token punctuation">.</span>as_column_major_storage<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token keyword">is</span> s    <span class="token comment" spellcheck="true"># an array with column major storage order </span>
               <span class="token comment" spellcheck="true"># is returned immediately</span>
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="回调参数"><a href="#回调参数" class="headerlink" title="回调参数"></a>回调参数</h2><p>F2PY支持从Fortran或C代码调用Python函数。</p>
<p>考虑以下Fortran 77代码：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> CALLBACK<span class="token punctuation">.</span>F
      SUBROUTINE FOO<span class="token punctuation">(</span>FUN<span class="token punctuation">,</span>R<span class="token punctuation">)</span>
      EXTERNAL FUN
      INTEGER I
      REAL<span class="token operator">*</span><span class="token number">8</span> R
Cf2py intent<span class="token punctuation">(</span>out<span class="token punctuation">)</span> r
      R <span class="token operator">=</span> <span class="token number">0D0</span>
      DO I<span class="token operator">=</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span>
         R <span class="token operator">=</span> R <span class="token operator">+</span> FUN<span class="token punctuation">(</span>I<span class="token punctuation">)</span>
      ENDDO
      END
C END OF FILE CALLBACK<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m callback callback.f</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> callback
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> callback<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>__doc__
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  r <span class="token operator">=</span> foo<span class="token punctuation">(</span>fun<span class="token punctuation">,</span><span class="token punctuation">[</span>fun_extra_args<span class="token punctuation">]</span><span class="token punctuation">)</span>
Required arguments<span class="token punctuation">:</span>
  fun <span class="token punctuation">:</span> call<span class="token operator">-</span>back function
Optional arguments<span class="token punctuation">:</span>
  fun_extra_args <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> input tuple
Return objects<span class="token punctuation">:</span>
  r <span class="token punctuation">:</span> float
Call<span class="token operator">-</span>back functions<span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> r
  Required arguments<span class="token punctuation">:</span>
    i <span class="token punctuation">:</span> input int
  Return objects<span class="token punctuation">:</span>
    r <span class="token punctuation">:</span> float

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> i<span class="token operator">*</span>i
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> callback<span class="token punctuation">.</span>foo<span class="token punctuation">(</span>f<span class="token punctuation">)</span>     
<span class="token number">110.0</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> callback<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token keyword">lambda</span> i<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">11.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的示例中，F2PY能够准确地猜测回叫函数的签名。但是，有时F2PY无法按照人们的意愿建立签名，然后必须手动修改签名文件中的回调函数的签名。即，签名文件可以包含特殊模块（这些模块的名称包含子串<code>__user__</code>），其收集回调函数的各种签名。例程签名中的回调参数具有属性<code>external</code>（另请参见<code>intent(callback)</code>属性）。要在<code>__user__</code>模块块中关联回调参数及其签名，请使用<code>use</code>如下所示的语句。回调参数的相同签名可以在不同的例程签名中引用。</p>
<p>我们使用与前面示例相同的Fortran 77代码，但现在我们假装F2PY无法正确猜测回调参数的签名。首先，我们<code>callback2.pyf</code>使用F2PY 创建一个初始签名文件：</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">-</span>m callback2 <span class="token operator">-</span>h callback2<span class="token punctuation">.</span>pyf callback<span class="token punctuation">.</span>f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后按如下方式修改它</p>
<pre class="line-numbers language-python"><code class="language-python">!    <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> f90 <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>
python module __user__routines 
    interface
        function fun<span class="token punctuation">(</span>i<span class="token punctuation">)</span> result <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            integer <span class="token punctuation">:</span><span class="token punctuation">:</span> i
            real<span class="token operator">*</span><span class="token number">8</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> r
        end function fun
    end interface
end python module __user__routines

python module callback2
    interface
        subroutine foo<span class="token punctuation">(</span>f<span class="token punctuation">,</span>r<span class="token punctuation">)</span>
            use __user__routines<span class="token punctuation">,</span> f<span class="token operator">=</span><span class="token operator">></span>fun
            external f
            real<span class="token operator">*</span><span class="token number">8</span> intent<span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> r
        end subroutine foo
    end interface 
end python module callback2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，使用构建扩展模块。<code>f2py -c callback2.pyf callback.f</code></p>
<p>示例Python会话与前面的示例相同，只是参数名称会有所不同。</p>
<p>有时，Fortran程序包可能要求用户提供程序包将使用的例程。F2PY可以构造这种例程的接口，以便可以从Fortran调用Python函数。</p>
<p>考虑以下Fortran 77子例程，它接受一个数组并将一个函数<code>func</code>应用于其元素。</p>
<pre class="line-numbers language-python"><code class="language-python">subroutine calculate<span class="token punctuation">(</span>x<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
cf2py intent<span class="token punctuation">(</span>callback<span class="token punctuation">)</span> func
      external func
c     The following lines define the signature of func <span class="token keyword">for</span> F2PY<span class="token punctuation">:</span>
cf2py real<span class="token operator">*</span><span class="token number">8</span> y
cf2py y <span class="token operator">=</span> func<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
c
cf2py intent<span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">,</span>out<span class="token punctuation">,</span>copy<span class="token punctuation">)</span> x
      integer n<span class="token punctuation">,</span>i
      real<span class="token operator">*</span><span class="token number">8</span> x<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
      do i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>n
         x<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> func<span class="token punctuation">(</span>x<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
      end do
      end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>预计功能<code>func</code>已在外部定义。为了使用Python函数<code>func</code>，它必须具有一个属性<code>intent(callback)</code>（必须在<code>external</code>语句之前指定）。</p>
<p>最后，使用构建扩展模块 <code>f2py -c -m foo calculate.f</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> foo
<span class="token operator">>></span><span class="token operator">></span> foo<span class="token punctuation">.</span>calculate<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">*</span>x<span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">9</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">16</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> math
<span class="token operator">>></span><span class="token operator">></span> foo<span class="token punctuation">.</span>calculate<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span>        <span class="token punctuation">,</span>   <span class="token number">2.71828175</span><span class="token punctuation">,</span>   <span class="token number">7.38905621</span><span class="token punctuation">,</span>  <span class="token number">20.08553696</span><span class="token punctuation">,</span>  <span class="token number">54.59814835</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数作为参数包含在对Fortran子例程的python函数调用中，即使它 <em>不在</em> Fortran子例程参数列表中。“外部”是指由f2py生成的C函数，而不是python函数本身。必须将python函数提供给C函数。</p>
<p>回调函数也可以在模块中明确设置。然后，没有必要将参数列表中的函数传递给Fortran函数。如果调用python回调函数的Fortran函数本身由另一个Fortran函数调用，则可能需要这样做。</p>
<p>考虑以下Fortran 77子例程：</p>
<pre class="line-numbers language-python"><code class="language-python">subroutine f1<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"in f1, calling f2 twice.."</span>
         call f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
         call f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span>
      end

      subroutine f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
cf2py    intent<span class="token punctuation">(</span>callback<span class="token punctuation">,</span> hide<span class="token punctuation">)</span> fpy
         external fpy
         <span class="token keyword">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"in f2, calling f2py.."</span>
         call fpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span>
      end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m pfromf extcallback.f</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> pfromf
<span class="token operator">>></span><span class="token operator">></span> pfromf<span class="token punctuation">.</span>f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> ?
pfromf<span class="token punctuation">.</span>error<span class="token punctuation">:</span> Callback fpy <span class="token operator">not</span> defined <span class="token punctuation">(</span><span class="token keyword">as</span> an argument <span class="token operator">or</span> module pfromf attribute<span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span> <span class="token string">"python f"</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> pfromf<span class="token punctuation">.</span>fpy <span class="token operator">=</span> f
<span class="token operator">>></span><span class="token operator">></span> pfromf<span class="token punctuation">.</span>f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">in</span> f2<span class="token punctuation">,</span> calling f2py<span class="token punctuation">.</span><span class="token punctuation">.</span>
python f
<span class="token operator">>></span><span class="token operator">></span> pfromf<span class="token punctuation">.</span>f1<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">in</span> f1<span class="token punctuation">,</span> calling f2 twice<span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">in</span> f2<span class="token punctuation">,</span> calling f2py<span class="token punctuation">.</span><span class="token punctuation">.</span>
python f
 <span class="token keyword">in</span> f2<span class="token punctuation">,</span> calling f2py<span class="token punctuation">.</span><span class="token punctuation">.</span>
python f
<span class="token operator">>></span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="解决回调函数的参数"><a href="#解决回调函数的参数" class="headerlink" title="解决回调函数的参数"></a>解决回调函数的参数</h3><p>F2PY生成的接口在回调参数方面非常灵活。对于每个回调参数<code>_extra_args</code>，F2PY引入了另一个可选参数。此参数可用于将额外参数传递给用户提供的回调参数。</p>
<p>如果F2PY生成的包装函数需要以下回调参数：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span>a_1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>a_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">return</span> x_1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>x_k<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>但是以下Python函数</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gun</span><span class="token punctuation">(</span>b_1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>b_m<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">return</span> y_1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>y_l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>由用户提供，此外，</p>
<pre class="line-numbers language-python"><code class="language-python">fun_extra_args <span class="token operator">=</span> <span class="token punctuation">(</span>e_1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>e_p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果使用Fortran或C函数调用回调参数，则应用以下规则<code>gun</code>：</p>
<ul>
<li>如果那时被调用，这里 。<code>p == 0</code>gun(a_1, …, a_q)<code>q = min(m, n)</code></li>
<li>如果那时被召唤。<code>n + p &lt;= m</code>gun(a_1, …, a_n, e_1, …, e_p)``</li>
<li>如果那时被调用，这里 。<code>p &lt;= m &lt; n + p</code>gun(a_1, …, a_q, e_1, …, e_p)<code>q=m-p</code></li>
<li>如果那时被召唤。<code>p &gt; m</code>gun(e_1, …, e_m)``</li>
<li>如果小于所需参数的数量， 则引发异常。<code>n + p</code>gun``</li>
</ul>
<p>该函数<code>gun</code>可以将任意数量的对象作为元组返回。然后应用以下规则：</p>
<ul>
<li>如果，则忽略。<code>k &lt; l</code>y_{k + 1}, …, y_l``</li>
<li>如果，那么只设置。<code>k &gt; l</code>x_1, …, x_l``</li>
</ul>
<h2 id="常用块"><a href="#常用块" class="headerlink" title="常用块"></a>常用块</h2><p>F2PY <code>common</code>为例程签名块中定义的块生成包装器。所有与当前扩展模块链接的Fortran代码都可以看到公共块，但不能看到其他扩展模块（这种限制是由于Python导入共享库的原因）。在Python中，<code>common</code>块的F2PY包装器<code>fortran</code>是具有与公共块的数据成员相关的（动态）属性的类型对象。访问时，这些属性作为NumPy数组对象（多维数组是Fortran连续）返回，这些对象直接链接到公共块中的数据成员。可以通过直接赋值或通过对相应数组对象的就地更改来更改数据成员。</p>
<p>考虑以下Fortran 77代码：</p>
<pre class="line-numbers language-python"><code class="language-python">C FILE<span class="token punctuation">:</span> COMMON<span class="token punctuation">.</span>F
      SUBROUTINE FOO
      INTEGER I<span class="token punctuation">,</span>X
      REAL A
      COMMON <span class="token operator">/</span>DATA<span class="token operator">/</span> I<span class="token punctuation">,</span>X<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"I="</span><span class="token punctuation">,</span>I
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"X=["</span><span class="token punctuation">,</span>X<span class="token punctuation">,</span><span class="token string">"]"</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"A=["</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"["</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"]"</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"["</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"]"</span>
      PRINT<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"]"</span>
      END
C END OF COMMON<span class="token punctuation">.</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m common common.f</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> common
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>__doc__
i <span class="token operator">-</span> <span class="token string">'i'</span><span class="token operator">-</span>scalar
x <span class="token operator">-</span> <span class="token string">'i'</span><span class="token operator">-</span>array<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
a <span class="token operator">-</span> <span class="token string">'f'</span><span class="token operator">-</span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> 
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 I<span class="token operator">=</span> <span class="token number">5</span>
 X<span class="token operator">=</span><span class="token punctuation">[</span> <span class="token number">0</span> <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span>
 A<span class="token operator">=</span><span class="token punctuation">[</span>
 <span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">45</span>
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 I<span class="token operator">=</span> <span class="token number">5</span>
 X<span class="token operator">=</span><span class="token punctuation">[</span> <span class="token number">0</span> <span class="token number">2</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span>
 A<span class="token operator">=</span><span class="token punctuation">[</span>
 <span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> common<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a                 <span class="token comment" spellcheck="true"># a is Fortran-contiguous</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">45</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Fortran-90模块数据"><a href="#Fortran-90模块数据" class="headerlink" title="Fortran 90模块数据"></a>Fortran 90模块数据</h2><p>Fortran 90模块数据的F2PY接口类似于Fortran 77公共块。</p>
<p>考虑以下Fortran 90代码：</p>
<pre class="line-numbers language-python"><code class="language-python">module mod
  integer i
  integer <span class="token punctuation">:</span><span class="token punctuation">:</span> x<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  real<span class="token punctuation">,</span> dimension<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> a
  real<span class="token punctuation">,</span> allocatable<span class="token punctuation">,</span> dimension<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> b 
contains
  subroutine foo
    integer k
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"i="</span><span class="token punctuation">,</span>i
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"x=["</span><span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token string">"]"</span>
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"a=["</span>
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"["</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"]"</span>
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"["</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span>a<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"]"</span>
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"]"</span>
    <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"Setting a(1,2)=a(1,2)+3"</span>
    a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3</span>
  end subroutine foo
end module mod<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m moddata moddata.f90</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> moddata
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>__doc__
i <span class="token operator">-</span> <span class="token string">'i'</span><span class="token operator">-</span>scalar
x <span class="token operator">-</span> <span class="token string">'i'</span><span class="token operator">-</span>array<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
a <span class="token operator">-</span> <span class="token string">'f'</span><span class="token operator">-</span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  foo<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token operator">>></span><span class="token operator">></span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">5</span>  
<span class="token operator">>></span><span class="token operator">></span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                
 i<span class="token operator">=</span>           <span class="token number">5</span>
 x<span class="token operator">=</span><span class="token punctuation">[</span>           <span class="token number">1</span>           <span class="token number">2</span>           <span class="token number">0</span>           <span class="token number">0</span> <span class="token punctuation">]</span>
 a<span class="token operator">=</span><span class="token punctuation">[</span>
 <span class="token punctuation">[</span>   <span class="token number">1.000000</span>     <span class="token punctuation">,</span>   <span class="token number">2.000000</span>     <span class="token punctuation">,</span>   <span class="token number">3.000000</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span>   <span class="token number">4.000000</span>     <span class="token punctuation">,</span>   <span class="token number">5.000000</span>     <span class="token punctuation">,</span>   <span class="token number">6.000000</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">]</span>
 Setting a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">=</span>a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> moddata<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>a               <span class="token comment" spellcheck="true"># a is Fortran-contiguous</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="可分配数组"><a href="#可分配数组" class="headerlink" title="可分配数组"></a>可分配数组</h3><p>F2PY对Fortran 90模块可分配阵列提供基本支持。</p>
<p>考虑以下Fortran 90代码：</p>
<pre class="line-numbers language-python"><code class="language-python">module mod
  real<span class="token punctuation">,</span> allocatable<span class="token punctuation">,</span> dimension<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> b 
contains
  subroutine foo
    integer k
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allocated<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> then
       <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"b=["</span>
       do k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span>size<span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       enddo
       <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"]"</span>
    <span class="token keyword">else</span>
       <span class="token keyword">print</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">"b is not allocated"</span>
    endif
  end subroutine foo
end module mod<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用它包装。<code>f2py -c -m allocarr allocarr.f90</code></p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> allocarr 
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>__doc__
b <span class="token operator">-</span> <span class="token string">'f'</span><span class="token operator">-</span>array<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">not</span> allocated
foo <span class="token operator">-</span> Function signature<span class="token punctuation">:</span>
  foo<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>  
 b <span class="token keyword">is</span> <span class="token operator">not</span> allocated
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>         <span class="token comment" spellcheck="true"># allocate/initialize b</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 b<span class="token operator">=</span><span class="token punctuation">[</span>
   <span class="token number">1.000000</span>       <span class="token number">2.000000</span>       <span class="token number">3.000000</span>    
   <span class="token number">4.000000</span>       <span class="token number">5.000000</span>       <span class="token number">6.000000</span>    
 <span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>b                             <span class="token comment" spellcheck="true"># b is Fortran-contiguous</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># reallocate/initialize b</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 b<span class="token operator">=</span><span class="token punctuation">[</span>
   <span class="token number">1.000000</span>       <span class="token number">2.000000</span>       <span class="token number">3.000000</span>    
   <span class="token number">4.000000</span>       <span class="token number">5.000000</span>       <span class="token number">6.000000</span>    
   <span class="token number">7.000000</span>       <span class="token number">8.000000</span>       <span class="token number">9.000000</span>    
 <span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>b <span class="token operator">=</span> None                      <span class="token comment" spellcheck="true"># deallocate array</span>
<span class="token operator">>></span><span class="token operator">></span> allocarr<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
 b <span class="token keyword">is</span> <span class="token operator">not</span> allocated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="使用-F2PY"><a href="#使用-F2PY" class="headerlink" title="使用 F2PY"></a>使用 F2PY</h1><p>F2PY既可以用作命令行工具 <code>f2py</code>，也可以用作Python模块 <code>numpy.f2py</code>。 虽然我们尝试将命令行工具安装为numpy设置的一部分，但是像Windows这样的某些平台却难以将可执行文件可靠地放在 <code>PATH</code> 上。 我们将在本文档中引用 <code>f2py</code>，但您可能必须将其作为模块运行：</p>
<pre class="line-numbers language-text"><code class="language-text">python -m numpy.f2py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果你运行没有参数的 <code>f2py</code>，并且最后的行 <code>numpy Version</code> 与从 <code>python -m numpy.f2py</code> 打印的NumPy版本匹配， 那么你可以使用更短的版本。如果没有，或者如果你不能运行 <code>f2py</code>，你应该用更长的版本替换所有对 <code>f2py</code> 的调用。</p>
<h2 id="f2py-命令"><a href="#f2py-命令" class="headerlink" title="f2py 命令"></a><code>f2py</code> 命令</h2><p>当用作命令行工具时，<code>f2py</code> 有三种主要模式，区别在于使用 <code>-c</code> 和 <code>-h</code> 开关：要扫描Fortran源并生成签名文件，请使用：</p>
<ol>
<li><p>要扫描Fortran源并生成签名文件，请使用</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">-</span>h <span class="token operator">&lt;</span>filename<span class="token punctuation">.</span>pyf<span class="token operator">></span> <span class="token operator">&lt;</span>options<span class="token operator">></span> <span class="token operator">&lt;</span>fortran files<span class="token operator">></span>   \
  <span class="token punctuation">[</span><span class="token punctuation">[</span> only<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span>                \
  <span class="token punctuation">[</span> skip<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            \
  <span class="token punctuation">[</span><span class="token operator">&lt;</span>fortran files<span class="token operator">></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，Fortran源文件可以包含许多例程，并且不一定需要从Python中使用所有例程。 因此，您可以指定应该包装哪些例程（ 在 <code>only: .. :</code> 部分）或者应忽略哪些例程F2PY（在 <code>skip: .. :</code> 部分）。</p>
<p>如果将 <code>&lt;filename.pyf&gt;</code> 指定为 <code>stdout</code>，则签名将发送到标准输出而不是文件。</p>
<p>在其他选项（见下文）中，可以在此模式中使用以下选项：</p>
<p><code>--overwrite-signature</code></p>
<p>覆盖现有签名文件。</p>
</li>
<li><p>要构建扩展模块，请使用：</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">&lt;</span>options<span class="token operator">></span> <span class="token operator">&lt;</span>fortran files<span class="token operator">></span>          \
  <span class="token punctuation">[</span><span class="token punctuation">[</span> only<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span>     \
  <span class="token punctuation">[</span> skip<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> \
  <span class="token punctuation">[</span><span class="token operator">&lt;</span>fortran files<span class="token operator">></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造的扩展模块作为 <code>&lt;modulename&gt;module.c</code> 保存到当前目录。</p>
<p>这里 <code>&lt;fortran files&gt;</code> 也可能包含签名文件。在其他选项（见下文）中，可以在此模式中使用以下选项：</p>
<ul>
<li><p><code>--debug-capi</code></p>
<p>将调试挂钩添加到扩展模块。使用此扩展模块时，有关包装器的各种信息将打印到标准输出，例如，变量值，所采取的步骤等。</p>
</li>
<li><p><code>-include'&lt;includefile&gt;'</code></p>
<p>将CPP <code>#include</code> 语句添加到扩展模块源。 <code>&lt;includefile&gt;</code> 应以下列形式之一给出：</p>
<pre class="line-numbers language-text"><code class="language-text">"filename.ext"
<filename.ext><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>include语句就在包装函数之前插入。此功能允许在F2PY生成的包装器中使用任意C函数（在 <code>&lt;includefile&gt;</code> 中定义）。</p>
<p>不推荐使用此选项。使用<code>usercode</code>语句直接在签名文件中指定C代码片段。</p>
</li>
<li><p><code>--[no-]wrap-functions</code></p>
<p>为 Fortran 函数创建 Fortran子例程包装器。<code>--wrap-functions</code> 是默认的，因为它确保了最大的可移植性和编译器独立性。</p>
</li>
<li><p><code>--include-paths &lt;path1&gt;:&lt;path2&gt;:..</code></p>
<p>搜索包含给定目录中的文件。</p>
</li>
<li><p><code>--help-link [&lt;list of resources names&gt;]</code> 列出 numpy_distutils/system_info.py 找到的系统资源。 例如，尝试 <code>f2py --help-link lapack_opt</code>。</p>
</li>
</ul>
</li>
<li><p>要构建扩展模块，请使用</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">-</span>c <span class="token operator">&lt;</span>options<span class="token operator">></span> <span class="token operator">&lt;</span>fortran files<span class="token operator">></span>       \
  <span class="token punctuation">[</span><span class="token punctuation">[</span> only<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span>     \
  <span class="token punctuation">[</span> skip<span class="token punctuation">:</span> <span class="token operator">&lt;</span>fortran functions<span class="token operator">></span>  <span class="token punctuation">:</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> \
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>fortran<span class="token operator">/</span>c source files<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span><span class="token punctuation">.</span>o<span class="token punctuation">,</span> <span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token punctuation">.</span>so files<span class="token operator">></span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果 <code>&lt;fortran files&gt;</code> 包含签名文件，则构建扩展模块的源，编译所有Fortran和C源，最后将所有对象和库文件链接到扩展模块 <code>&lt;modulename&gt;</code>.so，保存到 当前目录。</p>
<p>如果 <code>&lt;fortran files&gt;</code> 不包含签名文件，则通过扫描所有Fortran源代码以构建常规签名来构建扩展模块。</p>
<p>在以前模式中描述的其他选项（参见下文）和选项中，可以在此模式中使用以下选项：</p>
<ul>
<li><p><code>--help-fcompiler</code></p>
<p>列出可用的Fortran编译器。</p>
</li>
<li><p><code>--help-compiler [depreciated]</code></p>
<p>列出可用的Fortran编译器。</p>
</li>
<li><p><code>--fcompiler=&lt;Vendor&gt;</code></p>
<p>按供应商指定Fortran编译器类型。</p>
</li>
<li><p><code>--f77exec=&lt;path&gt;</code></p>
<p>指定F77编译器的路径。</p>
</li>
<li><p><code>--fcompiler-exec=&lt;path&gt; [depreciated]</code></p>
<p>指定F77编译器的路径。</p>
</li>
<li><p><code>--f90exec=&lt;path&gt;</code></p>
<p>指定F90编译器的路径。</p>
</li>
<li><p><code>--f90compiler-exec=&lt;path&gt; [depreciated]</code></p>
<p>指定F90编译器的路径。</p>
</li>
<li><p><code>--f77flags=&lt;string&gt;</code></p>
<p>指定F77编译器标志。</p>
</li>
<li><p><code>--f90flags=&lt;string&gt;</code></p>
<p>指定F90编译器标志。</p>
</li>
<li><p><code>--opt=&lt;string&gt;</code></p>
<p>指定优化标志。</p>
</li>
<li><p><code>--arch=&lt;string&gt;</code></p>
<p>指定架构特定的优化标志。</p>
</li>
<li><p><code>--noopt</code></p>
<p>无需优化即可编译。</p>
</li>
<li><p><code>--noarch</code></p>
<p>编译时不依赖于arch的优化。</p>
</li>
<li><p><code>--debug</code></p>
<p>编译调试信息。</p>
</li>
<li><p><code>-l&lt;libname&gt;</code></p>
<p>链接时使用库<code>&lt;libname&gt;</code>。</p>
</li>
<li><p><code>-D&lt;macro&gt;[=&lt;defn=1&gt;]</code></p>
<p>将宏 <code>&lt;macro&gt;</code> 定义为 <code>&lt;defn&gt;</code> 。</p>
</li>
<li><p><code>-U&lt;macro&gt;</code></p>
<p>定义宏<code>&lt;macro&gt;</code>。</p>
</li>
<li><p><code>-I&lt;dir&gt;</code></p>
<p>将目录 <code>&lt;dir&gt;</code> 添加到搜索包含文件的目录列表中。</p>
</li>
<li><p><code>-L&lt;dir&gt;</code></p>
<p>将目录 <code>&lt;dir&gt;</code> 添加到要搜索 -l 的目录列表中。</p>
</li>
<li><p><code>link-&lt;resource&gt;</code></p>
<p>使用 numpy_distutils/system_info.py 定义的 <code>&lt;resource&gt;</code> 链接扩展模块。例如。要链接优化的LAPACK库（MacOSX上的vecLib，其他地方的ATLAS），请使用 –link-lapack_opt。 另请参阅 –help-link 开关。</p>
</li>
</ul>
<p>构建扩展模块时，非gcc Fortran编译器可能需要以下宏的组合：</p>
<pre class="line-numbers language-text"><code class="language-text">-DPREPEND_FORTRAN
-DNO_APPEND_FORTRAN
-DUPPERCASE_FORTRAN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>要测试 F2PY 生成的接口的性能，请使用 -DF2PY_REPORT_ATEXIT。 然后在Python的出口处打印出各种计时的报告。 此功能可能无法在所有平台上运行，目前仅支持Linux平台。</p>
<p>要查看F2PY生成的接口是否执行数组参数的副本，请使用 <code>-DF2PY_REPORT_ON_ARRAY_COPY=&lt;int&gt;</code>。 当数组参数的大小大于 <code>&lt;int&gt;</code> 时，会将有关应对的消息发送到stderr。</p>
</li>
</ol>
<p>其他选择：</p>
<ul>
<li><p><code>-m &lt;modulename&gt;</code></p>
<p>扩展模块的名称。默认为无标题。如果使用签名文件（*.pyf），请不要使用此选项。</p>
</li>
<li><p><code>--[no-]lower</code></p>
<p>不要降低 <code>&lt;fortran files&gt;</code> 中的大小写。 默认情况下，<code>--lower</code> 假定为 <code>-h</code> 开关， <code>--no-lower</code> 假定为 -h 开关。</p>
</li>
<li><p><code>--build-dir &lt;dirname&gt;</code></p>
<p>所有F2PY生成的文件都在 <code>&lt;dirname&gt;</code> 中创建。默认值为 <code>tempfile.mkdtemp()</code> 。</p>
</li>
<li><p><code>--quiet</code></p>
<p>安静地跑（不打印日志）。</p>
</li>
<li><p><code>--verbose</code></p>
<p>额外冗长的跑（打印大量日志）。</p>
</li>
<li><p><code>-v</code></p>
<p>打印f2py版本ID并退出。</p>
</li>
</ul>
<p>在没有任何选项的情况下执行 <code>f2py</code> 以获取可用选项的最新列表。</p>
<h2 id="Python-模块-numpy-f2py"><a href="#Python-模块-numpy-f2py" class="headerlink" title="Python 模块 numpy.f2py"></a>Python 模块 <code>numpy.f2py</code></h2><p>警告</p>
<p><code>f2py</code> 模块的当前Python接口尚未成熟，将来可能会发生变化。</p>
<p>Fortran到Python接口生成器。</p>
<ul>
<li><p><code>numpy.f2py</code>.run_main( <em>comline_list</em> )<a href="https://github.com/numpy/numpy/blob/master/numpy/f2py/f2py2e.py#L398-L461" target="_blank" rel="noopener">[点击查看源代码]</a></p>
<p>相当于运行：</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">&lt;</span>args<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中 <code>=string.join(,' ')</code>，但在Python中。除非使用 <code>-h</code>，否则此函数将返回一个字典，其中包含有关生成的模块及其对源文件的依赖关系的信息。例如，可以从Python执行命令 <code>f2py -m scalar scalar.f</code> ，如下所示：</p>
<p>您无法使用此功能构建扩展模块，即不允许使用 <code>-c</code>。请改用 <code>compile</code> 命令。</p>
<p><strong>示例：</strong></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy<span class="token punctuation">.</span>f2py
<span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> numpy<span class="token punctuation">.</span>f2py<span class="token punctuation">.</span>run_main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'-m'</span><span class="token punctuation">,</span><span class="token string">'scalar'</span><span class="token punctuation">,</span><span class="token string">'doc/source/f2py/scalar.f'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Reading fortran codes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Reading file <span class="token string">'doc/source/f2py/scalar.f'</span> <span class="token punctuation">(</span>format<span class="token punctuation">:</span>fix<span class="token punctuation">,</span>strict<span class="token punctuation">)</span>
Post<span class="token operator">-</span>processing<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Block<span class="token punctuation">:</span> scalar
                        Block<span class="token punctuation">:</span> FOO
Building modules<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Building module <span class="token string">"scalar"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Wrote C<span class="token operator">/</span>API module <span class="token string">"scalar"</span> to file <span class="token string">"./scalarmodule.c"</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'scalar'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'h'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'/home/users/pearu/src_cvs/f2py/src/fortranobject.h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'csrc'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./scalarmodule.c'</span><span class="token punctuation">,</span> 
                  <span class="token string">'/home/users/pearu/src_cvs/f2py/src/fortranobject.c'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>numpy.f2py</code>.compile( <em>source</em> , <em>modulename=’untitled’</em> , <em>extra_args=’’</em> , <em>verbose=True</em> , <em>source_fn=None</em> , <em>extension=’.f’</em> )<a href="https://github.com/numpy/numpy/blob/master/numpy/f2py/__init__.py#L23-L117" target="_blank" rel="noopener">[点击查看源代码]</a></p>
<p>使用f2py从Fortran 77源字符串构建扩展模块。</p>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>source : str or bytes</td>
<td>要编译的Fortran源模块/子程序。<em>在版本1.16.0中更改：</em> 接受str以及字节。</td>
</tr>
<tr>
<td>modulename : str, optional</td>
<td>已编译的python模块的名称</td>
</tr>
<tr>
<td>extra_args : str or list, optional</td>
<td>传递给f2py的其他参数。<em>版本1.16.0中已更改：</em> 也可能提供args列表。</td>
</tr>
<tr>
<td>verbose : bool, optional</td>
<td>将f2py输出打印到屏幕</td>
</tr>
<tr>
<td>source_fn : str, optional</td>
<td>写入fortran源的文件的名称。 默认设置是使用扩展参数提供的扩展名的临时文件。</td>
</tr>
<tr>
<td>extension : {‘.f’, ‘.f90’}, optional</td>
<td>如果未提供source_fn，则为文件扩展名。扩展名告诉我使用了哪个fortran标准。默认值为f，表示F77标准。 <em>版本1.11.0中的新功能。</em></td>
</tr>
</tbody></table>
<p><strong>返回值：</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>result : int</td>
<td>0 表示成功</td>
</tr>
</tbody></table>
<p><strong>示例：</strong></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> numpy<span class="token punctuation">.</span>f2py
<span class="token operator">>></span><span class="token operator">></span> fsource <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
...       subroutine foo
...       print*, "Hello world!"
...       end 
... '''</span>
<span class="token operator">>></span><span class="token operator">></span> numpy<span class="token punctuation">.</span>f2py<span class="token punctuation">.</span>compile<span class="token punctuation">(</span>fsource<span class="token punctuation">,</span> modulename<span class="token operator">=</span><span class="token string">'hello'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">0</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> hello
<span class="token operator">>></span><span class="token operator">></span> hello<span class="token punctuation">.</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
Hello world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h1 id="使用-numpy-distutils-模块"><a href="#使用-numpy-distutils-模块" class="headerlink" title="使用 numpy.distutils 模块"></a>使用 <code>numpy.distutils</code> 模块</h1><p><a href="https://numpy.org/devdocs/reference/distutils.html#module-numpy.distutils" target="_blank" rel="noopener"><code>numpy.distutils</code></a> 是NumPy扩展标准Python distutils的一部分， 用于处理Fortran源代码和F2PY签名文件， 例如编译Fortran源代码，调用F2PY构造扩展模块等。</p>
<p><strong>示例</strong></p>
<p>请思考下面的<code>setup 文件</code>：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> division<span class="token punctuation">,</span> absolute_import<span class="token punctuation">,</span> print_function

<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> Extension

ext1 <span class="token operator">=</span> Extension<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'scalar'</span><span class="token punctuation">,</span>
                 sources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'scalar.f'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ext2 <span class="token operator">=</span> Extension<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'fib2'</span><span class="token punctuation">,</span>
                 sources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'fib2.pyf'</span><span class="token punctuation">,</span> <span class="token string">'fib1.f'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> numpy<span class="token punctuation">.</span>distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup
    setup<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'f2py_example'</span><span class="token punctuation">,</span>
          description       <span class="token operator">=</span> <span class="token string">"F2PY Users Guide examples"</span><span class="token punctuation">,</span>
          author            <span class="token operator">=</span> <span class="token string">"Pearu Peterson"</span><span class="token punctuation">,</span>
          author_email      <span class="token operator">=</span> <span class="token string">"pearu@cens.ioc.ee"</span><span class="token punctuation">,</span>
          ext_modules <span class="token operator">=</span> <span class="token punctuation">[</span>ext1<span class="token punctuation">,</span> ext2<span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># End of setup_example.py</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行</p>
<pre class="line-numbers language-python"><code class="language-python">python setup_example<span class="token punctuation">.</span>py build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将构建两个扩展模块 <code>标量</code> 和 <code>fib2</code> 到构建目录。</p>
<p><a href="https://numpy.org/devdocs/reference/distutils.html#module-numpy.distutils" target="_blank" rel="noopener"><code>numpy.distutils</code></a> 使用以下功能扩展 <code>distutils</code>：</p>
<ul>
<li><p><code>扩展</code> 类参数 <code>源</code> 可能包含Fortran源文件。此外，列表 <code>源</code> 最多可包含一个F2PY签名文件，然后扩展模块的名称必须与签名文件中使用的<code>&lt;modulename&gt;</code> 匹配。 假设F2PY签名文件恰好包含一个 <code>python模块</code> 块。</p>
<p>如果 <code>源</code> 文件不包含签名文件，则使用 F2PY 扫描Fortran 源文件中的例程签名，以构造 Fortran 代码的包装器。</p>
<p>可以使用 <code>扩展</code> 类参数 <code>f2py_options</code> 给出 F2py 进程的其他选项。</p>
</li>
<li><p>定义了以下新的 <code>distutils</code> 命令：</p>
<p><code>build_src</code></p>
<p>构建Fortran包装器扩展模块，以及其他许多事情。</p>
<p><code>config_fc</code></p>
<p>更改Fortran编译器选项</p>
<p>以及 <code>build_ext</code> 和 <code>build_clib</code> 命令都得到了增强，以支持Fortran源代码。</p>
<p>运行</p>
<pre class="line-numbers language-python"><code class="language-python">python <span class="token operator">&lt;</span>setup<span class="token punctuation">.</span>py file<span class="token operator">></span> config_fc build_src build_ext <span class="token operator">-</span><span class="token operator">-</span>help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>要查看这些命令的可用选项，请执行以下操作。</p>
</li>
<li><p>在构建包含 Fortran 源代码的 Python 包时，可以使用 <code>build_ext</code> 命令选项 <code>--fcompiler=&lt;Vendor&gt;.</code> 来选择不同的Fortran编译器。此处<code>&lt;Vendor&gt;</code> 可以是以下名称之一：</p>
<pre class="line-numbers language-python"><code class="language-python">absoft sun mips intel intelv intele intelev nag compaq compaqv gnu vast pg hpux<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>有关支持的编译器或运行的最新列表，请参见 <code>numpy_distutils/fCompiler.py</code>。</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">-</span>c <span class="token operator">-</span><span class="token operator">-</span>help<span class="token operator">-</span>fcompiler<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h1 id="高级F2PY用法"><a href="#高级F2PY用法" class="headerlink" title="高级F2PY用法"></a>高级F2PY用法</h1><h2 id="将自编写函数添加到F2PY生成的模块"><a href="#将自编写函数添加到F2PY生成的模块" class="headerlink" title="将自编写函数添加到F2PY生成的模块"></a>将自编写函数添加到F2PY生成的模块</h2><p>可以使用 <code>usercode</code> 和 <code>pymethoddef</code> 语句在签名文件中定义自编的Python C / API函数（它们必须在 <code>python模块</code> 块中使用）。 例如，以下签名文件<code>spam.pyf</code>。</p>
<pre class="line-numbers language-python"><code class="language-python">!    <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> f90 <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>
python module spam
    usercode <span class="token triple-quoted-string string">'''
  static char doc_spam_system[] = "Execute a shell command.";
  static PyObject *spam_system(PyObject *self, PyObject *args)
  {
    char *command;
    int sts;

    if (!PyArg_ParseTuple(args, "s", &amp;command))
        return NULL;
    sts = system(command);
    return Py_BuildValue("i", sts);
  }
    '''</span>
    pymethoddef <span class="token triple-quoted-string string">'''
    {"system",  spam_system, METH_VARARGS, doc_spam_system},
    '''</span>
end python module spam<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>包装C库函数<code>system()</code>：</p>
<pre class="line-numbers language-python"><code class="language-python">f2py <span class="token operator">-</span>c spam<span class="token punctuation">.</span>pyf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> spam
<span class="token operator">>></span><span class="token operator">></span> status <span class="token operator">=</span> spam<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span>
pearu
<span class="token operator">>></span> status <span class="token operator">=</span> spam<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'blah'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">:</span> line <span class="token number">1</span><span class="token punctuation">:</span> blah<span class="token punctuation">:</span> command <span class="token operator">not</span> found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="修改F2PY生成模块的字典"><a href="#修改F2PY生成模块的字典" class="headerlink" title="修改F2PY生成模块的字典"></a>修改F2PY生成模块的字典</h2><p>以下示例说明如何将用户定义的变量添加到F2PY生成的扩展模块。给出以下签名文件：</p>
<pre class="line-numbers language-python"><code class="language-python">!    <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> f90 <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>
python module var
  usercode <span class="token triple-quoted-string string">'''
    int BAR = 5;
  '''</span>
  interface
    usercode <span class="token triple-quoted-string string">'''
      PyDict_SetItemString(d,"BAR",PyInt_FromLong(BAR));
    '''</span>
  end interface
end python module<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将其编译为：<code>f2py -c var.pyf</code></p>
<p>请注意，必须在 <code>interface（接口）</code> 块内定义第二个 <code>usercode</code> 语句，并且通过变量 <code>d</code> 可以获得模块字典（有关其他详细信息，请参阅<code>f2py var.pyf</code> 生成的 <code>varmodule.c</code>）。</p>
<p>在Python中：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> var
<span class="token operator">>></span><span class="token operator">></span> var<span class="token punctuation">.</span>BAR
<span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/Language-Fortran-f2py.html">https://jackhcc.github.io/posts/Language-Fortran-f2py.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/f2py/">
                                    <span class="chip bg-color">f2py</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-08-01T15-55-53',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/matrix-gradient.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/1.jpg" class="responsive-img" alt="Math-矩阵求导计算">
                        
                        <span class="card-title">Math-矩阵求导计算</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            矩阵求导机制
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Basic/" class="post-category">
                                    Basic
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Math/">
                        <span class="chip bg-color">Math</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/Language-Fortran.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/12.jpg" class="responsive-img" alt="Fortran-基础语法详解">
                        
                        <span class="card-title">Fortran-基础语法详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Fortran语言学习手册~
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Language/" class="post-category">
                                    Language
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Fortran/">
                        <span class="chip bg-color">Fortran</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

