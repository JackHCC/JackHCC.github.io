<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF-Misc要点, JackHCC">
    <meta name="description" content="CTF杂项学习要点">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CTF-Misc要点 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF-Misc要点</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MISC/">
                                <span class="chip bg-color">MISC</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    28.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    120 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="信息搜集技术"><a href="#信息搜集技术" class="headerlink" title="信息搜集技术"></a>信息搜集技术</h1><h2 id="网络信息搜集技巧"><a href="#网络信息搜集技巧" class="headerlink" title="网络信息搜集技巧"></a>网络信息搜集技巧</h2><ul>
<li>公开渠道</li>
<li>目标 Web 网页、地理位置、相关组织</li>
<li>组织结构和人员、个人资料、电话、电子邮件</li>
<li>网络配置、安全防护机制的策略和技术细节</li>
<li>通过搜索引擎查找特定安全漏洞或私密信息的方法</li>
<li><a href="https://www.exploit-db.com/google-hacking-database/" target="_blank" rel="noopener">Google Hacking Database</a></li>
<li>科学上网</li>
</ul>
<h2 id="基本搜索技巧"><a href="#基本搜索技巧" class="headerlink" title="基本搜索技巧"></a>基本搜索技巧</h2><ul>
<li>Google 基本搜索与挖掘技巧</li>
<li>保持简单明了的关键词</li>
<li>使用最可能出现在要查找的网页上的字词</li>
<li>尽量简明扼要地描述要查找的内容</li>
<li>选择独特性的描述字词</li>
<li>社会公共信息库查询</li>
<li>个人信息：人口统计局</li>
<li>企业等实体：YellowPage、企业信用信息网</li>
<li>网站、域名、IP：whois 等</li>
</ul>
<h2 id="地图和街景搜索"><a href="#地图和街景搜索" class="headerlink" title="地图和街景搜索"></a>地图和街景搜索</h2><ul>
<li>国外：Google Map、Google Earth、Google Street View</li>
<li>国内：百度地图、卫星地图、街景</li>
<li>从网络世界到物理世界：IP2Location</li>
<li>whois 数据库</li>
<li>GeoIP</li>
<li>IP2Location</li>
<li>纯真数据库（QQ IP 查询）</li>
</ul>
<h1 id="编码分析"><a href="#编码分析" class="headerlink" title="编码分析"></a>编码分析</h1><h2 id="通信领域常用编码"><a href="#通信领域常用编码" class="headerlink" title="通信领域常用编码"></a>通信领域常用编码</h2><h3 id="电话拨号编码"><a href="#电话拨号编码" class="headerlink" title="电话拨号编码"></a>电话拨号编码</h3><p>1-9 分别使用 1-9 个脉冲，0 则表示使用 10 个脉冲。</p>
<h3 id="Morse-编码"><a href="#Morse-编码" class="headerlink" title="Morse 编码"></a>Morse 编码</h3><p>参见 <a href="https://zh.wikipedia.org/wiki/摩尔斯电码" target="_blank" rel="noopener">摩尔斯编码 - 维基百科</a>，对应表如下</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/morse.jpg" alt="摩尔斯电码"></p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>只有 <code>.</code> 和 <code>-</code>；</li>
<li>最多 6 位；</li>
<li>也可以使用 <code>01</code> 串表示。</li>
</ul>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><ul>
<li><a href="http://www.zhongguosou.com/zonghe/moErSiCodeConverter.aspx" target="_blank" rel="noopener">摩尔斯编码在线转换</a></li>
</ul>
<h3 id="敲击码"><a href="#敲击码" class="headerlink" title="敲击码"></a>敲击码</h3><p>敲击码（Tap code）是一种以非常简单的方式对文本信息进行编码的方法。因该编码对信息通过使用一系列的点击声音来编码而命名，敲击码是基于 5 ×5 方格波利比奥斯方阵来实现的，不同点是是用 K 字母被整合到 C 中。</p>
<table>
<thead>
<tr>
<th align="left">Tap Code</th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th align="left">5</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">A</td>
<td align="left">B</td>
<td align="left">C/K</td>
<td align="left">D</td>
<td align="left">E</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">F</td>
<td align="left">G</td>
<td align="left">H</td>
<td align="left">I</td>
<td align="left">J</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">L</td>
<td align="left">M</td>
<td align="left">N</td>
<td align="left">O</td>
<td align="left">P</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">Q</td>
<td align="left">R</td>
<td align="left">S</td>
<td align="left">T</td>
<td align="left">U</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">V</td>
<td align="left">W</td>
<td align="left">X</td>
<td align="left">Y</td>
<td align="left">Z</td>
</tr>
</tbody></table>
<p><img src="/images/loading.gif" data-original="../images/CTF/tapcode.jpg" alt=""></p>
<h3 id="曼彻斯特编码"><a href="#曼彻斯特编码" class="headerlink" title="曼彻斯特编码"></a>曼彻斯特编码</h3><ul>
<li><a href="https://zh.wikipedia.org/wiki/曼彻斯特编码" target="_blank" rel="noopener">曼彻斯特编码 - 维基百科</a></li>
</ul>
<h3 id="格雷编码"><a href="#格雷编码" class="headerlink" title="格雷编码"></a>格雷编码</h3><ul>
<li><a href="https://zh.wikipedia.org/wiki/格雷码" target="_blank" rel="noopener">格雷码 - 维基百科</a></li>
</ul>
<h2 id="计算机相关的编码"><a href="#计算机相关的编码" class="headerlink" title="计算机相关的编码"></a>计算机相关的编码</h2><p>本节介绍一些计算机相关的编码。</p>
<h3 id="字母表编码"><a href="#字母表编码" class="headerlink" title="字母表编码"></a>字母表编码</h3><ul>
<li>A-Z/a-z 对应 1-26 或者 0-25</li>
</ul>
<h3 id="ASCII-编码"><a href="#ASCII-编码" class="headerlink" title="ASCII 编码"></a>ASCII 编码</h3><p><img src="/images/loading.gif" data-original="../images/CTF/ascii.jpg" alt="ascii"></p>
<h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><p>我们一般使用的 ascii 编码的时候采用的都是可见字符，而且主要是如下字符</p>
<ul>
<li>0-9, 48-57</li>
<li>A-Z, 65-90</li>
<li>a-z, 97-122</li>
</ul>
<h4 id="变形"><a href="#变形" class="headerlink" title="变形"></a>变形</h4><h5 id="二进制编码"><a href="#二进制编码" class="headerlink" title="二进制编码"></a>二进制编码</h5><p>将 ascii 码对应的数字换成二进制表示形式。</p>
<ul>
<li>只有 0 和 1</li>
<li>不大于 8 位，一般 7 位也可以，因为可见字符到 127。</li>
<li>其实是另一种 ascii 编码。</li>
</ul>
<h5 id="十六进制编码"><a href="#十六进制编码" class="headerlink" title="十六进制编码"></a>十六进制编码</h5><p>将 ascii 码对应的数字换成十六进制表示形式。</p>
<ul>
<li>A-Z→41-5 A</li>
<li>a-z→61-7 A</li>
</ul>
<h4 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h4><ul>
<li>jpk, ascii to number, number to ascii</li>
<li><a href="http://www.ab126.com/goju/1711.html" target="_blank" rel="noopener">http://www.ab126.com/goju/1711.html</a></li>
</ul>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p><img src="/images/loading.gif" data-original="../images/CTF/ascii-example.png" alt="ascii"></p>
<h5 id="2018-DEFCON-Quals-ghettohackers-Throwback"><a href="#2018-DEFCON-Quals-ghettohackers-Throwback" class="headerlink" title="2018 DEFCON Quals ghettohackers: Throwback"></a>2018 DEFCON Quals ghettohackers: Throwback</h5><p>题目描述如下</p>
<pre><code>Anyo!e!howouldsacrificepo!icyforexecu!!onspeedthink!securityisacomm!ditytop!urintoasy!tem!</code></pre><p>第一直觉应该是我们去补全这些叹号对应的内容，从而得到 flag，但是补全后并不行，那么我们可以把源字符串按照 <code>!</code> 分割，然后字符串长度 1 对应字母 a，长度 2 对应字母 b，以此类推</p>
<pre class="line-numbers language-python"><code class="language-python">ori <span class="token operator">=</span> <span class="token string">'Anyo!e!howouldsacrificepo!icyforexecu!!onspeedthink!securityisacomm!ditytop!urintoasy!tem!'</span>
sp <span class="token operator">=</span> ori<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> repr<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>chr<span class="token punctuation">(</span><span class="token number">97</span> <span class="token operator">+</span> len<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> sp<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>进而可以得到，这里同时需要假设 0 个字符为空格。因为这正好使得原文可读。</p>
<pre><code>dark logic</code></pre><h3 id="Base-编码"><a href="#Base-编码" class="headerlink" title="Base 编码"></a>Base 编码</h3><p>base xx 中的 xx 表示的是采用多少个字符进行编码，比如说 base64 就是采用以下 64 个字符编码，由于 2 的 6 次方等于 64，所以每 6 个比特为一个单元，对应某个可打印字符。3 个字节就有 24 个比特，对应于 4 个 Base64 单元，即 3 个字节需要用 4 个可打印字符来表示。它可用来作为电子邮件的传输编码。在 Base64 中的可打印字符包括字母 A-Z、a-z、数字 0-9，这样共有 62 个字符，此外两个可打印符号在不同的系统中而不同。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/base64.png" alt="base64"></p>
<p>具体介绍参见 <a href="https://zh.wikipedia.org/wiki/Base64" target="_blank" rel="noopener">Base64 - 维基百科</a>。</p>
<p><strong>编码 man</strong></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/base64_man.png" alt="base64 编码 MAN"></p>
<p>如果要编码的字节数不能被 3 整除，最后会多出 1 个或 2 个字节，那么可以使用下面的方法进行处理：先使用 0 值在末尾补足，使其能够被 3 整除，然后再进行 base64 的编码。在编码后的 base64 文本后加上一个或两个 <code>=</code> 号，代表补足的字节数。也就是说，当最后剩余一个八位字节（一个 byte）时，最后一个 6 位的 base64 字节块有四位是 0 值，最后附加上两个等号；如果最后剩余两个八位字节（2 个 byte）时，最后一个 6 位的 base 字节块有两位是 0 值，最后附加一个等号。参考下表：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/base64_0.png" alt="base64 补 0"></p>
<p>由于解码时补位的 0 并不参与运算，可以在该处隐藏信息。</p>
<p>与 base64 类似，base32 使用 32 个可见字符进行编码，2 的 5 次方为 32，所以每 5 bit 为 1 个分组。5 字节为 40 bit，对应于 8 个 base32 分组，即 5 个字节用 8 个 base32 中字符来表示。但如果不足 5 个字节，则会先对第一个不足 5 bit 的分组用 0 补足了 5 bit ，对后面剩余分组全部使用 “=” 填充，直到补满 5 个字节。由此可知，base32 最多只有 6 个等号出现。例如：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/base32.png" alt="base32"></p>
<h4 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h4><ul>
<li>base64 结尾可能会有 <code>=</code> 号，但最多有 2 个</li>
<li>base32 结尾可能会有 <code>=</code> 号，但最多有 6 个</li>
<li>根据 base 的不同，字符集会有所限制</li>
<li><strong>有可能需要自己加等号</strong></li>
<li><strong>= 也就是 3D</strong></li>
<li>更多内容请参见 <a href="https://tools.ietf.org/html/rfc4648" target="_blank" rel="noopener">base rfc</a></li>
</ul>
<h4 id="工具-2"><a href="#工具-2" class="headerlink" title="工具"></a>工具</h4><ul>
<li><a href="http://www1.tc711.com/tool/BASE64.htm" target="_blank" rel="noopener">http://www1.tc711.com/tool/BASE64.htm</a></li>
<li>python 库函数</li>
<li><a href="https://github.com/cjcslhp/wheels/tree/master/b64stego" target="_blank" rel="noopener">读取隐写信息脚本</a></li>
</ul>
<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><p>题目描述参见 <code>ctf-challenge</code>中 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/misc/encode/computer/base64-stego" target="_blank" rel="noopener">misc 分类的 base64-stego 目录</a>中的 data.txt 文件。</p>
<p>使用脚本读取隐写信息。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> base64

<span class="token keyword">def</span> <span class="token function">deStego</span><span class="token punctuation">(</span>stegoFile<span class="token punctuation">)</span><span class="token punctuation">:</span>
    b64table <span class="token operator">=</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>stegoFile<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> stegoText<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> stegoText<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                text <span class="token operator">=</span> line<span class="token punctuation">[</span>line<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                message <span class="token operator">+=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span> bin<span class="token punctuation">(</span> <span class="token number">0</span> <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">'='</span> <span class="token keyword">else</span> b64table<span class="token punctuation">.</span>find<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> text<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token keyword">if</span> text<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token number">2</span> <span class="token keyword">else</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>chr<span class="token punctuation">(</span>int<span class="token punctuation">(</span>message<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>deStego<span class="token punctuation">(</span><span class="token string">"text.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出:</p>
<pre><code>     flag{BASE64_i5_amaz1ng}</code></pre><h3 id="霍夫曼编码"><a href="#霍夫曼编码" class="headerlink" title="霍夫曼编码"></a>霍夫曼编码</h3><p>参见 <a href="https://zh.wikipedia.org/wiki/霍夫曼编码" target="_blank" rel="noopener">霍夫曼编码</a>。</p>
<h3 id="XXencoding"><a href="#XXencoding" class="headerlink" title="XXencoding"></a>XXencoding</h3><p>XXencode 将输入文本以每三个字节为单位进行编码。如果最后剩下的资料少于三个字节，不够的部份用零补齐。这三个字节共有 24 个 Bit，以 6bit 为单位分为 4 个组，每个组以十进制来表示所出现的数值只会落在 0 到 63 之间。以所对应值的位置字符代替。</p>
<pre><code>           1         2         3         4         5         6
 0123456789012345678901234567890123456789012345678901234567890123
 |         |         |         |         |         |         |
 +-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz</code></pre><p>具体信息参见<a href="https://en.wikipedia.org/wiki/Xxencoding" target="_blank" rel="noopener">维基百科</a></p>
<h4 id="特点-3"><a href="#特点-3" class="headerlink" title="特点"></a>特点</h4><ul>
<li>+ 号，- 号。</li>
</ul>
<h4 id="工具-3"><a href="#工具-3" class="headerlink" title="工具"></a>工具</h4><ul>
<li><a href="http://web.chacuo.net/charsetxxencode" target="_blank" rel="noopener">http://web.chacuo.net/charsetxxencode</a></li>
</ul>
<h3 id="URL-编码"><a href="#URL-编码" class="headerlink" title="URL 编码"></a>URL 编码</h3><p>参见<a href="https://zh.wikipedia.org/wiki/百分号编码" target="_blank" rel="noopener"> URL 编码 - 维基百科</a>。</p>
<h4 id="特点-4"><a href="#特点-4" class="headerlink" title="特点"></a>特点</h4><ul>
<li>大量的百分号</li>
</ul>
<h4 id="工具-4"><a href="#工具-4" class="headerlink" title="工具"></a>工具</h4><h3 id="Unicode-编码"><a href="#Unicode-编码" class="headerlink" title="Unicode 编码"></a>Unicode 编码</h3><p>参见<a href="https://zh.wikipedia.org/wiki/Unicode" target="_blank" rel="noopener"> Unicode - 维基百科</a>。</p>
<p>注意，它有四种表现形式。</p>
<h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4><p>源文本： <code>The</code></p>
<p>&amp;#x [Hex]: <code>The</code></p>
<p>&amp;# [Decimal]: <code>The</code></p>
<p>\U [Hex]: <code>\U0054\U0068\U0065</code></p>
<p>\U+ [Hex]: <code>\U+0054\U+0068\U+0065</code></p>
<h4 id="工具-5"><a href="#工具-5" class="headerlink" title="工具"></a>工具</h4><h2 id="现实世界中常用的编码"><a href="#现实世界中常用的编码" class="headerlink" title="现实世界中常用的编码"></a>现实世界中常用的编码</h2><h3 id="条形码"><a href="#条形码" class="headerlink" title="条形码"></a>条形码</h3><ul>
<li>宽度不等的多个黑条和空白，按照一定的编码规则排列，用以表达一组信息的图形标识符</li>
<li>国际标准</li>
<li>EAN-13 商品标准，13 位数字</li>
<li>Code-39：39 字符</li>
<li>Code-128：128 字符</li>
<li><a href="https://online-barcode-reader.inliteresearch.com/" target="_blank" rel="noopener">条形码在线识别</a></li>
</ul>
<h3 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h3><ul>
<li><p>用某种特定几何图形按一定规律在平面分步的黑白相间的图形记录数据符号信息</p>
</li>
<li><p>堆叠式 / 行排式二维码：Code 16 k、Code 49、PDF417</p>
</li>
<li><p>矩阵式二维码：QR CODE</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/qr1.jpg" alt=""></p>
</li>
</ul>
<h1 id="取证隐写前置技术"><a href="#取证隐写前置技术" class="headerlink" title="取证隐写前置技术"></a>取证隐写前置技术</h1><p>大部分的 CTF 比赛中，取证及隐写两者密不可分，两者所需要的知识也相辅相成，所以这里也将对两者一起介绍。</p>
<p>任何要求检查一个静态数据文件从而获取隐藏信息的都可以被认为是隐写取证题（除非单纯地是密码学的知识），一些低分的隐写取证又常常与古典密码学结合在一起，而高分的题目则通常用与一些较为复杂的现代密码学知识结合在一起，很好地体现了 Misc 题的特点。</p>
<h2 id="前置技能"><a href="#前置技能" class="headerlink" title="前置技能"></a>前置技能</h2><ul>
<li><p>了解常见的编码</p>
<p>能够对文件中出现的一些编码进行解码，并且对一些特殊的编码（Base64、十六进制、二进制等）有一定的敏感度，对其进行转换并得到最终的 flag。</p>
</li>
<li><p>能够利用脚本语言（Python 等）去操作二进制数据</p>
</li>
<li><p>熟知常见文件的文件格式，尤其是各类 <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank" rel="noopener">文件头</a>、协议、结构等</p>
</li>
<li><p>灵活运用常见的工具</p>
</li>
</ul>
<h2 id="Python-操作二进制数据"><a href="#Python-操作二进制数据" class="headerlink" title="Python 操作二进制数据"></a>Python 操作二进制数据</h2><h3 id="struct-模块"><a href="#struct-模块" class="headerlink" title="struct 模块"></a>struct 模块</h3><p>有的时候需要用 Python 处理二进制数据，比如，存取文件，socket 操作时。这时候，可以使用 Python 的 struct 模块来完成。</p>
<p>struct 模块中最重要的三个函数是 <code>pack()</code>、<code>unpack()</code> 和 <code>calcsize()</code></p>
<ul>
<li><code>pack(fmt, v1, v2, ...)</code> 按照给定的格式（fmt），把数据封装成字符串（实际上是类似于 c 结构体的字节流）</li>
<li><code>unpack(fmt, string)</code> 按照给定的格式（fmt）解析字节流 string，返回解析出来的 tuple</li>
<li><code>calcsize(fmt)</code> 计算给定的格式（fmt）占用多少字节的内存</li>
</ul>
<p>这里打包格式 <code>fmt</code> 确定了将变量按照什么方式打包成字节流，其包含了一系列的格式字符串。这里就不再给出不同格式字符串的含义了，详细细节可以参照 <a href="https://docs.python.org/2/library/struct.html" target="_blank" rel="noopener">Python Doc</a></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> struct
<span class="token operator">>></span><span class="token operator">></span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'>I'</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token string">'\x00\x00\x00\x10'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>pack</code> 的第一个参数是处理指令，<code>'&gt;I'</code> 的意思是：<code>&gt;</code> 表示字节顺序是 Big-Endian，也就是网络序，<code>I</code> 表示 4 字节无符号整数。</p>
<p>后面的参数个数要和处理指令一致。</p>
<p>读入一个 BMP 文件的前 30 字节，文件头的结构按顺序如下</p>
<ul>
<li>两个字节：<code>BM</code> 表示 Windows 位图，<code>BA</code> 表示 OS/2 位图</li>
<li>一个 4 字节整数：表示位图大小</li>
<li>一个 4 字节整数：保留位，始终为 0</li>
<li>一个 4 字节整数：实际图像的偏移量</li>
<li>一个 4 字节整数：Header 的字节数</li>
<li>一个 4 字节整数：图像宽度</li>
<li>一个 4 字节整数：图像高度</li>
<li>一个 2 字节整数：始终为 1</li>
<li>一个 2 字节整数：颜色数</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> struct
<span class="token operator">>></span><span class="token operator">></span> bmp <span class="token operator">=</span> <span class="token string">'\x42\x4d\x38\x8c\x0a\x00\x00\x00\x00\x00\x36\x00\x00\x00\x28\x00\x00\x00\x80\x02\x00\x00\x68\x01\x00\x00\x01\x00\x18\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'&lt;ccIIIIIIHH'</span><span class="token punctuation">,</span>bmp<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token number">691256</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="bytearray-字节数组"><a href="#bytearray-字节数组" class="headerlink" title="bytearray 字节数组"></a>bytearray 字节数组</h3><p>将文件以二进制数组形式读取</p>
<pre class="line-numbers language-python"><code class="language-python">data <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>open<span class="token punctuation">(</span><span class="token string">'challenge.png'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>字节数组就是可变版本的字节</p>
<pre class="line-numbers language-python"><code class="language-python">data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\x89'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><h3 id="010-Editor"><a href="#010-Editor" class="headerlink" title="010 Editor"></a><a href="http://www.sweetscape.com/010editor/" target="_blank" rel="noopener">010 Editor</a></h3><p>SweetScape 010 Editor 是一个全新的十六进位文件编辑器，它有别于传统的十六进位编辑器在于它可用「范本」来解析二进位文件，从而让你读懂和编辑它。它还可用来比较一切可视的二进位文件。</p>
<p>利用它的模板功能可以非常轻松的观察文件内部的具体结构并且依此快速更改内容。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/010.png" alt=""></p>
<h3 id="file-命令"><a href="#file-命令" class="headerlink" title="file 命令"></a><code>file</code> 命令</h3><p><code>file</code> 命令根据文件头（魔法字节）去识别一个文件的文件类型。</p>
<pre><code>root in ~/Desktop/tmp λ file flag
flag: PNG image data, 450 x 450, 8-bit grayscale, non-interlaced</code></pre><h3 id="strings-命令"><a href="#strings-命令" class="headerlink" title="strings 命令"></a><code>strings</code> 命令</h3><p>打印文件中可打印的字符，经常用来发现文件中的一些提示信息或是一些特殊的编码信息，常常用来发现题目的突破口。</p>
<ul>
<li><p>可以配合 <code>grep</code> 命令探测指定信息</p>
<pre><code>strings test|grep -i XXCTF</code></pre></li>
<li><p>也可以配合 <code>-o</code> 参数获取所有 ASCII 字符偏移</p>
<pre><code>root in ~/Desktop/tmp λ strings -o flag|head
    14 IHDR
    45 gAMA
    64  cHRM
    141 bKGD
    157 tIME
    202 IDATx
    223 NFdVK3
    361 |;*-
    410 Ge%&lt;W
    431 5duX@%</code></pre></li>
</ul>
<h3 id="binwalk-命令"><a href="#binwalk-命令" class="headerlink" title="binwalk 命令"></a><code>binwalk</code> 命令</h3><p>binwalk 本是一个固件的分析工具，比赛中常用来发现多个文件粘合再在一起的情况。根据文件头去识别一个文件中夹杂的其他文件，有时也会存在误报率（尤其是对 Pcap 流量包等文件时）。</p>
<pre><code>root in ~/Desktop/tmp λ binwalk flag

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             PNG image, 450 x 450, 8-bit grayscale, non-interlaced
134           0x86            Zlib compressed data, best compression
25683         0x6453          Zip archive data, at least v2.0 to extract, compressed size: 675, uncompressed size: 1159, name: readme.txt
26398         0x671E          Zip archive data, at least v2.0 to extract, compressed size: 430849, uncompressed size: 1027984, name: trid
457387        0x6FAAB         End of Zip archive</code></pre><p>配合 <code>-e</code> 参数可以进行自动化提取。</p>
<p>也可以结合 <code>dd</code> 命令进行手动切割。</p>
<pre><code>root in ~/Desktop/tmp λ dd if=flag of=1.zip bs=1 skip=25683
431726+0 records in
431726+0 records out
431726 bytes (432 kB, 422 KiB) copied, 0.900973 s, 479 kB/s</code></pre><h1 id="图片分析"><a href="#图片分析" class="headerlink" title="图片分析"></a>图片分析</h1><h2 id="图片分析简介"><a href="#图片分析简介" class="headerlink" title="图片分析简介"></a>图片分析简介</h2><p>图像文件能够很好地包含黑客文化，因此 CTF 竞赛中经常会出现各种图像文件。</p>
<p>图像文件有多种复杂的格式，可以用于各种涉及到元数据、信息丢失和无损压缩、校验、隐写或可视化数据编码的分析解密，都是 Misc 中的一个很重要的出题方向。涉及到的知识点很多（包括基本的文件格式，常见的隐写手法及隐写用的软件），有的地方也需要去进行深入的理解。</p>
<h3 id="元数据（Metadata）"><a href="#元数据（Metadata）" class="headerlink" title="元数据（Metadata）"></a>元数据（Metadata）</h3><blockquote>
<p>元数据（Metadata），又称中介数据、中继数据，为描述数据的数据（Data about data），主要是描述数据属性（property）的信息，用来支持如指示存储位置、历史数据、资源查找、文件记录等功能。</p>
</blockquote>
<p>元数据中隐藏信息在比赛中是最基本的一种手法，通常用来隐藏一些关键的 <code>Hint</code> 信息或者是一些重要的如 <code>password</code> 等信息。</p>
<p>这类元数据你可以 <code>右键 --&gt; 属性</code> 去查看, 也可以通过 <code>strings</code> 命令去查看，一般来说，一些隐藏的信息（奇怪的字符串）常常出现在头部或者尾部。</p>
<p>接下来介绍一个 <code>identify</code> 命令，这个命令是用来获取一个或多个图像文件的格式和特性。</p>
<p><code>-format</code> 用来指定显示的信息，灵活使用它的 <code>-format</code> 参数可以给解题带来不少方便。<a href="https://www.imagemagick.org/script/escape.php" target="_blank" rel="noopener">format 各个参数具体意义</a></p>
<h4 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h4><p><a href="https://github.com/ctfs/write-ups-2017/tree/master/breakin-ctf-2017/misc/Mysterious-GIF" target="_blank" rel="noopener">Break In 2017 - Mysterious GIF</a></p>
<p>这题的一个难点是发现并提取 GIF 中的元数据，首先 <code>strings</code> 是可以观察到异常点的。</p>
<pre><code>GIF89a
   !!!"""###$$$%%%&amp;&amp;&amp;'''((()))***+++,,,---...///000111222333444555666777888999:::;;;&lt;&lt;&lt;===&gt;&gt;&gt;???@@@AAABBBCCCDDDEEEFFFGGGHHHIIIJJJKKKLLLMMMNNNOOOPPPQQQRRRSSSTTTUUUVVVWWWXXXYYYZZZ[[[\\\]]]^^^___```aaabbbcccdddeeefffggghhhiiijjjkkklllmmmnnnooopppqqqrrrssstttuuuvvvwwwxxxyyyzzz{{{|||}}}~~~
4d494945767749424144414e42676b71686b6947397730424151454641415343424b6b776767536c41674541416f4942415144644d4e624c3571565769435172
NETSCAPE2.0
ImageMagick
...</code></pre><p>这里的一串 16 进制其实是藏在 GIF 的元数据区</p>
<p>接下来就是提取，你可以选择 Python，但是利用 <code>identify</code> 显得更加便捷</p>
<pre><code>root in ~/Desktop/tmp λ identify -format "%s %c \n" Question.gif
0 4d494945767749424144414e42676b71686b6947397730424151454641415343424b6b776767536c41674541416f4942415144644d4e624c3571565769435172
1 5832773639712f377933536849507565707478664177525162524f72653330633655772f6f4b3877655a547834346d30414c6f75685634364b63514a6b687271
...
24 484b7735432b667741586c4649746d30396145565458772b787a4c4a623253723667415450574d35715661756278667362356d58482f77443969434c684a536f
25 724b3052485a6b745062457335797444737142486435504646773d3d</code></pre><p>其他过程这里不在叙述，可参考链接中的 Writeup</p>
<h3 id="像素值转化"><a href="#像素值转化" class="headerlink" title="像素值转化"></a>像素值转化</h3><p>看看这个文件里的数据，你能想到什么？</p>
<pre><code>255,255,255,255,255...........</code></pre><p>是一串 RGB 值，尝试着将他转化为图片</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> re

x <span class="token operator">=</span> <span class="token number">307</span> <span class="token comment" spellcheck="true">#x坐标  通过对txt里的行数进行整数分解</span>
y <span class="token operator">=</span> <span class="token number">311</span> <span class="token comment" spellcheck="true">#y坐标  x*y = 行数</span>

rgb1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">**</span><span class="token operator">**</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>rgb1<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">3</span>
m<span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>

        line <span class="token operator">=</span> rgb1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#获取一行</span>
        m<span class="token operator">+=</span><span class="token number">1</span>
        rgb <span class="token operator">=</span> line

        im<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>int<span class="token punctuation">(</span>rgb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>int<span class="token punctuation">(</span>rgb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>int<span class="token punctuation">(</span>rgb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rgb转化为像素</span>
im<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
im<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"flag.png"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而如果反过来的话，从一张图片提取 RGB 值，再对 RGB 值去进行一些对比，从而得到最终的 flag。</p>
<p>这类题目大部分都是一些像素块组成的图片，如下图</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/picture/figure/brainfun.png" alt=""></p>
<p>相关题目:</p>
<ul>
<li><a href="https://github.com/ctfs/write-ups-2016/tree/master/csaw-ctf-2016-quals/forensics/brainfun-50" target="_blank" rel="noopener">CSAW-2016-quals:Forensic/Barinfun</a></li>
<li><a href="https://github.com/ctfs/write-ups-2017/tree/master/breakin-ctf-2017/misc/A-dance-partner" target="_blank" rel="noopener">breakin-ctf-2017:A-dance-partner</a></li>
</ul>
<h2 id="PNG"><a href="#PNG" class="headerlink" title="PNG"></a>PNG</h2><h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p>对于一个 PNG 文件来说，其文件头总是由位固定的字节来描述的，剩余的部分由 3 个以上的 PNG 的数据块（Chunk）按照特定的顺序组成。</p>
<p>文件头 <code>89 50 4E 47 0D 0A 1A 0A</code> + 数据块 + 数据块 + 数据块……</p>
<h4 id="数据块-CHUNk"><a href="#数据块-CHUNk" class="headerlink" title="数据块 CHUNk"></a>数据块 CHUNk</h4><p>PNG 定义了两种类型的数据块，一种是称为关键数据块（critical chunk），这是标准的数据块，另一种叫做辅助数据块（ancillary chunks），这是可选的数据块。关键数据块定义了 4 个标准数据块，每个 PNG 文件都必须包含它们，PNG 读写软件也都必须要支持这些数据块。</p>
<table>
<thead>
<tr>
<th align="left">数据块符号</th>
<th align="left">数据块名称</th>
<th align="left">多数据块</th>
<th align="left">可选否</th>
<th align="left">位置限制</th>
</tr>
</thead>
<tbody><tr>
<td align="left">IHDR</td>
<td align="left">文件头数据块</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">第一块</td>
</tr>
<tr>
<td align="left">cHRM</td>
<td align="left">基色和白色点数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 和 IDAT 之前</td>
</tr>
<tr>
<td align="left">gAMA</td>
<td align="left">图像γ数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 和 IDAT 之前</td>
</tr>
<tr>
<td align="left">sBIT</td>
<td align="left">样本有效位数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 和 IDAT 之前</td>
</tr>
<tr>
<td align="left">PLTE</td>
<td align="left">调色板数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 IDAT 之前</td>
</tr>
<tr>
<td align="left">bKGD</td>
<td align="left">背景颜色数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 之后 IDAT 之前</td>
</tr>
<tr>
<td align="left">hIST</td>
<td align="left">图像直方图数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 之后 IDAT 之前</td>
</tr>
<tr>
<td align="left">tRNS</td>
<td align="left">图像透明数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 PLTE 之后 IDAT 之前</td>
</tr>
<tr>
<td align="left">oFFs</td>
<td align="left">（专用公共数据块）</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 IDAT 之前</td>
</tr>
<tr>
<td align="left">pHYs</td>
<td align="left">物理像素尺寸数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 IDAT 之前</td>
</tr>
<tr>
<td align="left">sCAL</td>
<td align="left">（专用公共数据块）</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">在 IDAT 之前</td>
</tr>
<tr>
<td align="left">IDAT</td>
<td align="left">图像数据块</td>
<td align="left">是</td>
<td align="left">否</td>
<td align="left">与其他 IDAT 连续</td>
</tr>
<tr>
<td align="left">tIME</td>
<td align="left">图像最后修改时间数据块</td>
<td align="left">否</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">tEXt</td>
<td align="left">文本信息数据块</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">zTXt</td>
<td align="left">压缩文本数据块</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">fRAc</td>
<td align="left">（专用公共数据块）</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">gIFg</td>
<td align="left">（专用公共数据块）</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">gIFt</td>
<td align="left">（专用公共数据块）</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">gIFx</td>
<td align="left">（专用公共数据块）</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">无限制</td>
</tr>
<tr>
<td align="left">IEND</td>
<td align="left">图像结束数据</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">最后一个数据块</td>
</tr>
</tbody></table>
<p>对于每个数据块都有着统一的数据结构，每个数据块由 4 个部分组成</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">字节数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Length（长度）</td>
<td align="left">4 字节</td>
<td align="left">指定数据块中数据域的长度，其长度不超过（231－1）字节</td>
</tr>
<tr>
<td align="left">Chunk Type Code（数据块类型码）</td>
<td align="left">4 字节</td>
<td align="left">数据块类型码由 ASCII 字母（A - Z 和 a - z）组成</td>
</tr>
<tr>
<td align="left">Chunk Data（数据块数据）</td>
<td align="left">可变长度</td>
<td align="left">存储按照 Chunk Type Code 指定的数据</td>
</tr>
<tr>
<td align="left">CRC（循环冗余检测）</td>
<td align="left">4 字节</td>
<td align="left">存储用来检测是否有错误的循环冗余码</td>
</tr>
</tbody></table>
<p>CRC（Cyclic Redundancy Check）域中的值是对 Chunk Type Code 域和 Chunk Data 域中的数据进行计算得到的。</p>
<h4 id="IHDR"><a href="#IHDR" class="headerlink" title="IHDR"></a>IHDR</h4><p>文件头数据块 IHDR（Header Chunk）：它包含有 PNG 文件中存储的图像数据的基本信息，由 13 字节组成，并要作为第一个数据块出现在 PNG 数据流中，而且一个 PNG 数据流中只能有一个文件头数据块</p>
<p>其中我们关注的是前 8 字节的内容</p>
<table>
<thead>
<tr>
<th align="left">域的名称</th>
<th align="left">字节数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Width</td>
<td align="left">4 bytes</td>
<td align="left">图像宽度，以像素为单位</td>
</tr>
<tr>
<td align="left">Height</td>
<td align="left">4 bytes</td>
<td align="left">图像高度，以像素为单位</td>
</tr>
</tbody></table>
<p>我们经常会去更改一张图片的高度或者宽度使得一张图片显示不完整从而达到隐藏信息的目的。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pngihdr.png" alt=""></p>
<p>这里可以发现在 Kali 中是打不开这张图片的，提示 <code>IHDR CRC error</code>，而 Windows 10 自带的图片查看器能够打开，就提醒了我们 IHDR 块被人为的篡改过了，从而尝试修改图片的高度或者宽度发现隐藏的字符串。</p>
<h5 id="例题-WDCTF-FINALS-2017"><a href="#例题-WDCTF-FINALS-2017" class="headerlink" title="例题  WDCTF-FINALS-2017"></a>例题  WDCTF-FINALS-2017</h5><p>观察文件可以发现, 文件头及宽度异常</p>
<pre><code>00000000  80 59 4e 47 0d 0a 1a 0a  00 00 00 0d 49 48 44 52  |.YNG........IHDR|
00000010  00 00 00 00 00 00 02 f8  08 06 00 00 00 93 2f 8a  |............../.|
00000020  6b 00 00 00 04 67 41 4d  41 00 00 9c 40 20 0d e4  |k....gAMA...@ ..|
00000030  cb 00 00 00 20 63 48 52  4d 00 00 87 0f 00 00 8c  |.... cHRM.......|
00000040  0f 00 00 fd 52 00 00 81  40 00 00 7d 79 00 00 e9  |....R...@..}y...|
...</code></pre><p>这里需要注意的是，文件宽度不能任意修改，需要根据 IHDR 块的 CRC 值爆破得到宽度, 否则图片显示错误不能得到 flag。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> struct


misc <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"misc4.png"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> misc<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">+</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'>i'</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token operator">+</span> misc<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">]</span>
    crc32 <span class="token operator">=</span> binascii<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span>
    <span class="token keyword">if</span> crc32 <span class="token operator">==</span> <span class="token number">0x932f8a6b</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到宽度值为 709 后，恢复图片得到 flag。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/picture/figure/misc4.png" alt=""></p>
<h4 id="PLTE"><a href="#PLTE" class="headerlink" title="PLTE"></a>PLTE</h4><p>调色板数据块 PLTE（palette chunk）：它包含有与索引彩色图像（indexed-color image）相关的彩色变换数据，它仅与索引彩色图像有关，而且要放在图像数据块（image data chunk）之前。真彩色的 PNG 数据流也可以有调色板数据块，目的是便于非真彩色显示程序用它来量化图像数据，从而显示该图像。</p>
<h4 id="IDAT"><a href="#IDAT" class="headerlink" title="IDAT"></a>IDAT</h4><p>图像数据块 IDAT（image data chunk）：它存储实际的数据，在数据流中可包含多个连续顺序的图像数据块。</p>
<ul>
<li>储存图像像数数据</li>
<li>在数据流中可包含多个连续顺序的图像数据块</li>
<li>采用 LZ77 算法的派生算法进行压缩</li>
<li>可以用 zlib 解压缩</li>
</ul>
<p>值得注意的是，IDAT 块只有当上一个块充满时，才会继续一个新的块。</p>
<p>用 <code>pngcheck</code> 去查看此 PNG 文件</p>
<pre><code>λ .\pngcheck.exe -v sctf.png
File: sctf.png (1421461 bytes)
  chunk IHDR at offset 0x0000c, length 13
    1000 x 562 image, 32-bit RGB+alpha, non-interlaced
  chunk sRGB at offset 0x00025, length 1
    rendering intent = perceptual
  chunk gAMA at offset 0x00032, length 4: 0.45455
  chunk pHYs at offset 0x00042, length 9: 3780x3780 pixels/meter (96 dpi)
  chunk IDAT at offset 0x00057, length 65445
    zlib: deflated, 32K window, fast compression
  chunk IDAT at offset 0x10008, length 65524
...
  chunk IDAT at offset 0x150008, length 45027
  chunk IDAT at offset 0x15aff7, length 138
  chunk IEND at offset 0x15b08d, length 0
No errors detected in sctf.png (28 chunks, 36.8% compression).</code></pre><p>可以看到，正常的块的 length 是在 65524 的时候就满了，而倒数第二个 IDAT 块长度是 45027，最后一个长度是 138，很明显最后一个 IDAT 块是有问题的，因为他本来应该并入到倒数第二个未满的块里.</p>
<p>利用 <code>python zlib</code> 解压多余 IDAT 块的内容，此时注意剔除 <strong>长度、数据块类型及末尾的 CRC 校验值</strong>。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> zlib
<span class="token keyword">import</span> binascii
IDAT <span class="token operator">=</span> <span class="token string">"789...667"</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span>IDAT<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IEND"><a href="#IEND" class="headerlink" title="IEND"></a>IEND</h4><p>图像结束数据 IEND（image trailer chunk）：它用来标记 PNG 文件或者数据流已经结束，并且必须要放在文件的尾部。</p>
<pre><code>00 00 00 00 49 45 4E 44 AE 42 60 82</code></pre><p>IEND 数据块的长度总是 <code>00 00 00 00</code>，数据标识总是 IEND <code>49 45 4E 44</code>，因此，CRC 码也总是 <code>AE 42 60 82</code>。</p>
<h4 id="其余辅助数据块"><a href="#其余辅助数据块" class="headerlink" title="其余辅助数据块"></a>其余辅助数据块</h4><ul>
<li>背景颜色数据块 bKGD（background color）</li>
<li>基色和白色度数据块 cHRM（primary chromaticities and white point），所谓白色度是指当 <code>R＝G＝B＝最大值</code> 时在显示器上产生的白色度</li>
<li>图像 γ 数据块 gAMA（image gamma）</li>
<li>图像直方图数据块 hIST（image histogram）</li>
<li>物理像素尺寸数据块 pHYs（physical pixel dimensions）</li>
<li>样本有效位数据块 sBIT（significant bits）</li>
<li>文本信息数据块 tEXt（textual data）</li>
<li>图像最后修改时间数据块 tIME （image last-modification time）</li>
<li>图像透明数据块 tRNS （transparency）</li>
<li>压缩文本数据块 zTXt （compressed textual data）</li>
</ul>
<h3 id="LSB"><a href="#LSB" class="headerlink" title="LSB"></a>LSB</h3><p>LSB 全称 Least Significant Bit，最低有效位。PNG 文件中的图像像数一般是由 RGB 三原色（红绿蓝）组成，每一种颜色占用 8 位，取值范围为 <code>0x00</code> 至 <code>0xFF</code>，即有 256 种颜色，一共包含了 256 的 3 次方的颜色，即 16777216 种颜色。</p>
<p>而人类的眼睛可以区分约 1000 万种不同的颜色，意味着人类的眼睛无法区分余下的颜色大约有 6777216 种。</p>
<p>LSB 隐写就是修改 RGB 颜色分量的最低二进制位（LSB），每个颜色会有 8 bit，LSB 隐写就是修改了像数中的最低的 1 bit，而人类的眼睛不会注意到这前后的变化，每个像素可以携带 3 比特的信息。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/lsb.jpg" alt=""></p>
<p>如果是要寻找这种 LSB 隐藏痕迹的话，有一个工具 <a href="http://www.caesum.com/handbook/Stegsolve.jar" target="_blank" rel="noopener">Stegsolve</a> 是个神器，可以来辅助我们进行分析。</p>
<p>通过下方的按钮可以观察每个通道的信息，例如查看 R 通道的最低位第 8 位平面的信息。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/lsb1.png" alt=""></p>
<p>LSB 的信息借助于 Stegsolve 查看各个通道时一定要细心捕捉异常点，抓住 LSB 隐写的蛛丝马迹。</p>
<h4 id="例题-1"><a href="#例题-1" class="headerlink" title="例题"></a>例题</h4><blockquote>
<p>HCTF - 2016 - Misc</p>
</blockquote>
<p>这题的信息隐藏在 RGB 三个通道的最低位中，借助 <code>Stegsolve--&gt;Analyse--&gt;Data Extract</code> 可以指定通道进行提取。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/hctfsolve.png" alt=""></p>
<p>可以发现 <code>zip</code> 头，用 <code>save bin</code> 保存为压缩包后，打开运行其中的 ELF 文件就可以得到最后的 flag。</p>
<blockquote>
<p>更多关于 LSB 的研究可以看 <a href="https://zhuanlan.zhihu.com/p/23890677" target="_blank" rel="noopener">这里</a>。</p>
</blockquote>
<h3 id="隐写软件"><a href="#隐写软件" class="headerlink" title="隐写软件"></a>隐写软件</h3><p><a href="http://domnit.org/stepic/doc/" target="_blank" rel="noopener">Stepic</a></p>
<h2 id="JPG"><a href="#JPG" class="headerlink" title="JPG"></a>JPG</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><ul>
<li>JPEG 是有损压缩格式，将像素信息用 JPEG 保存成文件再读取出来，其中某些像素值会有少许变化。在保存时有个质量参数可在 0 至 100 之间选择，参数越大图片就越保真，但图片的体积也就越大。一般情况下选择 70 或 80 就足够了</li>
<li>JPEG 没有透明度信息</li>
</ul>
<p>JPG 基本数据结构为两大类型：「段」和经过压缩编码的图像数据。</p>
<table>
<thead>
<tr>
<th align="left">名 称</th>
<th align="left">字节数</th>
<th align="left">数据</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">段 标识</td>
<td align="left">1</td>
<td align="left">FF</td>
<td align="left">每个新段的开始标识</td>
</tr>
<tr>
<td align="left">段类型</td>
<td align="left">1</td>
<td align="left"></td>
<td align="left">类型编码（称作标记码）</td>
</tr>
<tr>
<td align="left">段长 度</td>
<td align="left">2</td>
<td align="left"></td>
<td align="left">包括段内容和段长度本身, 不包括段标识和段类型</td>
</tr>
<tr>
<td align="left">段内容</td>
<td align="left">2</td>
<td align="left"></td>
<td align="left">≤65533 字节</td>
</tr>
</tbody></table>
<ul>
<li>有些段没有长度描述也没有内容，只有段标识和段类型。文件头和文件尾均属于这种段。</li>
<li>段与段之间无论有多少 <code>FF</code> 都是合法的，这些 <code>FF</code> 称为「填充字节」，必须被忽略掉。</li>
</ul>
<p>一些常见的段类型</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/jpgformat.png" alt=""></p>
<p><code>0xffd8</code> 和 <code>0xffd9</code>为 JPG 文件的开始结束的标志。</p>
<h3 id="隐写软件-1"><a href="#隐写软件-1" class="headerlink" title="隐写软件"></a>隐写软件</h3><h4 id="Stegdetect"><a href="#Stegdetect" class="headerlink" title="Stegdetect"></a><a href="https://github.com/redNixon/stegdetect" target="_blank" rel="noopener">Stegdetect</a></h4><p>通过统计分析技术评估 JPEG 文件的 DCT 频率系数的隐写工具, 可以检测到通过 JSteg、JPHide、OutGuess、Invisible Secrets、F5、appendX 和 Camouflage 等这些隐写工具隐藏的信息，并且还具有基于字典暴力破解密码方法提取通过 Jphide、outguess 和 jsteg-shell 方式嵌入的隐藏信息。</p>
<pre><code>-q 仅显示可能包含隐藏内容的图像。
-n 启用检查JPEG文件头功能，以降低误报率。如果启用，所有带有批注区域的文件将被视为没有被嵌入信息。如果JPEG文件的JFIF标识符中的版本号不是1.1，则禁用OutGuess检测。
-s 修改检测算法的敏感度，该值的默认值为1。检测结果的匹配度与检测算法的敏感度成正比，算法敏感度的值越大，检测出的可疑文件包含敏感信息的可能性越大。
-d 打印带行号的调试信息。
-t 设置要检测哪些隐写工具（默认检测jopi），可设置的选项如下：
j 检测图像中的信息是否是用jsteg嵌入的。
o 检测图像中的信息是否是用outguess嵌入的。
p 检测图像中的信息是否是用jphide嵌入的。
i 检测图像中的信息是否是用invisible secrets嵌入的。</code></pre><h4 id="JPHS"><a href="#JPHS" class="headerlink" title="JPHS"></a><a href="http://linux01.gwdg.de/~alatham/stego.html" target="_blank" rel="noopener">JPHS</a></h4><p>JPEG 图像的信息隐藏软件 JPHS，它是由 Allan Latham 开发设计实现在 Windows 和 Linux 系统平台针对有损压缩 JPEG 文件进行信息加密隐藏和探测提取的工具。软件里面主要包含了两个程序 JPHIDE 和 JPSEEK。JPHIDE 程序主要是实现将信息文件加密隐藏到 JPEG 图像功能，而 JPSEEK 程序主要实现从用 JPHIDE 程序加密隐藏得到的 JPEG 图像探测提取信息文件，Windows 版本的 JPHS 里的 JPHSWIN 程序具有图形化操作界面且具备 JPHIDE 和 JPSEEK 的功能。</p>
<h4 id="SilentEye"><a href="#SilentEye" class="headerlink" title="SilentEye"></a><a href="http://silenteye.v1kings.io/" target="_blank" rel="noopener">SilentEye</a></h4><blockquote>
<p>SilentEye is a cross-platform application design for an easy use of steganography, in this case hiding messages into pictures or sounds. It provides a pretty nice interface and an easy integration of new steganography algorithm and cryptography process by using a plug-ins system.</p>
</blockquote>
<h2 id="GIF"><a href="#GIF" class="headerlink" title="GIF"></a>GIF</h2><h3 id="文件结构-1"><a href="#文件结构-1" class="headerlink" title="文件结构"></a>文件结构</h3><p>一个 GIF 文件的结构可分为</p>
<ul>
<li>文件头（File Header）<ul>
<li>GIF 文件署名（Signature）</li>
<li>版本号（Version）</li>
</ul>
</li>
<li>GIF 数据流（GIF Data Stream）<ul>
<li>控制标识符</li>
<li>图象块（Image Block）</li>
<li>其他的一些扩展块</li>
</ul>
</li>
<li>文件终结器（Trailer）</li>
</ul>
<p>下表显示了一个 GIF 文件的组成结构：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/gif.png" alt=""></p>
<p>中间的那个大块可以被重复任意次</p>
<h4 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h4><p>GIF 署名（Signature）和版本号（Version）。GIF 署名用来确认一个文件是否是 GIF 格式的文件，这一部分由三个字符组成：<code>GIF</code>；文件版本号也是由三个字节组成，可以为 <code>87a</code> 或 <code>89a</code>。</p>
<h4 id="逻辑屏幕标识符（Logical-Screen-Descriptor）"><a href="#逻辑屏幕标识符（Logical-Screen-Descriptor）" class="headerlink" title="逻辑屏幕标识符（Logical Screen Descriptor）"></a>逻辑屏幕标识符（Logical Screen Descriptor）</h4><p>Logical Screen Descriptor（逻辑屏幕描述符）紧跟在 header 后面。这个块告诉 decoder（解码器）图片需要占用的空间。它的大小固定为 7 个字节，以 canvas width（画布宽度）和 canvas height（画布高度）开始。</p>
<h4 id="全局颜色列表（Global-Color-Table）"><a href="#全局颜色列表（Global-Color-Table）" class="headerlink" title="全局颜色列表（Global Color Table）"></a>全局颜色列表（Global Color Table）</h4><p>GIF 格式可以拥有 global color table，或用于针对每个子图片集，提供 local color table。每个 color table 由一个 RGB（就像通常我们见到的（255，0，0）红色 那种）列表组成。</p>
<h4 id="图像标识符（Image-Descriptor）"><a href="#图像标识符（Image-Descriptor）" class="headerlink" title="图像标识符（Image Descriptor）"></a>图像标识符（Image Descriptor）</h4><p>一个 GIF 文件一般包含多个图片。之前的图片渲染模式一般是将多个图片绘制到一个大的（virtual canvas）虚拟画布上，而现在一般将这些图片集用于实现动画。</p>
<p>每个 image 都以一个 image descriptor block（图像描述块）作为开头，这个块固定为 10 字节。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/picture/figure/imagesdescription.png" alt=""></p>
<h4 id="图像数据（Image-Data）"><a href="#图像数据（Image-Data）" class="headerlink" title="图像数据（Image Data）"></a>图像数据（Image Data）</h4><p>终于到了图片数据实际存储的地方。Image Data 是由一系列的输出编码（output codes）构成，它们告诉 decoder（解码器）需要绘制在画布上的每个颜色信息。这些编码以字节码的形式组织在这个块中。</p>
<h4 id="文件终结器（Trailer）"><a href="#文件终结器（Trailer）" class="headerlink" title="文件终结器（Trailer）"></a>文件终结器（Trailer）</h4><p>该块为一个单字段块，用来指示该数据流的结束。取固定值 0x3b.</p>
<p>更多参见 <a href="http://www.jianshu.com/p/df52f1511cf8" target="_blank" rel="noopener">gif 格式图片详细解析</a></p>
<h3 id="空间轴"><a href="#空间轴" class="headerlink" title="空间轴"></a>空间轴</h3><p>由于 GIF 的动态特性，由一帧帧的图片构成，所以每一帧的图片，多帧图片间的结合，都成了隐藏信息的一种载体。</p>
<p>对于需要分离的 GIF 文件, 可以使用<code>convert</code>命令将其每一帧分割开来</p>
<p>` sourceCode shell root in ~/Desktop/tmp λ convert cake.gif cake.png root in ~/Desktop/tmp λ ls cake-0.png cake-1.png cake-2.png cake-3.png cake.gif</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">### 例题</span>

<span class="token operator">></span> WDCTF<span class="token number">-2017</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">2</span>

打开gif后，思路很清晰，分离每一帧图片后，将起合并得到完整的二维码即可

``` sourceCode python
<span class="token keyword">from</span>  PIL <span class="token keyword">import</span> Image


flag <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">450</span><span class="token punctuation">,</span><span class="token number">450</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pot <span class="token operator">=</span> <span class="token string">"cake-{}.png"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>j<span class="token operator">+</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
        potImage <span class="token operator">=</span> Image<span class="token punctuation">.</span>open<span class="token punctuation">(</span>pot<span class="token punctuation">)</span>
        flag<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>potImage<span class="token punctuation">,</span><span class="token punctuation">(</span>j<span class="token operator">*</span><span class="token number">225</span><span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">225</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
flag<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'./flag.png'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>扫码后得到一串 16 进制字符串</p>
<pre><code>03f30d0ab8c1aa5....74080006030908</code></pre><p>开头<code>03f3</code>为<code>pyc</code>文件的头，恢复为<code>python</code>脚本后直接运行得到 flag</p>
<h3 id="时间轴"><a href="#时间轴" class="headerlink" title="时间轴"></a>时间轴</h3><p>GIF 文件每一帧间的时间间隔也可以作为信息隐藏的载体。</p>
<p>例如在当时在 XMan 选拔赛出的一题</p>
<blockquote>
<p>XMAN-2017:100.gif</p>
</blockquote>
<p>通过<code>identify</code>命令清晰的打印出每一帧的时间间隔</p>
<pre><code>$ identify -format "%s %T \n" 100.gif
0 66
1 66
2 20
3 10
4 20
5 10
6 10
7 20
8 20
9 20
10 20
11 10
12 20
13 20
14 10
15 10</code></pre><p>推断 <code>20 &amp; 10</code> 分别代表 <code>0 &amp; 1</code>，提取每一帧间隔并进行转化。</p>
<pre><code>$ cat flag|cut -d ' ' -f 2|tr -d '66'|tr -d '\n'|tr -d '0'|tr '2' '0'
0101100001001101010000010100111001111011001110010011011000110101001101110011010101100010011001010110010101100100001101000110010001100101011000010011000100111000011001000110010101100100001101000011011100110011001101010011011000110100001100110110000101100101011000110110011001100001001100110011010101111101#</code></pre><p>最后转 ASCII 码得到 flag。</p>
<h3 id="隐写软件-2"><a href="#隐写软件-2" class="headerlink" title="隐写软件"></a>隐写软件</h3><h4 id="F5-steganography"><a href="#F5-steganography" class="headerlink" title="F5-steganography"></a><a href="https://github.com/matthewgao/F5-steganography" target="_blank" rel="noopener">F5-steganography</a></h4><h1 id="音频隐写"><a href="#音频隐写" class="headerlink" title="音频隐写"></a>音频隐写</h1><p>与音频相关的 CTF 题目主要使用了隐写的策略，主要分为 MP3 隐写，LSB 隐写，波形隐写，频谱隐写等等。</p>
<h2 id="常见手段"><a href="#常见手段" class="headerlink" title="常见手段"></a>常见手段</h2><p>通过 <code>binwalk</code> 以及 <code>strings</code> 可以发现的信息不再详述。</p>
<h2 id="MP3-隐写"><a href="#MP3-隐写" class="headerlink" title="MP3 隐写"></a>MP3 隐写</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>MP3 隐写主要是使用 <a href="http://www.petitcolas.net/steganography/mp3stego/" target="_blank" rel="noopener">Mp3Stego</a> 工具进行隐写，其基本介绍及使用方法如下</p>
<blockquote>
<p>MP3Stego will hide information in MP3 files during the compression process. The data is first compressed, encrypted and then hidden in the MP3 bit stream.</p>
</blockquote>
<pre><code>encode -E hidden_text.txt -P pass svega.wav svega_stego.mp3
decode -X -P pass svega_stego.mp3</code></pre><h3 id="例题-2"><a href="#例题-2" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>ISCC-2016: Music Never Sleep</p>
</blockquote>
<p>初步观察后，由 <code>strings</code> 无发现，听音频无异常猜测使用隐写软件隐藏数据。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/audio/figure/1.jpg" alt=""></p>
<p>得到密码后使用 <code>Mp3Stego</code> 解密。</p>
<pre><code>decode.exe -X ISCC2016.mp3 -P bfsiscc2016</code></pre><p>得到文件 <code>iscc2016.mp3.txt</code>:</p>
<pre><code>Flag is SkYzWEk0M1JOWlNHWTJTRktKUkdJTVpXRzVSV0U2REdHTVpHT1pZPQ== ???</code></pre><p>Base64 &amp;&amp; Base32 后得到 flag。</p>
<h2 id="波形"><a href="#波形" class="headerlink" title="波形"></a>波形</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>通常来说，波形方向的题，在观察到异常后，使用相关软件（Audacity, Adobe Audition 等）观察波形规律，将波形进一步转化为 01 字符串等，从而提取转化出最终的 flag。</p>
<h3 id="例题-3"><a href="#例题-3" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>ISCC-2017: Misc-04</p>
</blockquote>
<p>其实这题隐藏的信息在最开始的一段音频内，不细心听可能会误认为是隐写软件。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/audio/figure/3.png" alt=""></p>
<p>以高为 1 低为 0，转换得到 <code>01</code> 字符串。</p>
<pre><code>110011011011001100001110011111110111010111011000010101110101010110011011101011101110110111011110011111101</code></pre><p>转为 ASCII，摩斯密码解密，得到 flag。</p>
<p>Note</p>
<p>一些较复杂的可能会先对音频进行一系列的处理，如滤波等。例如 <a href="https://www.40huo.cn/blog/jarvisoj-misc-writeup.html" target="_blank" rel="noopener">JarvisOJ - 上帝之音 Writeup</a></p>
<h2 id="频谱"><a href="#频谱" class="headerlink" title="频谱"></a>频谱</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>音频中的频谱隐写是将字符串隐藏在频谱中，此类音频通常会有一个较明显的特征，听起来是一段杂音或者比较刺耳。</p>
<h3 id="例题-4"><a href="#例题-4" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>Su-ctf-quals-2014:hear_with_your_eyes</p>
</blockquote>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/audio/figure/4.png" alt=""></p>
<h2 id="LSB-音频隐写"><a href="#LSB-音频隐写" class="headerlink" title="LSB 音频隐写"></a>LSB 音频隐写</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>类似于图片隐写中的 LSB 隐写，音频中也有对应的 LSB 隐写。主要可以使用 <a href="http://silenteye.v1kings.io/" target="_blank" rel="noopener">Silenteye</a> 工具，其介绍如下：</p>
<blockquote>
<p>SilentEye is a cross-platform application design for an easy use of steganography, in this case hiding messages into pictures or sounds. It provides a pretty nice interface and an easy integration of new steganography algorithm and cryptography process by using a plug-ins system.</p>
</blockquote>
<h3 id="例题-5"><a href="#例题-5" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>2015 广东省强网杯 - Little Apple</p>
</blockquote>
<p>直接使用 <code>silenteye</code> 即可。</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/audio/figure/2.jpg" alt=""></p>
<h2 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h2><ul>
<li><a href="https://ethackal.github.io/2015/10/05/derbycon-ctf-wav-steganography/" target="_blank" rel="noopener">音频中的 LSB</a></li>
<li><a href="http://bobao.360.cn/learning/detail/243.html" target="_blank" rel="noopener">隐写术总结</a></li>
</ul>
<h1 id="流量包分析"><a href="#流量包分析" class="headerlink" title="流量包分析"></a>流量包分析</h1><h2 id="流量包分析简介"><a href="#流量包分析简介" class="headerlink" title="流量包分析简介"></a>流量包分析简介</h2><p>CTF 比赛中, 流量包的取证分析是另一项重要的考察方向。</p>
<p>通常比赛中会提供一个包含流量数据的 PCAP 文件，有时候也会需要选手们先进行修复或重构传输文件后，再进行分析。</p>
<p>PCAP 这一块作为重点考察方向，复杂的地方在于数据包里充满着大量无关的流量信息，因此如何分类和过滤数据是参赛者需要完成的工作。</p>
<p>总的来说有以下几个步骤</p>
<ul>
<li>总体把握<ul>
<li>协议分级</li>
<li>端点统计</li>
</ul>
</li>
<li>过滤赛选<ul>
<li>过滤语法</li>
<li>Host，Protocol，contains，特征值</li>
</ul>
</li>
<li>发现异常<ul>
<li>特殊字符串</li>
<li>协议某字段</li>
<li>flag 位于服务器中</li>
</ul>
</li>
<li>数据提取<ul>
<li>字符串取</li>
<li>文件提取</li>
</ul>
</li>
</ul>
<p>总的来说比赛中的流量分析可以概括为以下三个方向:</p>
<ul>
<li>流量包修复</li>
<li>协议分析</li>
<li>数据提取</li>
</ul>
<h2 id="PCAP-文件修复"><a href="#PCAP-文件修复" class="headerlink" title="PCAP 文件修复"></a>PCAP 文件修复</h2><h3 id="PCAP-文件结构"><a href="#PCAP-文件结构" class="headerlink" title="PCAP 文件结构"></a>PCAP 文件结构</h3><p>一般来说, 对于 <code>PCAP</code> 文件格式考察较少，且通常都能借助于现成的工具如 <code>pcapfix</code> 直接修复，这里大致介绍下几个常见的块，详细可以翻看 <a href="http://www.tcpdump.org/pcap/pcap.html" target="_blank" rel="noopener">Here</a>。</p>
<ul>
<li>Tools<ul>
<li><a href="https://f00l.de/hacking/pcapfix.php" target="_blank" rel="noopener">PcapFix Online</a></li>
<li><a href="https://github.com/Rup0rt/pcapfix/tree/devel" target="_blank" rel="noopener">PcapFix</a></li>
</ul>
</li>
</ul>
<p>一般文件结构</p>
<pre><code>    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          Block Type                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      Block Total Length                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   /                          Block Body                           /
   /          /* variable length, aligned to 32 bits */            /
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      Block Total Length                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><p>目前所定义的常见块类型有</p>
<ol>
<li>Section Header Block: it defines the most important characteristics of the capture file.</li>
<li>Interface Description Block: it defines the most important characteristics of the interface(s) used for capturing traffic.</li>
<li>Packet Block: it contains a single captured packet, or a portion of it.</li>
<li>Simple Packet Block: it contains a single captured packet, or a portion of it, with only a minimal set of information about it.</li>
<li>Name Resolution Block: it defines the mapping from numeric addresses present in the packet dump and the canonical name counterpart.</li>
<li>Capture Statistics Block: it defines how to store some statistical data (e.g. packet dropped, etc) which can be useful to undestand the conditions in which the capture has been made.</li>
</ol>
<h3 id="常见块"><a href="#常见块" class="headerlink" title="常见块"></a>常见块</h3><h4 id="Section-Header-BlocK-文件头"><a href="#Section-Header-BlocK-文件头" class="headerlink" title="Section Header BlocK(文件头)"></a>Section Header BlocK(文件头)</h4><p>必须存在, 意味着文件的开始</p>
<pre><code>    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                Byte-Order Magic (0x1A2B3C4D)                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Major Version(主版本号)   |    Minor Version(次版本号)        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   |                          Section Length                       |
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   /                                                               /
   /                      Options (variable)                       /
   /                                                               /
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><h4 id="Interface-Description-Block-接口描述"><a href="#Interface-Description-Block-接口描述" class="headerlink" title="Interface Description Block(接口描述)"></a>Interface Description Block(接口描述)</h4><p>必须存在, 描述接口特性</p>
<pre><code>    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           LinkType            |           Reserved            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                  SnapLen(每个数据包最大字节数)                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   /                                                               /
   /                      Options (variable)                       /
   /                                                               /
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><h4 id="Packet-Block-数据块"><a href="#Packet-Block-数据块" class="headerlink" title="Packet Block(数据块)"></a>Packet Block(数据块)</h4><pre><code>    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Interface ID          |          Drops Count          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Timestamp (High)   标准的Unix格式          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Timestamp (Low)                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         Captured Len                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          Packet Len                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   /                          Packet Data                          /
   /          /* variable length, aligned to 32 bits */            /
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   /                      Options (variable)                       /
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><h3 id="例题-6"><a href="#例题-6" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>题目：第一届 “百度杯” 信息安全攻防总决赛 线上选拔赛：find the flag</p>
<p>WP：<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9884447.html" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9884447.html</a></p>
</blockquote>
<p>首先我们拿到这样一道流量包的题目，题目名称为 <code>find the flag</code> 。这里面给了很多提示信息，要我们去找到 <code>flag</code> 。</p>
<p><strong>第一步，搜索 <code>flag</code> 字样</strong></p>
<p>我们先去搜索看看流量包里面有没有 <code>flag</code> 。我们使用 <code>strings</code> 命令去找一下流量包， <code>Windows</code> 的朋友可以用 <code>notepad++</code> 的搜索功能去寻找。</p>
<p>搜索命令如下：</p>
<pre><code>strings findtheflag.cap | grep flag</code></pre><p>搜索结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/strings-to-flag.png" alt="strings-to-flag"></p>
<p>我们发现搜出了一大堆的东西，我们通过管道去过滤出 <code>flag</code> 信息，似乎没有发现我们所需要找的答案。</p>
<p><strong>第二步，流量包修复</strong></p>
<p>我们用 <code>wireshark</code> 打开这个流量包</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/wireshark-to-error.png" alt="wireshark-to-error"></p>
<p>我们发现这个流量包出现了异常现象，我们可以修复一下这个流量包。</p>
<p>这里我们用到一个在线工具：<a href="http://f00l.de/hacking/pcapfix.php" target="_blank" rel="noopener">http://f00l.de/hacking/pcapfix.php</a></p>
<p>这个工具可以帮助我们快速地将其流量包修复为 <code>pcap</code> 包。</p>
<p>我们对其进行在线修复。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/repaire-to-pcap.png" alt="repaire-to-pcap"></p>
<p>修复完毕后点击 <code>Get your repaired PCAP-file here.</code> 即可下载流量包，然后我们用 <code>wireshark</code> 打开。</p>
<p>既然还是要找 <code>flag</code> ，我们可以先看看这个流量包。</p>
<p><strong>第三步，追踪 TCP 流</strong></p>
<p>我们追踪一下 TCP 流，看看有没有什么突破？</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/wireshark-to-stream.png" alt="wireshark-to-stream"></p>
<p>我们通过追踪 <code>TCP</code> 流，可以看到一些版本信息， <code>cookie</code> 等等，我们还是发现了一些很有意思的东西。</p>
<p>从 <code>tcp.stream eq 29</code> 到 <code>tcp.stream eq 41</code> 只显示了 <code>where is the flag?</code> 这个字样，难道这是出题人在告诉我们 <code>flag</code> 在这里嘛？</p>
<p><strong>第四步，查找分组字节流</strong></p>
<p>我们追踪到 <code>tcp.stream eq 29</code> 的时候，在 <code>Identification</code> 信息中看到了 <code>flag</code> 中的 <code>lf</code> 字样，我们可以继续追踪下一个流，在 <code>tcp.stream eq 30</code> 的 <code>Identification</code> 信息中看到了 <code>flag</code> 中的 <code>ga</code> 字样，我们发现将两个包中 <code>Identification</code> 信息对应的字段从右至左组合，恰好就是 <code>flag</code> ！于是我们可以大胆地猜测， <code>flag</code> 肯定是藏在这里面。</p>
<p>我们直接通过搜索 -&gt; 字符串搜索 -&gt; 分组字节流 -&gt; 搜索关键字 <code>flag</code> 即可，按照同样的方式连接后面相连数据包的 <code>Identification</code> 信息对应的字段，即可找到最终的 flag！</p>
<p>下面是搜索的截图：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-01.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-02.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-03.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-04.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-05.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-06.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-07.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-08.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-09.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-10.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-11.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/find-the-flag-12.png" alt=""></p>
<p>所以最终的 <code>flag</code> 为：<strong>flag{aha!_you_found_it!}</strong></p>
<h2 id="数据提取"><a href="#数据提取" class="headerlink" title="数据提取"></a>数据提取</h2><p>这一块是流量包中另一个重点, 通过对协议分析, 找到了题目的关键点, 如何提取数据成了接下来的关键问题</p>
<h3 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h3><h4 id="wireshark-自动分析"><a href="#wireshark-自动分析" class="headerlink" title="wireshark 自动分析"></a>wireshark 自动分析</h4><pre><code>file -&gt; export objects -&gt; http</code></pre><h4 id="手动数据提取"><a href="#手动数据提取" class="headerlink" title="手动数据提取"></a>手动数据提取</h4><pre><code>file-&gt;export selected Packet Bytes</code></pre><h3 id="tshark"><a href="#tshark" class="headerlink" title="tshark"></a>tshark</h3><p>tshark 作为 wireshark 的命令行版, 高效快捷是它的优点, 配合其余命令行工具 (awk,grep) 等灵活使用, 可以快速定位, 提取数据从而省去了繁杂的脚本编写</p>
<p>再看<code>Google CTF 2016 Forensic-200</code>这一题, 可以通过 tshark 迅速完成解题</p>
<pre><code>what@kali:/tmp$ tshark -r capture.pcapng -T fields -e usb.capdata &gt; data2.txt
what@kali:/tmp$ # awk -F: 'function comp(v){if(v&gt;127)v-=256;return v}{x+=comp(strtonum("0x"$2));y+=comp(strtonum("0x"$3))}$1=="01"{print x,y}' data.txt &gt; data3.txt
what@kali:/tmp$ gnuplot
&gt; plot "data3.txt"</code></pre><ul>
<li>Step 1 鼠标协议中数据提取</li>
<li>Step 2 通过 awk 进行位置坐标转换</li>
<li>Step 3 形成图形</li>
</ul>
<hr>
<h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><blockquote>
<pre><code>tshark -r **.pcap –Y ** -T fields –e ** | **** &gt; data</code></pre></blockquote>
<pre><code>Usage:
  -Y &lt;display filter&gt;      packet displaY filter in Wireshark display filter
                           syntax
  -T pdml|ps|psml|json|jsonraw|ek|tabs|text|fields|?
                           format of text output (def: text)
  -e &lt;field&gt;               field to print if -Tfields selected (e.g. tcp.port,
                           _ws.col.Info)</code></pre><p>通过<code>-Y</code>过滤器 (与 wireshark 一致), 然后用<code>-T filds -e</code>配合指定显示的数据段 (比如 usb.capdata)</p>
<ul>
<li><pre><code>tips</code></pre><ul>
<li><code>-e</code>后的参数不确定可以由 <code>wireshark</code> 右击需要的数据选中后得到</li>
</ul>
</li>
</ul>
<h4 id="例题-7"><a href="#例题-7" class="headerlink" title="例题"></a>例题</h4><blockquote>
<p>题目：<code>google-ctf-2016 : a-cute-stegosaurus-100</code></p>
</blockquote>
<p>这题的数据隐藏的非常巧妙, 而且有一张图片混淆视听, 需要对<code>tcp</code>协议非常熟悉, 所以当时做出来的人并不多, 全球只有 <code>26</code> 支队伍</p>
<p>在<code>tcp</code>报文段中有 6Bit 的状态控制码, 分别如下</p>
<ul>
<li>URG：紧急比特（urgent）, 当 URG＝1 时，表明紧急指针字段有效, 代表该封包为紧急封包。它告诉系统此报文段中有紧急数据，应尽快传送 (相当于高优先级的数据)</li>
<li>ACK：确认比特（Acknowledge）。只有当 ACK＝1 时确认号字段才有效, 代表这个封包为确认封包。当 ACK＝0 时，确认号无效。</li>
<li>PSH：（Push function）若为 1 时，代表要求对方立即传送缓冲区内的其他对应封包，而无需等缓冲满了才送。</li>
<li>RST：复位比特 (Reset) , 当 RST＝1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。</li>
<li>SYN：同步比特 (Synchronous)，SYN 置为 1，就表示这是一个连接请求或连接接受报文, 通常带有 SYN 标志的封包表示『主动』要连接到对方的意思。。</li>
<li>FIN：终止比特 (Final)，用来释放一个连接。当 FIN＝1 时，表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。</li>
</ul>
<p>而这里的<code>tcp.urg</code>却为</p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/traffic/figure/urg.png" alt="urg"></p>
<p>通过 tshark 提取<code>tcp.urg</code>然后去除 0 的字段, 换行符转<code>,</code>直接转换成 python 的列表, 转 ascii 即可得到 flag</p>
<pre><code>⚡ root@kali:  tshark -r Stego-200_urg.pcap -T fields -e  tcp.urgent_pointer|egrep -vi "^0$"|tr '\n' ','
Running as user "root" and group "root". This could be dangerous.
67,84,70,123,65,110,100,95,89,111,117,95,84,104,111,117,103,104,116,95,73,116,95,87,97,115,95,73,110,95,84,104,101,95,80,105,99,116,117,114,101,125,#
...
&gt;&gt;&gt; print "".join([chr(x) for x in arr]) #python转换ascii
CTF{And_You_Thought_It_Was_In_The_Picture}</code></pre><blockquote>
<p>题目：<code>stego-150_ears.xz</code></p>
</blockquote>
<p><strong>Step 1</strong></p>
<p>通过<code>file</code>命令不断解压得到 <code>pcap</code> 文件</p>
<pre><code>➜  Desktop file ears
ears: XZ compressed data
➜  Desktop unxz &lt; ears &gt; file_1
➜  Desktop file file_1
file_1: POSIX tar archive
➜  Desktop 7z x file_1

7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,1 CPU Intel(R) Core(TM) i7-4710MQ CPU @ 2.50GHz (306C3),ASM,AES-NI)

    Scanning the drive for archives:
    1 file, 4263936 bytes (4164 KiB)

    Extracting archive: file_1
    --
    Path = file_1
    Type = tar
    Physical Size = 4263936
    Headers Size = 1536
    Code Page = UTF-8

    Everything is Ok

    Size:       4262272
    Compressed: 4263936</code></pre><p><strong>Step 2</strong></p>
<p>通过 <code>wireshark</code> 发现 <code>dns</code> 中回应名字存在异常，组成 <code>16</code> 进制的 <code>png</code> 文件</p>
<p>采用 <code>tshark</code> 进行提取，提取 <code>dns</code> 中的数据, 筛选具体报文形式<code>\w{4,}.asis.io</code></p>
<pre><code>tshark -r forensic_175_d78a42edc01c9104653776f16813d9e5 -T fields -e dns.qry.name -e dns.flags|grep 8180|awk '{if ($1~/\w{4,}.asis.io/) print $1}'|awk -F '.' '{print $1}'|tr -d '\n' &gt; png</code></pre><p><strong>Step 3</strong></p>
<p><code>16</code> 进制还原图片</p>
<pre><code>xxd -p -r png flag</code></pre><h3 id="自定义协议"><a href="#自定义协议" class="headerlink" title="自定义协议"></a>自定义协议</h3><p>提取数据存在一类特殊情况，即传输的数据本身使用自定义协议，下面用 <code>HITCON 2018</code> 的两道 Misc 为例说明。</p>
<h4 id="例题分析"><a href="#例题分析" class="headerlink" title="例题分析"></a>例题分析</h4><ul>
<li><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/misc/cap/2018HITCON-ev3-basic" target="_blank" rel="noopener">HITCON-2018 : ev3 basic</a></li>
<li><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/misc/cap/2018HITCON-ev3-scanner" target="_blank" rel="noopener">HITCON-2018 : ev3 scanner</a></li>
</ul>
<p><strong>ev3 basic</strong></p>
<h5 id="确定数据"><a href="#确定数据" class="headerlink" title="确定数据"></a>确定数据</h5><p>对于这类题目，首先分析有效数据位于哪些包中。观察流量，通讯双方为 <code>localhost</code> 和 <code>LegoSystem</code> 。其中大量标为 <code>PKTLOG</code> 的数据包都是日志，此题中不需关注。简单浏览其余各个协议的流量，发现仅 <code>RFCOMM</code> 协议中存在没有被 <code>wireshark</code> 解析的 <code>data</code> 段，而 <code>RFCOMM</code> 正是蓝牙使用的<a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_protocols#Radio_frequency_communication_(RFCOMM)" target="_blank" rel="noopener">传输层协议</a>之一。</p>
<p>由前述 <code>tshark</code> 相关介绍，可以通过以下命令提取数据：</p>
<pre><code>tshark -r .\ev3_basic.pklg -T fields -e data -Y "btrfcomm"</code></pre><h5 id="分析协议"><a href="#分析协议" class="headerlink" title="分析协议"></a>分析协议</h5><p>找到数据后，需要确定数据格式。如何查找资料可以参考 <code>信息搜集技术</code> 一节，此处不再赘述。总之由 <code>ev3</code> 这个关键词出发，我们最终知道这种通信方式传输的内容被称之为 <a href="http://ev3directcommands.blogspot.com/2016/01/no-title-specified-page-table-border_94.html" target="_blank" rel="noopener">Direct Command</a>，所使用的是乐高自定义的一种[简单应用层协议](<a href="https://le-www-live-s.legocdn.com/sc/media/files/ev3-developer-kit/lego" target="_blank" rel="noopener">https://le-www-live-s.legocdn.com/sc/media/files/ev3-developer-kit/lego</a> mindstorms ev3 communication developer kit-f691e7ad1e0c28a4cfb0835993d76ae3.pdf?la=en-us)，<code>Command</code> 本身格式由乐高的手册 <a href="http://www.lego.com/en-gb/mindstorms/downloads" target="_blank" rel="noopener">EV3 Firmware Developer Kit</a> 定义。<em>（查找过程并不像此处简单而直观，也是本题的关键点之一。）</em></p>
<p>在乐高的协议中，发送和回复遵从不同格式。在 <code>ev3 basic</code> 中，所有回复流量都相同，通过手册可知内容代表 <code>ok</code> ，没有实际含义，而发送的每个数据包都包含了一条指令。由协议格式解析出指令的 <code>Opcode</code> 均为 <code>0x84</code> ，代表 <code>UI_DRAW</code> 函数，且 <code>CMD</code> 是 <code>0x05</code> ，代表 <code>TEXT</code> 。之后是四个参数，<code>Color</code>, <code>X0</code>, <code>Y0</code>, <code>STRING</code> 。此处需要注意乐高的单个参数字节数并不固定，即便手册上标明了数据类型是 <code>DATA16</code> ，仍然可能使用一个字节长度的参数，需要参照手册中 <code>Parameter encoding</code> 一节及<a href="http://ev3directcommands.blogspot.com/2016/01/ev3-direct-commands-lesson-02-pre.html" target="_blank" rel="noopener">相关文章</a>。</p>
<p>尝试分析几个命令，发现每个指令都会在屏幕特定位置打印一个字符，这与提供的图片相符。</p>
<h5 id="处理结果"><a href="#处理结果" class="headerlink" title="处理结果"></a>处理结果</h5><p>理解数据内容后，通过脚本提取所有命令并解析参数，需要注意单个参数的字节数不固定。</p>
<p>得到所有命令的参数后，可以将每个字符其按照坐标绘制在屏幕上。较简单的做法是先按 <code>X</code> 后按 <code>Y</code> 排序，直接输出即可。</p>
<p><strong>ev3 scanner</strong></p>
<p>第二题的做法与第一题基本相同，难度增加的地方在于：</p>
<ul>
<li>发送的命令不再单一，包括读取传感器信息、控制 ev3 运动</li>
<li>回复也包含信息，主要是传感器读取的内容</li>
<li>函数的参数更复杂，解析难度更大</li>
<li>解析命令得到的结果需要更多处理</li>
</ul>
<p><code>ev3 scanner</code> 此处不再提供详细方法，可作为练习加深对这一类型题目的理解。</p>
<h1 id="协议分析"><a href="#协议分析" class="headerlink" title="协议分析"></a>协议分析</h1><h2 id="协议分析概述"><a href="#协议分析概述" class="headerlink" title="协议分析概述"></a>协议分析概述</h2><p>网络协议为计算机网络中进行数据交换而建立的规则、标准或约定的集合。例如，网络中一个微机用户和一个大型主机的操作员进行通信，由于这两个数据终端所用字符集不同，因此操作员所输入的命令彼此不认识。为了能进行通信，规定每个终端都要将各自字符集中的字符先变换为标准字符集的字符后，才进入网络传送，到达目的终端之后，再变换为该终端字符集的字符。当然，对于不相容终端，除了需变换字符集字符外还需转换其他特性，如显示格式、行长、行数、屏幕滚动方式等也需作相应的变换。</p>
<p>相应的，我们在协议分析这一章节中，将会从以下几个方面来介绍这一部分的知识：</p>
<ul>
<li><code>Wireshark</code> 常用功能的介绍</li>
<li><code>HTTP</code> 协议分析</li>
<li><code>HTTPS</code> 协议分析</li>
<li><code>FTP</code> 协议分析</li>
<li><code>DNS</code> 协议分析</li>
<li><code>WIFI</code> 协议分析</li>
<li><code>USB</code> 协议分析</li>
</ul>
<h2 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h2><h3 id="Wireshark-常用功能介绍"><a href="#Wireshark-常用功能介绍" class="headerlink" title="Wireshark 常用功能介绍"></a>Wireshark 常用功能介绍</h3><h4 id="显示过滤器"><a href="#显示过滤器" class="headerlink" title="显示过滤器"></a>显示过滤器</h4><p>显示过滤器可以用很多不同的参数来作为匹配标准，比如 IP 地址、协议、端口号、某些协议头部的参数。此外，用户也用一些条件工具和串联运算符创建出更加复杂的表达式。用户可以将不同的表达式组合起来，让软件显示的数据包范围更加精确。在数据包列表面板中显示的所有数据包都可以用数据包中包含的字段进行过滤。</p>
<pre><code>[not] Expression [and|or] [not] Expression</code></pre><p>经常要用到各种运算符</p>
<table>
<thead>
<tr>
<th align="left">运算符</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">==</td>
<td align="left">等于</td>
</tr>
<tr>
<td align="left">!=</td>
<td align="left">不等于</td>
</tr>
<tr>
<td align="left">&gt;</td>
<td align="left">大于</td>
</tr>
<tr>
<td align="left">&lt;</td>
<td align="left">小于</td>
</tr>
<tr>
<td align="left">&gt;=</td>
<td align="left">大于等于</td>
</tr>
<tr>
<td align="left">&lt;=</td>
<td align="left">小于等于</td>
</tr>
<tr>
<td align="left">与</td>
<td align="left">and , &amp;&amp;</td>
</tr>
<tr>
<td align="left">或</td>
<td align="left">or , ||</td>
</tr>
<tr>
<td align="left">非</td>
<td align="left">! , not</td>
</tr>
</tbody></table>
<h4 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h4><ol>
<li>借助于过滤器窗口</li>
</ol>
<p><img src="/images/loading.gif" data-original="../images/CTF/filter_window.png" alt=""></p>
<p>​    2. 借助于工具条的输入栏</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/filter_tool.png" alt=""></p>
<ol start="3">
<li>将数据包某个属性值指定为过滤条件</li>
</ol>
<p><img src="/images/loading.gif" data-original="../images/CTF/filter_select.png" alt=""></p>
<p> 复杂的过滤命令可以直接通过第三种方式得到过滤语法</p>
<h4 id="信息统计"><a href="#信息统计" class="headerlink" title="信息统计"></a>信息统计</h4><h5 id="Protocol-History-协议分级"><a href="#Protocol-History-协议分级" class="headerlink" title="Protocol History(协议分级)"></a>Protocol History(协议分级)</h5><p>这个窗口现实的是捕捉文件包含的所有协议的树状分支</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pro_his.png" alt=""></p>
<p>包含的字段</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Protocol：</td>
<td align="left">协议名称</td>
</tr>
<tr>
<td align="left">% Packets：</td>
<td align="left">含有该协议的包数目在捕捉文件所有包所占的比例</td>
</tr>
<tr>
<td align="left">Packets：</td>
<td align="left">含有该协议的包的数目</td>
</tr>
<tr>
<td align="left">Bytes：</td>
<td align="left">含有该协议的字节数</td>
</tr>
<tr>
<td align="left">Mbit/s：</td>
<td align="left">抓包时间内的协议带宽</td>
</tr>
<tr>
<td align="left">End Packets：</td>
<td align="left">该协议中的包的数目（作为文件中的最高协议层）</td>
</tr>
<tr>
<td align="left">End Bytes：</td>
<td align="left">该协议中的字节数（作为文件中的最高协议层）</td>
</tr>
<tr>
<td align="left">End Mbit/s：</td>
<td align="left">抓包时间内的协议带宽（作为文件中的最高协议层）</td>
</tr>
</tbody></table>
<p>这一功能可以为分析数据包的主要方向提供依据</p>
<h5 id="Conversation-对话"><a href="#Conversation-对话" class="headerlink" title="Conversation(对话)"></a>Conversation(对话)</h5><p>发生于一特定端点的 IP 间的所有流量.</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/conversation.png" alt=""></p>
<ul>
<li>查看收发大量数据流的 IP 地址。如果是你知道的服务器（你记得服务器的地址或地址范围），那问题就解决了；但也有可能只是某台设备正在扫描网络，或仅是一台产生过多数据的 PC。  </li>
<li>查看扫描模式（scan pattern）。这可能是一次正常的扫描，如 SNMP 软件发送 ping 报文以查找网络，但通常扫描都不是好事情</li>
</ul>
<h5 id="EndPoints-端点"><a href="#EndPoints-端点" class="headerlink" title="EndPoints(端点)"></a>EndPoints(端点)</h5><p>这一工具列出了 Wireshark 发现的所有 endpoints 上的统计信息</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/points.png" alt=""></p>
<h5 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h5><ul>
<li>Packet Counter</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/CTF/pac_count.png" alt=""></p>
<h2 id="HTTP-1"><a href="#HTTP-1" class="headerlink" title="HTTP"></a>HTTP</h2><p><code>HTTP</code> ( <code>Hyper Text Transfer Protocol</code> ，也称为超文本传输协议) 是一种用于分布式、协作式和超媒体信息系统的应用层协议。 <code>HTTP</code> 是万维网的数据通信的基础。</p>
<h3 id="例题-8"><a href="#例题-8" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>题目：江苏省领航杯 - 2017：hack</p>
</blockquote>
<p>总体观察可以得出:</p>
<ul>
<li><code>HTTP</code>为主</li>
<li><code>192.168.173.134</code>为主</li>
<li>不存在附件</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/CTF/linghang_hack.png" alt=""></p>
<p>从这张图, 基本可以判断初这是一个在<code>sql注入-盲注时产生的流量包</code></p>
<p>到此为止, 基本可以判断 flag 的方向, 提取出所有的 url 后, 用<code>python</code>辅助即可得到 flag</p>
<ul>
<li>提取 url: <code>tshark -r hack.pcap -T fields -e http.request.full_uri|tr -s '\n'|grep flag &gt; log</code></li>
<li>得到盲注结果</li>
</ul>
<pre><code>import re

with open('log') as f:
    tmp = f.read()
    flag = ''
    data = re.findall(r'=(\d*)%23',tmp)
    data = [int(i) for i in data]
    for i,num in enumerate(data):
        try:
            if num &gt; data[i+1]:
                flag += chr(num)
        except Exception:
            pass
    print flag</code></pre><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p><code>HTTPs = HTTP + SSL / TLS</code>. 服务端和客户端的信息传输都会通过 TLS 进行加密，所以传输的数据都是加密后的数据</p>
<ul>
<li><a href="http://www.freebuf.com/articles/system/37900.html" target="_blank" rel="noopener">wireshark 分析 HTTPs</a></li>
</ul>
<h3 id="例题-9"><a href="#例题-9" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>题目：hack-dat-kiwi-ctf-2015:ssl-sniff-2</p>
</blockquote>
<p>打开流量包发现是 <code>SSL</code> 加密过的数据, 导入题目提供的<code>server.key.insecure</code>, 即可解密</p>
<pre><code>GET /key.html HTTP/1.1
Host: localhost

HTTP/1.1 200 OK
Date: Fri, 20 Nov 2015 14:16:24 GMT
Server: Apache/2.4.7 (Ubuntu)
Last-Modified: Fri, 20 Nov 2015 14:15:54 GMT
ETag: "1c-524f98378d4e1"
Accept-Ranges: bytes
Content-Length: 28
Content-Type: text/html

The key is 39u7v25n1jxkl123</code></pre><h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p><code>FTP</code> ( <code>File Transfer Protocol</code> ，即文件传输协议) 是 <code>TCP/IP</code> 协议组中的协议之一。 <code>FTP</code> 协议包括两个组成部分，其一为 <code>FTP</code> 服务器，其二为 <code>FTP</code> 客户端。其中 <code>FTP</code> 服务器用来存储文件，用户可以使用 <code>FTP</code> 客户端通过 <code>FTP</code> 协议访问位于 <code>FTP</code> 服务器上的资源。在开发网站的时候，通常利用 <code>FTP</code> 协议把网页或程序传到 <code>Web</code> 服务器上。此外，由于 <code>FTP</code> 传输效率非常高，在网络上传输大的文件时，一般也采用该协议。</p>
<p>默认情况下 <code>FTP</code> 协议使用 <code>TCP</code> 端口中的 <code>20</code> 和 <code>21</code> 这两个端口，其中 <code>20</code> 用于传输数据， <code>21</code> 用于传输控制信息。但是，是否使用 <code>20</code> 作为传输数据的端口与 <code>FTP</code> 使用的传输模式有关，如果采用主动模式，那么数据传输端口就是 <code>20</code> ；如果采用被动模式，则具体最终使用哪个端口要服务器端和客户端协商决定。</p>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>DNS</code> 通常为 <code>UDP</code> 协议, 报文格式</p>
<pre><code>+-------------------------------+
| 报文头                         |
+-------------------------------+
| 问题 (向服务器提出的查询部分)    |
+-------------------------------+
| 回答 (服务器回复的资源记录)      |
+-------------------------------+
| 授权 (权威的资源记录)           |
+-------------------------------+
| 额外的 (额外的资源记录)         |
+-------------------------------+</code></pre><p>查询包只有头部和问题两个部分， <code>DNS</code> 收到查询包后，根据查询到的信息追加回答信息、授权机构、额外资源记录，并且修改了包头的相关标识再返回给客户端。</p>
<p>每个 <code>question</code> 部分</p>
<pre><code>   0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
 |                                               |
 /                     QNAME                     /
 /                                               /
 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
 |                     QTYPE                     |
 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
 |                     QCLASS                    |
 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</code></pre><ul>
<li><code>QNAME</code> ：为查询的域名，是可变长的，编码格式为：将域名用. 号划分为多个部分，每个部分前面加上一个字节表示该部分的长度，最后加一个 <code>0</code> 字节表示结束</li>
<li><code>QTYPE</code> ：占 <code>16</code> 位，表示查询类型，共有 <code>16</code> 种，常用值有：<code>1</code> ( <code>A</code> 记录，请求主机 <code>IP</code> 地址)、<code>2</code> ( <code>NS</code> ，请求授权 <code>DNS</code> 服务器)、<code>5</code> ( <code>CNAME</code> 别名查询)</li>
</ul>
<h3 id="例题-10"><a href="#例题-10" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>题目：<code>BSides San Francisco CTF 2017</code> ： <code>dnscap.pcap</code></p>
</blockquote>
<p>我们通过 <code>wireshark</code> 打开发现全部为 <code>DNS</code> 协议, 查询名为大量字符串<code>([\w\.]+)\.skullseclabs\.org</code></p>
<p>我们通过 <code>tshark -r dnscap.pcap -T fields -e dns.qry.name &gt; hex</code>提取后，利用 <code>python</code> 转码：</p>
<pre><code>import re


find = ""

with open('hex','rb') as f:
    for i in f:
        text = re.findall(r'([\w\.]+)\.skull',i)
        if text:
            find += text[0].replace('.','')
print find</code></pre><p>我们发现了几条关键信息：</p>
<pre><code>Welcome to dnscap! The flag is below, have fun!!
Welcome to dnscap! The flag is below, have fun!!
!command (sirvimes)
...
IHDR
gAMA
bKGD
        pHYs
IHDR
gAMA
bKGD
        pHYs
tIME
IDATx
...
2017-02-01T21:04:00-08:00
IEND
console (sirvimes)
console (sirvimes)
Good luck! That was dnscat2 traffic on a flaky connection with lots of re-transmits. Seriously,
Good luck! That was dnscat2 traffic on a flaky connection with lots of re-transmits. Seriously, d[
good luck. :)+</code></pre><p><code>flag</code> 确实包含在其中, 但是有大量重复信息, 一是应为<code>question</code> 。在 <code>dns</code> 协议中查询和反馈时都会用到，<code>-Y "ip.src == 192.168.43.91"</code>进行过滤后发现还是有不少重复部分。</p>
<pre><code>%2A}
%2A}
%2A}q
%2A}x
%2A}
IHDR
gAMA
bKGD
        pHYs
tIME
IDATx
HBBH
CxRH!
C1%t
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1</code></pre><p>根据发现的 <code>dnscat</code> 找到 <a href="https://github.com/iagox86/dnscat2/blob/master/doc/protocol.md" target="_blank" rel="noopener">https://github.com/iagox86/dnscat2/blob/master/doc/protocol.md</a> 这里介绍了 <code>dnscat</code> 协议的相关信息, 这是一种通过 <code>DNS</code> 传递数据的变种协议, 题目文件中应该未使用加密, 所以直接看这里的数据块信息</p>
<pre><code>MESSAGE_TYPE_MSG: [0x01]
(uint16_t) packet_id
(uint8_t) message_type [0x01]
(uint16_t) session_id
(uint16_t) seq
(uint16_t) ack
(byte[]) data</code></pre><p>在<code>qry.name</code>中去除其余字段, 只留下 <code>data</code> 快, 从而合并数据, 再从 <code>16</code> 进制中检索<code>89504e.....6082</code>提取<code>png</code>, 得到 <code>flag</code> 。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> re


find <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">:</span>
        text <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>r<span class="token string">'([\w\.]+)\.skull'</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> text<span class="token punctuation">:</span>
            tmp <span class="token operator">=</span>  text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
            find<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
last <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> find<span class="token punctuation">:</span>
    <span class="token keyword">if</span> i <span class="token operator">not</span> <span class="token keyword">in</span> last<span class="token punctuation">:</span>
        last<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>


<span class="token keyword">print</span>  <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>last<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>flag</em></p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/traffic/protocols/figure/dnscat_flag.png" alt="dnscat_flag"></p>
<h3 id="相关题目"><a href="#相关题目" class="headerlink" title="相关题目"></a>相关题目</h3><ul>
<li><a href="https://mrpnkt.github.io/2016/icectf-2016-search/" target="_blank" rel="noopener">IceCTF-2016:Search</a></li>
<li>[EIS-2017:DNS 101](<a href="https://github.com/susers/Writeups/blob/master/2017/EIS/Misc/DNS" target="_blank" rel="noopener">https://github.com/susers/Writeups/blob/master/2017/EIS/Misc/DNS</a> 101/Write-up.md)</li>
</ul>
<h2 id="WIFI"><a href="#WIFI" class="headerlink" title="WIFI"></a>WIFI</h2><blockquote>
<p><code>802.11</code> 是现今无线局域网通用的标准, 常见认证方式</p>
<ul>
<li>不启用安全‍‍</li>
<li><code>WEP‍‍</code></li>
<li><code>WPA/WPA2-PSK</code>（预共享密钥）‍‍</li>
<li><code>PA/WPA2 802.1X</code> （<code>radius</code> 认证）</li>
</ul>
</blockquote>
<h3 id="WPA-PSK"><a href="#WPA-PSK" class="headerlink" title="WPA-PSK"></a>WPA-PSK</h3><p><img src="/images/loading.gif" data-original="../images/CTF/wpa-psk.png" alt=""></p>
<p>其中四次握手过程</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/eapol.png" alt=""></p>
<ol>
<li>4 次握手开始于验证器 (AP)，它产生一个随机的值(ANonce) 发送给请求者</li>
<li>请求者也产生了它自己的随机 SNonce，然后用这两个 Nonces 以及 PMK 生成了 PTK。请求者回复消息 2 给验证器, 还有一个 MIC（message integrity code，消息验证码）作为 PMK 的验证</li>
<li>它先要验证请求者在消息 2 中发来的 MIC 等信息，验证成功后，如果需要就生成 GTK。然后发送消息 3</li>
<li>请求者收到消息 3，验证 MIC，安装密钥，发送消息 4，一个确认信息。验证器收到消息 4，验证 MIC，安装相同的密钥</li>
</ol>
<h3 id="例题-11"><a href="#例题-11" class="headerlink" title="例题"></a>例题</h3><blockquote>
<p>实验吧： <code>shipin.cap</code></p>
</blockquote>
<p>从大量的<code>Deauth</code> 攻击基本可以判断是一个破解 <code>wifi</code> 时的流量攻击</p>
<p>同时也成功发现了握手包信息</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/shiyanba-wpa.png" alt=""></p>
<p>接下来跑密码</p>
<ul>
<li><code>linux</code> ： <code>aircrack</code> 套件</li>
<li><code>windows</code> ： <code>wifipr</code> ，速度比 <code>esaw</code> 快， <code>GTX850</code> 能将近 <code>10w\s :</code>)</li>
</ul>
<p>得到密码<code>88888888</code>在 <code>wireshark</code> 中<code>Edit -&gt; Preferences -&gt; Protocols -&gt; IEEE802.11 -&gt; Edit</code>以<code>key:SSID</code>形式填入即可解密 <code>wifi</code> 包看到明文流量</p>
<blockquote>
<p>KCARCK 相关: <a href="https://www.krackattacks.com/" target="_blank" rel="noopener">https://www.krackattacks.com/</a></p>
</blockquote>
<h2 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p><strong>USB 详述</strong>: <a href="https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf" target="_blank" rel="noopener">https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf</a></p>
<ul>
<li>鼠标协议</li>
</ul>
<p>鼠标移动时表现为连续性，与键盘击键的离散性不一样，不过实际上鼠标动作所产生的数据包也是离散的，毕竟计算机表现的连续性信息都是由大量离散信息构成的</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/mouse.png" alt=""></p>
<p>每一个数据包的数据区有四个字节，第一个字节代表按键，当取 0x00 时，代表没有按键、为 0x01 时，代表按左键，为 0x02 时，代表当前按键为右键。第二个字节可以看成是一个 signed byte 类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。第三个字节与第二字节类似，代表垂直上下移动的偏移。</p>
<p>得到这些点的信息后, 即可恢复出鼠标移动轨迹</p>
<ul>
<li>Tools</li>
<li><a href="https://github.com/WangYihang/UsbMiceDataHacker" target="_blank" rel="noopener">UsbMiceDataHacker</a></li>
<li>键盘协议</li>
</ul>
<p>键盘数据包的数据长度为 8 个字节，击键信息集中在第 3 个字节</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/keyboard.png" alt=""></p>
<p>根据 data 值与具体键位的对应关系</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/keyboard_pro.png" alt=""></p>
<p>可从数据包恢复出键盘的案件信息</p>
<ul>
<li>Tools</li>
<li><a href="https://github.com/WangYihang/UsbKeyboardDataHacker" target="_blank" rel="noopener">UsbKeyboardDataHacker</a></li>
</ul>
<p><strong>参考</strong></p>
<ul>
<li><a href="https://www.anquanke.com/post/id/85218" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85218</a></li>
</ul>
<h3 id="例题-12"><a href="#例题-12" class="headerlink" title="例题"></a>例题</h3><blockquote>
<pre><code>Xman`三期夏令营排位赛练习题：`AutoKey</code></pre><p>WP：<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9473808.html" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9473808.html</a></p>
</blockquote>
<p>问题描述：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/task_AutoKey.png" alt=""></p>
<p>这道题是我参加 <code>Xman</code> 三期夏令营选拔赛出的一道题，我们如何对其进行分析？</p>
<h4 id="流量包是如何捕获的？"><a href="#流量包是如何捕获的？" class="headerlink" title="流量包是如何捕获的？"></a>流量包是如何捕获的？</h4><p>首先我们从上面的数据包分析可以知道，这是个 <code>USB</code> 的流量包，我们可以先尝试分析一下 <code>USB</code> 的数据包是如何捕获的。</p>
<p>在开始前，我们先介绍一些 <code>USB</code> 的基础知识。 <code>USB</code> 有不同的规格，以下是使用 <code>USB</code> 的三种方式：</p>
<pre><code>l USB UART
l USB HID
l USB Memory</code></pre><p><code>UART</code> 或者 <code>Universal Asynchronous Receiver/Transmitter</code> 。这种方式下，设备只是简单的将 <code>USB</code> 用于接受和发射数据，除此之外就再没有其他通讯功能了。</p>
<p><code>HID</code> 是人性化的接口。这一类通讯适用于交互式，有这种功能的设备有：键盘，鼠标，游戏手柄和数字显示设备。</p>
<p>最后是 <code>USB Memory</code> ，或者说是数据存储。 <code>External HDD</code> ， <code>thumb drive/flash drive</code> 等都是这一类的。</p>
<p>其中使用的最广的不是 <code>USB HID</code> 就是 <code>USB Memory</code> 了。</p>
<p>每一个 <code>USB</code> 设备（尤其是 <code>HID</code> 或者 <code>Memory</code> ）都有一个供应商 <code>ID（Vendor ID）</code> 和产品识别码<code>（Product Id）</code> 。 <code>Vendor ID</code> 是用来标记哪个厂商生产了这个 <code>USB</code> 设备。 <code>Product ID</code> 用来标记不同的产品，他并不是一个特殊的数字，当然最好不同。如下图：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/Product-ID.png" alt=""></p>
<p>上图是我在虚拟机环境下连接在我电脑上的 <code>USB</code> 设备列表，通过 <code>lsusb</code> 查看命令。</p>
<p>例如说，我在 <code>VMware</code> 下有一个无线鼠标。它是属于 <code>HID</code> 设备。这个设备正常的运行，并且通过<code>lsusb</code> 这个命令查看所有 <code>USB</code> 设备，现在大家能找出哪一条是这个鼠标吗？？没有错，就是第四个，就是下面这条：</p>
<pre><code>Bus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse</code></pre><p>其中，<code>ID 0e0f:0003</code> 就是 <code>Vendor-Product ID</code> 对， <code>Vendor ID</code> 的值是 <code>0e0f</code> ，并且 <code>Product ID</code> 的值是 <code>0003</code> 。 <code>Bus 002 Device 002</code> 代表 <code>usb</code> 设备正常连接，这点需要记下来。</p>
<p>我们用 <code>root</code> 权限运行 <code>Wireshark</code> 捕获 <code>USB</code> 数据流。但是通常来说我们不建议这么做。我们需要给用户足够的权限来获取 <code>Linux</code> 中的 <code>usb</code> 数据流。我们可以用 <code>udev</code> 来达到我们的目的。我们需要创建一个用户组 <code>usbmon</code> ，然后把我们的账户添加到这个组中。</p>
<pre><code>addgroup usbmon
gpasswd -a $USER usbmon
echo 'SUBSYSTEM=="usbmon", GROUP="usbmon", MODE="640"' &gt; /etc/udev/rules.d/99-usbmon.rules</code></pre><p>接下来，我们需要 <code>usbmon</code> 内核模块。如果该模块没有被加载，我们可以通过以下命令加载该模块：</p>
<pre><code>modprobe usbmon</code></pre><p>打开 <code>wireshark</code> ，你会看到 <code>usbmonX</code> 其中 <code>X</code> 代表数字。下图是我们本次的结果（我使用的是<code>root</code>）：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/usbmon0.png" alt=""></p>
<p>如果接口处于活跃状态或者有数据流经过的时候， <code>wireshark</code> 的界面就会把它以波形图的方式显示出来。那么，我们该选那个呢？没有错，就是我刚刚让大家记下来的，这个 X 的数字就是对应这 <code>USB Bus</code> 。在本文中是 <code>usbmon0</code> 。打开他就可以观察数据包了。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/analysis-usbmon0.png" alt=""></p>
<p>通过这些，我们可以了解到 <code>usb</code> 设备与主机之间的通信过程和工作原理，我们可以来对流量包进行分析了。</p>
<h4 id="如何去分析一个-USB-流量包？"><a href="#如何去分析一个-USB-流量包？" class="headerlink" title="如何去分析一个 USB 流量包？"></a>如何去分析一个 USB 流量包？</h4><p>根据前面的知识铺垫，我们大致对 <code>USB</code> 流量包的抓取有了一个轮廓了，下面我们介绍一下如何分析一个 <code>USB</code> 流量包。</p>
<p><code>USB</code> 协议的细节方面参考 <code>wireshark</code> 的 <code>wiki</code> ：<a href="https://wiki.wireshark.org/USB" target="_blank" rel="noopener">https://wiki.wireshark.org/USB</a></p>
<p>我们先拿 <code>GitHub</code> 上一个简单的例子开始讲起：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/example-usbpcap.png" alt=""></p>
<p>我们分析可以知道， <code>USB</code> 协议的数据部分在 <code>Leftover Capture Data</code> 域之中，在 <code>Mac</code> 和 <code>Linux</code> 下可以用 <code>tshark</code> 命令可以将 <code>leftover capture data</code> 单独提取出来，命令如下：</p>
<pre><code>tshark -r example.pcap -T fields -e usb.capdata //如果想导入usbdata.txt文件中，后面加上参数：&gt;usbdata.txt
Windows` 下装了 `wireshark` 的环境下，在 `wireshark`目录下有个 `tshark.exe` ，比如我的在 `D:\Program Files\Wireshark\tshark.exe</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/Windows-tshark.png" alt=""></p>
<p>调用 <code>cmd</code> ，定位到当前目录下，输入如下命令即可：</p>
<pre><code>tshark.exe -r example.pcap -T fields -e usb.capdata //如果想导入usbdata.txt文件中，后面加上参数：&gt;usbdata.txt</code></pre><p>有关 <code>tshark</code> 命令的详细使用参考 <code>wireshark</code> 官方文档：<a href="https://www.wireshark.org/docs/man-pages/tshark.html" target="_blank" rel="noopener">https://www.wireshark.org/docs/man-pages/tshark.html</a></p>
<p>运行命令并查看 <code>usbdata.txt</code> 发现数据包长度为八个字节</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/usbdata.png" alt=""></p>
<p>关于 <code>USB</code> 的特点应用我找了一张图，很清楚的反应了这个问题：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/usb-feature.png" alt=""></p>
<p>这里我们只关注 <code>USB</code> 流量中的键盘流量和鼠标流量。</p>
<p>键盘数据包的数据长度为 <code>8</code> 个字节，击键信息集中在第 <code>3</code> 个字节，每次 <code>key stroke</code> 都会产生一个 <code>keyboard event usb packet</code> 。</p>
<p>鼠标数据包的数据长度为 <code>4</code> 个字节，第一个字节代表按键，当取 <code>0x00</code> 时，代表没有按键、为 0x01 时，代表按左键，为 <code>0x02</code> 时，代表当前按键为右键。第二个字节可以看成是一个 <code>signed byte</code> 类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。第三个字节与第二字节类似，代表垂直上下移动的偏移。</p>
<p>我翻阅了大量的 <code>USB</code> 协议的文档，在这里我们可以找到这个值与具体键位的对应关系：<a href="https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf" target="_blank" rel="noopener">https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf</a></p>
<p><code>usb keyboard</code> 的映射表 根据这个映射表将第三个字节取出来，对应对照表得到解码：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/keyboard_pro-162851368223023.png" alt=""></p>
<p>我们写出如下脚本：</p>
<pre class="line-numbers language-python"><code class="language-python">mappings <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0x04</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">,</span>  <span class="token number">0x05</span><span class="token punctuation">:</span><span class="token string">"B"</span><span class="token punctuation">,</span>  <span class="token number">0x06</span><span class="token punctuation">:</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">:</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">:</span><span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">:</span><span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">:</span><span class="token string">"G"</span><span class="token punctuation">,</span>  <span class="token number">0x0B</span><span class="token punctuation">:</span><span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">:</span><span class="token string">"I"</span><span class="token punctuation">,</span>  <span class="token number">0x0D</span><span class="token punctuation">:</span><span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">:</span><span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">:</span><span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">:</span><span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">:</span><span class="token string">"N"</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">:</span><span class="token string">"O"</span><span class="token punctuation">,</span>  <span class="token number">0x13</span><span class="token punctuation">:</span><span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">:</span><span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">:</span><span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">:</span><span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">:</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">:</span><span class="token string">"U"</span><span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">:</span><span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">:</span><span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">:</span><span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">:</span><span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">:</span><span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">:</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">:</span><span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">:</span><span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">:</span><span class="token string">"5"</span><span class="token punctuation">,</span>  <span class="token number">0x23</span><span class="token punctuation">:</span><span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">:</span><span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">:</span><span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">:</span><span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">:</span><span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">0x2a</span><span class="token punctuation">:</span><span class="token string">"[DEL]"</span><span class="token punctuation">,</span>  <span class="token number">0X2B</span><span class="token punctuation">:</span><span class="token string">"    "</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">:</span><span class="token string">" "</span><span class="token punctuation">,</span>  <span class="token number">0x2D</span><span class="token punctuation">:</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">:</span><span class="token string">"="</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">:</span><span class="token string">"["</span><span class="token punctuation">,</span>  <span class="token number">0x30</span><span class="token punctuation">:</span><span class="token string">"]"</span><span class="token punctuation">,</span>  <span class="token number">0x31</span><span class="token punctuation">:</span><span class="token string">"\\"</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">:</span><span class="token string">"~"</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">:</span><span class="token string">";"</span><span class="token punctuation">,</span>  <span class="token number">0x34</span><span class="token punctuation">:</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">:</span><span class="token string">","</span><span class="token punctuation">,</span>  <span class="token number">0x37</span><span class="token punctuation">:</span><span class="token string">"."</span> <span class="token punctuation">}</span>
nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
keys <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'usbdata.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
    <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span><span class="token punctuation">:</span>
         <span class="token keyword">continue</span>
    nums<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 00:00:xx:....</span>
keys<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> n <span class="token keyword">in</span> nums<span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> n <span class="token keyword">in</span> mappings<span class="token punctuation">:</span>
        output <span class="token operator">+=</span> mappings<span class="token punctuation">[</span>n<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output <span class="token operator">+=</span> <span class="token string">'[unknown]'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'output :n'</span> <span class="token operator">+</span> output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/usb-solved.png" alt=""></p>
<p>我们把前面的整合成脚本，得：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os

DataFileName <span class="token operator">=</span> <span class="token string">"usb.dat"</span>

presses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

normalKeys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"04"</span><span class="token punctuation">:</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"05"</span><span class="token punctuation">:</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"06"</span><span class="token punctuation">:</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"07"</span><span class="token punctuation">:</span><span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"08"</span><span class="token punctuation">:</span><span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token string">"09"</span><span class="token punctuation">:</span><span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"0a"</span><span class="token punctuation">:</span><span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"0b"</span><span class="token punctuation">:</span><span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"0c"</span><span class="token punctuation">:</span><span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"0d"</span><span class="token punctuation">:</span><span class="token string">"j"</span><span class="token punctuation">,</span> <span class="token string">"0e"</span><span class="token punctuation">:</span><span class="token string">"k"</span><span class="token punctuation">,</span> <span class="token string">"0f"</span><span class="token punctuation">:</span><span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">:</span><span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">:</span><span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"12"</span><span class="token punctuation">:</span><span class="token string">"o"</span><span class="token punctuation">,</span> <span class="token string">"13"</span><span class="token punctuation">:</span><span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"14"</span><span class="token punctuation">:</span><span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">"15"</span><span class="token punctuation">:</span><span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">"16"</span><span class="token punctuation">:</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"17"</span><span class="token punctuation">:</span><span class="token string">"t"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">:</span><span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"19"</span><span class="token punctuation">:</span><span class="token string">"v"</span><span class="token punctuation">,</span> <span class="token string">"1a"</span><span class="token punctuation">:</span><span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"1b"</span><span class="token punctuation">:</span><span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"1c"</span><span class="token punctuation">:</span><span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"1d"</span><span class="token punctuation">:</span><span class="token string">"z"</span><span class="token punctuation">,</span><span class="token string">"1e"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"1f"</span><span class="token punctuation">:</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">:</span><span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">:</span><span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"22"</span><span class="token punctuation">:</span><span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"23"</span><span class="token punctuation">:</span><span class="token string">"6"</span><span class="token punctuation">,</span><span class="token string">"24"</span><span class="token punctuation">:</span><span class="token string">"7"</span><span class="token punctuation">,</span><span class="token string">"25"</span><span class="token punctuation">:</span><span class="token string">"8"</span><span class="token punctuation">,</span><span class="token string">"26"</span><span class="token punctuation">:</span><span class="token string">"9"</span><span class="token punctuation">,</span><span class="token string">"27"</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span><span class="token string">"28"</span><span class="token punctuation">:</span><span class="token string">"&lt;RET>"</span><span class="token punctuation">,</span><span class="token string">"29"</span><span class="token punctuation">:</span><span class="token string">"&lt;ESC>"</span><span class="token punctuation">,</span><span class="token string">"2a"</span><span class="token punctuation">:</span><span class="token string">"&lt;DEL>"</span><span class="token punctuation">,</span> <span class="token string">"2b"</span><span class="token punctuation">:</span><span class="token string">"\t"</span><span class="token punctuation">,</span><span class="token string">"2c"</span><span class="token punctuation">:</span><span class="token string">"&lt;SPACE>"</span><span class="token punctuation">,</span><span class="token string">"2d"</span><span class="token punctuation">:</span><span class="token string">"-"</span><span class="token punctuation">,</span><span class="token string">"2e"</span><span class="token punctuation">:</span><span class="token string">"="</span><span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">:</span><span class="token string">"["</span><span class="token punctuation">,</span><span class="token string">"30"</span><span class="token punctuation">:</span><span class="token string">"]"</span><span class="token punctuation">,</span><span class="token string">"31"</span><span class="token punctuation">:</span><span class="token string">"\\"</span><span class="token punctuation">,</span><span class="token string">"32"</span><span class="token punctuation">:</span><span class="token string">"&lt;NON>"</span><span class="token punctuation">,</span><span class="token string">"33"</span><span class="token punctuation">:</span><span class="token string">";"</span><span class="token punctuation">,</span><span class="token string">"34"</span><span class="token punctuation">:</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">"35"</span><span class="token punctuation">:</span><span class="token string">"&lt;GA>"</span><span class="token punctuation">,</span><span class="token string">"36"</span><span class="token punctuation">:</span><span class="token string">","</span><span class="token punctuation">,</span><span class="token string">"37"</span><span class="token punctuation">:</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"38"</span><span class="token punctuation">:</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"39"</span><span class="token punctuation">:</span><span class="token string">"&lt;CAP>"</span><span class="token punctuation">,</span><span class="token string">"3a"</span><span class="token punctuation">:</span><span class="token string">"&lt;F1>"</span><span class="token punctuation">,</span><span class="token string">"3b"</span><span class="token punctuation">:</span><span class="token string">"&lt;F2>"</span><span class="token punctuation">,</span> <span class="token string">"3c"</span><span class="token punctuation">:</span><span class="token string">"&lt;F3>"</span><span class="token punctuation">,</span><span class="token string">"3d"</span><span class="token punctuation">:</span><span class="token string">"&lt;F4>"</span><span class="token punctuation">,</span><span class="token string">"3e"</span><span class="token punctuation">:</span><span class="token string">"&lt;F5>"</span><span class="token punctuation">,</span><span class="token string">"3f"</span><span class="token punctuation">:</span><span class="token string">"&lt;F6>"</span><span class="token punctuation">,</span><span class="token string">"40"</span><span class="token punctuation">:</span><span class="token string">"&lt;F7>"</span><span class="token punctuation">,</span><span class="token string">"41"</span><span class="token punctuation">:</span><span class="token string">"&lt;F8>"</span><span class="token punctuation">,</span><span class="token string">"42"</span><span class="token punctuation">:</span><span class="token string">"&lt;F9>"</span><span class="token punctuation">,</span><span class="token string">"43"</span><span class="token punctuation">:</span><span class="token string">"&lt;F10>"</span><span class="token punctuation">,</span><span class="token string">"44"</span><span class="token punctuation">:</span><span class="token string">"&lt;F11>"</span><span class="token punctuation">,</span><span class="token string">"45"</span><span class="token punctuation">:</span><span class="token string">"&lt;F12>"</span><span class="token punctuation">}</span>

shiftKeys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"04"</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"05"</span><span class="token punctuation">:</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"06"</span><span class="token punctuation">:</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"07"</span><span class="token punctuation">:</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"08"</span><span class="token punctuation">:</span><span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token string">"09"</span><span class="token punctuation">:</span><span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token string">"0a"</span><span class="token punctuation">:</span><span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"0b"</span><span class="token punctuation">:</span><span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"0c"</span><span class="token punctuation">:</span><span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token string">"0d"</span><span class="token punctuation">:</span><span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token string">"0e"</span><span class="token punctuation">:</span><span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"0f"</span><span class="token punctuation">:</span><span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">:</span><span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">:</span><span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"12"</span><span class="token punctuation">:</span><span class="token string">"O"</span><span class="token punctuation">,</span> <span class="token string">"13"</span><span class="token punctuation">:</span><span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"14"</span><span class="token punctuation">:</span><span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"15"</span><span class="token punctuation">:</span><span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"16"</span><span class="token punctuation">:</span><span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"17"</span><span class="token punctuation">:</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">:</span><span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"19"</span><span class="token punctuation">:</span><span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"1a"</span><span class="token punctuation">:</span><span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"1b"</span><span class="token punctuation">:</span><span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token string">"1c"</span><span class="token punctuation">:</span><span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token string">"1d"</span><span class="token punctuation">:</span><span class="token string">"Z"</span><span class="token punctuation">,</span><span class="token string">"1e"</span><span class="token punctuation">:</span><span class="token string">"!"</span><span class="token punctuation">,</span> <span class="token string">"1f"</span><span class="token punctuation">:</span><span class="token string">"@"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">:</span><span class="token string">"#"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">:</span><span class="token string">"$"</span><span class="token punctuation">,</span> <span class="token string">"22"</span><span class="token punctuation">:</span><span class="token string">"%"</span><span class="token punctuation">,</span> <span class="token string">"23"</span><span class="token punctuation">:</span><span class="token string">"^"</span><span class="token punctuation">,</span><span class="token string">"24"</span><span class="token punctuation">:</span><span class="token string">"&amp;"</span><span class="token punctuation">,</span><span class="token string">"25"</span><span class="token punctuation">:</span><span class="token string">"*"</span><span class="token punctuation">,</span><span class="token string">"26"</span><span class="token punctuation">:</span><span class="token string">"("</span><span class="token punctuation">,</span><span class="token string">"27"</span><span class="token punctuation">:</span><span class="token string">")"</span><span class="token punctuation">,</span><span class="token string">"28"</span><span class="token punctuation">:</span><span class="token string">"&lt;RET>"</span><span class="token punctuation">,</span><span class="token string">"29"</span><span class="token punctuation">:</span><span class="token string">"&lt;ESC>"</span><span class="token punctuation">,</span><span class="token string">"2a"</span><span class="token punctuation">:</span><span class="token string">"&lt;DEL>"</span><span class="token punctuation">,</span> <span class="token string">"2b"</span><span class="token punctuation">:</span><span class="token string">"\t"</span><span class="token punctuation">,</span><span class="token string">"2c"</span><span class="token punctuation">:</span><span class="token string">"&lt;SPACE>"</span><span class="token punctuation">,</span><span class="token string">"2d"</span><span class="token punctuation">:</span><span class="token string">"_"</span><span class="token punctuation">,</span><span class="token string">"2e"</span><span class="token punctuation">:</span><span class="token string">"+"</span><span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">:</span><span class="token string">"{"</span><span class="token punctuation">,</span><span class="token string">"30"</span><span class="token punctuation">:</span><span class="token string">"}"</span><span class="token punctuation">,</span><span class="token string">"31"</span><span class="token punctuation">:</span><span class="token string">"|"</span><span class="token punctuation">,</span><span class="token string">"32"</span><span class="token punctuation">:</span><span class="token string">"&lt;NON>"</span><span class="token punctuation">,</span><span class="token string">"33"</span><span class="token punctuation">:</span><span class="token string">"\""</span><span class="token punctuation">,</span><span class="token string">"34"</span><span class="token punctuation">:</span><span class="token string">":"</span><span class="token punctuation">,</span><span class="token string">"35"</span><span class="token punctuation">:</span><span class="token string">"&lt;GA>"</span><span class="token punctuation">,</span><span class="token string">"36"</span><span class="token punctuation">:</span><span class="token string">"&lt;"</span><span class="token punctuation">,</span><span class="token string">"37"</span><span class="token punctuation">:</span><span class="token string">">"</span><span class="token punctuation">,</span><span class="token string">"38"</span><span class="token punctuation">:</span><span class="token string">"?"</span><span class="token punctuation">,</span><span class="token string">"39"</span><span class="token punctuation">:</span><span class="token string">"&lt;CAP>"</span><span class="token punctuation">,</span><span class="token string">"3a"</span><span class="token punctuation">:</span><span class="token string">"&lt;F1>"</span><span class="token punctuation">,</span><span class="token string">"3b"</span><span class="token punctuation">:</span><span class="token string">"&lt;F2>"</span><span class="token punctuation">,</span> <span class="token string">"3c"</span><span class="token punctuation">:</span><span class="token string">"&lt;F3>"</span><span class="token punctuation">,</span><span class="token string">"3d"</span><span class="token punctuation">:</span><span class="token string">"&lt;F4>"</span><span class="token punctuation">,</span><span class="token string">"3e"</span><span class="token punctuation">:</span><span class="token string">"&lt;F5>"</span><span class="token punctuation">,</span><span class="token string">"3f"</span><span class="token punctuation">:</span><span class="token string">"&lt;F6>"</span><span class="token punctuation">,</span><span class="token string">"40"</span><span class="token punctuation">:</span><span class="token string">"&lt;F7>"</span><span class="token punctuation">,</span><span class="token string">"41"</span><span class="token punctuation">:</span><span class="token string">"&lt;F8>"</span><span class="token punctuation">,</span><span class="token string">"42"</span><span class="token punctuation">:</span><span class="token string">"&lt;F9>"</span><span class="token punctuation">,</span><span class="token string">"43"</span><span class="token punctuation">:</span><span class="token string">"&lt;F10>"</span><span class="token punctuation">,</span><span class="token string">"44"</span><span class="token punctuation">:</span><span class="token string">"&lt;F11>"</span><span class="token punctuation">,</span><span class="token string">"45"</span><span class="token punctuation">:</span><span class="token string">"&lt;F12>"</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># check argv</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"Usage : "</span>
        <span class="token keyword">print</span> <span class="token string">"        python UsbKeyboardHacker.py data.pcap"</span>
        <span class="token keyword">print</span> <span class="token string">"Tips : "</span>
        <span class="token keyword">print</span> <span class="token string">"        To use this python script , you must install the tshark first."</span>
        <span class="token keyword">print</span> <span class="token string">"        You can use `sudo apt-get install tshark` to install it"</span>
        <span class="token keyword">print</span> <span class="token string">"        Thank you for using."</span>
        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get argv</span>
    pcapFilePath <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># get data of pcap</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"tshark -r %s -T fields -e usb.capdata > %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pcapFilePath<span class="token punctuation">,</span> DataFileName<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># read data</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>DataFileName<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
            presses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># handle</span>
    result <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> press <span class="token keyword">in</span> presses<span class="token punctuation">:</span>
        Bytes <span class="token operator">=</span> press<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> Bytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"00"</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> Bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"00"</span><span class="token punctuation">:</span>
                result <span class="token operator">+=</span> normalKeys<span class="token punctuation">[</span>Bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> Bytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"20"</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># shift key is pressed.</span>
            <span class="token keyword">if</span> Bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"00"</span><span class="token punctuation">:</span>
                result <span class="token operator">+=</span> shiftKeys<span class="token punctuation">[</span>Bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">"[-] Unknow Key : %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Bytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"[+] Found : %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># clean the temp data</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"rm ./%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DataFileName<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/example-solved.png" alt=""></p>
<p>另外贴上一份鼠标流量数据包转换脚本：</p>
<pre class="line-numbers language-python"><code class="language-python">nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 
keys <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'usbdata.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> 
posx <span class="token operator">=</span> <span class="token number">0</span> 
posy <span class="token operator">=</span> <span class="token number">0</span> 
<span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span> 
<span class="token keyword">if</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">12</span> <span class="token punctuation">:</span> 
     <span class="token keyword">continue</span> 
x <span class="token operator">=</span> int<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> 
y <span class="token operator">=</span> int<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">127</span> <span class="token punctuation">:</span> 
    x <span class="token operator">-=</span> <span class="token number">256</span> 
<span class="token keyword">if</span> y <span class="token operator">></span> <span class="token number">127</span> <span class="token punctuation">:</span> 
    y <span class="token operator">-=</span> <span class="token number">256</span> 
posx <span class="token operator">+=</span> x 
posy <span class="token operator">+=</span> y 
btn_flag <span class="token operator">=</span> int<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 1 for left , 2 for right , 0 for nothing </span>
<span class="token keyword">if</span> btn_flag <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">:</span> 
    <span class="token keyword">print</span> posx <span class="token punctuation">,</span> posy 
keys<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>键盘流量数据包转换脚本如下：</p>
<pre class="line-numbers language-python"><code class="language-python">nums<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0x62</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x7a</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">]</span>
s<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> nums<span class="token punctuation">:</span>
    s<span class="token operator">+=</span>chr<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">print</span> s
mappings <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0x41</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">,</span>  <span class="token number">0x42</span><span class="token punctuation">:</span><span class="token string">"B"</span><span class="token punctuation">,</span>  <span class="token number">0x43</span><span class="token punctuation">:</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">:</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">:</span><span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">:</span><span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">:</span><span class="token string">"G"</span><span class="token punctuation">,</span>  <span class="token number">0x48</span><span class="token punctuation">:</span><span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">:</span><span class="token string">"I"</span><span class="token punctuation">,</span>  <span class="token number">0x4a</span><span class="token punctuation">:</span><span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token number">0x4b</span><span class="token punctuation">:</span><span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">:</span><span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token number">0x4d</span><span class="token punctuation">:</span><span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token number">0x4e</span><span class="token punctuation">:</span><span class="token string">"N"</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">:</span><span class="token string">"O"</span><span class="token punctuation">,</span>  <span class="token number">0x50</span><span class="token punctuation">:</span><span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">:</span><span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">:</span><span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">:</span><span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">:</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">:</span><span class="token string">"U"</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">:</span><span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">:</span><span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">:</span><span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">:</span><span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token number">0x5a</span><span class="token punctuation">:</span><span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">:</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">:</span><span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">:</span><span class="token string">"4"</span><span class="token punctuation">,</span>  <span class="token number">0x65</span><span class="token punctuation">:</span><span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">:</span><span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">:</span><span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">:</span><span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">:</span><span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">0x6a</span><span class="token punctuation">:</span><span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token number">0x6b</span><span class="token punctuation">:</span><span class="token string">"+"</span><span class="token punctuation">,</span>  <span class="token number">0X6c</span><span class="token punctuation">:</span><span class="token string">"separator"</span><span class="token punctuation">,</span> <span class="token number">0x6d</span><span class="token punctuation">:</span><span class="token string">"-"</span><span class="token punctuation">,</span>  <span class="token number">0x6e</span><span class="token punctuation">:</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token number">0x6f</span><span class="token punctuation">:</span><span class="token string">"/"</span> <span class="token punctuation">}</span>
output <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> n <span class="token keyword">in</span> nums<span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> n <span class="token keyword">in</span> mappings<span class="token punctuation">:</span>
        output <span class="token operator">+=</span> mappings<span class="token punctuation">[</span>n<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output <span class="token operator">+=</span> <span class="token string">'[unknown]'</span>
<span class="token keyword">print</span> <span class="token string">'output :\n'</span> <span class="token operator">+</span> output<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么对于 <code>xman</code> 三期夏令营排位赛的这道题，我们可以模仿尝试如上这个例子：</p>
<p>首先我们通过 <code>tshark</code> 将 <code>usb.capdata</code> 全部导出：</p>
<pre><code>tshark -r task_AutoKey.pcapng -T fields -e usb.capdata //如果想导入usbdata.txt文件中，后面加上参数：&gt;usbdata.txt</code></pre><p>结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/tshark-task_AutoKey.png" alt=""></p>
<p>我们用上面的 <code>python</code> 脚本将第三个字节取出来，对应对照表得到解码：</p>
<pre class="line-numbers language-python"><code class="language-python">mappings <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0x04</span><span class="token punctuation">:</span><span class="token string">"A"</span><span class="token punctuation">,</span>  <span class="token number">0x05</span><span class="token punctuation">:</span><span class="token string">"B"</span><span class="token punctuation">,</span>  <span class="token number">0x06</span><span class="token punctuation">:</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">:</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">:</span><span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">:</span><span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">:</span><span class="token string">"G"</span><span class="token punctuation">,</span>  <span class="token number">0x0B</span><span class="token punctuation">:</span><span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">:</span><span class="token string">"I"</span><span class="token punctuation">,</span>  <span class="token number">0x0D</span><span class="token punctuation">:</span><span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">:</span><span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">:</span><span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">:</span><span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">:</span><span class="token string">"N"</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">:</span><span class="token string">"O"</span><span class="token punctuation">,</span>  <span class="token number">0x13</span><span class="token punctuation">:</span><span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">:</span><span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">:</span><span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">:</span><span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">:</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">:</span><span class="token string">"U"</span><span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">:</span><span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">:</span><span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">:</span><span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">:</span><span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">:</span><span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token number">0x1E</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">:</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">:</span><span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">:</span><span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">:</span><span class="token string">"5"</span><span class="token punctuation">,</span>  <span class="token number">0x23</span><span class="token punctuation">:</span><span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">:</span><span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token number">0x25</span><span class="token punctuation">:</span><span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token number">0x26</span><span class="token punctuation">:</span><span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">:</span><span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">0x2a</span><span class="token punctuation">:</span><span class="token string">"[DEL]"</span><span class="token punctuation">,</span>  <span class="token number">0X2B</span><span class="token punctuation">:</span><span class="token string">"    "</span><span class="token punctuation">,</span> <span class="token number">0x2C</span><span class="token punctuation">:</span><span class="token string">" "</span><span class="token punctuation">,</span>  <span class="token number">0x2D</span><span class="token punctuation">:</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token number">0x2E</span><span class="token punctuation">:</span><span class="token string">"="</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">:</span><span class="token string">"["</span><span class="token punctuation">,</span>  <span class="token number">0x30</span><span class="token punctuation">:</span><span class="token string">"]"</span><span class="token punctuation">,</span>  <span class="token number">0x31</span><span class="token punctuation">:</span><span class="token string">"\\"</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">:</span><span class="token string">"~"</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">:</span><span class="token string">";"</span><span class="token punctuation">,</span>  <span class="token number">0x34</span><span class="token punctuation">:</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">:</span><span class="token string">","</span><span class="token punctuation">,</span>  <span class="token number">0x37</span><span class="token punctuation">:</span><span class="token string">"."</span> <span class="token punctuation">}</span>
nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
keys <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'usbdata.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
    <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span> <span class="token operator">or</span> line<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string">'0'</span><span class="token punctuation">:</span>
         <span class="token keyword">continue</span>
    nums<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 00:00:xx:....</span>
keys<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> n <span class="token keyword">in</span> nums<span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> n <span class="token keyword">in</span> mappings<span class="token punctuation">:</span>
        output <span class="token operator">+=</span> mappings<span class="token punctuation">[</span>n<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output <span class="token operator">+=</span> <span class="token string">'[unknown]'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'output :n'</span> <span class="token operator">+</span> output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/task_AutoKey-solved.png" alt=""></p>
<pre><code>output :n[unknown]A[unknown]UTOKEY''.DECIPHER'[unknown]MPLRVFFCZEYOUJFJKYBXGZVDGQAURKXZOLKOLVTUFBLRNJESQITWAHXNSIJXPNMPLSHCJBTYHZEALOGVIAAISSPLFHLFSWFEHJNCRWHTINSMAMBVEXO[DEL]PZE[DEL]IZ'</code></pre><p>我们可以看出这是自动密匙解码，现在的问题是在我们不知道密钥的情况下应该如何解码呢？</p>
<p>我找到了如下这篇关于如何爆破密匙：<a href="http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-autokey-cipher/" target="_blank" rel="noopener">http://www.practicalcryptography.com/cryptanalysis/stochastic-searching/cryptanalysis-autokey-cipher/</a></p>
<p>爆破脚本如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> ngram_score <span class="token keyword">import</span> ngram_score
<span class="token keyword">from</span> pycipher <span class="token keyword">import</span> Autokey
<span class="token keyword">import</span> re
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> permutations

qgram <span class="token operator">=</span> ngram_score<span class="token punctuation">(</span><span class="token string">'quadgrams.txt'</span><span class="token punctuation">)</span>
trigram <span class="token operator">=</span> ngram_score<span class="token punctuation">(</span><span class="token string">'trigrams.txt'</span><span class="token punctuation">)</span>

ctext <span class="token operator">=</span> <span class="token string">'MPLRVFFCZEYOUJFJKYBXGZVDGQAURKXZOLKOLVTUFBLRNJESQITWAHXNSIJXPNMPLSHCJBTYHZEALOGVIAAISSPLFHLFSWFEHJNCRWHTINSMAMBVEXPZIZ'</span>

ctext <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>r<span class="token string">'[^A-Z]'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span>ctext<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># keep a list of the N best things we have seen, discard anything else</span>

<span class="token keyword">class</span> <span class="token class-name">nbest</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>N<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>store <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>N <span class="token operator">=</span> N

    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>store<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>store<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>store <span class="token operator">=</span> self<span class="token punctuation">.</span>store<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>N<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>store<span class="token punctuation">[</span>k<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>store<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#init</span>
N<span class="token operator">=</span><span class="token number">100</span>
<span class="token keyword">for</span> KLEN <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rec <span class="token operator">=</span> nbest<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> permutations<span class="token punctuation">(</span><span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span>KLEN<span class="token operator">-</span>len<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pt <span class="token operator">=</span> Autokey<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>decipher<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span>
        score <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span class="token punctuation">,</span>KLEN<span class="token punctuation">)</span><span class="token punctuation">:</span>
            score <span class="token operator">+=</span> trigram<span class="token punctuation">.</span>score<span class="token punctuation">(</span>pt<span class="token punctuation">[</span>j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        rec<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>pt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    next_rec <span class="token operator">=</span> nbest<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>KLEN<span class="token number">-3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">:</span>
                key <span class="token operator">=</span> rec<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> c
                fullkey <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span>KLEN<span class="token operator">-</span>len<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                pt <span class="token operator">=</span> Autokey<span class="token punctuation">(</span>fullkey<span class="token punctuation">)</span><span class="token punctuation">.</span>decipher<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span>
                score <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span class="token punctuation">,</span>KLEN<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    score <span class="token operator">+=</span> qgram<span class="token punctuation">.</span>score<span class="token punctuation">(</span>pt<span class="token punctuation">[</span>j<span class="token punctuation">:</span>j<span class="token operator">+</span>len<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                next_rec<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span>key<span class="token punctuation">,</span>pt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        rec <span class="token operator">=</span> next_rec
        next_rec <span class="token operator">=</span> nbest<span class="token punctuation">(</span>N<span class="token punctuation">)</span>
    bestkey <span class="token operator">=</span> rec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    pt <span class="token operator">=</span> Autokey<span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">.</span>decipher<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span>
    bestscore <span class="token operator">=</span> qgram<span class="token punctuation">.</span>score<span class="token punctuation">(</span>pt<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pt <span class="token operator">=</span> Autokey<span class="token punctuation">(</span>rec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decipher<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span>
        score <span class="token operator">=</span> qgram<span class="token punctuation">.</span>score<span class="token punctuation">(</span>pt<span class="token punctuation">)</span>
        <span class="token keyword">if</span> score <span class="token operator">></span> bestscore<span class="token punctuation">:</span>
            bestkey <span class="token operator">=</span> rec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            bestscore <span class="token operator">=</span> score       
    <span class="token keyword">print</span> bestscore<span class="token punctuation">,</span><span class="token string">'autokey, klen'</span><span class="token punctuation">,</span>KLEN<span class="token punctuation">,</span><span class="token string">':"'</span><span class="token operator">+</span>bestkey<span class="token operator">+</span><span class="token string">'",'</span><span class="token punctuation">,</span>Autokey<span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">.</span>decipher<span class="token punctuation">(</span>ctext<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>跑出来的结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/usbpwn.png" alt=""></p>
<p>我们看到了 <code>flag</code> 的字样，整理可得如下：</p>
<pre><code>-674.914569565 autokey, klen 8 :"FLAGHERE", HELLOBOYSANDGIRLSYOUARESOSMARTTHATYOUCANFINDTHEFLAGTHATIHIDEINTHEKEYBOARDPACKAGEFLAGISJHAWLZKEWXHNCDHSLWBAQJTUQZDXZQPF</code></pre><p>我们把字段进行分割看：</p>
<pre><code>HELLO
BOYS
AND
GIRLS
YOU
ARE
SO
SMART
THAT
YOU
CAN
FIND
THE
FLAG
THAT
IH
IDE
IN
THE
KEY
BOARD
PACKAGE
FLAG
IS
JHAWLZKEWXHNCDHSLWBAQJTUQZDXZQPF</code></pre><p>最后的 <code>flag</code> 就是 <code>flag{JHAWLZKEWXHNCDHSLWBAQJTUQZDXZQPF}</code></p>
<h1 id="压缩包分析"><a href="#压缩包分析" class="headerlink" title="压缩包分析"></a>压缩包分析</h1><h2 id="ZIP-格式"><a href="#ZIP-格式" class="headerlink" title="ZIP 格式"></a>ZIP 格式</h2><h3 id="文件结构-2"><a href="#文件结构-2" class="headerlink" title="文件结构"></a>文件结构</h3><p><code>ZIP</code> 文件主要由三部分构成，分别为</p>
<table>
<thead>
<tr>
<th align="left">压缩源文件数据区</th>
<th align="left">核心目录</th>
<th align="left">目录结束</th>
</tr>
</thead>
<tbody><tr>
<td align="left">local file header + file data + data descriptor</td>
<td align="left">central directory</td>
<td align="left">end of central directory record</td>
</tr>
</tbody></table>
<ul>
<li><p>压缩源文件数据区中每一个压缩的源文件或目录都是一条记录，其中</p>
<ul>
<li><code>local file header</code> ：文件头用于标识该文件的开始，记录了该压缩文件的信息，这里的文件头标识由固定值 <code>50 4B 03 04</code> 开头，也是 <code>ZIP</code> 的文件头的重要标志</li>
<li><code>file data</code> ：文件数据记录了相应压缩文件的数据</li>
<li><code>data descriptor</code> ：数据描述符用于标识该文件压缩结束，该结构只有在相应的 <code>local file header</code> 中通用标记字段的第 <code>3 bit</code> 设为 <code>1</code> 时才会出现，紧接在压缩文件源数据后</li>
</ul>
</li>
<li><p><code>Central directory</code> 核心目录</p>
</li>
<li><p>记录了压缩文件的目录信息，在这个数据区中每一条纪录对应在压缩源文件数据区中的一条数据。</p>
<table>
<thead>
<tr>
<th align="left">Offset</th>
<th align="left">Bytes</th>
<th align="left">Description</th>
<th align="left">译</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">4</td>
<td align="left">Central directory file header signature = 0x02014b50</td>
<td align="left">核心目录文件 header 标识 =（0x02014b50）</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">2</td>
<td align="left">Version made by</td>
<td align="left">压缩所用的 pkware 版本</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">2</td>
<td align="left">Version needed to extract (minimum)</td>
<td align="left">解压所需 pkware 的最低版本</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left">2</td>
<td align="left">General purpose bit flag</td>
<td align="left">通用位标记伪加密</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left">2</td>
<td align="left">Compression method</td>
<td align="left">压缩方法</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left">2</td>
<td align="left">File last modification time</td>
<td align="left">文件最后修改时间</td>
</tr>
<tr>
<td align="left">14</td>
<td align="left">2</td>
<td align="left">File last modification date</td>
<td align="left">文件最后修改日期</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left">4</td>
<td align="left">CRC-32</td>
<td align="left">CRC-32 校验码</td>
</tr>
<tr>
<td align="left">20</td>
<td align="left">4</td>
<td align="left">Compressed size</td>
<td align="left">压缩后的大小</td>
</tr>
<tr>
<td align="left">24</td>
<td align="left">4</td>
<td align="left">Uncompressed size</td>
<td align="left">未压缩的大小</td>
</tr>
<tr>
<td align="left">28</td>
<td align="left">2</td>
<td align="left">File name length (n)</td>
<td align="left">文件名长度</td>
</tr>
<tr>
<td align="left">30</td>
<td align="left">2</td>
<td align="left">Extra field length (m)</td>
<td align="left">扩展域长度</td>
</tr>
<tr>
<td align="left">32</td>
<td align="left">2</td>
<td align="left">File comment length (k)</td>
<td align="left">文件注释长度</td>
</tr>
<tr>
<td align="left">34</td>
<td align="left">2</td>
<td align="left">Disk number where file starts</td>
<td align="left">文件开始位置的磁盘编号</td>
</tr>
<tr>
<td align="left">36</td>
<td align="left">2</td>
<td align="left">Internal file attributes</td>
<td align="left">内部文件属性</td>
</tr>
<tr>
<td align="left">38</td>
<td align="left">4</td>
<td align="left">External file attributes</td>
<td align="left">外部文件属性</td>
</tr>
<tr>
<td align="left">42</td>
<td align="left">4</td>
<td align="left">relative offset of local header</td>
<td align="left">本地文件头的相对位移</td>
</tr>
<tr>
<td align="left">46</td>
<td align="left">n</td>
<td align="left">File name</td>
<td align="left">目录文件名</td>
</tr>
<tr>
<td align="left">46+n</td>
<td align="left">m</td>
<td align="left">Extra field</td>
<td align="left">扩展域</td>
</tr>
<tr>
<td align="left">46+n+m</td>
<td align="left">k</td>
<td align="left">File comment</td>
<td align="left">文件注释内容</td>
</tr>
</tbody></table>
</li>
<li><p><code>End of central directory record(EOCD)</code> 目录结束标识</p>
</li>
<li><p>目录结束标识存在于整个归档包的结尾，用于标记压缩的目录数据的结束。每个压缩文件必须有且只有一个 <code>EOCD</code> 记录。</p>
</li>
</ul>
<p>更加详细参见 <a href="https://pkware.cachefly.net/webdocs/APPNOTE/APPNOTE-6.2.0.txt" target="_blank" rel="noopener">官方文档</a>。</p>
<h3 id="主要攻击"><a href="#主要攻击" class="headerlink" title="主要攻击"></a>主要攻击</h3><h4 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h4><p>这里主要介绍两款爆破使用的工具</p>
<ul>
<li><p><code>Windows</code>下的神器 <a href="http://www.downcc.com/soft/130539.html" target="_blank" rel="noopener">ARCHPR</a></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/1.png" alt=""></p>
<p>暴力枚举，跑字典，明文攻击，应有尽有。</p>
</li>
<li><p><code>Linux</code> 下的命令行工具 <a href="https://github.com/hyc/fcrackzip" target="_blank" rel="noopener">fcrackzip</a></p>
<pre><code># －b 指定模式为暴破，-c1指定密码类型为纯数字，其它类型可以rtfm,-u这个参数非常重要不然不显示破解出来的密码,-l 5-6可以指定长度
root@kali:fcrackzip -b -c1 -u test.zip</code></pre></li>
</ul>
<h4 id="CRC32"><a href="#CRC32" class="headerlink" title="CRC32"></a>CRC32</h4><h5 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h5><p><code>CRC</code> 本身是「冗余校验码」的意思，<code>CRC32</code> 则表示会产生一个 <code>32 bit</code> ( <code>8</code> 位十六进制数) 的校验值。由于 <code>CRC32</code> 产生校验值时源数据块的每一个 <code>bit</code> (位) 都参与了计算，所以数据块中即使只有一位发生了变化，也会得到不同的 <code>CRC32</code> 值。</p>
<p><code>CRC32</code> 校验码出现在很多文件中比如 <code>png</code> 文件，同样 <code>zip</code> 中也有 <code>CRC32</code> 校验码。值得注意的是 <code>zip</code> 中的 <code>CRC32</code> 是未加密文件的校验值。</p>
<p>这也就导致了基于 <code>CRC32</code> 的攻击手法。</p>
<ul>
<li>文件内内容很少 (一般比赛中大多为 <code>4</code> 字节左右)</li>
<li>加密的密码很长</li>
</ul>
<p>我们不去爆破压缩包的密码，而是直接去爆破源文件的内容 (一般都是可见的字符串)，从而获取想要的信息。</p>
<p>比如我们新建一个 <code>flag.txt</code>，其中内容为 <code>123</code>，使用密码 <code>!QAZXSW@#EDCVFR$</code> 去加密。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/2.png" alt=""></p>
<p>而我们去计算文件的 <code>CRC32</code> 值发现和上图中的 <code>CRC32</code> 值吻合。</p>
<pre><code>文件: flag.txt
大小: 3
时间: Tue, 29 Aug 2017 10:38:10 +0800
MD5: 202cb962ac59075b964b07152d234b70
SHA1: 40bd001563085fc35165329ea1ff5c5ecbdbbeef
CRC32: 884863D2</code></pre><p>Note</p>
<p> 在爆破时我们所枚举的所有可能字符串的 <code>CRC32</code> 值是要与压缩源文件数据区中的 <code>CRC32</code> 值所对应</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> string
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> struct

alph <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/='</span>

crcdict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">print</span> <span class="token string">"computing all possible CRCs..."</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span>list<span class="token punctuation">(</span>alph<span class="token punctuation">)</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    st <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    testcrc <span class="token operator">=</span> binascii<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>st<span class="token punctuation">)</span>
    crcdict<span class="token punctuation">[</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&lt;i'</span><span class="token punctuation">,</span> testcrc<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> st
<span class="token keyword">print</span> <span class="token string">"Done!"</span>

f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'flag.zip'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
crc <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> crc <span class="token keyword">in</span> crcdict<span class="token punctuation">:</span>
    <span class="token keyword">print</span> crcdict<span class="token punctuation">[</span>crc<span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">"FAILED!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="例题-13"><a href="#例题-13" class="headerlink" title="例题"></a>例题</h5><blockquote>
<p>题目：<code>Abctf-2016:Zippy</code></p>
</blockquote>
<p>根据每个压缩包内的文件大小可以推断使用 <code>CRC32</code> 攻击手法，获得每个压缩包内的内容后连在一起 <code>Base64</code> 解码后是一个加密的压缩包，爆破获得 <code>flag</code>。</p>
<h4 id="明文攻击"><a href="#明文攻击" class="headerlink" title="明文攻击"></a>明文攻击</h4><h5 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h5><ul>
<li>一个加密的压缩文件</li>
<li>压缩文件的压缩工具，比如 <code>2345</code> 好压， <code>WinRAR</code> ， <code>7z</code> 。 <code>zip</code> 版本号等，可以通过文件属性了解。如果是 <code>Linux</code> 平台，用 <code>zipinfo -v</code> 可以查看一个 <code>zip</code> 包的详细信息，包括加密算法等</li>
<li>知道压缩包里某个文件的部分连续内容 (至少 <code>12</code> 字节)</li>
</ul>
<p>如果你已经知道加密文件的部分内容，比如在某个网站上发现了它的 <code>readme.txt</code> 文件，你就可以开始尝试破解了。</p>
<p>首先，将这个明文文件打包成 <code>zip</code> 包，比如将 <code>readme.txt</code> 打包成 <code>readme.zip</code> 。</p>
<p>打包完成后，需要确认二者采用的压缩算法相同。一个简单的判断方法是用 <code>WinRAR</code> 打开文件，同一个文件压缩后的体积是否相同。如果相同，基本可以说明你用的压缩算法是正确的。如果不同，就尝试另一种压缩算法。</p>
<h5 id="工具-6"><a href="#工具-6" class="headerlink" title="工具"></a>工具</h5><ul>
<li>Windows 下的神器 <a href="http://www.downcc.com/soft/130539.html" target="_blank" rel="noopener">ARCHPR</a></li>
<li>Linux 下的 <a href="http://www.unix-ag.uni-kl.de/~conrad/krypto/pkcrack.html" target="_blank" rel="noopener">PKCrack</a></li>
</ul>
<p>Note</p>
<p> 建议使用 <code>Windows</code> 的 <code>ARCHPR</code>，一是速度较快，二是较稳定（之前出题时遇到过用 <code>PKCrack</code> 爆不出来的情况）。</p>
<h5 id="例题-14"><a href="#例题-14" class="headerlink" title="例题"></a>例题</h5><blockquote>
<p>2015 广州强网杯：爆破？</p>
<p>WP：<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9884416.html" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9884416.html</a></p>
</blockquote>
<p>首先我们拿到这样一道题，题目标题为<strong>爆破?</strong>，很明显这题肯定是要用到一个破解工具，很暴力的说。</p>
<p><strong>第一步、分析压缩包文件</strong></p>
<p>我们下载了这个压缩包以后，我们看到文件名是 <strong>*.zip</strong> 结尾，我们可以立即想到破解压缩包常用的几种方式，我们将其压缩包解压出来，发现里面有两个文件，分别为 <code>Desktop.zip</code> 和 <code>readme.txt</code> ，我们看看 <code>readme.txt</code> 里面写了什么？</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/readme.png" alt=""></p>
<p>打开以后竟然是<code>qianwanbuyaogeixuanshoukandao!!!</code> ，出题人不想让选手看到，这出题人还是有点意思。我们再看看那个 <code>Desktop.zip</code> ，我们可以看到里面有个 <code>readme.txt</code> 文件和 <code>answer</code> 文件夹， <code>answer</code> 文件夹下有 <code>key.txt</code> 文件， <code>flag</code> 应该就藏在这里了。</p>
<p><strong>第二步、分析破解方式</strong></p>
<p>这题目拿到手上，我们首先发现解压出来的文件和 <code>Desktop.zip</code> 压缩包中都含有同样一个文件 <code>readme.txt</code> ，而且并没有给出其他相关信息，且文件大小大于 <code>12Byte</code> ，我们再对比压缩包中的 <code>readme.txt</code> 和原压缩包中的 <code>readme.txt</code> 的 <code>CRC32</code> 的值，我们发现两个值相同，这说明解压出的 <code>readme.txt</code> 是加密压缩包里的 <code>readme.txt</code> 的明文，于是我们可以大胆地猜测这极可能是个明文加密。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/compare.png" alt=""></p>
<p><strong>第三步、尝试明文攻击</strong></p>
<p>既然我们已经知道了它是明文攻击的话，我们将对其压缩包进行破解，由于解压出的 readme.txt 是加密压缩包里的 <code>readme.txt</code> 的明文，将 <code>readme.txt</code> 压缩成 <strong>.zip</strong> 文件，然后在软件中填入相应的路径即可开始进行明文攻击，这里我们将介绍 <code>Windows</code> 和 <code>Ubuntu</code> 下使用不同的方式进行明文攻击。</p>
<p>方法一、 <code>pkcrack</code> 进行明文攻击</p>
<p><code>pkcrack</code> 下载链接：<a href="https://www.unix-ag.uni-kl.de/~conrad/krypto/pkcrack.html" target="_blank" rel="noopener">https://www.unix-ag.uni-kl.de/~conrad/krypto/pkcrack.html</a></p>
<p>我们可以直接写个 <code>shell</code> 脚本下载就好了：</p>
<pre><code>#!/bin/bash -ex

wget https://www.unix-ag.uni-kl.de/~conrad/krypto/pkcrack/pkcrack-1.2.2.tar.gz
tar xzf pkcrack-1.2.2.tar.gz
cd pkcrack-1.2.2/src
make

mkdir -p ../../bin
cp extract findkey makekey pkcrack zipdecrypt ../../bin
cd ../../</code></pre><p>把文件保存，改为 <code>pkcrack-install.sh</code> ，然后跑到当前目录下，给它加一个执行权限 <code>x</code> 。</p>
<pre><code>chmod 777 install.sh</code></pre><p>或者直接可以：</p>
<pre><code>chmod u+x install.sh</code></pre><p>然后运行 <code>./pkcrack-install.sh</code></p>
<p><img src="/images/loading.gif" data-original="https://ctf-wiki.org/misc/archive/figure/install-pkcrack.png" alt="install-pkcrack"></p>
<p>然后当前目录下会生成一个 <code>bin</code> 的文件夹，我们直接进入 <code>bin</code> 文件夹下，看到有 <code>pkcrack</code> 文件，直接对文件进行明文破解。</p>
<pre><code>./pkcrack -c "readme.txt" -p readme.txt  -C ~/下载/misc/Desktop.zip -P ~/下载/misc/readme.zip -d ~/decrypt.zip</code></pre><p>我们所用到的参数选项如下：</p>
<pre><code>-C:要破解的目标文件(含路径)

-c:破解文件中的明文文件的名字(其路径不包括系统路径,从zip文件一层开始)

-P:压缩后的明文文件

-p:压缩的明文文件中明文文件的名字(也就是readme.txt在readme.zip中的位置)
-d:指定文件名及所在的绝对路径，将解密后的zip文件输出</code></pre><p>至于其他选项参看 <code>./pkcrack --help</code></p>
<p>解密后的结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pkcrack-to-flag-01.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pkcrack-to-flag-02.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pkcrack-to-flag-03.png" alt=""></p>
<p><img src="/images/loading.gif" data-original="../images/CTF/pkcrack-to-flag-04.png" alt=""></p>
<p>我们可以看到，我们下午 <code>1:10</code> 开始跑的，下午 <code>3:27</code> 才求解出秘钥。</p>
<p>我们得出了最终的 flag 为：<strong><code>flag{7ip_Fi13_S0m3tim3s_s0_3a5y@}</code></strong></p>
<p><strong>坑点来了</strong></p>
<p>看起来一切都很顺利的样子，同样花了两个多小时，为啥我在博客园上写了我跑了两个小时都没跑出来呢？或者说有朋友遇到了和我一样的问题，我明明和你是一样的，为啥我跑不出结果？</p>
<p>你们可能忽略了一些细节问题，有人曾想过原压缩包是通过什么方式压缩的嘛？还有就是我们生成的 <code>readme.zip</code> 又该以哪种方式去生成呢？我就是因为这个问题卡了整整三个月没做出来，不信的话我们可以看看第二种方法，在 <code>Windows</code> 下用 <code>ARCHPR</code> 进行明文攻击。</p>
<p>方法二、 <code>ARCHPR</code> 进行明文攻击</p>
<p>首先这题我建议大家下 <code>ARCHPR 4.53</code> 版本，我是在这个版本下测试成功的。成功截图如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/success.jpg" alt=""></p>
<p>我相信很多朋友在用 <code>ARCHPR</code> 的时候遇到以下这种情况：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/error.png" alt=""></p>
<p>我当时内心是崩溃的，为啥会出现这种情况。</p>
<p>在后来的学习中发现，用 <code>7z</code> 压缩的文件得用 <code>7z</code> 来解压缩， <code>7z</code> 是一种使用多种压缩算法进行数据压缩的档案格式，和传统的 <code>zip</code> ， <code>rar</code> 相比，它的压缩比率更大，采用的压缩算法不同，自然而然就可能出现不匹配这种情况，所以我们在解压缩原压缩包和对文件进行加密的时候得先分析出题人是用什么方式进行加解密的，所以这题的问题显而易见就出来了，经过验证，我发现出题人是用 <code>7z</code> 进行压缩的。</p>
<p><strong>再尝试</strong></p>
<p>我们已经发现了这个问题，我们去官网下载 <code>7zip</code> ：<a href="https://www.7-zip.org/" target="_blank" rel="noopener">https://www.7-zip.org/</a></p>
<p>然后我们对原压缩文件用 <code>7z</code> 进行解压缩，然后将 <code>readme.txt</code> 用 7z 进行压缩即可。然后我们就可以用 <code>ARCHPR</code> 进行明文攻击了。</p>
<p>结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/attack-success.png" alt=""></p>
<p>我们将 <code>Desktop_decrypted.zip</code> 解压出来，查看 <code>answer</code> 目录下的 <code>key.txt</code> 即可。</p>
<p>所以最终的 flag 为：<strong><code>flag{7ip_Fi13_S0m3tim3s_s0_3a5y@}</code></strong></p>
<h4 id="伪加密"><a href="#伪加密" class="headerlink" title="伪加密"></a>伪加密</h4><h5 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h5><p>在上文 <code>ZIP</code> 格式中的 <strong>核心目录区</strong> 中，我们强调了一个叫做通用位标记 <code>(General purpose bit flag)</code> 的 <code>2</code> 字节，不同比特位有着不同的含义。</p>
<pre><code>Bit 0: If set, indicates that the file is encrypted.

(For Method 6 - Imploding)
Bit 1: If the compression method used was type 6,
     Imploding, then this bit, if set, indicates
     an 8K sliding dictionary was used.  If clear,
     then a 4K sliding dictionary was used.
...
Bit 6: Strong encryption.  If this bit is set, you should
     set the version needed to extract value to at least
     50 and you must also set bit 0.  If AES encryption
     is used, the version needed to extract value must
     be at least 51.
...</code></pre><p>在 <code>010Editor</code> 中我们尝试着将这 <code>1</code> 位修改 <code>0 --&gt; 1</code>。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/4.png" alt=""></p>
<p>再打开文件发现已要求输入密码。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/5.png" alt=""></p>
<p>修改伪加密的方法：</p>
<ul>
<li><code>16</code> 进制下修改通用位标记</li>
<li><code>binwalk -e</code> 无视伪加密</li>
<li>在 <code>Mac OS</code> 及部分 <code>Linux</code>(如 <code>Kali</code> ) 系统中，可以直接打开伪加密的 <code>ZIP</code> 压缩包</li>
<li>检测伪加密的小工具 <code>ZipCenOp.jar</code></li>
<li>有时候用 <code>WinRar</code> 的修复功能（此方法有时有奇效，不仅针对伪加密）</li>
</ul>
<h5 id="例题-15"><a href="#例题-15" class="headerlink" title="例题"></a>例题</h5><blockquote>
<p><code>SSCTF-2017</code> ：我们的秘密是绿色的</p>
<p><code>WP</code>：<a href="http://bobao.360.cn/ctf/detail/197.html" target="_blank" rel="noopener">http://bobao.360.cn/ctf/detail/197.html</a></p>
</blockquote>
<p>我们在得到两个 <code>readme.txt</code>，且一个加密，一个已知，很容易想到明文攻击的手法。</p>
<p>注意在用明文攻击时的操作。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/3.png" alt=""></p>
<p>得到密码 <code>Y29mZmVl</code> 后，解压缩文件，得到另一个压缩包。</p>
<p>观察通用位标记位，猜测伪加密，修改后解压得到 flag。</p>
<p>这一题，基本涵盖了比赛中 ZIP 的常见考察手法，爆破，伪加密，明文攻击等，都在本题中出现。</p>
<h2 id="RAR-格式"><a href="#RAR-格式" class="headerlink" title="RAR 格式"></a>RAR 格式</h2><h3 id="文件格式-1"><a href="#文件格式-1" class="headerlink" title="文件格式"></a>文件格式</h3><p>RAR 文件主要由标记块，压缩文件头块，文件头块，结尾块组成。</p>
<p>其每一块大致分为以下几个字段：</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">大小</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">HEAD_CRC</td>
<td align="left">2</td>
<td align="left">全部块或块部分的 CRC</td>
</tr>
<tr>
<td align="left">HEAD_TYPE</td>
<td align="left">1</td>
<td align="left">块类型</td>
</tr>
<tr>
<td align="left">HEAD_FLAGS</td>
<td align="left">2</td>
<td align="left">阻止标志</td>
</tr>
<tr>
<td align="left">HEAD_SIZE</td>
<td align="left">2</td>
<td align="left">块大小</td>
</tr>
<tr>
<td align="left">ADD_SIZE</td>
<td align="left">4</td>
<td align="left">可选字段 - 添加块大小</td>
</tr>
</tbody></table>
<p>Rar 压缩包的文件头为 <code>0x 52 61 72 21 1A 07 00</code>。</p>
<p>紧跟着文件头（0x526172211A0700）的是标记块（MARK_HEAD），其后还有文件头（File Header）。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">大小</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">HEAD_CRC</td>
<td align="left">2</td>
<td align="left">CRC of fields from HEAD_TYPE to FILEATTR and file name</td>
</tr>
<tr>
<td align="left">HEAD_TYPE</td>
<td align="left">1</td>
<td align="left">Header Type: 0x74</td>
</tr>
<tr>
<td align="left">HEAD_FLAGS</td>
<td align="left">2</td>
<td align="left">Bit Flags (Please see ‘Bit Flags for File in Archive’ table for all possibilities)（伪加密）</td>
</tr>
<tr>
<td align="left">HEAD_SIZE</td>
<td align="left">2</td>
<td align="left">File header full size including file name and comments</td>
</tr>
<tr>
<td align="left">PACK_SIZE</td>
<td align="left">4</td>
<td align="left">Compressed file size</td>
</tr>
<tr>
<td align="left">UNP_SIZE</td>
<td align="left">4</td>
<td align="left">Uncompressed file size</td>
</tr>
<tr>
<td align="left">HOST_OS</td>
<td align="left">1</td>
<td align="left">Operating system used for archiving (See the ‘Operating System Indicators’ table for the flags used)</td>
</tr>
<tr>
<td align="left">FILE_CRC</td>
<td align="left">4</td>
<td align="left">File CRC</td>
</tr>
<tr>
<td align="left">FTIME</td>
<td align="left">4</td>
<td align="left">Date and time in standard MS DOS format</td>
</tr>
<tr>
<td align="left">UNP_VER</td>
<td align="left">1</td>
<td align="left">RAR version needed to extract file (Version number is encoded as 10 * Major version + minor version.)</td>
</tr>
<tr>
<td align="left">METHOD</td>
<td align="left">1</td>
<td align="left">Packing method (Please see ‘Packing Method’ table for all possibilities</td>
</tr>
<tr>
<td align="left">NAME_SIZE</td>
<td align="left">2</td>
<td align="left">File name size</td>
</tr>
<tr>
<td align="left">ATTR</td>
<td align="left">4</td>
<td align="left">File attributes</td>
</tr>
<tr>
<td align="left">HIGH_PACK_SIZ</td>
<td align="left">4</td>
<td align="left">High 4 bytes of 64-bit value of compressed file size. Optional value, presents only if bit 0x100 in HEAD_FLAGS is set.</td>
</tr>
<tr>
<td align="left">HIGH_UNP_SIZE</td>
<td align="left">4</td>
<td align="left">High 4 bytes of 64-bit value of uncompressed file size. Optional value, presents only if bit 0x100 in HEAD_FLAGS is set.</td>
</tr>
<tr>
<td align="left">FILE_NAME</td>
<td align="left">NAME_SIZE bytes</td>
<td align="left">File name - string of NAME_SIZE bytes size</td>
</tr>
<tr>
<td align="left">SALT</td>
<td align="left">8</td>
<td align="left">present if (HEAD_FLAGS &amp; 0x400) != 0</td>
</tr>
<tr>
<td align="left">EXT_TIME</td>
<td align="left">variable size</td>
<td align="left">present if (HEAD_FLAGS &amp; 0x1000) != 0</td>
</tr>
</tbody></table>
<p>每个 RAR 文件的结尾快（Terminator）都是固定的。</p>
<table>
<thead>
<tr>
<th align="left">Field Name</th>
<th align="left">Size (bytes)</th>
<th align="left">Possibilities</th>
</tr>
</thead>
<tbody><tr>
<td align="left">HEAD_CRC</td>
<td align="left">2</td>
<td align="left">Always 0x3DC4</td>
</tr>
<tr>
<td align="left">HEAD_TYPE</td>
<td align="left">1</td>
<td align="left">Header type: 0x7b</td>
</tr>
<tr>
<td align="left">HEAD_FLAGS</td>
<td align="left">2</td>
<td align="left">Always 0x4000</td>
</tr>
<tr>
<td align="left">HEAD_SIZE</td>
<td align="left">2</td>
<td align="left">Block size = 0x0007</td>
</tr>
</tbody></table>
<p>更多详见 <a href="https://forensicswiki.xyz/wiki/index.php?title=RAR" target="_blank" rel="noopener">https://forensicswiki.xyz/wiki/index.php?title=RAR</a></p>
<h3 id="主要攻击-1"><a href="#主要攻击-1" class="headerlink" title="主要攻击"></a>主要攻击</h3><h4 id="爆破-1"><a href="#爆破-1" class="headerlink" title="爆破"></a>爆破</h4><ul>
<li>Linux 下的 <a href="http://rarcrack.sourceforge.net/" target="_blank" rel="noopener">RarCrack</a></li>
</ul>
<h4 id="伪加密-1"><a href="#伪加密-1" class="headerlink" title="伪加密"></a>伪加密</h4><p>RAR 文件的伪加密在文件头中的位标记字段上，用 010 Editor 可以很清楚的看见这一位，修改这一位可以造成伪加密。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/6.png" alt=""></p>
<p>其余明文攻击等手法依旧同 ZIP 中介绍的一样。</p>
<h1 id="磁盘内存分析"><a href="#磁盘内存分析" class="headerlink" title="磁盘内存分析"></a>磁盘内存分析</h1><h2 id="常用工具-1"><a href="#常用工具-1" class="headerlink" title="常用工具"></a>常用工具</h2><ul>
<li>EasyRecovery</li>
<li>MedAnalyze</li>
<li>FTK</li>
<li>Elcomsoft Forensic Disk Decryptor</li>
<li>Volatility</li>
</ul>
<h2 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h2><p>常见的磁盘分区格式有以下几种</p>
<ul>
<li><p>Windows: FAT12 -&gt; FAT16 -&gt; FAT32 -&gt; NTFS</p>
</li>
<li><p>Linux: EXT2 -&gt; EXT3 -&gt; EXT4</p>
</li>
<li><p>FAT 主磁盘结构</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/forensic-filesys.jpg" alt=""></p>
</li>
<li><p>删除文件：目录表中文件名第一字节 <code>e5</code>。</p>
</li>
</ul>
<h2 id="VMDK"><a href="#VMDK" class="headerlink" title="VMDK"></a>VMDK</h2><p>VMDK 文件本质上是物理硬盘的虚拟版，也会存在跟物理硬盘的分区和扇区中类似的填充区域，我们可以利用这些填充区域来把我们需要隐藏的数据隐藏到里面去，这样可以避免隐藏的文件增加了 VMDK 文件的大小（如直接附加到文件后端），也可以避免由于 VMDK 文件大小的改变所带来的可能导致的虚拟机错误。而且 VMDK 文件一般比较大，适合用于隐藏大文件。</p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><ul>
<li>解析 Windows / Linux / Mac OS X 内存结构</li>
<li>分析进程，内存数据</li>
<li>根据题目提示寻找线索和思路，提取分析指定进程的特定内存数据</li>
</ul>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="2018-网鼎杯第一场-clip"><a href="#2018-网鼎杯第一场-clip" class="headerlink" title="2018 网鼎杯第一场 clip"></a>2018 网鼎杯第一场 clip</h3><p>通过 010 editor 可以看到文件的头部包含有 cloop 字样，搜了搜发现这是一个古老的 linux 压缩后的设备，题目中又说这个设备损坏了，所以就想办法找一个正常的。于是搜索如何压缩得到一个 cloop 文件，如下</p>
<pre><code>mkisofs -r test | create_compressed_fs - 65536 &gt; test.cloop</code></pre><p>参考 <a href="https://github.com/KlausKnopper/cloop，于是压缩一个文件，然后发现源文件文件头存在问题，于是进行修复，从而考虑如何从" target="_blank" rel="noopener">https://github.com/KlausKnopper/cloop，于是压缩一个文件，然后发现源文件文件头存在问题，于是进行修复，从而考虑如何从</a> cloop 文件中提取文件，即使用</p>
<pre><code>extract_compressed_fs test.cloop now</code></pre><p>参考 <a href="https://manned.org/create_compressed_fs/f2f838da。" target="_blank" rel="noopener">https://manned.org/create_compressed_fs/f2f838da。</a></p>
<p>得到一个 ext4 类型的文件，进一步想办法获取这个文件系统的内容</p>
<pre><code>➜  clip losetup -d /dev/loop0
losetup: /dev/loop0: detach failed: Permission denied
➜  clip sudo losetup -d /dev/loop0
➜  clip sudo losetup /dev/loop0 now                                                 
losetup: now: failed to set up loop device: Device or resource busy
➜  clip sudo losetup /dev/loop0 /home/iromise/ctf/2018/0820网鼎杯/misc/clip/now        
losetup: /home/iromise/ctf/2018/0820网鼎杯/misc/clip/now: failed to set up loop device: Device or resource busy
➜  clip losetup -f           
/dev/loop10
➜  clip sudo losetup /dev/loop10 /home/iromise/ctf/2018/0820网鼎杯/misc/clip/now
➜  clip sudo mount /dev/loop10 /mnt/now
➜  clip cd /mnt/now 
➜  now ls        
clip-clip.png  clip-clop.png  clop-clip.png  clop-clop.jpg  flag.png</code></pre><p>最后一步就是修复 flag 了。就是少了文件头那几个字符。</p>
<h1 id="pyc-文件"><a href="#pyc-文件" class="headerlink" title="pyc 文件"></a>pyc 文件</h1><blockquote>
<p>在我们导入 python 脚本时在目录下会生成个一个相应的 pyc 文件，是 pythoncodeobj 的持久化储存形式, 加速下一次的装载。</p>
</blockquote>
<h2 id="文件结构-3"><a href="#文件结构-3" class="headerlink" title="文件结构"></a>文件结构</h2><p>pyc 文件由三大部分组成</p>
<ul>
<li>最开始 4 个字节是一个 Maigc int, 标识此 pyc 的版本信息</li>
<li>接下来四个字节还是个 int, 是 pyc 产生的时间</li>
<li>序列化的 PyCodeObject, 结构参照 <a href="https://github.com/python/cpython/blob/master/Include/code.h" target="_blank" rel="noopener">include/code.h</a>, 序列化方法 <a href="https://github.com/python/cpython/blob/master/Python/marshal.c" target="_blank" rel="noopener">python/marshal</a></li>
</ul>
<p><strong>pyc 完整的文件解析可以参照</strong></p>
<ul>
<li><a href="http://python.jobbole.com/84599/" target="_blank" rel="noopener">Python 程序的执行原理</a></li>
<li><a href="http://kdr2.com/tech/python/pyc-format.html" target="_blank" rel="noopener">PYC 文件格式分析</a></li>
</ul>
<p><strong>关于 co_code</strong></p>
<p>一串二进制流, 代表着指令序列, 具体定义在 <a href="https://github.com/python/cpython/blob/fc7df0e664198cb05cafd972f190a18ca422989c/Include/opcode.h" target="_blank" rel="noopener">include/opcode.h</a> 中, 也可以参照 <a href="http://unpyc.sourceforge.net/Opcodes.html" target="_blank" rel="noopener">python opcodes</a>。</p>
<p>由</p>
<ul>
<li>指令 (opcode), 分为有参数和无参数两种, 以 <a href="https://github.com/python/cpython/blob/fc7df0e664198cb05cafd972f190a18ca422989c/Include/opcode.h#L69" target="_blank" rel="noopener">https://github.com/python/cpython/blob/fc7df0e664198cb05cafd972f190a18ca422989c/Include/opcode.h#L69</a> 划分</li>
<li>参数 (oparg)</li>
</ul>
<p>python3.6 以上参数永远占 1 字节, 如果指令不带参数的话则以<code>0x00</code>代替, 在运行过程中被解释器忽略, 也是 <strong>Stegosaurus</strong> 技术原理; 而低于 python3.5 的版本中指令不带参数的话却没有<code>0x00</code>填充</p>
<h3 id="例题-16"><a href="#例题-16" class="headerlink" title="例题"></a>例题</h3><p><strong><a href="https://github.com/ctfs/write-ups-2016/tree/master/hackover-ctf-2016/forensics/img-enc" target="_blank" rel="noopener">Hackover CTF 2016 : img-enc</a></strong></p>
<p>首先尝试 pycdc 反编译失败</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Source Generated with Decompyle++</span>
<span class="token comment" spellcheck="true"># File: imgenc.pyc (Python 2.7)</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>misc <span class="token keyword">import</span> imread<span class="token punctuation">,</span> imsave

<span class="token keyword">def</span> <span class="token function">doit</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> output_file<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>
Unsupported opcode<span class="token punctuation">:</span> STOP_CODE
    img <span class="token operator">=</span> imread<span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> flatten <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    img <span class="token operator">/=</span> <span class="token number">255</span>
    size <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># WARNING: Decompyle incomplete</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意到是 python2.7, 也就是说指令序列共占 1 字节或 3 字节 (有参数无参数)</p>
<p>使用 pcads 得到</p>
<pre><code>imgenc.pyc (Python 2.7)
...
                67      STOP_CODE               
                68      STOP_CODE               
                69      BINARY_DIVIDE           
                70      JUMP_IF_TRUE_OR_POP     5
                73      LOAD_CONST              3: 0
                76      LOAD_CONST              3: 0
                79      BINARY_DIVIDE       </code></pre><p>定位到出错的地方, 观察发现 <code>LOAD_CONST LOAD_CONST BINARY_DIVIDE STORE_FAST opcodes (64 03 00 64 03 00 15 7d 05 00)</code>被破坏了, 根据上下文线索修复后</p>
<pre><code>00000120  64 04 00 6b 00 00 72 ce  00 64 03 00 64 03 00 15  |d..k..r..d..d...|
00000130  7d 05 00 64 03 00 64 03  00 15 7d 05 00 64 03 00  |}..d..d...}..d..|
00000140  64 03 00 15 7d 05 00 64  03 00 64 03 00 15 7d 05  |d...}..d..d...}.|
00000150  00 64 03 00 64 03 00 15  7d 05 00 64 03 00 64 03  |.d..d...}..d..d.|
00000160  00 15 7d 05 00 64 03 00  64 03 00 15 7d 05 00 64  |..}..d..d...}..d|
00000170  03 00 64 03 00 15 7d 05  00 64 03 00 64 03 00 15  |..d...}..d..d...|
00000180  7d 05 00 64 03 00 64 03  00 15 7d 05 00 64 03 00  |}..d..d...}..d..|
00000190  64 03 00 15 7d 05 00 64  03 00 64 03 00 15 7d 05  |d...}..d..d...}.|
000001a0  00 64 03 00 64 03 00 15  7d 05 00 64 03 00 64 03  |.d..d...}..d..d.|
000001b0  00 15 7d 05 00 64 03 00  64 03 00 15 7d 05 00 6e  |..}..d..d...}..n|</code></pre><p>接下来根据修复好的 python 源代码得到 flag 即可</p>
<p><strong>延伸</strong>:</p>
<ul>
<li>题目: <a href="https://github.com/ctfs/write-ups-2017/tree/master/0ctf-quals-2017/reverse/py-137" target="_blank" rel="noopener">0ctf-2017:py</a></li>
<li>writeup: <a href="http://0x48.pw/2017/03/20/0x2f/" target="_blank" rel="noopener">记一次手撸 CPython bytecode</a></li>
</ul>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><h3 id="pycdc"><a href="#pycdc" class="headerlink" title="pycdc"></a><a href="https://github.com/zrax/pycdc" target="_blank" rel="noopener">pycdc</a></h3><blockquote>
<p>将 python 字节码转换为可读的 python 源代码, 包含了反汇编 (pycads) 和反编译 (pycdc) 两种工具</p>
</blockquote>
<h3 id="Stegosaurus"><a href="#Stegosaurus" class="headerlink" title="Stegosaurus"></a><a href="https://github.com/AngelKitty/stegosaurus" target="_blank" rel="noopener">Stegosaurus</a></h3><blockquote>
<p>Stegosaurus 是一款隐写工具，它允许我们在 Python 字节码文件 (pyc 或 pyo) 中嵌入任意 Payload。由于编码密度较低，因此我们嵌入 Payload 的过程既不会改变源代码的运行行为，也不会改变源文件的文件大小。 Payload 代码会被分散嵌入到字节码之中，所以类似 strings 这样的代码工具无法查找到实际的 Payload。 Python 的 dis 模块会返回源文件的字节码，然后我们就可以使用 Stegosaurus 来嵌入 Payload 了。</p>
</blockquote>
<p>原理是在 python 的字节码文件中，利用冗余空间，将完整的 payload 代码分散隐藏到这些零零碎碎的空间中。</p>
<p>具体用法可参看 <a href="https://ctf-wiki.github.io/ctf-tools/misc/" target="_blank" rel="noopener">ctf-tools</a>。</p>
<h4 id="例题-17"><a href="#例题-17" class="headerlink" title="例题"></a>例题</h4><p>Bugku QAQ</p>
<p>赛题链接如下：</p>
<pre><code>http://ctf.bugku.com/files/447e4b626f2d2481809b8690613c1613/QAQ
http://ctf.bugku.com/files/5c02892cd05a9dcd1c5a34ef22dd9c5e/cipher.txt</code></pre><p>首先拿到这道题，用 <code>010Editor</code> 乍一眼看过去，我们可以看到一些特征信息：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/feature.png" alt=""></p>
<p>可以判断这是个跟 <code>python</code> 有关的东西，通过查阅相关资料可以判断这是个 <code>python</code> 经编译过后的 <code>pyc</code> 文件。这里可能很多小伙伴们可能不理解了，什么是 <code>pyc</code> 文件呢？为什么会生成 <code>pyc</code> 文件？ <code>pyc</code> 文件又是何时生成的呢？下面我将一一解答这些问题。</p>
<p>简单来说， <code>pyc</code> 文件就是 <code>Python</code> 的字节码文件，是个二进制文件。我们都知道 <code>Python</code> 是一种全平台的解释性语言，全平台其实就是 <code>Python</code> 文件在经过解释器解释之后 (或者称为编译) 生成的 <code>pyc</code> 文件可以在多个平台下运行，这样同样也可以隐藏源代码。其实， <code>Python</code> 是完全面向对象的语言， <code>Python</code> 文件在经过解释器解释后生成字节码对象 <code>PyCodeObject</code> ， <code>pyc</code> 文件可以理解为是 <code>PyCodeObject</code> 对象的持久化保存方式。而 <code>pyc</code> 文件只有在文件被当成模块导入时才会生成。也就是说， <code>Python</code> 解释器认为，只有 <code>import</code> 进行的模块才需要被重用。 生成 <code>pyc</code> 文件的好处显而易见，当我们多次运行程序时，不需要重新对该模块进行重新的解释。主文件一般只需要加载一次，不会被其他模块导入，所以一般主文件不会生成 <code>pyc</code> 文件。</p>
<p>我们举个例子来说明这个问题：</p>
<p>为了方便起见，我们事先创建一个 test 文件夹作为此次实验的测试：</p>
<pre><code>mkdir test &amp;&amp; cd test/</code></pre><p>假设我们现在有个 <code>test.py</code> 文件，文件内容如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">print_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Hello,Kitty!'</span><span class="token punctuation">)</span>

print_test<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们执行以下命令：</p>
<pre><code>python3 test.py</code></pre><p>不用说，想必大家都知道打印出的结果是下面这个：</p>
<pre><code>Hello,Kitty!</code></pre><p>我们通过下面命令查看下当前文件夹下有哪些文件：</p>
<pre><code>ls -alh</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/test-01.png" alt=""></p>
<p>我们可以发现，并没有 <code>pyc</code> 文件生成。</p>
<p>‘我们再去创建一个文件为 <code>import_test.py</code> 文件，文件内容如下：</p>
<blockquote>
<p>注： <code>test.py</code> 和 <code>import_test.py</code> 应当放在同一文件夹下</p>
</blockquote>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> test

test<span class="token punctuation">.</span>print_test<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们执行以下命令：</p>
<pre><code>python3 import_test.py</code></pre><p>结果如下：</p>
<pre><code>Hello,Kitty!
Hello,Kitty!</code></pre><p>诶，为啥会打印出两句相同的话呢？我们再往下看，我们通过下面命令查看下当前文件夹下有哪些文件：</p>
<pre><code>ls -alh</code></pre><p>结果如下：</p>
<pre><code>总用量 20K
drwxr-xr-x 3 python python 4.0K 11月  5 20:38 .
drwxrwxr-x 4 python python 4.0K 11月  5 20:25 ..
-rw-r--r-- 1 python python   31 11月  5 20:38 import_test.py
drwxr-xr-x 2 python python 4.0K 11月  5 20:38 __pycache__
-rw-r--r-- 1 python python   58 11月  5 20:28 test.py</code></pre><p>诶，多了个 <code>__pycache__</code> 文件夹，我们进入文件夹下看看有什么？</p>
<pre><code>cd __pycache__ &amp;&amp; ls</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/test-02.png" alt=""></p>
<p>我们可以看到生成了一个 <code>test.cpython-36.pyc</code> 。为什么是这样子呢？</p>
<p>我们可以看到，我们在执行 <code>python3 import_test.py</code> 命令的时候，首先开始执行的是 <code>import test</code> ，即导入 <code>test</code> 模块，而一个模块被导入时， <code>PVM(Python Virtual Machine)</code> 会在后台从一系列路径中搜索该模块，其搜索过程如下：</p>
<ul>
<li>在当前目录下搜索该模块</li>
<li>在环境变量 <code>PYTHONPATH</code> 中指定的路径列表中依次搜索</li>
<li>在 <code>python</code> 安装路径中搜索</li>
</ul>
<p>事实上， <code>PVM</code> 通过变量 <code>sys.path</code> 中包含的路径来搜索，这个变量里面包含的路径列表就是上面提到的这些路径信息。</p>
<p>模块的搜索路径都放在了 <code>sys.path</code> 列表中，如果缺省的 <code>sys.path</code> 中没有含有自己的模块或包的路径，可以动态的加入 <code>(sys.path.apend)</code> 即可。</p>
<p>事实上， <code>Python</code> 中所有加载到内存的模块都放在 <code>sys.modules</code> 。当 <code>import</code> 一个模块时首先会在这个列表中查找是否已经加载了此模块，如果加载了则只是将模块的名字加入到正在调用 <code>import</code> 的模块的 <code>Local</code> 名字空间中。如果没有加载则从 <code>sys.path</code> 目录中按照模块名称查找模块文件，模块文件可以是 <code>py</code> 、 <code>pyc</code> 、 <code>pyd</code> ，找到后将模块载入内存，并加入到 <code>sys.modules</code> 中，并将名称导入到当前的 <code>Local</code> 名字空间。</p>
<p>可以看出来，<strong>一个模块不会重复载入</strong>。多个不同的模块都可以用 <code>import</code> 引入同一个模块到自己的 <code>Local</code> 名字空间，其实背后的 <code>PyModuleObject</code> 对象只有一个。</p>
<p>在这里，我还要说明一个问题，<strong><code>import</code> 只能导入模块，不能导入模块中的对象 (类、函数、变量等)。</strong>例如像上面这个例子，我在 <code>test.py</code> 里面定义了一个函数 <code>print_test()</code> ，我在另外一个模块文件 <code>import_test.py</code>不能直接通过 <code>import test.print_test</code> 将 <code>print_test</code> 导入到本模块文件中，只能用 <code>import test</code> 进行导入。如果我想只导入特定的类、函数、变量，用 <code>from test import print_test</code> 即可。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/import-test.png" alt=""></p>
<p>既然说到了 <code>import</code> 导入机制，再提一提嵌套导入和 <code>Package</code> 导入。</p>
<p><strong><code>import</code> 嵌套导入</strong></p>
<p>嵌套，不难理解，就是一个套着一个。小时候我们都玩过俄罗斯套娃吧，俄罗斯套娃就是一个大娃娃里面套着一个小娃娃，小娃娃里面还有更小的娃娃，而这个嵌套导入也是同一个意思。假如我们现在有一个模块，我们想要导入模块 <code>A</code> ，而模块 <code>A</code> 中有含有其他模块需要导入，比如模块 <code>B</code> ，模块 <code>B</code> 中又含有模块 <code>C</code> ，一直这样延续下去，这种方式我们称之为 <code>import</code> 嵌套导入。</p>
<p>对这种嵌套比较容易理解，我们需要注意的一点就是各个模块的 <code>Local</code> 名字空间是独立的，所以上面的例子，本模块 <code>import A</code> 完了后，本模块只能访问模块 <code>A</code> ，不能访问 <code>B</code> 及其它模块。虽然模块 <code>B</code> 已经加载到内存了，如果要访问，还必须明确在本模块中导入 <code>import B</code> 。</p>
<p>那如果我们有以下嵌套这种情况，我们该怎么处理呢？</p>
<p>比如我们现在有个模块 <code>A</code> ：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># A.py</span>
<span class="token keyword">from</span> B <span class="token keyword">import</span> D
<span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有个模块 <code>B</code> ：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># B.py</span>
<span class="token keyword">from</span> A <span class="token keyword">import</span> C
<span class="token keyword">class</span> <span class="token class-name">D</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们简单分析一下程序，如果程序运行，应该会去从模块 B 中调用对象 D。</p>
<p>我们尝试执行一下 <code>python A.py</code> ：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/import-error.png" alt=""></p>
<p>报 <code>ImportError</code> 的错误，似乎是没有加载到对象 <code>D</code> ，而我们将 <code>from B import D</code> 改成 <code>import B</code> ，我们似乎就能执行成功了。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/import-success.png" alt=""></p>
<p>这是怎么回事呢？这其实是跟 <code>Python</code> 内部 <code>import</code> 的机制是有关的，具体到 <code>from B import D</code> ， <code>Python</code> 内部会分成以下几个步骤：</p>
<ul>
<li>在 <code>sys.modules</code> 中查找符号 <code>B</code></li>
<li>如果符号 <code>B</code> 存在，则获得符号 <code>B</code> 对应的 <code>module</code> 对象 <code>&lt;module B&gt;</code> 。从 <code>&lt;module B&gt;</code> 的 <code>__dict__</code> 中获得符号 <code>D</code> 对应的对象，如果 <code>D</code> 不存在，则抛出异常</li>
<li>如果符号 <code>B</code> 不存在，则创建一个新的 <code>module</code> 对象 <code>&lt;module B&gt;</code> ，注意，此时 <code>module</code> 对象的 <code>__dict__</code> 为空。执行 <code>B.py</code> 中的表达式，填充 <code>&lt;module B&gt;</code> 的 <code>__dict__</code> 。从 <code>&lt;module B&gt;</code> 的 <code>__dict__</code> 中获得 <code>D</code> 对应的对象。如果 <code>D</code> 不存在，则抛出异常。</li>
</ul>
<p>所以，这个例子的执行顺序如下：</p>
<p>1、执行 <code>A.py</code> 中的 <code>from B import D</code></p>
<blockquote>
<p>注：由于是执行的 <code>python A.py</code> ，所以在 <code>sys.modules</code> 中并没有 <code>&lt;module B&gt;</code> 存在，首先为 <code>B.py</code> 创建一个 <code>module</code> 对象 ( <code>&lt;module B&gt;</code> )，注意，这时创建的这个 <code>module</code> 对象是空的，里边啥也没有，在 <code>Python</code> 内部创建了这个 <code>module</code> 对象之后，就会解析执行 <code>B.py</code> ，其目的是填充 <code>&lt;module B&gt;</code> 这个 <code>dict</code> 。</p>
</blockquote>
<p>2、执行 <code>B.py</code> 中的 <code>from A import C</code></p>
<blockquote>
<p>注：在执行 <code>B.py</code> 的过程中，会碰到这一句，首先检查 <code>sys.modules</code> 这个 <code>module</code> 缓存中是否已经存在 <code>&lt;module A&gt;</code> 了，由于这时缓存还没有缓存 <code>&lt;module A&gt;</code> ，所以类似的， <code>Python</code> 内部会为 <code>A.py</code> 创建一个 <code>module</code> 对象 ( <code>&lt;module A&gt;</code> )，然后，同样地，执行 <code>A.py</code> 中的语句。</p>
</blockquote>
<p>3、再次执行 <code>A.py</code> 中的 <code>from B import D</code></p>
<blockquote>
<p>注：这时，由于在第 <code>1</code> 步时，创建的 <code>&lt;module B&gt;</code> 对象已经缓存在了 <code>sys.modules</code> 中，所以直接就得到了 <code>&lt;module B&gt;</code> ，但是，注意，从整个过程来看，我们知道，这时 <code>&lt;module B&gt;</code> 还是一个空的对象，里面啥也没有，所以从这个 <code>module</code> 中获得符号 <code>D</code> 的操作就会抛出异常。如果这里只是 <code>import B</code> ，由于 <code>B</code> 这个符号在 <code>sys.modules</code> 中已经存在，所以是不会抛出异常的。</p>
</blockquote>
<p>我们可以从下图很清楚的看到 <code>import</code> 嵌套导入的过程：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/PyImportFlow.png" alt=""></p>
<p><strong><code>Package</code> 导入</strong></p>
<p>包 <code>(Package)</code> 可以看成模块的集合，只要一个文件夹下面有个 <code>__init__.py</code> 文件，那么这个文件夹就可以看做是一个包。包下面的文件夹还可以成为包 (子包)。更进一步的讲，多个较小的包可以聚合成一个较大的包。通过包这种结构，我们可以很方便的进行类的管理和维护，也方便了用户的使用。比如 <code>SQLAlchemy</code> 等都是以包的形式发布给用户的。</p>
<p>包和模块其实是很类似的东西，如果查看包的类型： <code>import SQLAlchemy type(SQLAlchemy)</code> ，可以看到其实也是 <code>&lt;type 'module'&gt;</code> 。 <code>import</code> 包的时候查找的路径也是 <code>sys.path</code>。</p>
<p>包导入的过程和模块的基本一致，只是导入包的时候会执行此包目录下的 <strong><code>__init__.py</code></strong> ，而不是模块里面的语句了。另外，如果只是单纯的导入包，而包的 <code>__init__.py</code> 中又没有明确的其他初始化操作，那么此包下面的模块是不会自动导入的。</p>
<p>假设我们有如下文件结构：</p>
<pre><code>.
└── PA
    ├── __init__.py
    ├── PB1
    │   ├── __init__.py
    │   └── pb1_m.py
    ├── PB2
    │   ├── __init__.py
    │   └── pb2_m.py
    └── wave.py</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/tree.png" alt=""></p>
<p><code>wave.py</code> ， <code>pb1_m.py</code> ， <code>pb2_m.py</code> 文件中我们均定义了如下函数：</p>
<pre><code>def getName():
    pass</code></pre><p><code>__init__.py</code> 文件内容均为空。</p>
<p>我们新建一个 <code>test.py</code> ，内容如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> PA<span class="token punctuation">.</span>wave <span class="token comment" spellcheck="true">#1</span>
<span class="token keyword">import</span> PA<span class="token punctuation">.</span>PB1 <span class="token comment" spellcheck="true">#2</span>
<span class="token keyword">import</span> PA<span class="token punctuation">.</span>PB1<span class="token punctuation">.</span>pb1_m <span class="token keyword">as</span> m1 <span class="token comment" spellcheck="true">#3</span>
<span class="token keyword">import</span> PA<span class="token punctuation">.</span>PB2<span class="token punctuation">.</span>pb2_m <span class="token comment" spellcheck="true">#4</span>
PA<span class="token punctuation">.</span>wave<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#5</span>
m1<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#6</span>
PA<span class="token punctuation">.</span>PB2<span class="token punctuation">.</span>pb2_m<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们运行以后，可以看出是成功执行成功了，我们再看看目录结构：</p>
<pre><code>.
├── PA
│   ├── __init__.py
│   ├── __init__.pyc
│   ├── PB1
│   │   ├── __init__.py
│   │   ├── __init__.pyc
│   │   ├── pb1_m.py
│   │   └── pb1_m.pyc
│   ├── PB2
│   │   ├── __init__.py
│   │   ├── __init__.pyc
│   │   ├── pb2_m.py
│   │   └── pb2_m.pyc
│   ├── wave.py
│   └── wave.pyc
└── test.py</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/test-success.png" alt=""></p>
<p>我们来分析一下这个过程：</p>
<ul>
<li>当执行<code>#1</code> 后， <code>sys.modules</code> 会同时存在 <code>PA</code> 、 <code>PA.wave</code> 两个模块，此时可以调用 <code>PA.wave</code> 的任何类或函数了。但不能调用 <code>PA.PB1(2)</code> 下的任何模块。当前 <code>Local</code> 中有了 <code>PA</code> 名字。</li>
<li>当执行 <code>#2</code> 后，只是将 <code>PA.PB1</code> 载入内存， <code>sys.modules</code> 中会有 <code>PA</code> 、 <code>PA.wave</code> 、 <code>PA.PB1</code> 三个模块，但是 <code>PA.PB1</code> 下的任何模块都没有自动载入内存，此时如果直接执行 <code>PA.PB1.pb1_m.getName()</code> 则会出错，因为 <code>PA.PB1</code> 中并没有 <code>pb1_m</code> 。当前 <code>Local</code> 中还是只有 <code>PA</code> 名字，并没有 <code>PA.PB1</code> 名字。</li>
<li>当执行 <code>#3</code> 后，会将 <code>PA.PB1</code> 下的 <code>pb1_m</code> 载入内存， <code>sys.modules</code> 中会有 <code>PA</code> 、 <code>PA.wave</code> 、 <code>PA.PB1</code> 、 <code>PA.PB1.pb1_m</code> 四个模块，此时可以执行 <code>PA.PB1.pb1_m.getName()</code> 了。由于使用了 <code>as</code> ，当前 <code>Local</code> 中除了 <code>PA</code> 名字，另外添加了 <code>m1</code> 作为 <code>PA.PB1.pb1_m</code> 的别名。</li>
<li>当执行 <code>#4</code> 后，会将 <code>PA.PB2</code> 、 <code>PA.PB2.pb2_m</code> 载入内存， <code>sys.modules</code> 中会有 <code>PA</code> 、 <code>PA.wave</code> 、 <code>PA.PB1</code> 、 <code>PA.PB1.pb1_m</code> 、 <code>PA.PB2</code> 、 <code>PA.PB2.pb2_m</code> 六个模块。当前 <code>Local</code> 中还是只有 <code>PA</code> 、 <code>m1</code> 。</li>
<li>下面的 <code>#5</code> ，<code>#6</code> ， <code>#7</code> 都是可以正确运行的。</li>
</ul>
<blockquote>
<p>注：需要注意的问题是如果 <code>PA.PB2.pb2_m</code> 想导入 <code>PA.PB1.pb1_m</code> 、 <code>PA.wave</code> 是可以直接成功的。最好是采用明确的导入路径，对于 <code>../..</code> 相对导入路径还是不推荐使用。</p>
</blockquote>
<p>既然我们已经知道 <code>pyc</code> 文件的产生，再回到那道赛题，我们尝试将 <code>pyc</code> 文件反编译回 <code>python</code> 源码。我们使用在线的开源工具进行尝试：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/error-162851453301555.png" alt=""></p>
<p>部分代码没有反编译成功？？？我们可以尝试分析一下，大概意思就是读取 <code>cipher.txt</code> 那个文件，将那个文件内容是通过 <code>base64</code> 编码的，我们的目的是将文件内容解码，然后又已知 <code>key</code> ，通过 <code>encryt</code> 函数进行加密的，我们可以尝试将代码补全：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">encryt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        cipher <span class="token operator">+=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>key<span class="token punctuation">[</span>i <span class="token operator">%</span> len<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> ord<span class="token punctuation">(</span>plain<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> cipher


<span class="token keyword">def</span> <span class="token function">getPlainText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plain <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'cipher.txt'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            line <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> line<span class="token punctuation">:</span>
                plain <span class="token operator">+=</span> line
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>

    <span class="token keyword">return</span> plain<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base_64'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> <span class="token string">'LordCasser'</span>
    plain <span class="token operator">=</span> getPlainText<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> encryt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> plain<span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'xxx.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下：</p>
<pre><code>YOU ARE FOOLED
THIS IS NOT THAT YOU WANT
GO ON DUDE
CATCH THAT STEGOSAURUS</code></pre><p>提示告诉我们用 <code>STEGOSAURUS</code> 工具进行隐写的，我们直接将隐藏的 payload 分离出来即可。</p>
<pre><code>python3 stegosaurus.py -x QAQ.pyc</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/flag.png" alt=""></p>
<p>我们得到了最终的 <code>flag</code> 为：<strong><code>flag{fin4lly_z3r0_d34d}</code></strong></p>
<p>既然都说到这个份子上了，我们就来分析一下我们是如何通过 <code>Stegosaurus</code> 来嵌入 <code>Payload</code> 。</p>
<p>我们仍然以上面这个代码为例子，我们设置脚本名称为 <code>encode.py</code> 。</p>
<p>第一步，我们使用 <code>Stegosaurus</code> 来查看在不改变源文件 <code>(Carrier)</code> 大小的情况下，我们的 <code>Payload</code> 能携带多少字节的数据：</p>
<pre><code>python3 -m stegosaurus encode.py -r</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/carry-bytes.png" alt=""></p>
<p>现在，我们可以安全地嵌入最多 24 个字节的 <code>Payload</code> 了。如果不想覆盖源文件的话，我们可以使用 <code>-s</code> 参数来单独生成一个嵌入了 <code>Payload</code> 的 <code>py</code> 文件：</p>
<pre><code>python3 -m stegosaurus encode.py -s --payload "flag{fin4lly_z3r0_d34d}"</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/payload-embedded.png" alt=""></p>
<p>现在我们可以用 <code>ls</code> 命令查看磁盘目录，嵌入了 <code>Payload</code> 的文件 ( <code>carrier</code> 文件) 和原始的字节码文件两者大小是完全相同的：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/bytes-similar.png" alt=""></p>
<blockquote>
<p>注：如果没有使用 <code>-s</code> 参数，那么原始的字节码文件将会被覆盖。</p>
</blockquote>
<p>我们可以通过向 <code>Stegosaurus</code> 传递 <code>-x</code> 参数来提取出 <code>Payload</code> ：</p>
<pre><code>python3 -m stegosaurus __pycache__/encode.cpython-36-stegosaurus.pyc -x</code></pre><p><img src="/images/loading.gif" data-original="../images/CTF/extract-payload.png" alt=""></p>
<p>我们构造的 <code>Payload</code> 不一定要是一个 <code>ASCII</code> 字符串， <code>shellcode</code> 也是可以的：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/payload-shellcode.png" alt=""></p>
<p>我们重新编写一个 <code>example.py</code> 模块，代码如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> math
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">+</span>int<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">sum1</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>

<span class="token keyword">def</span> <span class="token function">sum2</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">3</span>

<span class="token keyword">def</span> <span class="token function">sum3</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> int<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">3</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token number">1</span>
    b <span class="token operator">=</span> <span class="token number">2</span>
    result <span class="token operator">=</span> add<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sum1<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sum2<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sum3<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们让它携带 <code>Payload</code> 为 <code>flag_is_here</code>。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/example.png" alt=""></p>
<p>我们可以查看嵌入 <code>Payload</code> 之前和之后的 <code>Python</code> 代码运行情况：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/example-run.png" alt=""></p>
<p>通过 <code>strings</code> 查看 <code>Stegosaurus</code> 嵌入了 <code>Payload</code> 之后的文件输出情况 ( <code>payload</code> 并没有显示出来)：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/strings.png" alt=""></p>
<p>接下来使用 <code>Python</code> 的 <code>dis</code> 模块来查看 <code>Stegosaurus</code> 嵌入 <code>Payload</code> 之前和之后的文件字节码变化情况：</p>
<p>嵌入 payload 之前：</p>
<pre><code>#( 11/29/18@ 5:14下午 )( python@Sakura ):~/桌面
   python3 -m dis example.py 
  1           0 LOAD_CONST               0 (0)
              2 LOAD_CONST               1 (None)
              4 IMPORT_NAME              0 (sys)
              6 STORE_NAME               0 (sys)

  2           8 LOAD_CONST               0 (0)
             10 LOAD_CONST               1 (None)
             12 IMPORT_NAME              1 (os)
             14 STORE_NAME               1 (os)

  3          16 LOAD_CONST               0 (0)
             18 LOAD_CONST               1 (None)
             20 IMPORT_NAME              2 (math)
             22 STORE_NAME               2 (math)

  4          24 LOAD_CONST               2 (&lt;code object add at 0x7f90479778a0, file "example.py", line 4&gt;)
             26 LOAD_CONST               3 ('add')
             28 MAKE_FUNCTION            0
             30 STORE_NAME               3 (add)

  6          32 LOAD_CONST               4 (&lt;code object sum1 at 0x7f9047977810, file "example.py", line 6&gt;)
             34 LOAD_CONST               5 ('sum1')
             36 MAKE_FUNCTION            0
             38 STORE_NAME               4 (sum1)

  9          40 LOAD_CONST               6 (&lt;code object sum2 at 0x7f9047977ae0, file "example.py", line 9&gt;)
             42 LOAD_CONST               7 ('sum2')
             44 MAKE_FUNCTION            0
             46 STORE_NAME               5 (sum2)

 12          48 LOAD_CONST               8 (&lt;code object sum3 at 0x7f9047977f60, file "example.py", line 12&gt;)
             50 LOAD_CONST               9 ('sum3')
             52 MAKE_FUNCTION            0
             54 STORE_NAME               6 (sum3)

 15          56 LOAD_CONST              10 (&lt;code object main at 0x7f904798c300, file "example.py", line 15&gt;)
             58 LOAD_CONST              11 ('main')
             60 MAKE_FUNCTION            0
             62 STORE_NAME               7 (main)

 23          64 LOAD_NAME                8 (__name__)
             66 LOAD_CONST              12 ('__main__')
             68 COMPARE_OP               2 (==)
             70 POP_JUMP_IF_FALSE       78

 24          72 LOAD_NAME                7 (main)
             74 CALL_FUNCTION            0
             76 POP_TOP
        &gt;&gt;   78 LOAD_CONST               1 (None)
             80 RETURN_VALUE</code></pre><p>嵌入 <code>payload</code> 之后：</p>
<pre><code>#( 11/29/18@ 5:31下午 )( python@Sakura ):~/桌面
   python3 -m dis example.py                                 
  1           0 LOAD_CONST               0 (0)
              2 LOAD_CONST               1 (None)
              4 IMPORT_NAME              0 (sys)
              6 STORE_NAME               0 (sys)

  2           8 LOAD_CONST               0 (0)
             10 LOAD_CONST               1 (None)
             12 IMPORT_NAME              1 (os)
             14 STORE_NAME               1 (os)

  3          16 LOAD_CONST               0 (0)
             18 LOAD_CONST               1 (None)
             20 IMPORT_NAME              2 (math)
             22 STORE_NAME               2 (math)

  4          24 LOAD_CONST               2 (&lt;code object add at 0x7f146e7038a0, file "example.py", line 4&gt;)
             26 LOAD_CONST               3 ('add')
             28 MAKE_FUNCTION            0
             30 STORE_NAME               3 (add)

  6          32 LOAD_CONST               4 (&lt;code object sum1 at 0x7f146e703810, file "example.py", line 6&gt;)
             34 LOAD_CONST               5 ('sum1')
             36 MAKE_FUNCTION            0
             38 STORE_NAME               4 (sum1)

  9          40 LOAD_CONST               6 (&lt;code object sum2 at 0x7f146e703ae0, file "example.py", line 9&gt;)
             42 LOAD_CONST               7 ('sum2')
             44 MAKE_FUNCTION            0
             46 STORE_NAME               5 (sum2)

 12          48 LOAD_CONST               8 (&lt;code object sum3 at 0x7f146e703f60, file "example.py", line 12&gt;)
             50 LOAD_CONST               9 ('sum3')
             52 MAKE_FUNCTION            0
             54 STORE_NAME               6 (sum3)

 15          56 LOAD_CONST              10 (&lt;code object main at 0x7f146e718300, file "example.py", line 15&gt;)
             58 LOAD_CONST              11 ('main')
             60 MAKE_FUNCTION            0
             62 STORE_NAME               7 (main)

 23          64 LOAD_NAME                8 (__name__)
             66 LOAD_CONST              12 ('__main__')
             68 COMPARE_OP               2 (==)
             70 POP_JUMP_IF_FALSE       78

 24          72 LOAD_NAME                7 (main)
             74 CALL_FUNCTION            0
             76 POP_TOP
        &gt;&gt;   78 LOAD_CONST               1 (None)
             80 RETURN_VALUE</code></pre><blockquote>
<p>注： <code>Payload</code> 的发送和接受方法完全取决于用户个人喜好， <code>Stegosaurus</code> 只提供了一种向 <code>Python</code> 字节码文件嵌入或提取 <code>Payload</code> 的方法。但是为了保证嵌入之后的代码文件大小不会发生变化，因此 <code>Stegosaurus</code> 所支持嵌入的 <code>Payload</code> 字节长度十分有限。因此 ，如果你需要嵌入一个很大的 <code>Payload</code> ，那么你可能要将其分散存储于多个字节码文件中了。</p>
</blockquote>
<p>为了在不改变源文件大小的情况下向其嵌入 <code>Payload</code> ，我们需要识别出字节码中的无效空间 ( <code>Dead Zone</code> )。这里所谓的无效空间指的是那些即使被修改也不会改变原 <code>Python</code> 脚本正常行为的那些字节数据。</p>
<p>需要注意的是，我们可以轻而易举地找出 <code>Python3.6</code> 代码中的无效空间。 <code>Python</code> 的引用解释器 <code>CPython</code> 有两种类型的操作码：即无参数的和有参数的。在版本号低于 <code>3.5</code> 的 <code>Python</code> 版本中，根据操作码是否带参，字节码中的操作指令将需要占用 <code>1</code> 个字节或 <code>3</code> 个字节。在 <code>Python3.6</code> 中就不一样了， <code>Python3.6</code> 中所有的指令都占用 <code>2</code> 个字节，并会将无参数指令的第二个字节设置为 <code>0</code> ，这个字节在其运行过程中将会被解释器忽略。这也就意味着，对于字节码中每一个不带参数的操作指令， <code>Stegosaurus</code> 都可以安全地嵌入长度为 <code>1</code> 个字节的 <code>Payload</code> 代码。</p>
<p>我们可以通过 <code>Stegosaurus</code> 的 <code>-vv</code> 选项来查看 <code>Payload</code> 是如何嵌入到这些无效空间之中的：</p>
<pre><code>#( 11/29/18@10:35下午 )( python@Sakura ):~/桌面
   python3 -m stegosaurus example.py -s -p "ABCDE" -vv          
2018-11-29 22:36:26,795 - stegosaurus - DEBUG - Validated args
2018-11-29 22:36:26,797 - stegosaurus - INFO - Compiled example.py as __pycache__/example.cpython-36.pyc for use as carrier
2018-11-29 22:36:26,797 - stegosaurus - DEBUG - Read header and bytecode from carrier
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - POP_TOP (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - POP_TOP (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - POP_TOP (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - BINARY_SUBTRACT (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - BINARY_TRUE_DIVIDE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - BINARY_MULTIPLY (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - BINARY_ADD (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - POP_TOP (0)
2018-11-29 22:36:26,798 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,798 - stegosaurus - INFO - Found 14 bytes available for payload
Payload embedded in carrier
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - POP_TOP (65) ----A
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - POP_TOP (66) ----B
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - POP_TOP (67) ----C
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (68) ----D
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - BINARY_SUBTRACT (69) ----E
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - BINARY_TRUE_DIVIDE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - BINARY_MULTIPLY (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - BINARY_ADD (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - POP_TOP (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - RETURN_VALUE (0)
2018-11-29 22:36:26,799 - stegosaurus - DEBUG - Creating new carrier file name for side-by-side install
2018-11-29 22:36:26,799 - stegosaurus - INFO - Wrote carrier file as __pycache__/example.cpython-36-stegosaurus.pyc</code></pre><p><strong>Challenges:</strong> <a href="https://www.xctf.org.cn/library/details/whctf-writeup/" target="_blank" rel="noopener">WHCTF-2017:Py-Py-Py</a></p>
<h1 id="MISC-Tools"><a href="#MISC-Tools" class="headerlink" title="MISC Tools"></a>MISC Tools</h1><h2 id="图片隐写"><a href="#图片隐写" class="headerlink" title="图片隐写"></a>图片隐写</h2><ul>
<li><p><a href="http://down.40huo.cn/misc/Stegsolve.jar" target="_blank" rel="noopener">Stegsolve</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/stegdetect_0.6-6_amd64.deb" target="_blank" rel="noopener">Stegdetect amd64 deb</a></p>
<p>Stegdetect 的主要选项如下：</p>
<p>q – 仅显示可能包含隐藏内容的图像</p>
<p>n – 启用检查 JPEG 文件头功能，以降低误报率。如果启用，所有带有批注区域的文件将被视为没有被嵌入信息。如果 JPEG 文件的 JFIF 标识符中的版本号不是 1.1，则禁用 OutGuess 检测。</p>
<p>s – 修改检测算法的敏感度，该值的默认值为 1。检测结果的匹配度与检测算法的敏感度成正比，算法敏感度的值越大，检测出的可疑文件包含敏感信息的可能性越大。</p>
<p>d – 打印带行号的调试信息。</p>
<p>t – 设置要检测哪些隐写工具（默认检测 jopi），可设置的选项如下：</p>
<p>j – 检测图像中的信息是否是用 jsteg 嵌入的。</p>
<p>o – 检测图像中的信息是否是用 outguess 嵌入的。</p>
<p>p – 检测图像中的信息是否是用 jphide 嵌入的。</p>
<p>i – 检测图像中的信息是否是用 invisible secrets 嵌入的。</p>
</li>
<li><p><a href="http://down.40huo.cn/misc/steghide-0.5.1-win32.zip" target="_blank" rel="noopener">Steghide 0.5.1 win32</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/outguess_0.2-7_amd64.deb" target="_blank" rel="noopener">Outguess amd64 deb</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/pngcheck-2.3.0-win32.zip" target="_blank" rel="noopener">PNGCheck 2.3.0 win32</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/jphs_05.zip" target="_blank" rel="noopener">JPHS win32</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/oursecret.zip" target="_blank" rel="noopener">OurSecret</a></p>
</li>
</ul>
<h2 id="压缩包"><a href="#压缩包" class="headerlink" title="压缩包"></a>压缩包</h2><ul>
<li><p><a href="http://down.40huo.cn/misc/Ziperello.zip" target="_blank" rel="noopener">Ziperello</a></p>
<p>zip 压缩包密码爆破。</p>
</li>
<li><p><a href="http://down.40huo.cn/misc/AdvancedRARPassword.zip" target="_blank" rel="noopener">Advanced Rar Password Recovery</a></p>
</li>
<li><p><a href="http://down.40huo.cn/misc/AZPR_4.0.zip" target="_blank" rel="noopener">Advanced Zip Password Recovery</a></p>
</li>
</ul>
<h2 id="无线密码"><a href="#无线密码" class="headerlink" title="无线密码"></a>无线密码</h2><ul>
<li><a href="http://down.40huo.cn/misc/Elcomsoft.Wireless.Security.Auditor.Pro.v5.9.359-BRD_tt7z.com.rar" target="_blank" rel="noopener">Elcomsoft Wireless Security Auditor</a></li>
</ul>
<h2 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h2><ul>
<li><a href="http://down.40huo.cn/misc/010_Editor_v6.0.2_CracKed_For_Windows_x64.zip" target="_blank" rel="noopener">010 Editor Windows x64</a></li>
</ul>
<h2 id="NTFS-文件流"><a href="#NTFS-文件流" class="headerlink" title="NTFS 文件流"></a>NTFS 文件流</h2><ul>
<li><a href="http://down.40huo.cn/misc/alternatestreamview.zip" target="_blank" rel="noopener">Alternate Stream View</a></li>
</ul>
<h2 id="音频隐写-1"><a href="#音频隐写-1" class="headerlink" title="音频隐写"></a>音频隐写</h2><ul>
<li><a href="http://down.40huo.cn/misc/audacity-win-2.1.2.zip" target="_blank" rel="noopener">Audacity</a></li>
<li><a href="http://dialabc.com/sound/detect/" target="_blank" rel="noopener">在线拨号音识别</a></li>
</ul>
<h2 id="取证"><a href="#取证" class="headerlink" title="取证"></a>取证</h2><ul>
<li>Elcomsoft Forensic Disk Decryptor<ul>
<li><a href="http://down.40huo.cn/misc/Elcomsoft.Forensic.Disk.Decryptor.CracKed.By.Hmily.LCG.rar" target="_blank" rel="noopener">破解工具</a></li>
</ul>
</li>
</ul>
<h2 id="条形码、二维码"><a href="#条形码、二维码" class="headerlink" title="条形码、二维码"></a>条形码、二维码</h2><ul>
<li><a href="https://online-barcode-reader.inliteresearch.com/default.aspx" target="_blank" rel="noopener">条形码、二维码在线识别</a></li>
</ul>
<h2 id="GIF-1"><a href="#GIF-1" class="headerlink" title="GIF"></a>GIF</h2><ul>
<li><a href="http://ezgif.com/split" target="_blank" rel="noopener">GIF 在线分解</a></li>
</ul>
<h2 id="pyc"><a href="#pyc" class="headerlink" title="pyc"></a>pyc</h2><ul>
<li><a href="https://github.com/AngelKitty/stegosaurus" target="_blank" rel="noopener">Stegosaurus</a></li>
</ul>
<p>Stegosaurus 是一款隐写工具，它允许我们在 Python 字节码文件( pyc 或 pyo )中嵌入任意 Payload 。由于编码密度较低，因此我们嵌入 Payload 的过程既不会改变源代码的运行行为，也不会改变源文件的文件大小。 Payload 代码会被分散嵌入到字节码之中，所以类似 strings 这样的代码工具无法查找到实际的 Payload 。 Python 的 dis 模块会返回源文件的字节码，然后我们就可以使用 Stegosaurus 来嵌入 Payload 了。</p>
<blockquote>
<p><strong>Tips: Stegosaurus 仅支持 Python3.6 及其以下版本</strong></p>
</blockquote>
<p>Stegosaurus 的基本用法如下：</p>
<pre><code>$ python3 -m stegosaurus -h
usage: stegosaurus.py [-h] [-p PAYLOAD] [-r] [-s] [-v] [-x] carrier

positional arguments:
  carrier               Carrier py, pyc or pyo file

optional arguments:
  -h, --help            show this help message and exit
  -p PAYLOAD, --payload PAYLOAD
                        Embed payload in carrier file
  -r, --report          Report max available payload size carrier supports
  -s, --side-by-side    Do not overwrite carrier file, install side by side
                        instead.
  -v, --verbose         Increase verbosity once per use
  -x, --extract         Extract payload from carrier file</code></pre><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/ctf-misc.html">https://jackhcc.github.io/posts/ctf-misc.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MISC/">
                                    <span class="chip bg-color">MISC</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-08-08T22-13-50',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/gensim.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="Gensim API">
                        
                        <span class="card-title">Gensim API</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Gensim Python包详解
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/NLP/">
                        <span class="chip bg-color">NLP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/word2vec.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/0.jpg" class="responsive-img" alt="word2vec原理理解">
                        
                        <span class="card-title">word2vec原理理解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            word2vec词嵌入
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/NLP/">
                        <span class="chip bg-color">NLP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

