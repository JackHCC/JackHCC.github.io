<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Embedded Rustè¯¦è§£, JackHCC">
    <meta name="description" content="RuståµŒå…¥å¼ç¼–ç¨‹">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Embedded Rustè¯¦è§£ | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creativeå·¥å…·å¯¼èˆª</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLPæ¯æ—¥è®ºæ–‡</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChatèŠå¤©å®¤</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contactç•™è¨€æ¿</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creativeå·¥å…·å¯¼èˆª</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLPæ¯æ—¥è®ºæ–‡</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChatèŠå¤©å®¤</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contactç•™è¨€æ¿</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('è¯·è¾“å…¥è®¿é—®æœ¬æ–‡ç« çš„å¯†ç ')).toString(CryptoJS.enc.Hex)) {
                alert('å¯†ç é”™è¯¯ï¼Œå°†è¿”å›ä¸»é¡µï¼');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Embedded Rustè¯¦è§£</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Rust/">
                                <span class="chip bg-color">Rust</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Embedded/" class="post-category">
                                Embedded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2021-09-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2021-09-11
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    85.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>é˜…è¯»æ—¶é•¿:&nbsp;&nbsp;
                    366 åˆ†
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="âœ”Learning-Resource"><a href="#âœ”Learning-Resource" class="headerlink" title="âœ”Learning Resource"></a>âœ”Learning Resource</h1><ul>
<li><a href="https://kaisery.github.io/trpl-zh-cn/" target="_blank" rel="noopener">Rust ç¨‹åºè®¾è®¡è¯­è¨€</a></li>
</ul>
<ul>
<li><a href="https://rust-embedded.github.io/book/" target="_blank" rel="noopener">The Embedded Rust Book</a> - An introductory book about using the Rust Programming Language on â€œBare Metalâ€ embedded systems, such as Microcontrollers.</li>
<li><a href="https://rust-embedded.github.io/discovery" target="_blank" rel="noopener">Discovery</a> by @rust-embedded â€” this book is an introductory course on microcontroller-based embedded systems that uses Rust as the teaching language. Original author: @japaric</li>
<li><a href="https://docs.rs/cortex-m-quickstart/0.3.1/cortex_m_quickstart/" target="_blank" rel="noopener">Cortex-M Quickstart</a> by @japaric â€“ a template and introduction to embedded Rust, suitable for developers familiar to embedded development but new to embedded Rust.</li>
<li><a href="https://os.phil-opp.com/" target="_blank" rel="noopener">Writing an OS in rust</a> A blog series creating a small operating system in Rust</li>
<li><a href="https://droogmic.github.io/microrust/" target="_blank" rel="noopener">MicroRust</a> Introductory book for embedded development in Rust on the micro:bit.</li>
<li><a href="https://rahul-thakoor.github.io/physical-computing-rust/" target="_blank" rel="noopener">Physical Computing With Rust</a> A (WIP) guide to physical computing with Rust on the Raspberry Pi.</li>
<li><a href="https://github.com/rust-embedded/rust-raspi3-OS-tutorials" target="_blank" rel="noopener">Writing an embedded OS in Rust on the Raspberry Pi</a> A set of tutorials that give a guided, step-by-step tour of how to write a monolithic Operating System kernel for an embedded system from scratch. Runs on the Raspberry Pi 3 and the Raspberry Pi 4.</li>
<li><a href="https://hboeving.dev/blog/rust-2c-driver-p1/" target="_blank" rel="noopener">Writing embedded drivers in Rust isnâ€™t that hard</a> A guide to building an embedded-hal driver. <a href="https://hboeving.dev/blog/rust-i2c-driver-p2/" target="_blank" rel="noopener">Part 2</a></li>
<li><a href="https://github.com/ferrous-systems/embedded-trainings-2020" target="_blank" rel="noopener">Ferrous Systemsâ€™ Embedded Training Courses: 2020-current edition</a> A hands-on training course for beginner and advanced learners of Embedded Rust, based on Nordic Semiconductorâ€™s nRF52840 harware. This training was given at Oxidize Conferences and by <a href="https://ferrous-systems.com/" target="_blank" rel="noopener">Ferrous Systems</a> to corporate customers.</li>
<li><a href="https://knurling.ferrous-systems.com/sessions/" target="_blank" rel="noopener">Ferrous Systemsâ€™ Knurling Sessions</a> are hands-on embedded projects that explore specific concepts using generally available hardware, building full systems and components using microcontrollers, sensors, and actuators.</li>
<li><a href="https://github.com/jacobrosenthal/dsp-discoveryf4-rust/" target="_blank" rel="noopener">DSP on STM32F407G-DISC1</a> Unofficial oxidization of the <a href="https://www.amazon.com/Digital-Signal-Processing-Cortex-M-Microcontrollers/dp/1911531166" target="_blank" rel="noopener">Digital Signal Processing using Arm Cortex-M based Microcontrollers: Theory and Practice</a> book. The book isnâ€™t necessary to enjoy the examples and learn a functional DSP Rust coding style.</li>
</ul>
<hr>
<h1 id="ğŸ˜€ã€ŠThe-Embedded-Rust-Bookã€‹"><a href="#ğŸ˜€ã€ŠThe-Embedded-Rust-Bookã€‹" class="headerlink" title="ğŸ˜€ã€ŠThe Embedded Rust Bookã€‹"></a>ğŸ˜€ã€ŠThe Embedded Rust Bookã€‹</h1><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><h2 id="è®¤è¯†ç¡¬ä»¶"><a href="#è®¤è¯†ç¡¬ä»¶" class="headerlink" title="è®¤è¯†ç¡¬ä»¶"></a>è®¤è¯†ç¡¬ä»¶</h2><p>è®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ç¡¬ä»¶ã€‚</p>
<h3 id="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰"><a href="#STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰" class="headerlink" title="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰"></a>STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰</h3><p><img src="/images/loading.gif" data-original="../images/language/f3-16313292317231.jpg" alt=""></p>
<p>è¿™ä¸ªæ¿å­åŒ…å«ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ä¸€ä¸ª<a href="https://www.st.com/en/microcontrollers/stm32f303vc.html" target="_blank" rel="noopener">STM32F303VCT6</a>å¾®æ§åˆ¶å™¨ã€‚è¿™ä¸ªå¾®æ§åˆ¶å™¨æœ‰<ul>
<li>å•æ ¸ ARM Cortex-M4F å¤„ç†å™¨ï¼Œç¡¬ä»¶æ”¯æŒå•ç²¾åº¦æµ®ç‚¹è¿ç®—ï¼Œæœ€å¤§æ—¶é’Ÿé¢‘ç‡ä¸º 72 MHzã€‚</li>
<li>256 KiB çš„â€œé—ªå­˜â€å†…å­˜ã€‚ï¼ˆ1 KiB = 10 <strong>24</strong>å­—èŠ‚ï¼‰</li>
<li>48 KiB å†…å­˜ã€‚</li>
<li>å¤šç§é›†æˆå¤–è®¾ï¼Œå¦‚å®šæ—¶å™¨ã€I2Cã€SPI å’Œ USARTã€‚</li>
<li>é€šç”¨è¾“å…¥è¾“å‡º (GPIO) å’Œå…¶ä»–ç±»å‹çš„å¼•è„šå¯é€šè¿‡æ¿æ—è¾¹çš„ä¸¤æ’æ¥å¤´è®¿é—®ã€‚</li>
<li>å¯é€šè¿‡æ ‡æœ‰â€œUSB USERâ€çš„ USB ç«¯å£è®¿é—®çš„ USB æ¥å£ã€‚</li>
</ul>
</li>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">åŠ é€Ÿè®¡</a>ä½œä¸ºçš„ä¸€éƒ¨åˆ†<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>èŠ¯ç‰‡ã€‚</li>
<li>ç”²<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">ç£åŠ›</a>ä½œä¸ºä¸€éƒ¨åˆ†<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>èŠ¯ç‰‡ã€‚</li>
<li>ç”²<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">é™€èºä»ª</a>ä½œä¸ºä¸€éƒ¨åˆ†<a href="https://www.pololu.com/file/0J563/L3GD20.pdf" target="_blank" rel="noopener">L3GD20</a>èŠ¯ç‰‡ã€‚</li>
<li>8 ä¸ªç”¨æˆ· LED æ’åˆ—æˆæŒ‡å—é’ˆå½¢çŠ¶ã€‚</li>
<li>ç¬¬äºŒä¸ªå¾®æ§åˆ¶å™¨ï¼š<a href="https://www.st.com/en/microcontrollers/stm32f103cb.html" target="_blank" rel="noopener">STM32F103</a>ã€‚è¯¥å¾®æ§åˆ¶å™¨å®é™…ä¸Šæ˜¯æ¿è½½ç¼–ç¨‹å™¨/è°ƒè¯•å™¨çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶è¿æ¥åˆ°åä¸ºâ€œUSB ST-LINKâ€çš„ USB ç«¯å£ã€‚</li>
</ul>
<p>å¦‚éœ€æ›´è¯¦ç»†çš„åŠŸèƒ½åˆ—è¡¨å’Œç”µè·¯æ¿çš„è¿›ä¸€æ­¥è§„æ ¼ï¼Œè¯·è®¿é—®<a href="https://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STMicroelectronics</a>ç½‘ç«™ã€‚</p>
<p>è­¦å‘Šï¼šå¦‚æœæ‚¨æƒ³å°†å¤–éƒ¨ä¿¡å·åº”ç”¨äºç”µè·¯æ¿ï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚å¾®æ§åˆ¶å™¨ STM32F303VCT6 å¼•è„šçš„æ ‡ç§°ç”µå‹ä¸º 3.3 ä¼ã€‚å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ‰‹å†Œä¸­çš„<a href="https://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">6.2 ç»å¯¹æœ€å¤§é¢å®šå€¼éƒ¨åˆ†</a></p>
<h2 id="ä¸€ä¸ªno-std-rustç¯å¢ƒ"><a href="#ä¸€ä¸ªno-std-rustç¯å¢ƒ" class="headerlink" title="ä¸€ä¸ªno_std rustç¯å¢ƒ"></a>ä¸€ä¸ª<code>no_std</code> rustç¯å¢ƒ</h2><p>æœ¯è¯­åµŒå…¥å¼ç¼–ç¨‹ç”¨äºå¹¿æ³›çš„ä¸åŒç±»åˆ«çš„ç¼–ç¨‹ã€‚ä»ç¼–ç¨‹åªæœ‰å‡  KB RAM å’Œ ROM çš„8 ä½ MCUï¼ˆå¦‚<a href="https://www.st.com/resource/en/datasheet/st72325j6.pdf" target="_blank" rel="noopener">ST72325xx</a>ï¼‰ï¼Œåˆ°å…·æœ‰ 32/64 ä½ 4 æ ¸ Cortex-A53 @çš„ Raspberry Piï¼ˆ<a href="https://en.wikipedia.org/wiki/Raspberry_Pi#Specifications" target="_blank" rel="noopener">B å‹ 3+</a>ï¼‰ç­‰ç³»ç»Ÿ1.4 GHz å’Œ 1GB å†…å­˜ã€‚ç¼–å†™ä»£ç æ—¶å°†åº”ç”¨ä¸åŒçš„é™åˆ¶/é™åˆ¶ï¼Œå…·ä½“å–å†³äºæ‚¨æ‹¥æœ‰çš„ç›®æ ‡å’Œç”¨ä¾‹ç±»å‹ã€‚</p>
<p>æœ‰ä¸¤ç§é€šç”¨çš„åµŒå…¥å¼ç¼–ç¨‹åˆ†ç±»ï¼š</p>
<h3 id="æ‰˜ç®¡ç¯å¢ƒ"><a href="#æ‰˜ç®¡ç¯å¢ƒ" class="headerlink" title="æ‰˜ç®¡ç¯å¢ƒ"></a>æ‰˜ç®¡ç¯å¢ƒ</h3><p>è¿™äº›ç±»å‹çš„ç¯å¢ƒæ¥è¿‘äºæ­£å¸¸çš„ PC ç¯å¢ƒã€‚è¿™æ„å‘³ç€æ‚¨æä¾›äº†ä¸€ä¸ªç³»ç»Ÿæ¥å£<a href="https://en.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener">EG POSIX</a> ï¼Œå®ƒä¸ºæ‚¨æä¾›äº†ä¸å„ç§ç³»ç»Ÿäº¤äº’çš„åŸè¯­ï¼Œä¾‹å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹ç­‰ã€‚æ ‡å‡†åº“é€šå¸¸åˆä¾èµ–äºè¿™äº›åŸè¯­æ¥å®ç°ä»–ä»¬çš„åŠŸèƒ½ã€‚æ‚¨å¯èƒ½è¿˜æœ‰æŸç§ sysroot å’Œ RAM/ROM ä½¿ç”¨é™åˆ¶ï¼Œä¹Ÿè®¸è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„ç¡¬ä»¶æˆ– I/Oã€‚æ€»ä½“è€Œè¨€ï¼Œæ„Ÿè§‰å°±åƒåœ¨ä¸“ç”¨ PC ç¯å¢ƒä¸­ç¼–ç ã€‚</p>
<h3 id="è£¸æœºç¯å¢ƒ"><a href="#è£¸æœºç¯å¢ƒ" class="headerlink" title="è£¸æœºç¯å¢ƒ"></a>è£¸æœºç¯å¢ƒ</h3><p>åœ¨è£¸æœºç¯å¢ƒä¸­ï¼Œåœ¨æ‚¨çš„ç¨‹åºä¹‹å‰æ²¡æœ‰åŠ è½½ä»»ä½•ä»£ç ã€‚å¦‚æœæ²¡æœ‰æ“ä½œç³»ç»Ÿæä¾›çš„è½¯ä»¶ï¼Œæˆ‘ä»¬å°†æ— æ³•åŠ è½½æ ‡å‡†åº“ã€‚ç›¸åï¼Œç¨‹åºåŠå…¶ä½¿ç”¨çš„æ¿æ¡ç®±åªèƒ½ä½¿ç”¨ç¡¬ä»¶ï¼ˆè£¸æœºï¼‰æ¥è¿è¡Œã€‚ä¸ºäº†é˜²æ­¢ Rust åŠ è½½æ ‡å‡†åº“ï¼Œè¯·ä½¿ç”¨<code>no_std</code>. æ ‡å‡†åº“çš„å¹³å°æ— å…³éƒ¨åˆ†å¯é€šè¿‡<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore è·å¾—</a>ã€‚libcore è¿˜æ’é™¤äº†åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­å¹¶ä¸æ€»æ˜¯éœ€è¦çš„ä¸œè¥¿ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ç”¨äºåŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åˆ†é…å™¨ã€‚å¦‚æœæ‚¨éœ€è¦æ­¤åŠŸèƒ½æˆ–ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œé€šå¸¸æœ‰æä¾›è¿™äº›åŠŸèƒ½çš„æ¿æ¡ç®±ã€‚</p>
<p>libstd è¿è¡Œæ—¶</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>éœ€è¦æŸç§ç³»ç»Ÿé›†æˆï¼Œä½†è¿™ä¸ä»…æ˜¯å› ä¸º <a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>åªæ˜¯æä¾›ä¸€ç§è®¿é—®æ“ä½œç³»ç»ŸæŠ½è±¡çš„é€šç”¨æ–¹æ³•ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªè¿è¡Œæ—¶ã€‚è¯¥è¿è¡Œæ—¶è´Ÿè´£è®¾ç½®å †æ ˆæº¢å‡ºä¿æŠ¤ã€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ä»¥åŠåœ¨è°ƒç”¨ç¨‹åºçš„ä¸»å‡½æ•°ä¹‹å‰ç”Ÿæˆä¸»çº¿ç¨‹ã€‚æ­¤è¿è¡Œæ—¶åœ¨<code>no_std</code>ç¯å¢ƒä¸­ä¹Ÿä¸å¯ç”¨ã€‚</p>
<h3 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h3><p><code>#![no_std]</code>æ˜¯ä¸€ä¸ª crate çº§åˆ«çš„å±æ€§ï¼Œè¡¨ç¤º crate å°†é“¾æ¥åˆ° core-crate è€Œä¸æ˜¯ std-crateã€‚åè¿‡æ¥ï¼Œ<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a> crate æ˜¯ std crate ä¸å¹³å°æ— å…³çš„å­é›†ï¼Œå®ƒä¸å¯¹ç¨‹åºå°†åœ¨å…¶ä¸Šè¿è¡Œçš„ç³»ç»Ÿåšä»»ä½•å‡è®¾ã€‚å› æ­¤ï¼Œå®ƒä¸ºæµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡ç­‰è¯­è¨€åŸè¯­æä¾› APIï¼Œä»¥åŠå…¬å¼€åŸå­æ“ä½œå’Œ SIMD æŒ‡ä»¤ç­‰å¤„ç†å™¨åŠŸèƒ½çš„ APIã€‚ç„¶è€Œï¼Œå®ƒç¼ºå°‘ä»»ä½•æ¶‰åŠå¹³å°é›†æˆçš„ APIã€‚ç”±äºè¿™äº›å±æ€§ï¼Œno_std å’Œ<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a>ä»£ç å¯ç”¨äºä»»ä½•ç±»å‹çš„å¼•å¯¼ï¼ˆé˜¶æ®µ 0ï¼‰ä»£ç ï¼Œå¦‚å¼•å¯¼åŠ è½½ç¨‹åºã€å›ºä»¶æˆ–å†…æ ¸ã€‚</p>
<h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><table>
<thead>
<tr>
<th>ç‰¹å¾</th>
<th>no_std</th>
<th>æ ‡å‡†</th>
</tr>
</thead>
<tbody><tr>
<td>å †ï¼ˆåŠ¨æ€å†…å­˜ï¼‰</td>
<td>*</td>
<td>âœ“</td>
</tr>
<tr>
<td>é›†åˆï¼ˆVecã€HashMap ç­‰ï¼‰</td>
<td>**</td>
<td>âœ“</td>
</tr>
<tr>
<td>å †æ ˆæº¢å‡ºä¿æŠ¤</td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>åœ¨ main ä¹‹å‰è¿è¡Œåˆå§‹åŒ–ä»£ç </td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>libstd å¯ç”¨</td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>libcore å¯ç”¨</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
<tr>
<td>ç¼–å†™å›ºä»¶ã€å†…æ ¸æˆ–å¼•å¯¼åŠ è½½ç¨‹åºä»£ç </td>
<td>âœ“</td>
<td>âœ˜</td>
</tr>
</tbody></table>
<p>* ä»…å½“æ‚¨ä½¿ç”¨<code>alloc</code>crate å¹¶ä½¿ç”¨åˆé€‚çš„åˆ†é…å™¨ï¼ˆå¦‚<a href="https://github.com/rust-embedded/alloc-cortex-m" target="_blank" rel="noopener">alloc-cortex-m ï¼‰æ—¶</a>ã€‚</p>
<p>** ä»…å½“æ‚¨ä½¿ç”¨<code>collections</code>crate å¹¶é…ç½®å…¨å±€é»˜è®¤åˆ†é…å™¨æ—¶ã€‚</p>
<h3 id="ä¹Ÿå¯ä»¥çœ‹çœ‹"><a href="#ä¹Ÿå¯ä»¥çœ‹çœ‹" class="headerlink" title="ä¹Ÿå¯ä»¥çœ‹çœ‹"></a>ä¹Ÿå¯ä»¥çœ‹çœ‹</h3><ul>
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1184-stabilize-no_std.md" target="_blank" rel="noopener">RFC-1184</a></li>
</ul>
<h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>å¤„ç†å¾®æ§åˆ¶å™¨æ¶‰åŠä½¿ç”¨å‡ ç§ä¸åŒçš„å·¥å…·ï¼Œå› ä¸ºæˆ‘ä»¬å°†å¤„ç†ä¸ç¬”è®°æœ¬ç”µè„‘ä¸åŒçš„æ¶æ„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨<em>è¿œç¨‹</em>è®¾å¤‡ä¸Šè¿è¡Œå’Œè°ƒè¯•ç¨‹åºã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢åˆ—å‡ºçš„æ‰€æœ‰å·¥å…·ã€‚å½“æœªæŒ‡å®šæœ€ä½ç‰ˆæœ¬æ—¶ï¼Œä»»ä½•æœ€æ–°ç‰ˆæœ¬éƒ½åº”è¯¥å¯ä»¥å·¥ä½œï¼Œä½†æˆ‘ä»¬å·²ç»åˆ—å‡ºäº†æˆ‘ä»¬æµ‹è¯•è¿‡çš„ç‰ˆæœ¬ã€‚</p>
<ul>
<li>Rust 1.31ã€1.31-beta æˆ–æ›´æ–°çš„å·¥å…·é“¾åŠ ä¸Š ARM Cortex-M ç¼–è¯‘æ”¯æŒã€‚</li>
<li><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a> ~0.1.4</li>
<li><a href="https://www.qemu.org/" target="_blank" rel="noopener"><code>qemu-system-arm</code></a>. æµ‹è¯•ç‰ˆæœ¬ï¼š3.0.0</li>
<li>OpenOCD &gt;=0.8ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼šv0.9.0 å’Œ v0.10.0</li>
<li>å…·æœ‰ ARM æ”¯æŒçš„ GDBã€‚å¼ºçƒˆå»ºè®®ä½¿ç”¨ 7.12 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼š7.10ã€7.11ã€7.12 å’Œ 8.1</li>
<li><a href="https://github.com/ashleygwilliams/cargo-generate" target="_blank" rel="noopener"><code>cargo-generate</code></a>æˆ–<code>git</code>ã€‚è¿™äº›å·¥å…·æ˜¯å¯é€‰çš„ï¼Œä½†å¯ä»¥æ›´è½»æ¾åœ°è·Ÿéšæœ¬ä¹¦è¿›è¡Œå­¦ä¹ ã€‚</li>
</ul>
<p>ä¸‹é¢çš„æ–‡å­—è§£é‡Šäº†æˆ‘ä»¬ä½¿ç”¨è¿™äº›å·¥å…·çš„åŸå› ã€‚å®‰è£…è¯´æ˜å¯ä»¥åœ¨ä¸‹ä¸€é¡µæ‰¾åˆ°ã€‚</p>
<h3 id="cargo-generate-æˆ–è€…-git"><a href="#cargo-generate-æˆ–è€…-git" class="headerlink" title="cargo-generate æˆ–è€… git"></a><code>cargo-generate</code> æˆ–è€… <code>git</code></h3><p>è£¸æœºç¨‹åºæ˜¯éæ ‡å‡†çš„ ( <code>no_std</code>) Rust ç¨‹åºï¼Œéœ€è¦å¯¹é“¾æ¥è¿‡ç¨‹è¿›è¡Œä¸€äº›è°ƒæ•´æ‰èƒ½ä½¿ç¨‹åºçš„å†…å­˜å¸ƒå±€æ­£ç¡®ã€‚è¿™éœ€è¦ä¸€äº›é¢å¤–çš„æ–‡ä»¶ï¼ˆå¦‚é“¾æ¥å™¨è„šæœ¬ï¼‰å’Œè®¾ç½®ï¼ˆå¦‚é“¾æ¥å™¨æ ‡å¿—ï¼‰ã€‚æˆ‘ä»¬ä¸ºæ‚¨æ‰“åŒ…äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œæ‚¨åªéœ€å¡«å†™ç¼ºå°‘çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚é¡¹ç›®åç§°å’Œç›®æ ‡ç¡¬ä»¶çš„ç‰¹æ€§ï¼‰ã€‚</p>
<p>æˆ‘ä»¬çš„æ¨¡æ¿å…¼å®¹<code>cargo-generate</code>ï¼šç”¨äºä»æ¨¡æ¿åˆ›å»ºæ–° Cargo é¡¹ç›®çš„ Cargo å­å‘½ä»¤ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸‹è½½æ¨¡æ¿<code>git</code>ï¼Œ<code>curl</code>ï¼Œ<code>wget</code>ï¼Œæˆ–Webæµè§ˆå™¨ã€‚</p>
<h3 id="cargo-binutils"><a href="#cargo-binutils" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><p><code>cargo-binutils</code>æ˜¯ Cargo å­å‘½ä»¤çš„é›†åˆï¼Œå¯ä»¥è½»æ¾ä½¿ç”¨ Rust å·¥å…·é“¾é™„å¸¦çš„ LLVM å·¥å…·ã€‚è¿™äº›å·¥å…·åŒ…æ‹¬<code>objdump</code>ã€<code>nm</code>å’Œçš„ LLVM ç‰ˆæœ¬ï¼Œ<code>size</code>ç”¨äºæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>ä¸ GNU binutils ç›¸æ¯”ï¼Œä½¿ç”¨è¿™äº›å·¥å…·çš„ä¼˜åŠ¿åœ¨äº (a) å®‰è£… LLVM å·¥å…·æ˜¯ç›¸åŒçš„å•å‘½ä»¤å®‰è£… ( <code>rustup component add llvm-tools-preview</code>)ï¼Œæ— è®ºæ‚¨çš„æ“ä½œç³»ç»Ÿå¦‚ä½•ï¼Œä»¥åŠ (b)<code>objdump</code>æ”¯æŒæ‰€æœ‰<code>rustc</code>æ”¯æŒæ¶æ„çš„å·¥å…·â€”â€”ä» ARM åˆ° x86_64â€”â€” - å› ä¸ºå®ƒä»¬å…±äº«ç›¸åŒçš„ LLVM åç«¯ã€‚</p>
<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu-system-arm"></a><code>qemu-system-arm</code></h3><p>QEMU æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯ä»¥å®Œå…¨æ¨¡æ‹Ÿ ARM ç³»ç»Ÿçš„å˜ä½“ã€‚æˆ‘ä»¬ä½¿ç”¨ QEMU åœ¨ä¸»æœºä¸Šè¿è¡ŒåµŒå…¥å¼ç¨‹åºã€‚å¤šäºäº†è¿™ä¸€ç‚¹ï¼Œå³ä½¿æ‚¨æ²¡æœ‰ä»»ä½•ç¡¬ä»¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥éµå¾ªæœ¬ä¹¦çš„æŸäº›éƒ¨åˆ†ï¼</p>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><p>è°ƒè¯•å™¨æ˜¯åµŒå…¥å¼å¼€å‘çš„ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼Œå› ä¸ºæ‚¨å¯èƒ½å¹¶ä¸æ€»æ˜¯èƒ½å¤Ÿå°†å†…å®¹è®°å½•åˆ°ä¸»æœºæ§åˆ¶å°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨çš„ç¡¬ä»¶ç”šè‡³å¯èƒ½æ²¡æœ‰ LED æŒ‡ç¤ºç¯é—ªçƒï¼</p>
<p>æ€»çš„æ¥è¯´ï¼ŒLLDB åœ¨è°ƒè¯•æ–¹é¢çš„æ•ˆæœä¸ GDB ä¸€æ ·å¥½ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾åˆ° GDB çš„<code>load</code>å‘½ä»¤çš„ LLDB å¯¹åº”é¡¹ï¼Œå®ƒå°†ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡ç¡¬ä»¶ï¼Œå› æ­¤ç›®å‰æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ GDBã€‚</p>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>GDB æ— æ³•ç›´æ¥ä¸ STM32F3DISCOVERY å¼€å‘æ¿ä¸Šçš„ ST-Link è°ƒè¯•ç¡¬ä»¶é€šä¿¡ã€‚å®ƒéœ€è¦ä¸€ä¸ªè½¬æ¢å™¨ï¼Œè€Œå¼€æ”¾å¼ç‰‡ä¸Šè°ƒè¯•å™¨ OpenOCD å°±æ˜¯é‚£ä¸ªè½¬æ¢å™¨ã€‚OpenOCD æ˜¯ä¸€ä¸ªåœ¨æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC ä¸Šè¿è¡Œçš„ç¨‹åºï¼Œå¯åœ¨ GDB çš„åŸºäº TCP/IP çš„è¿œç¨‹è°ƒè¯•åè®®å’Œ ST-Link çš„åŸºäº USB çš„åè®®ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p>
<p>OpenOCD è¿˜æ‰§è¡Œå…¶ä»–é‡è¦å·¥ä½œï¼Œä½œä¸ºå…¶åœ¨ STM32F3DISCOVERY å¼€å‘æ¿ä¸Šè°ƒè¯•åŸºäº ARM Cortex-M çš„å¾®æ§åˆ¶å™¨çš„ç¿»è¯‘çš„ä¸€éƒ¨åˆ†ï¼š</p>
<ul>
<li>å®ƒçŸ¥é“å¦‚ä½•ä¸ ARM CoreSight è°ƒè¯•å¤–è®¾ä½¿ç”¨çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨è¿›è¡Œäº¤äº’ã€‚æ­£æ˜¯è¿™äº› CoreSight å¯„å­˜å™¨å…è®¸ï¼š<ul>
<li>æ–­ç‚¹/è§‚å¯Ÿç‚¹æ“ä½œ</li>
<li>è¯»å–å’Œå†™å…¥ CPU å¯„å­˜å™¨</li>
<li>æ£€æµ‹ CPU ä½•æ—¶å› è°ƒè¯•äº‹ä»¶è€Œåœæ­¢</li>
<li>é‡åˆ°è°ƒè¯•äº‹ä»¶åç»§ç»­æ‰§è¡Œ CPU</li>
<li>ç­‰ç­‰ã€‚</li>
</ul>
</li>
<li>å®ƒè¿˜çŸ¥é“å¦‚ä½•æ“¦é™¤å’Œå†™å…¥å¾®æ§åˆ¶å™¨çš„ FLASH</li>
</ul>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>æ­¤é¡µé¢åŒ…å«ä¸€äº›å·¥å…·çš„ä¸æ“ä½œç³»ç»Ÿæ— å…³çš„å®‰è£…è¯´æ˜ï¼š</p>
<h3 id="Rust-å·¥å…·é“¾"><a href="#Rust-å·¥å…·é“¾" class="headerlink" title="Rust å·¥å…·é“¾"></a>Rust å·¥å…·é“¾</h3><p>æŒ‰ç…§<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs </a>ä¸Šçš„è¯´æ˜å®‰è£… rustup ã€‚</p>
<p><strong>æ³¨æ„</strong>ç¡®ä¿æ‚¨çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ç­‰äºæˆ–é«˜äº<code>1.31</code>. <code>rustc -V</code>åº”è¯¥è¿”å›ä¸€ä¸ªæ¯”ä¸‹é¢æ˜¾ç¤ºçš„æ—¥æœŸæ–°çš„æ—¥æœŸã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ rustc -V
rustc 1.31.1 (b6c32da9b 2018-12-18)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¯¹äºå¸¦å®½å’Œç£ç›˜ä½¿ç”¨é—®é¢˜ï¼Œé»˜è®¤å®‰è£…ä»…æ”¯æŒæœ¬æœºç¼–è¯‘ã€‚è¦ä¸º ARM Cortex-M æ¶æ„æ·»åŠ äº¤å‰ç¼–è¯‘æ”¯æŒï¼Œè¯·é€‰æ‹©ä»¥ä¸‹ç¼–è¯‘ç›®æ ‡ä¹‹ä¸€ã€‚å¯¹äºæœ¬ä¹¦ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ STM32F3DISCOVERY æ¿ï¼Œè¯·ä½¿ç”¨<code>thumbv7em-none-eabihf</code>ç›®æ ‡ã€‚</p>
<p>Cortex-M0ã€M0+ å’Œ M1ï¼ˆARMv6-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M3ï¼ˆARMv7-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ— ç¡¬ä»¶æµ®ç‚¹çš„ Cortex-M4 å’Œ M7ï¼ˆARMv7E-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¸¦æœ‰ç¡¬ä»¶æµ®ç‚¹çš„ Cortex-M4F å’Œ M7Fï¼ˆARMv7E-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M23ï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.base-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33 å’Œ M35Pï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33F å’Œ M35PF å¸¦ç¡¬ä»¶æµ®ç‚¹ï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="cargo-binutils-1"><a href="#cargo-binutils-1" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><pre class="line-numbers language-text"><code class="language-text">cargo install cargo-binutils

rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-generate"><a href="#cargo-generate" class="headerlink" title="cargo-generate"></a><code>cargo-generate</code></h3><p>ç¨åæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»æ¨¡æ¿ç”Ÿæˆé¡¹ç›®ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>ä»¥ä¸‹æ˜¯ä¸€äº› Linux å‘è¡Œç‰ˆçš„å®‰è£…å‘½ä»¤ã€‚</p>
<h4 id="å¥—é¤"><a href="#å¥—é¤" class="headerlink" title="å¥—é¤"></a>å¥—é¤</h4><ul>
<li>Ubuntu 18.04 æˆ–æ›´é«˜ç‰ˆæœ¬/Debian å»¶ä¼¸ç‰ˆæˆ–æ›´é«˜ç‰ˆæœ¬</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>gdb-multiarch</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-multiarch openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Ubuntu 14.04 å’Œ 16.04</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-arm-none-eabi openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Fedora 27 æˆ–æ›´æ–°ç‰ˆæœ¬</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo dnf install arm-none-eabi-gdb openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>æ‹±å½¢Linux</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S arm-none-eabi-gdb qemu-arch-extra openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="udev-è§„åˆ™"><a href="#udev-è§„åˆ™" class="headerlink" title="udev è§„åˆ™"></a>udev è§„åˆ™</h4><p>æ­¤è§„åˆ™å…è®¸æ‚¨åœ¨æ²¡æœ‰ root æƒé™çš„æƒ…å†µä¸‹å°† OpenOCD ä¸ Discovery æ¿ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p><code>/etc/udev/rules.d/70-st-link.rules</code>ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å†…å®¹åˆ›å»ºæ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY rev A/B - ST-LINK/V2
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="3748", TAG+="uaccess"

# STM32F3DISCOVERY rev C+ - ST-LINK/V2-1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", TAG+="uaccess"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°åŠ è½½æ‰€æœ‰ udev è§„åˆ™ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¦‚æœæ‚¨å°†ç”µè·¯æ¿æ’å…¥ç¬”è®°æœ¬ç”µè„‘ï¼Œè¯·å°†å…¶æ‹”ä¸‹ï¼Œç„¶åå†é‡æ–°æ’å…¥ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥æƒé™ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å“ªä¸ªåº”è¯¥æ˜¾ç¤ºç±»ä¼¼</p>
<pre class="line-numbers language-text"><code class="language-text">(..)
Bus 001 Device 018: ID 0483:374b STMicroelectronics ST-LINK/V2.1
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è®°ä¸‹æ€»çº¿å’Œè®¾å¤‡ç¼–å·ã€‚ä½¿ç”¨è¿™äº›æ•°å­—åˆ›å»ºä¸€ä¸ªç±»ä¼¼ <code>/dev/bus/usb/&lt;bus&gt;/&lt;device&gt;</code>. ç„¶ååƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªè·¯å¾„ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">ls -l /dev/bus/usb/001/018
crw-------+ 1 root root 189, 17 Sep 13 12:34 /dev/bus/usb/001/018
getfacl /dev/bus/usb/001/018 | grep user
user::rw-
user:you:rw-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨<code>+</code>é™„åŠ åˆ°æƒé™æŒ‡ç¤ºæ‰©å±•çš„è®¸å¯çš„å­˜åœ¨ã€‚è¯¥<code>getfacl</code>å‘½ä»¤å‘Šè¯‰ç”¨æˆ·<code>you</code>å¯ä»¥ä½¿ç”¨è¯¥è®¾å¤‡ã€‚</p>
<h3 id="è‹¹æœç³»ç»Ÿ"><a href="#è‹¹æœç³»ç»Ÿ" class="headerlink" title="è‹¹æœç³»ç»Ÿ"></a>è‹¹æœç³»ç»Ÿ</h3><p>æ‰€æœ‰å·¥å…·éƒ½å¯ä»¥ä½¿ç”¨<a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>å®‰è£…ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ # GDB
$ brew install armmbed/formulae/arm-none-eabi-gcc

$ # OpenOCD
$ brew install openocd

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="arm-none-eabi-gdb"><a href="#arm-none-eabi-gdb" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h4><p>ARM<code>.exe</code>ä¸º Windowsæä¾›å®‰è£…ç¨‹åºã€‚ä»<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‹¿ä¸€ä¸ªï¼Œç„¶åæŒ‰ç…§è¯´æ˜æ“ä½œã€‚å°±åœ¨å®‰è£…è¿‡ç¨‹å®Œæˆä¹‹å‰ï¼Œå‹¾é€‰/é€‰æ‹©â€œæ·»åŠ ç¯å¢ƒå˜é‡è·¯å¾„â€é€‰é¡¹ã€‚ç„¶åéªŒè¯å·¥å…·æ˜¯å¦åœ¨æ‚¨çš„<code>%PATH%</code>ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ arm-none-eabi-gdb -v
GNU gdb (GNU Tools for Arm Embedded Processors 7-2018-q2-update) 8.1.0.20180315-git
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="å¼€æ”¾å¼å¼ºè¿«ç—‡"><a href="#å¼€æ”¾å¼å¼ºè¿«ç—‡" class="headerlink" title="å¼€æ”¾å¼å¼ºè¿«ç—‡"></a>å¼€æ”¾å¼å¼ºè¿«ç—‡</h4><p>æ²¡æœ‰ç”¨äº Windows çš„ OpenOCD çš„å®˜æ–¹äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨ä¸æƒ³è‡ªå·±ç¼–è¯‘å®ƒï¼ŒxPack é¡¹ç›®æä¾›äº†ä¸€ä¸ªäºŒè¿›åˆ¶å‘è¡Œç‰ˆï¼Œè¯·<a href="https://xpack.github.io/openocd/" target="_blank" rel="noopener">ç‚¹å‡»æ­¤å¤„</a>ã€‚æŒ‰ç…§æä¾›çš„å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œã€‚ç„¶åæ›´æ–°æ‚¨çš„<code>%PATH%</code>ç¯å¢ƒå˜é‡ä»¥åŒ…å«å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ã€‚( <code>C:\Users\USERNAME\AppData\Roaming\xPacks\@xpack-dev-tools\openocd\0.10.0-13.1\.content\bin\</code>, å¦‚æœæ‚¨ä¸€ç›´åœ¨ä½¿ç”¨ç®€æ˜“å®‰è£…)</p>
<p>éªŒè¯ OpenOCD æ˜¯å¦åœ¨æ‚¨çš„ç›®å½•<code>%PATH%</code>ä¸­ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="åŠ¨è½¦ç»„"><a href="#åŠ¨è½¦ç»„" class="headerlink" title="åŠ¨è½¦ç»„"></a>åŠ¨è½¦ç»„</h4><p>ä»<a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™è·å–</a>QEMU ã€‚</p>
<h4 id="ST-LINK-USB-é©±åŠ¨"><a href="#ST-LINK-USB-é©±åŠ¨" class="headerlink" title="ST-LINK USB é©±åŠ¨"></a>ST-LINK USB é©±åŠ¨</h4><p>æ‚¨è¿˜éœ€è¦å®‰è£…<a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">æ­¤ USB é©±åŠ¨ç¨‹åº</a>ï¼Œå¦åˆ™ OpenOCD å°†æ— æ³•å·¥ä½œã€‚æŒ‰ç…§å®‰è£…ç¨‹åºè¯´æ˜è¿›è¡Œæ“ä½œï¼Œå¹¶ç¡®ä¿å®‰è£…æ­£ç¡®ç‰ˆæœ¬ï¼ˆ32 ä½æˆ– 64 ä½ï¼‰çš„é©±åŠ¨ç¨‹åºã€‚</p>
<h3 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h3><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€äº›å¿…éœ€çš„å·¥å…·/é©±åŠ¨ç¨‹åºæ˜¯å¦å·²æ­£ç¡®å®‰è£…å’Œé…ç½®ã€‚</p>
<p>ä½¿ç”¨å¾®å‹ USB ç”µç¼†å°†æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC è¿æ¥åˆ°å‘ç°æ¿ã€‚å‘ç°æ¿æœ‰ä¸¤ä¸ª USB è¿æ¥å™¨ï¼›ä½¿ç”¨ä½äºç”µè·¯æ¿è¾¹ç¼˜ä¸­å¿ƒçš„æ ‡æœ‰â€œUSB ST-LINKâ€çš„é‚£ä¸ªã€‚</p>
<p>è¿˜è¦æ£€æŸ¥æ˜¯å¦å¡«å……äº† ST-LINK æ ‡å¤´ã€‚è§ä¸‹å›¾ï¼›ST-LINK æ ‡å¤´ä»¥çº¢è‰²åœˆå‡ºã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/verify.jpeg" alt=""></p>
<p>ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šæ—§ç‰ˆæœ¬çš„ openocdï¼ŒåŒ…æ‹¬ 2017 å¹´çš„ 0.10.0 ç‰ˆæœ¬ï¼Œä¸åŒ…å«æ–°çš„ï¼ˆå’Œæ›´å¯å–çš„ï¼‰<code>interface/stlink.cfg</code>æ–‡ä»¶ï¼›ç›¸åï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨<code>interface/stlink-v2.cfg</code>æˆ–<code>interface/stlink-v2-1.cfg</code>ã€‚</p>
</blockquote>
<p>æ‚¨åº”è¯¥å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œå¹¶ä¸”ç¨‹åºåº”è¯¥é˜»æ­¢æ§åˆ¶å°ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.919881
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†…å®¹å¯èƒ½ä¸å®Œå…¨åŒ¹é…ï¼Œä½†æ‚¨åº”è¯¥å¾—åˆ°å…³äºæ–­ç‚¹å’Œè§‚å¯Ÿç‚¹çš„æœ€åä¸€è¡Œã€‚å¦‚æœæ‚¨å¾—åˆ°å®ƒï¼Œåˆ™ç»ˆæ­¢ OpenOCD è¿›ç¨‹å¹¶è½¬åˆ°<a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">ä¸‹ä¸€éƒ¨åˆ†</a>ã€‚</p>
<p>å¦‚æœæ‚¨æ²¡æœ‰å¾—åˆ°â€œæ–­ç‚¹â€è¡Œï¼Œè¯·å°è¯•ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2.cfg -f target/stm32f3x.cfg
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¦‚æœå…¶ä¸­ä¸€ä¸ªå‘½ä»¤æœ‰æ•ˆï¼Œåˆ™æ„å‘³ç€æ‚¨è·å¾—äº†å‘ç°æ¿çš„æ—§ç¡¬ä»¶ç‰ˆæœ¬ã€‚è¿™ä¸ä¼šæˆä¸ºé—®é¢˜ï¼Œä½†è¯·å°†æ­¤äº‹å®è®°å…¥å†…å­˜ï¼Œå› ä¸ºæ‚¨ç¨åéœ€è¦ä»¥ä¸åŒçš„æ–¹å¼é…ç½®å†…å®¹ã€‚æ‚¨å¯ä»¥è½¬åˆ° <a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">ä¸‹ä¸€éƒ¨åˆ†</a>ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ä»»ä½•å‘½ä»¤ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œï¼Œåˆ™å°è¯•ä»¥ root æƒé™ï¼ˆä¾‹å¦‚<code>sudo openocd ..</code>ï¼‰è¿è¡Œå®ƒä»¬ã€‚å¦‚æœå‘½ä»¤ç¡®å®åœ¨ root æƒé™ä¸‹å·¥ä½œï¼Œåˆ™æ£€æŸ¥<a href="https://docs.rust-embedded.org/book/intro/install/linux.html#udev-rules" target="_blank" rel="noopener">udev è§„åˆ™</a>æ˜¯å¦å·²æ­£ç¡®è®¾ç½®ã€‚</p>
<h1 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h1><h2 id="QUEM"><a href="#QUEM" class="headerlink" title="QUEM"></a>QUEM</h2><p>æˆ‘ä»¬å°†å¼€å§‹ä¸ºCortex-M3 å¾®æ§åˆ¶å™¨<a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>ç¼–å†™ç¨‹åºã€‚æˆ‘ä»¬é€‰æ‹©å®ƒä½œä¸ºæˆ‘ä»¬çš„åˆå§‹ç›®æ ‡ï¼Œå› ä¸ºå®ƒ<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">å¯ä»¥</a>ä½¿ç”¨ QEMU<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">è¿›è¡Œæ¨¡æ‹Ÿ</a>ï¼Œå› æ­¤æ‚¨æ— éœ€åœ¨æœ¬èŠ‚ä¸­æ‘†å¼„ç¡¬ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“æ³¨äºå·¥å…·å’Œå¼€å‘è¿‡ç¨‹ã€‚</p>
<p><strong>é‡è¦ä¿¡æ¯</strong> åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åç§°â€œappâ€ä½œä¸ºé¡¹ç›®åç§°ã€‚æ¯å½“æ‚¨çœ‹åˆ°â€œappâ€ä¸€è¯æ—¶ï¼Œæ‚¨éƒ½åº”è¯¥å°†å…¶æ›¿æ¢ä¸ºæ‚¨ä¸ºé¡¹ç›®é€‰æ‹©çš„åç§°ã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†æ‚¨çš„é¡¹ç›®å‘½åä¸ºâ€œappâ€å¹¶é¿å…æ›¿æ¢ã€‚</p>
<h3 id="åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„-Rust-ç¨‹åº"><a href="#åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„-Rust-ç¨‹åº" class="headerlink" title="åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„ Rust ç¨‹åº"></a>åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„ Rust ç¨‹åº</h3><p>æˆ‘ä»¬å°†ä½¿ç”¨<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>é¡¹ç›®æ¨¡æ¿ä»ä¸­ç”Ÿæˆä¸€ä¸ªæ–°é¡¹ç›®ã€‚åˆ›å»ºçš„é¡¹ç›®å°†åŒ…å«ä¸€ä¸ªå‡†ç³»ç»Ÿåº”ç”¨ç¨‹åºï¼šä¸€ä¸ªæ–°çš„åµŒå…¥å¼ Rust åº”ç”¨ç¨‹åºçš„è‰¯å¥½èµ·ç‚¹ã€‚æ­¤å¤–ï¼Œè¯¥é¡¹ç›®å°†åŒ…å«ä¸€ä¸ª<code>examples</code>ç›®å½•ï¼Œå…¶ä¸­åŒ…å«å‡ ä¸ªå•ç‹¬çš„åº”ç”¨ç¨‹åºï¼Œçªå‡ºæ˜¾ç¤ºäº†ä¸€äº›å…³é”®çš„åµŒå…¥å¼ Rust åŠŸèƒ½ã€‚</p>
<h4 id="ä½¿ç”¨-cargo-generate"><a href="#ä½¿ç”¨-cargo-generate" class="headerlink" title="ä½¿ç”¨ cargo-generate"></a>ä½¿ç”¨ <code>cargo-generate</code></h4><p>é¦–å…ˆå®‰è£…è´§ç‰©ç”Ÿæˆ</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç„¶åç”Ÿæˆä¸€ä¸ªæ–°é¡¹ç›®</p>
<pre class="line-numbers language-console"><code class="language-console">cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä½¿ç”¨-git"><a href="#ä½¿ç”¨-git" class="headerlink" title="ä½¿ç”¨ git"></a>ä½¿ç”¨ <code>git</code></h4><p>å…‹éš†å­˜å‚¨åº“</p>
<pre class="line-numbers language-console"><code class="language-console">git clone https://github.com/rust-embedded/cortex-m-quickstart app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åå¡«å†™<code>Cargo.toml</code>æ–‡ä»¶ä¸­çš„å ä½ç¬¦</p>
<pre class="line-numbers language-toml"><code class="language-toml">[package]
authors = ["{{authors}}"] # "{{authors}}" -> "John Smith"
edition = "2018"
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
version = "0.1.0"

# ..

[[bin]]
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
test = false
bench = false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä½¿ç”¨neither"><a href="#ä½¿ç”¨neither" class="headerlink" title="ä½¿ç”¨neither"></a>ä½¿ç”¨<code>neither</code></h4><p>è·å–<code>cortex-m-quickstart</code>æ¨¡æ¿çš„æœ€æ–°å¿«ç…§å¹¶æå–å®ƒã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">curl -LO https://github.com/rust-embedded/cortex-m-quickstart/archive/master.zip
unzip master.zip
mv cortex-m-quickstart-master app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ–è€…æ‚¨å¯ä»¥æµè§ˆåˆ°<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>ï¼Œå•å‡»ç»¿è‰²çš„â€œå…‹éš†æˆ–ä¸‹è½½â€æŒ‰é’®ï¼Œç„¶åå•å‡»â€œä¸‹è½½ ZIPâ€ã€‚</p>
<p>ç„¶å<code>Cargo.toml</code>æŒ‰ç…§â€œä½¿ç”¨<code>git</code>â€ç‰ˆæœ¬çš„ç¬¬äºŒéƒ¨åˆ†ä¸­çš„æ–¹æ³•å¡«å†™æ–‡ä»¶ä¸­çš„å ä½ç¬¦ã€‚</p>
<h3 id="ç¨‹åºæ¦‚è§ˆ"><a href="#ç¨‹åºæ¦‚è§ˆ" class="headerlink" title="ç¨‹åºæ¦‚è§ˆ"></a>ç¨‹åºæ¦‚è§ˆ</h3><p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œæ˜¯æºä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†<code>src/main.rs</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// your code goes here</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªç¨‹åºä¸æ ‡å‡†çš„ Rust ç¨‹åºæœ‰ç‚¹ä¸åŒï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ã€‚</p>
<p><code>#![no_std]</code>è¡¨ç¤ºè¿™ä¸ªç¨‹åº<em>ä¸ä¼š</em>é“¾æ¥åˆ°æ ‡å‡†åŒ…ï¼Œ <code>std</code>. ç›¸åï¼Œå®ƒå°†é“¾æ¥åˆ°å®ƒçš„å­é›†ï¼š<code>core</code>æ¿æ¡ç®±ã€‚</p>
<p><code>#![no_main]</code>è¡¨ç¤ºè¿™ä¸ªç¨‹åºä¸ä¼šä½¿ç”¨<code>main</code> å¤§å¤šæ•° Rust ç¨‹åºä½¿ç”¨çš„æ ‡å‡†æ¥å£ã€‚ä¸»è¦ï¼ˆæ²¡æœ‰åŒå…³è¯­ï¼‰çš„åŸå› <code>no_main</code>æ˜¯<code>main</code>åœ¨<code>no_std</code>ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ç•Œé¢éœ€è¦æ¯æ™šã€‚</p>
<p><code>use panic_halt as _;</code>. è¿™ä¸ª crate æä¾›äº†ä¸€ä¸ª<code>panic_handler</code>å®šä¹‰ç¨‹åºçš„ææ…Œè¡Œä¸ºã€‚</p>
<p><a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.entry.html" target="_blank" rel="noopener"><code>#[entry]</code></a>æ˜¯<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>crateæä¾›çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæ ‡è®°ç¨‹åºçš„å…¥å£ç‚¹ã€‚ç”±äºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨æ ‡å‡†<code>main</code> æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ç§æ–¹å¼æ¥æŒ‡ç¤ºç¨‹åºçš„å…¥å£ç‚¹ï¼Œé‚£å°±æ˜¯<code>#[entry]</code>.</p>
<p><code>fn main() -&gt; !</code>. æˆ‘ä»¬çš„ç¨‹åºå°†æ˜¯ç›®æ ‡ç¡¬ä»¶ä¸Šè¿è¡Œçš„<em>å”¯ä¸€</em>è¿›ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¸Œæœ›å®ƒç»“æŸï¼æˆ‘ä»¬ä½¿ç”¨<a href="https://doc.rust-lang.org/rust-by-example/fn/diverging.html" target="_blank" rel="noopener">å‘æ•£å‡½æ•°</a>ï¼ˆ<code>-&gt; !</code> å‡½æ•°ç­¾åä¸­çš„ä½ï¼‰æ¥ç¡®ä¿åœ¨ç¼–è¯‘æ—¶å°±æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<h3 id="äº¤å‰ç¼–è¯‘"><a href="#äº¤å‰ç¼–è¯‘" class="headerlink" title="äº¤å‰ç¼–è¯‘"></a>äº¤å‰ç¼–è¯‘</h3><p>ä¸‹ä¸€æ­¥æ˜¯<em>äº¤å‰</em>ç¼–è¯‘ Cortex-M3 æ¶æ„çš„ç¨‹åºã€‚<code>cargo build --target $TRIPLE</code>å¦‚æœæ‚¨çŸ¥é“ç¼–è¯‘ç›®æ ‡ ( <code>$TRIPLE</code>) åº”è¯¥æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆè¿™å°±åƒè¿è¡Œä¸€æ ·ç®€å•ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<code>.cargo/config.toml</code>æ¨¡æ¿ä¸­æœ‰ç­”æ¡ˆï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n6 .cargo/config.toml
[build]
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
# target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¦äº¤å‰ç¼–è¯‘ Cortex-M3 æ¶æ„ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>thumbv7m-none-eabi</code>. å®‰è£… Rust å·¥å…·é“¾æ—¶ä¸ä¼šè‡ªåŠ¨å®‰è£…è¯¥ç›®æ ‡ï¼Œç°åœ¨æ˜¯å°†è¯¥ç›®æ ‡æ·»åŠ åˆ°å·¥å…·é“¾çš„å¥½æ—¶æœºï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰è¿™æ ·åšï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç”±äº<code>thumbv7m-none-eabi</code>ç¼–è¯‘ç›®æ ‡å·²åœ¨æ‚¨çš„<code>.cargo/config.toml</code>æ–‡ä»¶ä¸­è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå› æ­¤ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7m-none-eabi
cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><p>ç°åœ¨æˆ‘ä»¬åœ¨<code>target/thumbv7m-none-eabi/debug/app</code>. æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>cargo-binutils</code>.</p>
<p>éšç€<code>cargo-readobj</code>æˆ‘ä»¬å¯ä»¥æ‰“å°ELFå¤´ï¼Œä»¥ç¡®è®¤è¿™æ˜¯ä¸€ä¸ªARMäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --bin app -- -file-headers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>--bin app</code> æ˜¯ç”¨äºæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ç³– <code>target/$TRIPLE/debug/app</code></li>
<li><code>--bin app</code> å¦‚æœ‰å¿…è¦ï¼Œè¿˜å°†ï¼ˆé‡æ–°ï¼‰ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶</li>
</ul>
<pre class="line-numbers language-text"><code class="language-text">ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0x0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x405
  Start of program headers:          52 (bytes into file)
  Start of section headers:          153204 (bytes into file)
  Flags:                             0x5000200
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         19
  Section header string table index: 18<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>cargo-size</code> å¯ä»¥æ‰“å°äºŒè¿›åˆ¶æ–‡ä»¶çš„é“¾æ¥å™¨éƒ¨åˆ†çš„å¤§å°ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo size --bin app --release -- -A<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬<code>--release</code>ç”¨æ¥æ£€æŸ¥ä¼˜åŒ–ç‰ˆæœ¬</p>
<pre class="line-numbers language-text"><code class="language-text">app  :
section             size        addr
.vector_table       1024         0x0
.text                 92       0x400
.rodata                0       0x45c
.data                  0  0x20000000
.bss                   0  0x20000000
.debug_str          2958         0x0
.debug_loc            19         0x0
.debug_abbrev        567         0x0
.debug_info         4929         0x0
.debug_ranges         40         0x0
.debug_macinfo         1         0x0
.debug_pubnames     2035         0x0
.debug_pubtypes     1892         0x0
.ARM.attributes       46         0x0
.debug_frame         100         0x0
.debug_line          867         0x0
Total              14570<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ELF é“¾æ¥å™¨éƒ¨åˆ†çš„å¤ä¹ </p>
<ul>
<li><code>.text</code> åŒ…å«ç¨‹åºæŒ‡ä»¤</li>
<li><code>.rodata</code> åŒ…å«å¸¸é‡å€¼ï¼Œå¦‚å­—ç¬¦ä¸²</li>
<li><code>.data</code>åŒ…å«åˆå§‹å€¼<em>ä¸</em>ä¸ºé›¶çš„é™æ€åˆ†é…å˜é‡</li>
<li><code>.bss</code>ä¹ŸåŒ…å«é™æ€åˆ†é…çš„å˜é‡ï¼Œå…¶åˆå§‹å€¼ <em>æ˜¯</em>é›¶</li>
<li><code>.vector_table</code>æ˜¯æˆ‘ä»¬ç”¨æ¥å­˜å‚¨å‘é‡ï¼ˆä¸­æ–­ï¼‰è¡¨çš„<em>éæ ‡å‡†</em>éƒ¨åˆ†</li>
<li><code>.ARM.attributes</code>å¹¶ä¸”è¿™äº›<code>.debug_*</code>éƒ¨åˆ†åŒ…å«å…ƒæ•°æ®ï¼Œå¹¶ä¸” åœ¨é—ªçƒäºŒè¿›åˆ¶æ–‡ä»¶æ—¶<em>ä¸ä¼š</em>åŠ è½½åˆ°ç›®æ ‡ä¸Šã€‚</li>
</ul>
</blockquote>
<p><strong>é‡è¦æç¤º</strong>ï¼šELF æ–‡ä»¶åŒ…å«è¯¸å¦‚è°ƒè¯•ä¿¡æ¯ä¹‹ç±»çš„å…ƒæ•°æ®ï¼Œå› æ­¤å®ƒä»¬<em>åœ¨ç£ç›˜</em>ä¸Šçš„<em>å¤§å°*</em>ä¸èƒ½<em>å‡†ç¡®åæ˜ ç¨‹åºåœ¨è®¾å¤‡ä¸Šé—ªçƒæ—¶å°†å ç”¨çš„ç©ºé—´ã€‚</em>å§‹ç»ˆ*ä½¿ç”¨<code>cargo-size</code>æ¥æ£€æŸ¥äºŒè¿›åˆ¶çœŸçš„æœ‰å¤šå¤§ã€‚</p>
<p><code>cargo-objdump</code> å¯ç”¨äºåæ±‡ç¼–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin app --release -- --disassemble --no-show-raw-insn --print-imm-hex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœä¸Šé¢çš„å‘½ä»¤æŠ±æ€¨<code>Unknown command line argument</code>çœ‹åˆ°ä»¥ä¸‹é”™è¯¯æŠ¥å‘Šï¼š<a href="https://github.com/rust-embedded/book/issues/269" target="_blank" rel="noopener">https://github.com/rust-embedded/book/issues/269</a></p>
</blockquote>
<blockquote>
<p><strong>æ³¨æ„</strong>æ­¤è¾“å‡ºåœ¨æ‚¨çš„ç³»ç»Ÿä¸Šå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚æ–°ç‰ˆæœ¬çš„ rustcã€LLVM å’Œåº“å¯ä»¥ç”Ÿæˆä¸åŒçš„ç¨‹åºé›†ã€‚æˆ‘ä»¬æˆªæ–­äº†ä¸€äº›æŒ‡ä»¤ä»¥ä¿æŒä»£ç ç‰‡æ®µè¾ƒå°ã€‚</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">app:  file format ELF32-arm-little

Disassembly of section .text:
main:
     400: bl  #0x256
     404: b #-0x4 <main+0x4>

Reset:
     406: bl  #0x24e
     40a: movw  r0, #0x0
     < .. truncated any more instructions .. >

DefaultHandler_:
     656: b #-0x4 <DefaultHandler_>

UsageFault:
     657: strb  r7, [r4, #0x3]

DefaultPreInit:
     658: bx  lr

__pre_init:
     659: strb  r7, [r0, #0x1]

__nop:
     65a: bx  lr

HardFaultTrampoline:
     65c: mrs r0, msp
     660: b #-0x2 <HardFault_>

HardFault_:
     662: b #-0x4 <HardFault_>

HardFault:
     663: <unknown><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ QEMU ä¸Šè¿è¡ŒåµŒå…¥å¼ç¨‹åºï¼è¿™æ¬¡æˆ‘ä»¬å°†ä½¿ç”¨<code>hello</code>å®é™…æ‰§è¡ŒæŸäº›æ“ä½œçš„ ç¤ºä¾‹ã€‚</p>
<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œçš„æºä»£ç <code>examples/hello.rs</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! Prints "Hello, world!" on the host console using semihosting</span>

<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥ç¨‹åºä½¿ç”¨ç§°ä¸ºåŠä¸»æœºçš„ä¸œè¥¿å°†æ–‡æœ¬æ‰“å°åˆ°<em>ä¸»æœº</em> æ§åˆ¶å°ã€‚å½“ä½¿ç”¨çœŸæ­£çš„ç¡¬ä»¶æ—¶ï¼Œè¿™éœ€è¦ä¸€ä¸ªè°ƒè¯•ä¼šè¯ï¼Œä½†å½“ä½¿ç”¨ QEMU æ—¶ï¼Œå®ƒå°±å¯ä»¥å·¥ä½œã€‚</p>
<p>è®©æˆ‘ä»¬ä»ç¼–è¯‘ç¤ºä¾‹å¼€å§‹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶å°†ä½äº <code>target/thumbv7m-none-eabi/debug/examples/hello</code>.</p>
<p>è¦åœ¨ QEMU ä¸Šè¿è¡Œæ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰“å°æ–‡æœ¬åï¼Œè¯¥å‘½ä»¤åº”æˆåŠŸé€€å‡ºï¼ˆé€€å‡ºä»£ç  = 0ï¼‰ã€‚åœ¨ *nix ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">echo $?
0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹ QEMU å‘½ä»¤ï¼š</p>
<ul>
<li><code>qemu-system-arm</code>. è¿™æ˜¯ QEMU æ¨¡æ‹Ÿå™¨ã€‚è¿™äº› QEMU äºŒè¿›åˆ¶æ–‡ä»¶æœ‰å‡ ä¸ªå˜ä½“ï¼›è¿™ä¸ªå¯¹<em>ARM</em>æœºå™¨è¿›è¡Œå®Œæ•´çš„<em>ç³»ç»Ÿ</em>ä»¿çœŸï¼Œå› æ­¤å¾—åã€‚</li>
<li><code>-cpu cortex-m3</code>. è¿™å‘Šè¯‰ QEMU æ¨¡æ‹Ÿ Cortex-M3 CPUã€‚æŒ‡å®š CPU å‹å·å¯ä»¥è®©æˆ‘ä»¬æ•è·ä¸€äº›é”™è¯¯ç¼–è¯‘é”™è¯¯ï¼šä¾‹å¦‚ï¼Œè¿è¡Œä¸º Cortex-M4F ç¼–è¯‘çš„ç¨‹åºï¼Œå®ƒå…·æœ‰ç¡¬ä»¶ FPUï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¼è‡´ QEMU é”™è¯¯ã€‚</li>
<li><code>-machine lm3s6965evb</code>. è¿™å‘Šè¯‰ QEMU æ¨¡æ‹Ÿ LM3S6965EVBï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å« LM3S6965 å¾®æ§åˆ¶å™¨çš„è¯„ä¼°æ¿ã€‚</li>
<li><code>-nographic</code>. è¿™å‘Šè¯‰ QEMU ä¸è¦å¯åŠ¨å®ƒçš„ GUIã€‚</li>
<li><code>-semihosting-config (..)</code>. è¿™å‘Šè¯‰ QEMU å¯ç”¨åŠä¸»æœºã€‚åŠä¸»æœºå…è®¸æ¨¡æ‹Ÿè®¾å¤‡ä½¿ç”¨ä¸»æœº stdoutã€stderr å’Œ stdin å¹¶åœ¨ä¸»æœºä¸Šåˆ›å»ºæ–‡ä»¶ã€‚</li>
<li><code>-kernel $file</code>. è¿™ä¼šå‘Šè¯‰ QEMU åœ¨æ¨¡æ‹Ÿæœºå™¨ä¸ŠåŠ è½½å’Œè¿è¡Œå“ªä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li>
</ul>
<p>è¾“å…¥è¿™ä¹ˆé•¿çš„ QEMU å‘½ä»¤å¤ªè´¹åŠ›äº†ï¼æˆ‘ä»¬å¯ä»¥è®¾ç½®è‡ªå®šä¹‰è¿è¡Œå™¨æ¥ç®€åŒ–æµç¨‹ã€‚<code>.cargo/config.toml</code>æœ‰ä¸€ä¸ªè¢«æ³¨é‡Šæ‰çš„è°ƒç”¨ QEMU çš„è¿è¡Œç¨‹åºï¼›è®©æˆ‘ä»¬å–æ¶ˆæ³¨é‡Šï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">head -n3 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤è¿è¡Œç¨‹åºä»…é€‚ç”¨äº<code>thumbv7m-none-eabi</code>ç›®æ ‡ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„é»˜è®¤ç¼–è¯‘ç›®æ ‡ã€‚ç°åœ¨<code>cargo run</code>å°†ç¼–è¯‘ç¨‹åºå¹¶åœ¨ QEMU ä¸Šè¿è¡Œå®ƒï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run --example hello --release
   Compiling app v0.1.0 (file:///tmp/app)
    Finished release [optimized + debuginfo] target(s) in 0.26s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/examples/hello`
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>è°ƒè¯•å¯¹äºåµŒå…¥å¼å¼€å‘è‡³å…³é‡è¦ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p>
<p>è°ƒè¯•åµŒå…¥å¼è®¾å¤‡æ¶‰åŠ<em>è¿œç¨‹</em>è°ƒè¯•ï¼Œå› ä¸ºæˆ‘ä»¬è¦è°ƒè¯•çš„ç¨‹åºä¸ä¼šåœ¨è¿è¡Œè°ƒè¯•å™¨ç¨‹åºï¼ˆGDB æˆ– LLDBï¼‰çš„æœºå™¨ä¸Šè¿è¡Œã€‚</p>
<p>è¿œç¨‹è°ƒè¯•æ¶‰åŠå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚åœ¨ QEMU è®¾ç½®ä¸­ï¼Œå®¢æˆ·ç«¯å°†æ˜¯ä¸€ä¸ª GDBï¼ˆæˆ– LLDBï¼‰è¿›ç¨‹ï¼Œè€ŒæœåŠ¡å™¨å°†æ˜¯è¿è¡ŒåµŒå…¥å¼ç¨‹åºçš„ QEMU è¿›ç¨‹ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>hello</code>æˆ‘ä»¬å·²ç»ç¼–è¯‘çš„ç¤ºä¾‹ã€‚</p>
<p>è°ƒè¯•çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯åŠ¨ QEMUï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -gdb tcp::3333 \
  -S \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å‘½ä»¤ä¸ä¼šå‘æ§åˆ¶å°æ‰“å°ä»»ä½•å†…å®¹å¹¶å°†é˜»æ­¢ç»ˆç«¯ã€‚è¿™æ¬¡æˆ‘ä»¬ä¼ é€’äº†ä¸¤ä¸ªé¢å¤–çš„æ ‡å¿—ï¼š</p>
<ul>
<li><code>-gdb tcp::3333</code>. è¿™å‘Šè¯‰ QEMU ç­‰å¾… TCP ç«¯å£ 3333 ä¸Šçš„ GDB è¿æ¥ã€‚</li>
<li><code>-S</code>. è¿™å‘Šè¯‰ QEMU åœ¨å¯åŠ¨æ—¶å†»ç»“æœºå™¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªï¼Œç¨‹åºå°†åœ¨æˆ‘ä»¬æœ‰æœºä¼šå¯åŠ¨è°ƒè¯•å™¨ä¹‹å‰åˆ°è¾¾ main çš„æœ«å°¾ï¼</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨ GDB å¹¶å‘Šè¯‰å®ƒåŠ è½½ç¤ºä¾‹çš„è°ƒè¯•ç¬¦å·ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">gdb-multiarch -q target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>æ³¨æ„</strong>ï¼šæ‚¨å¯èƒ½éœ€è¦å¦ä¸€ä¸ªç‰ˆæœ¬çš„ gdb è€Œä¸æ˜¯<code>gdb-multiarch</code>å–å†³äºæ‚¨åœ¨å®‰è£…ç« èŠ‚ä¸­å®‰è£…çš„é‚£ä¸ªç‰ˆæœ¬ã€‚è¿™ä¹Ÿå¯ä»¥æ˜¯ <code>arm-none-eabi-gdb</code>æˆ–åªæ˜¯<code>gdb</code>.</p>
<p>ç„¶ååœ¨ GDB shell ä¸­æˆ‘ä»¬è¿æ¥åˆ° QEMUï¼Œå®ƒæ­£åœ¨ç­‰å¾… TCP ç«¯å£ 3333 ä¸Šçš„è¿æ¥ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">target remote :3333
Remote debugging using :3333
Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473
473     pub unsafe extern "C" fn Reset() -> ! {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å°†çœ‹åˆ°è¯¥è¿›ç¨‹å·²åœæ­¢ï¼Œå¹¶ä¸”ç¨‹åºè®¡æ•°å™¨æŒ‡å‘åä¸º<code>Reset</code>. è¿™å°±æ˜¯é‡ç½®å¤„ç†ç¨‹åºï¼šCortex-M å†…æ ¸åœ¨å¯åŠ¨æ—¶æ‰§è¡Œçš„æ“ä½œã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œåœ¨æŸäº›è®¾ç½®<code>Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473</code>ä¸­ï¼Œgdb å¯èƒ½ä¼šæ‰“å°ä¸€äº›è­¦å‘Šï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºå¦‚ä¸Šæ‰€ç¤ºçš„è¡Œï¼š</p>
<pre><code>core::num::bignum::Big32x40::mul_small () at src/libcore/num/bignum.rs:254` `src/libcore/num/bignum.rs: No such file or directory.</code></pre><p>è¿™æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„æ•…éšœã€‚æ‚¨å¯ä»¥æ”¾å¿ƒåœ°å¿½ç•¥è¿™äº›è­¦å‘Šï¼Œæ‚¨å¾ˆå¯èƒ½åœ¨ Reset() å¤„ã€‚</p>
</blockquote>
<p>è¿™ä¸ªé‡ç½®å¤„ç†ç¨‹åºæœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬çš„ä¸»å‡½æ•°ã€‚è®©æˆ‘ä»¬ä½¿ç”¨æ–­ç‚¹å’Œ<code>continue</code>å‘½ä»¤ä¸€è·¯è·³è¿‡ã€‚è¦è®¾ç½®æ–­ç‚¹ï¼Œè®©æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹æˆ‘ä»¬æƒ³è¦åœ¨ä»£ç ä¸­ä¸­æ–­çš„ä½ç½®ï¼Œä½¿ç”¨<code>list</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">list main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™å°†æ˜¾ç¤ºæ¥è‡ªæ–‡ä»¶ examples/hello.rs çš„æºä»£ç ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">6       use panic_halt as _;
7
8       use cortex_m_rt::entry;
9       use cortex_m_semihosting::{debug, hprintln};
10
11      #[entry]
12      fn main() -> ! {
13          hprintln!("Hello, world!").unwrap();
14
15          // exit QEMU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬æƒ³åœ¨ç¬¬ 13 è¡Œçš„â€œHello, world!â€ä¹‹å‰æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ã€‚æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹<code>break</code>å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">break 13<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹<code>continue</code>å‘½ä»¤æŒ‡ç¤º gdb è¿è¡Œåˆ°æˆ‘ä»¬çš„ main å‡½æ•°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">continue
Continuing.

Breakpoint 1, hello::__cortex_m_rt_main () at examples\hello.rs:13
13          hprintln!("Hello, world!").unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨æ¥è¿‘æ‰“å°â€œHello, world!â€çš„ä»£ç ã€‚è®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨<code>next</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">next
16          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ­¤æ—¶æ‚¨åº”è¯¥çœ‹åˆ°â€œHello, world!â€ æ‰“å°åœ¨æ­£åœ¨è¿è¡Œçš„ç»ˆç«¯ä¸Š<code>qemu-system-arm</code>ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>next</code>å†æ¬¡è°ƒç”¨å°†ç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">next
[Inferior 1 (Remote target) exited normally]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ‚¨ç°åœ¨å¯ä»¥é€€å‡º GDB ä¼šè¯ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Hardwareï¼ˆç¡¬ä»¶ï¼‰"><a href="#Hardwareï¼ˆç¡¬ä»¶ï¼‰" class="headerlink" title="Hardwareï¼ˆç¡¬ä»¶ï¼‰"></a>Hardwareï¼ˆç¡¬ä»¶ï¼‰</h2><h3 id="äº†è§£ç¡¬ä»¶"><a href="#äº†è§£ç¡¬ä»¶" class="headerlink" title="äº†è§£ç¡¬ä»¶"></a>äº†è§£ç¡¬ä»¶</h3><p>åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦ç¡®å®šç›®æ ‡è®¾å¤‡çš„ä¸€äº›ç‰¹å¾ï¼Œå› ä¸ºè¿™äº›ç‰¹å¾å°†ç”¨äºé…ç½®é¡¹ç›®ï¼š</p>
<ul>
<li>ARM æ ¸å¿ƒã€‚ä¾‹å¦‚çš®è´¨-M3ã€‚</li>
<li>ARM å†…æ ¸æ˜¯å¦åŒ…å« FPUï¼ŸCortex-M4 <strong>F</strong>å’Œ Cortex-M7 <strong>F</strong>å†…æ ¸å¯ä»¥ã€‚</li>
<li>ç›®æ ‡è®¾å¤‡æœ‰å¤šå°‘é—ªå­˜å’Œ RAMï¼Ÿä¾‹å¦‚ 256 KiB çš„é—ªå­˜å’Œ 32 KiB çš„ RAMã€‚</li>
<li>é—ªå­˜å’Œ RAM åœ¨åœ°å€ç©ºé—´ä¸­æ˜ å°„åˆ°å“ªé‡Œï¼Ÿä¾‹å¦‚ï¼ŒRAM é€šå¸¸ä½äº address <code>0x2000_0000</code>ã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥åœ¨æ•°æ®è¡¨æˆ–è®¾å¤‡çš„å‚è€ƒæ‰‹å†Œä¸­æ‰¾åˆ°æ­¤ä¿¡æ¯ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬çš„å‚è€ƒç¡¬ä»¶ STM32F3DISCOVERYã€‚è¯¥æ¿åŒ…å«ä¸€ä¸ª STM32F303VCT6 å¾®æ§åˆ¶å™¨ã€‚è¯¥å¾®æ§åˆ¶å™¨å…·æœ‰ï¼š</p>
<ul>
<li>åŒ…å«å•ç²¾åº¦ FPU çš„ Cortex-M4F å†…æ ¸</li>
<li>ä½äºåœ°å€ 0x0800_0000 çš„ 256 KiB é—ªå­˜ã€‚</li>
<li>ä½äºåœ°å€ 0x2000_0000 çš„ 40 KiB RAMã€‚ï¼ˆè¿˜æœ‰å¦ä¸€ä¸ª RAM åŒºåŸŸï¼Œä½†ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†å¿½ç•¥å®ƒï¼‰ã€‚</li>
</ul>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªæ–°çš„æ¨¡æ¿å®ä¾‹å¼€å§‹ã€‚è¯·å‚é˜… QEMUå…³äºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹æ²¡æœ‰å¤ä¹  <code>cargo-generate</code>ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app

$ cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¬¬ä¸€æ­¥æ˜¯åœ¨<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n5 .cargo/config.toml
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
# target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ä½¿ç”¨<code>thumbv7em-none-eabihf</code>å®ƒè¦†ç›– Cortex-M4F å†…æ ¸ã€‚</p>
<p>ç¬¬äºŒæ­¥æ˜¯å°†å†…å­˜åŒºåŸŸä¿¡æ¯è¾“å…¥åˆ°<code>memory.x</code> æ–‡ä»¶ä¸­ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cat memory.x
/* Linker script for the STM32F303VCT6 */
MEMORY
{
  /* NOTE 1 K = 1 KiBi = 1024 bytes */
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ‚¨<code>memory.x</code>åœ¨å®Œæˆç‰¹å®šæ„å»ºç›®æ ‡çš„ç¬¬ä¸€æ¬¡æ„å»ºåå‡ºäºæŸç§åŸå› æ›´æ”¹äº†æ–‡ä»¶ï¼Œè¯·<code>cargo clean</code>åœ¨ä¹‹å‰æ‰§è¡Œ <code>cargo build</code>ï¼Œå› ä¸º<code>cargo build</code>å¯èƒ½æ— æ³•è·Ÿè¸ª<code>memory.x</code>.</p>
</blockquote>
<p>æˆ‘ä»¬å°†å†æ¬¡ä» hello ç¤ºä¾‹å¼€å§‹ï¼Œä½†é¦–å…ˆæˆ‘ä»¬å¿…é¡»è¿›è¡Œä¸€äº›å°çš„æ›´æ”¹ã€‚</p>
<p>åœ¨ ä¸­<code>examples/hello.rs</code>ï¼Œç¡®ä¿<code>debug::exit()</code>å·²æ³¨é‡Šæ‰æˆ–åˆ é™¤è¯¥è°ƒç”¨ã€‚å®ƒä»…ç”¨äºåœ¨ QEMU ä¸­è¿è¡Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    <span class="token comment" spellcheck="true">// debug::exit(debug::EXIT_SUCCESS);</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ç°åœ¨å¯ä»¥åƒä»¥å‰ä¸€æ ·ä½¿ç”¨äº¤å‰ç¼–è¯‘ç¨‹åº<code>cargo build</code> å’Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶<code>cargo-binutils</code>ã€‚è¯¥ <code>cortex-m-rt</code>ç®±å¤„ç†æ‰€æœ‰çš„é­”æ³•éœ€è¦å¾—åˆ°ä½ çš„èŠ¯ç‰‡ä¸Šè¿è¡Œï¼Œå¦‚æœ‰ç›Šï¼Œå‡ ä¹æ‰€æœ‰çš„Cortex-M CPUçš„å¯åŠ¨ä»¥åŒæ ·çš„æ–¹å¼ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="è°ƒè¯•-1"><a href="#è°ƒè¯•-1" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>è°ƒè¯•çœ‹èµ·æ¥æœ‰ç‚¹ä¸åŒã€‚äº‹å®ä¸Šï¼Œæ ¹æ®ç›®æ ‡è®¾å¤‡çš„ä¸åŒï¼Œç¬¬ä¸€æ­¥çœ‹èµ·æ¥å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºè°ƒè¯•åœ¨ STM32F3DISCOVERY ä¸Šè¿è¡Œçš„ç¨‹åºæ‰€éœ€çš„æ­¥éª¤ã€‚è¿™æ˜¯ä¸ºäº†ä½œä¸ºå‚è€ƒï¼›æœ‰å…³è°ƒè¯•çš„è®¾å¤‡ç‰¹å®šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/rust-embedded/debugonomicon" target="_blank" rel="noopener">Debugonomicon</a>ã€‚</p>
<p>å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å°†è¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼Œå®¢æˆ·ç«¯å°†æ˜¯ä¸€ä¸ª GDB è¿›ç¨‹ã€‚ç„¶è€Œï¼Œè¿™ä¸€æ¬¡ï¼ŒæœåŠ¡å™¨å°†æ˜¯ OpenOCDã€‚</p>
<p>æ­£å¦‚åœ¨å®‰è£…éªŒè¯éƒ¨åˆ†æ‰€åšçš„é‚£æ ·ï¼Œå°†å‘ç°æ¿è¿æ¥åˆ°æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC å¹¶æ£€æŸ¥ ST-LINK æ ‡å¤´æ˜¯å¦å·²å¡«å……ã€‚</p>
<p>åœ¨ç»ˆç«¯ä¸Šè¿è¡Œ<code>openocd</code>ä»¥è¿æ¥åˆ°å‘ç°æ¿ä¸Šçš„ ST-LINKã€‚ä»æ¨¡æ¿çš„æ ¹ç›®å½•è¿è¡Œæ­¤å‘½ä»¤ï¼›<code>openocd</code>å°†æ‹¾å– <code>openocd.cfg</code>æŒ‡ç¤ºä½¿ç”¨å“ªä¸ªæ¥å£æ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶çš„æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.cfg
# Sample OpenOCD configuration for the STM32F3DISCOVERY development board

# Depending on the hardware revision you got you'll have to pick ONE of these
# interfaces. At any time only one interface should be commented out.

# Revision C (newer revision)
source [find interface/stlink.cfg]

# Revision A and B (older revisions)
# source [find interface/stlink-v2.cfg]

source [find target/stm32f3x.cfg]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨åœ¨éªŒè¯éƒ¨åˆ†å‘ç°å‘ç°æ¿çš„ç‰ˆæœ¬è¾ƒæ—§ï¼Œåˆ™æ­¤æ—¶åº”ä¿®æ”¹<code>openocd.cfg</code> æ–‡ä»¶ä»¥ä½¿ç”¨<code>interface/stlink-v2.cfg</code>.</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.913879
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸Šè¿è¡Œ GDBï¼Œä¹Ÿæ˜¯ä»æ¨¡æ¿çš„æ ¹ç›®å½•ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ <gdb> -q target/thumbv7em-none-eabihf/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥å°† GDB è¿æ¥åˆ° OpenOCDï¼Œå®ƒæ­£åœ¨ç­‰å¾…ç«¯å£ 3333 ä¸Šçš„ TCP è¿æ¥ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ç»§ç»­ä½¿ç”¨å‘½ä»¤å°†ç¨‹åº<em>é—ªå­˜</em>ï¼ˆåŠ è½½ï¼‰åˆ°å¾®æ§åˆ¶å™¨ä¸Š <code>load</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) load
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¨‹åºç°åœ¨å·²åŠ è½½ã€‚è¯¥ç¨‹åºä½¿ç”¨åŠä¸»æœºï¼Œå› æ­¤åœ¨æˆ‘ä»¬è¿›è¡Œä»»ä½•åŠä¸»æœºè°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å‘Šè¯‰ OpenOCD å¯ç”¨åŠä¸»æœºã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤å‘ OpenOCD å‘é€å‘½ä»¤<code>monitor</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨<code>monitor help</code>å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ OpenOCD å‘½ä»¤ã€‚</p>
</blockquote>
<p>åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ç›´è·³è¿‡<code>main</code>ä½¿ç”¨æ–­ç‚¹å’Œ <code>continue</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main
Breakpoint 1 at 0x8000d18: file examples/hello.rs, line 15.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, main () at examples/hello.rs:15
15          let mut stdout = hio::hstdout().unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœåœ¨æ‚¨å‘å‡ºä¸Šè¿°<code>continue</code>å‘½ä»¤å GDB é˜»å¡ç»ˆç«¯è€Œä¸æ˜¯ç‚¹å‡»æ–­ç‚¹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä»”ç»†æ£€æŸ¥æ–‡ä»¶ä¸­çš„å†…å­˜åŒºåŸŸä¿¡æ¯<code>memory.x</code>æ˜¯å¦ä¸ºæ‚¨çš„è®¾å¤‡æ­£ç¡®è®¾ç½®ï¼ˆå¼€å§‹<em>å’Œ</em>é•¿åº¦ï¼‰ã€‚</p>
</blockquote>
<p>æ¨è¿›ç¨‹åº<code>next</code>åº”è¯¥äº§ç”Ÿä¸ä»¥å‰ç›¸åŒçš„ç»“æœã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next
16          writeln!(stdout, "Hello, world!").unwrap();

(gdb) next
19          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤æ—¶æ‚¨åº”è¯¥çœ‹åˆ°â€œHello, world!â€ æ‰“å°åœ¨ OpenOCD æ§åˆ¶å°ä¸Šï¼Œç­‰ç­‰ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08000e6c
Hello, world!
Info : halted: PC: 0x08000d62
Info : halted: PC: 0x08000d64
Info : halted: PC: 0x08000d66
Info : halted: PC: 0x08000d6a
Info : halted: PC: 0x08000a0c
Info : halted: PC: 0x08000d70
Info : halted: PC: 0x08000d72<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘å‡ºå¦ä¸€ä¸ª<code>next</code>å°†ä½¿å¤„ç†å™¨æ‰§è¡Œ<code>debug::exit</code>ã€‚è¿™å……å½“æ–­ç‚¹å¹¶åœæ­¢è¿›ç¨‹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next

Program received signal SIGTRAP, Trace/breakpoint trap.
0x0800141a in __syscall ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®ƒè¿˜ä¼šå¯¼è‡´å°†å…¶æ‰“å°åˆ° OpenOCD æ§åˆ¶å°ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08001188
semihosting: *** application exited ***
Warn : target not halted
Warn : target not halted
target halted due to breakpoint, current mode: Thread
xPSR: 0x21000000 pc: 0x08000d76 msp: 0x20009fc0, semihosting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯ï¼Œåœ¨å¾®æ§åˆ¶å™¨ä¸Šè¿è¡Œçš„è¿›ç¨‹å°šæœªç»ˆæ­¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>continue</code>æˆ–ç±»ä¼¼å‘½ä»¤æ¢å¤å®ƒã€‚</p>
<p>æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨è¯¥<code>quit</code>å‘½ä»¤é€€å‡º GDB ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è°ƒè¯•ç°åœ¨éœ€è¦æ›´å¤šçš„æ­¥éª¤ï¼Œå› æ­¤æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›æ­¥éª¤æ‰“åŒ…åˆ°ä¸€ä¸ªåä¸º<code>openocd.gdb</code>. è¯¥æ–‡ä»¶æ˜¯åœ¨è¯¥<code>cargo generate</code>æ­¥éª¤ä¸­åˆ›å»ºçš„ï¼Œåº”è¯¥æ— éœ€ä»»ä½•ä¿®æ”¹å³å¯å·¥ä½œã€‚è®©æˆ‘ä»¬æœ‰ä¸€ä¸ªé«˜å³°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.gdb
target extended-remote :3333

# print demangled symbols
set print asm-demangle on

# detect unhandled exceptions, hard faults and panics
break DefaultHandler
break HardFault
break rust_begin_unwind

monitor arm semihosting enable

load

# start the process but immediately halt the processor
stepi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨è¿è¡Œ<code>&lt;gdb&gt; -x openocd.gdb target/thumbv7em-none-eabihf/debug/examples/hello</code>å°†ç«‹å³å°† GDB è¿æ¥åˆ° OpenOCDï¼Œå¯ç”¨åŠä¸»æœºï¼ŒåŠ è½½ç¨‹åºå¹¶å¯åŠ¨è¿›ç¨‹ã€‚</p>
<p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥å˜æˆ<code>&lt;gdb&gt; -x openocd.gdb</code>è‡ªå®šä¹‰è¿è¡Œ<code>cargo run</code>ç¨‹åºæ¥ æ„å»ºç¨‹åº<em>å¹¶</em>å¯åŠ¨ GDB ä¼šè¯ã€‚æ­¤è¿è¡Œç¨‹åºåŒ…å«åœ¨<code>.cargo/config.toml</code>ä½†å·²æ³¨é‡Šæ‰ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">head -n10 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
# runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"

[target.'cfg(all(target_arch = "arm", target_os = "none"))']
# uncomment ONE of these three option to make `cargo run` start a GDB session
# which option to pick depends on your system
runner = "arm-none-eabi-gdb -x openocd.gdb"
# runner = "gdb-multiarch -x openocd.gdb"
# runner = "gdb -x openocd.gdb"
$ cargo run --example hello
(..)
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Memory-Mapped-Registers"><a href="#Memory-Mapped-Registers" class="headerlink" title="Memory Mapped Registers"></a>Memory Mapped Registers</h2><p>åµŒå…¥å¼ç³»ç»Ÿåªèƒ½é€šè¿‡æ‰§è¡Œæ™®é€šçš„ Rust ä»£ç å¹¶åœ¨ RAM ä¸­ç§»åŠ¨æ•°æ®æ¥å®ç°ã€‚å¦‚æœæˆ‘ä»¬æƒ³å°†ä»»ä½•ä¿¡æ¯è¾“å…¥æˆ–è¾“å‡ºæˆ‘ä»¬çš„ç³»ç»Ÿï¼ˆä¾‹å¦‚é—ªçƒ LEDã€æ£€æµ‹æŒ‰é’®æŒ‰ä¸‹æˆ–ä¸æŸç§æ€»çº¿ä¸Šçš„ç‰‡å¤–å¤–å›´è®¾å¤‡é€šä¿¡ï¼‰ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ·±å…¥äº†è§£å¤–è®¾åŠå…¶â€œå†…å­˜æ˜ å°„å¯„å­˜å™¨â€ã€‚</p>
<p>æ‚¨å¯èƒ½ä¼šå‘ç°è®¿é—®å¾®æ§åˆ¶å™¨ä¸­çš„å¤–å›´è®¾å¤‡æ‰€éœ€çš„ä»£ç å·²ç»ç¼–å†™å¥½äº†ï¼Œä½äºä»¥ä¸‹çº§åˆ«ä¹‹ä¸€ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/crates.png" alt=""></p>
<ul>
<li>Micro-architecture Crate - æ­¤ç±» crate å¤„ç†æ‚¨çš„å¾®æ§åˆ¶å™¨ä½¿ç”¨çš„å¤„ç†å™¨å†…æ ¸é€šç”¨çš„ä»»ä½•æœ‰ç”¨ä¾‹ç¨‹ï¼Œä»¥åŠä½¿ç”¨è¯¥ç‰¹å®šç±»å‹å¤„ç†å™¨å†…æ ¸çš„æ‰€æœ‰å¾®æ§åˆ¶å™¨é€šç”¨çš„ä»»ä½•å¤–å›´è®¾å¤‡ã€‚ä¾‹å¦‚ï¼Œ<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate ä¸ºæ‚¨æä¾›äº†å¯ç”¨å’Œç¦ç”¨ä¸­æ–­çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¯¹äºæ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨éƒ½æ˜¯ç›¸åŒçš„ã€‚å®ƒè¿˜å…è®¸æ‚¨è®¿é—®æ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨ä¸­åŒ…å«çš„â€œSysTickâ€å¤–è®¾ã€‚</li>
<li>å¤–è®¾è®¿é—®æ¿æ¡ç®± (PAC) - è¿™ç§æ¿æ¡ç®±æ˜¯ä¸ºæ‚¨æ­£åœ¨ä½¿ç”¨çš„å¾®æ§åˆ¶å™¨çš„ç‰¹å®šéƒ¨ä»¶å·å®šä¹‰çš„å„ç§å†…å­˜åŒ…è£…å™¨å¯„å­˜å™¨çš„è–„åŒ…è£…å™¨ã€‚ä¾‹å¦‚ï¼Œ<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>é€‚ç”¨äº Texas Instruments Tiva-C TM4C123 ç³»åˆ—ï¼Œæˆ–<a href="https://crates.io/crates/stm32f30x" target="_blank" rel="noopener">stm32f30x</a>é€‚ç”¨äº ST-Micro STM32F30x ç³»åˆ—ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å°†æŒ‰ç…§å¾®æ§åˆ¶å™¨æŠ€æœ¯å‚è€ƒæ‰‹å†Œä¸­ç»™å‡ºçš„æ¯ä¸ªå¤–å›´è®¾å¤‡çš„æ“ä½œè¯´æ˜ç›´æ¥ä¸å¯„å­˜å™¨äº¤äº’ã€‚</li>
<li>HAL Crate - è¿™äº› crate ä¸ºæ‚¨çš„ç‰¹å®šå¤„ç†å™¨æä¾›æ›´åŠ ç”¨æˆ·å‹å¥½çš„ APIï¼Œé€šå¸¸é€šè¿‡å®ç°ä¸€äº›åœ¨<a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener">Embedded-hal </a>ä¸­å®šä¹‰çš„å¸¸è§ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ª crate å¯èƒ½æä¾›ä¸€ä¸ª<code>Serial</code>ç»“æ„ä½“ï¼Œå¸¦æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°é‡‡ç”¨ä¸€ç»„é€‚å½“çš„ GPIO å¼•è„šå’Œæ³¢ç‰¹ç‡ï¼Œå¹¶æä¾›æŸç§<code>write_byte</code>å‘é€æ•°æ®çš„åŠŸèƒ½ã€‚</li>
<li>Board Crate - è¿™äº› crate æ¯” HAL Crate æ›´è¿›ä¸€æ­¥ï¼Œé€šè¿‡é¢„é…ç½®å„ç§å¤–è®¾å’Œ GPIO å¼•è„šä»¥é€‚åˆæ‚¨æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šå¼€å‘äººå‘˜å¥—ä»¶æˆ–æ¿ï¼Œä¾‹å¦‚<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>ç”¨äº STM32F3DISCOVERY æ¿ã€‚</li>
</ul>
<h3 id="æ¿æ¡ç®±"><a href="#æ¿æ¡ç®±" class="headerlink" title="æ¿æ¡ç®±"></a>æ¿æ¡ç®±</h3><p>å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰åµŒå…¥å¼ Rustï¼Œæ¿æ¡ç®±æ˜¯å®Œç¾çš„èµ·ç‚¹ã€‚ä»–ä»¬å¾ˆå¥½åœ°æŠ½è±¡äº†å¼€å§‹å­¦ä¹ è¿™ä¸ªä¸»é¢˜æ—¶å¯èƒ½ä¼šè®©äººä¸çŸ¥æ‰€æªçš„ç¡¬ä»¶ç»†èŠ‚ï¼Œå¹¶ä½¿æ ‡å‡†ä»»åŠ¡å˜å¾—ç®€å•ï¼Œæ¯”å¦‚æ‰“å¼€æˆ–å…³é—­ LEDã€‚å®ƒä»¬å…¬å¼€çš„åŠŸèƒ½å› æ¿è€Œå¼‚ã€‚ç”±äºæœ¬ä¹¦æ—¨åœ¨ä¿æŒä¸ç¡¬ä»¶æ— å…³ï¼Œå› æ­¤æœ¬ä¹¦ä¸ä¼šæ¶µç›–æ¿æ¡ç®±ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³è¯•ç”¨ STM32F3DISCOVERY æ¿ï¼Œå¼ºçƒˆå»ºè®®æŸ¥çœ‹<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>æ¿ç®±ï¼Œå®ƒæä¾›ä½¿æ¿ LED é—ªçƒã€è®¿é—®æŒ‡å—é’ˆã€è“ç‰™ç­‰åŠŸèƒ½ã€‚<a href="https://rust-embedded.github.io/discovery/" target="_blank" rel="noopener">discovery</a>æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»ä½¿ç”¨æ¿ç®±çš„ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªè¿˜æ²¡æœ‰ä¸“ç”¨æ¿æ¡ç®±çš„ç³»ç»Ÿï¼Œæˆ–è€…æ‚¨éœ€è¦ç°æœ‰æ¿æ¡ç®±æœªæä¾›çš„åŠŸèƒ½ï¼Œè¯·ç»§ç»­é˜…è¯»æˆ‘ä»¬ä»åº•éƒ¨å¼€å§‹çš„å¾®æ¶æ„æ¿æ¡ç®±ã€‚</p>
<h3 id="å¾®æ¶æ„ç®±"><a href="#å¾®æ¶æ„ç®±" class="headerlink" title="å¾®æ¶æ„ç®±"></a>å¾®æ¶æ„ç®±</h3><p>è®©æˆ‘ä»¬çœ‹çœ‹æ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨é€šç”¨çš„ SysTick å¤–è®¾ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate ä¸­æ‰¾åˆ°ä¸€ä¸ªéå¸¸ä½çº§çš„ API ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>syst<span class="token punctuation">,</span> Peripherals<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> systick <span class="token operator">=</span> peripherals<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>systick<span class="token punctuation">.</span><span class="token function">has_wrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Loop</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨åŠŸèƒ½<code>SYST</code>ç»“æ„éå¸¸ç´§å¯†æ˜ å°„åˆ°ç”±ARMæŠ€æœ¯å‚è€ƒæ‰‹å†Œæ­¤å¤–è®¾å®šä¹‰çš„åŠŸèƒ½ã€‚è¿™ä¸ª API ä¸­æ²¡æœ‰å…³äºâ€œå»¶è¿Ÿ X æ¯«ç§’â€çš„å†…å®¹â€”â€”æˆ‘ä»¬å¿…é¡»è‡ªå·±ä½¿ç”¨<code>while</code>å¾ªç¯ç²—ç•¥åœ°å®ç°å®ƒã€‚è¯·æ³¨æ„ï¼Œ<code>SYST</code>åœ¨è°ƒç”¨ä¹‹å‰æˆ‘ä»¬æ— æ³•è®¿é—®æˆ‘ä»¬çš„ç»“æ„<code>Peripherals::take()</code>- è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹ç¨‹ï¼Œå¯ä¿è¯<code>SYST</code>æˆ‘ä»¬æ•´ä¸ªç¨‹åºä¸­åªæœ‰ä¸€ä¸ªç»“æ„ã€‚</p>
<h3 id="ä½¿ç”¨å¤–è®¾è®¿é—®ç®±-PAC"><a href="#ä½¿ç”¨å¤–è®¾è®¿é—®ç®±-PAC" class="headerlink" title="ä½¿ç”¨å¤–è®¾è®¿é—®ç®± (PAC)"></a>ä½¿ç”¨å¤–è®¾è®¿é—®ç®± (PAC)</h3><p>å¦‚æœæˆ‘ä»¬å°†è‡ªå·±é™åˆ¶åœ¨æ¯ä¸ª Cortex-M é™„å¸¦çš„åŸºæœ¬å¤–å›´è®¾å¤‡ä¸Šï¼Œæˆ‘ä»¬çš„åµŒå…¥å¼è½¯ä»¶å¼€å‘å°±ä¸ä¼šèµ°å¾—å¤ªè¿œã€‚åœ¨æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬å°†éœ€è¦ç¼–å†™ä¸€äº›ç‰¹å®šäºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šå¾®æ§åˆ¶å™¨çš„ä»£ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Texas Instruments TM4C123â€”â€”ä¸€ä¸ªä¸­ç­‰çš„ 80MHz Cortex-M4ï¼Œå…·æœ‰ 256 KiB çš„é—ªå­˜ã€‚æˆ‘ä»¬å°†æ‹‰å…¥<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>æ¿æ¡ç®±ä»¥ä½¿ç”¨è¯¥èŠ¯ç‰‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> Leds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> tm4c123x<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> pwm <span class="token operator">=</span> p<span class="token punctuation">.</span>PWM0<span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Mode = 1 => Count up/down mode</span>
    pwm<span class="token punctuation">.</span>_2_ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_gena<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">actcmpau</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actcmpad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 528 cycles (264 up and down) = 4 loops per video line (2112 cycles)</span>
    pwm<span class="token punctuation">.</span>_2_load<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">263</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_cmpa<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">compa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">pwm4en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è®¿é—®çš„<code>PWM0</code>å¤–è®¾å®Œå…¨ç›¸åŒçš„æ–¹å¼ï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®çš„<code>SYST</code>å¤–å›´è¾ƒæ—©ï¼Œä½†æˆ‘ä»¬å«<code>tm4c123x::Peripherals::take()</code>ã€‚ç”±äºè¿™ä¸ª crate æ˜¯ä½¿ç”¨<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¯„å­˜å™¨å­—æ®µçš„è®¿é—®å‡½æ•°é‡‡ç”¨é—­åŒ…ï¼Œè€Œä¸æ˜¯æ•°å­—å‚æ•°ã€‚è™½ç„¶è¿™çœ‹èµ·æ¥åƒå¾ˆå¤šä»£ç ï¼Œä½† Rust ç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨å®ƒä¸ºæˆ‘ä»¬æ‰§è¡Œä¸€å †æ£€æŸ¥ï¼Œç„¶åç”Ÿæˆéå¸¸æ¥è¿‘æ‰‹å†™æ±‡ç¼–å™¨çš„æœºå™¨ä»£ç ï¼è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç æ— æ³•ç¡®å®šç‰¹å®šè®¿é—®å™¨å‡½æ•°çš„æ‰€æœ‰å¯èƒ½å‚æ•°éƒ½æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ SVD å°†å¯„å­˜å™¨å®šä¹‰ä¸º 32 ä½ï¼Œä½†æ²¡æœ‰è¯´æ˜è¿™äº› 32 ä½å€¼ä¸­çš„æŸäº›å€¼æ˜¯å¦æœ‰æ•ˆï¼‰æœ‰ç‰¹æ®Šæ„ä¹‰ï¼‰ï¼Œåˆ™è¯¥å‡½æ•°è¢«æ ‡è®°ä¸º<code>unsafe</code>. åœ¨ä½¿ç”¨è¯¥å‡½æ•°è®¾ç½®<code>load</code>å’Œ<code>compa</code>å­å­—æ®µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹<code>bits()</code>ã€‚</p>
<h4 id="è¯»"><a href="#è¯»" class="headerlink" title="è¯»"></a>è¯»</h4><p>è¯¥<code>read()</code>å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æä¾›å¯¹è¯¥å¯„å­˜å™¨ä¸­å„ä¸ªå­å­—æ®µçš„åªè¯»è®¿é—®ï¼Œå¦‚è¯¥èŠ¯ç‰‡åˆ¶é€ å•†çš„ SVD æ–‡ä»¶æ‰€å®šä¹‰ã€‚æ‚¨å¯ä»¥<code>R</code>åœ¨<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.R.html" target="_blank" rel="noopener">tm4c123x æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æ­¤ç‰¹å®šå¯„å­˜å™¨çš„ç‰¹æ®Šè¿”å›ç±»å‹ã€æ­¤ç‰¹å®šå¤–è®¾ã€æ­¤ç‰¹å®šèŠ¯ç‰‡ä¸Šçš„æ‰€æœ‰å¯ç”¨å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">if</span> pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Do a thing</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="å†™"><a href="#å†™" class="headerlink" title="å†™"></a>å†™</h4><p>è¯¥<code>write()</code>å‡½æ•°é‡‡ç”¨å¸¦æœ‰å•ä¸ªå‚æ•°çš„é—­åŒ…ã€‚é€šå¸¸æˆ‘ä»¬ç§°ä¹‹ä¸º<code>w</code>. ç„¶åï¼Œæ­¤å‚æ•°æä¾›å¯¹è¯¥å¯„å­˜å™¨å†…çš„å„ç§å­å­—æ®µçš„è¯»å†™è®¿é—®ï¼Œå¦‚è¯¥èŠ¯ç‰‡åˆ¶é€ å•†çš„ SVD æ–‡ä»¶æ‰€å®šä¹‰çš„é‚£æ ·ã€‚åŒæ ·ï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.W.html" target="_blank" rel="noopener">tm4c123x æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æ­¤ç‰¹å®šå¯„å­˜å™¨ã€æ­¤ç‰¹å®šå¤–è®¾ã€æ­¤ç‰¹å®šèŠ¯ç‰‡ä¸Šçš„â€œwâ€ä¸Šå¯ç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æœªè®¾ç½®çš„æ‰€æœ‰å­å­—æ®µå°†ä¸ºæˆ‘ä»¬è®¾ç½®ä¸ºé»˜è®¤å€¼ - å¯„å­˜å™¨ä¸­çš„ä»»ä½•ç°æœ‰å†…å®¹éƒ½å°†ä¸¢å¤±ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h4><p>å¦‚æœæˆ‘ä»¬åªæƒ³æ”¹å˜è¿™ä¸ªå¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªç‰¹å®šå­å­—æ®µè€Œå…¶ä»–å­å­—æ®µä¿æŒä¸å˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥<code>modify</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªå‚æ•°çš„é—­åŒ…â€”â€”ä¸€ä¸ªç”¨äºè¯»å–ï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚é€šå¸¸æˆ‘ä»¬åˆ†åˆ«ç§°å®ƒä»¬ä¸º<code>r</code>å’Œ<code>w</code>ã€‚è¯¥<code>r</code>å‚æ•°å¯ä»¥ç”¨æ¥æ£€æŸ¥æ‰€è¿°å¯„å­˜å™¨çš„å½“å‰å†…å®¹ï¼Œå¹¶ä¸”<code>w</code>å‚æ•°å¯ä»¥ç”¨æ¥ä¿®æ”¹å¯„å­˜å™¨çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¯¥<code>modify</code>å‡½æ•°åœ¨è¿™é‡ŒçœŸæ­£å±•ç¤ºäº†é—­åŒ…çš„å¨åŠ›ã€‚åœ¨ C ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è¯»å…¥ä¸€äº›ä¸´æ—¶å€¼ï¼Œä¿®æ”¹æ­£ç¡®çš„ä½ï¼Œç„¶åå°†å€¼å†™å›ã€‚è¿™æ„å‘³ç€å­˜åœ¨ç›¸å½“å¤§çš„é”™è¯¯èŒƒå›´ï¼š</p>
<pre class="line-numbers language-C"><code class="language-C">uint32_t temp = pwm0.ctl.read();
temp |= PWM0_CTL_GLOBALSYNC0;
pwm0.ctl.write(temp);
uint32_t temp2 = pwm0.enable.read();
temp2 |= PWM0_ENABLE_PWM4EN;
pwm0.enable.write(temp); // Uh oh! Wrong variable!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä½¿ç”¨-HAL-æ¿æ¡ç®±"><a href="#ä½¿ç”¨-HAL-æ¿æ¡ç®±" class="headerlink" title="ä½¿ç”¨ HAL æ¿æ¡ç®±"></a>ä½¿ç”¨ HAL æ¿æ¡ç®±</h3><p>èŠ¯ç‰‡çš„ HAL crate é€šå¸¸é€šè¿‡ä¸º PAC å…¬å¼€çš„åŸå§‹ç»“æ„å®ç°è‡ªå®šä¹‰ Trait æ¥å·¥ä½œã€‚é€šå¸¸ï¼Œæ­¤ç‰¹å¾ä¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨<code>constrain()</code>å•ä¸ªå¤–è®¾æˆ–<code>split()</code>å…·æœ‰å¤šä¸ªå¼•è„šçš„ GPIO ç«¯å£ä¹‹ç±»çš„ä¸œè¥¿ã€‚æ­¤å‡½æ•°å°†æ¶ˆè€—åº•å±‚åŸå§‹å¤–å›´ç»“æ„å¹¶è¿”å›å…·æœ‰æ›´é«˜çº§åˆ« API çš„æ–°å¯¹è±¡ã€‚è¿™ä¸ª API ä¹Ÿå¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®©ä¸²å£<code>new</code>åŠŸèƒ½éœ€è¦å€Ÿç”¨ä¸€äº›<code>Clock</code>ç»“æ„ï¼Œåªèƒ½é€šè¿‡è°ƒç”¨é…ç½® PLL å’Œè®¾ç½®æ‰€æœ‰æ—¶é’Ÿé¢‘ç‡çš„å‡½æ•°æ¥ç”Ÿæˆã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œé™æ€åœ°ä¸å¯èƒ½åœ¨æ²¡æœ‰é¦–å…ˆé…ç½®æ—¶é’Ÿé€Ÿç‡çš„æƒ…å†µä¸‹åˆ›å»ºä¸²è¡Œç«¯å£å¯¹è±¡ï¼Œæˆ–è€…ä¸²è¡Œç«¯å£å¯¹è±¡å°†æ³¢ç‰¹ç‡é”™è¯¯åœ°è½¬æ¢ä¸ºæ—¶é’Ÿæ»´ç­”ã€‚ä¸€äº› crate ç”šè‡³ä¸ºæ¯ä¸ª GPIO å¼•è„šå¯ä»¥å¤„äºçš„çŠ¶æ€å®šä¹‰ç‰¹æ®Šç‰¹å¾ï¼Œè¦æ±‚ç”¨æˆ·åœ¨å°†å¼•è„šä¼ é€’åˆ°å¤–è®¾ä¹‹å‰å°†å¼•è„šç½®äºæ­£ç¡®çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡é€‰æ‹©é€‚å½“çš„å¤‡ç”¨åŠŸèƒ½æ¨¡å¼ï¼‰ã€‚ä¸€åˆ‡éƒ½æ²¡æœ‰è¿è¡Œæ—¶æˆæœ¬ï¼</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal <span class="token keyword">as</span> hal<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>NewlineMode<span class="token punctuation">,</span> Serial<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>sysctl<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>CorePeripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the SYSCTL struct into an object with a higher-layer API</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sc <span class="token operator">=</span> p<span class="token punctuation">.</span>SYSCTL<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Pick our oscillation settings</span>
    sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span>oscillator <span class="token operator">=</span> sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>Oscillator<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Main</span><span class="token punctuation">(</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>CrystalFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_16mhz<span class="token punctuation">,</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>SystemClock<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UsePll</span><span class="token punctuation">(</span>sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>PllOutputFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_80_00mhz<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Configure the PLL with those settings</span>
    <span class="token keyword">let</span> clocks <span class="token operator">=</span> sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the GPIO_PORTA struct into an object with a higher-layer API.</span>
    <span class="token comment" spellcheck="true">// Note it needs to borrow `sc.power_control` so it can power up the GPIO</span>
    <span class="token comment" spellcheck="true">// peripheral automatically.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> porta <span class="token operator">=</span> p<span class="token punctuation">.</span>GPIO_PORTA<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Activate the UART.</span>
    <span class="token keyword">let</span> uart <span class="token operator">=</span> Serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">uart0</span><span class="token punctuation">(</span>
        p<span class="token punctuation">.</span>UART0<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The transmit pin</span>
        porta
            <span class="token punctuation">.</span>pa1
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The receive pin</span>
        porta
            <span class="token punctuation">.</span>pa0
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// No RTS or CTS required</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The baud rate</span>
        <span class="token number">115200_u32</span><span class="token punctuation">.</span><span class="token function">bps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// Output handling</span>
        NewlineMode<span class="token punctuation">:</span><span class="token punctuation">:</span>SwapLFtoCRLF<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need the clock rates to calculate the baud rate divisors</span>
        <span class="token operator">&amp;</span>clocks<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need this to power up the UART peripheral</span>
        <span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>uart<span class="token punctuation">,</span> <span class="token string">"Hello, World!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Semihostingï¼ˆåŠä¸»æœºï¼‰"><a href="#Semihostingï¼ˆåŠä¸»æœºï¼‰" class="headerlink" title="Semihostingï¼ˆåŠä¸»æœºï¼‰"></a>Semihostingï¼ˆåŠä¸»æœºï¼‰</h2><p>åŠä¸»æœºæ˜¯ä¸€ç§è®©åµŒå…¥å¼è®¾å¤‡åœ¨ä¸»æœºä¸Šè¿›è¡Œ I/O çš„æœºåˆ¶ï¼Œä¸»è¦ç”¨äºå°†æ¶ˆæ¯è®°å½•åˆ°ä¸»æœºæ§åˆ¶å°ã€‚åŠä¸»æœºéœ€è¦ä¸€ä¸ªè°ƒè¯•ä¼šè¯ï¼Œå‡ ä¹ä¸éœ€è¦å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼ˆæ²¡æœ‰é¢å¤–çš„ç”µçº¿ï¼ï¼‰æ‰€ä»¥å®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚ç¼ºç‚¹æ˜¯å®ƒéå¸¸æ…¢ï¼šæ ¹æ®æ‚¨ä½¿ç”¨çš„ç¡¬ä»¶è°ƒè¯•å™¨ï¼ˆä¾‹å¦‚ ST-Linkï¼‰ï¼Œæ¯ä¸ªå†™å…¥æ“ä½œå¯èƒ½éœ€è¦å‡ æ¯«ç§’ã€‚</p>
<p>è¯¥<a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>ç®±æä¾›äº†ä¸€ä¸ªAPIåšçš„Cortex-Mçš„è®¾å¤‡åŠä¸»æœºæ“ä½œã€‚ä¸‹é¢çš„ç¨‹åºæ˜¯â€œHello, world!â€çš„åŠä¸»æœºç‰ˆæœ¬ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hprintln<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½ åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä½ ä¼šçœ‹åˆ°â€œHello, world!â€ OpenOCD æ—¥å¿—ä¸­çš„æ¶ˆæ¯ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Hello, world!
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ç¡®å®éœ€è¦å…ˆä» GDB åœ¨ OpenOCD ä¸­å¯ç”¨åŠä¸»æœºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>QEMU ç†è§£åŠä¸»æœºæ“ä½œï¼Œå› æ­¤ä¸Šè¿°ç¨‹åºä¹Ÿå¯ä»¥è¿è¡Œè€Œ <code>qemu-system-arm</code>æ— éœ€å¯åŠ¨è°ƒè¯•ä¼šè¯ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦å°†<code>-semihosting-config</code>æ ‡å¿—ä¼ é€’ç»™ QEMU ä»¥å¯ç”¨åŠä¸»æœºæ”¯æŒï¼›è¿™äº›æ ‡å¿—å·²ç»åŒ…å«åœ¨<code>.cargo/config.toml</code>æ¨¡æ¿æ–‡ä»¶ä¸­ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ # this program will block the terminal
$ cargo run
     Running `qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿˜æœ‰ä¸€ä¸ª<code>exit</code>åŠä¸»æœºæ“ä½œå¯ç”¨äºç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚é‡è¦æç¤ºï¼šåƒä¸‡<strong>ä¸èƒ½</strong>ä½¿ç”¨<code>debug::exit</code>ç¡¬ä»¶; æ­¤åŠŸèƒ½å¯èƒ½ä¼šæŸåæ‚¨çš„ OpenOCD ä¼šè¯ï¼Œå¹¶ä¸”åœ¨æ‚¨é‡æ–°å¯åŠ¨å®ƒä¹‹å‰æ‚¨å°†æ— æ³•è°ƒè¯•æ›´å¤šç¨‹åºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> roses <span class="token operator">==</span> <span class="token string">"red"</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€åä¸€ä¸ªæç¤ºï¼šæ‚¨å¯ä»¥å°†ææ…Œè¡Œä¸ºè®¾ç½®ä¸º<code>exit(EXIT_FAILURE)</code>. è¿™å°†è®©æ‚¨ç¼–å†™<code>no_std</code>å¯ä»¥åœ¨ QEMU ä¸Šè¿è¡Œçš„è¿è¡Œé€šè¿‡æµ‹è¯•ã€‚</p>
<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œ<code>panic-semihosting</code>æ¿æ¡ç®±å…·æœ‰â€œé€€å‡ºâ€åŠŸèƒ½ï¼Œå¯ç”¨<code>exit(EXIT_FAILURE)</code>åä¼šåœ¨å°†ç´§æ€¥æ¶ˆæ¯è®°å½•åˆ°ä¸»æœº stderr åè°ƒç”¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// features = ["exit"]</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>roses<span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
panicked at 'assertion failed<span class="token punctuation">:</span> `<span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span>`
  left<span class="token punctuation">:</span> `<span class="token string">"blue"</span>`<span class="token punctuation">,</span>
 right<span class="token punctuation">:</span> `<span class="token string">"red"</span>`'<span class="token punctuation">,</span> examples<span class="token operator">/</span>hello<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">5</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>æ³¨æ„</strong>ï¼šè¦åœ¨ ä¸Šå¯ç”¨æ­¤åŠŸèƒ½<code>panic-semihosting</code>ï¼Œè¯·ç¼–è¾‘æ‚¨çš„ <code>Cargo.toml</code>ä¾èµ–é¡¹éƒ¨åˆ†ï¼Œå…¶ä¸­<code>panic-semihosting</code>æŒ‡å®šä¸ºï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">panic-semihosting = { version = "VERSION", features = ["exit"] }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>VERSION</code>æƒ³è¦çš„ç‰ˆæœ¬åœ¨å“ªé‡Œã€‚æœ‰å…³ä¾èµ–é¡¹åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html" target="_blank" rel="noopener"><code>specifying dependencies</code></a>Cargo ä¹¦çš„éƒ¨åˆ†ã€‚</p>
<h2 id="Panickingï¼ˆææ…Œï¼‰"><a href="#Panickingï¼ˆææ…Œï¼‰" class="headerlink" title="Panickingï¼ˆææ…Œï¼‰"></a>Panickingï¼ˆææ…Œï¼‰</h2><p>ææ…Œæ˜¯ Rust è¯­è¨€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚ç´¢å¼•ç­‰å†…ç½®æ“ä½œä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥å†…å­˜å®‰å…¨ã€‚å½“å°è¯•è¶Šç•Œç´¢å¼•æ—¶ï¼Œè¿™ä¼šå¯¼è‡´ææ…Œã€‚</p>
<p>åœ¨æ ‡å‡†åº“ä¸­ï¼Œææ…Œæœ‰ä¸€ä¸ªå®šä¹‰çš„è¡Œä¸ºï¼šå®ƒå±•å¼€ææ…Œçº¿ç¨‹çš„å †æ ˆï¼Œé™¤éç”¨æˆ·é€‰æ‹©åœ¨ææ…Œæ—¶ä¸­æ­¢ç¨‹åºã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨æ²¡æœ‰æ ‡å‡†åº“çš„ç¨‹åºä¸­ï¼Œææ…Œè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯ä»¥é€šè¿‡å£°æ˜<code>#[panic_handler]</code>å‡½æ•°æ¥é€‰æ‹©è¡Œä¸ºã€‚è¯¥å‡½æ•°å¿…é¡»åœ¨ç¨‹åºçš„ä¾èµ–å›¾ä¸­åªå‡ºç°<em>ä¸€æ¬¡</em>ï¼Œå¹¶ä¸”å¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åï¼š<code>fn(&amp;PanicInfo) -&gt; !</code>ï¼Œå…¶ä¸­<a href="https://doc.rust-lang.org/core/panic/struct.PanicInfo.html" target="_blank" rel="noopener"><code>PanicInfo</code></a> æ˜¯ä¸€ä¸ªåŒ…å«æœ‰å…³ææ…Œä½ç½®ä¿¡æ¯çš„ç»“æ„ã€‚</p>
<p>é‰´äºåµŒå…¥å¼ç³»ç»Ÿçš„èŒƒå›´ä»é¢å‘ç”¨æˆ·åˆ°å®‰å…¨å…³é”®ï¼ˆä¸èƒ½å´©æºƒï¼‰ï¼Œæ²¡æœ‰ä¸€ç§é€‚åˆæ‰€æœ‰ææ…Œè¡Œä¸ºçš„å°ºå¯¸ï¼Œä½†æœ‰å¾ˆå¤šå¸¸ç”¨è¡Œä¸ºã€‚è¿™äº›å¸¸è§çš„è¡Œä¸ºå·²ç»è¢«æ‰“åŒ…åˆ°å®šä¹‰<code>#[panic_handler]</code>å‡½æ•°çš„crate ä¸­ã€‚ä¸€äº›ä¾‹å­åŒ…æ‹¬ï¼š</p>
<ul>
<li><a href="https://crates.io/crates/panic-abort" target="_blank" rel="noopener"><code>panic-abort</code></a>. ææ…Œå¯¼è‡´ä¸­æ­¢æŒ‡ä»¤è¢«æ‰§è¡Œã€‚</li>
<li><a href="https://crates.io/crates/panic-halt" target="_blank" rel="noopener"><code>panic-halt</code></a>. ææ…Œå¯¼è‡´ç¨‹åºæˆ–å½“å‰çº¿ç¨‹é€šè¿‡è¿›å…¥æ— é™å¾ªç¯è€Œåœæ­¢ã€‚</li>
<li><a href="https://crates.io/crates/panic-itm" target="_blank" rel="noopener"><code>panic-itm</code></a>. ä½¿ç”¨ ITMï¼ˆä¸€ç§ ARM Cortex-M ç‰¹å®šå¤–è®¾ï¼‰è®°å½•ç´§æ€¥æ¶ˆæ¯ã€‚</li>
<li><a href="https://crates.io/crates/panic-semihosting" target="_blank" rel="noopener"><code>panic-semihosting</code></a>. ä½¿ç”¨åŠä¸»æœºæŠ€æœ¯å°†ææ…Œæ¶ˆæ¯è®°å½•åˆ°ä¸»æœºã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥<a href="https://crates.io/keywords/panic-handler" target="_blank" rel="noopener"><code>panic-handler</code></a> åœ¨ crates.io ä¸Šæ‰¾åˆ°æ›´å¤šæœç´¢å…³é”®å­—çš„ crateã€‚</p>
<p>ç¨‹åºå¯ä»¥é€šè¿‡é“¾æ¥åˆ°ç›¸åº”çš„ crate æ¥é€‰æ‹©è¿™äº›è¡Œä¸ºä¹‹ä¸€ã€‚åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­å°†ææ…Œè¡Œä¸ºè¡¨ç¤ºä¸ºä¸€è¡Œä»£ç è¿™ä¸€äº‹å®ä¸ä»…å¯ç”¨ä½œæ–‡æ¡£ï¼Œè€Œä¸”è¿˜å¯ç”¨äºæ ¹æ®ç¼–è¯‘é…ç½®æ–‡ä»¶æ›´æ”¹ææ…Œè¡Œä¸ºã€‚ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// dev profile: easier to debug panics; can put a breakpoint on `rust_begin_unwind`</span>
<span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// release profile: minimize the binary size of the application</span>
<span class="token attribute attr-name">#[cfg(not(debug_assertions))]</span>
<span class="token keyword">use</span> panic_abort <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>panic-halt</code>ä½¿ç”¨ dev é…ç½®æ–‡ä»¶ ( <code>cargo build</code>)æ„å»ºæ—¶crate é“¾æ¥åˆ°crate ï¼Œä½†<code>panic-abort</code>ä½¿ç”¨ release é…ç½®æ–‡ä»¶ ( <code>cargo build --release</code>)æ„å»ºæ—¶é“¾æ¥åˆ°crate ã€‚</p>
<blockquote>
<p>è¯­å¥çš„<code>use panic_abort as _;</code>å½¢å¼<code>use</code>ç”¨äºç¡®ä¿<code>panic_abort</code>ææ…Œå¤„ç†ç¨‹åºåŒ…å«åœ¨æˆ‘ä»¬çš„æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒåŒæ—¶å‘ç¼–è¯‘å™¨æ˜ç¡®æˆ‘ä»¬ä¸ä¼šæ˜¾å¼ä½¿ç”¨ crate ä¸­çš„ä»»ä½•å†…å®¹ã€‚å¦‚æœæ²¡æœ‰<code>as _</code>é‡å‘½åï¼Œç¼–è¯‘å™¨ä¼šè­¦å‘Šæˆ‘ä»¬æœ‰ä¸€ä¸ªæœªä½¿ç”¨çš„å¯¼å…¥ã€‚æœ‰æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°<code>extern crate panic_abort</code>ï¼Œè€Œä¸æ˜¯ï¼Œè¿™æ˜¯2018å¹´ç‰ˆçš„é”ˆä¹‹å‰ä½¿ç”¨çš„æ—§é£æ ¼ï¼Œç°åœ¨åº”è¯¥ä»…ç”¨äºâ€œSYSROOTâ€ç®±å­ï¼ˆé‚£äº›æ•£å‘ç€é“é”ˆæœ¬èº«ï¼‰ï¼Œä¾‹å¦‚<code>proc_macro</code>ï¼Œ<code>alloc</code>ï¼Œ<code>std</code>ï¼Œå’Œ<code>test</code>ã€‚</p>
</blockquote>
<h3 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h3><p>è¿™æ˜¯ä¸€ä¸ªå°è¯•å¯¹è¶…å‡ºå…¶é•¿åº¦çš„æ•°ç»„è¿›è¡Œç´¢å¼•çš„ç¤ºä¾‹ã€‚æ“ä½œå¯¼è‡´ææ…Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> xs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// out of bounds access</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤ç¤ºä¾‹é€‰æ‹©äº†<code>panic-semihosting</code>ä½¿ç”¨åŠä¸»æœºå°†ç´§æ€¥æ¶ˆæ¯æ‰“å°åˆ°ä¸»æœºæ§åˆ¶å°çš„è¡Œä¸ºã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo run
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb (..)
panicked at 'index out of bounds: the len is 3 but the index is 4', src/main.rs:12:13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥å°è¯•å°†è¡Œä¸ºæ›´æ”¹ä¸º<code>panic-halt</code>å¹¶ç¡®è®¤åœ¨è¿™ç§æƒ…å†µä¸‹ä¸ä¼šæ‰“å°ä»»ä½•æ¶ˆæ¯ã€‚</p>
<h2 id="Exceptionsï¼ˆå¼‚å¸¸ï¼‰"><a href="#Exceptionsï¼ˆå¼‚å¸¸ï¼‰" class="headerlink" title="Exceptionsï¼ˆå¼‚å¸¸ï¼‰"></a>Exceptionsï¼ˆå¼‚å¸¸ï¼‰</h2><p>å¼‚å¸¸å’Œä¸­æ–­æ˜¯å¤„ç†å™¨å¤„ç†å¼‚æ­¥äº‹ä»¶å’Œè‡´å‘½é”™è¯¯ï¼ˆä¾‹å¦‚æ‰§è¡Œæ— æ•ˆæŒ‡ä»¤ï¼‰çš„ç¡¬ä»¶æœºåˆ¶ã€‚å¼‚å¸¸æ„å‘³ç€æŠ¢å å¹¶æ¶‰åŠå¼‚å¸¸å¤„ç†ç¨‹åºã€å“åº”è§¦å‘äº‹ä»¶çš„ä¿¡å·è€Œæ‰§è¡Œçš„å­ç¨‹åºã€‚</p>
<p>è¯¥<code>cortex-m-rt</code>ç®±æä¾›äº†ä¸€ä¸ª<a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.exception.html" target="_blank" rel="noopener"><code>exception</code></a>å£°æ˜å¼‚å¸¸å¤„ç†ç¨‹åºå±æ€§ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Exception handler for the SysTick (System Timer) exception</span>
<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™¤äº†<code>exception</code>å±æ€§å¼‚å¸¸å¤„ç†ç¨‹åºçœ‹èµ·æ¥åƒæ™®é€šå‡½æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ï¼š<code>exception</code>å¤„ç†ç¨‹åº<em>ä¸èƒ½</em>è¢«è½¯ä»¶è°ƒç”¨ã€‚æŒ‰ç…§å‰é¢çš„ç¤ºä¾‹ï¼Œè¯¥è¯­å¥<code>SysTick();</code> å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>è¿™ç§è¡Œä¸ºå‡ ä¹æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œå®ƒéœ€è¦æä¾›ä¸€ä¸ªç‰¹æ€§ï¼š <em>åœ¨</em>å¤„ç†ç¨‹åºä¸­<code>static mut</code>å£°æ˜çš„å˜é‡å¯ä»¥<em>å®‰å…¨</em>ä½¿ç”¨ã€‚ <code>exception</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has transformed to type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯èƒ½çŸ¥é“ï¼Œ<code>static mut</code>åœ¨å‡½æ•°ä¸­ä½¿ç”¨å˜é‡ä¼šä½¿å…¶ <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)" target="_blank" rel="noopener"><em>ä¸å¯é‡å…¥</em></a>ã€‚ä»å¤šä¸ªå¼‚å¸¸/ä¸­æ–­å¤„ç†ç¨‹åºæˆ–ä»<code>main</code>ä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸/ä¸­æ–­å¤„ç†ç¨‹åºç›´æ¥æˆ–é—´æ¥è°ƒç”¨ä¸å¯é‡å…¥å‡½æ•°æ˜¯æœªå®šä¹‰çš„è¡Œä¸º ã€‚</p>
<p>å®‰å…¨ Rust ç»ä¸èƒ½å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› æ­¤ä¸å¯é‡å…¥å‡½æ•°å¿…é¡»æ ‡è®°ä¸º<code>unsafe</code>. ç„¶è€Œæˆ‘åªæ˜¯å‘Šè¯‰<code>exception</code>å¤„ç†ç¨‹åºå¯ä»¥å®‰å…¨åœ°ä½¿ç”¨<code>static mut</code>å˜é‡ã€‚è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿè¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º <code>exception</code>å¤„ç†ç¨‹åº<em>ä¸èƒ½</em>è¢«è½¯ä»¶è°ƒç”¨ï¼Œå› æ­¤é‡å…¥æ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œè¯¥<code>exception</code>å±æ€§é€šè¿‡å°†é™æ€å˜é‡åŒ…è£…åˆ°<code>unsafe</code>å—ä¸­å¹¶ä¸ºæˆ‘ä»¬æä¾›æ–°çš„é€‚å½“ç±»å‹<code>&amp;mut</code>çš„åŒåå˜é‡æ¥è½¬æ¢å‡½æ•°å†…é™æ€å˜é‡çš„å®šä¹‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>*</code>è®¿é—®å˜é‡çš„å€¼æ¥å–æ¶ˆå¼•ç”¨å¼•ç”¨ï¼Œè€Œæ— éœ€å°†å®ƒä»¬åŒ…è£…åœ¨ä¸€ä¸ª<code>unsafe</code>å—ä¸­ã€‚</p>
</blockquote>
<h3 id="ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­"><a href="#ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­"></a>ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­</h3><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ç³»ç»Ÿè®¡æ—¶å™¨<code>SysTick</code>å¤§çº¦æ¯ç§’å¼•å‘ä¸€æ¬¡å¼‚å¸¸çš„ç¤ºä¾‹ã€‚åœ¨<code>SysTick</code>å¼‚å¸¸å¤„ç†ç¨‹åºè·Ÿè¸ªå®ƒå·²ç»å¤šå°‘æ¬¡è¢«ç§°ä¸ºåœ¨<code>COUNT</code>å˜é‡ï¼Œç„¶åæ‰“å°å‡ºçš„å€¼ <code>COUNT</code>ä½¿ç”¨åŠä¸»æœºä¸»æœºæ§åˆ¶å°ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šæ‚¨å¯ä»¥åœ¨ä»»ä½• Cortex-M è®¾å¤‡ä¸Šè¿è¡Œæ­¤ç¤ºä¾‹ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ QEMU ä¸Šè¿è¡Œå®ƒ</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    debug<span class="token punctuation">,</span>
    hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> HStdout<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> syst <span class="token operator">=</span> p<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configures the system timer to trigger a SysTick exception every second</span>
    syst<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// this is configured for the LM3S6965 which has a default CPU clock of 12 MHz</span>
    syst<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">12_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> STDOUT<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>HStdout<span class="token operator">></span> <span class="token operator">=</span> None<span class="token punctuation">;</span>

    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Lazy initialization</span>
    <span class="token keyword">if</span> STDOUT<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>STDOUT <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> STDOUT<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// IMPORTANT omit this `if` block if running on real hardware or your</span>
    <span class="token comment" spellcheck="true">// debugger will end in an inconsistent state</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>COUNT <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This will terminate the QEMU process</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
tail <span class="token operator">-</span>n5 Cargo<span class="token punctuation">.</span>toml
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
cortex<span class="token operator">-</span>m <span class="token operator">=</span> <span class="token string">"0.5.7"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">"0.6.3"</span>
panic<span class="token operator">-</span>halt <span class="token operator">=</span> <span class="token string">"0.2.0"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>semihosting <span class="token operator">=</span> <span class="token string">"0.3.1"</span>
$ cargo run <span class="token operator">-</span><span class="token operator">-</span>release
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span>arm <span class="token operator">-</span>cpu cortex<span class="token operator">-</span>m3 <span class="token operator">-</span>machine <span class="token function">lm3s6965evb</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
<span class="token number">123456789</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ‚¨åœ¨ Discovery æ¿ä¸Šè¿è¡Œå®ƒï¼Œæ‚¨å°†åœ¨ OpenOCD æ§åˆ¶å°ä¸Šçœ‹åˆ°è¾“å‡ºã€‚æ­¤å¤–ï¼Œå½“è®¡æ•°è¾¾åˆ° 9 æ—¶ï¼Œç¨‹åº<em>ä¸ä¼š</em>åœæ­¢ã€‚</p>
<h3 id="é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº"><a href="#é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº" class="headerlink" title="é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº"></a>é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº</h3><p>è¯¥<code>exception</code>å±æ€§çš„å®é™…ä½œç”¨æ˜¯<em>è¦†ç›–</em>ç‰¹å®šå¼‚å¸¸çš„é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åºã€‚å¦‚æœæ‚¨ä¸è¦†ç›–ç‰¹å®šå¼‚å¸¸çš„å¤„ç†ç¨‹åºï¼Œå®ƒå°†ç”±<code>DefaultHandler</code>å‡½æ•°å¤„ç†ï¼Œè¯¥å‡½æ•°é»˜è®¤ä¸ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å‡½æ•°ç”±<code>cortex-m-rt</code>crateæä¾›å¹¶æ ‡è®°ä¸ºï¼Œ <code>#[no_mangle]</code>ä»¥ä¾¿æ‚¨å¯ä»¥åœ¨â€œDefaultHandlerâ€ä¸Šæ”¾ç½®æ–­ç‚¹å¹¶æ•è· <em>æœªå¤„ç†çš„</em>å¼‚å¸¸ã€‚</p>
<p>å¯ä»¥<code>DefaultHandler</code>ä½¿ç”¨<code>exception</code>å±æ€§è¦†ç›–å®ƒï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span>irqn<span class="token punctuation">:</span> i16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// custom default handler</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>irqn</code>å‚æ•°æŒ‡ç¤ºæ­£åœ¨å¤„ç†å“ªä¸ªå¼‚å¸¸ã€‚è´Ÿå€¼è¡¨ç¤ºæ­£åœ¨å¤„ç† Cortex-M å¼‚å¸¸ï¼›é›¶æˆ–æ­£å€¼è¡¨ç¤ºæ­£åœ¨å¤„ç†è®¾å¤‡ç‰¹å®šå¼‚å¸¸ï¼ˆAKA ä¸­æ–­ï¼‰ã€‚</p>
<h3 id="ç¡¬æ•…éšœå¤„ç†ç¨‹åº"><a href="#ç¡¬æ•…éšœå¤„ç†ç¨‹åº" class="headerlink" title="ç¡¬æ•…éšœå¤„ç†ç¨‹åº"></a>ç¡¬æ•…éšœå¤„ç†ç¨‹åº</h3><p>åœ¨<code>HardFault</code>ä¾‹å¤–çš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šã€‚å½“ç¨‹åºè¿›å…¥æ— æ•ˆçŠ¶æ€æ—¶ä¼šè§¦å‘æ­¤å¼‚å¸¸ï¼Œå› æ­¤å…¶å¤„ç†ç¨‹åº<em>æ— æ³•</em>è¿”å›ï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚æ­¤å¤–ï¼Œè¿è¡Œæ—¶ crate åœ¨<code>HardFault</code>è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å¤„ç†ç¨‹åºä¹‹å‰ä¼šåšä¸€äº›å·¥ä½œï¼Œä»¥æé«˜å¯è°ƒè¯•æ€§ã€‚</p>
<p>ç»“æœæ˜¯<code>HardFault</code>å¤„ç†ç¨‹åºå¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åï¼š <code>fn(&amp;ExceptionFrame) -&gt; !</code>. å¤„ç†ç¨‹åºçš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘ç”±å¼‚å¸¸å‹å…¥å †æ ˆçš„å¯„å­˜å™¨çš„æŒ‡é’ˆã€‚è¿™äº›å¯„å­˜å™¨æ˜¯è§¦å‘å¼‚å¸¸æ—¶å¤„ç†å™¨çŠ¶æ€çš„å¿«ç…§ï¼Œå¯ç”¨äºè¯Šæ–­ç¡¬æ•…éšœã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªæ‰§è¡Œéæ³•æ“ä½œçš„ç¤ºä¾‹ï¼šè¯»å–ä¸å­˜åœ¨çš„å†…å­˜ä½ç½®ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šè¿™ä¸ªç¨‹åºåœ¨ QEMU<code>qemu-system-arm -machine lm3s6965evb</code>ä¸Šæ— æ³•è¿è¡Œï¼Œå³å®ƒä¸ä¼šå´©æºƒï¼Œå› ä¸º å®ƒä¸æ£€æŸ¥å†…å­˜è´Ÿè½½ï¼Œå¹¶ä¸”ä¼šå¾ˆé«˜å…´åœ°<code>0</code>åœ¨è¯»å–æ— æ•ˆå†…å­˜æ—¶è¿”å›ã€‚</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> ExceptionFrame<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hio<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// read a nonexistent memory location</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x3FFF_FFFE</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>ef<span class="token punctuation">:</span> <span class="token operator">&amp;</span>ExceptionFrame<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">mut</span> hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#?}"</span><span class="token punctuation">,</span> ef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>HardFault</code>å¤„ç†å™¨æ‰“å°<code>ExceptionFrame</code>å€¼ã€‚å¦‚æœæ‚¨è¿è¡Œå®ƒï¼Œæ‚¨å°†åœ¨ OpenOCD æ§åˆ¶å°ä¸Šçœ‹åˆ°ç±»ä¼¼çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
ExceptionFrame {
    r0: 0x3ffffffe,
    r1: 0x00f00000,
    r2: 0x20000000,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x080008f7,
    pc: 0x0800094a,
    xpsr: 0x61000000
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>pc</code>å€¼æ˜¯å¼‚å¸¸å‘ç”Ÿæ—¶ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œå®ƒæŒ‡å‘è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤ã€‚</p>
<p>å¦‚æœä½ çœ‹ä¸€ä¸‹ç¨‹åºçš„åæ±‡ç¼–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
(..)
ResetTrampoline:
 8000942:       movw    r0, #0xfffe
 8000946:       movt    r0, #0x3fff
 800094a:       ldr     r0, [r0]
 800094c:       b       #-0x4 <ResetTrampoline+0xa><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥åœ¨å<code>0x0800094a</code>æ±‡ç¼–ä¸­æŸ¥æ‰¾ç¨‹åºè®¡æ•°å™¨çš„å€¼ã€‚æ‚¨å°†çœ‹åˆ°åŠ è½½æ“ä½œ ( <code>ldr r0, [r0]</code>) å¯¼è‡´äº†å¼‚å¸¸ã€‚æœ¬<code>r0</code>åœº<code>ExceptionFrame</code>ä¼šå‘Šè¯‰ä½ å¯„å­˜å™¨çš„å€¼<code>r0</code> æ˜¯<code>0x3fff_fffe</code>åœ¨é‚£ä¸ªæ—¶å€™ã€‚</p>
<h2 id="Interruptsï¼ˆä¸­æ–­ï¼‰"><a href="#Interruptsï¼ˆä¸­æ–­ï¼‰" class="headerlink" title="Interruptsï¼ˆä¸­æ–­ï¼‰"></a>Interruptsï¼ˆä¸­æ–­ï¼‰</h2><p>ä¸­æ–­åœ¨å¾ˆå¤šæ–¹é¢ä¸å¼‚å¸¸ä¸åŒï¼Œä½†å®ƒä»¬çš„æ“ä½œå’Œä½¿ç”¨å¤§ä½“ç›¸ä¼¼ï¼Œå¹¶ä¸”å®ƒä»¬ä¹Ÿç”±ç›¸åŒçš„ä¸­æ–­æ§åˆ¶å™¨å¤„ç†ã€‚å°½ç®¡å¼‚å¸¸ç”± Cortex-M æ¶æ„å®šä¹‰ï¼Œä½†ä¸­æ–­å§‹ç»ˆæ˜¯ä¾›åº”å•†ï¼ˆé€šå¸¸ç”šè‡³æ˜¯èŠ¯ç‰‡ï¼‰åœ¨å‘½åå’ŒåŠŸèƒ½æ–¹é¢çš„ç‰¹å®šå®ç°ã€‚</p>
<p>ä¸­æ–­ç¡®å®æä¾›äº†å¾ˆå¤§çš„çµæ´»æ€§ï¼Œåœ¨å°è¯•ä»¥é«˜çº§æ–¹å¼ä½¿ç”¨å®ƒä»¬æ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬ä¸ä¼šåœ¨æœ¬ä¹¦ä¸­ä»‹ç»è¿™äº›ç”¨é€”ï¼Œä½†è®°ä½ä»¥ä¸‹å‡ ç‚¹æ˜¯ä¸ªå¥½ä¸»æ„ï¼š</p>
<ul>
<li>ä¸­æ–­å…·æœ‰å¯ç¼–ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¿™äº›ä¼˜å…ˆçº§å†³å®šäº†å®ƒä»¬çš„å¤„ç†ç¨‹åºçš„æ‰§è¡Œé¡ºåº</li>
<li>ä¸­æ–­å¯ä»¥åµŒå¥—å’ŒæŠ¢å ï¼Œå³ä¸­æ–­å¤„ç†ç¨‹åºçš„æ‰§è¡Œå¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­ä¸­æ–­</li>
<li>ä¸€èˆ¬éœ€è¦æ¸…é™¤å¯¼è‡´ä¸­æ–­è§¦å‘çš„åŸå› ï¼Œé˜²æ­¢æ— ä¼‘æ­¢åœ°é‡æ–°è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åº</li>
</ul>
<p>è¿è¡Œæ—¶çš„ä¸€èˆ¬åˆå§‹åŒ–æ­¥éª¤å§‹ç»ˆç›¸åŒï¼š</p>
<ul>
<li>è®¾ç½®å¤–è®¾ä»¥åœ¨æ‰€éœ€åœºåˆç”Ÿæˆä¸­æ–­è¯·æ±‚</li>
<li>åœ¨ä¸­æ–­æ§åˆ¶å™¨ä¸­è®¾ç½®ä¸­æ–­å¤„ç†ç¨‹åºæ‰€éœ€çš„ä¼˜å…ˆçº§</li>
<li>åœ¨ä¸­æ–­æ§åˆ¶å™¨ä¸­å¯ç”¨ä¸­æ–­å¤„ç†ç¨‹åº</li>
</ul>
<p>ä¸å¼‚å¸¸ç±»ä¼¼ï¼Œ<code>cortex-m-rt</code>crate æä¾›äº†ä¸€ä¸ª<a href="https://docs.rs/cortex-m-rt-macros/0.1.5/cortex_m_rt_macros/attr.interrupt.html" target="_blank" rel="noopener"><code>interrupt</code></a> å±æ€§æ¥å£°æ˜ä¸­æ–­å¤„ç†ç¨‹åºã€‚å¯ç”¨çš„ä¸­æ–­ï¼ˆä»¥åŠå®ƒä»¬åœ¨ä¸­æ–­å¤„ç†ç¨‹åºè¡¨ä¸­çš„ä½ç½®ï¼‰é€šå¸¸æ˜¯é€šè¿‡<code>svd2rust</code>SVD æè¿°è‡ªåŠ¨ç”Ÿæˆçš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Interrupt handler for the Timer2 interrupt</span>
<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
    <span class="token comment" spellcheck="true">// Clear reason for the generated interrupt request</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸­æ–­å¤„ç†ç¨‹åºçœ‹èµ·æ¥åƒæ™®é€šå‡½æ•°ï¼ˆé™¤äº†ç¼ºå°‘å‚æ•°ï¼‰ç±»ä¼¼äºå¼‚å¸¸å¤„ç†ç¨‹åºã€‚ç„¶è€Œï¼Œç”±äºç‰¹æ®Šçš„è°ƒç”¨çº¦å®šï¼Œå®ƒä»¬ä¸èƒ½è¢«å›ºä»¶çš„å…¶ä»–éƒ¨åˆ†ç›´æ¥è°ƒç”¨ã€‚ç„¶è€Œï¼Œå¯ä»¥åœ¨è½¯ä»¶ä¸­ç”Ÿæˆä¸­æ–­è¯·æ±‚ä»¥è§¦å‘å¯¹ä¸­æ–­å¤„ç†ç¨‹åºçš„è½¬ç§»ã€‚</p>
<p>ä¸å¼‚å¸¸å¤„ç†ç¨‹åºç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥<code>static mut</code> åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­å£°æ˜å˜é‡ä»¥ä¿æŒ<em>å®‰å…¨</em>çŠ¶æ€ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p><strong>TODO</strong> Cover memory mapped I/O using registers.</p>
<h1 id="Peripheralsï¼ˆå¤–è®¾ï¼‰"><a href="#Peripheralsï¼ˆå¤–è®¾ï¼‰" class="headerlink" title="Peripheralsï¼ˆå¤–è®¾ï¼‰"></a>Peripheralsï¼ˆå¤–è®¾ï¼‰</h1><h3 id="ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ</h3><p>å¤§å¤šæ•°å¾®æ§åˆ¶å™¨ä¸ä»…ä»…æ˜¯ä¸€ä¸ª CPUã€RAM æˆ–é—ªå­˜â€”â€”å®ƒä»¬åŒ…å«ç¡…ç‰‡éƒ¨åˆ†ï¼Œç”¨äºä¸å¾®æ§åˆ¶å™¨ä¹‹å¤–çš„ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œä»¥åŠé€šè¿‡ä¼ æ„Ÿå™¨ã€ç”µæœºæ§åˆ¶å™¨ç›´æ¥æˆ–é—´æ¥åœ°ä¸å‘¨å›´ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œæˆ–äººæœºç•Œé¢ï¼Œå¦‚æ˜¾ç¤ºå™¨æˆ–é”®ç›˜ã€‚è¿™äº›ç»„ä»¶ç»Ÿç§°ä¸ºå¤–å›´è®¾å¤‡ã€‚</p>
<p>è¿™äº›å¤–è®¾å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å…è®¸å¼€å‘äººå‘˜å°†å¤„ç†å·¥ä½œå¸è½½ç»™å®ƒä»¬ï¼Œä»è€Œé¿å…å¿…é¡»åœ¨è½¯ä»¶ä¸­å¤„ç†æ‰€æœ‰äº‹æƒ…ã€‚ç±»ä¼¼äºæ¡Œé¢å¼€å‘äººå‘˜å°†å›¾å½¢å¤„ç†å¸è½½åˆ°è§†é¢‘å¡çš„æ–¹å¼ï¼ŒåµŒå…¥å¼å¼€å‘äººå‘˜å¯ä»¥å°†ä¸€äº›ä»»åŠ¡å¸è½½åˆ°å¤–å›´è®¾å¤‡ï¼Œä»è€Œè®© CPU å°†æ—¶é—´èŠ±åœ¨åšå…¶ä»–é‡è¦çš„äº‹æƒ…ä¸Šï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšä»¥èŠ‚çœç”µé‡ã€‚</p>
<p>å¦‚æœæ‚¨æŸ¥çœ‹ 1970 å¹´ä»£æˆ– 1980 å¹´ä»£çš„è€å¼å®¶ç”¨è®¡ç®—æœºçš„ä¸»ç”µè·¯æ¿ï¼ˆå®é™…ä¸Šï¼Œæ˜¨å¤©çš„å°å¼ PC ä¸ä»Šå¤©çš„åµŒå…¥å¼ç³»ç»Ÿç›¸è·ç”šè¿œï¼‰ï¼Œæ‚¨ä¼šæœŸæœ›çœ‹åˆ°ï¼š</p>
<ul>
<li>å¤„ç†å™¨</li>
<li>ä¸€ä¸ªå†…å­˜èŠ¯ç‰‡</li>
<li>ä¸€ä¸ªROMèŠ¯ç‰‡</li>
<li>ä¸€ä¸ª I/O æ§åˆ¶å™¨</li>
</ul>
<p>RAM èŠ¯ç‰‡ã€ROM èŠ¯ç‰‡å’Œ I/O æ§åˆ¶å™¨ï¼ˆè¯¥ç³»ç»Ÿä¸­çš„å¤–å›´è®¾å¤‡ï¼‰å°†é€šè¿‡ä¸€ç³»åˆ—ç§°ä¸ºâ€œæ€»çº¿â€çš„å¹¶è¡Œè¿¹çº¿è¿æ¥åˆ°å¤„ç†å™¨ã€‚è¯¥æ€»çº¿æ‰¿è½½åœ°å€ä¿¡æ¯ï¼Œå®ƒé€‰æ‹©å¤„ç†å™¨å¸Œæœ›ä¸æ€»çº¿ä¸Šçš„å“ªä¸ªè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œä»¥åŠæ‰¿è½½å®é™…æ•°æ®çš„æ•°æ®æ€»çº¿ã€‚åœ¨æˆ‘ä»¬çš„åµŒå…¥å¼å¾®æ§åˆ¶å™¨ä¸­ï¼ŒåŒæ ·çš„åŸåˆ™é€‚ç”¨ - åªæ˜¯æ‰€æœ‰ä¸œè¥¿éƒ½å°è£…åœ¨ä¸€å—ç¡…ä¸Šã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸é€šå¸¸å…·æœ‰ Vulkanã€Metal æˆ– OpenGL ç­‰è½¯ä»¶ API çš„å›¾å½¢å¡ä¸åŒï¼Œå¤–å›´è®¾å¤‡é€šè¿‡ç¡¬ä»¶æ¥å£æš´éœ²ç»™æˆ‘ä»¬çš„å¾®æ§åˆ¶å™¨ï¼Œè¯¥æ¥å£æ˜ å°„åˆ°ä¸€å—å†…å­˜ã€‚</p>
<h3 id="çº¿æ€§å’Œå®å†…å­˜ç©ºé—´"><a href="#çº¿æ€§å’Œå®å†…å­˜ç©ºé—´" class="headerlink" title="çº¿æ€§å’Œå®å†…å­˜ç©ºé—´"></a>çº¿æ€§å’Œå®å†…å­˜ç©ºé—´</h3><p>åœ¨å¾®æ§åˆ¶å™¨ä¸Šï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥å…¶ä»–ä»»æ„åœ°å€ï¼ˆä¾‹å¦‚<code>0x4000_0000</code>æˆ–<code>0x0000_0000</code>ï¼‰ä¹Ÿå¯èƒ½æ˜¯å®Œå…¨æœ‰æ•ˆçš„æ“ä½œã€‚</p>
<p>åœ¨æ¡Œé¢ç³»ç»Ÿä¸Šï¼Œå¯¹å†…å­˜çš„è®¿é—®ç”± MMU æˆ–å†…å­˜ç®¡ç†å•å…ƒä¸¥æ ¼æ§åˆ¶ã€‚è¯¥ç»„ä»¶æœ‰ä¸¤ä¸ªä¸»è¦èŒè´£ï¼šå¼ºåˆ¶æ‰§è¡Œå¯¹å†…å­˜éƒ¨åˆ†çš„è®¿é—®æƒé™ï¼ˆé˜²æ­¢ä¸€ä¸ªè¿›ç¨‹è¯»å–æˆ–ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼‰ï¼›å¹¶å°†ç‰©ç†å†…å­˜çš„æ®µé‡æ–°æ˜ å°„åˆ°è½¯ä»¶ä¸­ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜èŒƒå›´ã€‚å¾®æ§åˆ¶å™¨é€šå¸¸æ²¡æœ‰ MMUï¼Œè€Œæ˜¯ä»…åœ¨è½¯ä»¶ä¸­ä½¿ç”¨çœŸå®çš„ç‰©ç†åœ°å€ã€‚</p>
<p>å°½ç®¡ 32 ä½å¾®æ§åˆ¶å™¨å…·æœ‰æ¥è‡ª<code>0x0000_0000</code>, å’Œçš„çœŸå®çº¿æ€§åœ°å€ç©ºé—´<code>0xFFFF_FFFF</code>ï¼Œä½†å®ƒä»¬é€šå¸¸åªä½¿ç”¨è¯¥èŒƒå›´çš„å‡ ç™¾ KB ç”¨äºå®é™…å†…å­˜ã€‚è¿™ç•™ä¸‹äº†å¤§é‡çš„åœ°å€ç©ºé—´ã€‚åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº† RAM ä½äº address <code>0x2000_0000</code>ã€‚å¦‚æœæˆ‘ä»¬çš„RAMä¸º64æ˜†æ˜æ¤ç‰©ç ”ç©¶æ‰€é•¿ï¼ˆå³0xFFFFçš„æœ€å¤§åœ°å€ï¼‰ï¼Œç„¶ååœ°å€<code>0x2000_0000</code>ï¼Œä»¥<code>0x2000_FFFF</code>å°†å¯¹åº”äºæˆ‘ä»¬çš„RAMã€‚å½“æˆ‘ä»¬å†™å…¥ä¸€ä¸ªä½äº address çš„å˜é‡<code>0x2000_1234</code>æ—¶ï¼Œå†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…æ˜¯ä¸€äº›é€»è¾‘æ£€æµ‹åœ°å€çš„é«˜ä½éƒ¨åˆ†ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º 0x2000ï¼‰ï¼Œç„¶åæ¿€æ´» RAM ä»¥ä¾¿å®ƒå¯ä»¥å¯¹åœ°å€çš„ä½ä½éƒ¨åˆ†ï¼ˆ0x1234åœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰ã€‚åœ¨ Cortex-M ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå°†é—ªå­˜ ROM æ˜ å°„åˆ°åœ°å€<code>0x0000_0000</code>ç›´åˆ°åœ°å€<code>0x0007_FFFF</code>ï¼ˆå¦‚æœæˆ‘ä»¬æœ‰ 512 KiB é—ªå­˜ ROMï¼‰ã€‚å¾®æ§åˆ¶å™¨è®¾è®¡è€…å¹¶æ²¡æœ‰å¿½ç•¥è¿™ä¸¤ä¸ªåŒºåŸŸä¹‹é—´çš„æ‰€æœ‰å‰©ä½™ç©ºé—´ï¼Œè€Œæ˜¯å°†å¤–å›´è®¾å¤‡çš„æ¥å£æ˜ å°„åˆ°æŸäº›å­˜å‚¨å™¨ä½ç½®ã€‚è¿™æœ€ç»ˆçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-memory-map.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 æ•°æ®è¡¨ (pdf)</a></p>
<h3 id="å†…å­˜æ˜ å°„å¤–è®¾"><a href="#å†…å­˜æ˜ å°„å¤–è®¾" class="headerlink" title="å†…å­˜æ˜ å°„å¤–è®¾"></a>å†…å­˜æ˜ å°„å¤–è®¾</h3><p>ä¹ä¸€çœ‹ï¼Œä¸è¿™äº›å¤–è®¾çš„äº¤äº’å¾ˆç®€å•â€”â€”å°†æ­£ç¡®çš„æ•°æ®å†™å…¥æ­£ç¡®çš„åœ°å€ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä¸²è¡Œç«¯å£å‘é€ 32 ä½å­—å¯èƒ½ä¸å°†è¯¥ 32 ä½å­—å†™å…¥æŸä¸ªå†…å­˜åœ°å€ä¸€æ ·ç›´æ¥ã€‚ç„¶åä¸²è¡Œç«¯å£å¤–å›´è®¾å¤‡å°†æ¥ç®¡å¹¶è‡ªåŠ¨å‘é€æ•°æ®ã€‚</p>
<p>è¿™äº›å¤–è®¾çš„é…ç½®å·¥ä½œç±»ä¼¼ã€‚ä¸æ˜¯è°ƒç”¨å‡½æ•°æ¥é…ç½®å¤–è®¾ï¼Œè€Œæ˜¯å…¬å¼€äº†ä¸€å—å†…å­˜ï¼Œç”¨ä½œç¡¬ä»¶ APIã€‚å†™å…¥<code>0x8000_0000</code>SPI é¢‘ç‡é…ç½®å¯„å­˜å™¨ï¼ŒSPI ç«¯å£å°†ä»¥æ¯ç§’ 8 å…†ä½çš„é€Ÿåº¦å‘é€æ•°æ®ã€‚å†™å…¥<code>0x0200_0000</code>ç›¸åŒçš„åœ°å€ï¼ŒSPI ç«¯å£å°†ä»¥æ¯ç§’ 125 åƒä½çš„é€Ÿåº¦å‘é€æ•°æ®ã€‚è¿™äº›é…ç½®å¯„å­˜å™¨çœ‹èµ·æ¥æœ‰ç‚¹åƒè¿™æ ·ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-spi-frequency-register.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 æ•°æ®è¡¨ (pdf)</a></p>
<p>æ— è®ºä½¿ç”¨ä½•ç§è¯­è¨€ï¼Œæ— è®ºè¯¥è¯­è¨€æ˜¯æ±‡ç¼–ã€C è¿˜æ˜¯ Rustï¼Œæ­¤æ¥å£éƒ½æ˜¯ä¸ç¡¬ä»¶è¿›è¡Œäº¤äº’çš„æ–¹å¼ã€‚</p>
<h2 id="A-First-Attempt"><a href="#A-First-Attempt" class="headerlink" title="A First Attempt"></a>A First Attempt</h2><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><p>è®©æˆ‘ä»¬çœ‹çœ‹â€œSysTickâ€å¤–è®¾ - æ¯ä¸ª Cortex-M å¤„ç†å™¨å†…æ ¸éƒ½é™„å¸¦ä¸€ä¸ªç®€å•çš„è®¡æ—¶å™¨ã€‚é€šå¸¸ï¼Œæ‚¨ä¼šåœ¨èŠ¯ç‰‡åˆ¶é€ å•†çš„æ•°æ®è¡¨æˆ–<em>æŠ€æœ¯å‚è€ƒæ‰‹å†Œä¸­</em>æŸ¥æ‰¾è¿™äº›å†…å®¹ï¼Œä½†æ­¤ç¤ºä¾‹é€‚ç”¨äºæ‰€æœ‰ ARM Cortex-M å†…æ ¸ï¼Œè®©æˆ‘ä»¬æŸ¥çœ‹<a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0553a/Babieigh.html" target="_blank" rel="noopener">ARM å‚è€ƒæ‰‹å†Œ</a>ã€‚æˆ‘ä»¬çœ‹åˆ°æœ‰å››ä¸ªå¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>æŠµæ¶ˆ</th>
<th>å§“å</th>
<th>æè¿°</th>
<th>å®½åº¦</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>SYST_CSR</td>
<td>æ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x04</td>
<td>SYST_RVR</td>
<td>é‡è½½å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x08</td>
<td>SYST_CVR</td>
<td>å½“å‰å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x0C</td>
<td>SYST_CALIB</td>
<td>æ ¡å‡†å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
</tbody></table>
<h3 id="C-æ–¹æ³•"><a href="#C-æ–¹æ³•" class="headerlink" title="C æ–¹æ³•"></a>C æ–¹æ³•</h3><p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸åœ¨ C ä¸­å®Œå…¨ç›¸åŒçš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ç»„å¯„å­˜å™¨ - ä½¿ç”¨<code>struct</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™å®šç¬¦<code>#[repr(C)]</code>å‘Šè¯‰ Rust ç¼–è¯‘å™¨åƒ C ç¼–è¯‘å™¨é‚£æ ·å¸ƒç½®è¿™ä¸ªç»“æ„ã€‚è¿™éå¸¸é‡è¦ï¼Œå› ä¸º Rust å…è®¸é‡æ–°æ’åºç»“æ„å­—æ®µï¼Œè€Œ C åˆ™ä¸å…è®¸ã€‚æ‚¨å¯ä»¥æƒ³è±¡å¦‚æœè¿™äº›å­—æ®µè¢«ç¼–è¯‘å™¨é»˜é»˜åœ°é‡æ–°æ’åˆ—ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸è¿›è¡Œè°ƒè¯•ï¼æœ‰äº†è¿™ä¸ªé™å®šç¬¦ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸ä¸Šè¡¨ç›¸å¯¹åº”çš„å››ä¸ª 32 ä½å­—æ®µã€‚ä½†æ˜¯å½“ç„¶ï¼Œè¿™<code>struct</code>æœ¬èº«æ˜¯æ²¡æœ‰ç”¨çš„â€”â€”æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token operator">*</span>systick<span class="token punctuation">)</span><span class="token punctuation">.</span>cvr <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Volatile-Accesses"><a href="#Volatile-Accesses" class="headerlink" title="Volatile Accesses"></a>Volatile Accesses</h3><p>ç°åœ¨ï¼Œä¸Šè¿°æ–¹æ³•å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚</p>
<ol>
<li>æ¯æ¬¡æˆ‘ä»¬æƒ³è®¿é—®æˆ‘ä»¬çš„å¤–è®¾æ—¶ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»ä½¿ç”¨ unsafeã€‚</li>
<li>æˆ‘ä»¬æ— æ³•æŒ‡å®šå“ªäº›å¯„å­˜å™¨æ˜¯åªè¯»çš„æˆ–è¯»å†™çš„ã€‚</li>
<li>ç¨‹åºä¸­ä»»ä½•ä½ç½®çš„ä»»ä½•ä»£ç éƒ½å¯ä»¥é€šè¿‡æ­¤ç»“æ„è®¿é—®ç¡¬ä»¶ã€‚</li>
<li>æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå®é™…ä¸Šä¸èµ·ä½œç”¨â€¦â€¦</li>
</ol>
<p>ç°åœ¨ï¼Œé—®é¢˜æ˜¯ç¼–è¯‘å™¨å¾ˆèªæ˜ã€‚å¦‚æœæ‚¨å¯¹åŒä¸€å— RAM è¿›è¡Œä¸¤æ¬¡å†™å…¥ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œç¼–è¯‘å™¨ä¼šæ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”å®Œå…¨è·³è¿‡ç¬¬ä¸€æ¬¡å†™å…¥ã€‚åœ¨ C ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å˜é‡æ ‡è®°ä¸º<code>volatile</code>ç¡®ä¿æ¯æ¬¡è¯»å–æˆ–å†™å…¥éƒ½æŒ‰é¢„æœŸè¿›è¡Œã€‚åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å°†<em>è®¿é—®</em>æ ‡è®°ä¸º volatileï¼Œè€Œä¸æ˜¯å˜é‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> systick<span class="token punctuation">.</span>cvr<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†å››ä¸ªé—®é¢˜ä¹‹ä¸€ï¼Œä½†ç°åœ¨æˆ‘ä»¬æœ‰æ›´å¤šçš„<code>unsafe</code>ä»£ç ï¼å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¿æ¡ç®±å¯ä»¥æä¾›å¸®åŠ© - <a href="https://crates.io/crates/volatile_register" target="_blank" rel="noopener"><code>volatile_register</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
    <span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œæ˜“å¤±æ€§è®¿é—®æ˜¯é€šè¿‡<code>read</code>å’Œ<code>write</code>æ–¹æ³•è‡ªåŠ¨æ‰§è¡Œçš„ã€‚å®ƒä»ç„¶<code>unsafe</code>æ˜¯æ‰§è¡Œå†™å…¥ï¼Œä½†å…¬å¹³åœ°è¯´ï¼Œç¡¬ä»¶æ˜¯ä¸€å †å¯å˜çŠ¶æ€ï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¿™äº›å†™å…¥æ˜¯å¦çœŸæ­£å®‰å…¨ï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤ä½ç½®ã€‚</p>
<h3 id="The-Rusty-Wrapper"><a href="#The-Rusty-Wrapper" class="headerlink" title="The Rusty Wrapper"></a>The Rusty Wrapper</h3><p>æˆ‘ä»¬éœ€è¦å°†å…¶å°è£…<code>struct</code>åˆ°ä¸€ä¸ªæ›´é«˜å±‚çš„ API ä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„ç”¨æˆ·å¯ä»¥å®‰å…¨åœ°è°ƒç”¨ã€‚ä½œä¸ºé©±åŠ¨ç¨‹åºä½œè€…ï¼Œæˆ‘ä»¬æ‰‹åŠ¨éªŒè¯ä¸å®‰å…¨ä»£ç æ˜¯å¦æ­£ç¡®ï¼Œç„¶åä¸ºæˆ‘ä»¬çš„ç”¨æˆ·æä¾›ä¸€ä¸ªå®‰å…¨çš„ APIï¼Œè¿™æ ·ä»–ä»¬å°±ä¸å¿…æ‹…å¿ƒï¼ˆå‰ææ˜¯ä»–ä»¬ç›¸ä¿¡æˆ‘ä»¬ä¼šåšå¯¹ï¼ï¼‰ã€‚</p>
<p>ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> SystemTimer <span class="token punctuation">{</span>
    p<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> RegisterBlock
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> RegisterBlock <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> SystemTimer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SystemTimer <span class="token punctuation">{</span>
        SystemTimer <span class="token punctuation">{</span>
            p<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> RegisterBlock<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> reload_value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>rvr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reload_value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">example_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">0x00FF_FFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"Time is now 0x{:08x}"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œè¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯ç¼–è¯‘å™¨å®Œå…¨å¯ä»¥æ¥å—ä»¥ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬<code>&amp;mut self</code>å¯¹è¯¥<code>set_reload</code>å‡½æ•°çš„å‚æ•°æ£€æŸ¥æ˜¯å¦æ²¡æœ‰<em>å¯¹è¯¥</em>ç‰¹å®š<code>SystemTimer</code>ç»“æ„çš„å…¶ä»–å¼•ç”¨ï¼Œä½†å®ƒä»¬ä¸ä¼šé˜»æ­¢ç”¨æˆ·åˆ›å»ºç¬¬äºŒä¸ª<code>SystemTimer</code>æŒ‡å‘å®Œå…¨ç›¸åŒçš„å¤–å›´è®¾å¤‡ï¼å¦‚æœä½œè€…è¶³å¤Ÿå‹¤å¥‹åœ°å‘ç°æ‰€æœ‰è¿™äº›â€œé‡å¤â€çš„é©±åŠ¨ç¨‹åºå®ä¾‹ï¼Œä»¥è¿™ç§æ–¹å¼ç¼–å†™çš„ä»£ç å°†èµ·ä½œç”¨ï¼Œä½†æ˜¯ä¸€æ—¦ä»£ç åˆ†å¸ƒåœ¨å¤šä¸ªæ¨¡å—ã€é©±åŠ¨ç¨‹åºã€å¼€å‘äººå‘˜å’Œæ•°å¤©ä¸­ï¼Œç¼–å†™è¿™äº›ä»£ç ä¼šå˜å¾—è¶Šæ¥è¶Šå®¹æ˜“å„ç§é”™è¯¯ã€‚</p>
<h2 id="The-Borrow-Checker"><a href="#The-Borrow-Checker" class="headerlink" title="The Borrow Checker"></a>The Borrow Checker</h2><h3 id="å¯å˜å…¨å±€çŠ¶æ€"><a href="#å¯å˜å…¨å±€çŠ¶æ€" class="headerlink" title="å¯å˜å…¨å±€çŠ¶æ€"></a>å¯å˜å…¨å±€çŠ¶æ€</h3><p>ä¸å¹¸çš„æ˜¯ï¼Œç¡¬ä»¶åŸºæœ¬ä¸Šåªæ˜¯å¯å˜çš„å…¨å±€çŠ¶æ€ï¼Œè¿™å¯¹äº Rust å¼€å‘äººå‘˜æ¥è¯´å¯èƒ½ä¼šæ„Ÿåˆ°éå¸¸å¯æ€•ã€‚ç¡¬ä»¶ç‹¬ç«‹äºæˆ‘ä»¬ç¼–å†™çš„ä»£ç ç»“æ„è€Œå­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥éšæ—¶è¢«ç°å®ä¸–ç•Œä¿®æ”¹ã€‚</p>
<h3 id="æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æˆ‘ä»¬å¦‚ä½•æ‰èƒ½å¯é åœ°ä¸è¿™äº›å¤–å›´è®¾å¤‡äº¤äº’ï¼Ÿ</p>
<ol>
<li>å§‹ç»ˆä½¿ç”¨<code>volatile</code>è¯»å–æˆ–å†™å…¥å¤–å›´å­˜å‚¨å™¨çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒå¯ä»¥éšæ—¶æ›´æ”¹</li>
<li>åœ¨è½¯ä»¶ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå…±äº«å¯¹è¿™äº›å¤–è®¾çš„ä»»æ„æ•°é‡çš„åªè¯»è®¿é—®</li>
<li>å¦‚æœæŸäº›è½¯ä»¶åº”è¯¥å…·æœ‰å¯¹å¤–å›´è®¾å¤‡çš„è¯»å†™è®¿é—®æƒé™ï¼Œåˆ™å®ƒåº”è¯¥æŒæœ‰å¯¹è¯¥å¤–å›´è®¾å¤‡çš„å”¯ä¸€å¼•ç”¨</li>
</ol>
<h3 id="å€Ÿç”¨æ£€æŸ¥å™¨"><a href="#å€Ÿç”¨æ£€æŸ¥å™¨" class="headerlink" title="å€Ÿç”¨æ£€æŸ¥å™¨"></a>å€Ÿç”¨æ£€æŸ¥å™¨</h3><p>è¿™äº›è§„åˆ™ä¸­çš„æœ€åä¸¤æ¡å¬èµ·æ¥ä¸ Borrow Checker å·²ç»åšçš„å¾ˆç›¸ä¼¼ï¼</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä¼ é€’è¿™äº›å¤–å›´è®¾å¤‡çš„æ‰€æœ‰æƒï¼Œæˆ–è€…ä¸ºå®ƒä»¬æä¾›ä¸å¯å˜æˆ–å¯å˜çš„å¼•ç”¨ï¼Ÿ</p>
<p>å—¯ï¼Œæˆ‘ä»¬å¯ä»¥ï¼Œä½†æ˜¯å¯¹äº Borrow Checkerï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªå¤–è®¾æ­£å¥½æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ · Rust æ‰èƒ½æ­£ç¡®å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚å¥½å§ï¼Œå¹¸è¿çš„æ˜¯åœ¨ç¡¬ä»¶ä¸­ï¼Œä»»ä½•ç»™å®šçš„å¤–å›´è®¾å¤‡åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨ä»£ç ç»“æ„ä¸­å…¬å¼€å®ƒï¼Ÿ</p>
<h2 id="Singletons"><a href="#Singletons" class="headerlink" title="Singletons"></a>Singletons</h2><blockquote>
<p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œå•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†ç±»çš„å®ä¾‹åŒ–é™åˆ¶ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p><em>ç»´åŸºç™¾ç§‘ï¼š<a href="https://en.wikipedia.org/wiki/Singleton_pattern" target="_blank" rel="noopener">å•ä¾‹æ¨¡å¼</a></em></p>
</blockquote>
<h3 id="ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ"><a href="#ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ" class="headerlink" title="ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ"></a>ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ</h3><p>æˆ‘ä»¬å¯ä»¥è®©ä¸€åˆ‡éƒ½å˜æˆå…¬å…±é™æ€ï¼Œå°±åƒè¿™æ ·</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> THE_SERIAL_PORT<span class="token punctuation">:</span> SerialPort <span class="token operator">=</span> SerialPort<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        THE_SERIAL_PORT<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†è¿™æœ‰å‡ ä¸ªé—®é¢˜ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯å˜çš„å…¨å±€å˜é‡ï¼Œåœ¨ Rust ä¸­ï¼Œä¸è¿™äº›å˜é‡äº¤äº’æ€»æ˜¯ä¸å®‰å…¨çš„ã€‚è¿™äº›å˜é‡åœ¨æ•´ä¸ªç¨‹åºä¸­ä¹Ÿæ˜¯å¯è§çš„ï¼Œè¿™æ„å‘³ç€å€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•å¸®åŠ©æ‚¨è·Ÿè¸ªè¿™äº›å˜é‡çš„å¼•ç”¨å’Œæ‰€æœ‰æƒã€‚</p>
<h3 id="æˆ‘ä»¬å¦‚ä½•åœ¨-Rust-ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ"><a href="#æˆ‘ä»¬å¦‚ä½•åœ¨-Rust-ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ" class="headerlink" title="æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ"></a>æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ</h3><p>æˆ‘ä»¬ä¸åªæ˜¯è®©æˆ‘ä»¬çš„å¤–è®¾æˆä¸ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè€Œæ˜¯å†³å®šåˆ›å»ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç§°ä¸º<code>PERIPHERALS</code>ï¼Œå®ƒåŒ…å«<code>Option&lt;T&gt;</code>æˆ‘ä»¬æ¯ä¸ªå¤–è®¾çš„ ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>SerialPort<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Peripherals <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SerialPort <span class="token punctuation">{</span>
        <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> PERIPHERALS<span class="token punctuation">:</span> Peripherals <span class="token operator">=</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>SerialPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ç§ç»“æ„ä½¿æˆ‘ä»¬èƒ½å¤Ÿè·å¾—å¤–å›´è®¾å¤‡çš„å•ä¸ªå®ä¾‹ã€‚å¦‚æœæˆ‘ä»¬å°è¯•<code>take_serial()</code>å¤šæ¬¡è°ƒç”¨ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä¼šå´©æºƒï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// This panics!</span>
    <span class="token comment" spellcheck="true">// let serial_2 = unsafe { PERIPHERALS.take_serial() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°½ç®¡ä¸è¿™ä¸ªç»“æ„äº¤äº’æ˜¯<code>unsafe</code>ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬åŒ…å«äº†<code>SerialPort</code>å®ƒï¼Œæˆ‘ä»¬å°±ä¸å†éœ€è¦ä½¿ç”¨<code>unsafe</code>ï¼Œæˆ–è€…æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨è¯¥<code>PERIPHERALS</code>ç»“æ„ã€‚</p>
<p>è¿™æœ‰ä¸€ä¸ªå°çš„è¿è¡Œæ—¶å¼€é”€ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»å°†<code>SerialPort</code>ç»“æ„åŒ…è£…åœ¨ä¸€ä¸ªé€‰é¡¹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨<code>take_serial()</code>ä¸€æ¬¡ï¼Œä½†æ˜¯è¿™ä¸ªå°çš„å‰æœŸæˆæœ¬å…è®¸æˆ‘ä»¬åœ¨æˆ‘ä»¬ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä¸­åˆ©ç”¨å€Ÿç”¨æ£€æŸ¥å™¨ã€‚</p>
<h3 id="ç°æœ‰åº“æ”¯æŒ"><a href="#ç°æœ‰åº“æ”¯æŒ" class="headerlink" title="ç°æœ‰åº“æ”¯æŒ"></a>ç°æœ‰åº“æ”¯æŒ</h3><p>å°½ç®¡æˆ‘ä»¬åœ¨<code>Peripherals</code>ä¸Šé¢åˆ›å»ºäº†è‡ªå·±çš„ç»“æ„ï¼Œä½†æ²¡æœ‰å¿…è¦ä¸ºæ‚¨çš„ä»£ç æ‰§è¡Œæ­¤æ“ä½œã€‚åœ¨<code>cortex_m</code>ç®±å­ä¸­å«æœ‰ä¸€ç§å«å®<code>singleton!()</code>ï¼Œä¼šä¸ºä½ æ‰§è¡Œæ­¤æ“ä½œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_use(singleton)]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// OK if `main` is executed only once</span>
    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> bool <span class="token operator">=</span>
        <span class="token function">singleton!</span><span class="token punctuation">(</span><span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://docs.rs/cortex-m/latest/cortex_m/macro.singleton.html" target="_blank" rel="noopener">cortex_m æ–‡æ¡£</a></p>
<p>æ­¤å¤–ï¼Œå¦‚æœæ‚¨ä½¿ç”¨<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener"><code>cortex-m-rtic</code></a>ï¼Œåˆ™å®šä¹‰å’Œè·å–è¿™äº›å¤–è®¾çš„æ•´ä¸ªè¿‡ç¨‹éƒ½ä¼šä¸ºæ‚¨æŠ½è±¡åŒ–ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ª<code>Peripherals</code>ç»“æ„ï¼Œå…¶ä¸­åŒ…å«<code>Option&lt;T&gt;</code>æ‚¨å®šä¹‰çš„æ‰€æœ‰é¡¹ç›®çš„éç‰ˆæœ¬ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// cortex-m-rtic v0.5.x</span>
#<span class="token punctuation">[</span>rtic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">app</span><span class="token punctuation">(</span>device <span class="token operator">=</span> lm3s6965<span class="token punctuation">,</span> peripherals <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> APP<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[init]</span>
    <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>cx<span class="token punctuation">:</span> init<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">mut</span> X<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Cortex-M peripherals</span>
        <span class="token keyword">let</span> core<span class="token punctuation">:</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>core<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Device specific peripherals</span>
        <span class="token keyword">let</span> device<span class="token punctuation">:</span> lm3s6965<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä½†ä¸ºä»€ä¹ˆï¼Ÿ"><a href="#ä½†ä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä½†ä¸ºä»€ä¹ˆï¼Ÿ"></a>ä½†ä¸ºä»€ä¹ˆï¼Ÿ</h3><p>ä½†æ˜¯è¿™äº›å•ä¾‹å¦‚ä½•å¯¹æˆ‘ä»¬çš„ Rust ä»£ç çš„å·¥ä½œæ–¹å¼äº§ç”Ÿæ˜¾ç€çš„å½±å“ï¼Ÿ</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SER_PORT_SPEED_REG<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32 <span class="token operator">=</span> <span class="token number">0x4000_1000</span> <span class="token keyword">as</span> _<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">read_speed</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token comment" spellcheck="true">// &lt;------ This is really, really important</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>SER_PORT_SPEED_REG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªé‡è¦å› ç´ åœ¨èµ·ä½œç”¨ï¼š</p>
<ul>
<li>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å•ä¾‹ï¼Œæ‰€ä»¥åªæœ‰ä¸€ç§æ–¹æ³•æˆ–åœ°æ–¹å¯ä»¥è·å–<code>SerialPort</code>ç»“æ„</li>
<li>è¦è°ƒç”¨è¯¥<code>read_speed()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»æ‹¥æœ‰æ‰€æœ‰æƒæˆ–å¯¹<code>SerialPort</code>ç»“æ„çš„å¼•ç”¨</li>
</ul>
<p>è¿™ä¸¤ä¸ªå› ç´ æ”¾åœ¨ä¸€èµ·æ„å‘³ç€åªæœ‰åœ¨æˆ‘ä»¬é€‚å½“æ»¡è¶³å€Ÿç”¨æ£€æŸ¥å™¨çš„æƒ…å†µä¸‹æ‰èƒ½è®¿é—®ç¡¬ä»¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šå¯¹åŒä¸€ç¡¬ä»¶æœ‰å¤šä¸ªå¯å˜å¼•ç”¨ï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// missing reference to `self`! Won't work.</span>
    <span class="token comment" spellcheck="true">// SerialPort::read_speed();</span>

    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// you can only read what you have access to</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> serial_1<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶"><a href="#åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶" class="headerlink" title="åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶"></a>åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶</h3><p>æ­¤å¤–ï¼Œç”±äºä¸€äº›å¼•ç”¨æ˜¯å¯å˜çš„ï¼Œè€Œä¸€äº›å¼•ç”¨æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤å¯ä»¥æŸ¥çœ‹å‡½æ•°æˆ–æ–¹æ³•æ˜¯å¦æœ‰å¯èƒ½ä¿®æ”¹ç¡¬ä»¶çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œ</p>
<p>å…è®¸æ›´æ”¹ç¡¬ä»¶è®¾ç½®ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">setup_spi_port</span><span class="token punctuation">(</span>
    spi<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> SpiPort<span class="token punctuation">,</span>
    cs_pin<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> GpioPin
<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸æ˜¯ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read_button</span><span class="token punctuation">(</span>gpio<span class="token punctuation">:</span> <span class="token operator">&amp;</span>GpioPin<span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™å…è®¸æˆ‘ä»¬å¼ºåˆ¶ä»£ç æ˜¯å¦åº”è¯¥æˆ–ä¸åº”è¯¥åœ¨<strong>ç¼–è¯‘æ—¶è€Œ</strong>ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¯¹ç¡¬ä»¶è¿›è¡Œæ›´æ”¹ã€‚è¯·æ³¨æ„ï¼Œè¿™é€šå¸¸ä»…é€‚ç”¨äºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†å¯¹äºè£¸æœºç³»ç»Ÿï¼Œæˆ‘ä»¬çš„è½¯ä»¶å°†è¢«ç¼–è¯‘ä¸ºå•ä¸ªåº”ç”¨ç¨‹åºï¼Œå› æ­¤è¿™é€šå¸¸ä¸æ˜¯é™åˆ¶ã€‚</p>
<h1 id="Static-Guarantees"><a href="#Static-Guarantees" class="headerlink" title="Static Guarantees"></a>Static Guarantees</h1><p>Rust çš„ç±»å‹ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶é˜²æ­¢æ•°æ®ç«äº‰ï¼ˆè¯·å‚é˜…<a href="https://doc.rust-lang.org/core/marker/trait.Send.html" target="_blank" rel="noopener"><code>Send</code></a>å’Œ <a href="https://doc.rust-lang.org/core/marker/trait.Sync.html" target="_blank" rel="noopener"><code>Sync</code></a>ç‰¹å¾ï¼‰ã€‚ç±»å‹ç³»ç»Ÿè¿˜å¯ç”¨äºåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å…¶ä»–å±æ€§ï¼›åœ¨æŸäº›æƒ…å†µä¸‹å‡å°‘è¿è¡Œæ—¶æ£€æŸ¥çš„éœ€è¦ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå½“åº”ç”¨äºåµŒå…¥å¼ç¨‹åºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›<em>é™æ€æ£€æŸ¥</em>æ¥å¼ºåˆ¶æ­£ç¡®å®Œæˆ I/O æ¥å£çš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ª APIï¼Œå…¶ä¸­åªèƒ½é€šè¿‡é¦–å…ˆé…ç½®æ¥å£å°†ä½¿ç”¨çš„å¼•è„šæ¥åˆå§‹åŒ–ä¸²è¡Œæ¥å£ã€‚</p>
<p>è¿˜å¯ä»¥é™æ€æ£€æŸ¥æ“ä½œï¼Œä¾‹å¦‚å°†å¼•è„šè®¾ç½®ä¸ºä½ç”µå¹³ï¼Œåªèƒ½åœ¨æ­£ç¡®é…ç½®çš„å¤–è®¾ä¸Šæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå°è¯•æ›´æ”¹é…ç½®ä¸ºæµ®åŠ¨è¾“å…¥æ¨¡å¼çš„å¼•è„šçš„è¾“å‡ºçŠ¶æ€ä¼šå¼•å‘ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>å¹¶ä¸”ï¼Œå¦‚å‰ä¸€ç« æ‰€è§ï¼Œæ‰€æœ‰æƒçš„æ¦‚å¿µå¯ä»¥åº”ç”¨äºå¤–è®¾ï¼Œä»¥ç¡®ä¿åªæœ‰ç¨‹åºçš„æŸäº›éƒ¨åˆ†å¯ä»¥ä¿®æ”¹å¤–è®¾ã€‚ä¸å°†å¤–å›´è®¾å¤‡è§†ä¸ºå…¨å±€å¯å˜çŠ¶æ€çš„æ›¿ä»£æ–¹æ¡ˆç›¸æ¯”ï¼Œè¿™ç§<em>è®¿é—®æ§åˆ¶</em>ä½¿è½¯ä»¶æ›´å®¹æ˜“æ¨ç†ã€‚</p>
<h2 id="Typestate-Programming"><a href="#Typestate-Programming" class="headerlink" title="Typestate Programming"></a>Typestate Programming</h2><p><a href="https://en.wikipedia.org/wiki/Typestate_analysis" target="_blank" rel="noopener">typestates</a>çš„æ¦‚å¿µæè¿°äº†å°†æœ‰å…³å¯¹è±¡å½“å‰çŠ¶æ€çš„ä¿¡æ¯ç¼–ç ä¸ºè¯¥å¯¹è±¡çš„ç±»å‹ã€‚è™½ç„¶è¿™å¬èµ·æ¥æœ‰ç‚¹ç¥ç§˜ï¼Œä½†å¦‚æœæ‚¨åœ¨ Rust ä¸­ä½¿ç”¨è¿‡<a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html" target="_blank" rel="noopener">æ„å»ºå™¨æ¨¡å¼</a>ï¼Œé‚£ä¹ˆæ‚¨å·²ç»å¼€å§‹ä½¿ç”¨ Typestate Programmingï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">mod</span> foo_module <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[derive(Debug)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
        inner<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">struct</span> FooBuilder <span class="token punctuation">{</span>
        a<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> FooBuilder <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>starter<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">double_a</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Foo <span class="token punctuation">{</span>
            Foo <span class="token punctuation">{</span>
                inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> foo_module<span class="token punctuation">:</span><span class="token punctuation">:</span>FooBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">double_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª<code>Foo</code>å¯¹è±¡ã€‚æˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ª<code>FooBuilder</code>ï¼Œå¹¶æ­£ç¡®åˆå§‹åŒ–å®ƒï¼Œç„¶åæ‰èƒ½è·å¾—<code>Foo</code>æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡ã€‚</p>
<p>è¿™ä¸ªæœ€å°çš„ä¾‹å­ç¼–ç äº†ä¸¤ä¸ªçŠ¶æ€ï¼š</p>
<ul>
<li><code>FooBuilder</code>ï¼Œè¡¨ç¤ºâ€œæœªé…ç½®â€æˆ–â€œé…ç½®è¿›è¡Œä¸­â€çŠ¶æ€</li>
<li><code>Foo</code>ï¼Œè¡¨ç¤ºâ€œå·²é…ç½®â€æˆ–â€œå‡†å¤‡ä½¿ç”¨â€çŠ¶æ€ã€‚</li>
</ul>
<h3 id="å¼ºç±»å‹"><a href="#å¼ºç±»å‹" class="headerlink" title="å¼ºç±»å‹"></a>å¼ºç±»å‹</h3><p>å› ä¸º Rust æœ‰ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing" target="_blank" rel="noopener">å¼ºç±»å‹ç³»ç»Ÿ</a>ï¼Œæ²¡æœ‰ç®€å•çš„æ–¹æ³•å¯ä»¥ç¥å¥‡åœ°åˆ›å»º çš„å®ä¾‹<code>Foo</code>ï¼Œæˆ–è€…åœ¨ä¸è°ƒç”¨æ–¹æ³•<code>FooBuilder</code>çš„<code>Foo</code>æƒ…å†µä¸‹å°† aå˜æˆ a <code>into_foo()</code>ã€‚æ­¤å¤–ï¼Œè°ƒç”¨è¯¥<code>into_foo()</code>æ–¹æ³•ä¼šæ¶ˆè€—åŸå§‹<code>FooBuilder</code>ç»“æ„ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸åˆ›å»ºæ–°å®ä¾‹å°±æ— æ³•é‡ç”¨å®ƒã€‚</p>
<p>è¿™å…è®¸æˆ‘ä»¬å°†ç³»ç»Ÿçš„çŠ¶æ€è¡¨ç¤ºä¸ºç±»å‹ï¼Œå¹¶å°†çŠ¶æ€è½¬æ¢çš„å¿…è¦æ“ä½œåŒ…å«åˆ°å°†ä¸€ç§ç±»å‹äº¤æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„æ–¹æ³•ä¸­ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>FooBuilder</code>å¹¶å°†å…¶äº¤æ¢ä¸ºä¸€ä¸ª<code>Foo</code>å¯¹è±¡ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†åŸºæœ¬çŠ¶æ€æœºçš„æ­¥éª¤ã€‚</p>
<h2 id="Peripherals-as-State-Machines"><a href="#Peripherals-as-State-Machines" class="headerlink" title="Peripherals as State Machines"></a>Peripherals as State Machines</h2><p>å¾®æ§åˆ¶å™¨çš„å¤–å›´è®¾å¤‡å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç»„çŠ¶æ€æœºã€‚ä¾‹å¦‚ï¼Œç®€åŒ–<a href="https://en.wikipedia.org/wiki/General-purpose_input/output" target="_blank" rel="noopener">GPIO å¼•è„š</a>çš„é…ç½®å¯ä»¥è¡¨ç¤ºä¸ºä»¥ä¸‹çŠ¶æ€æ ‘ï¼š</p>
<ul>
<li>å·²ç¦ç”¨</li>
<li>å¯ç”¨<ul>
<li>é…ç½®ä¸ºè¾“å‡º<ul>
<li>è¾“å‡ºï¼šé«˜</li>
<li>è¾“å‡ºï¼šä½</li>
</ul>
</li>
<li>é…ç½®ä¸ºè¾“å…¥<ul>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
<li>è¾“å…¥ï¼šæ‹‰é«˜</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¦‚æœå¤–è®¾åœ¨<code>Disabled</code>æ¨¡å¼ä¸‹å¯åŠ¨ï¼Œè¦ç§»åŠ¨åˆ°<code>Input: High Resistance</code>æ¨¡å¼ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å·²ç¦ç”¨</li>
<li>å¯ç”¨</li>
<li>é…ç½®ä¸ºè¾“å…¥</li>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
</ol>
<p>å¦‚æœæˆ‘ä»¬æƒ³ä» ç§»åŠ¨<code>Input: High Resistance</code>åˆ°<code>Input: Pulled Low</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
</ol>
<p>åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬è¦å°† GPIO å¼•è„šä»é…ç½®ä¸º ç§»åŠ¨<code>Input: Pulled Low</code>åˆ°<code>Output: High</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
<li>é…ç½®ä¸ºè¾“å…¥</li>
<li>é…ç½®ä¸ºè¾“å‡º</li>
<li>è¾“å‡ºï¼šé«˜</li>
</ol>
<h3 id="ç¡¬ä»¶è¡¨ç¤º"><a href="#ç¡¬ä»¶è¡¨ç¤º" class="headerlink" title="ç¡¬ä»¶è¡¨ç¤º"></a>ç¡¬ä»¶è¡¨ç¤º</h3><p>é€šå¸¸ï¼Œä¸Šé¢åˆ—å‡ºçš„çŠ¶æ€æ˜¯é€šè¿‡å°†å€¼å†™å…¥æ˜ å°„åˆ° GPIO å¤–è®¾çš„ç»™å®šå¯„å­˜å™¨æ¥è®¾ç½®çš„ã€‚è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè™šæ„çš„ GPIO é…ç½®å¯„å­˜å™¨æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼š</p>
<table>
<thead>
<tr>
<th>å§“å</th>
<th>ä½æ•°</th>
<th>ä»·å€¼</th>
<th>æ„ä¹‰</th>
<th>ç¬”è®°</th>
</tr>
</thead>
<tbody><tr>
<td>ä½¿èƒ½å¤Ÿ</td>
<td>0</td>
<td>0</td>
<td>æ®‹ç–¾</td>
<td>ç¦ç”¨ GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>å¯ç”¨</td>
<td>å¯ç”¨ GPIO</td>
</tr>
<tr>
<td>æ–¹å‘</td>
<td>1</td>
<td>0</td>
<td>è¾“å…¥</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å…¥</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è¾“å‡º</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å‡º</td>
</tr>
<tr>
<td>è¾“å…¥æ¨¡å¼</td>
<td>2..3</td>
<td>00</td>
<td>é«˜é˜»æŠ—</td>
<td>å°†è¾“å…¥è®¾ç½®ä¸ºé«˜ç”µé˜»</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>ä¸‹æ‹‰</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰ä½</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>æ‹‰é«˜</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰é«˜</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>ä¸é€‚ç”¨</td>
<td>æ— æ•ˆçŠ¶æ€ã€‚ä¸è¦è®¾ç½®</td>
</tr>
<tr>
<td>è¾“å‡ºæ¨¡å¼</td>
<td>4</td>
<td>0</td>
<td>è®¾ç½®ä½</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºä½ç”µå¹³</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è®¾ç½®é«˜</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºé«˜ç”µå¹³</td>
</tr>
<tr>
<td>è¾“å…¥çŠ¶æ€</td>
<td>5</td>
<td>X</td>
<td>æœ‰æ•ˆå€¼</td>
<td>0 å¦‚æœè¾“å…¥ &lt; 1.5vï¼Œ1 å¦‚æœè¾“å…¥ &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>æˆ‘ä»¬<em>å¯ä»¥</em>åœ¨ Rust ä¸­æš´éœ²ä»¥ä¸‹ç»“æ„æ¥æ§åˆ¶è¿™ä¸ª GPIOï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬ä¿®æ”¹æŸäº›æ²¡æœ‰æ„ä¹‰çš„å¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬<code>output_mode</code>åœ¨ GPIO é…ç½®ä¸ºè¾“å…¥æ—¶è®¾ç½®è¯¥å­—æ®µä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨è¿™ç§ç»“æ„å°†å…è®¸æˆ‘ä»¬è¾¾åˆ°ä¸Šé¢çŠ¶æ€æœºæœªå®šä¹‰çš„çŠ¶æ€ï¼šä¾‹å¦‚ï¼Œè¾“å‡ºè¢«æ‹‰ä½ï¼Œæˆ–è¾“å…¥è¢«è®¾ç½®ä¸ºé«˜ã€‚å¯¹äºæŸäº›ç¡¬ä»¶ï¼Œè¿™å¯èƒ½æ— å…³ç´§è¦ã€‚åœ¨å…¶ä»–ç¡¬ä»¶ä¸Šï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´æ„å¤–æˆ–æœªå®šä¹‰çš„è¡Œä¸ºï¼</p>
<p>è™½ç„¶è¿™ä¸ªæ¥å£ç¼–å†™èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å¼ºåˆ¶æ‰§è¡Œæˆ‘ä»¬çš„ç¡¬ä»¶å®ç°æ‰€è§„å®šçš„è®¾è®¡å¥‘çº¦ã€‚</p>
<h2 id="Design-Contracts"><a href="#Design-Contracts" class="headerlink" title="Design Contracts"></a>Design Contracts</h2><p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª<em>ä¸</em>å¼ºåˆ¶æ‰§è¡Œè®¾è®¡å¥‘çº¦çš„æ¥å£ã€‚è®©æˆ‘ä»¬å†çœ‹çœ‹æˆ‘ä»¬æƒ³è±¡ä¸­çš„ GPIO é…ç½®å¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>å§“å</th>
<th>ä½æ•°</th>
<th>ä»·å€¼</th>
<th>æ„ä¹‰</th>
<th>ç¬”è®°</th>
</tr>
</thead>
<tbody><tr>
<td>ä½¿èƒ½å¤Ÿ</td>
<td>0</td>
<td>0</td>
<td>æ®‹ç–¾</td>
<td>ç¦ç”¨ GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>å¯ç”¨</td>
<td>å¯ç”¨ GPIO</td>
</tr>
<tr>
<td>æ–¹å‘</td>
<td>1</td>
<td>0</td>
<td>è¾“å…¥</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å…¥</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è¾“å‡º</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å‡º</td>
</tr>
<tr>
<td>è¾“å…¥æ¨¡å¼</td>
<td>2..3</td>
<td>00</td>
<td>é«˜é˜»æŠ—</td>
<td>å°†è¾“å…¥è®¾ç½®ä¸ºé«˜ç”µé˜»</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>ä¸‹æ‹‰</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰ä½</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>æ‹‰é«˜</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰é«˜</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>ä¸é€‚ç”¨</td>
<td>æ— æ•ˆçŠ¶æ€ã€‚ä¸è¦è®¾ç½®</td>
</tr>
<tr>
<td>è¾“å‡ºæ¨¡å¼</td>
<td>4</td>
<td>0</td>
<td>è®¾ç½®ä½</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºä½ç”µå¹³</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è®¾ç½®é«˜</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºé«˜ç”µå¹³</td>
</tr>
<tr>
<td>è¾“å…¥çŠ¶æ€</td>
<td>5</td>
<td>X</td>
<td>æœ‰æ•ˆå€¼</td>
<td>0 å¦‚æœè¾“å…¥ &lt; 1.5vï¼Œ1 å¦‚æœè¾“å…¥ &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>å¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨åº•å±‚ç¡¬ä»¶ä¹‹å‰æ£€æŸ¥çŠ¶æ€ï¼Œåœ¨è¿è¡Œæ—¶æ‰§è¡Œæˆ‘ä»¬çš„è®¾è®¡å¥‘çº¦ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set direction</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set input mode</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set output status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be output</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>bool<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to get status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å› ä¸ºæˆ‘ä»¬éœ€è¦å¯¹ç¡¬ä»¶å®æ–½é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä¼šè¿›è¡Œå¤§é‡çš„è¿è¡Œæ—¶æ£€æŸ¥ï¼Œè¿™ä¼šæµªè´¹æ—¶é—´å’Œèµ„æºï¼Œè€Œä¸”è¿™äº›ä»£ç å¯¹äºå¼€å‘äººå‘˜æ¥è¯´ä½¿ç”¨èµ·æ¥ä¼šå¾ˆä¸æ„‰å¿«ã€‚</p>
<h3 id="ç±»å‹çŠ¶æ€"><a href="#ç±»å‹çŠ¶æ€" class="headerlink" title="ç±»å‹çŠ¶æ€"></a>ç±»å‹çŠ¶æ€</h3><p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Rust çš„ç±»å‹ç³»ç»Ÿæ¥å¼ºåˆ¶æ‰§è¡ŒçŠ¶æ€è½¬æ¢è§„åˆ™å‘¢ï¼Ÿæ‹¿è¿™ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig<span class="token operator">&lt;</span>ENABLED<span class="token punctuation">,</span> DIRECTION<span class="token punctuation">,</span> MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
    enabled<span class="token punctuation">:</span> ENABLED<span class="token punctuation">,</span>
    direction<span class="token punctuation">:</span> DIRECTION<span class="token punctuation">,</span>
    mode<span class="token punctuation">:</span> MODE<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Type states for MODE in GpioConfig</span>
<span class="token keyword">struct</span> Disabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Output<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Input<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledLow<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledHigh<span class="token punctuation">;</span>
<span class="token keyword">struct</span> HighZ<span class="token punctuation">;</span>
<span class="token keyword">struct</span> DontCare<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/// These functions may be used on any GPIO Pin</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_disabled</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> DontCare<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Disabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">set_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Output<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// This function may be used on an Output Pin</span>
<span class="token keyword">impl</span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> set_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>set_high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// These methods may be used on any enabled input GPIO</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_status<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledLow<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_low</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledLow<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_up</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledHigh<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨å®ƒçš„ä»£ç ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/*
 * Example 1: Unconfigured to High-Z input
 */</span>
<span class="token keyword">let</span> pin<span class="token punctuation">:</span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">get_gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, pin isn't enabled!</span>
<span class="token comment" spellcheck="true">// pin.into_input_pull_down();</span>

<span class="token comment" spellcheck="true">// Now turn the pin from unconfigured to a high-z input</span>
<span class="token keyword">let</span> input_pin <span class="token operator">=</span> pin<span class="token punctuation">.</span><span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Read from the pin</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, input pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// input_pin.set_bit(true);</span>

<span class="token comment" spellcheck="true">/*
 * Example 2: High-Z input to Pulled Low input
 */</span>
<span class="token keyword">let</span> pulled_low <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Example 3: Pulled Low input to Output, set high
 */</span>
<span class="token keyword">let</span> output_pin <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
output_pin<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, output pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// output_pin.into_input_pull_down();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ç»å¯¹æ˜¯ä¸€ç§å­˜å‚¨å¼•è„šçŠ¶æ€çš„ä¾¿æ·æ–¹å¼ï¼Œä½†ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™æ¯”å°†çŠ¶æ€å­˜å‚¨åœ¨<code>enum</code>æˆ‘ä»¬çš„<code>GpioConfig</code>ç»“æ„å†…éƒ¨æ›´å¥½ï¼Ÿ</p>
<h3 id="ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨"><a href="#ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨" class="headerlink" title="ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨"></a>ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨</h3><p>å› ä¸ºæˆ‘ä»¬å®Œå…¨åœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡Œæˆ‘ä»¬çš„è®¾è®¡çº¦æŸï¼Œæ‰€ä»¥è¿™ä¸ä¼šäº§ç”Ÿè¿è¡Œæ—¶æˆæœ¬ã€‚å½“å¼•è„šå¤„äºè¾“å…¥æ¨¡å¼æ—¶ï¼Œæ— æ³•è®¾ç½®è¾“å‡ºæ¨¡å¼ã€‚ç›¸åï¼Œæ‚¨å¿…é¡»é€šè¿‡å°†å…¶è½¬æ¢ä¸ºè¾“å‡ºå¼•è„šæ¥éå†çŠ¶æ€ï¼Œç„¶åè®¾ç½®è¾“å‡ºæ¨¡å¼ã€‚å› æ­¤ï¼Œåœ¨æ‰§è¡Œå‡½æ•°ä¹‹å‰æ£€æŸ¥å½“å‰çŠ¶æ€ä¸ä¼šé€ æˆè¿è¡Œæ—¶æŸå¤±ã€‚</p>
<p>æ­¤å¤–ï¼Œç”±äºè¿™äº›çŠ¶æ€æ˜¯ç”±ç±»å‹ç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œçš„ï¼Œå› æ­¤è¯¥æ¥å£çš„ä½¿ç”¨è€…ä¸å†æœ‰é”™è¯¯çš„ä½™åœ°ã€‚å¦‚æœä»–ä»¬å°è¯•æ‰§è¡Œéæ³•çš„çŠ¶æ€è½¬æ¢ï¼Œä»£ç å°†æ— æ³•ç¼–è¯‘ï¼</p>
<h2 id="Zero-Cost-Abstractions"><a href="#Zero-Cost-Abstractions" class="headerlink" title="Zero Cost Abstractions"></a>Zero Cost Abstractions</h2><p>ç±»å‹çŠ¶æ€ä¹Ÿæ˜¯é›¶æˆæœ¬æŠ½è±¡çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ - å°†æŸäº›è¡Œä¸ºç§»åŠ¨åˆ°ç¼–è¯‘æ—¶æ‰§è¡Œæˆ–åˆ†æçš„èƒ½åŠ›ã€‚è¿™äº›ç±»å‹çŠ¶æ€ä¸åŒ…å«å®é™…æ•°æ®ï¼Œè€Œæ˜¯ç”¨ä½œæ ‡è®°ã€‚ç”±äºå®ƒä»¬ä¸åŒ…å«æ•°æ®ï¼Œå› æ­¤å®ƒä»¬åœ¨è¿è¡Œæ—¶åœ¨å†…å­˜ä¸­æ²¡æœ‰å®é™…è¡¨ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>mem<span class="token punctuation">:</span><span class="token punctuation">:</span>size_of<span class="token punctuation">;</span>

<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Enabled<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Input<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>PulledHigh<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="é›¶å°ºå¯¸ç±»å‹"><a href="#é›¶å°ºå¯¸ç±»å‹" class="headerlink" title="é›¶å°ºå¯¸ç±»å‹"></a>é›¶å°ºå¯¸ç±»å‹</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åƒè¿™æ ·å®šä¹‰çš„ç»“æ„ç§°ä¸ºé›¶å¤§å°ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬ä¸åŒ…å«å®é™…æ•°æ®ã€‚å°½ç®¡è¿™äº›ç±»å‹åœ¨ç¼–è¯‘æ—¶æ˜¯â€œçœŸå®çš„â€â€”â€”æ‚¨å¯ä»¥å¤åˆ¶å®ƒä»¬ã€ç§»åŠ¨å®ƒä»¬ã€å¼•ç”¨å®ƒä»¬ç­‰ç­‰ï¼Œä½†æ˜¯ä¼˜åŒ–å™¨å°†å®Œå…¨å‰¥ç¦»å®ƒä»¬ã€‚</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GpioConfig <span class="token punctuation">{</span>
        periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
        enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
        direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿”å›çš„ GpioConfig åœ¨è¿è¡Œæ—¶ä»ä¸å­˜åœ¨ã€‚è°ƒç”¨æ­¤å‡½æ•°é€šå¸¸å½’ç»“ä¸ºå•ä¸ªæ±‡ç¼–æŒ‡ä»¤ - å°†å¸¸é‡å¯„å­˜å™¨å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ä½ç½®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¼€å‘çš„ç±»å‹çŠ¶æ€æ¥å£æ˜¯ä¸€ç§é›¶æˆæœ¬æŠ½è±¡â€”â€”å®ƒä¸å†ä½¿ç”¨ CPUã€RAM æˆ–ä»£ç ç©ºé—´æ¥è·Ÿè¸ª çš„çŠ¶æ€<code>GpioConfig</code>ï¼Œå¹¶å‘ˆç°ä¸ºä¸ç›´æ¥å¯„å­˜å™¨è®¿é—®ç›¸åŒçš„æœºå™¨ä»£ç ã€‚</p>
<h3 id="åµŒå¥—"><a href="#åµŒå¥—" class="headerlink" title="åµŒå¥—"></a>åµŒå¥—</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œè¿™äº›æŠ½è±¡å¯ä»¥æ ¹æ®æ‚¨çš„éœ€è¦è¿›è¡ŒåµŒå¥—ã€‚åªè¦ä½¿ç”¨çš„æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯é›¶å°ºå¯¸ç±»å‹ï¼Œæ•´ä¸ªç»“æ„åœ¨è¿è¡Œæ—¶å°±ä¸ä¼šå­˜åœ¨ã€‚</p>
<p>å¯¹äºå¤æ‚æˆ–æ·±åº¦åµŒå¥—çš„ç»“æ„ï¼Œå®šä¹‰æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€ç»„åˆå¯èƒ½å¾ˆä¹å‘³ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå®å¯ç”¨äºç”Ÿæˆæ‰€æœ‰å®ç°ã€‚</p>
<h1 id="Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰"><a href="#Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰" class="headerlink" title="Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰"></a>Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰</h1><p>åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­ï¼Œå¯ç§»æ¤æ€§æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯é¢˜ï¼šæ¯ä¸ªä¾›åº”å•†ç”šè‡³æ¥è‡ªå•ä¸ªåˆ¶é€ å•†çš„æ¯ä¸ªç³»åˆ—éƒ½æä¾›ä¸åŒçš„å¤–å›´è®¾å¤‡å’ŒåŠŸèƒ½ï¼ŒåŒæ ·ï¼Œä¸å¤–å›´è®¾å¤‡äº¤äº’çš„æ–¹å¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<p>å¹³è¡¡è¿™ç§å·®å¼‚çš„å¸¸ç”¨æ–¹æ³•æ˜¯é€šè¿‡ç§°ä¸ºç¡¬ä»¶æŠ½è±¡å±‚æˆ–<strong>HAL çš„</strong>å±‚ã€‚</p>
<blockquote>
<p>ç¡¬ä»¶æŠ½è±¡æ˜¯è½¯ä»¶ä¸­çš„ä¸€ç»„ä¾‹ç¨‹ï¼Œç”¨äºæ¨¡æ‹ŸæŸäº›ç‰¹å®šäºå¹³å°çš„ç»†èŠ‚ï¼Œä½¿ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºã€‚</p>
<p>å®ƒä»¬é€šå¸¸å…è®¸ç¨‹åºå‘˜é€šè¿‡å‘ç¡¬ä»¶æä¾›æ ‡å‡†æ“ä½œç³»ç»Ÿ (OS) è°ƒç”¨æ¥ç¼–å†™ç‹¬ç«‹äºè®¾å¤‡çš„é«˜æ€§èƒ½åº”ç”¨ç¨‹åºã€‚</p>
<p><em>ç»´åŸºç™¾ç§‘ï¼š<a href="https://en.wikipedia.org/wiki/Hardware_abstraction" target="_blank" rel="noopener">ç¡¬ä»¶æŠ½è±¡å±‚</a></em></p>
</blockquote>
<p>åµŒå…¥å¼ç³»ç»Ÿåœ¨è¿™æ–¹é¢æœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸æ²¡æœ‰æ“ä½œç³»ç»Ÿå’Œç”¨æˆ·å¯å®‰è£…çš„è½¯ä»¶ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“ç¼–è¯‘çš„å›ºä»¶æ˜ åƒä»¥åŠè®¸å¤šå…¶ä»–é™åˆ¶ã€‚å› æ­¤ï¼Œè™½ç„¶ç»´åŸºç™¾ç§‘å®šä¹‰çš„ä¼ ç»Ÿæ–¹æ³•å¯èƒ½æœ‰æ•ˆï¼Œä½†å®ƒå¯èƒ½ä¸æ˜¯ç¡®ä¿å¯ç§»æ¤æ€§çš„æœ€æœ‰æ•ˆæ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿè¾“å…¥<strong>åµŒå…¥å¼å“ˆ</strong>â€¦</p>
<h2 id="ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ</h2><p>ç®€è€Œè¨€ä¹‹ï¼Œå®ƒæ˜¯ä¸€ç»„ç‰¹æ€§ï¼Œå®šä¹‰äº†<strong>HAL å®ç°</strong>ã€<strong>é©±åŠ¨ç¨‹åº</strong>å’Œ<strong>åº”ç”¨ç¨‹åºï¼ˆæˆ–å›ºä»¶ï¼‰</strong>ä¹‹é—´çš„å®ç°å¥‘çº¦ã€‚è¿™äº›å¥‘çº¦åŒ…æ‹¬èƒ½åŠ›ï¼ˆå³å¦‚æœä¸ºæŸç§ç±»å‹å®ç°äº†ç‰¹å¾ï¼Œ<strong>HAL å®ç°</strong>æä¾›äº†æŸç§èƒ½åŠ›ï¼‰å’Œæ–¹æ³•ï¼ˆå³å¦‚æœæ‚¨å¯ä»¥æ„é€ ä¸€ä¸ªå®ç°ç‰¹å¾çš„ç±»å‹ï¼Œåˆ™ä¿è¯æ‚¨æ‹¥æœ‰ç‰¹å¾ä¸­æŒ‡å®šçš„æ–¹æ³•å¯ç”¨çš„ï¼‰ã€‚</p>
<p>å…¸å‹çš„åˆ†å±‚å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/rust_layers.svg" alt=""></p>
<p><strong>åµŒå…¥å¼ hal</strong>ä¸­å®šä¹‰çš„ä¸€äº›ç‰¹å¾æ˜¯ï¼š</p>
<ul>
<li>GPIOï¼ˆè¾“å…¥å’Œè¾“å‡ºå¼•è„šï¼‰</li>
<li>ä¸²è¡Œé€šè®¯</li>
<li>I2C</li>
<li>SPI</li>
<li>è®¡æ—¶å™¨/å€’è®¡æ—¶</li>
<li>æ¨¡æ•°è½¬æ¢</li>
</ul>
<p>å®ç°å’Œä½¿ç”¨<strong>åµŒå…¥å¼ hal</strong>ç‰¹å¾å’Œæ¿æ¡ç®±çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†æ§åˆ¶å¤æ‚æ€§ã€‚å¦‚æœæ‚¨è®¤ä¸ºåº”ç”¨ç¨‹åºå¯èƒ½å¿…é¡»åœ¨ç¡¬ä»¶ä»¥åŠåº”ç”¨ç¨‹åºå’Œå…¶ä»–ç¡¬ä»¶ç»„ä»¶çš„æ½œåœ¨é©±åŠ¨ç¨‹åºä¸­å®ç°å¯¹å¤–å›´è®¾å¤‡çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆåº”è¯¥å¾ˆå®¹æ˜“çœ‹å‡ºå¯é‡ç”¨æ€§éå¸¸æœ‰é™ã€‚ç”¨æ•°å­¦è¡¨ç¤ºï¼Œå¦‚æœ<strong>M</strong>æ˜¯å¤–å›´ HAL å®ç°çš„æ•°é‡ï¼Œ<strong>N</strong>æ˜¯é©±åŠ¨ç¨‹åºçš„æ•°é‡ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºé‡æ–°å‘æ˜è½®å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°<strong>M*N ä¸ª</strong>å®ç°ï¼ŒåŒæ—¶ä½¿ç”¨<strong>åµŒå…¥å¼</strong>HALæä¾›çš„<em>API</em>ç‰¹å¾å°†ä½¿å®ç°å¤æ‚åº¦æ¥è¿‘<strong>M+N</strong>ã€‚å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–å¥½å¤„ï¼Œä¾‹å¦‚ç”±äºå®šä¹‰æ˜ç¡®ä¸”éšæ—¶å¯ç”¨çš„ APIï¼Œå‡å°‘äº†åå¤è¯•éªŒã€‚</p>
<h2 id="åµŒå…¥å¼-hal-çš„ç”¨æˆ·"><a href="#åµŒå…¥å¼-hal-çš„ç”¨æˆ·" class="headerlink" title="åµŒå…¥å¼ hal çš„ç”¨æˆ·"></a>åµŒå…¥å¼ hal çš„ç”¨æˆ·</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒHAL æœ‰ä¸‰ä¸ªä¸»è¦ç”¨æˆ·ï¼š</p>
<h3 id="HAL-å®æ–½"><a href="#HAL-å®æ–½" class="headerlink" title="HAL å®æ–½"></a>HAL å®æ–½</h3><p>HAL å®ç°æä¾›äº†ç¡¬ä»¶å’Œ HAL ç‰¹å¾çš„ç”¨æˆ·ä¹‹é—´çš„æ¥å£ã€‚å…¸å‹çš„å®ç°åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¸€ç§æˆ–å¤šç§ç¡¬ä»¶ç‰¹å®šç±»å‹</li>
<li>åˆ›å»ºå’Œåˆå§‹åŒ–æ­¤ç±»ç±»å‹çš„å‡½æ•°ï¼Œé€šå¸¸æä¾›å„ç§é…ç½®é€‰é¡¹ï¼ˆé€Ÿåº¦ã€æ“ä½œæ¨¡å¼ã€ä½¿ç”¨å¼•è„šç­‰ï¼‰</li>
<li>ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Š<code>trait</code> <code>impl</code>çš„<strong>åµŒ-HAL</strong>æ€§çŠ¶è¯¥ç±»å‹</li>
</ul>
<p>è¿™æ ·çš„<strong>HAL å®ç°</strong>å¯ä»¥æœ‰å¤šç§é£æ ¼ï¼š</p>
<ul>
<li>é€šè¿‡åº•å±‚ç¡¬ä»¶è®¿é—®ï¼Œä¾‹å¦‚é€šè¿‡å¯„å­˜å™¨</li>
<li>é€šè¿‡æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚é€šè¿‡<code>sysfs</code>åœ¨ Linux ä¸‹ä½¿ç”¨</li>
<li>é€šè¿‡é€‚é…å™¨ï¼Œä¾‹å¦‚ç”¨äºå•å…ƒæµ‹è¯•çš„æ¨¡æ‹Ÿç±»å‹</li>
<li>é€šè¿‡ç¡¬ä»¶é€‚é…å™¨çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚ I2C å¤šè·¯å¤ç”¨å™¨æˆ– GPIO æ‰©å±•å™¨</li>
</ul>
<h3 id="é©±åŠ¨"><a href="#é©±åŠ¨" class="headerlink" title="é©±åŠ¨"></a>é©±åŠ¨</h3><p>é©±åŠ¨ç¨‹åºä¸ºå†…éƒ¨æˆ–å¤–éƒ¨ç»„ä»¶å®ç°ä¸€ç»„è‡ªå®šä¹‰åŠŸèƒ½ï¼Œè¿æ¥åˆ°å®ç°åµŒå…¥å¼ hal ç‰¹å¾çš„å¤–è®¾ã€‚æ­¤ç±»é©±åŠ¨å™¨çš„å…¸å‹ç¤ºä¾‹åŒ…æ‹¬å„ç§ä¼ æ„Ÿå™¨ï¼ˆæ¸©åº¦ã€ç£åŠ›è®¡ã€åŠ é€Ÿåº¦è®¡ã€å…‰ï¼‰ã€æ˜¾ç¤ºè®¾å¤‡ï¼ˆLED é˜µåˆ—ã€LCD æ˜¾ç¤ºå™¨ï¼‰å’Œæ‰§è¡Œå™¨ï¼ˆç”µæœºã€å‘å°„å™¨ï¼‰ã€‚</p>
<p>é©±åŠ¨ç¨‹åºå¿…é¡»ä½¿ç”¨ç±»å‹å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ï¼Œè¯¥ç±»å‹å®ä¾‹å®ç°äº†ç‰¹å®š<code>trait</code>çš„åµŒå…¥å¼ halï¼Œè¿™æ˜¯é€šè¿‡ trait bound ç¡®ä¿çš„ï¼Œå¹¶æä¾›å…¶è‡ªå·±çš„ç±»å‹å®ä¾‹å’Œä¸€ç»„å…è®¸ä¸é©±åŠ¨è®¾å¤‡äº¤äº’çš„è‡ªå®šä¹‰æ–¹æ³•ã€‚</p>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>è¯¥åº”ç”¨ç¨‹åºå°†å„ä¸ªéƒ¨åˆ†ç»‘å®šåœ¨ä¸€èµ·å¹¶ç¡®ä¿å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚åœ¨ä¸åŒç³»ç»Ÿä¹‹é—´ç§»æ¤æ—¶ï¼Œè¿™æ˜¯æœ€éœ€è¦é€‚åº”å·¥ä½œçš„éƒ¨åˆ†ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡ HAL å®ç°æ­£ç¡®åˆå§‹åŒ–çœŸå®ç¡¬ä»¶ï¼Œå¹¶ä¸”ä¸åŒç¡¬ä»¶çš„åˆå§‹åŒ–ä¸åŒï¼Œæœ‰æ—¶å·®å¼‚å¾ˆå¤§ã€‚æ­¤å¤–ï¼Œç”¨æˆ·çš„é€‰æ‹©é€šå¸¸ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºç»„ä»¶å¯ä»¥ç‰©ç†è¿æ¥åˆ°ä¸åŒçš„ç»ˆç«¯ï¼Œç¡¬ä»¶æ€»çº¿æœ‰æ—¶éœ€è¦å¤–éƒ¨ç¡¬ä»¶æ¥åŒ¹é…é…ç½®ï¼Œæˆ–è€…åœ¨ä½¿ç”¨å†…éƒ¨å¤–è®¾ï¼ˆä¾‹å¦‚å¤šä¸ªå®šæ—¶å™¨ï¼‰æ—¶éœ€è¦è¿›è¡Œä¸åŒçš„æƒè¡¡å…·æœ‰ä¸åŒçš„åŠŸèƒ½å¯ç”¨æˆ–å¤–å›´è®¾å¤‡ä¸å…¶ä»–è®¾å¤‡å†²çªï¼‰ã€‚</p>
<h1 id="Concurrencyï¼ˆå¹¶å‘ï¼‰"><a href="#Concurrencyï¼ˆå¹¶å‘ï¼‰" class="headerlink" title="Concurrencyï¼ˆå¹¶å‘ï¼‰"></a>Concurrencyï¼ˆå¹¶å‘ï¼‰</h1><p>å½“ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¯èƒ½åœ¨ä¸åŒæ—¶é—´æˆ–æ— åºæ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿå¹¶å‘ã€‚åœ¨åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸­æ–­å¤„ç†ç¨‹åºï¼Œæ¯å½“ç›¸å…³çš„ä¸­æ–­å‘ç”Ÿæ—¶è¿è¡Œï¼Œ</li>
<li>å„ç§å½¢å¼çš„å¤šçº¿ç¨‹ï¼Œæ‚¨çš„å¾®å¤„ç†å™¨å®šæœŸåœ¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´è¿›è¡Œäº¤æ¢ï¼Œ</li>
<li>åœ¨æŸäº›ç³»ç»Ÿä¸­ï¼Œå¤šæ ¸å¾®å¤„ç†å™¨ï¼Œå…¶ä¸­æ¯ä¸ªæ ¸å¯ä»¥åŒæ—¶ç‹¬ç«‹è¿è¡Œç¨‹åºçš„ä¸åŒéƒ¨åˆ†ã€‚</li>
</ul>
<p>ç”±äºå¾ˆå¤šåµŒå…¥å¼ç¨‹åºéœ€è¦å¤„ç†ä¸­æ–­ï¼Œå¹¶å‘é€šå¸¸è¿Ÿæ—©ä¼šå‡ºç°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¾ˆå¤šå¾®å¦™å’Œå›°éš¾çš„é”™è¯¯å‘ç”Ÿçš„åœ°æ–¹ã€‚å¹¸è¿çš„æ˜¯ï¼ŒRust æä¾›äº†è®¸å¤šæŠ½è±¡å’Œå®‰å…¨ä¿è¯æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ­£ç¡®çš„ä»£ç ã€‚</p>
<h2 id="æ— å¹¶å‘"><a href="#æ— å¹¶å‘" class="headerlink" title="æ— å¹¶å‘"></a>æ— å¹¶å‘</h2><p>åµŒå…¥å¼ç¨‹åºæœ€ç®€å•çš„å¹¶å‘æ˜¯æ— å¹¶å‘ï¼šä½ çš„è½¯ä»¶ç”±ä¸€ä¸ªä¸»å¾ªç¯ç»„æˆï¼Œå®ƒä¸€ç›´åœ¨è¿è¡Œï¼Œæ ¹æœ¬æ²¡æœ‰ä¸­æ–­ã€‚æœ‰æ—¶è¿™éå¸¸é€‚åˆæ‰‹å¤´çš„é—®é¢˜ï¼é€šå¸¸ï¼Œæ‚¨çš„å¾ªç¯ä¼šè¯»å–ä¸€äº›è¾“å…¥ã€æ‰§è¡Œä¸€äº›å¤„ç†å¹¶å†™å…¥ä¸€äº›è¾“å‡ºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> <span class="token function">setup_peripherals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> inputs <span class="token operator">=</span> <span class="token function">read_inputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> outputs <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_outputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”±äºæ²¡æœ‰å¹¶å‘ï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒç¨‹åºå„éƒ¨åˆ†ä¹‹é—´çš„æ•°æ®å…±äº«æˆ–å¯¹å¤–å›´è®¾å¤‡çš„åŒæ­¥è®¿é—®ã€‚å¦‚æœæ‚¨å¯ä»¥é€šè¿‡è¿™ç§ç®€å•çš„æ–¹æ³•é€ƒè„±ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="å…¨å±€å¯å˜æ•°æ®"><a href="#å…¨å±€å¯å˜æ•°æ®" class="headerlink" title="å…¨å±€å¯å˜æ•°æ®"></a>å…¨å±€å¯å˜æ•°æ®</h2><p>ä¸éåµŒå…¥å¼ Rust ä¸åŒï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šåˆ›å»ºå †åˆ†é…å¹¶å°†å¯¹è¯¥æ•°æ®çš„å¼•ç”¨ä¼ é€’ç»™æ–°åˆ›å»ºçš„çº¿ç¨‹ã€‚ç›¸åï¼Œæˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½éšæ—¶è¢«è°ƒç”¨ï¼Œå¹¶ä¸”å¿…é¡»çŸ¥é“å¦‚ä½•è®¿é—®æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ä»»ä½•å…±äº«å†…å­˜ã€‚åœ¨æœ€ä½çº§åˆ«ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»<em>é™æ€åˆ†é…</em>å¯å˜å†…å­˜ï¼Œä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸»ä»£ç éƒ½å¯ä»¥å¼•ç”¨è¿™äº›å†…å­˜ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œè¿™æ ·çš„<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable" target="_blank" rel="noopener"><code>static mut</code></a>å˜é‡è¯»æˆ–å†™æ€»æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå¦‚æœä¸ç‰¹åˆ«å°å¿ƒï¼Œä½ å¯èƒ½ä¼šè§¦å‘ç«äº‰æ¡ä»¶ï¼Œä½ å¯¹å˜é‡çš„è®¿é—®åœ¨ä¸­é€”è¢«ä¸€ä¸ªä¹Ÿè®¿é—®è¯¥å˜é‡çš„ä¸­æ–­ä¸­æ–­ã€‚</p>
<p>æœ‰å…³æ­¤è¡Œä¸ºå¦‚ä½•åœ¨æ‚¨çš„ä»£ç ä¸­å¯¼è‡´ç»†å¾®é”™è¯¯çš„ç¤ºä¾‹ï¼Œè¯·è€ƒè™‘ä¸€ä¸ªåµŒå…¥å¼ç¨‹åºï¼Œè¯¥ç¨‹åºåœ¨æ¯ä¸ªä¸€ç§’å‘¨æœŸï¼ˆé¢‘ç‡è®¡æ•°å™¨ï¼‰è®¡ç®—æŸäº›è¾“å…¥ä¿¡å·çš„ä¸Šå‡æ²¿ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DANGER - Not actually safe! Could cause data races.</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¯ä¸€ç§’ï¼Œå®šæ—¶å™¨ä¸­æ–­éƒ½ä¼šå°†è®¡æ•°å™¨è®¾ç½®å› 0ã€‚åŒæ—¶ï¼Œä¸»å¾ªç¯ä¸æ–­æµ‹é‡ä¿¡å·ï¼Œå¹¶åœ¨çœ‹åˆ°ä»ä½åˆ°é«˜çš„å˜åŒ–æ—¶é€’å¢è®¡æ•°å™¨ã€‚æˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨<code>unsafe</code>è®¿é—® <code>COUNTER</code>ï¼Œå› ä¸ºå®ƒæ˜¯<code>static mut</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å‘ç¼–è¯‘å™¨ä¿è¯æˆ‘ä»¬ä¸ä¼šå¯¼è‡´ä»»ä½•æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä½ èƒ½å‘ç°æ¯”èµ›æ¡ä»¶å—ï¼Ÿä¸Šçš„å¢é‡<code>COUNTER</code>æ˜¯<em>ä¸èƒ½</em>ä¿è¯æ˜¯åŸå­-äº‹å®ä¸Šï¼Œåœ¨å¤§å¤šæ•°åµŒå…¥å¼å¹³å°ï¼Œå®ƒå°†è¢«åˆ†æˆäº†è´Ÿè½½ï¼Œåˆ™å¢é‡ï¼Œç„¶åå•†åº—ã€‚å¦‚æœä¸­æ–­åœ¨åŠ è½½ä¹‹åä½†åœ¨å­˜å‚¨ä¹‹å‰è§¦å‘ï¼Œåˆ™åœ¨ä¸­æ–­è¿”å›åå°†å¿½ç•¥é‡ç½®å› 0 - æˆ‘ä»¬å°†åœ¨è¯¥æœŸé—´è®¡ç®—ä¸¤å€çš„è½¬æ¢æ¬¡æ•°ã€‚</p>
<h2 id="ä¸´ç•ŒåŒº"><a href="#ä¸´ç•ŒåŒº" class="headerlink" title="ä¸´ç•ŒåŒº"></a>ä¸´ç•ŒåŒº</h2><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®ç«äº‰åšäº›ä»€ä¹ˆå‘¢ï¼Ÿä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨<em>ä¸´ç•ŒåŒº</em>ï¼Œå³ç¦ç”¨ä¸­æ–­çš„ä¸Šä¸‹æ–‡ã€‚é€šè¿‡å°†<code>COUNTER</code>inçš„è®¿é—®åŒ…è£… <code>main</code>åœ¨ä¸´ç•ŒåŒºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å®šæ—¶å™¨ä¸­æ–­åœ¨æˆ‘ä»¬å®Œæˆé€’å¢ä¹‹å‰ä¸ä¼šè§¦å‘<code>COUNTER</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// New critical section ensures synchronised access to COUNTER</span>
            cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>cortex_m::interrupt::free</code>ï¼Œä½†å…¶ä»–å¹³å°å°†å…·æœ‰ç±»ä¼¼çš„æœºåˆ¶æ¥æ‰§è¡Œä¸´ç•ŒåŒºä¸­çš„ä»£ç ã€‚è¿™ä¹Ÿä¸ç¦ç”¨ä¸­æ–­ã€è¿è¡Œä¸€äº›ä»£ç ï¼Œç„¶åé‡æ–°å¯ç”¨ä¸­æ–­ç›¸åŒã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­æ”¾ç½®ä¸´ç•ŒåŒºï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>å†™å…¥ 0<code>COUNTER</code>ä¸ä¼šå—åˆ°æ¯”èµ›çš„å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬ä¸é˜…è¯»å®ƒ</li>
<li><code>main</code>æ— è®ºå¦‚ä½•å®ƒæ°¸è¿œä¸ä¼šè¢«çº¿ç¨‹ä¸­æ–­</li>
</ul>
<p>å¦‚æœ<code>COUNTER</code>è¢«å¤šä¸ªå¯èƒ½äº’ç›¸<em>æŠ¢å çš„</em>ä¸­æ–­å¤„ç†ç¨‹åºå…±äº«ï¼Œé‚£ä¹ˆæ¯ä¸ªä¸­æ–­å¤„ç†ç¨‹åºä¹Ÿ å¯èƒ½éœ€è¦ä¸€ä¸ªä¸´ç•ŒåŒºã€‚</p>
<p>è¿™è§£å†³äº†æˆ‘ä»¬çœ¼å‰çš„é—®é¢˜ï¼Œä½†æˆ‘ä»¬ä»ç„¶è¦ç¼–å†™è®¸å¤šéœ€è¦ä»”ç»†æ¨ç†çš„ä¸å®‰å…¨ä»£ç ï¼Œè€Œä¸”æˆ‘ä»¬å¯èƒ½ä¼šä¸å¿…è¦åœ°ä½¿ç”¨ä¸´ç•ŒåŒºã€‚ç”±äºæ¯ä¸ªä¸´ç•ŒåŒºéƒ½ä¼šä¸´æ—¶æš‚åœä¸­æ–­å¤„ç†ï¼Œå› æ­¤ä¼šäº§ç”Ÿä¸€äº›é¢å¤–ä»£ç å¤§å°ä»¥åŠæ›´é«˜çš„ä¸­æ–­å»¶è¿Ÿå’ŒæŠ–åŠ¨çš„ç›¸å…³æˆæœ¬ï¼ˆå¤„ç†ä¸­æ–­å¯èƒ½éœ€è¦æ›´é•¿çš„æ—¶é—´ï¼Œå¹¶ä¸”å¤„ç†å®ƒä»¬ä¹‹å‰çš„æ—¶é—´å°†æ›´åŠ å¯å˜ï¼‰ã€‚è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªé—®é¢˜å–å†³äºæ‚¨çš„ç³»ç»Ÿï¼Œä½†æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…å®ƒã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ä¸´ç•ŒåŒºä¿è¯ä¸ä¼šè§¦å‘ä»»ä½•ä¸­æ–­ï¼Œä½†å®ƒä¸æä¾›å¤šæ ¸ç³»ç»Ÿä¸Šçš„æ’ä»–æ€§ä¿è¯ï¼å³ä½¿æ²¡æœ‰ä¸­æ–­ï¼Œå¦ä¸€ä¸ªå†…æ ¸ä¹Ÿå¯ä»¥æ„‰å¿«åœ°è®¿é—®ä¸æ‚¨çš„å†…æ ¸ç›¸åŒçš„å†…å­˜ã€‚å¦‚æœæ‚¨ä½¿ç”¨å¤šæ ¸ï¼Œæ‚¨å°†éœ€è¦æ›´å¼ºçš„åŒæ­¥åŸè¯­ã€‚</p>
<h2 id="åŸå­è®¿é—®"><a href="#åŸå­è®¿é—®" class="headerlink" title="åŸå­è®¿é—®"></a>åŸå­è®¿é—®</h2><p>åœ¨æŸäº›å¹³å°ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„åŸå­æŒ‡ä»¤ï¼Œä¸ºè¯»å–-ä¿®æ”¹-å†™å…¥æ“ä½œæä¾›ä¿è¯ã€‚ä¸“é—¨é’ˆå¯¹ Cortex-Mï¼š<code>thumbv6</code> ï¼ˆCortex-M0ã€Cortex-M0+ï¼‰ä»…æä¾›åŸå­åŠ è½½å’Œå­˜å‚¨æŒ‡ä»¤ï¼Œè€Œ<code>thumbv7</code>ï¼ˆCortex-M3 åŠä»¥ä¸Šï¼‰æä¾›å®Œæ•´çš„æ¯”è¾ƒå’Œäº¤æ¢ï¼ˆCASï¼‰æŒ‡ä»¤ã€‚è¿™äº› CAS æŒ‡ä»¤æä¾›äº†å¯¹æ‰€æœ‰ä¸­æ–­çš„ä¸¥å‰ç¦ç”¨çš„æ›¿ä»£æ–¹æ¡ˆï¼šæˆ‘ä»¬å¯ä»¥å°è¯•é€’å¢ï¼Œå®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šæˆåŠŸï¼Œä½†å¦‚æœè¢«ä¸­æ–­ï¼Œå®ƒå°†è‡ªåŠ¨é‡è¯•æ•´ä¸ªé€’å¢æ“ä½œã€‚å³ä½¿è·¨å¤šä¸ªå†…æ ¸ï¼Œè¿™äº›åŸå­æ“ä½œä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AtomicUsize<span class="token punctuation">,</span> Ordering<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> AtomicUsize <span class="token operator">=</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Use `fetch_add` to atomically add 1 to COUNTER</span>
            COUNTER<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use `store` to write 0 directly to COUNTER</span>
    COUNTER<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªæ—¶é—´<code>COUNTER</code>æ˜¯ä¸€ä¸ªå®‰å…¨<code>static</code>å˜é‡ã€‚ç”±äºå¯ä»¥ä»ä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸»çº¿ç¨‹å®‰å…¨åœ°ä¿®æ”¹<code>AtomicUsize</code> ç±»å‹ï¼Œ<code>COUNTER</code>è€Œæ— éœ€ç¦ç”¨ä¸­æ–­ã€‚å¦‚æœå¯èƒ½ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆ - ä½†æ‚¨çš„å¹³å°å¯èƒ½ä¸æ”¯æŒå®ƒã€‚</p>
<p>æ³¨æ„<a href="https://doc.rust-lang.org/core/sync/atomic/enum.Ordering.html" target="_blank" rel="noopener"><code>Ordering</code></a>ï¼šè¿™ä¼šå½±å“ç¼–è¯‘å™¨å’Œç¡¬ä»¶å¯¹æŒ‡ä»¤é‡æ–°æ’åºçš„æ–¹å¼ï¼Œä¹Ÿä¼šå¯¹ç¼“å­˜å¯è§æ€§äº§ç”Ÿå½±å“ã€‚å‡è®¾ç›®æ ‡æ˜¯å•æ ¸å¹³å°<code>Relaxed</code>å°±è¶³å¤Ÿäº†ï¼Œå¹¶ä¸”åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹æ˜¯æœ€æœ‰æ•ˆçš„é€‰æ‹©ã€‚æ›´ä¸¥æ ¼çš„æ’åºå°†å¯¼è‡´ç¼–è¯‘å™¨å›´ç»•åŸå­æ“ä½œå‘å‡ºå†…å­˜å±éšœï¼›æ ¹æ®æ‚¨ä½¿ç”¨åŸå­çš„å†…å®¹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¹Ÿå¯èƒ½ä¸éœ€è¦è¿™ä¸ªï¼åŸå­æ¨¡å‹çš„ç²¾ç¡®ç»†èŠ‚å¾ˆå¤æ‚ï¼Œæœ€å¥½åœ¨åˆ«å¤„è¿›è¡Œæè¿°ã€‚</p>
<p>æœ‰å…³åŸå­å’Œæ’åºçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://doc.rust-lang.org/nomicon/atomics.html" target="_blank" rel="noopener">nomicon</a>ã€‚</p>
<h2 id="æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥"><a href="#æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥" class="headerlink" title="æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥"></a>æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥</h2><p>ä¸Šè¿°è§£å†³æ–¹æ¡ˆéƒ½ä¸æ˜¯ç‰¹åˆ«ä»¤äººæ»¡æ„ã€‚å®ƒä»¬éœ€è¦<code>unsafe</code> å¿…é¡»éå¸¸ä»”ç»†åœ°æ£€æŸ¥å¹¶ä¸”ä¸ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„ç§¯æœ¨ã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥åœ¨ Rust ä¸­åšå¾—æ›´å¥½ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„è®¡æ•°å™¨æŠ½è±¡æˆä¸€ä¸ªå®‰å…¨çš„æ¥å£ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°åœ¨æˆ‘ä»¬ä»£ç çš„ä»»ä½•å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸´ç•ŒåŒºè®¡æ•°å™¨ï¼Œä½†ä½ å¯ä»¥ç”¨åŸå­åšä¸€äº›éå¸¸ç›¸ä¼¼çš„äº‹æƒ…ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>UnsafeCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Our counter is just a wrapper around UnsafeCell&lt;u32>, which is the heart</span>
<span class="token comment" spellcheck="true">// of interior mutability in Rust. By using interior mutability, we can have</span>
<span class="token comment" spellcheck="true">// COUNTER be `static` instead of `static mut`, but still able to mutate</span>
<span class="token comment" spellcheck="true">// its counter value.</span>
<span class="token keyword">struct</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CS_COUNTER_INIT<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> CSCounter <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// By requiring a CriticalSection be passed in, we know we must</span>
        <span class="token comment" spellcheck="true">// be operating inside a CriticalSection, and so can confidently</span>
        <span class="token comment" spellcheck="true">// use this unsafe block (required to call UnsafeCell::get).</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Required to allow static CSCounter. See explanation below.</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> CSCounter <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// COUNTER is no longer `mut` as it uses interior mutability;</span>
<span class="token comment" spellcheck="true">// therefore it also no longer requires unsafe blocks to access.</span>
<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> CS_COUNTER_INIT<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No unsafe here!</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We do need to enter a critical section here just to obtain a valid</span>
    <span class="token comment" spellcheck="true">// cs token, even though we know no other interrupt could pre-empt</span>
    <span class="token comment" spellcheck="true">// this one.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We could use unsafe code to generate a fake CriticalSection if we</span>
    <span class="token comment" spellcheck="true">// really wanted to, avoiding the overhead:</span>
    <span class="token comment" spellcheck="true">// let cs = unsafe { interrupt::CriticalSection::new() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å·²ç»å°†<code>unsafe</code>ä»£ç ç§»åˆ°ç²¾å¿ƒè§„åˆ’çš„æŠ½è±¡å†…éƒ¨ï¼Œç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç ä¸åŒ…å«ä»»ä½•<code>unsafe</code>å—ã€‚</p>
<p>è¿™ç§è®¾è®¡è¦æ±‚åº”ç”¨ç¨‹åºä¼ å…¥ä¸€ä¸ª<code>CriticalSection</code>ä»¤ç‰Œï¼šè¿™äº›ä»¤ç‰Œä»…ç”± å®‰å…¨ç”Ÿæˆ<code>interrupt::free</code>ï¼Œå› æ­¤é€šè¿‡è¦æ±‚ä¼ å…¥ä¸€ä¸ªä»¤ç‰Œï¼Œæˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬åœ¨ä¸´ç•ŒåŒºä¸­æ“ä½œï¼Œè€Œä¸å¿…è‡ªå·±å®é™…è¿›è¡Œé”å®šã€‚è¿™ç§ä¿è¯æ˜¯ç”±ç¼–è¯‘å™¨é™æ€æä¾›çš„ï¼šä¸ä¼šæœ‰ä»»ä½•ä¸<code>cs</code>. å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªè®¡æ•°å™¨ï¼Œå®ƒä»¬éƒ½å¯ä»¥è¢«èµ‹äºˆç›¸åŒçš„<code>cs</code>ï¼Œè€Œä¸éœ€è¦å¤šä¸ªåµŒå¥—çš„ä¸´ç•ŒåŒºã€‚</p>
<p>è¿™ä¹Ÿå¸¦æ¥äº† Rust å¹¶å‘çš„ä¸€ä¸ªé‡è¦ä¸»é¢˜ï¼š <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html" target="_blank" rel="noopener"><code>Send</code>å’Œ<code>Sync</code></a>ç‰¹å¾ã€‚æ€»ç»“ä¸€ä¸‹ Rust ä¹¦ï¼Œå½“å®ƒå¯ä»¥å®‰å…¨åœ°ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œç±»å‹æ˜¯ Sendï¼Œè€Œå½“å®ƒå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨å…±äº«æ—¶ï¼Œå®ƒæ˜¯ Syncã€‚åœ¨åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºä¸­æ–­åœ¨ä¸åº”ç”¨ç¨‹åºä»£ç ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå› æ­¤è¢«ä¸­æ–­å’Œä¸»ä»£ç è®¿é—®çš„å˜é‡å¿…é¡»æ˜¯åŒæ­¥çš„ã€‚</p>
<p>å¯¹äº Rust ä¸­çš„å¤§å¤šæ•°ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ‚¨æ´¾ç”Ÿè¿™ä¸¤ä¸ªç‰¹å¾ã€‚ä½†æ˜¯ï¼Œå› ä¸º<code>CSCounter</code>åŒ…å«ä¸€ä¸ª<a href="https://doc.rust-lang.org/core/cell/struct.UnsafeCell.html" target="_blank" rel="noopener"><code>UnsafeCell</code></a>ï¼Œå®ƒä¸æ˜¯åŒæ­¥çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ä½¿<code>static CSCounter</code>:<code>static</code> å˜é‡<em>å¿…é¡»</em>æ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ã€‚</p>
<p>ä¸ºäº†å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬å·²ç»æ³¨æ„åˆ°<code>CSCounter</code>åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å®é™…ä¸Šæ˜¯å®‰å…¨çš„ï¼Œæˆ‘ä»¬æ˜¾å¼åœ°å®ç°äº† Sync traitã€‚ä¸ä¹‹å‰ä½¿ç”¨çš„ä¸´ç•ŒåŒºä¸€æ ·ï¼Œè¿™ä»…åœ¨å•æ ¸å¹³å°ä¸Šæ˜¯å®‰å…¨çš„ï¼šå¯¹äºå¤šæ ¸ï¼Œæ‚¨éœ€è¦ä»˜å‡ºæ›´å¤§çš„åŠªåŠ›æ¥ç¡®ä¿å®‰å…¨ã€‚</p>
<h2 id="äº’æ–¥ä½“"><a href="#äº’æ–¥ä½“" class="headerlink" title="äº’æ–¥ä½“"></a>äº’æ–¥ä½“</h2><p>æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç‰¹å®šäºæˆ‘ä»¬çš„è®¡æ•°å™¨é—®é¢˜çš„æœ‰ç”¨æŠ½è±¡ï¼Œä½†æ˜¯æœ‰è®¸å¤šç”¨äºå¹¶å‘çš„é€šç”¨æŠ½è±¡ã€‚</p>
<p>ä¸€ä¸ªè¿™æ ·çš„<em>åŒæ­¥åŸè¯­</em>æ˜¯äº’æ–¥ï¼Œäº’æ–¥çš„ç¼©å†™ã€‚è¿™äº›æ„é€ ç¡®ä¿å¯¹å˜é‡çš„ç‹¬å è®¿é—®ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„è®¡æ•°å™¨ã€‚çº¿ç¨‹å¯ä»¥å°è¯•<em>é”å®š</em>ï¼ˆæˆ–<em>è·å–</em>ï¼‰äº’æ–¥é”ï¼Œå¹¶ä¸”è¦ä¹ˆç«‹å³æˆåŠŸï¼Œè¦ä¹ˆé˜»å¡ç­‰å¾…è·å–é”ï¼Œæˆ–è€…è¿”å›æ— æ³•é”å®šäº’æ–¥é”çš„é”™è¯¯ã€‚å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå®ƒè¢«æˆäºˆè®¿é—®å—ä¿æŠ¤æ•°æ®çš„æƒé™ã€‚å½“çº¿ç¨‹å®Œæˆæ—¶ï¼Œå®ƒ<em>è§£é”</em>ï¼ˆæˆ– <em>é‡Šæ”¾</em>ï¼‰äº’æ–¥é”ï¼Œå…è®¸å¦ä¸€ä¸ªçº¿ç¨‹é”å®šå®ƒã€‚åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<a href="https://doc.rust-lang.org/core/ops/trait.Drop.html" target="_blank" rel="noopener"><code>Drop</code></a>trait æ¥å®ç°è§£é”ï¼Œä»¥ç¡®ä¿å½“äº’æ–¥é‡è¶…å‡ºèŒƒå›´æ—¶å®ƒæ€»æ˜¯è¢«é‡Šæ”¾ã€‚</p>
<p>å°†äº’æ–¥é”ä¸ä¸­æ–­å¤„ç†ç¨‹åºä¸€èµ·ä½¿ç”¨å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼šä¸­æ–­å¤„ç†ç¨‹åºé˜»å¡é€šå¸¸æ˜¯ä¸å¯æ¥å—çš„ï¼Œå¹¶ä¸”é˜»å¡ç­‰å¾…ä¸»çº¿ç¨‹é‡Šæ”¾é”å°†æ˜¯ç‰¹åˆ«ç¾éš¾æ€§çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¼š<em>æ­»é”</em>ï¼ˆä¸»çº¿ç¨‹ï¼‰çº¿ç¨‹æ°¸è¿œä¸ä¼šé‡Šæ”¾é”ï¼Œå› ä¸ºæ‰§è¡Œåœç•™åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­ï¼‰ã€‚æ­»é”ä¸è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼šå³ä½¿åœ¨å®‰å…¨çš„ Rust ä¸­ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚</p>
<p>ä¸ºäº†å®Œå…¨é¿å…è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªéœ€è¦é”å®šä¸´ç•ŒåŒºçš„äº’æ–¥é”ï¼Œå°±åƒæˆ‘ä»¬çš„åä¾‹ä¸€æ ·ã€‚åªè¦ä¸´ç•ŒåŒºå¿…é¡»ä¸é”ä¸€æ ·é•¿ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿æˆ‘ä»¬å¯ä»¥ç‹¬å è®¿é—®è¢«åŒ…è£…çš„å˜é‡ï¼Œç”šè‡³ä¸éœ€è¦è·Ÿè¸ªäº’æ–¥é”çš„é”å®š/è§£é”çŠ¶æ€ã€‚</p>
<p>è¿™å®é™…ä¸Šæ˜¯åœ¨<code>cortex_m</code>æ¿æ¡ç®±ä¸­ä¸ºæˆ‘ä»¬å®Œæˆçš„ï¼æˆ‘ä»¬å¯ä»¥ç”¨å®ƒå†™æˆ‘ä»¬çš„è®¡æ•°å™¨ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>Cell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>Mutex<span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>Cell<span class="token operator">&lt;</span>u32<span class="token operator">>></span> <span class="token operator">=</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Cell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span>
                COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We still need to enter a critical section here to satisfy the Mutex.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨ä½¿ç”¨<a href="https://doc.rust-lang.org/core/cell/struct.Cell.html" target="_blank" rel="noopener"><code>Cell</code></a>ï¼Œå®ƒå’Œå®ƒçš„å…„å¼Ÿä¸€èµ·<code>RefCell</code>è¢«ç”¨æ¥æä¾›å®‰å…¨çš„å†…éƒ¨å¯å˜æ€§ã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°<code>UnsafeCell</code>äº† Rust å†…éƒ¨å¯å˜æ€§çš„åº•å±‚ï¼šå®ƒå…è®¸æ‚¨è·å¾—å¯¹å…¶å€¼çš„å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œä½†åªèƒ½ä½¿ç”¨ä¸å®‰å…¨çš„ä»£ç ã€‚A<code>Cell</code> ç±»ä¼¼äº an<code>UnsafeCell</code>ä½†å®ƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ¥å£ï¼šå®ƒåªå…è®¸è·å–å½“å‰å€¼çš„å‰¯æœ¬æˆ–æ›¿æ¢å®ƒï¼Œè€Œä¸æ˜¯è·å–å¼•ç”¨ï¼Œå¹¶ä¸”ç”±äºå®ƒä¸æ˜¯ Syncï¼Œå› æ­¤ä¸èƒ½åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚è¿™äº›çº¦æŸæ„å‘³ç€å®ƒå¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨<code>static</code>å˜é‡ä¸­ä½¿ç”¨å®ƒï¼Œ å› ä¸º<code>static</code>å¿…é¡»æ˜¯ Syncã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆä¸Šé¢çš„ä¾‹å­æœ‰æ•ˆå‘¢ï¼Ÿ<code>Mutex&lt;T&gt;</code>ä¸ºä»»ä½•<code>T</code>å‘é€çš„å®ç°åŒæ­¥ - ä¾‹å¦‚<code>Cell</code>. å®ƒå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºå®ƒä»…åœ¨å…³é”®éƒ¨åˆ†æœŸé—´æ‰å…è®¸è®¿é—®å…¶å†…å®¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå®Œå…¨æ²¡æœ‰ä¸å®‰å…¨ä»£ç çš„å®‰å…¨è®¡æ•°å™¨ï¼</p>
<p>è¿™å¯¹äºåƒ<code>u32</code>æˆ‘ä»¬çš„è®¡æ•°å™¨è¿™æ ·çš„ç®€å•ç±»å‹éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å¯¹äºä¸æ˜¯ Copy çš„æ›´å¤æ‚çš„ç±»å‹å‘¢ï¼ŸåµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ä¸€ä¸ªæå…¶å¸¸è§çš„ç¤ºä¾‹æ˜¯å¤–è®¾ç»“æ„ï¼Œå®ƒé€šå¸¸ä¸æ˜¯ Copyã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è½¬å‘<code>RefCell</code>.</p>
<h2 id="å…±äº«å¤–è®¾"><a href="#å…±äº«å¤–è®¾" class="headerlink" title="å…±äº«å¤–è®¾"></a>å…±äº«å¤–è®¾</h2><p>ä½¿ç”¨<code>svd2rust</code>å’Œç±»ä¼¼æŠ½è±¡ç”Ÿæˆçš„è®¾å¤‡ç®±é€šè¿‡å¼ºåˆ¶ä¸€æ¬¡åªèƒ½å­˜åœ¨ä¸€ä¸ªå¤–å›´ç»“æ„å®ä¾‹æ¥æä¾›å¯¹å¤–å›´è®¾å¤‡çš„å®‰å…¨è®¿é—®ã€‚è¿™ç¡®ä¿äº†å®‰å…¨æ€§ï¼Œä½†ä½¿å¾—ä»ä¸»çº¿ç¨‹å’Œä¸­æ–­å¤„ç†ç¨‹åºè®¿é—®å¤–è®¾å˜å¾—å›°éš¾ã€‚</p>
<p>ä¸ºäº†å®‰å…¨åœ°å…±äº«å¤–å›´è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Mutex</code>æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨<a href="https://doc.rust-lang.org/core/cell/struct.RefCell.html" target="_blank" rel="noopener"><code>RefCell</code></a>ï¼Œå®ƒä½¿ç”¨è¿è¡Œæ—¶æ£€æŸ¥æ¥ç¡®ä¿ä¸€æ¬¡åªç»™å‡ºä¸€ä¸ªå¯¹å¤–å›´è®¾å¤‡çš„å¼•ç”¨ã€‚è¿™æ¯”æ™®é€šçš„æœ‰æ›´å¤šçš„å¼€é”€<code>Cell</code>ï¼Œä½†ç”±äºæˆ‘ä»¬æä¾›å¼•ç”¨è€Œä¸æ˜¯å‰¯æœ¬ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿ä¸€æ¬¡åªå­˜åœ¨ä¸€ä¸ªã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¿˜å¿…é¡»è€ƒè™‘åœ¨ä¸»ä»£ç ä¸­åˆå§‹åŒ–åä»¥æŸç§æ–¹å¼å°†å¤–å›´è®¾å¤‡ç§»åŠ¨åˆ°å…±äº«å˜é‡ä¸­ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Option</code>ç±»å‹ï¼Œåˆå§‹åŒ–<code>None</code>å¹¶ç¨åè®¾ç½®ä¸ºå¤–å›´è®¾å¤‡çš„å®ä¾‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Obtain the peripheral singletons and configure it.</span>
    <span class="token comment" spellcheck="true">// This example is from an svd2rust-generated crate, but</span>
    <span class="token comment" spellcheck="true">// most embedded device crates will be similar.</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> <span class="token operator">&amp;</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it sets PA0 to an input and PA1 to an output.</span>
    <span class="token function">configure_gpio</span><span class="token punctuation">(</span>gpioa<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Store the GPIOA in the mutex, moving it.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We can no longer use `gpioa` or `dp.GPIOA`, and instead have to</span>
    <span class="token comment" spellcheck="true">// access it via the mutex.</span>

    <span class="token comment" spellcheck="true">// Be careful to enable the interrupt only after setting MY_GPIO:</span>
    <span class="token comment" spellcheck="true">// otherwise the interrupt might fire while it still contains None,</span>
    <span class="token comment" spellcheck="true">// and as-written (with `unwrap()`), it would panic.</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We'll now read state as a digital input, via the mutex</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>idr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">idr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Set PA1 high if we've seen a rising edge on PA0.</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This time in the interrupt we'll just clear PA0.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We can use `unwrap()` because we know the interrupt wasn't enabled</span>
        <span class="token comment" spellcheck="true">// until after MY_GPIO was set; otherwise we should handle the potential</span>
        <span class="token comment" spellcheck="true">// for a None value.</span>
        <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦è€ƒè™‘çš„å†…å®¹å¾ˆå¤šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ†è§£é‡è¦çš„å‡ è¡Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬çš„å…±äº«å˜é‡ç°åœ¨æ˜¯ a<code>Mutex</code>å‘¨å›´çš„ a <code>RefCell</code>ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <code>Option</code>ã€‚åœ¨<code>Mutex</code>ç¡®ä¿æˆ‘ä»¬åªæœ‰ä¸€ä¸ªä¸´ç•ŒåŒºä¸­è®¿é—®ï¼Œå¹¶å› æ­¤ä½¿å˜é‡åŒæ­¥ï¼Œå³ä½¿ä¸€ä¸ªæ™®é€šçš„<code>RefCell</code>ä¸ä¼šåŒæ­¥ã€‚è¯¥<code>RefCell</code>ç»™æˆ‘ä»¬å‚è€ƒï¼Œæˆ‘ä»¬å°†éœ€è¦ä½¿ç”¨æˆ‘ä»¬å†…éƒ¨çš„å¯å˜æ€§<code>GPIOA</code>ã€‚è¯¥<code>Option</code>è®©æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªå˜é‡ä¸ºç©ºçš„ä¸œè¥¿ï¼Œåæ¥æ‰çœŸæ­£ç§»åŠ¨çš„å˜é‡ï¼Œæˆ‘ä»¬ä¸èƒ½é™æ€åœ°è®¿é—®å¤–è®¾çš„ç‹¬ç”Ÿå­ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥è¿™æ˜¯å¿…éœ€çš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åœ¨ä¸´ç•ŒåŒºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>borrow()</code>äº’æ–¥é”ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†å¯¹<code>RefCell</code>. ç„¶åæˆ‘ä»¬è°ƒç”¨<code>replace()</code>å°†æˆ‘ä»¬çš„æ–°å€¼ç§»åŠ¨åˆ°<code>RefCell</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬<code>MY_GPIO</code>ä»¥å®‰å…¨å’Œå¹¶å‘çš„æ–¹å¼ä½¿ç”¨ã€‚ä¸´ç•ŒåŒºåƒå¾€å¸¸ä¸€æ ·é˜»æ­¢ä¸­æ–­è§¦å‘ï¼Œå¹¶è®©æˆ‘ä»¬å€Ÿç”¨äº’æ–¥é”ã€‚åœ¨ <code>RefCell</code>éšåç»™äº†æˆ‘ä»¬ä¸€ä¸ª<code>&amp;Option&lt;GPIOA&gt;</code>ï¼Œå¹¶è·Ÿè¸ªå®ƒä¿æŒå¤šä¹…å€Ÿæ¥çš„-ä¸€æ—¦è¿›å…¥å‚è€ƒèŒƒå›´çš„é‚£æ ·ï¼Œ<code>RefCell</code>å°†è¢«æ›´æ–°ï¼Œä»¥è¡¨æ˜å®ƒä¸å†æ˜¯å€Ÿæ¥çš„ã€‚</p>
<p>ç”±äºæˆ‘ä»¬æ— æ³•å°†<code>GPIOA</code>ç§»å‡º<code>&amp;Option</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸º<code>&amp;Option&lt;&amp;GPIOA&gt;</code>with <code>as_ref()</code>ï¼Œæˆ‘ä»¬æœ€ç»ˆ<code>unwrap()</code>å¯ä»¥è·å–<code>&amp;GPIOA</code>å®ƒè®©æˆ‘ä»¬ä¿®æ”¹å¤–å›´è®¾å¤‡ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…±äº«èµ„æºçš„å¯å˜å¼•ç”¨<code>borrow_mut</code>ï¼Œ<code>deref_mut</code> åˆ™åº”ä½¿ç”¨andä»£æ›¿ã€‚ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ä½¿ç”¨ TIM2 å®šæ—¶å™¨çš„ç¤ºä¾‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>DerefMut<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">:</span><span class="token punctuation">:</span>wfi<span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> G_TIM<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>Timer<span class="token operator">&lt;</span>stm32<span class="token punctuation">:</span><span class="token punctuation">:</span>TIM2<span class="token operator">>></span><span class="token operator">>></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cp <span class="token operator">=</span> cm<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of timer configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it configures the TIM2 timer, its NVIC interrupt,</span>
    <span class="token comment" spellcheck="true">// and finally starts the timer.</span>
    <span class="token keyword">let</span> tim <span class="token operator">=</span> <span class="token function">configure_timer_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> cp<span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>tim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">wfi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> tim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>  G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tim<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å“‡ï¼è¿™æ˜¯å®‰å…¨çš„ï¼Œä½†ä¹Ÿæœ‰ç‚¹ç¬¨æ‹™ã€‚æˆ‘ä»¬è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ</p>
<h2 id="ä¿¡æ¯ä¸­å¿ƒ"><a href="#ä¿¡æ¯ä¸­å¿ƒ" class="headerlink" title="ä¿¡æ¯ä¸­å¿ƒ"></a>ä¿¡æ¯ä¸­å¿ƒ</h2><p>ä¸€ç§æ›¿ä»£æ–¹æ¡ˆæ˜¯<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener">RTIC æ¡†æ¶</a>ï¼Œå®ƒæ˜¯å®æ—¶ä¸­æ–­é©±åŠ¨å¹¶å‘çš„ç¼©å†™ã€‚å®ƒå¼ºåˆ¶æ‰§è¡Œé™æ€ä¼˜å…ˆçº§å¹¶è·Ÿè¸ªå¯¹<code>static mut</code>å˜é‡ï¼ˆâ€œèµ„æºâ€ï¼‰çš„è®¿é—®ï¼Œä»¥é™æ€åœ°ç¡®ä¿å§‹ç»ˆå®‰å…¨åœ°è®¿é—®å…±äº«èµ„æºï¼Œè€Œæ— éœ€æ€»æ˜¯è¿›å…¥ä¸´ç•ŒåŒºå’Œä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼ˆå¦‚ ä¸­æ‰€ç¤º<code>RefCell</code>ï¼‰çš„å¼€é”€ã€‚è¿™æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œä¾‹å¦‚ä¿è¯æ²¡æœ‰æ­»é”å¹¶æä¾›æä½çš„æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚</p>
<p>è¯¥æ¡†æ¶è¿˜åŒ…æ‹¬å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æ¶ˆæ¯ä¼ é€’ï¼Œè¿™å‡å°‘äº†å¯¹æ˜¾å¼å…±äº«çŠ¶æ€çš„éœ€æ±‚ï¼Œä»¥åŠå®‰æ’ä»»åŠ¡åœ¨ç»™å®šæ—¶é—´è¿è¡Œçš„èƒ½åŠ›ï¼Œå¯ç”¨äºå®ç°å‘¨æœŸæ€§ä»»åŠ¡ã€‚æŸ¥çœ‹<a href="https://rtic.rs/" target="_blank" rel="noopener">æ–‡æ¡£</a>ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼</p>
<h2 id="å®æ—¶æ“ä½œç³»ç»Ÿ"><a href="#å®æ—¶æ“ä½œç³»ç»Ÿ" class="headerlink" title="å®æ—¶æ“ä½œç³»ç»Ÿ"></a>å®æ—¶æ“ä½œç³»ç»Ÿ</h2><p>åµŒå…¥å¼å¹¶å‘çš„å¦ä¸€ä¸ªå¸¸è§æ¨¡å‹æ˜¯å®æ—¶æ“ä½œç³»ç»Ÿ (RTOS)ã€‚è™½ç„¶ç›®å‰åœ¨ Rust ä¸­çš„æ¢ç´¢è¾ƒå°‘ï¼Œä½†å®ƒä»¬å¹¿æ³›ç”¨äºä¼ ç»Ÿçš„åµŒå…¥å¼å¼€å‘ã€‚å¼€æºç¤ºä¾‹åŒ…æ‹¬<a href="https://freertos.org/" target="_blank" rel="noopener">FreeRTOS</a>å’Œ <a href="http://chibios.org/" target="_blank" rel="noopener">ChibiOS</a>ã€‚è¿™äº› RTOS æ”¯æŒè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹ï¼ŒCPU åœ¨è¿™äº›çº¿ç¨‹ä¹‹é—´è¿›è¡Œäº¤æ¢ï¼Œå½“çº¿ç¨‹è®©å‡ºæ§åˆ¶æƒï¼ˆç§°ä¸ºåä½œå¤šä»»åŠ¡å¤„ç†ï¼‰æˆ–åŸºäºå¸¸è§„è®¡æ—¶å™¨æˆ–ä¸­æ–­ï¼ˆæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼‰æ—¶ã€‚RTOS é€šå¸¸æä¾›äº’æ–¥é”å’Œå…¶ä»–åŒæ­¥åŸè¯­ï¼Œå¹¶ä¸”ç»å¸¸ä¸ç¡¬ä»¶åŠŸèƒ½ï¼ˆä¾‹å¦‚ DMA å¼•æ“ï¼‰è¿›è¡Œäº’æ“ä½œã€‚</p>
<p>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¯ä»¥æŒ‡å‡ºçš„ Rust RTOS ç¤ºä¾‹å¹¶ä¸å¤šï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é¢†åŸŸï¼Œå› æ­¤è¯·å…³æ³¨æ­¤ç©ºé—´ï¼</p>
<h2 id="å¤šæ ¸"><a href="#å¤šæ ¸" class="headerlink" title="å¤šæ ¸"></a>å¤šæ ¸</h2><p>åœ¨åµŒå…¥å¼å¤„ç†å™¨ä¸­æ‹¥æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šå†…æ ¸å˜å¾—è¶Šæ¥è¶Šæ™®éï¼Œè¿™ä¸ºå¹¶å‘æ€§å¢åŠ äº†ä¸€å±‚é¢å¤–çš„å¤æ‚æ€§ã€‚æ‰€æœ‰ä½¿ç”¨ä¸´ç•ŒåŒºï¼ˆåŒ…æ‹¬<code>cortex_m::interrupt::Mutex</code>ï¼‰çš„ç¤ºä¾‹éƒ½å‡è®¾å”¯ä¸€çš„å…¶ä»–æ‰§è¡Œçº¿ç¨‹æ˜¯ä¸­æ–­çº¿ç¨‹ï¼Œä½†åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šä¸å†å¦‚æ­¤ã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå¤šæ ¸è®¾è®¡çš„åŒæ­¥åŸè¯­ï¼ˆä¹Ÿç§°ä¸º SMPï¼Œç”¨äºå¯¹ç§°å¤šå¤„ç†ï¼‰ã€‚</p>
<p>è¿™äº›é€šå¸¸ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„åŸå­æŒ‡ä»¤ï¼Œå› ä¸ºå¤„ç†ç³»ç»Ÿå°†ç¡®ä¿åœ¨æ‰€æœ‰å†…æ ¸ä¸Šä¿æŒåŸå­æ€§ã€‚</p>
<p>è¯¦ç»†ä»‹ç»è¿™äº›ä¸»é¢˜ç›®å‰è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ï¼Œä½†ä¸€èˆ¬æ¨¡å¼ä¸å•æ ¸æƒ…å†µç›¸åŒã€‚</p>
<h1 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h1><p>æœ€ç»ˆï¼Œæ‚¨å°†å¸Œæœ›åœ¨ç¨‹åºä¸­ä½¿ç”¨åŠ¨æ€æ•°æ®ç»“æ„ï¼ˆAKA é›†åˆï¼‰ã€‚<code>std</code>æä¾›äº†ä¸€ç»„å…¬å…±é›†åˆï¼š<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html" target="_blank" rel="noopener"><code>Vec</code></a>ã€<a href="https://doc.rust-lang.org/std/string/struct.String.html" target="_blank" rel="noopener"><code>String</code></a>ã€ <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener"><code>HashMap</code></a>ç­‰ã€‚æ‰€æœ‰å®ç°çš„é›†åˆéƒ½<code>std</code>ä½¿ç”¨å…¨å±€åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼ˆä¹Ÿç§°ä¸ºå †ï¼‰ã€‚</p>
<p>æŒ‰ç…§<code>core</code>å®šä¹‰ï¼Œè¿™äº›å®ç°åœ¨æ²¡æœ‰å†…å­˜åˆ†é…çš„æƒ…å†µä¸‹ä¸å¯ç”¨ï¼Œä½†å¯ä»¥<code>alloc</code>åœ¨ç¼–è¯‘å™¨é™„å¸¦çš„crate ä¸­æ‰¾åˆ°ã€‚</p>
<p>å¦‚æœæ‚¨éœ€è¦é›†åˆï¼Œå †åˆ†é…å®ç°ä¸æ˜¯æ‚¨å”¯ä¸€çš„é€‰æ‹©ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<em>å›ºå®šå®¹é‡</em>é›†åˆï¼›åœ¨<a href="https://crates.io/crates/heapless" target="_blank" rel="noopener"><code>heapless</code></a>crate ä¸­å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„å®ç°ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å’Œæ¯”è¾ƒè¿™ä¸¤ç§å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨-alloc"><a href="#ä½¿ç”¨-alloc" class="headerlink" title="ä½¿ç”¨ alloc"></a>ä½¿ç”¨ <code>alloc</code></h2><p>è¯¥<code>alloc</code>ç®±å‡ºå‚æ—¶çš„æ ‡å‡†é”ˆç—…åˆ†å¸ƒã€‚è¦å¯¼å…¥ crateï¼Œæ‚¨å¯ä»¥ç›´æ¥å°†<code>use</code>å…¶å¯¼å…¥ï¼Œ<em>è€Œæ— éœ€</em>åœ¨<code>Cargo.toml</code>æ–‡ä»¶ä¸­å°†å…¶å£°æ˜ä¸ºä¾èµ–é¡¹ ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc)]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> alloc<span class="token punctuation">;</span>

<span class="token keyword">use</span> alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>vec<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ä»»ä½•é›†åˆï¼Œæ‚¨é¦–å…ˆéœ€è¦ä½¿ç”¨è¯¥<code>global_allocator</code> å±æ€§æ¥å£°æ˜æ‚¨çš„ç¨‹åºå°†ä½¿ç”¨çš„å…¨å±€åˆ†é…å™¨ã€‚æ‚¨é€‰æ‹©çš„åˆ†é…å™¨éœ€è¦å®ç°è¯¥<a href="https://doc.rust-lang.org/core/alloc/trait.GlobalAlloc.html" target="_blank" rel="noopener"><code>GlobalAlloc</code></a>ç‰¹å¾ã€‚</p>
<p>ä¸ºå®Œæ•´èµ·è§å¹¶ä¿æŒæœ¬èŠ‚å°½å¯èƒ½ç‹¬ç«‹ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„å‡¹å‡¸æŒ‡é’ˆåˆ†é…å™¨å¹¶å°†å…¶ç”¨ä½œå…¨å±€åˆ†é…å™¨ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬<em>å¼ºçƒˆ</em>å»ºè®®æ‚¨åœ¨ç¨‹åºä¸­ä½¿ç”¨ crates.io ä¸­ç»è¿‡å®æˆ˜æµ‹è¯•çš„åˆ†é…å™¨ï¼Œè€Œä¸æ˜¯è¿™ä¸ªåˆ†é…å™¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Bump pointer allocator implementation</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalAlloc<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Bump pointer allocator for *single* core systems</span>
<span class="token keyword">struct</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token operator">&lt;</span>usize<span class="token operator">></span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> usize<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> GlobalAlloc <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">mut</span> u8 <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// `interrupt::free` is a critical section that makes our allocator safe</span>
        <span class="token comment" spellcheck="true">// to use from within interrupts</span>
        interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> head <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> size <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align_mask <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// move start up to the next alignment boundary</span>
            <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>head <span class="token operator">+</span> align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> align_mask<span class="token punctuation">;</span>

            <span class="token keyword">if</span> start <span class="token operator">+</span> size <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>end <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// a null pointer signal an Out Of Memory condition</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">null_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>head <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
                start <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">dealloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8<span class="token punctuation">,</span> _<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this allocator never deallocates memory</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Declaration of the global memory allocator</span>
<span class="token comment" spellcheck="true">// NOTE the user must ensure that the memory region `[0x2000_0100, 0x2000_0200]`</span>
<span class="token comment" spellcheck="true">// is not used by other parts of the program</span>
<span class="token attribute attr-name">#[global_allocator]</span>
<span class="token keyword">static</span> HEAP<span class="token punctuation">:</span> BumpPointerAlloc <span class="token operator">=</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x2000_0100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> <span class="token number">0x2000_0200</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™¤äº†é€‰æ‹©å…¨å±€åˆ†é…å™¨ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¿…é¡»å®šä¹‰å¦‚ä½•ä½¿ç”¨<em>ä¸ç¨³å®š</em> <code>alloc_error_handler</code>å±æ€§å¤„ç†å†…å­˜ä¸è¶³ (OOM) é”™è¯¯ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc_error_handler)]</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[alloc_error_handler]</span>
<span class="token keyword">fn</span> <span class="token function">on_oom</span><span class="token punctuation">(</span>_layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    asm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸€åˆ‡å°±ç»ªåï¼Œç”¨æˆ·æœ€ç»ˆå¯ä»¥ä½¿ç”¨<code>alloc</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ‚¨ä½¿ç”¨è¿‡<code>std</code>crate ä¸­çš„é›†åˆï¼Œé‚£ä¹ˆè¿™äº›å°†å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å®Œå…¨ç›¸åŒçš„å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨-heapless"><a href="#ä½¿ç”¨-heapless" class="headerlink" title="ä½¿ç”¨ heapless"></a>ä½¿ç”¨ <code>heapless</code></h2><p><code>heapless</code>ä¸éœ€è¦è®¾ç½®ï¼Œå› ä¸ºå®ƒçš„é›†åˆä¸ä¾èµ–äºå…¨å±€å†…å­˜åˆ†é…å™¨ã€‚åªæ˜¯<code>use</code>å®ƒçš„é›†åˆå¹¶ç»§ç»­å®ä¾‹åŒ–å®ƒä»¬ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> heapless<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// v0.4.x</span>

<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token punctuation">,</span> U8<span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ä¼šæ³¨æ„åˆ°è¿™äº›é›†åˆä¸<code>alloc</code>.</p>
<p>é¦–å…ˆï¼Œæ‚¨å¿…é¡»é¢„å…ˆå£°æ˜é›†åˆçš„å®¹é‡ã€‚<code>heapless</code> é›†åˆæ°¸è¿œä¸ä¼šé‡æ–°åˆ†é…å¹¶å…·æœ‰å›ºå®šå®¹é‡ï¼›æ­¤å®¹é‡æ˜¯é›†åˆç±»å‹ç­¾åçš„ä¸€éƒ¨åˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»å£°æ˜äº†<code>xs</code> å…·æœ‰ 8 ä¸ªå…ƒç´ çš„å®¹é‡ï¼Œå³å‘é‡æœ€å¤šå¯ä»¥å®¹çº³ 8 ä¸ªå…ƒç´ ã€‚è¿™ç”±ç±»å‹ç­¾åä¸­çš„<code>U8</code>ï¼ˆè¯·å‚é˜…<a href="https://crates.io/crates/typenum" target="_blank" rel="noopener"><code>typenum</code></a>ï¼‰æŒ‡ç¤ºã€‚</p>
<p>å…¶æ¬¡ï¼Œè¯¥<code>push</code>æ–¹æ³•å’Œè®¸å¤šå…¶ä»–æ–¹æ³•éƒ½è¿”å›ä¸€ä¸ª<code>Result</code>. ç”±äº <code>heapless</code>é›†åˆå…·æœ‰å›ºå®šå®¹é‡ï¼Œå› æ­¤æ‰€æœ‰å°†å…ƒç´ æ’å…¥åˆ°é›†åˆä¸­çš„æ“ä½œéƒ½å¯èƒ½å¤±è´¥ã€‚API é€šè¿‡è¿”å›ä¸€ä¸ª<code>Result</code>æŒ‡ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸæ¥åæ˜ æ­¤é—®é¢˜ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>alloc</code>é›†åˆå°†åœ¨å †ä¸Šé‡æ–°åˆ†é…è‡ªå·±ä»¥å¢åŠ å…¶å®¹é‡ã€‚</p>
<p>ä» v0.4.x ç‰ˆæœ¬å¼€å§‹ï¼Œæ‰€æœ‰<code>heapless</code>é›†åˆéƒ½å†…è”å­˜å‚¨å…¶æ‰€æœ‰å…ƒç´ ã€‚è¿™æ„å‘³ç€åƒè¿™æ ·çš„æ“ä½œ<code>let x = heapless::Vec::new();</code>å°†åœ¨å †æ ˆä¸Šåˆ†é…é›†åˆï¼Œä½†ä¹Ÿå¯ä»¥åœ¨<code>static</code>å˜é‡ä¸Šåˆ†é…é›†åˆï¼Œç”šè‡³åœ¨å † ( <code>Box&lt;Vec&lt;_, _&gt;&gt;</code>) ä¸Šã€‚</p>
<h2 id="æƒè¡¡"><a href="#æƒè¡¡" class="headerlink" title="æƒè¡¡"></a>æƒè¡¡</h2><p>åœ¨å †åˆ†é…ã€å¯é‡å®šä½é›†åˆå’Œå›ºå®šå®¹é‡é›†åˆä¹‹é—´è¿›è¡Œé€‰æ‹©æ—¶ï¼Œè¯·è®°ä½è¿™äº›ã€‚</p>
<h3 id="å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†"><a href="#å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†" class="headerlink" title="å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†"></a>å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†</h3><p>å¯¹äºå †åˆ†é…ï¼Œå†…å­˜ä¸è¶³æ€»æ˜¯å¯èƒ½çš„ï¼Œå¹¶ä¸”å¯èƒ½å‘ç”Ÿåœ¨é›†åˆå¯èƒ½éœ€è¦å¢é•¿çš„ä»»ä½•åœ°æ–¹ï¼šä¾‹å¦‚ï¼Œæ‰€æœ‰ <code>alloc::Vec.push</code>è°ƒç”¨éƒ½å¯èƒ½äº§ç”Ÿ OOM æ¡ä»¶ã€‚å› æ­¤ï¼ŒæŸäº›æ“ä½œå¯èƒ½ä¼š<em>éšå¼</em>å¤±è´¥ã€‚ä¸€äº›<code>alloc</code>é›†åˆå…¬å¼€äº† ä¸€äº›<code>try_reserve</code>æ–¹æ³•ï¼Œå¯ä»¥è®©æ‚¨åœ¨å¢åŠ é›†åˆæ—¶æ£€æŸ¥æ½œåœ¨çš„ OOM æ¡ä»¶ï¼Œä½†æ‚¨éœ€è¦ä¸»åŠ¨ä½¿ç”¨å®ƒä»¬ã€‚</p>
<p>å¦‚æœæ‚¨åªä½¿ç”¨<code>heapless</code>é›†åˆå¹¶ä¸”ä¸å°†å†…å­˜åˆ†é…å™¨ç”¨äºå…¶ä»–ä»»ä½•äº‹æƒ…ï¼Œé‚£ä¹ˆ OOM æ¡ä»¶æ˜¯ä¸å¯èƒ½çš„ã€‚ç›¸åï¼Œæ‚¨å¿…é¡»æ ¹æ®å…·ä½“æƒ…å†µå¤„ç†å®¹é‡ä¸è¶³çš„é›†åˆã€‚è¿™å°±æ˜¯ä½ å¿…é¡»å¤„ç†<em>æ‰€æœ‰</em>çš„<code>Result</code>é€šè¿‡ç±»ä¼¼æ–¹æ³•è¿”å›å°å· <code>Vec.push</code>ã€‚</p>
<p>OOM æ•…éšœå¯èƒ½æ¯”<code>unwrap</code>å¯¹æ‰€æœ‰<code>Result</code>è¿”å›çš„ sè¯´-ingæ›´éš¾è°ƒè¯•ï¼Œ<code>heapless::Vec.push</code>å› ä¸ºè§‚å¯Ÿåˆ°çš„æ•…éšœä½ç½®å¯èƒ½ ä¸é—®é¢˜åŸå› çš„ä½ç½®<em>ä¸</em>åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œ<code>vec.reserve(1)</code>å¦‚æœåˆ†é…å™¨å‡ ä¹è€—å°½ï¼Œå› ä¸ºå…¶ä»–ä¸€äº›é›†åˆæ­£åœ¨æ³„æ¼å†…å­˜ï¼ˆåœ¨å®‰å…¨ Rust ä¸­å¯èƒ½å‘ç”Ÿå†…å­˜æ³„æ¼ï¼‰ï¼Œç”šè‡³ å¯ä»¥è§¦å‘ OOMã€‚</p>
<h3 id="å†…å­˜ä½¿ç”¨æƒ…å†µ"><a href="#å†…å­˜ä½¿ç”¨æƒ…å†µ" class="headerlink" title="å†…å­˜ä½¿ç”¨æƒ…å†µ"></a>å†…å­˜ä½¿ç”¨æƒ…å†µ</h3><p>å¯¹å †åˆ†é…é›†åˆçš„å†…å­˜ä½¿ç”¨æƒ…å†µè¿›è¡Œæ¨ç†æ˜¯å¾ˆå›°éš¾çš„ï¼Œå› ä¸ºé•¿å¯¿å‘½é›†åˆçš„å®¹é‡å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶å‘ç”Ÿå˜åŒ–ã€‚æŸäº›æ“ä½œå¯èƒ½ä¼šéšå¼åœ°é‡æ–°åˆ†é…é›†åˆä»¥å¢åŠ å…¶å†…å­˜ä½¿ç”¨é‡ï¼Œè€ŒæŸäº›é›†åˆå…¬å¼€çš„æ–¹æ³•<code>shrink_to_fit</code>å¯èƒ½ä¼šå‡å°‘é›†åˆä½¿ç”¨çš„å†…å­˜â€”â€”æœ€ç»ˆï¼Œç”±åˆ†é…å™¨å†³å®šæ˜¯å¦å®é™…ç¼©å°å†…å­˜åˆ†é…ã€‚æ­¤å¤–ï¼Œåˆ†é…å™¨å¯èƒ½å¿…é¡»å¤„ç†å†…å­˜ç¢ç‰‡ï¼Œè¿™ä¼šå¢åŠ  <em>æ˜æ˜¾çš„</em>å†…å­˜ä½¿ç”¨é‡ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‚¨ä¸“é—¨ä½¿ç”¨å›ºå®šå®¹é‡é›†åˆï¼Œå°†å®ƒä»¬ä¸­çš„å¤§éƒ¨åˆ†å­˜å‚¨åœ¨<code>static</code>å˜é‡ä¸­å¹¶ä¸ºè°ƒç”¨å †æ ˆè®¾ç½®æœ€å¤§å¤§å°ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°†æ£€æµ‹æ‚¨æ˜¯å¦å°è¯•ä½¿ç”¨æ¯”ç‰©ç†å¯ç”¨å†…å­˜æ›´å¤šçš„å†…å­˜ã€‚</p>
<p>æ­¤å¤–ï¼Œå †æ ˆä¸Šåˆ†é…çš„å›ºå®šå®¹é‡é›†åˆå°†é€šè¿‡<a href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/emit-stack-sizes.html" target="_blank" rel="noopener"><code>-Z emit-stack-sizes</code></a>æ ‡å¿—æŠ¥å‘Šï¼Œè¿™æ„å‘³ç€åˆ†æå †æ ˆä½¿ç”¨æƒ…å†µçš„å·¥å…·ï¼ˆå¦‚<a href="https://crates.io/crates/stack-sizes" target="_blank" rel="noopener"><code>stack-sizes</code></a>ï¼‰å°†åœ¨å…¶åˆ†æä¸­åŒ…æ‹¬å®ƒä»¬ã€‚</p>
<p>ä½†æ˜¯ï¼Œå›ºå®šå®¹é‡é›†åˆ<em>æ— æ³•</em>æ”¶ç¼©ï¼Œè¿™ä¼šå¯¼è‡´è´Ÿè½½å› å­ï¼ˆé›†åˆå¤§å°ä¸å…¶å®¹é‡ä¹‹é—´çš„æ¯”ç‡ï¼‰ä½äºå¯é‡å®šä½é›†åˆæ‰€èƒ½è¾¾åˆ°çš„è´Ÿè½½å› å­ã€‚</p>
<h3 id="æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´-WCET"><a href="#æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´-WCET" class="headerlink" title="æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ (WCET)"></a>æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ (WCET)</h3><p>å¦‚æœæ‚¨æ­£åœ¨æ„å»ºå¯¹æ—¶é—´æ•æ„Ÿçš„åº”ç”¨ç¨‹åºæˆ–ç¡¬å®æ—¶åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½éå¸¸å…³å¿ƒç¨‹åºä¸åŒéƒ¨åˆ†çš„æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ã€‚</p>
<p>è¯¥<code>alloc</code>é›†åˆå¯ä»¥é‡æ–°åˆ†é…ï¼Œè¿™æ ·å¯ä»¥å¢åŠ é›†åˆè¿˜å°†åŒ…æ‹¬å®ƒéœ€è¦é‡æ–°åˆ†é…çš„é›†åˆï¼Œå®ƒæœ¬èº«ä¾èµ–äºæ—¶é—´çš„æ“ä½œçš„WCET<em>è¿è¡Œæ—¶</em>æ”¶é›†çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—å¾ˆéš¾ç¡®å®šä¾‹å¦‚<code>alloc::Vec.push</code>æ“ä½œçš„ WCETï¼Œå› ä¸ºå®ƒå–å†³äºæ­£åœ¨ä½¿ç”¨çš„åˆ†é…å™¨åŠå…¶è¿è¡Œæ—¶å®¹é‡ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå›ºå®šå®¹é‡é›†åˆæ°¸è¿œä¸ä¼šé‡æ–°åˆ†é…ï¼Œå› æ­¤æ‰€æœ‰æ“ä½œéƒ½æœ‰å¯é¢„æµ‹çš„æ‰§è¡Œæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ<code>heapless::Vec.push</code>åœ¨æ’å®šæ—¶é—´å†…æ‰§è¡Œã€‚</p>
<h3 id="ä¾¿äºä½¿ç”¨"><a href="#ä¾¿äºä½¿ç”¨" class="headerlink" title="ä¾¿äºä½¿ç”¨"></a>ä¾¿äºä½¿ç”¨</h3><p><code>alloc</code>éœ€è¦è®¾ç½®å…¨å±€åˆ†é…å™¨ï¼Œ<code>heapless</code>è€Œä¸éœ€è¦ã€‚ä½†æ˜¯ï¼Œ<code>heapless</code>éœ€è¦æ‚¨é€‰æ‹©å®ä¾‹åŒ–çš„æ¯ä¸ªé›†åˆçš„å®¹é‡ã€‚</p>
<p><code>alloc</code>å‡ ä¹æ¯ä¸ª Rust å¼€å‘äººå‘˜éƒ½ä¼šç†Ÿæ‚‰è¯¥APIã€‚è¯¥ <code>heapless</code>APIå°è¯•å¯†åˆ‡æ¨¡ä»¿çš„<code>alloc</code>APIï¼Œä½†å®ƒæ°¸è¿œä¸ä¼šæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒæ˜ç¡®çš„é”™è¯¯å¤„ç†-ä¸€äº›å¼€å‘äººå‘˜å¯èƒ½ä¼šè§‰å¾—æ˜ç¡®é”™è¯¯å¤„ç†è¿‡åº¦æˆ–å¤ªéº»çƒ¦äº†ã€‚</p>
<h1 id="Design-Patterns"><a href="#Design-Patterns" class="headerlink" title="Design Patterns"></a>Design Patterns</h1><p>HAL Design Patternsï¼š</p>
<p>è¿™æ˜¯ä¸€ç»„å¸¸ç”¨å’Œæ¨èçš„æ¨¡å¼ï¼Œç”¨äºåœ¨ Rust ä¸­ä¸ºå¾®æ§åˆ¶å™¨ç¼–å†™ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)ã€‚åœ¨ä¸ºå¾®æ§åˆ¶å™¨ç¼–å†™ HAL æ—¶ï¼Œé™¤äº†ç°æœ‰çš„<a href="https://rust-lang.github.io/api-guidelines/" target="_blank" rel="noopener">Rust API æŒ‡å—</a>ä¹‹å¤–ï¼Œè¿˜æ‰“ç®—ä½¿ç”¨è¿™äº›æ¨¡å¼ã€‚</p>
<h2 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h2><ul>
<li><p>å‘½å</p>
<p>ï¼ˆcrate ä¸ Rust å‘½åçº¦å®šä¸€è‡´ï¼‰</p>
<ul>
<li>ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/naming.html#c-crate-name" target="_blank" rel="noopener">C-CRATE-NAME</a>ï¼‰</li>
</ul>
</li>
<li><p>äº’æ“ä½œæ€§</p>
<p>ï¼ˆæ¿æ¡ç®±ä¸å…¶ä»–åº“åŠŸèƒ½å¾ˆå¥½åœ°äº¤äº’ï¼‰</p>
<ul>
<li>åŒ…è£…å™¨ç±»å‹æä¾›ææ„å‡½æ•°æ–¹æ³• ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-free" target="_blank" rel="noopener">C-FREE</a> )</li>
<li>HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-reexport-pac" target="_blank" rel="noopener">C-REEXPORT-PAC</a> )</li>
<li>ç±»å‹å®ç°<code>embedded-hal</code>ç‰¹å¾ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-hal-traits" target="_blank" rel="noopener">C-HAL-TRAITS</a>ï¼‰</li>
</ul>
</li>
<li><p>å¯é¢„æµ‹æ€§</p>
<p>ï¼ˆæ¿æ¡ç®±å¯ç”¨æ¸…æ™°çš„ä»£ç ï¼Œä½¿å…¶çœ‹èµ·æ¥å¦‚ä½•ï¼‰</p>
<ul>
<li>ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/predictability.html#c-ctor" target="_blank" rel="noopener">C-CTOR</a>ï¼‰</li>
</ul>
</li>
<li><p>GPIO æ¥å£</p>
<p>ï¼ˆGPIO æ¥å£éµå¾ªé€šç”¨æ¨¡å¼ï¼‰</p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-zst-pin" target="_blank" rel="noopener">C-ZST-PIN</a> )</li>
<li>å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-erased-pin" target="_blank" rel="noopener">C-ERASED-PIN</a>ï¼‰</li>
<li>å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-pin-state" target="_blank" rel="noopener">C-PIN-STATE</a>ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h2><h3 id="ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰"><a href="#ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰" class="headerlink" title="ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰"></a>ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰</h3><p>HAL crate åº”ä»¥å…¶æ—¨åœ¨æ”¯æŒçš„èŠ¯ç‰‡æˆ–èŠ¯ç‰‡ç³»åˆ—å‘½åã€‚å®ƒä»¬çš„åç§°åº”ä»¥ ç»“å°¾ï¼Œ<code>-hal</code>ä»¥å°†å®ƒä»¬ä¸ register access crate åŒºåˆ†å¼€æ¥ã€‚åç§°ä¸åº”åŒ…å«ä¸‹åˆ’çº¿ï¼ˆæ”¹ç”¨ç ´æŠ˜å·ï¼‰ã€‚</p>
<h2 id="Interoperability"><a href="#Interoperability" class="headerlink" title="Interoperability"></a>Interoperability</h2><h3 id="åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰"><a href="#åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰" class="headerlink" title="åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰"></a>åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰</h3><p><code>Copy</code>HAL æä¾›çš„ä»»ä½•éåŒ…è£…å™¨ç±»å‹éƒ½åº”è¯¥æä¾›ä¸€ä¸ª<code>free</code>æ–¹æ³•æ¥ä½¿ç”¨åŒ…è£…å™¨å¹¶è¿”å›åˆ›å»ºå®ƒçš„åŸå§‹å¤–å›´è®¾å¤‡ï¼ˆå¯èƒ½è¿˜æœ‰å…¶ä»–å¯¹è±¡ï¼‰ã€‚</p>
<p>å¦‚æœ‰å¿…è¦ï¼Œè¯¥æ–¹æ³•åº”å…³é—­å¹¶é‡ç½®å¤–è®¾ã€‚<code>new</code> ä½¿ç”¨ è¿”å›çš„åŸå§‹å¤–è®¾è°ƒç”¨<code>free</code>ä¸åº”ç”±äºå¤–è®¾çš„æ„å¤–çŠ¶æ€è€Œå¤±è´¥ã€‚</p>
<p>å¦‚æœ HAL ç±»å‹éœ€è¦<code>Copy</code>æ„é€ å…¶ä»–éå¯¹è±¡ï¼ˆä¾‹å¦‚ I/O å¼•è„šï¼‰ï¼Œåˆ™ä»»ä½•æ­¤ç±»å¯¹è±¡ä¹Ÿåº”è¢«é‡Šæ”¾å¹¶è¿”å›<code>free</code>ã€‚ <code>free</code>åœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥è¿”å›ä¸€ä¸ªå…ƒç»„ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token function">Timer</span><span class="token punctuation">(</span>TIMER0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Timer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>periph<span class="token punctuation">:</span> TIMER0<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        <span class="token function">Self</span><span class="token punctuation">(</span>periph<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> TIMER0 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="HAL-é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®±-C-REEXPORT-PAC"><a href="#HAL-é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®±-C-REEXPORT-PAC" class="headerlink" title="HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± (C-REEXPORT-PAC)"></a>HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± (C-REEXPORT-PAC)</h3><p>HAL å¯ä»¥å†™åœ¨<a href="https://github.com/rust-embedded/svd2rust" target="_blank" rel="noopener">svd2rust</a>ç”Ÿæˆçš„ PAC ä¹‹ä¸Šï¼Œæˆ–è€…å†™åœ¨æä¾›åŸå§‹å¯„å­˜å™¨è®¿é—®çš„å…¶ä»– crate ä¹‹ä¸Šã€‚HAL åº”å§‹ç»ˆåœ¨å…¶ crate æ ¹ä¸­é‡æ–°å¯¼å‡ºå®ƒä»¬æ‰€åŸºäºçš„ register access crateã€‚</p>
<p>PAC åº”è¯¥ä»¥ name é‡æ–°å¯¼å‡º<code>pac</code>ï¼Œè€Œä¸ç®¡ crate çš„å®é™…åç§°æ˜¯ä»€ä¹ˆï¼Œå› ä¸º HAL çš„åç§°åº”è¯¥å·²ç»æ¸…æ¥šåœ°è¡¨æ˜æ­£åœ¨è®¿é—®ä»€ä¹ˆ PACã€‚</p>
<h3 id="ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰"><a href="#ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰" class="headerlink" title="ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰"></a>ç±»å‹å®ç°<code>embedded-hal</code>ç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰</h3><p>HAL æä¾›çš„ç±»å‹åº”å®ç°<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>crateæä¾›çš„æ‰€æœ‰é€‚ç”¨ç‰¹å¾ ã€‚</p>
<p>å¯ä»¥ä¸ºåŒä¸€ç±»å‹å®ç°å¤šä¸ªç‰¹å¾ã€‚</p>
<h2 id="Predictability"><a href="#Predictability" class="headerlink" title="Predictability"></a>Predictability</h2><h3 id="ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰"><a href="#ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰" class="headerlink" title="ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰"></a>ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰</h3><p>HAL å‘å…¶æ·»åŠ åŠŸèƒ½çš„æ‰€æœ‰å¤–å›´è®¾å¤‡éƒ½åº”åŒ…å«åœ¨æ–°ç±»å‹ä¸­ï¼Œå³ä½¿è¯¥åŠŸèƒ½ä¸éœ€è¦å…¶ä»–å­—æ®µã€‚</p>
<p>åº”é¿å…ä¸ºåŸå§‹å¤–è®¾å®ç°çš„æ‰©å±•ç‰¹æ€§ã€‚</p>
<h3 id="æ–¹æ³•-inline-åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰"><a href="#æ–¹æ³•-inline-åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰" class="headerlink" title="æ–¹æ³•#[inline\]åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰"></a>æ–¹æ³•<code>#[inline\]</code>åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust ç¼–è¯‘å™¨ä¸ä¼šè·¨ crate è¾¹ç•Œæ‰§è¡Œå®Œå…¨å†…è”ã€‚ç”±äºåµŒå…¥å¼åº”ç”¨ç¨‹åºå¯¹æ„å¤–çš„ä»£ç å¤§å°å¢åŠ å¾ˆæ•æ„Ÿï¼Œ<code>#[inline]</code>åº”ä½¿ç”¨å¦‚ä¸‹æŒ‡å¯¼ç¼–è¯‘å™¨ï¼š</p>
<ul>
<li>æ‰€æœ‰â€œå°â€åŠŸèƒ½éƒ½åº”è¯¥è¢«æ ‡è®°<code>#[inline]</code>ã€‚ä»€ä¹ˆæ˜¯â€œå°â€æ˜¯ä¸»è§‚çš„ï¼Œä½†é€šå¸¸æ‰€æœ‰é¢„æœŸç¼–è¯‘ä¸ºä¸€ä½æ•°æŒ‡ä»¤åºåˆ—çš„å‡½æ•°éƒ½è¢«è®¤ä¸ºæ˜¯å°ã€‚</li>
<li>å¾ˆå¯èƒ½é‡‡ç”¨å¸¸é‡å€¼ä½œä¸ºå‚æ•°çš„å‡½æ•°åº”æ ‡è®°ä¸º<code>#[inline]</code>. è¿™ä½¿å¾—ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶è®¡ç®—ç”šè‡³å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘ï¼Œå‰ææ˜¯å‡½æ•°è¾“å…¥æ˜¯å·²çŸ¥çš„ã€‚</li>
</ul>
<h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><h3 id="é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å°-C-ZST-PIN"><a href="#é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å°-C-ZST-PIN" class="headerlink" title="é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° (C-ZST-PIN)"></a>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° (C-ZST-PIN)</h3><p>HAL å…¬å¼€çš„ GPIO æ¥å£åº”ä¸ºæ¯ä¸ªæ¥å£æˆ–ç«¯å£ä¸Šçš„æ¯ä¸ªå¼•è„šæä¾›ä¸“ç”¨çš„é›¶å¤§å°ç±»å‹ï¼Œä»è€Œåœ¨æ‰€æœ‰å¼•è„šåˆ†é…éƒ½æ˜¯é™æ€å·²çŸ¥çš„æƒ…å†µä¸‹å®ç°é›¶æˆæœ¬çš„ GPIO æŠ½è±¡ã€‚</p>
<p>æ¯ä¸ª GPIO æ¥å£æˆ–ç«¯å£éƒ½åº”è¯¥å®ç°ä¸€ä¸ª<code>split</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå¸¦æœ‰æ¯ä¸ªå¼•è„šçš„ç»“æ„ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortA<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PortA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PortAPins <span class="token punctuation">{</span>
        PortAPins <span class="token punctuation">{</span>
            pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
            pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortAPins <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•-C-ERASED-PIN"><a href="#å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•-C-ERASED-PIN" class="headerlink" title="å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³• (C-ERASED-PIN)"></a>å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³• (C-ERASED-PIN)</h3><p>Pin åº”è¯¥æä¾›ç±»å‹æ“¦é™¤æ–¹æ³•ï¼Œå°†å®ƒä»¬çš„å±æ€§ä»ç¼–è¯‘æ—¶ç§»åŠ¨åˆ°è¿è¡Œæ—¶ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºä¸­æä¾›æ›´å¤§çš„çµæ´»æ€§ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// Port A, pin 0.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PA0 <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_pin</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PA <span class="token punctuation">{</span>
        PA <span class="token punctuation">{</span> pin<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A pin on port A.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// The pin number.</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> PA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_port</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Pin <span class="token punctuation">{</span>
        Pin <span class="token punctuation">{</span>
            port<span class="token punctuation">:</span> Port<span class="token punctuation">:</span><span class="token punctuation">:</span>A<span class="token punctuation">,</span>
            pin<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>pin<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Pin <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> Port<span class="token punctuation">,</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// (these fields can be packed to reduce the memory footprint)</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> Port <span class="token punctuation">{</span>
    A<span class="token punctuation">,</span>
    B<span class="token punctuation">,</span>
    C<span class="token punctuation">,</span>
    D<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°-C-PIN-STATE"><a href="#å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°-C-PIN-STATE" class="headerlink" title="å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•° (C-PIN-STATE)"></a>å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•° (C-PIN-STATE)</h3><p>æ ¹æ®èŠ¯ç‰‡æˆ–ç³»åˆ—çš„ä¸åŒï¼Œå¼•è„šå¯ä»¥é…ç½®ä¸ºå…·æœ‰ä¸åŒç‰¹æ€§çš„è¾“å…¥æˆ–è¾“å‡ºã€‚æ­¤çŠ¶æ€åº”åœ¨ç±»å‹ç³»ç»Ÿä¸­è¿›è¡Œç¼–ç ï¼Œä»¥é˜²æ­¢åœ¨é”™è¯¯çŠ¶æ€ä¸‹ä½¿ç”¨å¼•è„šã€‚</p>
<p>é™„åŠ çš„ã€ç‰¹å®šäºèŠ¯ç‰‡çš„çŠ¶æ€ï¼ˆä¾‹å¦‚é©±åŠ¨å¼ºåº¦ï¼‰ä¹Ÿå¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨é™„åŠ ç±»å‹å‚æ•°è¿›è¡Œç¼–ç ã€‚</p>
<p>åº”æä¾›æ›´æ”¹å¼•è„šçŠ¶æ€çš„æ–¹æ³•<code>into_input</code>å’Œ <code>into_output</code>æ–¹æ³•ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>with_{input,output}_state</code>åº”è¯¥æä¾›åœ¨ä¸åŒçŠ¶æ€ä¸‹ä¸´æ—¶é‡æ–°é…ç½®å¼•è„šè€Œä¸ç§»åŠ¨å®ƒçš„æ–¹æ³•ã€‚</p>
<p>åº”ä¸ºæ¯ç§å¼•è„šç±»å‹æä¾›ä»¥ä¸‹æ–¹æ³•ï¼ˆå³æ“¦é™¤å’Œéæ“¦é™¤å¼•è„šç±»å‹åº”æä¾›ç›¸åŒçš„ APIï¼‰ï¼š</p>
<ul>
<li><p><code>pub fn into_input&lt;N: InputState&gt;(self, input: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><p><code>pub fn into_output&lt;N: OutputState&gt;(self, output: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_input_state<N: InputState, R>(
    &mut self,
    input: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_output_state<N: OutputState, R>(
    &mut self,
    output: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>å¼•è„šçŠ¶æ€åº”å—å¯†å°ç‰¹å¾çš„é™åˆ¶ã€‚HAL çš„ç”¨æˆ·åº”è¯¥ä¸éœ€è¦æ·»åŠ ä»–ä»¬è‡ªå·±çš„çŠ¶æ€ã€‚è¿™äº›ç‰¹å¾å¯ä»¥æä¾›å®ç°å¼•è„šçŠ¶æ€ API æ‰€éœ€çš„ç‰¹å®šäº HAL çš„æ–¹æ³•ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">mod</span> sealed <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">trait</span> Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> PinState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> OutputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> InputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Output<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PushPull<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> OpenDrain<span class="token punctuation">;</span>

<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Input<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Floating<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullUp<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullDown<span class="token punctuation">;</span>

<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> PA1<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_input<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Input<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_output<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Output<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_input_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_output_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Same for `PA` and `Pin`, and other pin types.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Tips-for-embedded-C-developers"><a href="#Tips-for-embedded-C-developers" class="headerlink" title="Tips for embedded C developers"></a>Tips for embedded C developers</h1><p>æœ¬ç« æ”¶é›†äº†å„ç§æŠ€å·§ï¼Œå¯èƒ½å¯¹å¸Œæœ›å¼€å§‹ç¼–å†™ Rust çš„æœ‰ç»éªŒçš„åµŒå…¥å¼ C å¼€å‘äººå‘˜æœ‰ç”¨ã€‚å®ƒå°†ç‰¹åˆ«å¼ºè°ƒæ‚¨åœ¨ C ä¸­å¯èƒ½å·²ç»ä¹ æƒ¯çš„ä¸œè¥¿åœ¨ Rust ä¸­çš„ä¸åŒä¹‹å¤„ã€‚</p>
<h2 id="é¢„å¤„ç†å™¨"><a href="#é¢„å¤„ç†å™¨" class="headerlink" title="é¢„å¤„ç†å™¨"></a>é¢„å¤„ç†å™¨</h2><p>åœ¨åµŒå…¥å¼ C ä¸­ï¼Œå°†é¢„å¤„ç†å™¨ç”¨äºå„ç§ç›®çš„æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ä»£ç å—çš„ç¼–è¯‘æ—¶é€‰æ‹© <code>#ifdef</code></li>
<li>ç¼–è¯‘æ—¶æ•°ç»„å¤§å°å’Œè®¡ç®—</li>
<li>ç”¨äºç®€åŒ–å¸¸è§æ¨¡å¼çš„å®ï¼ˆä»¥é¿å…å‡½æ•°è°ƒç”¨å¼€é”€ï¼‰</li>
</ul>
<p>åœ¨ Rust ä¸­æ²¡æœ‰é¢„å¤„ç†å™¨ï¼Œå› æ­¤è®¸å¤šè¿™äº›ç”¨ä¾‹çš„å¤„ç†æ–¹å¼ä¸åŒã€‚åœ¨æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä½¿ç”¨é¢„å¤„ç†å™¨çš„å„ç§æ›¿ä»£æ–¹æ³•ã€‚</p>
<h3 id="Compile-Time-Code-Selection"><a href="#Compile-Time-Code-Selection" class="headerlink" title="Compile-Time Code Selection"></a>Compile-Time Code Selection</h3><p><code>#ifdef ... #endif</code>åœ¨ Rust ä¸­æœ€æ¥è¿‘çš„åŒ¹é…æ˜¯<a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-features-section" target="_blank" rel="noopener">Cargo features</a>ã€‚è¿™äº›æ¯” C é¢„å¤„ç†å™¨æ›´æ­£å¼ä¸€äº›ï¼šæ‰€æœ‰å¯èƒ½çš„åŠŸèƒ½éƒ½æ˜ç¡®åˆ—å‡ºæ¯ä¸ª crateï¼Œå¹¶ä¸”åªèƒ½æ‰“å¼€æˆ–å…³é—­ã€‚å½“æ‚¨å°†ä¸€ä¸ª crate åˆ—ä¸ºä¾èµ–é¡¹æ—¶ï¼ŒåŠŸèƒ½ä¼šè¢«æ‰“å¼€ï¼Œå¹¶ä¸”æ˜¯é™„åŠ çš„ï¼šå¦‚æœæ‚¨çš„ä¾èµ–æ ‘ä¸­çš„ä»»ä½•ä¸€ä¸ª crate ä¸ºå¦ä¸€ä¸ª crate å¯ç”¨äº†ä¸€ä¸ªç‰¹æ€§ï¼Œé‚£ä¹ˆè¯¥ç‰¹æ€§å°†ä¸ºè¯¥ crate çš„æ‰€æœ‰ç”¨æˆ·å¯ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªæä¾›ä¿¡å·å¤„ç†åŸè¯­åº“çš„ crateã€‚æ¯ä¸ªäººéƒ½å¯èƒ½éœ€è¦ä¸€äº›é¢å¤–çš„æ—¶é—´æ¥ç¼–è¯‘æˆ–å£°æ˜ä¸€äº›æ‚¨å¸Œæœ›é¿å…çš„å¤§å‹å¸¸é‡è¡¨ã€‚ä½ å¯ä»¥ä¸ºä½ çš„æ¯ä¸ªç»„ä»¶å£°æ˜ä¸€ä¸ª Cargo ç‰¹æ€§<code>Cargo.toml</code>ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">[features]
FIR = []
IIR = []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åï¼Œåœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œä½¿ç”¨<code>#[cfg(feature="FIR")]</code>æ¥æ§åˆ¶æ‰€åŒ…å«çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// In your top-level lib.rs</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"FIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> fir<span class="token punctuation">;</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"IIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> iir<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç±»ä¼¼åœ°ï¼Œä»…å½“æŸä¸ªåŠŸèƒ½<em>æœª</em>å¯ç”¨ï¼Œæˆ–è€…åŠŸèƒ½çš„ä»»ä½•ç»„åˆå·²å¯ç”¨æˆ–æœªå¯ç”¨æ—¶ï¼Œæ‚¨æ‰å¯ä»¥åŒ…å«ä»£ç å—ã€‚</p>
<p>æ­¤å¤–ï¼ŒRust æä¾›äº†è®¸å¤šæ‚¨å¯ä»¥ä½¿ç”¨çš„è‡ªåŠ¨è®¾ç½®æ¡ä»¶ï¼Œä¾‹å¦‚<code>target_arch</code>æ ¹æ®æ¶æ„é€‰æ‹©ä¸åŒçš„ä»£ç ã€‚æœ‰å…³æ¡ä»¶ç¼–è¯‘æ”¯æŒçš„å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…Rust å‚è€ƒçš„ <a href="https://doc.rust-lang.org/reference/conditional-compilation.html" target="_blank" rel="noopener">æ¡ä»¶ç¼–è¯‘</a>ç« èŠ‚ã€‚</p>
<p>æ¡ä»¶ç¼–è¯‘ä»…é€‚ç”¨äºä¸‹ä¸€ä¸ªè¯­å¥æˆ–å—ã€‚å¦‚æœä¸€ä¸ªå—ä¸èƒ½åœ¨å½“å‰èŒƒå›´å†…ä½¿ç”¨ï¼Œé‚£ä¹ˆè¯¥<code>cfg</code>å±æ€§å°†éœ€è¦å¤šæ¬¡ä½¿ç”¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæœ€å¥½ç®€å•åœ°åŒ…å«æ‰€æœ‰ä»£ç å¹¶å…è®¸ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–æ—¶åˆ é™¤æ­»ä»£ç ï¼šè¿™å¯¹æ‚¨å’Œæ‚¨çš„ç”¨æˆ·æ¥è¯´æ›´ç®€å•ï¼Œå¹¶ä¸”é€šå¸¸ç¼–è¯‘å™¨ä¼šå¾ˆå¥½åœ°åˆ é™¤æœªä½¿ç”¨çš„ä»£ç .</p>
<h3 id="ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—"><a href="#ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—" class="headerlink" title="ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—"></a>ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—</h3><p>Rust æ”¯æŒ<code>const fn</code>, ä¿è¯åœ¨ç¼–è¯‘æ—¶å¯è¯„ä¼°çš„å‡½æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨éœ€è¦å¸¸é‡çš„åœ°æ–¹ä½¿ç”¨ï¼Œä¾‹å¦‚æ•°ç»„çš„å¤§å°ã€‚è¿™å¯ä»¥ä¸ä¸Šè¿°åŠŸèƒ½ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> usize <span class="token punctuation">{</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">1024</span> <span class="token punctuation">}</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">128</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> BUF<span class="token punctuation">:</span> <span class="token punctuation">[</span>u32<span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u32</span><span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä» 1.31 å¼€å§‹ï¼Œè¿™äº›æ˜¯ç¨³å®š Rust çš„æ–°å†…å®¹ï¼Œå› æ­¤æ–‡æ¡£ä»ç„¶å¾ˆå°‘ã€‚<code>const fn</code>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¯ç”¨çš„åŠŸèƒ½ä¹Ÿéå¸¸æœ‰é™ï¼›åœ¨æœªæ¥çš„ Rust ç‰ˆæœ¬ä¸­ï¼Œé¢„è®¡ä¼šæ‰©å±•<code>const fn</code>.</p>
<h3 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h3><p>Rust æä¾›äº†ä¸€ä¸ªæå…¶å¼ºå¤§çš„<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">å®ç³»ç»Ÿ</a>ã€‚è™½ç„¶ C é¢„å¤„ç†å™¨å‡ ä¹ç›´æ¥å¯¹æºä»£ç çš„æ–‡æœ¬è¿›è¡Œæ“ä½œï¼Œä½† Rust å®ç³»ç»Ÿåœ¨æ›´é«˜çš„çº§åˆ«ä¸Šè¿è¡Œã€‚Rust å®æœ‰ä¸¤ç§å˜ä½“ï¼š<em>ç¤ºä¾‹*</em>å®<em>å’Œ</em>è¿‡ç¨‹å®*ã€‚å‰è€…æ›´ç®€å•ä¹Ÿæœ€å¸¸è§ï¼›å®ƒä»¬çœ‹èµ·æ¥åƒå‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥æ‰©å±•ä¸ºå®Œæ•´çš„è¡¨è¾¾å¼ã€è¯­å¥ã€é¡¹æˆ–æ¨¡å¼ã€‚è¿‡ç¨‹å®æ›´å¤æ‚ï¼Œä½†å…è®¸å¯¹ Rust è¯­è¨€è¿›è¡Œæå…¶å¼ºå¤§çš„æ·»åŠ ï¼šå®ƒä»¬å¯ä»¥å°†ä»»æ„ Rust è¯­æ³•è½¬æ¢ä¸ºæ–°çš„ Rust è¯­æ³•ã€‚</p>
<p>é€šå¸¸ï¼Œåœ¨æ‚¨å¯èƒ½ä½¿ç”¨è¿‡ C é¢„å¤„ç†å™¨å®çš„åœ°æ–¹ï¼Œæ‚¨å¯èƒ½æƒ³æŸ¥çœ‹ä¸€ä¸ªå®ç¤ºä¾‹æ˜¯å¦å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚å®ƒä»¬å¯ä»¥åœ¨æ‚¨çš„ crate ä¸­å®šä¹‰ï¼Œå¹¶ä¸”å¯ä»¥ç”±æ‚¨è‡ªå·±çš„ crate è½»æ¾ä½¿ç”¨æˆ–å¯¼å‡ºç»™å…¶ä»–ç”¨æˆ·ã€‚è¯·æ³¨æ„ï¼Œç”±äºå®ƒä»¬å¿…é¡»æ‰©å±•ä¸ºå®Œæ•´çš„è¡¨è¾¾å¼ã€è¯­å¥ã€é¡¹æˆ–æ¨¡å¼ï¼Œå› æ­¤ C é¢„å¤„ç†å™¨å®çš„æŸäº›ç”¨ä¾‹å°†ä¸èµ·ä½œç”¨ï¼Œä¾‹å¦‚æ‰©å±•ä¸ºå˜é‡åç§°çš„ä¸€éƒ¨åˆ†æˆ–åˆ—è¡¨ä¸­ä¸å®Œæ•´çš„é¡¹é›†çš„å®.</p>
<p>ä¸ Cargo åŠŸèƒ½ä¸€æ ·ï¼Œå¦‚æœæ‚¨ç”šè‡³éœ€è¦å®ï¼Œåˆ™å€¼å¾—è€ƒè™‘ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¸¸è§„å‡½æ•°æ›´å®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”ä¼šè¢«å†…è”åˆ°ä¸å®ç›¸åŒçš„ä»£ç ä¸­ã€‚åœ¨<code>#[inline]</code>å’Œ<code>#[inline(always)]</code> <a href="https://doc.rust-lang.org/reference/attributes.html#inline-attribute" target="_blank" rel="noopener">å±æ€§</a> è®©æ‚¨å¯¹è¿™ä¸€è¿‡ç¨‹çš„è¿›ä¸€æ­¥æ§åˆ¶ï¼Œä½†åº”è°¨æ…åœ¨è¿™é‡Œæ‹æ‘„ï¼Œä»¥åŠ-ç¼–è¯‘å™¨ä¼šä»åŒä¸€åŒ…è£…ç®±è‡ªåŠ¨å†…è”å‡½æ•°åœ¨é€‚å½“æƒ…å†µä¸‹ï¼Œæ‰€ä»¥è¿«ä½¿å®ƒè¿™æ ·åšä¸æ°å½“å®é™…ä¸Šå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
<p>è§£é‡Šæ•´ä¸ª Rust å®ç³»ç»Ÿè¶…å‡ºäº†æœ¬æç¤ºé¡µé¢çš„èŒƒå›´ï¼Œå› æ­¤é¼“åŠ±æ‚¨æŸ¥é˜… Rust æ–‡æ¡£ä»¥è·å–å®Œæ•´è¯¦ç»†ä¿¡æ¯ã€‚</p>
<h2 id="æ„å»ºç³»ç»Ÿ"><a href="#æ„å»ºç³»ç»Ÿ" class="headerlink" title="æ„å»ºç³»ç»Ÿ"></a>æ„å»ºç³»ç»Ÿ</h2><p>å¤§å¤šæ•° Rust crate æ˜¯ä½¿ç”¨ Cargo æ„å»ºçš„ï¼ˆå°½ç®¡ä¸æ˜¯å¿…éœ€çš„ï¼‰ã€‚è¿™è§£å†³äº†ä¼ ç»Ÿæ„å»ºç³»ç»Ÿçš„è®¸å¤šéš¾é¢˜ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½å¸Œæœ›è‡ªå®šä¹‰æ„å»ºè¿‡ç¨‹ã€‚Cargoä¸ºæ­¤æä¾›äº†<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener"><code>build.rs</code> è„šæœ¬</a>ã€‚å®ƒä»¬æ˜¯ Rust è„šæœ¬ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¸ Cargo æ„å»ºç³»ç»Ÿäº¤äº’ã€‚</p>
<p>æ„å»ºè„šæœ¬çš„å¸¸è§ç”¨ä¾‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>æä¾›æ„å»ºæ—¶é—´ä¿¡æ¯ï¼Œä¾‹å¦‚å°†æ„å»ºæ—¥æœŸæˆ– Git æäº¤å“ˆå¸Œé™æ€åµŒå…¥åˆ°æ‚¨çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­</li>
<li>æ ¹æ®æ‰€é€‰åŠŸèƒ½æˆ–å…¶ä»–é€»è¾‘åœ¨æ„å»ºæ—¶ç”Ÿæˆé“¾æ¥å™¨è„šæœ¬</li>
<li>æ›´æ”¹ Cargo æ„å»ºé…ç½®</li>
<li>æ·»åŠ é¢å¤–çš„é™æ€åº“æ¥é“¾æ¥</li>
</ul>
<p>ç›®å‰ä¸æ”¯æŒæ„å»ºåè„šæœ¬ï¼Œæ‚¨å¯èƒ½åœ¨ä¼ ç»Ÿä¸Šå°†å…¶ç”¨äºä»æ„å»ºå¯¹è±¡è‡ªåŠ¨ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶æˆ–æ‰“å°æ„å»ºä¿¡æ¯ç­‰ä»»åŠ¡ã€‚</p>
<h3 id="äº¤å‰ç¼–è¯‘-1"><a href="#äº¤å‰ç¼–è¯‘-1" class="headerlink" title="äº¤å‰ç¼–è¯‘"></a>äº¤å‰ç¼–è¯‘</h3><p>å°† Cargo ç”¨äºæ‚¨çš„æ„å»ºç³»ç»Ÿè¿˜å¯ä»¥ç®€åŒ–äº¤å‰ç¼–è¯‘ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€å‘Šè¯‰ Cargo<code>--target thumbv6m-none-eabi</code>å¹¶åœ¨<code>target/thumbv6m-none-eabi/debug/myapp</code>.</p>
<p>å¯¹äº Rust æœ¬èº«ä¸æ”¯æŒçš„å¹³å°ï¼Œæ‚¨éœ€è¦<code>libcore</code> è‡ªå·±ä¸ºè¯¥ç›®æ ‡æ„å»ºã€‚åœ¨è¿™æ ·çš„å¹³å°ä¸Šï¼Œ<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener">Xargo</a>å¯ä»¥ç”¨ä½œ Cargo çš„æ›¿èº«ï¼Œå®ƒä¼šè‡ªåŠ¨<code>libcore</code>ä¸ºæ‚¨æ„å»ºã€‚</p>
<h2 id="è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®"><a href="#è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®" class="headerlink" title="è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®"></a>è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®</h2><p>åœ¨ C ä¸­ï¼Œæ‚¨å¯èƒ½ä¹ æƒ¯äºé€šè¿‡ç´¢å¼•ç›´æ¥è®¿é—®æ•°ç»„ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c">int16_t arr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ Rust ä¸­ï¼Œè¿™æ˜¯ä¸€ç§åæ¨¡å¼ï¼šç´¢å¼•è®¿é—®å¯èƒ½ä¼šæ›´æ…¢ï¼ˆå› ä¸ºå®ƒéœ€è¦è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼‰å¹¶ä¸”å¯èƒ½ä¼šé˜»æ­¢å„ç§ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼Œå€¼å¾—é‡å¤ï¼šRust å°†æ£€æŸ¥æ‰‹åŠ¨æ•°ç»„ç´¢å¼•çš„è¶Šç•Œè®¿é—®ä»¥ä¿è¯å†…å­˜å®‰å…¨ï¼Œè€Œ C å°†å¾ˆä¹æ„åœ¨æ•°ç»„å¤–è¿›è¡Œç´¢å¼•ã€‚</p>
<p>ç›¸åï¼Œä½¿ç”¨è¿­ä»£å™¨ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u16</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> element <span class="token keyword">in</span> arr<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">*</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿­ä»£å™¨æä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§çš„åŠŸèƒ½ï¼Œæ‚¨å¿…é¡»åœ¨ C ä¸­æ‰‹åŠ¨å®ç°ï¼Œä¾‹å¦‚é“¾æ¥ã€å‹ç¼©ã€æšä¸¾ã€æŸ¥æ‰¾æœ€å°å€¼æˆ–æœ€å¤§å€¼ã€æ±‚å’Œç­‰ç­‰ã€‚è¿­ä»£å™¨æ–¹æ³•ä¹Ÿå¯ä»¥é“¾æ¥ï¼Œæä¾›éå¸¸æ˜“è¯»çš„æ•°æ®å¤„ç†ä»£ç ã€‚</p>
<h2 id="å¼•ç”¨-vs-æŒ‡é’ˆ"><a href="#å¼•ç”¨-vs-æŒ‡é’ˆ" class="headerlink" title="å¼•ç”¨ vs æŒ‡é’ˆ"></a>å¼•ç”¨ vs æŒ‡é’ˆ</h2><p>åœ¨ Rust ä¸­ï¼ŒæŒ‡é’ˆï¼ˆç§°ä¸º<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener"><em>åŸå§‹æŒ‡é’ˆ</em></a>ï¼‰å­˜åœ¨ä½†ä»…åœ¨ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œå› ä¸ºæ€»æ˜¯è€ƒè™‘å–æ¶ˆå¼•ç”¨å®ƒä»¬<code>unsafe</code>â€”â€”Rust ä¸èƒ½æä¾›å…³äºæŒ‡é’ˆåé¢å¯èƒ½æ˜¯ä»€ä¹ˆçš„é€šå¸¸ä¿è¯ã€‚</p>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ”¹ç”¨<em>å¼•ç”¨</em>ï¼Œç”±æŒ‡å®šçš„<code>&amp;</code>ç¬¦å·ï¼Œæˆ– <em>å¯å˜çš„å¼•ç”¨</em>ï¼Œä»¥è¡¨ç¤º<code>&amp;mut</code>ã€‚å¼•ç”¨çš„è¡Œä¸ºç±»ä¼¼äºæŒ‡é’ˆï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è¢«å–æ¶ˆå¼•ç”¨ä»¥è®¿é—®åº•å±‚å€¼ï¼Œä½†å®ƒä»¬æ˜¯ Rust æ‰€æœ‰æƒç³»ç»Ÿçš„å…³é”®éƒ¨åˆ†ï¼šRust å°†ä¸¥æ ¼å¼ºåˆ¶æ‚¨å¯èƒ½åªæœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨<em>æˆ–</em>å¤šä¸ªéå¯å˜å¼•ç”¨åˆ°åŒä¸€ä¸ªåœ¨ä»»ä½•ç»™å®šæ—¶é—´çš„ä»·å€¼ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€æ‚¨å¿…é¡»æ›´åŠ å°å¿ƒæ˜¯å¦éœ€è¦å¯¹æ•°æ®è¿›è¡Œå¯å˜è®¿é—®ï¼šåœ¨ C ä¸­ï¼Œé»˜è®¤å€¼æ˜¯å¯å˜çš„ï¼Œæ‚¨å¿…é¡»æ˜ç¡®è¯´æ˜<code>const</code>ï¼Œè€Œåœ¨ Rust ä¸­åˆ™ç›¸åã€‚</p>
<p>æ‚¨å¯èƒ½ä»ç„¶ä½¿ç”¨åŸå§‹æŒ‡é’ˆçš„ä¸€ç§æƒ…å†µæ˜¯ç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ï¼ˆä¾‹å¦‚ï¼Œå°†æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆå†™å…¥ DMA å¤–è®¾å¯„å­˜å™¨ï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬ä¹Ÿåœ¨å¹•åç”¨äºæ‰€æœ‰å¤–è®¾è®¿é—®åŒ…ï¼Œä»¥å…è®¸æ‚¨è¯»å–å’Œå†™å†…å­˜æ˜ å°„å¯„å­˜å™¨ã€‚</p>
<h2 id="Volatile-Access"><a href="#Volatile-Access" class="headerlink" title="Volatile Access"></a>Volatile Access</h2><p>åœ¨ C ä¸­ï¼Œä¸ªåˆ«å˜é‡å¯èƒ½è¢«æ ‡è®°ä¸º<code>volatile</code>ï¼Œå‘ç¼–è¯‘å™¨è¡¨æ˜å˜é‡ä¸­çš„å€¼å¯èƒ½ä¼šåœ¨è®¿é—®ä¹‹é—´å‘ç”Ÿå˜åŒ–ã€‚æ˜“å¤±æ€§å˜é‡é€šå¸¸ç”¨äºå†…å­˜æ˜ å°„å¯„å­˜å™¨çš„åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å°†å˜é‡æ ‡è®°ä¸º<code>volatile</code>ï¼Œè€Œæ˜¯ä½¿ç”¨ç‰¹å®šçš„æ–¹æ³•æ¥æ‰§è¡Œ volatile è®¿é—®ï¼š<a href="https://doc.rust-lang.org/core/ptr/fn.read_volatile.html" target="_blank" rel="noopener"><code>core::ptr::read_volatile</code></a>å’Œ <a href="https://doc.rust-lang.org/core/ptr/fn.write_volatile.html" target="_blank" rel="noopener"><code>core::ptr::write_volatile</code></a>ã€‚è¿™äº›æ–¹æ³•é‡‡ç”¨ a<code>*const T</code>æˆ– a <code>*mut T</code> ï¼ˆ<em>åŸå§‹æŒ‡é’ˆ</em>ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼‰å¹¶æ‰§è¡Œæ˜“å¤±æ€§è¯»å–æˆ–å†™å…¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ C ä¸­ä½ å¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">volatile</span> bool signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    signalled <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>signalled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Rust ä¸­çš„ç­‰ä»·ç‰©å°†åœ¨æ¯æ¬¡è®¿é—®æ—¶ä½¿ç”¨ volatile æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    <span class="token comment" spellcheck="true">// (In real code, you should consider a higher level primitive,</span>
    <span class="token comment" spellcheck="true">//  such as an atomic type).</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">!</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SIGNALLED<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»£ç ç¤ºä¾‹ä¸­æœ‰å‡ ç‚¹å€¼å¾—æ³¨æ„ï¼š</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥ä¼ é€’<code>&amp;mut SIGNALLED</code>åˆ°å‡½æ•° requires <code>*mut T</code>ï¼Œå› ä¸º <code>&amp;mut T</code>è‡ªåŠ¨è½¬æ¢ä¸º a <code>*mut T</code>ï¼ˆå¯¹äº<code>*const T</code>ï¼‰</li>
<li>æˆ‘ä»¬éœ€è¦/æ–¹æ³•çš„<code>unsafe</code>å—ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å‡½æ•°ã€‚ç¡®ä¿å®‰å…¨ä½¿ç”¨æ˜¯ç¨‹åºå‘˜çš„è´£ä»»ï¼šæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ–¹æ³•æ–‡æ¡£ã€‚<code>read_volatile``write_volatile``unsafe</code></li>
</ul>
<p>åœ¨æ‚¨çš„ä»£ç ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›å‡½æ•°æ˜¯å¾ˆå°‘è§çš„ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸ä¼šç”±æ›´é«˜çº§åˆ«çš„åº“ä¸ºæ‚¨å¤„ç†ã€‚å¯¹äºå†…å­˜æ˜ å°„å¤–è®¾ï¼Œå¤–è®¾è®¿é—® crate å°†è‡ªåŠ¨å®ç°æ˜“å¤±æ€§è®¿é—®ï¼Œè€Œå¯¹äºå¹¶å‘åŸè¯­ï¼Œæœ‰æ›´å¥½çš„æŠ½è±¡å¯ç”¨ã€‚</p>
<h2 id="å‹ç¼©å’Œå¯¹é½ç±»å‹"><a href="#å‹ç¼©å’Œå¯¹é½ç±»å‹" class="headerlink" title="å‹ç¼©å’Œå¯¹é½ç±»å‹"></a>å‹ç¼©å’Œå¯¹é½ç±»å‹</h2><p>åœ¨åµŒå…¥å¼ C ä¸­ï¼Œé€šå¸¸ä¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸€ä¸ªå˜é‡å¿…é¡»æœ‰ä¸€å®šçš„å¯¹é½æ–¹å¼ï¼Œæˆ–è€…ä¸€ä¸ªç»“æ„å¿…é¡»æ‰“åŒ…è€Œä¸æ˜¯å¯¹é½ï¼Œé€šå¸¸æ˜¯ä¸ºäº†æ»¡è¶³ç‰¹å®šçš„ç¡¬ä»¶æˆ–åè®®è¦æ±‚ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œè¿™ç”±<code>repr</code>ç»“æ„æˆ–è”åˆä¸Šçš„å±æ€§æ§åˆ¶ã€‚é»˜è®¤è¡¨ç¤ºä¸æä¾›å¸ƒå±€ä¿è¯ï¼Œå› æ­¤ä¸åº”ç”¨äºä¸ç¡¬ä»¶æˆ– C äº’æ“ä½œçš„ä»£ç ã€‚ç¼–è¯‘å™¨å¯èƒ½ä¼šé‡æ–°æ’åºç»“æ„æˆå‘˜æˆ–æ’å…¥å¡«å……ï¼Œå¹¶ä¸”è¡Œä¸ºå¯èƒ½ä¼šéšç€ Rust çš„æœªæ¥ç‰ˆæœ¬è€Œæ”¹å˜ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffecb3511d0 0x7ffecb3511d4 0x7ffecb3511d2</span>
<span class="token comment" spellcheck="true">// Note ordering has been changed to x, z, y to improve packing.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºç¡®ä¿å¸ƒå±€å¯ä¸ C äº’æ“ä½œï¼Œè¯·ä½¿ç”¨<code>repr(C)</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7fffd0d84c60 0x7fffd0d84c62 0x7fffd0d84c64</span>
<span class="token comment" spellcheck="true">// Ordering is preserved and the layout will not change over time.</span>
<span class="token comment" spellcheck="true">// `z` is two-byte aligned so a byte of padding exists between `y` and `z`.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¦ç¡®ä¿æ‰“åŒ…è¡¨ç¤ºï¼Œè¯·ä½¿ç”¨<code>repr(packed)</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(packed)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Unsafe is required to borrow a field of a packed struct.</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffd33598490 0x7ffd33598492 0x7ffd33598493</span>
<span class="token comment" spellcheck="true">// No padding has been inserted between `y` and `z`, so now `z` is unaligned.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯·æ³¨æ„ï¼Œ using<code>repr(packed)</code>è¿˜å°†ç±»å‹çš„å¯¹é½æ–¹å¼è®¾ç½®ä¸º<code>1</code>ã€‚</p>
<p>æœ€åï¼Œè¦æŒ‡å®šç‰¹å®šçš„å¯¹é½æ–¹å¼ï¼Œè¯·ä½¿ç”¨<code>repr(align(n))</code>ï¼Œå…¶ä¸­<code>n</code>æ˜¯è¦å¯¹é½çš„å­—èŠ‚æ•°ï¼ˆå¹¶ä¸”å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼‰ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[repr(align(4096))]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> u <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffec909a000 0x7ffec909a002 0x7ffec909a004</span>
<span class="token comment" spellcheck="true">// 0x7ffec909b000 0x7ffec909b002 0x7ffec909b004</span>
<span class="token comment" spellcheck="true">// The two instances `u` and `v` have been placed on 4096-byte alignments,</span>
<span class="token comment" spellcheck="true">// evidenced by the `000` at the end of their addresses.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆ<code>repr(C)</code>ä½¿ç”¨<code>repr(align(n))</code>ä»¥è·å¾—å¯¹é½ä¸”ä¸ C å…¼å®¹çš„å¸ƒå±€ã€‚è¿™æ˜¯ä¸å…è®¸çš„ç»“åˆ<code>repr(align(n))</code>æœ‰ <code>repr(packed)</code>ï¼Œå› ä¸º<code>repr(packed)</code>å¥—å¯¹é½<code>1</code>ã€‚ä¸€ä¸ª<code>repr(packed)</code>ç±»å‹ä¹Ÿä¸å…è®¸åŒ…å«ä¸€ä¸ª<code>repr(align(n))</code>ç±»å‹ã€‚</p>
<h2 id="å…¶ä»–èµ„æº"><a href="#å…¶ä»–èµ„æº" class="headerlink" title="å…¶ä»–èµ„æº"></a>å…¶ä»–èµ„æº</h2><ul>
<li><a href="https://docs.rust-embedded.org/faq.html" target="_blank" rel="noopener">Rust åµŒå…¥å¼å¸¸è§é—®é¢˜è§£ç­”</a></li>
<li><a href="http://blahg.josefsipek.net/?p=580" target="_blank" rel="noopener">C ç¨‹åºå‘˜çš„ Rust æŒ‡é’ˆ</a></li>
<li><a href="https://github.com/diwic/reffers-rs/blob/master/docs/Pointers.md" target="_blank" rel="noopener">æˆ‘æ›¾ç»ä½¿ç”¨æŒ‡é’ˆ - ç°åœ¨å‘¢ï¼Ÿ</a></li>
</ul>
<h1 id="Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰"><a href="#Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰" class="headerlink" title="Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰"></a>Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰</h1><p>Rust å’Œ C ä»£ç ä¹‹é—´çš„äº’æ“ä½œæ€§å§‹ç»ˆä¾èµ–äºä¸¤ç§è¯­è¨€ä¹‹é—´çš„æ•°æ®è½¬æ¢ã€‚ä¸ºæ­¤ç›®çš„ï¼Œåœ¨è¢«<code>stdlib</code>è°ƒç”¨ <a href="https://doc.rust-lang.org/std/ffi/index.html" target="_blank" rel="noopener"><code>std::ffi</code></a>å’Œ ä¸­ æœ‰ä¸¤ä¸ªä¸“ç”¨æ¨¡å—<a href="https://doc.rust-lang.org/std/os/raw/index.html" target="_blank" rel="noopener"><code>std::os::raw</code></a>ã€‚</p>
<p><code>std::os::raw</code> å¤„ç†å¯ä»¥ç”±ç¼–è¯‘å™¨éšå¼è½¬æ¢çš„ä½çº§åŸå§‹ç±»å‹ï¼Œå› ä¸º Rust å’Œ C ä¹‹é—´çš„å†…å­˜å¸ƒå±€è¶³å¤Ÿç›¸ä¼¼æˆ–ç›¸åŒã€‚</p>
<p><code>std::ffi</code>æä¾›äº†ä¸€äº›å®ç”¨ç¨‹åºç”¨äºå°†æ›´åŠ å¤æ‚çš„ç±»å‹ï¼Œå¦‚å¼¦ä¹å™¨ï¼Œæ—¢æ˜ å°„<code>&amp;str</code>å’Œ<code>String</code> å¯¹C-ç±»å‹æ˜¯æ›´å®¹æ˜“å’Œæ›´å®‰å…¨çš„å¤„ç†ã€‚</p>
<p>è¿™äº›æ¨¡å—éƒ½æ²¡æœ‰åœ¨ ä¸­å¯ç”¨<code>core</code>ï¼Œä½†æ˜¯æ‚¨å¯ä»¥åœ¨crate ä¸­æ‰¾åˆ°<code>#![no_std]</code> å…¼å®¹ç‰ˆæœ¬ï¼Œ<code>std::ffi::{CStr,CString}</code>ä»¥åŠ<a href="https://crates.io/crates/cstr_core" target="_blank" rel="noopener"><code>cstr_core</code></a>crate ä¸­çš„å¤§å¤šæ•°<code>std::os::raw</code>ç±»å‹<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>ã€‚</p>
<table>
<thead>
<tr>
<th>é”ˆå‹</th>
<th>ä¸­é—´çš„</th>
<th>Cå‹</th>
</tr>
</thead>
<tbody><tr>
<td>ç»†ç»³</td>
<td>å­—ç¬¦ä¸²</td>
<td>*å­—ç¬¦</td>
</tr>
<tr>
<td>&amp;str</td>
<td>CStr</td>
<td>*å¸¸é‡å­—ç¬¦</td>
</tr>
<tr>
<td>()</td>
<td>c_void</td>
<td>ç©ºç™½</td>
</tr>
<tr>
<td>u32 æˆ– u64</td>
<td>c_uint</td>
<td>æ— ç¬¦å·æ•´æ•°</td>
</tr>
<tr>
<td>ç­‰ç­‰</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p>å¦‚ä¸Šæ‰€è¿°ï¼ŒåŸºæœ¬ç±»å‹å¯ä»¥ç”±ç¼–è¯‘å™¨éšå¼è½¬æ¢ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c_num<span class="token punctuation">:</span> c_uint <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r_num<span class="token punctuation">:</span> u32 <span class="token operator">=</span> c_num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§"><a href="#ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§" class="headerlink" title="ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§"></a>ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§</h3><p>åœ¨æ‚¨çš„åµŒå…¥å¼é¡¹ç›®ä¸­åŒ…å« Rust çš„ä¸€ä¸ªå¸¸è§è¦æ±‚æ˜¯å°† Cargo ä¸æ‚¨ç°æœ‰çš„æ„å»ºç³»ç»Ÿç›¸ç»“åˆï¼Œä¾‹å¦‚ make æˆ– cmakeã€‚</p>
<p>æˆ‘ä»¬æ­£åœ¨<a href="https://github.com/rust-embedded/book/issues/61" target="_blank" rel="noopener">é—®é¢˜ #61 ä¸­çš„</a>é—®é¢˜è·Ÿè¸ªå™¨ä¸Šä¸ºæ­¤æ”¶é›†ç¤ºä¾‹å’Œç”¨ä¾‹ ã€‚</p>
<h3 id="ä¸-RTOS-çš„äº’æ“ä½œæ€§"><a href="#ä¸-RTOS-çš„äº’æ“ä½œæ€§" class="headerlink" title="ä¸ RTOS çš„äº’æ“ä½œæ€§"></a>ä¸ RTOS çš„äº’æ“ä½œæ€§</h3><p>å°† Rust ä¸è¯¸å¦‚ FreeRTOS æˆ– ChibiOS ä¹‹ç±»çš„ RTOS é›†æˆä»åœ¨è¿›è¡Œä¸­ï¼›å°¤å…¶æ˜¯ä» Rust è°ƒç”¨ RTOS å‡½æ•°å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ã€‚</p>
<p>æˆ‘ä»¬æ­£åœ¨<a href="https://github.com/rust-embedded/book/issues/62" target="_blank" rel="noopener">é—®é¢˜ #62 ä¸­çš„</a>é—®é¢˜è·Ÿè¸ªå™¨ä¸Šä¸ºæ­¤æ”¶é›†ç¤ºä¾‹å’Œç”¨ä¾‹ ã€‚</p>
<h2 id="A-little-C-with-your-Rust"><a href="#A-little-C-with-your-Rust" class="headerlink" title="A little C with your Rust"></a>A little C with your Rust</h2><p>åœ¨ Rust é¡¹ç›®ä¸­ä½¿ç”¨ C æˆ– C++ åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>
<ul>
<li>åŒ…è£…æš´éœ²çš„ C API ä»¥ä¸ Rust ä¸€èµ·ä½¿ç”¨</li>
<li>æ„å»ºæ‚¨çš„ C æˆ– C++ ä»£ç ä»¥ä¸ Rust ä»£ç é›†æˆ</li>
</ul>
<p>ç”±äº C++ æ²¡æœ‰ç¨³å®šçš„ ABI ä¾› Rust ç¼–è¯‘å™¨ä½œä¸ºç›®æ ‡ï¼Œå› æ­¤å»ºè®®<code>C</code>åœ¨å°† Rust ä¸ C æˆ– C++ ç»“åˆä½¿ç”¨æ—¶ä½¿ç”¨ABIã€‚</p>
<h3 id="å®šä¹‰æ¥å£"><a href="#å®šä¹‰æ¥å£" class="headerlink" title="å®šä¹‰æ¥å£"></a>å®šä¹‰æ¥å£</h3><p>åœ¨ä» Rust ä½¿ç”¨ C æˆ– C++ ä»£ç ä¹‹å‰ï¼Œæœ‰å¿…è¦å®šä¹‰ï¼ˆåœ¨ Rust ä¸­ï¼‰é“¾æ¥ä»£ç ä¸­å­˜åœ¨å“ªäº›æ•°æ®ç±»å‹å’Œå‡½æ•°ç­¾åã€‚åœ¨ C æˆ– C++ ä¸­ï¼Œæ‚¨å°†åŒ…å«å®šä¹‰æ­¤æ•°æ®çš„å¤´ (<code>.h</code>æˆ–<code>.hpp</code>) æ–‡ä»¶ã€‚åœ¨ Rust ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å°†è¿™äº›å®šä¹‰è½¬æ¢ä¸º Rustï¼Œæˆ–è€…ä½¿ç”¨å·¥å…·ç”Ÿæˆè¿™äº›å®šä¹‰ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»‹ç»å°†è¿™äº›å®šä¹‰ä» C/C++ æ‰‹åŠ¨è½¬æ¢ä¸º Rustã€‚</p>
<h4 id="åŒ…è£…-C-å‡½æ•°å’Œæ•°æ®ç±»å‹"><a href="#åŒ…è£…-C-å‡½æ•°å’Œæ•°æ®ç±»å‹" class="headerlink" title="åŒ…è£… C å‡½æ•°å’Œæ•°æ®ç±»å‹"></a>åŒ…è£… C å‡½æ•°å’Œæ•°æ®ç±»å‹</h4><p>é€šå¸¸ï¼Œç”¨ C æˆ– C++ ç¼–å†™çš„åº“å°†æä¾›ä¸€ä¸ªå®šä¹‰å…¬å…±æ¥å£ä¸­ä½¿ç”¨çš„æ‰€æœ‰ç±»å‹å’Œå‡½æ•°çš„å¤´æ–‡ä»¶ã€‚ç¤ºä¾‹æ–‡ä»¶å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-C"><code class="language-C">/* File: cool.h */
typedef struct CoolStruct {
    int x;
    int y;
} CoolStruct;

void cool_function(int i, char c, CoolStruct* cs);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“è½¬æ¢ä¸º Rust æ—¶ï¼Œæ­¤ç•Œé¢å°†å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/* File: cool_bindings.rs */</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span>
    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬ä¸€æ¬¡ä¸€ä¸ªåœ°çœ‹ä¸€ä¸‹è¿™ä¸ªå®šä¹‰ï¼Œä»¥è§£é‡Šæ¯ä¸ªéƒ¨åˆ†ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust ä¸ä¿è¯åŒ…å«åœ¨<code>struct</code>. ä¸ºäº†ä¿è¯ä¸ C ä»£ç çš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬åŒ…å«äº†<code>#[repr(C)]</code>å±æ€§ï¼Œå®ƒæŒ‡ç¤º Rust ç¼–è¯‘å™¨å§‹ç»ˆä½¿ç”¨ C åœ¨ç»“æ„ä¸­ç»„ç»‡æ•°æ®çš„ç›¸åŒè§„åˆ™ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç”±äº C æˆ– C++ å®šä¹‰<code>int</code>or çš„æ–¹å¼çš„çµæ´»æ€§ï¼Œ<code>char</code>å»ºè®®ä½¿ç”¨ ä¸­å®šä¹‰çš„åŸå§‹æ•°æ®ç±»å‹<code>cty</code>ï¼Œå®ƒå°†ç±»å‹ä» C æ˜ å°„åˆ° Rust ä¸­çš„ç±»å‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span> <span class="token punctuation">...</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ­¤è¯­å¥å®šä¹‰äº†ä½¿ç”¨ C ABI çš„å‡½æ•°çš„ç­¾åï¼Œç§°ä¸º<code>cool_function</code>. é€šè¿‡å®šä¹‰ç­¾åè€Œä¸å®šä¹‰å‡½æ•°ä½“ï¼Œè¿™ä¸ªå‡½æ•°çš„å®šä¹‰éœ€è¦åœ¨åˆ«å¤„æä¾›ï¼Œæˆ–è€…ä»é™æ€åº“é“¾æ¥åˆ°æœ€ç»ˆåº“æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä¸æˆ‘ä»¬ä¸Šé¢çš„æ•°æ®ç±»å‹ç±»ä¼¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ C å…¼å®¹å®šä¹‰æ¥å®šä¹‰å‡½æ•°å‚æ•°çš„æ•°æ®ç±»å‹ã€‚ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬è¿˜ä¿ç•™äº†ç›¸åŒçš„å‚æ•°åç§°ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œæœ‰ä¸€ç§æ–°ç±»å‹ï¼Œ<code>*mut CoolStruct</code>. ç”±äº C æ²¡æœ‰ Rust å¼•ç”¨çš„æ¦‚å¿µï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š<code>&amp;mut CoolStruct</code>ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå§‹æŒ‡é’ˆã€‚ç”±äºå–æ¶ˆå¼•ç”¨æ­¤æŒ‡é’ˆæ˜¯<code>unsafe</code>ï¼Œå¹¶ä¸”è¯¥æŒ‡é’ˆå®é™…ä¸Šå¯èƒ½æ˜¯ä¸€ä¸ª<code>null</code>æŒ‡é’ˆï¼Œå› æ­¤åœ¨ä¸ C æˆ– C++ ä»£ç äº¤äº’æ—¶å¿…é¡»æ³¨æ„ç¡®ä¿ Rust çš„å…¸å‹ä¿è¯ã€‚</p>
<h4 id="è‡ªåŠ¨ç”Ÿæˆç•Œé¢"><a href="#è‡ªåŠ¨ç”Ÿæˆç•Œé¢" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆç•Œé¢"></a>è‡ªåŠ¨ç”Ÿæˆç•Œé¢</h4><p>æœ‰ä¸€ä¸ªåä¸º<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>çš„å·¥å…·å¯ä»¥è‡ªåŠ¨æ‰§è¡Œè¿™äº›è½¬æ¢ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç”Ÿæˆè¿™äº›æ¥å£ï¼Œè¿™å¯èƒ½å¾ˆä¹å‘³ä¸”å®¹æ˜“å‡ºé”™ã€‚æœ‰å…³<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>çš„ä½¿ç”¨<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">è¯´æ˜</a>ï¼Œè¯·å‚é˜…<a href="https://rust-lang.github.io/rust-bindgen/" target="_blank" rel="noopener">bindgen ç”¨æˆ·æ‰‹å†Œ</a>ï¼Œä½†å…¸å‹çš„è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>æ”¶é›†æ‰€æœ‰ C æˆ– C++ å¤´æ–‡ä»¶ï¼Œå®šä¹‰ä½ æƒ³ä¸ Rust ä¸€èµ·ä½¿ç”¨çš„æ¥å£æˆ–æ•°æ®ç±»å‹ã€‚</li>
<li>ç¼–å†™ä¸€ä¸ª<code>bindings.h</code>æ–‡ä»¶ï¼Œå®ƒ<code>#include "..."</code>æ˜¯æ‚¨åœ¨ç¬¬ä¸€æ­¥ä¸­æ”¶é›†çš„æ¯ä¸ªæ–‡ä»¶ã€‚</li>
<li>æä¾›æ­¤<code>bindings.h</code>æ–‡ä»¶ä»¥åŠç”¨äºå°†ä»£ç ç¼–è¯‘ä¸º<code>bindgen</code>. æç¤ºï¼šä½¿ç”¨<code>Builder.ctypes_prefix("cty")</code>/ <code>--ctypes-prefix=cty</code>å’Œ<code>Builder.use_core()</code>/<code>--use-core</code>ä½¿ç”Ÿæˆçš„ä»£ç <code>#![no_std]</code>å…¼å®¹ã€‚</li>
<li><code>bindgen</code>å°†ç”Ÿæˆç”Ÿæˆçš„ Rust ä»£ç åˆ°ç»ˆç«¯çª—å£çš„è¾“å‡ºã€‚æ­¤æ–‡ä»¶å¯èƒ½ä¼šé€šè¿‡ç®¡é“ä¼ è¾“åˆ°é¡¹ç›®ä¸­çš„æ–‡ä»¶ï¼Œä¾‹å¦‚<code>bindings.rs</code>. ä½ å¯ä»¥åœ¨ä½ çš„ Rust é¡¹ç›®ä¸­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥ä¸ç¼–è¯‘å’Œé“¾æ¥ä¸ºå¤–éƒ¨åº“çš„ C/C++ ä»£ç äº¤äº’ã€‚æç¤ºï¼š<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>å¦‚æœç”Ÿæˆçš„ç»‘å®šä¸­çš„ç±»å‹å¸¦æœ‰å‰ç¼€ï¼Œè¯·ä¸è¦å¿˜è®°ä½¿ç”¨crate <code>cty</code>ã€‚</li>
</ol>
<h3 id="æ„å»ºæ‚¨çš„-C-C-ä»£ç "><a href="#æ„å»ºæ‚¨çš„-C-C-ä»£ç " class="headerlink" title="æ„å»ºæ‚¨çš„ C/C++ ä»£ç "></a>æ„å»ºæ‚¨çš„ C/C++ ä»£ç </h3><p>ç”±äº Rust ç¼–è¯‘å™¨ä¸ç›´æ¥çŸ¥é“å¦‚ä½•ç¼–è¯‘ C æˆ– C++ ä»£ç ï¼ˆæˆ–æ¥è‡ªä»»ä½•å…¶ä»–è¯­è¨€çš„ä»£ç ï¼Œæä¾› C æ¥å£ï¼‰ï¼Œå› æ­¤æœ‰å¿…è¦æå‰ç¼–è¯‘æ‚¨çš„é Rust ä»£ç ã€‚</p>
<p>å¯¹äºåµŒå…¥å¼é¡¹ç›®ï¼Œè¿™é€šå¸¸æ„å‘³ç€å°† C/C++ ä»£ç ç¼–è¯‘ä¸ºé™æ€å­˜æ¡£ï¼ˆä¾‹å¦‚<code>cool-library.a</code>ï¼‰ï¼Œç„¶åå¯ä»¥åœ¨æœ€åçš„é“¾æ¥æ­¥éª¤ä¸­å°†å…¶ä¸ Rust ä»£ç ç»“åˆã€‚</p>
<p>å¦‚æœæ‚¨è¦ä½¿ç”¨çš„åº“å·²ä½œä¸ºé™æ€å­˜æ¡£åˆ†å‘ï¼Œåˆ™æ— éœ€é‡æ–°æ„å»ºä»£ç ã€‚åªéœ€å¦‚ä¸Šæ‰€è¿°è½¬æ¢æä¾›çš„æ¥å£å¤´æ–‡ä»¶ï¼Œå¹¶åœ¨ç¼–è¯‘/é“¾æ¥æ—¶åŒ…å«é™æ€å­˜æ¡£ã€‚</p>
<p>å¦‚æœä»£ç å­˜åœ¨ä½œä¸ºæºé¡¹ç›®ï¼Œè¿™å°†æ˜¯å¿…è¦ç¼–è¯‘C / C ++ä»£ç åˆ°é™æ€åº“ï¼Œæˆ–è€…é€šè¿‡è§¦å‘ç°æœ‰æ„å»ºç³»ç»Ÿï¼ˆå¦‚<code>make</code>ï¼Œ<code>CMake</code>ç­‰ï¼‰ï¼Œæˆ–é€šè¿‡ç§»æ¤å¿…è¦çš„ç¼–è¯‘æ­¥éª¤ï¼Œä½¿ç”¨ä¸€ç§å«åš<code>cc</code>æ¿æ¡ç®±çš„å·¥å…·ã€‚å¯¹äºè¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œéƒ½éœ€è¦ä½¿ç”¨<code>build.rs</code>è„šæœ¬ã€‚</p>
<h4 id="Rustbuild-rsæ„å»ºè„šæœ¬"><a href="#Rustbuild-rsæ„å»ºè„šæœ¬" class="headerlink" title="Rustbuild.rsæ„å»ºè„šæœ¬"></a>Rust<code>build.rs</code>æ„å»ºè„šæœ¬</h4><p>ä¸€ä¸ª<code>build.rs</code>è„šæœ¬æ˜¯å†™åœ¨é²æ–¯ç‰¹è¯­æ³•çš„æ–‡ä»¶ï¼Œé‚£æ˜¯ä½ çš„ç¼–è¯‘æœºä¸Šè¿è¡Œåï¼Œä½ çš„é¡¹ç›®çš„ä¾èµ–å·²å»ºæˆï¼Œä½†åœ¨æ­¤ä¹‹å‰é¡¹ç›®çš„ç”Ÿæˆã€‚</p>
<p>å®Œæ•´çš„å‚è€ƒå¯ä»¥åœ¨<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚<code>build.rs</code>è„šæœ¬å¯¹äºç”Ÿæˆä»£ç ï¼ˆä¾‹å¦‚é€šè¿‡<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>ï¼‰ã€è°ƒç”¨å¤–éƒ¨æ„å»ºç³»ç»Ÿï¼ˆä¾‹å¦‚<code>Make</code>ï¼‰æˆ–é€šè¿‡ä½¿ç”¨<code>cc</code>crateç›´æ¥ç¼–è¯‘ C/C++ éå¸¸æœ‰ç”¨ã€‚</p>
<h4 id="è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ"><a href="#è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ" class="headerlink" title="è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ"></a>è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ</h4><p>å¯¹äºå…·æœ‰å¤æ‚å¤–éƒ¨é¡¹ç›®æˆ–æ„å»ºç³»ç»Ÿçš„é¡¹ç›®ï¼Œ<a href="https://doc.rust-lang.org/std/process/struct.Command.html" target="_blank" rel="noopener"><code>std::process::Command</code></a>é€šè¿‡éå†ç›¸å¯¹è·¯å¾„ã€è°ƒç”¨å›ºå®šå‘½ä»¤ï¼ˆä¾‹å¦‚<code>make library</code>ï¼‰ï¼Œç„¶åå°†ç”Ÿæˆçš„é™æ€åº“å¤åˆ¶åˆ°é€‚å½“çš„åœ¨<code>target</code>æ„å»ºç›®å½•ä¸­çš„ä½ç½®ã€‚</p>
<p>è™½ç„¶æ‚¨çš„ crate å¯èƒ½é’ˆå¯¹<code>no_std</code>åµŒå…¥å¼å¹³å°ï¼Œä½†æ‚¨<code>build.rs</code>åªèƒ½åœ¨ç¼–è¯‘ crate çš„æœºå™¨ä¸Šæ‰§è¡Œã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿ç”¨å°†åœ¨æ‚¨çš„ç¼–è¯‘ä¸»æœºä¸Šè¿è¡Œçš„ä»»ä½• Rust crateã€‚</p>
<h4 id="ä½¿ç”¨cccrateæ„å»º-C-C-ä»£ç "><a href="#ä½¿ç”¨cccrateæ„å»º-C-C-ä»£ç " class="headerlink" title="ä½¿ç”¨cccrateæ„å»º C/C++ ä»£ç "></a>ä½¿ç”¨<code>cc</code>crateæ„å»º C/C++ ä»£ç </h4><p>å¯¹äºä¾èµ–é¡¹æˆ–å¤æ‚æ€§æœ‰é™çš„é¡¹ç›®ï¼Œæˆ–è€…å¯¹äºéš¾ä»¥ä¿®æ”¹æ„å»ºç³»ç»Ÿä»¥ç”Ÿæˆé™æ€åº“ï¼ˆè€Œä¸æ˜¯æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰çš„é¡¹ç›®ï¼Œä½¿ç”¨<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>å¯èƒ½æ›´å®¹æ˜“ï¼Œå®ƒæä¾›äº†æƒ¯ç”¨çš„ Rustä¸»æœºæä¾›çš„ç¼–è¯‘å™¨æ¥å£ã€‚</p>
<p>åœ¨å°†å•ä¸ª C æ–‡ä»¶ç¼–è¯‘ä¸ºé™æ€åº“çš„ä¾èµ–é¡¹çš„æœ€ç®€å•æƒ…å†µä¸‹ï¼Œ<code>build.rs</code>ä½¿ç”¨<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>çš„ç¤ºä¾‹è„šæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> cc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cc<span class="token punctuation">:</span><span class="token punctuation">:</span>Build<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"foo.c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"libfoo.a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="A-little-Rust-with-your-C"><a href="#A-little-Rust-with-your-C" class="headerlink" title="A little Rust with your C"></a>A little Rust with your C</h2><p>åœ¨ C æˆ– C++ é¡¹ç›®ä¸­ä½¿ç”¨ Rust ä»£ç ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚</p>
<ul>
<li>åœ¨ Rust ä¸­åˆ›å»ºä¸€ä¸ª C å‹å¥½çš„ API</li>
<li>å°†æ‚¨çš„ Rust é¡¹ç›®åµŒå…¥åˆ°å¤–éƒ¨æ„å»ºç³»ç»Ÿä¸­</li>
</ul>
<p>é™¤äº†<code>cargo</code>andä¹‹å¤–<code>meson</code>ï¼Œå¤§å¤šæ•°æ„å»ºç³»ç»Ÿéƒ½æ²¡æœ‰åŸç”Ÿçš„ Rust æ”¯æŒã€‚å› æ­¤ï¼Œæ‚¨å¾ˆå¯èƒ½æœ€å¥½ä»…<code>cargo</code>ç”¨äºç¼–è¯‘æ‚¨çš„ crate å’Œä»»ä½•ä¾èµ–é¡¹ã€‚</p>
<h3 id="è®¾ç½®é¡¹ç›®"><a href="#è®¾ç½®é¡¹ç›®" class="headerlink" title="è®¾ç½®é¡¹ç›®"></a>è®¾ç½®é¡¹ç›®</h3><p><code>cargo</code>åƒå¾€å¸¸ä¸€æ ·åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚</p>
<p>æœ‰ä¸€äº›æ ‡å¿—å‘Šè¯‰<code>cargo</code>å‘å‡ºä¸€ä¸ªç³»ç»Ÿåº“ï¼Œè€Œä¸æ˜¯å®ƒçš„å¸¸è§„ rust ç›®æ ‡ã€‚è¿™ä¹Ÿå…è®¸æ‚¨ä¸ºåº“è®¾ç½®ä¸åŒçš„è¾“å‡ºåç§°ï¼Œå¦‚æœæ‚¨å¸Œæœ›å®ƒä¸æ‚¨çš„ crate çš„å…¶ä½™éƒ¨åˆ†ä¸åŒã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[lib]
name = "your_crate"
crate-type = ["cdylib"]      # Creates dynamic lib
# crate-type = ["staticlib"] # Creates static lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ„å»ºCAPI"><a href="#æ„å»ºCAPI" class="headerlink" title="æ„å»ºCAPI"></a>æ„å»º<code>C</code>API</h3><p>å› ä¸º C++ æ²¡æœ‰ç¨³å®šçš„ ABI ä¾› Rust ç¼–è¯‘å™¨ä½œä¸ºç›®æ ‡ï¼Œæˆ‘ä»¬<code>C</code>ç”¨äºä¸åŒè¯­è¨€ä¹‹é—´çš„ä»»ä½•äº’æ“ä½œæ€§ã€‚åœ¨ C å’Œ C++ ä»£ç ä¸­ä½¿ç”¨ Rust æ—¶ä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<h4 id="no-mangle"><a href="#no-mangle" class="headerlink" title="#[no_mangle\]"></a><code>#[no_mangle\]</code></h4><p>Rust ç¼–è¯‘å™¨å¯¹ç¬¦å·åç§°çš„å¤„ç†ä¸æœ¬æœºä»£ç é“¾æ¥å™¨æ‰€æœŸæœ›çš„ä¸åŒã€‚å› æ­¤ï¼Œä»»ä½• Rust å¯¼å‡ºä»¥åœ¨ Rust ä¹‹å¤–ä½¿ç”¨çš„å‡½æ•°éƒ½éœ€è¦è¢«å‘ŠçŸ¥ä¸è¦è¢«ç¼–è¯‘å™¨ç ´åã€‚</p>
<h4 id="extern-quot-C-quot"><a href="#extern-quot-C-quot" class="headerlink" title="extern &quot;C&quot;"></a><code>extern "C"</code></h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨åœ¨ Rust ä¸­ç¼–å†™çš„ä»»ä½•å‡½æ•°éƒ½å°†ä½¿ç”¨ Rust ABIï¼ˆå®ƒä¹Ÿä¸ç¨³å®šï¼‰ã€‚ç›¸åï¼Œåœ¨æ„å»ºé¢å‘å¤–éƒ¨çš„ FFI API æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨ä½¿ç”¨ç³»ç»Ÿ ABIã€‚</p>
<p>æ ¹æ®æ‚¨çš„å¹³å°ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é’ˆå¯¹ç‰¹å®šçš„ ABI ç‰ˆæœ¬ï¼Œ<a href="https://doc.rust-lang.org/reference/items/external-blocks.html" target="_blank" rel="noopener">æ­¤å¤„</a>è®°å½•äº†è¿™äº›ç‰ˆæœ¬ã€‚</p>
<hr>
<p>å°†è¿™äº›éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ï¼Œæ‚¨ä¼šå¾—åˆ°ä¸€ä¸ªå¤§è‡´å¦‚ä¸‹æ‰€ç¤ºçš„å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°±åƒ<code>C</code>åœ¨æ‚¨çš„ Rust é¡¹ç›®ä¸­ä½¿ç”¨ä»£ç ä¸€æ ·ï¼Œæ‚¨ç°åœ¨éœ€è¦å°†æ•°æ®ä»åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†å¯ä»¥ç†è§£çš„å½¢å¼æ¥å›è½¬æ¢ã€‚</p>
<h3 id="é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯"><a href="#é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯" class="headerlink" title="é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯"></a>é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯</h3><p>é‚£ä¹ˆï¼Œé—®é¢˜å°±è§£å†³äº†ä¸€åŠã€‚ä½ ç°åœ¨æ€ä¹ˆç”¨è¿™ä¸ªï¼Ÿ</p>
<p><strong>è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ‚¨çš„é¡¹ç›®å’Œ/æˆ–æ„å»ºç³»ç»Ÿ</strong></p>
<p><code>cargo</code>å°†åˆ›å»ºä¸€ä¸ª<code>my_lib.so</code>/<code>my_lib.dll</code>æˆ–<code>my_lib.a</code>æ–‡ä»¶ï¼Œå…·ä½“å–å†³äºæ‚¨çš„å¹³å°å’Œè®¾ç½®ã€‚è¿™ä¸ªåº“å¯ä»¥ç®€å•åœ°ç”±ä½ çš„æ„å»ºç³»ç»Ÿé“¾æ¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œä» C è°ƒç”¨ Rust å‡½æ•°éœ€è¦ä¸€ä¸ªå¤´æ–‡ä»¶æ¥å£°æ˜å‡½æ•°ç­¾åã€‚</p>
<p>Rust-ffi API ä¸­çš„æ¯ä¸ªå‡½æ•°éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„å¤´å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åä¼šå˜æˆ</p>
<pre class="line-numbers language-C"><code class="language-C">void rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç­‰ç­‰ã€‚</p>
<p>æœ‰ä¸€ä¸ªå·¥å…·å¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ­¤è¿‡ç¨‹ï¼Œç§°ä¸º<a href="https://github.com/eqrion/cbindgen" target="_blank" rel="noopener">cbindgen</a>ï¼Œå®ƒä¼šåˆ†ææ‚¨çš„ Rust ä»£ç ï¼Œç„¶åä»ä¸­ç”Ÿæˆ C å’Œ C++ é¡¹ç›®çš„æ ‡å¤´ã€‚</p>
<p>æ­¤æ—¶ï¼Œä½¿ç”¨ C ä¸­çš„ Rust å‡½æ•°å°±åƒåŒ…å«æ ‡å¤´å¹¶è°ƒç”¨å®ƒä»¬ä¸€æ ·ç®€å•ï¼</p>
<pre class="line-numbers language-C"><code class="language-C">#include "my-rust-project.h"
rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Optimizations-the-speed-size-tradeoff"><a href="#Optimizations-the-speed-size-tradeoff" class="headerlink" title="Optimizations: the speed size tradeoff"></a>Optimizations: the speed size tradeoff</h1><p>æ¯ä¸ªäººéƒ½å¸Œæœ›ä»–ä»¬çš„ç¨‹åºè¶…å¿«å’Œè¶…å°ï¼Œä½†é€šå¸¸ä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰è¿™ä¸¤ç§ç‰¹æ€§ã€‚æœ¬èŠ‚è®¨è®ºæä¾›çš„ä¸åŒä¼˜åŒ–çº§åˆ«<code>rustc</code>ä»¥åŠå®ƒä»¬å¦‚ä½•å½±å“ç¨‹åºçš„æ‰§è¡Œæ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°ã€‚</p>
<h2 id="æ²¡æœ‰ä¼˜åŒ–"><a href="#æ²¡æœ‰ä¼˜åŒ–" class="headerlink" title="æ²¡æœ‰ä¼˜åŒ–"></a>æ²¡æœ‰ä¼˜åŒ–</h2><p>è¿™æ˜¯é»˜è®¤è®¾ç½®ã€‚å½“æ‚¨æ‰“ç”µè¯æ—¶ï¼Œ<code>cargo build</code>æ‚¨ä½¿ç”¨å¼€å‘ (AKA <code>dev</code>) é…ç½®æ–‡ä»¶ã€‚æ­¤é…ç½®æ–‡ä»¶é’ˆå¯¹è°ƒè¯•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå› æ­¤å®ƒå¯ç”¨è°ƒè¯•ä¿¡æ¯ï¼Œä½†<em>ä¸</em>å¯ç”¨ä»»ä½•ä¼˜åŒ–ï¼Œå³å®ƒä½¿ç”¨<code>-C opt-level = 0</code>.</p>
<p>è‡³å°‘å¯¹äºè£¸æœºå¼€å‘è€Œè¨€ï¼Œdebuginfo æ˜¯é›¶æˆæœ¬çš„ï¼Œå› ä¸ºå®ƒä¸ä¼šå ç”¨ Flash / ROM ä¸­çš„ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬å®é™…ä¸Šå»ºè®®æ‚¨åœ¨å‘å¸ƒé…ç½®æ–‡ä»¶ä¸­å¯ç”¨ debuginfo â€“ é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨å®ƒã€‚è¿™å°†å…è®¸æ‚¨åœ¨è°ƒè¯•å‘å¸ƒç‰ˆæœ¬æ—¶ä½¿ç”¨æ–­ç‚¹ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# symbols are nice and they don't increase the size on Flash
debug = true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ²¡æœ‰ä¼˜åŒ–å¯¹äºè°ƒè¯•æ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œå› ä¸ºå•æ­¥è°ƒè¯•ä»£ç æ„Ÿè§‰å°±åƒä½ åœ¨é€æ¡è¯­å¥æ‰§è¡Œç¨‹åºï¼Œè€Œä¸”ä½ å¯ä»¥<code>print</code> åœ¨ GDB ä¸­å †å å˜é‡å’Œå‡½æ•°å‚æ•°ã€‚ä»£ç ä¼˜åŒ–åï¼Œå°è¯•æ‰“å°å˜é‡ä¼šå¯¼è‡´<code>$0 = &lt;value optimized out&gt;</code>æ‰“å°ã€‚</p>
<p><code>dev</code>é…ç½®æ–‡ä»¶çš„æœ€å¤§ç¼ºç‚¹æ˜¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¼šå¾ˆå¤§è€Œä¸”å¾ˆæ…¢ã€‚å¤§å°é€šå¸¸æ›´æˆé—®é¢˜ï¼Œå› ä¸ºæœªä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½å ç”¨æ•°å KiB çš„é—ªå­˜ï¼Œè€Œæ‚¨çš„ç›®æ ‡è®¾å¤‡å¯èƒ½æ²¡æœ‰â€”â€”ç»“æœï¼šæœªä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸é€‚åˆæ‚¨çš„è®¾å¤‡ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥æœ‰æ›´å°çš„ã€è°ƒè¯•å™¨å‹å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å—ï¼Ÿæ˜¯çš„ï¼Œæœ‰ä¸€ä¸ªæŠ€å·§ã€‚</p>
<h3 id="ä¼˜åŒ–ä¾èµ–"><a href="#ä¼˜åŒ–ä¾èµ–" class="headerlink" title="ä¼˜åŒ–ä¾èµ–"></a>ä¼˜åŒ–ä¾èµ–</h3><p>æœ‰ä¸€ä¸ªåä¸º Cargo çš„åŠŸèƒ½<a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides" target="_blank" rel="noopener"><code>profile-overrides</code></a>ï¼Œå¯è®©æ‚¨è¦†ç›–ä¾èµ–é¡¹çš„ä¼˜åŒ–çº§åˆ«ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¯¥åŠŸèƒ½æ¥ä¼˜åŒ–æ‰€æœ‰ä¾èµ–é¡¹çš„å¤§å°ï¼ŒåŒæ—¶ä¿æŒ top crate æœªä¼˜åŒ–å’Œè°ƒè¯•å™¨å‹å¥½ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml"># Cargo.toml
[package]
name = "app"
# ..

[profile.dev.package."*"] # +
opt-level = "z" # +<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ²¡æœ‰è¦†ç›–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 9060   0x8000400
.rodata               1708   0x8002780
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨è¦†ç›–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 3490   0x8000400
.rodata               1100   0x80011c0
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ„å‘³ç€ Flash ä½¿ç”¨é‡å‡å°‘äº† 6 KiBï¼Œè€Œ top crate çš„å¯è°ƒè¯•æ€§æ²¡æœ‰ä»»ä½•æŸå¤±ã€‚å¦‚æœæ‚¨è¿›å…¥ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆæ‚¨å°†<code>&lt;value optimized out&gt;</code>å†æ¬¡å¼€å§‹çœ‹åˆ°è¿™äº› æ¶ˆæ¯ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æƒ³è¦è°ƒè¯•é¡¶çº§æ¿æ¡ç®±è€Œä¸æ˜¯ä¾èµ–é¡¹ã€‚å¦‚æœæ‚¨<em>ç¡®å®</em>éœ€è¦è°ƒè¯•ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨è¯¥<code>profile-overrides</code>åŠŸèƒ½ä»ä¼˜åŒ–ä¸­æ’é™¤ç‰¹å®šçš„ä¾èµ–é¡¹ã€‚è¯·å‚é˜…ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml"># ..

# don't optimize the `cortex-m-rt` crate
[profile.dev.package.cortex-m-rt] # +
opt-level = 0 # +

# but do optimize all the other dependencies
[profile.dev.package."*"]
codegen-units = 1 # better optimizations
opt-level = "z"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨é¡¶éƒ¨æ¿æ¡ç®±å’Œ<code>cortex-m-rt</code>è°ƒè¯•å™¨å‹å¥½ï¼</p>
<h2 id="ä¼˜åŒ–é€Ÿåº¦"><a href="#ä¼˜åŒ–é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–é€Ÿåº¦"></a>ä¼˜åŒ–é€Ÿåº¦</h2><p>æˆªè‡³ 2018 å¹´ 9 æœˆ 18 æ—¥ï¼Œ<code>rustc</code>æ”¯æŒä¸‰ä¸ªâ€œä¼˜åŒ–é€Ÿåº¦â€çº§åˆ«ï¼š<code>opt-level = 1</code>ã€<code>2</code>å’Œ<code>3</code>ã€‚å½“æ‚¨è¿è¡Œæ—¶ï¼Œ<code>cargo build --release</code>æ‚¨ä½¿ç”¨çš„æ˜¯é»˜è®¤ä¸º<code>opt-level = 3</code>.</p>
<p><code>opt-level = 2</code>å’Œéƒ½<code>3</code>ä»¥ç‰ºç‰²äºŒè¿›åˆ¶å¤§å°ä¸ºä»£ä»·æ¥ä¼˜åŒ–é€Ÿåº¦ï¼Œä½† level<code>3</code>æ¯” level æ‰§è¡Œæ›´å¤šçš„çŸ¢é‡åŒ–å’Œå†…è”<code>2</code>ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‚¨ä¼šçœ‹åˆ° at<code>opt-level</code>ç­‰äºæˆ–å¤§äº<code>2</code>LLVM å°†å±•å¼€å¾ªç¯ã€‚å¾ªç¯å±•å¼€åœ¨ Flash / ROM æ–¹é¢çš„æˆæœ¬ç›¸å½“é«˜ï¼ˆä¾‹å¦‚ï¼Œä» 26 å­—èŠ‚åˆ° 194 ä»¥å®ç°é›¶æ•°ç»„å¾ªç¯ï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨ç»™å®šæ­£ç¡®æ¡ä»¶çš„æƒ…å†µä¸‹å°†æ‰§è¡Œæ—¶é—´å‡åŠï¼ˆä¾‹å¦‚ï¼Œè¿­ä»£æ¬¡æ•°è¶³å¤Ÿå¤§ï¼‰ã€‚</p>
<p>ç›®å‰æ²¡æœ‰åŠæ³•ç¦ç”¨å¾ªç¯å±•å¼€<code>opt-level = 2</code>ï¼Œ<code>3</code>æ‰€ä»¥å¦‚æœä½ è´Ÿæ‹…ä¸èµ·å®ƒçš„æˆæœ¬ï¼Œä½ åº”è¯¥ä¼˜åŒ–ä½ çš„ç¨‹åºçš„å¤§å°ã€‚</p>
<h2 id="ä¼˜åŒ–å°ºå¯¸"><a href="#ä¼˜åŒ–å°ºå¯¸" class="headerlink" title="ä¼˜åŒ–å°ºå¯¸"></a>ä¼˜åŒ–å°ºå¯¸</h2><p>æˆªè‡³ 2018 å¹´ 9 æœˆ 18 æ—¥ï¼Œ<code>rustc</code>æ”¯æŒä¸¤ä¸ªâ€œä¼˜åŒ–å¤§å°â€çº§åˆ«ï¼š<code>opt-level = "s"</code>å’Œ<code>"z"</code>. è¿™äº›åç§°æ˜¯ä» clang/LLVM ç»§æ‰¿è€Œæ¥çš„ï¼Œå¹¶ä¸å¤ªå…·æœ‰æè¿°æ€§ï¼Œä½†<code>"z"</code>æ—¨åœ¨è¯´æ˜å®ƒç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ¯”<code>"s"</code>.</p>
<p>å¦‚æœæ‚¨å¸Œæœ›é’ˆå¯¹å¤§å°ä¼˜åŒ–å‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶<code>profile.release.opt-level</code>ï¼Œè¯·<code>Cargo.toml</code>æŒ‰å¦‚ä¸‹æ‰€ç¤ºæ›´æ”¹ è®¾ç½®ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# or "z"
opt-level = "s"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸¤ä¸ªä¼˜åŒ–çº§åˆ«å¤§å¤§é™ä½äº† LLVM çš„å†…è”é˜ˆå€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºå†³å®šæ˜¯å¦å†…è”å‡½æ•°çš„æŒ‡æ ‡ã€‚Rust åŸåˆ™ä¹‹ä¸€æ˜¯é›¶æˆæœ¬æŠ½è±¡ï¼›è¿™äº›æŠ½è±¡å€¾å‘äºä½¿ç”¨è®¸å¤šæ–°ç±»å‹å’Œå°å‡½æ•°æ¥ä¿å­˜ä¸å˜é‡ï¼ˆä¾‹å¦‚ï¼Œå€Ÿç”¨å†…éƒ¨å€¼çš„å‡½æ•°ï¼Œä¾‹å¦‚<code>deref</code>, <code>as_ref</code>ï¼‰ï¼Œå› æ­¤ä½å†…è”é˜ˆå€¼ä¼šä½¿ LLVM é”™è¿‡ä¼˜åŒ–æœºä¼šï¼ˆä¾‹å¦‚æ¶ˆé™¤æ­»åˆ†æ”¯ã€å†…è”è°ƒç”¨é—­åŒ…ï¼‰ã€‚</p>
<p>åœ¨ä¼˜åŒ–å¤§å°æ—¶ï¼Œæ‚¨å¯èƒ½æƒ³å°è¯•å¢åŠ å†…è”é˜ˆå€¼ï¼Œçœ‹çœ‹è¿™æ˜¯å¦å¯¹äºŒè¿›åˆ¶å¤§å°æœ‰ä»»ä½•å½±å“ã€‚æ›´æ”¹å†…è”é˜ˆå€¼çš„æ¨èæ–¹æ³•æ˜¯å°†<code>-C inline-threshold</code>æ ‡å¿—é™„åŠ åˆ°<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-toml"><code class="language-toml"># .cargo/config.toml
# this assumes that you are using the cortex-m-quickstart template
[target.'cfg(all(target_arch = "arm", target_os = "none"))']
rustflags = [
  # ..
  "-C", "inline-threshold=123", # +
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨ä»€ä¹ˆä»·å€¼ï¼Ÿ<a href="https://github.com/rust-lang/rust/blob/1.29.0/src/librustc_codegen_llvm/back/write.rs#L2105-L2122" target="_blank" rel="noopener">ä» 1.29.0 å¼€å§‹ï¼Œè¿™äº›æ˜¯ä¸åŒä¼˜åŒ–çº§åˆ«ä½¿ç”¨çš„å†…è”é˜ˆå€¼</a>ï¼š</p>
<ul>
<li><code>opt-level = 3</code> ä½¿ç”¨ 275</li>
<li><code>opt-level = 2</code> ä½¿ç”¨ 225</li>
<li><code>opt-level = "s"</code> ä½¿ç”¨ 75</li>
<li><code>opt-level = "z"</code> ä½¿ç”¨ 25</li>
</ul>
<p>ä½ åº”è¯¥å°è¯•<code>225</code>å’Œ<code>275</code>ä¼˜åŒ–å¤§å°æ—¶ã€‚</p>
<h1 id="Appendix-A-Glossary"><a href="#Appendix-A-Glossary" class="headerlink" title="Appendix A: Glossary"></a>Appendix A: Glossary</h1><p>The embedded ecosystem is full of different protocols, hardware components and vendor-specific things that use their own terms and abbreviations. This Glossary attempts to list them with pointers for understanding them better.</p>
<h3 id="BSP"><a href="#BSP" class="headerlink" title="BSP"></a>BSP</h3><p>A Board Support Crate provides a high level interface configured for a specific board. It usually depends on a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">HAL</a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="FPU"><a href="#FPU" class="headerlink" title="FPU"></a>FPU</h3><p>Floating-point Unit. A â€˜math processorâ€™ running only operations on floating-point numbers.</p>
<h3 id="HAL"><a href="#HAL" class="headerlink" title="HAL"></a>HAL</h3><p>A Hardware Abstraction Layer crate provides a developer friendly interface to a microcontrollerâ€™s features and peripherals. It is usually implemented on top of a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#pac" target="_blank" rel="noopener">Peripheral Access Crate (PAC)</a>. It may also implement traits from the <a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><p>Sometimes referred to as <code>IÂ²C</code> or Inter-IC. It is a protocol meant for hardware communication within a single integrated circuit. See <a href="https://en.wikipedia.org/wiki/I2c" target="_blank" rel="noopener">here</a> for more details</p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>A Peripheral Access Crate provides access to a microcontrollerâ€™s peripherals. It is one of the lower level crates and is usually generated directly from the provided <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#svd" target="_blank" rel="noopener">SVD</a>, often using <a href="https://github.com/rust-embedded/svd2rust/" target="_blank" rel="noopener">svd2rust</a>. The <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">Hardware Abstraction Layer</a> would usually depend on this crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>Serial Peripheral Interface. See <a href="https://en.wikipedia.org/wiki/Serial_peripheral_interface" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="SVD"><a href="#SVD" class="headerlink" title="SVD"></a>SVD</h3><p>System View Description is an XML file format used to describe the programmers view of a microcontroller device. You can read more about it on <a href="https://www.keil.com/pack/doc/CMSIS/SVD/html/index.html" target="_blank" rel="noopener">the ARM CMSIS documentation site</a>.</p>
<h3 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h3><p>Universal asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="USART"><a href="#USART" class="headerlink" title="USART"></a>USART</h3><p>Universal synchronous and asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_synchronous_and_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<hr>
<h1 id="ğŸ˜ã€ŠDiscoveryã€‹"><a href="#ğŸ˜ã€ŠDiscoveryã€‹" class="headerlink" title="ğŸ˜ã€ŠDiscoveryã€‹"></a>ğŸ˜ã€ŠDiscoveryã€‹</h1><h1 id="ç¡¬ä»¶-çŸ¥è¯†è¦æ±‚"><a href="#ç¡¬ä»¶-çŸ¥è¯†è¦æ±‚" class="headerlink" title="ç¡¬ä»¶/çŸ¥è¯†è¦æ±‚"></a>ç¡¬ä»¶/çŸ¥è¯†è¦æ±‚</h1><p>ç”±äºåµŒå…¥å¼ç¼–ç¨‹çš„æ€§è´¨ï¼Œç†è§£å€¼çš„äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶è¡¨ç¤ºå¦‚ä½•å·¥ä½œï¼Œä»¥åŠä¸€äº›æŒ‰ä½è¿ç®—ç¬¦çš„ä½¿ç”¨ä¹Ÿå°†éå¸¸æœ‰å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œäº†è§£ä»¥ä¸‹ç¨‹åºå¦‚ä½•äº§ç”Ÿå…¶è¾“å‡ºä¼šå¾ˆæœ‰ç”¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">0x4000_0000</span> <span class="token operator">+</span> <span class="token number">0xa2</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Use of the bit shift "&lt;&lt;" operation.</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// {:X} will format values as hexadecimal</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:X}: {:X}"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å¤–ï¼Œè¦éµå¾ªæ­¤ææ–™ï¼Œæ‚¨å°†éœ€è¦ä»¥ä¸‹ç¡¬ä»¶ï¼š</p>
<p>ï¼ˆæœ‰äº›ç»„ä»¶æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®ä½¿ç”¨ï¼‰</p>
<ul>
<li>ä¸€ä¸ª<a href="http://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STM32F3DISCOVERY</a>æ¿ã€‚</li>
</ul>
<p>ï¼ˆæ‚¨å¯ä»¥ä»â€œå¤§å‹â€<a href="http://www.mouser.com/ProductDetail/STMicroelectronics/STM32F3DISCOVERY" target="_blank" rel="noopener">ç”µå­</a> <a href="http://www.digikey.com/product-detail/en/stmicroelectronics/STM32F3DISCOVERY/497-13192-ND" target="_blank" rel="noopener">ä¾›åº”å•†</a>æˆ–<a href="https://www.aliexpress.com/wholesale?SearchText=stm32f3discovery" target="_blank" rel="noopener">ç”µå­å•†åŠ¡</a> <a href="http://www.ebay.com/sch/i.html?_nkw=stm32f3discovery" target="_blank" rel="noopener">ç½‘ç«™</a>è´­ä¹°æ­¤æ¿ï¼‰</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-16313628370881.jpg" alt=""></p>
<ul>
<li>å¯é€‰çš„ã€‚ä¸€ä¸ª<strong>3.3V</strong> USB &lt;-&gt; ä¸²è¡Œæ¨¡å—ã€‚ä¸ºäº†è¯¦ç»†è¯´æ˜ï¼šå¦‚æœä½ æœ‰å‘ç°ä¸»æ¿çš„æœ€æ–°ç‰ˆæœ¬ä¸­çš„ä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯ç»™å‡ºçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„æƒ…å†µä¸‹åœ¨æ•°å¹´å‰å‘å¸ƒçš„ï¼‰ï¼Œé‚£ä¹ˆä½ å°±<em>ä¸ä¼š</em>å› ä¸ºä¸»æ¿åŒ…æ‹¬æ¿è½½è¿™ä¸ªåŠŸèƒ½éœ€è¦è¿™ä¸ªæ¨¡å—ã€‚å¦‚æœæ‚¨æœ‰æ—§ç‰ˆç”µè·¯æ¿ï¼Œé‚£ä¹ˆç¬¬ 10 ç« å’Œç¬¬ 11 ç« å°†éœ€è¦æ­¤æ¨¡å—ã€‚ä¸ºäº†å®Œæ•´èµ·è§ï¼Œæˆ‘ä»¬å°†åŒ…å«ä½¿ç”¨ä¸²è¡Œæ¨¡å—çš„è¯´æ˜ã€‚æœ¬ä¹¦å°†ä½¿ç”¨<a href="https://www.sparkfun.com/products/9873" target="_blank" rel="noopener">æ­¤ç‰¹å®šå‹å·</a>ï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–å‹å·ï¼Œåªè¦å®ƒåœ¨ 3.3V ä¸‹è¿è¡Œå³å¯ã€‚æ‚¨å¯ä»¥ä»<a href="https://www.aliexpress.com/wholesale?SearchText=CH340G" target="_blank" rel="noopener">ç”µå­å•†åŠ¡</a>ç½‘ç«™è´­ä¹°çš„ CH340G æ¨¡å—ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸”å¯èƒ½æ›´ä¾¿å®œã€‚</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/language/serial-16313628370885.jpg" alt=""></p>
<ul>
<li>å¯é€‰çš„ã€‚HC-05 è“ç‰™æ¨¡å—ï¼ˆå¸¦æ¥å¤´ï¼ï¼‰ã€‚HC-06 ä¹Ÿå¯ä»¥ã€‚</li>
</ul>
<p>ï¼ˆä¸å…¶ä»–ä¸­å›½é›¶ä»¶ä¸€æ ·ï¼Œæ‚¨å‡ ä¹åªèƒ½åœ¨<a href="http://www.ebay.com/sch/i.html?_nkw=hc-05" target="_blank" rel="noopener">ç”µå­å•†åŠ¡</a> <a href="https://www.aliexpress.com/wholesale?SearchText=hc-05" target="_blank" rel="noopener">ç½‘ç«™</a>ä¸Šæ‰¾åˆ°è¿™äº›é›¶ä»¶ã€‚ï¼ˆç¾å›½ï¼‰ç”µå­ä¾›åº”å•†å‡ºäºæŸç§åŸå› é€šå¸¸ä¸ä¼šåº“å­˜è¿™äº›é›¶ä»¶ï¼‰</p>
<p><img src="/images/loading.gif" data-original="../images/language/bluetooth-16313628370887.jpg" alt=""></p>
<ul>
<li>ä¸¤æ¡ mini-B USB ç”µç¼†ã€‚éœ€è¦ä¸€ä¸ªæ‰èƒ½ä½¿ STM32F3DISCOVERY æ¿å·¥ä½œã€‚ä»…å½“æ‚¨æœ‰ä¸²è¡Œ &lt;-&gt; USB æ¨¡å—æ—¶æ‰éœ€è¦å¦ä¸€ä¸ªã€‚ç¡®ä¿ç”µç¼†éƒ½æ”¯æŒæ•°æ®ä¼ è¾“ï¼Œå› ä¸ºæŸäº›ç”µç¼†ä»…æ”¯æŒå……ç”µè®¾å¤‡ã€‚</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/language/usb-cable-16313628370889.jpg" alt=""></p>
<blockquote>
<p><strong>æ³¨æ„</strong>è¿™äº›<strong>å¹¶ä¸æ˜¯</strong>å‡ ä¹æ¯éƒ¨ Android æ‰‹æœºéƒ½éšé™„çš„ USB ç”µç¼†ï¼›é‚£äº›æ˜¯<em>å¾®å‹</em>USB ç”µç¼†ã€‚ç¡®ä¿ä½ æœ‰æ­£ç¡®çš„ä¸œè¥¿ï¼</p>
</blockquote>
<ul>
<li>ä¸»è¦æ˜¯å¯é€‰çš„ã€‚5 æ ¹æ¯å¯¹æ¯ã€4 æ ¹å…¬å¯¹æ¯å’Œ 1 æ ¹å…¬å¯¹å…¬<em>è·³çº¿</em>ï¼ˆåˆåæœé‚¦ï¼‰ã€‚æ‚¨<em>å¾ˆå¯èƒ½</em>éœ€è¦ä¸€å¯¹ä¸€å¥³æ€§æ‰èƒ½ä½¿ ITM å‘æŒ¥ä½œç”¨ã€‚ä»…å½“æ‚¨ä½¿ç”¨ USB &lt;-&gt; ä¸²è¡Œå’Œè“ç‰™æ¨¡å—æ—¶æ‰éœ€è¦å…¶ä»–ç”µçº¿ã€‚</li>
</ul>
<p>ï¼ˆæ‚¨å¯ä»¥ä»ç”µå­<a href="https://www.adafruit.com/categories/306" target="_blank" rel="noopener">ä¾›åº”å•†</a>æˆ–<a href="http://www.ebay.com/sch/i.html?_nkw=dupont+wire" target="_blank" rel="noopener">ç”µå­å•†åŠ¡</a> <a href="https://www.aliexpress.com/wholesale?SearchText=dupont+wire" target="_blank" rel="noopener">ç½‘ç«™</a>è·å¾—è¿™äº›ï¼‰</p>
<p><img src="/images/loading.gif" data-original="../images/language/jumper-wires-16313628370883.jpg" alt=""></p>
<blockquote>
<p><strong>FAQ</strong> : ç­‰ç­‰ï¼Œä¸ºä»€ä¹ˆæˆ‘éœ€è¦è¿™ä¸ªç‰¹å®šçš„ç¡¬ä»¶ï¼Ÿ</p>
</blockquote>
<p>å®ƒè®©æˆ‘å’Œä½ çš„ç”Ÿæ´»æ›´è½»æ¾ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒç¡¬ä»¶å·®å¼‚ï¼Œé‚£ä¹ˆææ–™ä¼šæ›´åŠ å¹³æ˜“è¿‘äººã€‚ç›¸ä¿¡æˆ‘è¿™ä¸€ç‚¹ã€‚</p>
<blockquote>
<p><strong>å¸¸è§é—®é¢˜</strong>ï¼šæˆ‘å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¼€å‘æ¿æ¥éµå¾ªæ­¤ææ–™å—ï¼Ÿ</p>
</blockquote>
<p>ä¹Ÿè®¸ï¼Ÿè¿™ä¸»è¦å–å†³äºä¸¤ä»¶äº‹ï¼šæ‚¨ä¹‹å‰ä½¿ç”¨å¾®æ§åˆ¶å™¨çš„ç»éªŒå’Œ/æˆ–æ˜¯å¦å·²ç»å­˜åœ¨<a href="https://docs.rs/f3" target="_blank" rel="noopener"><code>f3</code></a>ç”¨äºæ‚¨çš„å¼€å‘æ¿çš„é«˜çº§æ¿æ¡ç®±ï¼Œä¾‹å¦‚ã€‚</p>
<p>ä½¿ç”¨ä¸åŒçš„å¼€å‘æ¿ï¼Œå¦‚æœä¸æ˜¯æ‰€æœ‰çš„åˆå­¦è€…å‹å¥½æ€§å’Œâ€œæ˜“äºéµå¾ªâ€ï¼ŒIMOï¼Œæœ¬æ–‡å°†å¤±å»å¤§éƒ¨åˆ†ã€‚</p>
<p>å¦‚æœæ‚¨æœ‰ä¸åŒçš„å¼€å‘æ¿ï¼Œå¹¶ä¸”æ‚¨ä¸è®¤ä¸ºè‡ªå·±å®Œå…¨æ˜¯åˆå­¦è€…ï¼Œé‚£ä¹ˆæœ€å¥½ä»<a href="https://rust-embedded.github.io/cortex-m-quickstart/cortex_m_quickstart/" target="_blank" rel="noopener">å¿«é€Ÿå…¥é—¨</a>é¡¹ç›®æ¨¡æ¿å¼€å§‹ã€‚</p>
<h1 id="Setting-up-a-development-environment"><a href="#Setting-up-a-development-environment" class="headerlink" title="Setting up a development environment"></a>Setting up a development environment</h1><h2 id="æ­å»ºå¼€å‘ç¯å¢ƒ"><a href="#æ­å»ºå¼€å‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºå¼€å‘ç¯å¢ƒ"></a>æ­å»ºå¼€å‘ç¯å¢ƒ</h2><p>å¤„ç†å¾®æ§åˆ¶å™¨æ¶‰åŠå¤šç§å·¥å…·ï¼Œå› ä¸ºæˆ‘ä»¬å°†å¤„ç†ä¸æ‚¨çš„è®¡ç®—æœºä¸åŒçš„æ¶æ„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨â€œè¿œç¨‹â€è®¾å¤‡ä¸Šè¿è¡Œå’Œè°ƒè¯•ç¨‹åºã€‚</p>
<h3 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h3><p>å·¥å…·ä¸æ˜¯ä¸€åˆ‡ã€‚æ²¡æœ‰æ–‡æ¡£ï¼Œå‡ ä¹ä¸å¯èƒ½ä½¿ç”¨å¾®æ§åˆ¶å™¨ã€‚</p>
<p>æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦ä¸­æåŠæ‰€æœ‰è¿™äº›æ–‡ä»¶ï¼š</p>
<p><em>æ³¨æ„</em>æ‰€æœ‰è¿™äº›é“¾æ¥éƒ½æŒ‡å‘ PDF æ–‡ä»¶ï¼Œå…¶ä¸­ä¸€äº›æ–‡ä»¶é•¿è¾¾æ•°ç™¾é¡µï¼Œå¤§å°ä¸ºæ•° MBã€‚</p>
<ul>
<li><a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">STM32F3DISCOVERY ç”¨æˆ·æ‰‹å†Œ</a></li>
<li><a href="http://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">STM32F303VC æ•°æ®è¡¨</a></li>
<li><a href="http://www.st.com/resource/en/reference_manual/dm00043574.pdf" target="_blank" rel="noopener">STM32F303VC å‚è€ƒæ‰‹å†Œ</a></li>
<li><a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">LSM303DLHC</a> *</li>
<li><a href="https://www.st.com/content/ccc/resource/technical/document/application_note/2c/d9/a7/f8/43/48/48/64/DM00119036.pdf/files/DM00119036.pdf/jcr:content/translations/en.DM00119036.pdf" target="_blank" rel="noopener">L3GD20</a> *</li>
</ul>
<p><strong>*æ³¨æ„</strong>ï¼šè¾ƒæ–°çš„ï¼ˆä» 2020/09 å·¦å³å¼€å§‹ï¼‰æ¢ç´¢æ¿å¯èƒ½æœ‰ä¸åŒçš„ç”µå­ç½—ç›˜å’Œé™€èºä»ªï¼ˆè¯·å‚é˜…ç”¨æˆ·æ‰‹å†Œï¼‰ã€‚å› æ­¤ï¼Œç¬¬ 14-16 ç« ä¸­çš„è®¸å¤šå†…å®¹å°†ä¸ä¼šæŒ‰åŸæ ·è¿è¡Œã€‚åƒ<a href="https://github.com/rust-embedded/discovery/issues/274" target="_blank" rel="noopener">è¿™æ ·</a>æ£€æŸ¥ github é—®é¢˜ã€‚</p>
<h3 id="å·¥å…·-1"><a href="#å·¥å…·-1" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢åˆ—å‡ºçš„æ‰€æœ‰å·¥å…·ã€‚åœ¨æœªæŒ‡å®šæœ€ä½ç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œä»»ä½•æœ€æ–°ç‰ˆæœ¬éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä½†æˆ‘ä»¬åˆ—å‡ºäº†æˆ‘ä»¬æµ‹è¯•è¿‡çš„ç‰ˆæœ¬ã€‚</p>
<ul>
<li><p>Rust 1.31 æˆ–æ›´æ–°çš„å·¥å…·é“¾ã€‚</p>
</li>
<li><p><a href="https://crates.io/crates/itm" target="_blank" rel="noopener"><code>itmdump</code></a>&gt;=0.3.1 ( <code>cargo install itm</code>)ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼š0.3.1ã€‚</p>
</li>
<li><p>OpenOCD &gt;=0.8ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼šv0.9.0 å’Œ v0.10.0</p>
</li>
<li><p><code>arm-none-eabi-gdb</code>. å¼ºçƒˆå»ºè®®ä½¿ç”¨ 7.12 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼š7.10ã€7.11ã€7.12 å’Œ 8.1</p>
</li>
<li><p><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a>. 0.1.4 æˆ–æ›´æ–°ç‰ˆæœ¬ã€‚</p>
</li>
<li><p><code>minicom</code>åœ¨ Linux å’Œ macOS ä¸Šã€‚æµ‹è¯•ç‰ˆæœ¬ï¼š2.7ã€‚è¯»è€…æŠ¥å‘Šè¿™<code>picocom</code>ä¹Ÿæœ‰æ•ˆï¼Œä½†æˆ‘ä»¬å°†<code>minicom</code>åœ¨æœ¬æ–‡ä¸­ä½¿ç”¨ã€‚</p>
</li>
<li><p><code>PuTTY</code> åœ¨ Windows ä¸Šã€‚</p>
</li>
</ul>
<p>å¦‚æœä½ çš„ç”µè„‘æœ‰è“ç‰™åŠŸèƒ½å¹¶ä¸”ä½ æœ‰è“ç‰™æ¨¡å—ï¼Œä½ å¯ä»¥å¦å¤–å®‰è£…è¿™äº›å·¥å…·æ¥ç©è“ç‰™æ¨¡å—ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¯é€‰çš„ï¼š</p>
<ul>
<li>Linuxï¼Œä»…å½“æ‚¨æ²¡æœ‰åƒ Blueman è¿™æ ·çš„è“ç‰™ç®¡ç†å™¨åº”ç”¨ç¨‹åºæ—¶ã€‚<ul>
<li><code>bluez</code></li>
<li><code>hcitool</code></li>
<li><code>rfcomm</code></li>
<li><code>rfkill</code></li>
</ul>
</li>
</ul>
<p>macOS / OSX / Windows ç”¨æˆ·åªéœ€è¦å…¶æ“ä½œç³»ç»Ÿé™„å¸¦çš„é»˜è®¤è“ç‰™ç®¡ç†å™¨ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§ä¸æ“ä½œç³»ç»Ÿæ— å…³çš„å®‰è£…è¯´æ˜å®‰è£…ä¸€äº›å·¥å…·ï¼š</p>
<h4 id="rustc-amp-cargo"><a href="#rustc-amp-cargo" class="headerlink" title="rustc &amp; cargo"></a><code>rustc</code> &amp; cargo</h4><p>æŒ‰ç…§<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs ä¸Š</a>çš„è¯´æ˜å®‰è£… rustup ã€‚</p>
<p>å¦‚æœæ‚¨å·²ç»å®‰è£…äº† rustupï¼Œè¯·ä»”ç»†æ£€æŸ¥æ‚¨æ˜¯å¦åœ¨ç¨³å®šé¢‘é“ä¸Šå¹¶ä¸”æ‚¨çš„ç¨³å®šå·¥å…·é“¾æ˜¯æœ€æ–°çš„ã€‚<code>rustc -V</code>åº”è¯¥è¿”å›ä¸€ä¸ªæ¯”ä¸‹é¢æ˜¾ç¤ºçš„æ—¥æœŸæ–°çš„æ—¥æœŸï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc -V
rustc 1.31.0 (abe02cefd 2018-12-04)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="itmdump"><a href="#itmdump" class="headerlink" title="itmdump"></a><code>itmdump</code></h4><pre class="line-numbers language-console"><code class="language-console">cargo install itm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>éªŒè¯ç‰ˆæœ¬ &gt;=0.3.1</p>
<pre><code>$ itmdump -V
itmdump 0.3.1</code></pre><h4 id="cargo-binutils-2"><a href="#cargo-binutils-2" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h4><p>å®‰è£… <code>llvm-tools-preview</code></p>
<pre class="line-numbers language-console"><code class="language-console">rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å®‰è£… <code>cargo-binutils</code></p>
<pre><code>cargo install cargo-binutils</code></pre><p><strong>éªŒè¯å·¥å…·æ˜¯å¦å·²å®‰è£…</strong></p>
<p>åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-console"><code class="language-console">cargo new test-size
cd test-size
cargo run
cargo size -- -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code>~
$ cargo new test-size
     Created binary (application) `test-size` package

~
$ cd test-size

~/test-size (main)
$ cargo run
   Compiling test-size v0.1.0 (~/test-size)
    Finished dev [unoptimized + debuginfo] target(s) in 0.26s
     Running `target/debug/test-size`
Hello, world!

~/test-size (main)
$ cargo size -- -version
    Finished dev [unoptimized + debuginfo] target(s) in 0.00s
LLVM (http://llvm.org/):
  LLVM version 11.0.0-rust-1.50.0-stable
  Optimized build.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: znver2</code></pre><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><p>Here are the installation commands for a few Linux distributions.</p>
<h3 id="REQUIRED-packages"><a href="#REQUIRED-packages" class="headerlink" title="REQUIRED packages"></a>REQUIRED packages</h3><h4 id="Ubuntu-18-04-or-newer-Debian-stretch-or-newer"><a href="#Ubuntu-18-04-or-newer-Debian-stretch-or-newer" class="headerlink" title="Ubuntu 18.04 or newer / Debian stretch or newer"></a>Ubuntu 18.04 or newer / Debian stretch or newer</h4><blockquote>
<p><strong>NOTE</strong> <code>gdb-multiarch</code> is the GDB command youâ€™ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  gdb-multiarch \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-14-04-and-16-04"><a href="#Ubuntu-14-04-and-16-04" class="headerlink" title="Ubuntu 14.04 and 16.04"></a>Ubuntu 14.04 and 16.04</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command youâ€™ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  gdb-arm-none-eabi \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Fedora-23-or-newer"><a href="#Fedora-23-or-newer" class="headerlink" title="Fedora 23 or newer"></a>Fedora 23 or newer</h4><pre class="line-numbers language-console"><code class="language-console">sudo dnf install \
  minicom \
  openocd \
  gdb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Arch-Linux"><a href="#Arch-Linux" class="headerlink" title="Arch Linux"></a>Arch Linux</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command youâ€™ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S \
  arm-none-eabi-gdb \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Other-distros"><a href="#Other-distros" class="headerlink" title="Other distros"></a>Other distros</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command youâ€™ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<p>For distros that donâ€™t have packages for <a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">ARMâ€™s pre-built toolchain</a>, download the â€œLinux 64-bitâ€ file and put its <code>bin</code> directory on your path. Hereâ€™s one way to do it:</p>
<pre class="line-numbers language-console"><code class="language-console">mkdir -p ~/local && cd ~/local
tar xjf /path/to/downloaded/file/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux.tar.bz2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Then, use your editor of choice to append to your <code>PATH</code> in the appropriate shell init file (e.g. <code>~/.zshrc</code> or <code>~/.bashrc</code>):</p>
<pre><code>PATH=$PATH:$HOME/local/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux/bin</code></pre><h3 id="Optional-packages"><a href="#Optional-packages" class="headerlink" title="Optional packages"></a>Optional packages</h3><h4 id="Ubuntu-Debian"><a href="#Ubuntu-Debian" class="headerlink" title="Ubuntu / Debian"></a>Ubuntu / Debian</h4><pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  bluez \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h4><pre class="line-numbers language-console"><code class="language-console">sudo dnf install \
  bluez \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Arch-Linux-1"><a href="#Arch-Linux-1" class="headerlink" title="Arch Linux"></a>Arch Linux</h4><pre class="line-numbers language-console"><code class="language-console">sudo pacman -S \
  bluez \
  bluez-utils \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="udev-rules"><a href="#udev-rules" class="headerlink" title="udev rules"></a>udev rules</h4><p>These rules let you use USB devices like the F3 and the Serial module without root privilege, i.e. <code>sudo</code>.</p>
<p>Create <code>99-openocd.rules</code> in <code>/etc/udev/rules.d</code> using the <code>idVendor</code> and <code>idProduct</code> from the <code>lsusb</code> output.</p>
<p>For example, connect the STM32F3DISCOVERY to your computer using a USB cable. Be sure to connect the cable to the â€œUSB ST-LINKâ€ port, the USB port in the center of the edge of the board.</p>
<p>Execute <code>lsusb</code>:</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb | grep ST-LINK<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>It should result in something like:</p>
<pre><code>$ lsusb | grep ST-LINK
Bus 003 Device 003: ID 0483:374b STMicroelectronics ST-LINK/V2.1</code></pre><p>So the <code>idVendor</code> is <code>0483</code> and <code>idProduct</code> is <code>374b</code>.</p>
<h4 id="Create-etc-udev-rules-d-99-openocd-rules"><a href="#Create-etc-udev-rules-d-99-openocd-rules" class="headerlink" title="Create /etc/udev/rules.d/99-openocd.rules:"></a>Create <code>/etc/udev/rules.d/99-openocd.rules</code>:</h4><pre class="line-numbers language-console"><code class="language-console">sudo vi /etc/udev/rules.d/99-openocd.rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>With the contents:</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY - ST-LINK/V2.1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", MODE:="0666"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>For older devices with OPTIONAL USB &lt;-&gt; FT232 based Serial Module</strong></p>
<p>Create <code>/etc/udev/rules.d/99-ftdi.rules</code>:</p>
<pre class="line-numbers language-console"><code class="language-console">sudo vi /etc/udev/rules.d/99-openocd.rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>With the contents:</p>
<pre class="line-numbers language-text"><code class="language-text"># FT232 - USB <-> Serial Converter
ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", MODE:="0666"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Reload-the-udev-rules-with"><a href="#Reload-the-udev-rules-with" class="headerlink" title="Reload the udev rules with:"></a>Reload the udev rules with:</h4><pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>If you had any board plugged to your computer, unplug them and then plug them in again.</p>
<h2 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h2><h3 id="arm-none-eabi-gdb-1"><a href="#arm-none-eabi-gdb-1" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h3><p>ARM provides <code>.exe</code> installers for Windows. Grab one from <a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">here</a>, and follow the instructions. Just before the installation process finishes tick/select the â€œAdd path to environment variableâ€ option. Then verify that the tools are in your <code>%PATH%</code>:</p>
<p>Verify gcc is installed:</p>
<pre class="line-numbers language-console"><code class="language-console">arm-none-eabi-gcc -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The results should be something like:</p>
<pre><code>(..)
$ arm-none-eabi-gcc -v
gcc version 5.4.1 20160919 (release) (..)</code></pre><h3 id="OpenOCD-1"><a href="#OpenOCD-1" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>Thereâ€™s no official binary release of OpenOCD for Windows but there are unofficial releases available <a href="https://github.com/xpack-dev-tools/openocd-xpack/releases" target="_blank" rel="noopener">here</a>. Grab the 0.10.x zipfile and extract it somewhere in your drive (I recommend <code>C:\OpenOCD</code> but with the drive letter that makes sense to you) then update your <code>%PATH%</code> environment variable to include the following path: <code>C:\OpenOCD\bin</code> (or the path that you used before).</p>
<p>Verify OpenOCD is installed and in your <code>%PATH%</code> with:</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The results should be something like:</p>
<pre class="line-numbers language-console"><code class="language-console">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="PuTTY"><a href="#PuTTY" class="headerlink" title="PuTTY"></a>PuTTY</h3><p>Download the latest <code>putty.exe</code> from <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank" rel="noopener">this site</a> and place it somewhere in your <code>%PATH%</code>.</p>
<h3 id="ST-LINK-USB-driver"><a href="#ST-LINK-USB-driver" class="headerlink" title="ST-LINK USB driver"></a>ST-LINK USB driver</h3><p>Youâ€™ll also need to install <a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">this USB driver</a> or OpenOCD wonâ€™t work. Follow the installer instructions and make sure you install the right (32-bit or 64-bit) version of the driver.</p>
<h2 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h2><p>All the tools can be install using <a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>:</p>
<p>Install ArmMbed</p>
<pre class="line-numbers language-console"><code class="language-console">brew tap ArmMbed/homebrew-formulae<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Install the ARM GCC toolchain</p>
<pre class="line-numbers language-console"><code class="language-console">brew install arm-none-eabi-gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Install minicom and OpenOCD</p>
<pre class="line-numbers language-console"><code class="language-console">brew install minicom openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Verify-the-installation"><a href="#Verify-the-installation" class="headerlink" title="Verify the installation"></a>Verify the installation</h2><p>Letâ€™s verify that all the tools were installed correctly.</p>
<h3 id="Linux-only"><a href="#Linux-only" class="headerlink" title="Linux only"></a>Linux only</h3><h4 id="Verify-permissions"><a href="#Verify-permissions" class="headerlink" title="Verify permissions"></a>Verify permissions</h4><p>Connect the STM32F3DISCOVERY to your computer using an USB cable. Be sure to connect the cable to the â€œUSB ST-LINKâ€ port, the USB port in the center of the edge of the board.</p>
<p>The STM32F3DISCOVERY should now appear as a USB device (file) in <code>/dev/bus/usb</code>. Letâ€™s find out how it got enumerated:</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb | grep -i stm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>This should result in:</p>
<pre class="line-numbers language-console"><code class="language-console">$ lsusb | grep -i stm
Bus 003 Device 004: ID 0483:374b STMicroelectronics ST-LINK/V2.1
$ # ^^^        ^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>In my case, the STM32F3DISCOVERY got connected to the bus #3 and got enumerated as the device #4. This means the file <code>/dev/bus/usb/003/004</code> <em>is</em> the STM32F3DISCOVERY. Letâ€™s check its permissions:</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -la /dev/bus/usb/003/004
crw-rw-rw-+ 1 root root 189, 259 Feb 28 13:32 /dev/bus/usb/003/00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>The permissions should be <code>crw-rw-rw-</code>. If itâ€™s not â€¦ then check your <a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">udev rules</a> and try re-loading them with:</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>For older devices with OPTIONAL USB &lt;-&gt; FT232 based Serial Module</strong></p>
<p>Unplug the STM32F3DISCOVERY and plug the Serial module. Now, figure out whatâ€™s its associated file:</p>
<pre class="line-numbers language-console"><code class="language-console">$ lsusb | grep -i ft232
Bus 003 Device 005: ID 0403:6001 Future Technology Devices International, Ltd FT232 Serial (UART) IC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>In my case, itâ€™s the <code>/dev/bus/usb/003/005</code>. Now, check its permissions:</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -l /dev/bus/usb/003/005
crw-rw-rw- 1 root root 189, 21 Sep 13 00:00 /dev/bus/usb/003/005<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>As before, the permissions should be <code>crw-rw-rw-</code>.</p>
<h3 id="Verify-OpenOCD-connection"><a href="#Verify-OpenOCD-connection" class="headerlink" title="Verify OpenOCD connection"></a>Verify OpenOCD connection</h3><p>Connect the STM32F3DISCOVERY using the USB cable to the USB port in the center of edge of the board, the one thatâ€™s labeled â€œUSB ST-LINKâ€.</p>
<p>Two <em>red</em> LEDs should turn on right after connecting the USB cable to the board.</p>
<blockquote>
<p><strong>IMPORTANT</strong> There is more than one hardware revision of the STM32F3DISCOVERY board. For older revisions, youâ€™ll need to change the â€œinterfaceâ€ argument to <code>-f interface/stlink-v2.cfg</code> (note: no <code>-1</code> at the end). Alternatively, older revisions can use <code>-f board/stm32f3discovery.cfg</code> instead of <code>-f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg</code>.</p>
</blockquote>
<blockquote>
<p><strong>NOTE</strong> OpenOCD v0.11.0 has deprecated <code>interface/stlink-v2.cfg</code> in favor of <code>interface/stlink.cfg</code> which supports ST-LINK/V1, ST-LINK/V2, ST-LINK/V2-1, and ST-LINK/V3.</p>
</blockquote>
<h4 id="Nix"><a href="#Nix" class="headerlink" title="*Nix"></a>*Nix</h4><blockquote>
<p><strong>FYI:</strong> The <code>interface</code> directory is typically located in <code>/usr/share/openocd/scripts/</code>, which is the default location OpenOCD expects these files. If youâ€™ve installed them somewhere else use the <code>-s /path/to/scripts/</code> option to specify your install directory.</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>or</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Windows-2"><a href="#Windows-2" class="headerlink" title="Windows"></a>Windows</h4><p>Below the references to <code>C:\OpenOCD</code> is the directory where OpenOCD is installed.</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -s C:\OpenOCD\share\scripts -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>NOTE</strong> cygwin users have reported problems with the -s flag. If you run into that problem you can add <code>C:\OpenOCD\share\scripts\</code> directory to the parameters.</p>
</blockquote>
<p>cygwin users:</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f C:\OpenOCD\share\scripts\interface\stlink-v2-1.cfg -f C:\OpenOCD\share\scripts\target\stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="All"><a href="#All" class="headerlink" title="All"></a>All</h4><p>OpenOCD is a service which forwards debug information from the ITM channel to a file, <code>itm.txt</code>, as such it runs forever and does <strong>not</strong> return to the terminal prompt.</p>
<p>The initial output of OpenOCD is something like:</p>
<pre class="line-numbers language-console"><code class="language-console">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.915608
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>(If you donâ€™t â€¦ then check the <a href="https://docs.rust-embedded.org/discovery/appendix/1-general-troubleshooting/index.html" target="_blank" rel="noopener">general troubleshooting</a> instructions.)</p>
<p>Also, one of the red LEDs, the one closest to the USB port, should start oscillating between red light and green light.</p>
<p>Thatâ€™s it! It works. You can now use <code>Ctrl-c</code> to stop OpenOCD or close/kill the terminal.</p>
<h1 id="Meet-your-hardware"><a href="#Meet-your-hardware" class="headerlink" title="Meet your hardware"></a>Meet your hardware</h1><h2 id="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰-1"><a href="#STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰-1" class="headerlink" title="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰"></a>STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰</h2><p><img src="/images/loading.gif" data-original="../images/language/f3-163136334180811.jpg" alt=""></p>
<p>æˆ‘ä»¬å°†åœ¨æ•´æœ¬ä¹¦ä¸­å°†æ­¤æ¿ç§°ä¸ºâ€œF3â€ã€‚ä»¥ä¸‹æ˜¯æ¿ä¸Šçš„è®¸å¤šç»„ä»¶ä¸­çš„ä¸€äº›ï¼š</p>
<ul>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Microcontroller" target="_blank" rel="noopener">å¾®æ§åˆ¶å™¨</a>ã€‚</li>
<li>è®¸å¤š LEDï¼ŒåŒ…æ‹¬ä»¥â€œæŒ‡å—é’ˆâ€å½¢å¼æ’åˆ—çš„å…«ä¸ª LEDã€‚</li>
<li>ä¸¤ä¸ªæŒ‰é’®ã€‚</li>
<li>ä¸¤ä¸ª USB ç«¯å£ã€‚</li>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">åŠ é€Ÿåº¦è®¡</a>ã€‚</li>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">ç£åŠ›è®¡</a>ã€‚</li>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">é™€èºä»ª</a>ã€‚</li>
</ul>
<p>åœ¨è¿™äº›ç»„ä»¶ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯å¾®æ§åˆ¶å™¨ï¼ˆæœ‰æ—¶ç¼©å†™ä¸ºâ€œMCUâ€ä»£è¡¨â€œå¾®æ§åˆ¶å™¨å•å…ƒâ€ï¼‰ï¼Œå®ƒæ˜¯ä½äºç”µè·¯æ¿ä¸­å¿ƒçš„é»‘è‰²å¤§æ–¹å—ã€‚MCU è¿è¡Œæ‚¨çš„ä»£ç ã€‚æ‚¨æœ‰æ—¶å¯èƒ½ä¼šè¯»åˆ°â€œå¯¹ç”µè·¯æ¿è¿›è¡Œç¼–ç¨‹â€ï¼Œè€Œå®é™…ä¸Šæˆ‘ä»¬æ‰€åšçš„æ˜¯å¯¹å®‰è£…åœ¨ç”µè·¯æ¿ä¸Šçš„ MCU è¿›è¡Œç¼–ç¨‹ã€‚</p>
<h2 id="STM32F303VCT6ï¼ˆâ€œSTM32F3â€ï¼‰"><a href="#STM32F303VCT6ï¼ˆâ€œSTM32F3â€ï¼‰" class="headerlink" title="STM32F303VCT6ï¼ˆâ€œSTM32F3â€ï¼‰"></a>STM32F303VCT6ï¼ˆâ€œSTM32F3â€ï¼‰</h2><p>ç”±äº MCU å¦‚æ­¤é‡è¦ï¼Œè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ååœ¨æˆ‘ä»¬æ¿ä¸Šçš„é‚£ä¸ªã€‚</p>
<p>æˆ‘ä»¬çš„ MCU è¢« 100 ä¸ªå¾®å°çš„é‡‘å±<strong>å¼•è„š</strong>åŒ…å›´ç€ã€‚è¿™äº›å¼•è„šè¿æ¥åˆ° <strong>è¿¹çº¿</strong>ï¼Œè¿™äº›å°â€œé“è·¯â€å……å½“å°†ç”µè·¯æ¿ä¸Šçš„ç»„ä»¶è¿æ¥åœ¨ä¸€èµ·çš„ç”µçº¿ã€‚MCU å¯ä»¥åŠ¨æ€æ”¹å˜å¼•è„šçš„ç”µæ°”ç‰¹æ€§ã€‚è¿™ç±»ä¼¼äºæ”¹å˜ç”µæµæµç»ç”µè·¯çš„ç”µç¯å¼€å…³ã€‚é€šè¿‡å¯ç”¨æˆ–ç¦ç”¨æµè¿‡ç‰¹å®šå¼•è„šçš„ç”µæµï¼Œå¯ä»¥æ‰“å¼€å’Œå…³é—­è¿æ¥åˆ°è¯¥å¼•è„šï¼ˆé€šè¿‡èµ°çº¿ï¼‰çš„ LEDã€‚</p>
<p>æ¯ä¸ªåˆ¶é€ å•†ä½¿ç”¨ä¸åŒçš„é›¶ä»¶ç¼–å·æ–¹æ¡ˆï¼Œä½†è®¸å¤šåˆ¶é€ å•†å…è®¸æ‚¨é€šè¿‡æŸ¥çœ‹é›¶ä»¶ç¼–å·æ¥ç¡®å®šæœ‰å…³ç»„ä»¶çš„ä¿¡æ¯ã€‚æŸ¥çœ‹æˆ‘ä»¬ MCU çš„éƒ¨ä»¶å· ( <code>STM32F303VCT6</code>)ï¼Œ<code>ST</code>å‰é¢çš„ å‘æˆ‘ä»¬æš—ç¤ºè¿™æ˜¯ç”±<a href="https://st.com/" target="_blank" rel="noopener">ST Microelectronics</a>åˆ¶é€ çš„éƒ¨ä»¶ã€‚é€šè¿‡æœç´¢<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32-mainstream-mcus.html" target="_blank" rel="noopener">ST çš„è¥é”€ææ–™ï¼Œ</a>æˆ‘ä»¬è¿˜å¯ä»¥äº†è§£åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>çš„<code>M32</code>è¡¨ç¤ºï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºARMÂ®çš„32ä½å¾®æ§åˆ¶å™¨ã€‚</li>
<li>è¯¥<code>F3</code>ä»£è¡¨çš„MCUæ˜¯STçš„â€œSTM32F3ç³»åˆ—â€ã€‚è¿™æ˜¯ä¸€ç³»åˆ—åŸºäº CortexÂ®-M4 å¤„ç†å™¨è®¾è®¡çš„ MCUã€‚</li>
<li>éƒ¨ä»¶å·çš„å…¶ä½™éƒ¨åˆ†è¯¦ç»†ä»‹ç»äº†é¢å¤–åŠŸèƒ½å’Œ RAM å¤§å°ç­‰å†…å®¹ï¼Œç›®å‰æˆ‘ä»¬ä¸å¤ªå…³å¿ƒè¿™äº›ã€‚</li>
</ul>
<blockquote>
<h3 id="Arm-Cortex-M4"><a href="#Arm-Cortex-M4" class="headerlink" title="Arm? Cortex-M4?"></a>Arm? Cortex-M4?</h3><p>å¦‚æœæˆ‘ä»¬çš„èŠ¯ç‰‡æ˜¯ ST åˆ¶é€ çš„ï¼Œé‚£ä¹ˆ Arm æ˜¯è°ï¼Ÿå¦‚æœæˆ‘ä»¬çš„èŠ¯ç‰‡æ˜¯ STM32F3ï¼Œé‚£ä¹ˆ Cortex-M4 æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æ‚¨å¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°ï¼Œè™½ç„¶â€œåŸºäº Armâ€çš„èŠ¯ç‰‡éå¸¸å—æ¬¢è¿ï¼Œä½†â€œArmâ€å•†æ ‡èƒŒåçš„å…¬å¸ ( <a href="https://www.arm.com/" target="_blank" rel="noopener">Arm Holdings</a> ) å®é™…ä¸Šå¹¶ä¸åˆ¶é€ ç”¨äºè´­ä¹°çš„èŠ¯ç‰‡ã€‚ç›¸åï¼Œä»–ä»¬çš„ä¸»è¦å•†ä¸šæ¨¡å¼åªæ˜¯<em>è®¾è®¡</em>èŠ¯ç‰‡çš„ä¸€éƒ¨åˆ†ã€‚ç„¶åï¼Œä»–ä»¬ä¼šå°†è¿™äº›è®¾è®¡æˆæƒç»™åˆ¶é€ å•†ï¼Œåˆ¶é€ å•†åˆä¼šä»¥ç‰©ç†ç¡¬ä»¶çš„å½¢å¼å®æ–½è¿™äº›è®¾è®¡ï¼ˆä¹Ÿè®¸é€šè¿‡ä»–ä»¬è‡ªå·±çš„ä¸€äº›è°ƒæ•´ï¼‰ç„¶åå¯ä»¥å‡ºå”®ã€‚ARM åœ¨è¿™é‡Œçš„æˆ˜ç•¥ä¸è‹±ç‰¹å°”ç­‰å…¬å¸ä¸åŒï¼Œåè€…æ—¢è®¾è®¡<em>åˆ</em>åˆ¶é€ èŠ¯ç‰‡ã€‚</p>
<p>Arm è®¸å¯äº†ä¸€ç³»åˆ—ä¸åŒçš„è®¾è®¡ã€‚ä»–ä»¬çš„â€œCortex-Mâ€ç³»åˆ—è®¾è®¡ä¸»è¦ç”¨ä½œå¾®æ§åˆ¶å™¨çš„æ ¸å¿ƒã€‚ä¾‹å¦‚ï¼ŒCortex-M0 ä¸“ä¸ºä½æˆæœ¬å’Œä½åŠŸè€—è€Œè®¾è®¡ã€‚Cortex-M7 æˆæœ¬æ›´é«˜ï¼Œä½†å…·æœ‰æ›´å¤šåŠŸèƒ½å’Œæ€§èƒ½ã€‚æˆ‘ä»¬çš„ STM32F3 çš„æ ¸å¿ƒæ˜¯åŸºäº Cortex-M4ï¼Œå®ƒå¤„äºä¸­é—´ï¼šæ¯” Cortex-M0 çš„åŠŸèƒ½å’Œæ€§èƒ½æ›´å¤šï¼Œä½†æ¯” Cortex-M7 ä¾¿å®œã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæ‚¨ä¸éœ€è¦ä¸ºäº†æœ¬ä¹¦è€Œå¯¹ä¸åŒç±»å‹çš„å¤„ç†å™¨æˆ– Cortex è®¾è®¡äº†è§£å¤ªå¤šã€‚ä½†æ˜¯ï¼Œå¸Œæœ›æ‚¨ç°åœ¨å¯¹è®¾å¤‡çš„æœ¯è¯­æœ‰äº†æ›´å¤šäº†è§£ã€‚å½“æ‚¨ä¸“é—¨ä½¿ç”¨ STM32F3 æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°è‡ªå·±æ­£åœ¨é˜…è¯»æ–‡æ¡£å¹¶ä½¿ç”¨åŸºäº Cortex-M çš„èŠ¯ç‰‡çš„å·¥å…·ï¼Œå› ä¸º STM32F3 åŸºäº Cortex-M è®¾è®¡ã€‚</p>
</blockquote>
<h2 id="ä¸²è¡Œæ¨¡å—"><a href="#ä¸²è¡Œæ¨¡å—" class="headerlink" title="ä¸²è¡Œæ¨¡å—"></a>ä¸²è¡Œæ¨¡å—</h2><p><img src="/images/loading.gif" data-original="../images/language/serial-163136334180813.jpg" alt=""></p>
<p>å¦‚æœæ‚¨æœ‰æ—§ç‰ˆæœ¬çš„å‘ç°æ¿ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤æ¨¡å—åœ¨ F3 ä¸­çš„å¾®æ§åˆ¶å™¨å’Œæ‚¨çš„è®¡ç®—æœºä¹‹é—´äº¤æ¢æ•°æ®ã€‚è¯¥æ¨¡å—å°†ä½¿ç”¨ USB ç”µç¼†è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºã€‚è¿™ä¸ªæ—¶å€™æˆ‘å°±ä¸å¤šè¯´äº†ã€‚</p>
<p>å¦‚æœæ‚¨æœ‰è¾ƒæ–°ç‰ˆæœ¬çš„ç”µè·¯æ¿ï¼Œåˆ™ä¸éœ€è¦æ­¤æ¨¡å—ã€‚ST-LINK å°†å…¼ä½œ USB&lt;-&gt; ä¸²è¡Œè½¬æ¢å™¨ï¼Œé€šè¿‡ PC4 å’Œ PC5 å¼•è„šè¿æ¥åˆ°å¾®æ§åˆ¶å™¨ USART1ã€‚</p>
<h2 id="è“ç‰™æ¨¡å—"><a href="#è“ç‰™æ¨¡å—" class="headerlink" title="è“ç‰™æ¨¡å—"></a>è“ç‰™æ¨¡å—</h2><p><img src="/images/loading.gif" data-original="../images/language/bluetooth-163136334180915.jpg" alt=""></p>
<p>è¯¥æ¨¡å—ä¸ä¸²è¡Œæ¨¡å—çš„ç”¨é€”å®Œå…¨ç›¸åŒï¼Œä½†å®ƒé€šè¿‡è“ç‰™è€Œä¸æ˜¯ USB å‘é€æ•°æ®ã€‚</p>
<h1 id="LED-rouletteï¼ˆè½®ç›˜ï¼‰"><a href="#LED-rouletteï¼ˆè½®ç›˜ï¼‰" class="headerlink" title="LED rouletteï¼ˆè½®ç›˜ï¼‰"></a>LED rouletteï¼ˆè½®ç›˜ï¼‰</h1><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»æ„å»ºä»¥ä¸‹åº”ç”¨ç¨‹åºå¼€å§‹ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/0k1r2Lc.gif" alt=""></p>
<p>æˆ‘å°†ç»™ä½ ä¸€ä¸ªé«˜çº§ API æ¥å®ç°è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†åˆ«æ‹…å¿ƒæˆ‘ä»¬ç¨åä¼šåšä½çº§çš„ä¸œè¥¿ã€‚æœ¬ç« çš„ä¸»è¦ç›®æ ‡æ˜¯ç†Ÿæ‚‰<em>åˆ·æœº</em>å’Œè°ƒè¯•è¿‡ç¨‹ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://github.com/rust-embedded/discovery" target="_blank" rel="noopener">å‘ç°</a>å­˜å‚¨åº“ä¸­çš„å…¥é—¨ä»£ç ã€‚ç¡®ä¿æ‚¨å§‹ç»ˆæ‹¥æœ‰æœ€æ–°ç‰ˆæœ¬çš„ master åˆ†æ”¯ï¼Œå› ä¸ºè¯¥ç½‘ç«™ä¼šè·Ÿè¸ªè¯¥åˆ†æ”¯ã€‚</p>
<p>èµ·å§‹ä»£ç ä½äºè¯¥<code>src</code>å­˜å‚¨åº“çš„ç›®å½•ä¸­ã€‚åœ¨è¯¥ç›®å½•ä¸­ï¼Œè¿˜æœ‰æ›´å¤šä»¥æœ¬ä¹¦æ¯ä¸€ç« å‘½åçš„ç›®å½•ã€‚è¿™äº›ç›®å½•ä¸­çš„å¤§å¤šæ•°æ˜¯å…¥é—¨ Cargo é¡¹ç›®ã€‚</p>
<p>ç°åœ¨ï¼Œè·³è½¬åˆ°<code>src/05-led-roulette</code>ç›®å½•ã€‚æ£€æŸ¥<code>src/main.rs</code>æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// infinite loop; just so we don't leave this stack frame</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¾®æ§åˆ¶å™¨ç¨‹åºåœ¨ä¸¤ä¸ªæ–¹é¢ä¸åŒäºæ ‡å‡†ç¨‹åºï¼š<code>#![no_std]</code>å’Œ <code>#![no_main]</code>ã€‚</p>
<p>è¯¥<code>no_std</code>å±æ€§è¡¨ç¤ºè¯¥ç¨‹åºä¸ä¼šä½¿ç”¨<code>std</code>crateï¼Œå®ƒå‡å®šä¸€ä¸ªåº•å±‚æ“ä½œç³»ç»Ÿï¼›è¯¥ç¨‹åºå°†æ”¹ä¸ºä½¿ç”¨<code>core</code>crateï¼Œå®ƒçš„ä¸€ä¸ªå­é›†<code>std</code>å¯ä»¥åœ¨è£¸æœºç³»ç»Ÿä¸Šè¿è¡Œï¼ˆå³ï¼Œæ²¡æœ‰åƒæ–‡ä»¶å’Œå¥—æ¥å­—è¿™æ ·çš„æ“ä½œç³»ç»ŸæŠ½è±¡çš„ç³»ç»Ÿï¼‰ã€‚</p>
<p>è¯¥<code>no_main</code>å±æ€§è¡¨ç¤ºè¯¥ç¨‹åºä¸ä¼šä½¿ç”¨æ ‡å‡†<code>main</code>æ¥å£ï¼Œè¯¥æ¥å£æ˜¯ä¸ºæ¥æ”¶å‚æ•°çš„å‘½ä»¤è¡Œåº”ç”¨ç¨‹åºé‡èº«å®šåˆ¶çš„ã€‚<code>main</code>æˆ‘ä»¬å°†ä½¿ç”¨crate ä¸­çš„<code>entry</code>å±æ€§<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>æ¥å®šä¹‰è‡ªå®šä¹‰å…¥å£ç‚¹ï¼Œè€Œä¸æ˜¯æ ‡å‡†ã€‚åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†å…¥å£ç‚¹å‘½åä¸ºâ€œmainâ€ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–åç§°ã€‚å…¥å£ç‚¹å‡½æ•°å¿…é¡»æœ‰ç­¾å<code>fn() -&gt; !</code>ï¼›è¿™ç§ç±»å‹è¡¨ç¤ºå‡½æ•°ä¸èƒ½è¿”å›â€”â€”è¿™æ„å‘³ç€ç¨‹åºæ°¸è¿œä¸ä¼šç»ˆæ­¢ã€‚</p>
<p>å¦‚æœæ‚¨ç»†å¿ƒè§‚å¯Ÿï¼Œæ‚¨è¿˜ä¼šæ³¨æ„åˆ°<code>.cargo</code>Cargo é¡¹ç›®ä¸­ä¹Ÿæœ‰ä¸€ä¸ªç›®å½•ã€‚è¯¥ç›®å½•åŒ…å«ä¸€ä¸ª Cargo é…ç½®æ–‡ä»¶ ( <code>.cargo/config</code>)ï¼Œå®ƒè°ƒæ•´é“¾æ¥è¿‡ç¨‹ä»¥æ ¹æ®ç›®æ ‡è®¾å¤‡çš„è¦æ±‚å®šåˆ¶ç¨‹åºçš„å†…å­˜å¸ƒå±€ã€‚è¿™ç§ä¿®æ”¹åçš„é“¾æ¥è¿‡ç¨‹æ˜¯<code>cortex-m-rt</code>æ¿æ¡ç®±çš„è¦æ±‚ã€‚æ‚¨è¿˜å°†<code>.cargo/config</code>åœ¨ä»¥åçš„éƒ¨åˆ†ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„è°ƒæ•´ï¼Œä»¥ä½¿æ„å»ºå’Œè°ƒè¯•æ›´å®¹æ˜“ã€‚</p>
<p>å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»æ„å»ºè¿™ä¸ªç¨‹åºå¼€å§‹ã€‚</p>
<h2 id="Build-it"><a href="#Build-it" class="headerlink" title="Build it"></a>Build it</h2><p>ç¬¬ä¸€æ­¥æ˜¯æ„å»ºæˆ‘ä»¬çš„â€œäºŒè¿›åˆ¶â€æ¿æ¡ç®±ã€‚å› ä¸ºå¾®æ§åˆ¶å™¨çš„æ¶æ„ä¸æ‚¨çš„è®¡ç®—æœºä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚åœ¨ Rust ä¸­äº¤å‰ç¼–è¯‘å°±åƒ<code>--target</code>å‘<code>rustc</code>æˆ– Cargoä¼ é€’ä¸€ä¸ªé¢å¤–çš„æ ‡å¿—ä¸€æ ·ç®€å•ã€‚å¤æ‚çš„éƒ¨åˆ†æ˜¯æ‰¾å‡ºè¯¥æ ‡å¿—çš„å‚æ•°ï¼šç›®æ ‡çš„<em>åç§°</em>ã€‚</p>
<p>F3 ä¸­çš„å¾®æ§åˆ¶å™¨ä¸­æœ‰ä¸€ä¸ª Cortex-M4F å¤„ç†å™¨ã€‚<code>rustc</code>çŸ¥é“å¦‚ä½•äº¤å‰ç¼–è¯‘åˆ° Cortex-M æ¶æ„ï¼Œå¹¶æä¾› 4 ä¸ªä¸åŒçš„ç›®æ ‡ï¼Œæ¶µç›–è¯¥æ¶æ„ä¸­çš„ä¸åŒå¤„ç†å™¨ç³»åˆ—ï¼š</p>
<ul>
<li><code>thumbv6m-none-eabi</code>, å¯¹äº Cortex-M0 å’Œ Cortex-M1 å¤„ç†å™¨</li>
<li><code>thumbv7m-none-eabi</code>, å¯¹äº Cortex-M3 å¤„ç†å™¨</li>
<li><code>thumbv7em-none-eabi</code>, é€‚ç”¨äº Cortex-M4 å’Œ Cortex-M7 å¤„ç†å™¨</li>
<li><code>thumbv7em-none-eabihf</code>, å¯¹äº Cortex-M4 <strong>F</strong>å’Œ Cortex-M7 <strong>F</strong>å¤„ç†å™¨</li>
</ul>
<p>å¯¹äº F3ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>thumbv7em-none-eabihf</code>ç›®æ ‡ã€‚åœ¨äº¤å‰ç¼–è¯‘ä¹‹å‰ï¼Œæ‚¨å¿…é¡»ä¸ºæ‚¨çš„ç›®æ ‡ä¸‹è½½æ ‡å‡†åº“çš„é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆå®é™…ä¸Šæ˜¯å®ƒçš„ç®€åŒ–ç‰ˆæœ¬ï¼‰ã€‚è¿™æ˜¯ä½¿ç”¨<code>rustup</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ‚¨åªéœ€è¦æ‰§è¡Œä¸Šè¿°æ­¥éª¤ä¸€æ¬¡ï¼›æ¯å½“æ‚¨æ›´æ–°å·¥å…·é“¾æ—¶ï¼Œ<code>rustup</code>éƒ½ä¼šé‡æ–°å®‰è£…æ–°çš„æ ‡å‡†åº“ï¼ˆ<code>rust-std</code>ç»„ä»¶ï¼‰ã€‚</p>
<p>éšç€<code>rust-std</code>åˆ°ä½ç»„ä»¶ä½¿ç”¨è´§è¿æ‚¨ç°åœ¨å¯ä»¥äº¤å‰ç¼–è¯‘ç¨‹åºã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ç¡®ä¿æ‚¨åœ¨<code>src/05-led-roulette</code>ç›®å½•ä¸­å¹¶è¿è¡Œ<code>cargo build</code>ä»¥ä¸‹å‘½ä»¤ä»¥åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åœ¨æ‚¨çš„æ§åˆ¶å°ä¸Šï¼Œæ‚¨åº”è¯¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build --target thumbv7em-none-eabihf
   Compiling typenum v1.12.0
   Compiling semver-parser v0.7.0
   Compiling version_check v0.9.2
   Compiling nb v1.0.0
   Compiling void v1.0.2
   Compiling autocfg v1.0.1
   Compiling cortex-m v0.7.1
   Compiling proc-macro2 v1.0.24
   Compiling vcell v0.1.3
   Compiling unicode-xid v0.2.1
   Compiling stable_deref_trait v1.2.0
   Compiling syn v1.0.60
   Compiling bitfield v0.13.2
   Compiling cortex-m v0.6.7
   Compiling cortex-m-rt v0.6.13
   Compiling r0 v0.2.2
   Compiling stm32-usbd v0.5.1
   Compiling stm32f3 v0.12.1
   Compiling usb-device v0.2.7
   Compiling cfg-if v1.0.0
   Compiling paste v1.0.4
   Compiling stm32f3-discovery v0.6.0
   Compiling embedded-dma v0.1.2
   Compiling volatile-register v0.2.0
   Compiling nb v0.1.3
   Compiling embedded-hal v0.2.4
   Compiling semver v0.9.0
   Compiling generic-array v0.14.4
   Compiling switch-hal v0.3.2
   Compiling num-traits v0.2.14
   Compiling num-integer v0.1.44
   Compiling rustc_version v0.2.3
   Compiling bare-metal v0.2.5
   Compiling cast v0.2.3
   Compiling quote v1.0.9
   Compiling generic-array v0.13.2
   Compiling generic-array v0.12.3
   Compiling generic-array v0.11.1
   Compiling panic-itm v0.4.2
   Compiling lsm303dlhc v0.2.0
   Compiling as-slice v0.1.4
   Compiling micromath v1.1.0
   Compiling accelerometer v0.12.0
   Compiling chrono v0.4.19
   Compiling aligned v0.3.4
   Compiling rtcc v0.2.0
   Compiling cortex-m-rt-macros v0.1.8
   Compiling stm32f3xx-hal v0.6.1
   Compiling aux5 v0.2.0 (~/embedded-discovery/src/05-led-roulette/auxiliary)
   Compiling led-roulette v0.2.0 (~/embedded-discovery/src/05-led-roulette)
    Finished dev [unoptimized + debuginfo] target(s) in 17.91s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ä¸€å®šè¦åœ¨<em>æ²¡æœ‰</em>ä¼˜åŒ–çš„<em>æƒ…å†µä¸‹</em>ç¼–è¯‘è¿™ä¸ª crate ã€‚ä¸Šé¢æä¾›çš„ Cargo.toml æ–‡ä»¶å’Œæ„å»ºå‘½ä»¤å°†ç¡®ä¿ä¼˜åŒ–å…³é—­ã€‚</p>
</blockquote>
<p>å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸ä¼šä½¿ä»»ä½• LED é—ªçƒï¼Œå®ƒåªæ˜¯æˆ‘ä»¬å°†åœ¨æœ¬ç« åé¢æ„å»ºçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ã€‚ä½œä¸ºå®Œæ•´æ€§æ£€æŸ¥ï¼Œè®©æˆ‘ä»¬éªŒè¯ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ ARM äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --target thumbv7em-none-eabihf --bin led-roulette -- --file-header<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åœ¨<code>cargo readobj ..</code>ä¸Šè¿°ç›¸å½“äº <code>readelf -h target/thumbv7em-none-eabihf/debug/led-roulette</code> è€Œä¸”åº”è¯¥äº§ç”Ÿç±»ä¼¼çš„ä¸œè¥¿ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo readobj --target thumbv7em-none-eabihf --bin led-roulette -- --file-header
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x8000195
  Start of program headers:          52 (bytes into file)
  Start of section headers:          818328 (bytes into file)
  Flags:                             0x5000400
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         4
  Size of section headers:           40 (bytes)
  Number of section headers:         22
  Section header string table index: 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠç¨‹åºçƒ§å†™åˆ°æˆ‘ä»¬çš„å¾®æ§åˆ¶å™¨ä¸­ã€‚</p>
<h2 id="Flash-it"><a href="#Flash-it" class="headerlink" title="Flash it"></a>Flash it</h2><p>é—ªå­˜æ˜¯å°†æˆ‘ä»¬çš„ç¨‹åºç§»åŠ¨åˆ°å¾®æ§åˆ¶å™¨ï¼ˆæŒä¹…æ€§ï¼‰å†…å­˜ä¸­çš„è¿‡ç¨‹ã€‚ä¸€æ—¦åˆ·å…¥ï¼Œå¾®æ§åˆ¶å™¨æ¯æ¬¡ä¸Šç”µéƒ½ä¼šæ‰§è¡Œåˆ·å…¥çš„ç¨‹åºã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„<code>led-roulette</code>ç¨‹åºå°†æ˜¯å¾®æ§åˆ¶å™¨å­˜å‚¨å™¨ä¸­çš„<em>å”¯ä¸€</em>ç¨‹åºã€‚æˆ‘çš„æ„æ€æ˜¯å¾®æ§åˆ¶å™¨ä¸Šæ²¡æœ‰å…¶ä»–ä¸œè¥¿åœ¨è¿è¡Œï¼šæ²¡æœ‰æ“ä½œç³»ç»Ÿï¼Œæ²¡æœ‰â€œå®ˆæŠ¤è¿›ç¨‹â€ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚<code>led-roulette</code>å¯ä»¥å®Œå…¨æ§åˆ¶è®¾å¤‡ã€‚</p>
<p>è¿›å…¥å®é™…é—ªçƒã€‚æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å¯åŠ¨ OpenOCDã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­è¿™æ ·åšäº†ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬å°†åœ¨ä¸´æ—¶ç›®å½•ä¸­è¿è¡Œå‘½ä»¤ï¼ˆ<code>/tmp</code>åœ¨ *nix ä¸Šï¼› <code>%TEMP%</code>åœ¨ Windows ä¸Šï¼‰ã€‚</p>
<p>ç¡®ä¿ F3 å·²è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºå¹¶åœ¨<strong>æ–°ç»ˆç«¯ä¸­</strong>è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p>
<h3 id="å¯¹äº-nix-å’Œ-MacOSï¼š"><a href="#å¯¹äº-nix-å’Œ-MacOSï¼š" class="headerlink" title="å¯¹äº *nix å’Œ MacOSï¼š"></a>å¯¹äº *nix å’Œ MacOSï¼š</h3><pre class="line-numbers language-console"><code class="language-console">cd /tmp
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="å¯¹äº-Windowsæ³¨æ„ï¼šæ›¿æ¢C-å®é™…çš„-OpenOCD-è·¯å¾„ï¼š"><a href="#å¯¹äº-Windowsæ³¨æ„ï¼šæ›¿æ¢C-å®é™…çš„-OpenOCD-è·¯å¾„ï¼š" class="headerlink" title="å¯¹äº Windowsæ³¨æ„ï¼šæ›¿æ¢C:å®é™…çš„ OpenOCD è·¯å¾„ï¼š"></a>å¯¹äº Windows<strong>æ³¨æ„</strong>ï¼šæ›¿æ¢<code>C:</code>å®é™…çš„ OpenOCD è·¯å¾„ï¼š</h3><pre><code>cd %TEMP%
openocd -s C:\share\scripts -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg</code></pre><blockquote>
<p><strong>æ³¨æ„</strong>ç”µè·¯æ¿çš„è¾ƒæ—§ç‰ˆæœ¬éœ€è¦å°†ç¨å¾®ä¸åŒçš„å‚æ•°ä¼ é€’ç»™ <code>openocd</code>ã€‚</p>
</blockquote>
<p>ç¨‹åºä¼šé˜»å¡ï¼›è®©é‚£ä¸ªç»ˆç«¯ä¿æŒæ‰“å¼€çŠ¶æ€ã€‚</p>
<p>ç°åœ¨æ˜¯è§£é‡Šè¯¥<code>openocd</code>å‘½ä»¤å®é™…æ‰§è¡Œçš„æ“ä½œçš„å¥½æ—¶æœºã€‚</p>
<p>æˆ‘æåˆ° STM32F3DISCOVERYï¼ˆåˆå F3ï¼‰å®é™…ä¸Šæœ‰ä¸¤ä¸ªå¾®æ§åˆ¶å™¨ã€‚å…¶ä¸­ä¹‹ä¸€ç”¨ä½œç¨‹åºå‘˜/è°ƒè¯•å™¨ã€‚ç”¨ä½œç¼–ç¨‹å™¨çš„ç”µè·¯æ¿éƒ¨åˆ†ç§°ä¸º ST-LINKï¼ˆæ„æ³•åŠå¯¼ä½“å†³å®šè¿™æ ·ç§°å‘¼å®ƒï¼‰ã€‚æ­¤ ST-LINK ä½¿ç”¨ä¸²è¡Œçº¿è°ƒè¯• (SWD) æ¥å£è¿æ¥åˆ°ç›®æ ‡å¾®æ§åˆ¶å™¨ï¼ˆæ­¤æ¥å£æ˜¯ ARM æ ‡å‡†ï¼Œå› æ­¤åœ¨å¤„ç†å…¶ä»–åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨æ—¶ä¼šé‡åˆ°å®ƒï¼‰ã€‚è¯¥ SWD æ¥å£å¯ç”¨äºé—ªå­˜å’Œè°ƒè¯•å¾®æ§åˆ¶å™¨ã€‚ST-LINK è¿æ¥åˆ°â€œUSB ST-LINKâ€ç«¯å£ï¼Œå½“æ‚¨å°† F3 è¿æ¥åˆ°è®¡ç®—æœºæ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºä¸º USB è®¾å¤‡ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/st-link.png" alt=""></p>
<p>è‡³äº OpenOCDï¼Œå®ƒæ˜¯ä¸€ç§æä¾›ä¸€äº›æœåŠ¡çš„è½¯ä»¶ï¼Œä¾‹å¦‚åœ¨ USB è®¾å¤‡ä¸Šæä¾›ä¸€äº›æœåŠ¡ï¼Œä¾‹å¦‚å…¬å¼€ SWD æˆ– JTAG ç­‰è°ƒè¯•åè®®çš„<em>GDB æœåŠ¡å™¨</em>ã€‚</p>
<p>å…³äºå®é™…å‘½ä»¤ï¼š<code>.cfg</code>æˆ‘ä»¬ä½¿ç”¨çš„é‚£äº›æ–‡ä»¶æŒ‡ç¤º OpenOCD æŸ¥æ‰¾ ST-LINK USB è®¾å¤‡ ( <code>interface/stlink-v2-1.cfg</code>) å¹¶æœŸæœ› STM32F3XX å¾®æ§åˆ¶å™¨ ( <code>target/stm32f3x.cfg</code>) è¿æ¥åˆ° ST-LINKã€‚</p>
<p>OpenOCD è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v37 API v2 SWIM v26 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.888183
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>â€œ6 ä¸ªæ–­ç‚¹ï¼Œ4 ä¸ªè§‚å¯Ÿç‚¹â€éƒ¨åˆ†è¡¨ç¤ºå¤„ç†å™¨å¯ç”¨çš„è°ƒè¯•åŠŸèƒ½ã€‚</p>
<p>ä¿æŒè¯¥<code>openocd</code>è¿›ç¨‹è¿è¡Œï¼Œå¹¶åœ¨å‰ä¸€ä¸ªç»ˆç«¯æˆ–æ–°ç»ˆç«¯ä¸­ <strong>ç¡®ä¿æ‚¨ä½äºé¡¹ç›®<code>src/05-led-roulette/</code>ç›®å½•ä¸­</strong>ã€‚</p>
<p>æˆ‘æåˆ° OpenOCD æä¾›äº†ä¸€ä¸ª GDB æœåŠ¡å™¨ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç°åœ¨è¿æ¥åˆ°å®ƒï¼š</p>
<h3 id="æ‰§è¡Œ-GDB"><a href="#æ‰§è¡Œ-GDB" class="headerlink" title="æ‰§è¡Œ GDB"></a>æ‰§è¡Œ GDB</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š<code>gdb</code>æ‚¨çš„å“ªä¸ªç‰ˆæœ¬èƒ½å¤Ÿè°ƒè¯• ARM äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>è¿™å¯ä»¥æ˜¯ä»¥ä¸‹ä»»ä¸€å‘½ä»¤ï¼Œè¯·å°è¯•æ¯ä¸€ä¸ªï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
gdb-multiarch -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="å¤±è´¥æ¡ˆä¾‹"><a href="#å¤±è´¥æ¡ˆä¾‹" class="headerlink" title="å¤±è´¥æ¡ˆä¾‹"></a><strong>å¤±è´¥æ¡ˆä¾‹</strong></h4><p>å¦‚æœæœ‰<code>warning</code>æˆ–<code>error</code>åœ¨è¯¥<code>Remote debugging using :3333</code>è¡Œä¹‹åï¼Œæ‚¨å¯ä»¥æ£€æµ‹åˆ°å¤±è´¥æ¡ˆä¾‹ï¼š</p>
<pre><code>$ gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
warning: Architecture rejected target-supplied description
Truncated register 16 in remote 'g' packet
(gdb)</code></pre><h4 id="æˆåŠŸæ¡ˆä¾‹"><a href="#æˆåŠŸæ¡ˆä¾‹" class="headerlink" title="æˆåŠŸæ¡ˆä¾‹"></a><strong>æˆåŠŸæ¡ˆä¾‹</strong></h4><p>æˆåŠŸæ¡ˆä¾‹ä¸€ï¼š</p>
<pre><code>$ arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
cortex_m_rt::Reset () at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:497
497     pub unsafe extern "C" fn Reset() -&gt; ! {
(gdb)</code></pre><p>æˆåŠŸæ¡ˆä¾‹2ï¼š</p>
<pre><code>~/embedded-discovery/src/05-led-roulette (master)
$ arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
0x00000000 in ?? ()
(gdb)</code></pre><p>åœ¨å¤±è´¥å’ŒæˆåŠŸçš„æƒ…å†µä¸‹ï¼Œæ‚¨éƒ½åº”è¯¥åœ¨<strong>OpenOCD ç»ˆç«¯ä¸­</strong>çœ‹åˆ°æ–°çš„è¾“å‡ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints
<span class="token inserted">+Info : accepting 'gdb' connection on tcp/3333</span>
<span class="token inserted">+Info : device id = 0x10036422</span>
<span class="token inserted">+Info : flash size = 256kbytes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨æ”¶åˆ°ç±»ä¼¼çš„é”™è¯¯<code>undefined debug reason 7 - target needs reset</code>ï¼Œæ‚¨å¯ä»¥å°è¯•<code>monitor reset halt</code>æŒ‰ç…§<a href="https://stackoverflow.com/questions/38994596/reason-7-target-needs-reset-unreliable-debugging-setup" target="_blank" rel="noopener">æ­¤å¤„</a>æ‰€è¿°è¿è¡Œã€‚</p>
</blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenOCD çš„ GDB æœåŠ¡å™¨ä¾¦å¬ TCP ç«¯å£ 3333ï¼ˆæœ¬åœ°ä¸»æœºï¼‰ã€‚æ­¤å‘½ä»¤æ­£åœ¨è¿æ¥åˆ°è¯¥ç«¯å£ã€‚</p>
<h3 id="æ›´æ–°-cargo-config-toml"><a href="#æ›´æ–°-cargo-config-toml" class="headerlink" title="æ›´æ–° ../.cargo/config.toml"></a>æ›´æ–° ../.cargo/config.toml</h3><p>æ—¢ç„¶æ‚¨å·²æˆåŠŸç¡®å®šéœ€è¦ä½¿ç”¨å“ªä¸ªè°ƒè¯•å™¨ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ›´æ”¹ï¼Œ<code>../.cargo/config.toml</code>ä»¥ä¾¿<code>cargo run</code>å‘½ä»¤æˆåŠŸã€‚</p>
<blockquote>
<p><strong>NOTE</strong> <code>cargo</code>æ˜¯ Rust åŒ…ç®¡ç†å™¨ï¼Œä½ å¯ä»¥<a href="https://doc.rust-lang.org/cargo/" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>é˜…è¯»å®ƒ ã€‚</p>
</blockquote>
<p>å›åˆ°ç»ˆç«¯æç¤ºç¬¦å¹¶æŸ¥çœ‹<code>../.cargo/config.toml</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">~/embedded-discovery/src/05-led-roulette
$ cat ../.cargo/config.toml
[target.thumbv7em-none-eabihf]
runner = "arm-none-eabi-gdb -q"
# runner = "gdb-multiarch -q"
# runner = "gdb -q"
rustflags = [
  "-C", "link-arg=-Tlink.x",
]

[build]
target = "thumbv7em-none-eabihf"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨æ‚¨å–œæ¬¢çš„ç¼–è¾‘å™¨è¿›è¡Œç¼–è¾‘ï¼Œ<code>../.cargo/config.toml</code>ä»¥ä¾¿è¯¥ <code>runner</code>è¡ŒåŒ…å«è¯¥è°ƒè¯•å™¨çš„æ­£ç¡®åç§°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">nano ../.cargo/config.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„è°ƒè¯•å™¨<code>gdb-multiarch</code>åœ¨ç¼–è¾‘ä¹‹å<code>git diff</code>åº”è¯¥æ˜¯ï¼š</p>
<pre class="line-numbers language-diff"><code class="language-diff">$ git diff ../.cargo/config.toml
diff --git a/src/.cargo/config.toml b/src/.cargo/config.toml
index ddff17f..8512cfe 100644
<span class="token coord">--- a/src/.cargo/config.toml</span>
<span class="token coord">+++ b/src/.cargo/config.toml</span>
<span class="token coord">@@ -1,6 +1,6 @@</span>
 [target.thumbv7em-none-eabihf]
<span class="token deleted">-runner = "arm-none-eabi-gdb -q"</span>
<span class="token deleted">-# runner = "gdb-multiarch -q"</span>
<span class="token inserted">+# runner = "arm-none-eabi-gdb -q"</span>
<span class="token inserted">+runner = "gdb-multiarch -q"</span>
 # runner = "gdb -q"
 rustflags = [
   "-C", "link-arg=-Tlink.x",<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æ‚¨å·²ç»<code>../.cargo/config.toml</code>è®¾ç½®å¥½äº†ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨<code>cargo run</code>å¯åŠ¨è°ƒè¯•ä¼šè¯æ¥æµ‹è¯•å®ƒã€‚</p>
<blockquote>
<p><strong>æ³¨ï¼š</strong>è¯¥<code>--target thumbv7em-none-eabihf</code>å®šä¹‰å“ªäº›æ¶æ„æ¥æ„å»ºå’Œè¿è¡Œã€‚åœ¨æˆ‘ä»¬çš„<code>../.cargo/config.toml</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ <code>target = "thumbv7em-none-eabihf"</code>å®é™…ä¸Šæ²¡æœ‰å¿…è¦åœ¨<code>--target</code>æ­¤å¤„æŒ‡å®šæˆ‘ä»¬è¿™æ ·åšï¼Œåªæ˜¯ä¸ºäº†è®©æ‚¨çŸ¥é“å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œä¸Šçš„å‚æ•°å¹¶ä¸”å®ƒä»¬ä¼šè¦†ç›–<code>config.toml</code>æ–‡ä»¶ä¸­çš„å‚æ•°ã€‚</p>
</blockquote>
<pre><code>cargo run --target thumbv7em-none-eabihf</code></pre><p>ç»“æœæ˜¯ï¼š</p>
<pre><code>~/embedded-discovery/src/05-led-roulette
$ cargo run --target thumbv7em-none-eabihf
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...</code></pre><p>ç°åœ¨å‘å‡º<code>target remote :3333</code>è¿æ¥åˆ° OpenOCD æœåŠ¡å™¨å¹¶è¿æ¥åˆ° F3 çš„å‘½ä»¤ï¼š</p>
<pre><code>(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()</code></pre><p>å¤ªæ£’äº†ï¼Œæˆ‘ä»¬å°†æ¥ä¼šä¿®æ”¹<code>../.cargo/config.toml</code>ã€‚<strong>ä½†æ˜¯</strong>ï¼Œç”±äºæ­¤æ–‡ä»¶ä¸æ‰€æœ‰ç« èŠ‚å…±äº«ï¼Œå› æ­¤åº”è€ƒè™‘åˆ°è¿™ä¸€ç‚¹è¿›è¡Œæ›´æ”¹ã€‚å¦‚æœæ‚¨æƒ³è¦æˆ–æˆ‘ä»¬éœ€è¦è¿›è¡Œä»…ä¸ç‰¹å®šç« èŠ‚æœ‰å…³çš„æ›´æ”¹ï¼Œåˆ™åˆ›å»º<code>.cargo/config.toml</code>è¯¥ç« èŠ‚ç›®å½•çš„æœ¬åœ°ç›®å½•ã€‚</p>
<h3 id="çƒ§å½•è®¾å¤‡"><a href="#çƒ§å½•è®¾å¤‡" class="headerlink" title="çƒ§å½•è®¾å¤‡"></a>çƒ§å½•è®¾å¤‡</h3><p>å‡è®¾æ‚¨è¿è¡Œäº† GDBï¼Œå¦‚æœæ²¡æœ‰æŒ‰ç…§ä¸Šä¸€èŠ‚ä¸­çš„å»ºè®®å¯åŠ¨å®ƒã€‚</p>
<p>ç°åœ¨ä½¿ç”¨<code>load</code>å‘½ä»¤ in<code>gdb</code>å°†ç¨‹åºå®é™…åˆ·å…¥è®¾å¤‡ï¼š</p>
<pre><code>(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x20ec lma 0x8000194
Loading section .rodata, size 0x514 lma 0x8002280
Start address 0x08000194, load size 10132
Transfer rate: 17 KB/sec, 3377 bytes/write.</code></pre><p>æ‚¨è¿˜å°†åœ¨ OpenOCD ç»ˆç«¯ä¸­çœ‹åˆ°æ–°çš„è¾“å‡ºï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : flash size = 256kbytes
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+adapter speed: 4000 kHz</span>
<span class="token inserted">+target halted due to breakpoint, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x61000000 pc: 0x2000003a msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬çš„ç¨‹åºå·²ç»åŠ è½½å®Œæ¯•ï¼Œè®©æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹å§ï¼</p>
<h2 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h2><p>æˆ‘ä»¬å·²ç»åœ¨è°ƒè¯•ä¼šè¯ä¸­ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è°ƒè¯•æˆ‘ä»¬çš„ç¨‹åºã€‚</p>
<p>åœ¨<code>load</code>å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬çš„ç¨‹åºåœ¨å®ƒçš„<em>å…¥å£ç‚¹</em>åœæ­¢ã€‚è¿™ç”± GDB è¾“å‡ºçš„â€œèµ·å§‹åœ°å€ 0x8000XXXâ€éƒ¨åˆ†æŒ‡ç¤ºã€‚å…¥å£ç‚¹æ˜¯å¤„ç†å™¨/CPU å°†é¦–å…ˆæ‰§è¡Œçš„ç¨‹åºçš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>æˆ‘æä¾›ç»™æ‚¨çš„å…¥é—¨é¡¹ç›®æœ‰ä¸€äº›åœ¨å‡½æ•°<em>ä¹‹å‰</em>è¿è¡Œçš„é¢å¤–ä»£ç <code>main</code>ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯¹â€œpre-mainâ€éƒ¨åˆ†ä¸æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç›´æ¥è·³åˆ°<code>main</code>å‡½æ•°çš„å¼€å¤´ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ–­ç‚¹æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚<code>break main</code>åœ¨<code>(gdb)</code>æç¤ºç¬¦ä¸‹å‘å‡ºï¼š</p>
<blockquote>
<p><strong>æ³¨æ„</strong>å¯¹äºè¿™äº› GDB å‘½ä»¤ï¼Œæˆ‘é€šå¸¸ä¸ä¼šæä¾›å¯å¤åˆ¶çš„ä»£ç å—ï¼Œå› ä¸ºå®ƒä»¬å¾ˆçŸ­ï¼Œè€Œä¸”è‡ªå·±è¾“å…¥å®ƒä»¬ä¼šæ›´å¿«ã€‚æ­¤å¤–ï¼Œå¤§å¤šæ•°å¯ä»¥ç¼©çŸ­ã€‚ä¾‹å¦‚<code>b</code>for<code>break</code>æˆ–<code>s</code>for <code>step</code>ï¼Œè¯·å‚é˜…<a href="https://users.ece.utexas.edu/~adnan/gdb-refcard.pdf" target="_blank" rel="noopener">GDB å¿«é€Ÿå‚è€ƒ</a> ä»¥è·å–æ›´å¤šä¿¡æ¯æˆ–ä½¿ç”¨ Google æŸ¥æ‰¾æ‚¨çš„å…¶ä»–äººã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡é”®å…¥å‰å‡ ä¸ªå­—æ¯è€Œä¸æ˜¯ä¸€ä¸ªé€‰é¡¹å¡æ¥å®Œæˆæˆ–ä¸¤ä¸ªé€‰é¡¹å¡æ¥æŸ¥çœ‹æ‰€æœ‰å¯èƒ½çš„å‘½ä»¤æ¥ä½¿ç”¨é€‰é¡¹å¡å®Œæˆã€‚</p>
<blockquote>
<p>æœ€åï¼Œ<code>help xxxx</code>å…¶ä¸­ xxxx æ˜¯å‘½ä»¤ï¼Œå°†æä¾›çŸ­åç§°å’Œå…¶ä»–ä¿¡æ¯ï¼š</p>
<pre><code>(gdb) help s
step, s
Step program until it reaches a different source line.
Usage: step [N]
Argument N means step N times (or till program stops for another reason).</code></pre></blockquote>
</blockquote>
<pre><code>(gdb) break main
Breakpoint 1 at 0x80001f0: file src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.</code></pre><p>æ¥ä¸‹æ¥å‘å‡º<code>continue</code>å‘½ä»¤ï¼š</p>
<pre><code>(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7
7       #[entry]</code></pre><p>æ–­ç‚¹å¯ç”¨äºåœæ­¢ç¨‹åºçš„æ­£å¸¸æµç¨‹ã€‚è¯¥<code>continue</code>å‘½ä»¤å°†ä½¿ç¨‹åºè‡ªç”±è¿è¡Œï¼Œ<em>ç›´åˆ°</em>åˆ°è¾¾æ–­ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´åˆ°å®ƒåˆ°è¾¾<code>#[entry]</code> main å‡½æ•°çš„è¹¦åºŠå’Œ<code>break main</code>è®¾ç½®æ–­ç‚¹çš„ä½ç½®ã€‚</p>
<blockquote>
<p><strong>è¯·æ³¨æ„</strong>ï¼ŒGDB è¾“å‡ºæ˜¾ç¤ºâ€œæ–­ç‚¹ 1â€ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨åªèƒ½ä½¿ç”¨å…¶ä¸­çš„å…­ä¸ªæ–­ç‚¹ï¼Œå› æ­¤æœ€å¥½æ³¨æ„è¿™äº›æ¶ˆæ¯ã€‚</p>
</blockquote>
<p>å¥½çš„ã€‚ç”±äºæˆ‘ä»¬åœåœ¨<code>#[entry]</code>å¹¶ä½¿ç”¨äº†ï¼Œ<code>disassemble /m</code>æˆ‘ä»¬çœ‹åˆ°äº†è¿›å…¥çš„ä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªè¹¦åºŠåˆ°ä¸»ã€‚è¿™æ„å‘³ç€å®ƒä¼šè®¾ç½®å †æ ˆï¼Œç„¶å<code>main</code>ä½¿ç”¨ ARM åˆ†æ”¯å’Œé“¾æ¥æŒ‡ä»¤è°ƒç”¨å¯¹è¯¥å‡½æ•°çš„å­ä¾‹ç¨‹è°ƒç”¨<code>bl</code>ã€‚</p>
<pre><code>(gdb) disassemble /m
Dump of assembler code for function main:
7       #[entry]
   0x080001ec &lt;+0&gt;:     push    {r7, lr}
   0x080001ee &lt;+2&gt;:     mov     r7, sp
=&gt; 0x080001f0 &lt;+4&gt;:     bl      0x80001f6 &lt;_ZN12led_roulette18__cortex_m_rt_main17he61ef18c060014a5E&gt;
   0x080001f4 &lt;+8&gt;:     udf     #254    ; 0xfe

End of assembler dump.</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å‘å‡ºä¸€ä¸ª<code>step</code>GDB å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†é€šè¿‡è¯­å¥æ­¥è¿›åˆ°å‡½æ•°/è¿‡ç¨‹ä¸­æ¥æ¨è¿›ç¨‹åºè¯­å¥ã€‚æ‰€ä»¥åœ¨ç¬¬ä¸€ä¸ª<code>step</code>å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬åœ¨é‡Œé¢<code>main</code>å¹¶å®šä½åœ¨ç¬¬ä¸€ä¸ªå¯æ‰§è¡Œ<code>rust</code>è¯­å¥ï¼Œç¬¬ 10 è¡Œï¼Œä½†å®ƒ <strong>æ²¡æœ‰</strong>è¢«æ‰§è¡Œï¼š</p>
<pre><code>(gdb) step
led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:10
10          let x = 42;</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘å‡ºç¬¬äºŒä¸ª<code>step</code>ï¼Œå®ƒæ‰§è¡Œç¬¬ 10 è¡Œå¹¶åœ¨ç¬¬ 1 è¡Œåœæ­¢<code>11 _y = x;</code>ï¼ŒåŒæ ·<strong>ä¸</strong>æ‰§è¡Œç¬¬ 11 è¡Œã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬äºŒä¸ª<code>(gdb)</code>æç¤ºç¬¦ä¸‹æŒ‰ Enter é”®ï¼Œå®ƒä¼šé‡æ–°å‘å‡ºä¹‹å‰çš„è¯­å¥<code>step</code>ï¼Œä½†æ˜¯ä¸ºäº†åœ¨æœ¬æ•™ç¨‹ä¸­æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé‡æ–°é”®å…¥å‘½ä»¤ã€‚</p>
</blockquote>
<pre><code>(gdb) step
11          _y = x;</code></pre><p>å¦‚æ‚¨æ‰€è§ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåœ¨æ¯ä¸ª<code>step</code>å‘½ä»¤ä¸Šï¼ŒGDB å°†æ‰“å°å½“å‰è¯­å¥åŠå…¶è¡Œå·ã€‚æ­£å¦‚æ‚¨ç¨åå°†åœ¨ TUI æ¨¡å¼ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œæ‚¨å°†ä¸ä¼šåœ¨å‘½ä»¤åŒºåŸŸä¸­çœ‹åˆ°è¯¥è¯­å¥ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨â€œåœ¨â€<code>_y = x</code>å£°æ˜ï¼›è¯¥è¯­å¥å°šæœªæ‰§è¡Œã€‚è¿™æ„å‘³ç€<code>x</code> å·²åˆå§‹åŒ–ä½†æœªåˆå§‹åŒ–<code>_y</code>ã€‚è®©æˆ‘ä»¬ä½¿ç”¨<code>print</code> å‘½ä»¤æ£€æŸ¥é‚£äº›å †æ ˆ/å±€éƒ¨å˜é‡ï¼Œ<code>p</code>ç®€ç§°ï¼š</p>
<pre><code>(gdb) print x
$1 = 42
(gdb) p &amp;x
$2 = (*mut i32) 0x20009fe0
(gdb) p _y
$3 = 536870912
(gdb) p &amp;_y
$4 = (*mut i32) 0x20009fe4</code></pre><p>æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œ<code>x</code>åŒ…å«å€¼<code>42</code>ã€‚<code>_y</code>ï¼Œä½†æ˜¯ï¼ŒåŒ…å«å€¼<code>536870912</code>(?)ã€‚è¿™æ˜¯å› ä¸º<code>_y</code>å°šæœªåˆå§‹åŒ–ï¼Œå®ƒåŒ…å«ä¸€äº›åƒåœ¾å€¼ã€‚</p>
<p>è¯¥å‘½ä»¤<code>print &amp;x</code>æ‰“å°å˜é‡çš„åœ°å€<code>x</code>ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯ GDB è¾“å‡ºæ˜¾ç¤ºäº†å¼•ç”¨çš„ç±»å‹ï¼š<code>*mut i32</code>ï¼Œä¸€ä¸ªæŒ‡å‘<code>i32</code>å€¼çš„å¯å˜æŒ‡é’ˆã€‚å¦ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯ï¼Œåœ°å€<code>x</code>å’Œ<code>_y</code>éå¸¸æ¥è¿‘å¯¹æ–¹ï¼šä»–ä»¬çš„åœ°å€åªæ˜¯<code>4</code>ä¸ªå­—èŠ‚åˆ†å¼€ã€‚</p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹<code>info locals</code>å‘½ä»¤ï¼Œè€Œä¸æ˜¯ä¸€ä¸€æ‰“å°å±€éƒ¨å˜é‡ï¼š</p>
<pre><code>(gdb) info locals
x = 42
_y = 536870912</code></pre><p>å¥½çš„ã€‚ä½¿ç”¨ another <code>step</code>ï¼Œæˆ‘ä»¬å°†åœ¨<code>loop {}</code>è¯­å¥ä¹‹ä¸Šï¼š</p>
<pre><code>(gdb) step
14          loop {}</code></pre><p>å¹¶ä¸”<code>_y</code>ç°åœ¨åº”è¯¥è¢«åˆå§‹åŒ–ã€‚</p>
<pre><code>(gdb) print _y
$5 = 42</code></pre><p>å¦‚æœæˆ‘ä»¬<code>step</code>å†æ¬¡åœ¨<code>loop {}</code>è¯­å¥ä¹‹ä¸Šä½¿ç”¨ï¼Œæˆ‘ä»¬ä¼šå¡ä½ï¼Œå› ä¸ºç¨‹åºæ°¸è¿œä¸ä¼šé€šè¿‡è¯¥è¯­å¥ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨<code>step</code>é”™è¯¯åœ°ä½¿ç”¨äº†æˆ–ä»»ä½•å…¶ä»–å‘½ä»¤å¹¶ä¸” GDB å¡ä½äº†ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‰ æ¥è§£é™¤å¡ä½<code>Ctrl+C</code>ã€‚</p>
</blockquote>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œè¯¥<code>disassemble /m</code>å‘½ä»¤å¯ç”¨äºå›´ç»•æ‚¨å½“å‰æ‰€åœ¨çš„è¡Œåæ±‡ç¼–ç¨‹åºã€‚æ‚¨å¯èƒ½è¿˜å¸Œæœ›å¯¹<code>set print asm-demangle on</code> åç§°è¿›è¡Œä¹±ç å¤„ç†ï¼Œè¿™åªéœ€è¦åœ¨è°ƒè¯•ä¼šè¯ä¸­å®Œæˆä¸€æ¬¡ã€‚ç¨åè¿™ä¸ªå’Œå…¶ä»–å‘½ä»¤å°†è¢«æ”¾ç½®åœ¨ä¸€ä¸ªåˆå§‹åŒ–æ–‡ä»¶ä¸­ï¼Œè¿™å°†ç®€åŒ–å¯åŠ¨è°ƒè¯•ä¼šè¯ã€‚</p>
<pre><code>(gdb) set print asm-demangle on
(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17h51e7c3daad2af251E:
8       fn main() -&gt; ! {
   0x080001f6 &lt;+0&gt;:     sub     sp, #8
   0x080001f8 &lt;+2&gt;:     movs    r0, #42 ; 0x2a

9           let _y;
10          let x = 42;
   0x080001fa &lt;+4&gt;:     str     r0, [sp, #0]

11          _y = x;
   0x080001fc &lt;+6&gt;:     str     r0, [sp, #4]

12
13          // infinite loop; just so we don't leave this stack frame
14          loop {}
=&gt; 0x080001fe &lt;+8&gt;:     b.n     0x8000200 &lt;led_roulette::__cortex_m_rt_main+10&gt;
   0x08000200 &lt;+10&gt;:    b.n     0x8000200 &lt;led_roulette::__cortex_m_rt_main+10&gt;

End of assembler dump.</code></pre><p>çœ‹åˆ°<code>=&gt;</code>å·¦ä¾§çš„ç²—ç®­å¤´äº†å—ï¼Ÿå®ƒæ˜¾ç¤ºäº†å¤„ç†å™¨æ¥ä¸‹æ¥å°†æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p>
<p>æ­¤å¤–ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœæ‚¨è¦æ‰§è¡Œ<code>step</code>å‘½ä»¤ GDB ä¼šå¡ä½ï¼Œå› ä¸ºå®ƒæ­£åœ¨æ‰§è¡Œä¸€æ¡æŒ‡å‘è‡ªèº«çš„åˆ†æ”¯æŒ‡ä»¤å¹¶ä¸”æ°¸è¿œä¸ä¼šè¶Šè¿‡å®ƒã€‚æ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ <code>Ctrl+C</code>æ¥é‡æ–°è·å¾—æ§åˆ¶æƒã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨<code>stepi</code>( <code>si</code>) GDB å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æ‰§è¡Œä¸€æ¡ asm æŒ‡ä»¤ï¼ŒGDB å°†æ‰“å°å¤„ç†å™¨æ¥ä¸‹æ¥å°†æ‰§è¡Œçš„è¯­å¥çš„åœ°å€<strong>å’Œ</strong>è¡Œå·ï¼Œå¹¶ä¸”ä¸ä¼šå¡ä½ã€‚</p>
<pre><code>(gdb) stepi
0x08000194      14          loop {}

(gdb) si
0x08000194      14          loop {}</code></pre><p>åœ¨æˆ‘ä»¬è½¬å‘æ›´æœ‰è¶£çš„äº‹æƒ…ä¹‹å‰çš„æœ€åä¸€ä¸ªæŠ€å·§ã€‚åœ¨ GDB ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code>(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) disassemble /m
Dump of assembler code for function main:
7       #[entry]
   0x080001ec &lt;+0&gt;:     push    {r7, lr}
   0x080001ee &lt;+2&gt;:     mov     r7, sp
=&gt; 0x080001f0 &lt;+4&gt;:     bl      0x80001f6 &lt;led_roulette::__cortex_m_rt_main&gt;
   0x080001f4 &lt;+8&gt;:     udf     #254    ; 0xfe

End of assembler dump.</code></pre><p>æˆ‘ä»¬ç°åœ¨å›åˆ°äº†å¼€å¤´<code>#[entry]</code>ï¼</p>
<p><code>monitor reset halt</code>å°†é‡ç½®å¾®æ§åˆ¶å™¨å¹¶åœ¨ç¨‹åºå¼€å§‹æ—¶åœæ­¢å®ƒã€‚<code>continue</code>ç„¶åï¼Œè¯¥å‘½ä»¤å°†è®©ç¨‹åºè‡ªç”±è¿è¡Œï¼Œç›´åˆ°å®ƒåˆ°è¾¾æ–­ç‚¹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯åœ¨ å¤„çš„æ–­ç‚¹<code>#[entry]</code>ã€‚</p>
<p>å½“æ‚¨é”™è¯¯åœ°è·³è¿‡æ‚¨æœ‰å…´è¶£æ£€æŸ¥çš„ç¨‹åºéƒ¨åˆ†æ—¶ï¼Œæ­¤ç»„åˆéå¸¸æ–¹ä¾¿ã€‚æ‚¨å¯ä»¥è½»æ¾åœ°å°†ç¨‹åºçš„çŠ¶æ€å›æ»šåˆ°æœ€åˆçš„çŠ¶æ€ã€‚</p>
<blockquote>
<p><strong>ç»†åˆ™</strong>ï¼šæ­¤<code>reset</code>å‘½ä»¤ä¸ä¼šæ¸…é™¤æˆ–è§¦æ‘¸ RAMã€‚è¯¥å†…å­˜å°†ä¿ç•™å…¶ä¸Šæ¬¡è¿è¡Œçš„å€¼ã€‚ä¸è¿‡ï¼Œè¿™åº”è¯¥ä¸æ˜¯é—®é¢˜ï¼Œé™¤éæ‚¨çš„ç¨‹åºè¡Œä¸ºå–å†³äº<em>æœªåˆå§‹åŒ–</em>å˜é‡çš„å€¼ï¼Œä½†è¿™å°±æ˜¯æœªå®šä¹‰è¡Œä¸º (UB) çš„å®šä¹‰ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å®Œæˆäº†è¿™ä¸ªè°ƒè¯•ä¼šè¯ã€‚ä½ å¯ä»¥ç”¨<code>quit</code>å‘½ä»¤ç»“æŸå®ƒã€‚</p>
<pre><code>(gdb) quit
A debugging session is active.

        Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: $PWD/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.</code></pre><p>ä¸ºäº†è·å¾—æ›´å¥½çš„è°ƒè¯•ä½“éªŒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ GDB çš„æ–‡æœ¬ç”¨æˆ·ç•Œé¢ (TUI)ã€‚è¦è¿›å…¥è¯¥æ¨¡å¼ï¼Œè¯·åœ¨ GDB shell ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ï¼š</p>
<pre><code>(gdb) layout src
(gdb) layout asm
(gdb) layout split</code></pre><blockquote>
<p><strong>æ³¨æ„</strong>å‘ Windows ç”¨æˆ·é“æ­‰ï¼ŒGNU ARM Embedded Toolchain é™„å¸¦çš„ GDB å¯èƒ½ä¸æ”¯æŒæ­¤ TUI æ¨¡å¼<code>:-(</code>ã€‚</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯<code>layout split</code>é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è®¾ç½® a çš„ç¤ºä¾‹ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å·²ç»æ”¾å¼ƒäº†ä¼ é€’<code>--target</code>å‚æ•°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
(gdb) target remote :3333
(gdb) load
(gdb) set print asm-demangle on
(gdb) set style sources off
(gdb) break main
(gdb) continue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ä¸€ä¸ªä»¥ä¸Šè¿°å‘½ä»¤ä¸º<code>-ex</code>å‚æ•°çš„å‘½ä»¤è¡Œï¼Œä»¥èŠ‚çœæ‚¨çš„ä¸€äº›è¾“å…¥ï¼Œå¾ˆå¿«æˆ‘ä»¬å°†æä¾›ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ¥æ‰§è¡Œåˆå§‹å‘½ä»¤é›†ï¼š</p>
<pre><code>cargo run -- -q -ex 'target remote :3333' -ex 'load' -ex 'set print asm-demangle on' -ex 'set style sources off' -ex 'b main' -ex 'c' target/thumbv7em-none-eabihf/debug/led-roulette</code></pre><p>ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-1.png" alt=""></p>
<p>ç°åœ¨æˆ‘ä»¬å°†å‘ä¸‹æ»šåŠ¨é¡¶éƒ¨æºçª—å£ï¼Œä»¥ä¾¿æˆ‘ä»¬çœ‹åˆ°æ•´ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œ<code>layout split</code>ï¼Œç„¶å<code>step</code>ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-2.png" alt=""></p>
<p>ç„¶åæˆ‘ä»¬å°†æ‰§è¡Œä¸€äº›<code>info locals</code>and<code>step</code>çš„ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) info locals
(gdb) step
(gdb) info locals
(gdb) step
(gdb) info locals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-3.png" alt=""></p>
<p>æ‚¨å¯ä»¥éšæ—¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€€å‡º TUI æ¨¡å¼ï¼š</p>
<pre><code>(gdb) tui disable</code></pre><p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-4.png" alt=""></p>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨ä¸å–œæ¬¢é»˜è®¤çš„ GDB CLIï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/cyrus-and/gdb-dashboard#gdb-dashboard" target="_blank" rel="noopener">gdb-dashboard</a>ã€‚å®ƒä½¿ç”¨ Python å°†é»˜è®¤çš„ GDB CLI è½¬æ¢ä¸ºæ˜¾ç¤ºå¯„å­˜å™¨ã€æºä»£ç è§†å›¾ã€ç¨‹åºé›†è§†å›¾å’Œå…¶ä»–å†…å®¹çš„ä»ªè¡¨æ¿ã€‚</p>
</blockquote>
<p>ä¸è¿‡ä¸è¦å…³é—­ OpenOCDï¼ä»¥åæˆ‘ä»¬ä¼šä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨å®ƒã€‚æœ€å¥½è®©å®ƒç»§ç»­è¿è¡Œã€‚</p>
<h2 id="The-Led-and-Delay-abstractions"><a href="#The-Led-and-Delay-abstractions" class="headerlink" title="The Led and Delay abstractions"></a>The <code>Led</code> and <code>Delay</code> abstractions</h2><p>ç°åœ¨ï¼Œæˆ‘å°†ä»‹ç»ä¸¤ä¸ªé«˜çº§æŠ½è±¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬æ¥å®ç° LED è½®ç›˜èµŒåº”ç”¨ç¨‹åºã€‚</p>
<p>è¾…åŠ© crate<code>aux5</code>å…¬å¼€äº†ä¸€ä¸ªåä¸º çš„åˆå§‹åŒ–å‡½æ•°<code>init</code>ã€‚è°ƒç”¨æ­¤å‡½æ•°æ—¶ï¼Œè¿”å›ä¸¤ä¸ªæ‰“åŒ…åœ¨å…ƒç»„ä¸­çš„<code>Delay</code>å€¼ï¼šä¸€ä¸ªå€¼å’Œä¸€ä¸ª<code>LedArray</code>å€¼ã€‚</p>
<p><code>Delay</code> å¯ç”¨äºåœ¨æŒ‡å®šçš„æ¯«ç§’æ•°å†…é˜»æ­¢æ‚¨çš„ç¨‹åºã€‚</p>
<p><code>LedArray</code>æ˜¯ä¸€ä¸ªåŒ…å« 8 ä¸ª<code>Led</code>sçš„æ•°ç»„ã€‚æ¯ä¸ª<code>Led</code>ä»£è¡¨ F3 æ¿ä¸Šçš„ä¸€ä¸ª LEDï¼Œå¹¶å…¬å¼€ä¸¤ç§æ–¹æ³•ï¼š<code>on</code>å’Œ<code>off</code>å¯åˆ†åˆ«ç”¨äºæ‰“å¼€æˆ–å…³é—­ LEDã€‚</p>
<p>è®©æˆ‘ä»¬é€šè¿‡å°†èµ·å§‹ä»£ç ä¿®æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤ºæ¥å°è¯•è¿™ä¸¤ç§æŠ½è±¡ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> Delay<span class="token punctuation">,</span> DelayMs<span class="token punctuation">,</span> LedArray<span class="token punctuation">,</span> OutputSwitch<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> leds<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> LedArray<span class="token punctuation">)</span> <span class="token operator">=</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> half_period <span class="token operator">=</span> <span class="token number">500_u16</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        leds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>half_period<span class="token punctuation">)</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>half_period<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æ„å»ºå®ƒï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„*</strong>åœ¨<em>å¯åŠ¨ GDB ä¼šè¯</em>ä¹‹å‰<em>å¿˜è®°é‡æ–°æ„å»ºç¨‹åºæ˜¯å¯èƒ½çš„ï¼›è¿™ç§é—æ¼ä¼šå¯¼è‡´éå¸¸æ··ä¹±çš„è°ƒè¯•ä¼šè¯ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥è°ƒç”¨ just<code>cargo run</code> è€Œä¸æ˜¯<code>cargo build</code>; <code>cargo run</code>. è¯¥<code>cargo run</code>å‘½ä»¤å°†æ„å»º</em>å¹¶*å¯åŠ¨è°ƒè¯•ä¼šè¯ï¼Œç¡®ä¿æ‚¨æ°¸è¿œä¸ä¼šå¿˜è®°é‡æ–°ç¼–è¯‘æ‚¨çš„ç¨‹åºã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å°†è¿è¡Œå¹¶é‡å¤æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æ‰€åšçš„é—ªçƒè¿‡ç¨‹ï¼Œä½†ä½¿ç”¨æ–°ç¨‹åºã€‚æˆ‘ä¼šè®©ä½ è¾“å…¥<code>cargo run</code>ï¼Œ<em>è¿™å¾ˆå¿«å°±ä¼šå˜å¾—æ›´å®¹æ˜“</em>ã€‚:)</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...

(gdb) target remote :3333
Remote debugging using :3333
led_roulette::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x52c0 lma 0x8000194
Loading section .rodata, size 0xb50 lma 0x8005454
Start address 0x08000194, load size 24484
Transfer rate: 21 KB/sec, 6121 bytes/write.

(gdb) break main
Breakpoint 1 at 0x8000202: file ~/embedded-discovery/src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline ()
    at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) step
led_roulette::__cortex_m_rt_main () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:9
9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¥½çš„ã€‚è®©æˆ‘ä»¬é€æ­¥å®Œæˆä»£ç ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>next</code>å‘½ä»¤è€Œä¸æ˜¯<code>step</code>ã€‚ä¸åŒä¹‹å¤„åœ¨äºè¯¥<code>next</code>å‘½ä»¤å°†<em>è·³è¿‡</em>å‡½æ•°è°ƒç”¨è€Œä¸æ˜¯è¿›å…¥å®ƒä»¬å†…éƒ¨ã€‚</p>
<pre><code>(gdb) next
11          let half_period = 500_u16;

(gdb) next
13          loop {

(gdb) next
14              leds[0].on().ok();

(gdb) next
15              delay.delay_ms(half_period);</code></pre><p>æ‰§è¡Œè¯¥<code>leds[0].on().ok()</code>è¯­å¥åï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä¸€ä¸ªçº¢è‰² LEDï¼ŒæŒ‡å‘åŒ—æ–¹çš„ LED äº®èµ·ã€‚</p>
<p>è®©æˆ‘ä»¬ç»§ç»­éå†ç¨‹åºï¼š</p>
<pre><code>(gdb) next
17              leds[0].off().ok();

(gdb) next
18              delay.delay_ms(half_period);</code></pre><p>è¯¥<code>delay_ms</code>è°ƒç”¨å°†é˜»å¡ç¨‹åºåŠç§’ï¼Œä½†æ‚¨å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼Œå› ä¸ºè¯¥ <code>next</code>å‘½ä»¤ä¹Ÿéœ€è¦ä¸€äº›æ—¶é—´æ¥æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œåœ¨è·³è¿‡<code>leds[0].off()</code> è¯­å¥åï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°çº¢è‰² LED ç†„ç­ã€‚</p>
<p>ä½ å·²ç»å¯ä»¥çŒœåˆ°è¿™ä¸ªç¨‹åºåšäº†ä»€ä¹ˆã€‚ä½¿ç”¨<code>continue</code>å‘½ä»¤è®©å®ƒä¸é—´æ–­åœ°è¿è¡Œã€‚</p>
<pre><code>(gdb) continue
Continuing.</code></pre><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åšä¸€äº›æ›´æœ‰è¶£çš„äº‹æƒ…ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ GDB ä¿®æ”¹æˆ‘ä»¬ç¨‹åºçš„è¡Œä¸ºã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬é€šè¿‡ç‚¹å‡» æ¥åœæ­¢æ— é™å¾ªç¯<code>Ctrl+C</code>ã€‚ä½ å¯èƒ½æœ€ç»ˆä¼šåœ¨é‡Œé¢çš„æŸä¸ªåœ°æ–¹ <code>Led::on</code>ï¼Œ<code>Led::off</code>æˆ–è€…<code>delay_ms</code>ï¼š</p>
<pre><code>^C
Program received signal SIGINT, Interrupt.
0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053</code></pre><p>åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œç¨‹åºåœæ­¢äº†å®ƒåœ¨<code>read_volatile</code>å‡½æ•°å†…çš„æ‰§è¡Œã€‚GDBè¾“å‡ºç»“æœæ˜¾ç¤ºï¼Œä¸€äº›æœ‰è¶£çš„ä¿¡æ¯ï¼š<code>core::ptr::read_volatile (src=0xe000e010)</code>ã€‚è¿™æ„å‘³ç€è¯¥å‡½æ•°æ¥è‡ª<code>core</code>crate å¹¶ä¸”å®ƒæ˜¯ç”¨å‚æ•°è°ƒç”¨çš„<code>src = 0xe000e010</code>ã€‚</p>
<p>æ­£å¦‚æ‚¨æ‰€çŸ¥ï¼Œæ˜¾ç¤ºå‡½æ•°å‚æ•°çš„ä¸€ç§æ›´æ˜ç¡®çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä»¥ä¸‹<code>info args</code> å‘½ä»¤ï¼š</p>
<pre><code>(gdb) info args
src = 0xe000e010</code></pre><p>æ— è®ºæ‚¨çš„ç¨‹åºåœ¨å“ªé‡Œåœæ­¢ï¼Œæ‚¨éƒ½å¯ä»¥éšæ—¶æŸ¥çœ‹<code>backtrace</code>å‘½ä»¤çš„è¾“å‡º ï¼ˆ<code>bt</code>ç®€ç§°ï¼‰ä»¥äº†è§£å®ƒæ˜¯å¦‚ä½•åˆ°è¾¾é‚£é‡Œçš„ï¼š</p>
<pre><code>(gdb) backtrace
#0  0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053
#1  0x08002d66 in vcell::VolatileCell&lt;u32&gt;::get&lt;u32&gt; (self=0xe000e010) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/vcell-0.1.3/src/lib.rs:33
#2  volatile_register::RW&lt;u32&gt;::read&lt;u32&gt; (self=0xe000e010) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/volatile-register-0.2.0/src/lib.rs:75
#3  cortex_m::peripheral::SYST::has_wrapped (self=0x20009fa4)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-0.6.4/src/peripheral/syst.rs:136
#4  0x08003004 in stm32f3xx_hal::delay::{{impl}}::delay_us (self=0x20009fa4, us=500000)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:58
#5  0x08002f3e in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:32
#6  0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
#7  0x0800024c in led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:15
#8  0x08000206 in led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7</code></pre><p><code>backtrace</code> å°†æ‰“å°ä»å½“å‰å‡½æ•°åˆ° main çš„å‡½æ•°è°ƒç”¨è·Ÿè¸ªã€‚</p>
<p>å›åˆ°æˆ‘ä»¬çš„è¯é¢˜ã€‚ä¸ºäº†åšæˆ‘ä»¬æ‰€è¿½æ±‚çš„ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»è¿”å›åˆ°<code>main</code>å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>finish</code>å‘½ä»¤æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¯¥å‘½ä»¤æ¢å¤ç¨‹åºæ‰§è¡Œå¹¶åœ¨ç¨‹åºä»å½“å‰å‡½æ•°è¿”å›åç«‹å³åœæ­¢æ‰§è¡Œã€‚æˆ‘ä»¬å°†ä¸å¾—ä¸å¤šæ¬¡è°ƒç”¨å®ƒã€‚</p>
<pre><code>(gdb) finish
Run till exit from #0  0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053
cortex_m::peripheral::SYST::has_wrapped (self=0x20009fa4)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-0.6.4/src/peripheral/syst.rs:136
136             self.csr.read() &amp; SYST_CSR_COUNTFLAG != 0
Value returned is $1 = 5

(..)

(gdb) finish
Run till exit from #0  0x08002f3e in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:32
0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
38              self.delay_ms(u32(ms));

(gdb) finish
Run till exit from #0  0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
0x0800024c in led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:15
15              delay.delay_ms(half_period);</code></pre><p>æˆ‘ä»¬å›æ¥äº†<code>main</code>ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼š<code>half_period</code></p>
<pre><code>(gdb) print half_period
$3 = 500</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹<code>set</code>å‘½ä»¤ä¿®æ”¹æ­¤å˜é‡ï¼š</p>
<pre><code>(gdb) set half_period = 100

(gdb) print half_period
$5 = 100</code></pre><p>å¦‚æœæ‚¨ä½¿ç”¨è¯¥<code>continue</code>å‘½ä»¤å†æ¬¡è®©ç¨‹åºè‡ªç”±è¿è¡Œï¼Œæ‚¨<strong>å¯èƒ½ä¼š</strong>çœ‹åˆ° LED ç°åœ¨å°†ä»¥æ›´å¿«çš„é€Ÿåº¦é—ªçƒï¼Œä½†æ›´æœ‰å¯èƒ½çš„æ˜¯é—ªçƒç‡æ²¡æœ‰æ”¹å˜ã€‚<strong>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</strong></p>
<p>è®©æˆ‘ä»¬ç”¨ åœæ­¢ç¨‹åºï¼Œ<code>Ctrl+C</code>ç„¶ååœ¨ å¤„è®¾ç½®ä¸€ä¸ªæ–­ç‚¹<code>main:14</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
core::cell::UnsafeCell<u32>::get<u32> (self=0x20009fa4)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/cell.rs:1711
1711        pub const fn get(&self) -> *mut T {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶ååœ¨<code>main.rs:14</code>å’Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹<code>continue</code></p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main.rs:14
Breakpoint 2 at 0x8000236: file src/05-led-roulette/src/main.rs, line 14.
(gdb) continue
Continuing.

Breakpoint 2, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:14
14              leds[0].on().ok();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æ‰“å¼€ä½ çš„ç»ˆç«¯çª—å£ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œå®ƒå¤§çº¦æœ‰ 80 è¡Œé•¿å’Œ 170 ä¸ªå­—ç¬¦ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœä½ ä¸èƒ½æ‰“å¼€é‚£ä¹ˆå¤§çš„ç»ˆç«¯ï¼Œæ²¡é—®é¢˜ä½ ä¼šçœ‹åˆ° <code>--Type &lt;RET&gt; for more, q to quit, c to continue without paging--</code>æ‰€ä»¥åªéœ€è¾“å…¥ return ç›´åˆ°ä½ çœ‹åˆ°<code>(gdb)</code>æç¤ºã€‚ç„¶åæ»šåŠ¨ç»ˆç«¯çª—å£ä»¥æŸ¥çœ‹ç»“æœã€‚</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17h51e7c3daad2af251E:
8       fn main() -> ! {
   0x08000208 <+0>:     push    {r7, lr}
   0x0800020a <+2>:     mov     r7, sp
   0x0800020c <+4>:     sub     sp, #64 ; 0x40
   0x0800020e <+6>:     add     r0, sp, #32

9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();
   0x08000210 <+8>:     bl      0x8000302 <aux5::init>
   0x08000214 <+12>:    b.n     0x8000216 <led_roulette::__cortex_m_rt_main+14>
   0x08000216 <+14>:    add     r0, sp, #32
   0x08000218 <+16>:    add     r1, sp, #4
   0x0800021a <+18>:    ldmia.w r0, {r2, r3, r4, r12, lr}
   0x0800021e <+22>:    stmia.w r1, {r2, r3, r4, r12, lr}
   0x08000222 <+26>:    ldr     r0, [sp, #52]   ; 0x34
   0x08000224 <+28>:    ldr     r1, [sp, #56]   ; 0x38
   0x08000226 <+30>:    str     r1, [sp, #28]
   0x08000228 <+32>:    str     r0, [sp, #24]
   0x0800022a <+34>:    mov.w   r0, #500        ; 0x1f4

10
11          let half_period = 500_u16;
   0x0800022e <+38>:    strh.w  r0, [r7, #-2]

12
13          loop {
   0x08000232 <+42>:    b.n     0x8000234 <led_roulette::__cortex_m_rt_main+44>
   0x08000234 <+44>:    add     r0, sp, #24
   0x08000268 <+96>:    b.n     0x8000234 <led_roulette::__cortex_m_rt_main+44>

14              leds[0].on().ok();
=> 0x08000236 <+46>:    bl      0x80001ec <switch_hal::output::{{impl}}::on<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800023a <+50>:    b.n     0x800023c <led_roulette::__cortex_m_rt_main+52>
   0x0800023c <+52>:    bl      0x8000594 <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000240 <+56>:    b.n     0x8000242 <led_roulette::__cortex_m_rt_main+58>
   0x08000242 <+58>:    add     r0, sp, #4
   0x08000244 <+60>:    mov.w   r1, #500        ; 0x1f4

15              delay.delay_ms(half_period);
   0x08000248 <+64>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x0800024c <+68>:    b.n     0x800024e <led_roulette::__cortex_m_rt_main+70>
   0x0800024e <+70>:    add     r0, sp, #24

16
17              leds[0].off().ok();
   0x08000250 <+72>:    bl      0x800081a <switch_hal::output::{{impl}}::off<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x08000254 <+76>:    b.n     0x8000256 <led_roulette::__cortex_m_rt_main+78>
   0x08000256 <+78>:    bl      0x8000594 <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x0800025a <+82>:    b.n     0x800025c <led_roulette::__cortex_m_rt_main+84>
   0x0800025c <+84>:    add     r0, sp, #4
   0x0800025e <+86>:    mov.w   r1, #500        ; 0x1f4

18              delay.delay_ms(half_period);
   0x08000262 <+90>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000266 <+94>:    b.n     0x8000268 <led_roulette::__cortex_m_rt_main+96>

End of assembler dump.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ä¸Šé¢çš„è½¬å‚¨ä¸­ï¼Œå»¶è¿Ÿæ²¡æœ‰æ”¹å˜çš„åŸå› æ˜¯å› ä¸ºç¼–è¯‘å™¨è®¤è¯†åˆ° half_period æ²¡æœ‰æ”¹å˜ï¼Œè€Œæ˜¯åœ¨<code>delay.delay_ms(half_period);</code>è¢«è°ƒç”¨çš„ä¸¤ä¸ªåœ°æ–¹ æˆ‘ä»¬çœ‹åˆ°äº†<code>mov.w r1, #500</code>ã€‚æ‰€ä»¥æ”¹å˜ çš„å€¼<code>half_period</code>æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼</p>
<pre class="line-numbers language-console"><code class="language-console">   0x08000244 <+60>:    mov.w   r1, #500        ; 0x1f4

15              delay.delay_ms(half_period);
   0x08000248 <+64>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>

(..)

   0x0800025e <+86>:    mov.w   r1, #500        ; 0x1f4

18              delay.delay_ms(half_period);
   0x08000262 <+90>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥é—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯åŒ…è£…<code>half_period</code>åœ¨ a ä¸­<code>Volatile</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">#![deny(unsafe_code)]
#![no_main]
#![no_std]

use volatile::Volatile;
use aux5::{Delay, DelayMs, LedArray, OutputSwitch, entry};

#[entry]
fn main() -> ! {
    let (mut delay, mut leds): (Delay, LedArray) = aux5::init();

    let mut half_period = 500_u16;
    let v_half_period = Volatile::new(&mut half_period);

    loop {
        leds[0].on().ok();
        delay.delay_ms(v_half_period.read());

        leds[0].off().ok();
        delay.delay_ms(v_half_period.read());
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¯¥éƒ¨åˆ†ç¼–è¾‘<code>Cargo.toml</code>æ·»åŠ ã€‚<code>volatile = "0.4.3"``[dependencies]</code></p>
<pre class="line-numbers language-console"><code class="language-console">[dependencies]
aux5 = { path = "auxiliary" }
volatile = "0.4.3"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨ä¸Šé¢çš„ä»£ç ï¼Œ<code>Volatile</code>æ‚¨ç°åœ¨å¯ä»¥è¿›è¡Œæ›´æ”¹ï¼Œ<code>half_period</code>å¹¶ä¸”å¯ä»¥å°è¯•ä¸åŒçš„å€¼ã€‚è¿™æ˜¯å‘½ä»¤åˆ—è¡¨å’Œè§£é‡Šï¼›<code># xxxx</code>å±•ç¤ºã€‚</p>
<pre><code>$ cargo run --target thumbv7em-none-eabihf   # Compile and load the program into gdb
(gdb) target remote :3333           # Connect to STM32F3DISCOVERY board from PC
(gdb) load                          # Flash program
(gdb) break main.rs:16              # Set breakpoint 1 at top of loop
(gdb) continue                      # Continue, will stop at main.rs:16
(gdb) disable 1                     # Disable breakpoint 1
(gdb) set print asm-demangle on     # Enable asm-demangle
(gdb) disassemble /m                # Disassemble main function
(gdb) continue                      # Led blinking on for 1/2 sec then off 1/2 sec
^C                                  # Stop with Ctrl+C
(gdb) enable 1                      # Enable breakpiont 1
(gdb) continue                      # Continue, will stop at main.rs:16
(gdb) print half_period             # Print half_period result is 500
(gdb) set half_period = 2000        # Set half_period to 2000ms
(gdb) print half_period             # Print half_period and result is 2000
(gdb) disable 1                     # Disable breakpoint 1
(gdb) continue                      # Led blinking on for 2 secs then off 2 sec
^C                                  # Stop with Ctrl+C
(gdb) quit                          # Quit gdb</code></pre><p>å…³é”®æ›´æ”¹ä½äºæºä»£ç çš„ç¬¬ 13ã€17 å’Œ 20 è¡Œï¼Œæ‚¨å¯ä»¥åœ¨åæ±‡ç¼–ä¸­çœ‹åˆ°ã€‚åœ¨ 13 æˆ‘ä»¬åˆ›å»º<code>v_half_period</code>ç„¶å <code>read()</code>å®ƒçš„å€¼åœ¨ç¬¬ 17 å’Œ 20 è¡Œã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬<code>set half_period = 2000</code> ç°åœ¨ LED å°†æ‰“å¼€ 2 ç§’ç„¶åå…³é—­ 2 ç§’ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run --target thumbv7em-none-eabihf
   Compiling led-roulette v0.2.0 (~/embedded-discovery/src/05-led-roulette)
    Finished dev [unoptimized + debuginfo] target(s) in 0.18s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...

(gdb) target remote :3333
Remote debugging using :3333
led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x5258 lma 0x8000194
Loading section .rodata, size 0xbd8 lma 0x80053ec
Start address 0x08000194, load size 24516
Transfer rate: 21 KB/sec, 6129 bytes/write.

(gdb) break main.rs:16
Breakpoint 1 at 0x8000246: file src/05-led-roulette/src/main.rs, line 16.
Note: automatically using hardware breakpoints for read-only addresses.

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) disable 1

(gdb) set print asm-demangle on

(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17he1f2bc7990b13731E:
9       fn main() -> ! {
   0x0800020e <+0>:     push    {r7, lr}
   0x08000210 <+2>:     mov     r7, sp
   0x08000212 <+4>:     sub     sp, #72 ; 0x48
   0x08000214 <+6>:     add     r0, sp, #36     ; 0x24

10          let (mut delay, mut leds): (Delay, LedArray) = aux5::init();
   0x08000216 <+8>:     bl      0x800036a <aux5::init>
   0x0800021a <+12>:    b.n     0x800021c <led_roulette::__cortex_m_rt_main+14>
   0x0800021c <+14>:    add     r0, sp, #36     ; 0x24
   0x0800021e <+16>:    add     r1, sp, #8
   0x08000220 <+18>:    ldmia.w r0, {r2, r3, r4, r12, lr}
   0x08000224 <+22>:    stmia.w r1, {r2, r3, r4, r12, lr}
   0x08000228 <+26>:    ldr     r0, [sp, #56]   ; 0x38
   0x0800022a <+28>:    ldr     r1, [sp, #60]   ; 0x3c
   0x0800022c <+30>:    str     r1, [sp, #32]
   0x0800022e <+32>:    str     r0, [sp, #28]
   0x08000230 <+34>:    mov.w   r0, #500        ; 0x1f4

11
12          let mut half_period = 500_u16;
   0x08000234 <+38>:    strh.w  r0, [r7, #-6]
   0x08000238 <+42>:    subs    r0, r7, #6

13          let v_half_period = Volatile::new(&mut half_period);
   0x0800023a <+44>:    bl      0x800033e <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::new<&mut u16>>
   0x0800023e <+48>:    str     r0, [sp, #68]   ; 0x44
   0x08000240 <+50>:    b.n     0x8000242 <led_roulette::__cortex_m_rt_main+52>

14
15          loop {
   0x08000242 <+52>:    b.n     0x8000244 <led_roulette::__cortex_m_rt_main+54>
   0x08000244 <+54>:    add     r0, sp, #28
   0x08000288 <+122>:   b.n     0x8000244 <led_roulette::__cortex_m_rt_main+54>

16              leds[0].on().ok();
=> 0x08000246 <+56>:    bl      0x800032c <switch_hal::output::{{impl}}::on<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800024a <+60>:    b.n     0x800024c <led_roulette::__cortex_m_rt_main+62>
   0x0800024c <+62>:    bl      0x80005fc <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000250 <+66>:    b.n     0x8000252 <led_roulette::__cortex_m_rt_main+68>
   0x08000252 <+68>:    add     r0, sp, #68     ; 0x44

17              delay.delay_ms(v_half_period.read());
   0x08000254 <+70>:    bl      0x800034a <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::read<&mut u16,u16,volatile::access::ReadWrite>>
   0x08000258 <+74>:    str     r0, [sp, #4]
   0x0800025a <+76>:    b.n     0x800025c <led_roulette::__cortex_m_rt_main+78>
   0x0800025c <+78>:    add     r0, sp, #8
   0x0800025e <+80>:    ldr     r1, [sp, #4]
   0x08000260 <+82>:    bl      0x8002fc4 <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000264 <+86>:    b.n     0x8000266 <led_roulette::__cortex_m_rt_main+88>
   0x08000266 <+88>:    add     r0, sp, #28

18
19              leds[0].off().ok();
   0x08000268 <+90>:    bl      0x8000882 <switch_hal::output::{{impl}}::off<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800026c <+94>:    b.n     0x800026e <led_roulette::__cortex_m_rt_main+96>
   0x0800026e <+96>:    bl      0x80005fc <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000272 <+100>:   b.n     0x8000274 <led_roulette::__cortex_m_rt_main+102>
   0x08000274 <+102>:   add     r0, sp, #68     ; 0x44

20              delay.delay_ms(v_half_period.read());
   0x08000276 <+104>:   bl      0x800034a <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::read<&mut u16,u16,volatile::access::ReadWrite>>
   0x0800027a <+108>:   str     r0, [sp, #0]
   0x0800027c <+110>:   b.n     0x800027e <led_roulette::__cortex_m_rt_main+112>
   0x0800027e <+112>:   add     r0, sp, #8
   0x08000280 <+114>:   ldr     r1, [sp, #0]
   0x08000282 <+116>:   bl      0x8002fc4 <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000286 <+120>:   b.n     0x8000288 <led_roulette::__cortex_m_rt_main+122>

End of assembler dump.

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x080037b2 in core::cell::UnsafeCell<u32>::get<u32> (self=0x20009fa0) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/cell.rs:1716
1716        }

(gdb) enable 1

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) print half_period
$2 = 500

(gdb) disable 1

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x08003498 in core::ptr::read_volatile<u32> (src=0xe000e010) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1052
1052        unsafe { intrinsics::volatile_load(src) }

(gdb) enable 1

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) print half_period
$3 = 500

(gdb) set half_period = 2000

(gdb) print half_period
$4 = 2000

(gdb) disable 1

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x0800348e in core::ptr::read_volatile<u32> (src=0xe000e010) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1046
1046    pub unsafe fn read_volatile<T>(src: *const T) -> T {

(gdb) q
Detaching from program: ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é¢˜ï¼å¦‚æœæ‚¨å¼€å§‹é™ä½ çš„å€¼ä¼šå‘ç”Ÿä»€ä¹ˆ<code>half_period</code>ï¼Ÿåœ¨ä»€ä¹ˆå€¼ä¸‹ <code>half_period</code>æ‚¨ä¸èƒ½å†çœ‹åˆ° LED é—ªçƒï¼Ÿ</p>
<h2 id="The-challenge"><a href="#The-challenge" class="headerlink" title="The challenge"></a>The challenge</h2><p>ä½ ç°åœ¨è£…å¤‡é½å…¨ï¼Œå¯ä»¥è¿æ¥æŒ‘æˆ˜ï¼æ‚¨çš„ä»»åŠ¡æ˜¯å®ç°æˆ‘åœ¨æœ¬ç« å¼€å¤´å‘æ‚¨å±•ç¤ºçš„åº”ç”¨ç¨‹åºã€‚</p>
<p>è¿™é‡Œåˆæ˜¯GIFï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/0k1r2Lc-163136409093323.gif" alt=""></p>
<p>æ­¤å¤–ï¼Œè¿™å¯èƒ½æœ‰åŠ©äºï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/timing-diagram.png" alt=""></p>
<p>è¿™æ˜¯æ—¶åºå›¾ã€‚å®ƒæŒ‡ç¤ºåœ¨ä»»ä½•ç»™å®šæ—¶åˆ»å“ªä¸ª LED äº®èµ·ï¼Œä»¥åŠæ¯ä¸ª LED äº®èµ·çš„æ—¶é—´ã€‚åœ¨ X è½´ä¸Šï¼Œæˆ‘ä»¬æœ‰ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´ã€‚æ—¶åºå›¾æ˜¾ç¤ºäº†ä¸€ä¸ªå‘¨æœŸã€‚æ­¤æ¨¡å¼å°†æ¯ 800 æ¯«ç§’é‡å¤ä¸€æ¬¡ã€‚Y è½´ç”¨åŸºç‚¹æ ‡è®°æ¯ä¸ª LEDï¼šåŒ—ã€ä¸œç­‰ã€‚ä½œä¸ºæŒ‘æˆ˜çš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨å¿…é¡»å¼„æ¸…æ¥š<code>Leds</code>é˜µåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ å¦‚ä½•æ˜ å°„åˆ°è¿™äº›åŸºç‚¹ï¼ˆæç¤ºï¼šï¼‰<code>cargo doc --open</code> <code>;-)</code>ã€‚</p>
<p>åœ¨ä½ å°è¯•è¿™ä¸ªæŒ‘æˆ˜ä¹‹å‰ï¼Œè®©æˆ‘ç»™ä½ ä¸€ä¸ªé¢å¤–çš„æç¤ºã€‚æˆ‘ä»¬çš„ GDB ä¼šè¯æ€»æ˜¯åœ¨å¼€å§‹æ—¶è¾“å…¥ç›¸åŒçš„å‘½ä»¤ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª<code>.gdb</code>æ–‡ä»¶åœ¨ GDB å¯åŠ¨åç«‹å³æ‰§è¡Œä¸€äº›å‘½ä»¤ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥çœå»åœ¨æ¯ä¸ª GDB ä¼šè¯ä¸­æ‰‹åŠ¨è¾“å…¥å®ƒä»¬çš„å·¥ä½œã€‚</p>
<p>äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†<code>../openocd.gdb</code>ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å®ƒçš„åŠŸèƒ½ä¸æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æ‰€åšçš„å·®ä¸å¤šï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–å‘½ä»¤ã€‚æŸ¥çœ‹è¯„è®ºä»¥è·å–æ›´å¤šä¿¡æ¯ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../openocd.gdb
# Connect to gdb remote server
target remote :3333

# Load will flash the code
load

# Eanble demangling asm names on disassembly
set print asm-demangle on

# Enable pretty printing
set print pretty on

# Disable style sources as the default colors can be hard to read
set style sources off

# Initialize monitoring so iprintln! macro output
# is sent from the itm port to itm.txt
monitor tpiu config internal itm.txt uart off 8000000

# Turn on the itm port
monitor itm port 0 on

# Set a breakpoint at main, aka entry
break main

# Set a breakpiont at DefaultHandler
break DefaultHandler

# Set a breakpiont at HardFault
break HardFault

# Continue running and until we hit the main breakpoint
continue

# Step from the trampoline code in entry into main
step<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>../.cargo/config.toml</code>æ–‡ä»¶æ¥æ‰§è¡Œ<code>../openocd.gdb</code></p>
<pre class="line-numbers language-console"><code class="language-console">nano ../.cargo/config.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç¼–è¾‘æ‚¨çš„<code>runner</code>å‘½ä»¤<code>-x ../openocd.gdb</code>ã€‚å‡è®¾æ‚¨ä½¿ç”¨<code>arm-none-eabi-gdb</code>çš„å·®å¼‚æ˜¯ï¼š</p>
<pre class="line-numbers language-diff"><code class="language-diff">~/embedded-discovery/src/05-led-roulette
$ git diff ../.cargo/config.toml
diff --git a/src/.cargo/config.toml b/src/.cargo/config.toml
index ddff17f..02ac952 100644
<span class="token coord">--- a/src/.cargo/config.toml</span>
<span class="token coord">+++ b/src/.cargo/config.toml</span>
<span class="token coord">@@ -1,5 +1,5 @@</span>
 [target.thumbv7em-none-eabihf]
<span class="token deleted">-runner = "arm-none-eabi-gdb -q"</span>
<span class="token inserted">+runner = "arm-none-eabi-gdb -q -x ../openocd.gdb"</span>
 # runner = "gdb-multiarch -q"
 # runner = "gdb -q"
 rustflags = [<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>çš„å…¨éƒ¨å†…å®¹<code>../.cargo/config.toml</code>ï¼Œå†æ¬¡å‡è®¾<code>arm-none-eabi-gdb</code>ï¼Œæ˜¯ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">[target.thumbv7em-none-eabihf]
runner = "arm-none-eabi-gdb -q -x ../openocd.gdb"
# runner = "gdb-multiarch -q"
# runner = "gdb -q"
rustflags = [
  "-C", "link-arg=-Tlink.x",
]

[build]
target = "thumbv7em-none-eabihf"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰äº†å®ƒï¼Œæ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç®€å•çš„<code>cargo run</code>å‘½ä»¤æ¥æ„å»ºä»£ç çš„ ARM ç‰ˆæœ¬å¹¶è¿è¡Œ<code>gdb</code>ä¼šè¯ã€‚è¯¥<code>gdb</code>ä¼šè®®ä¼šè‡ªåŠ¨é—ªçƒç¨‹åºå¹¶è·³è½¬åˆ°çš„å¼€å§‹<code>main</code>ï¼Œå› ä¸ºå®ƒ<code>step</code>çš„é€šè¿‡è¿›å…¥è¹¦åºŠï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run
~/embedded-discovery/src/05-led-roulette (Update-05-led-roulette-WIP)
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q -x openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...
led_roulette::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x52c0 lma 0x8000194
Loading section .rodata, size 0xb50 lma 0x8005454
Start address 0x08000194, load size 24484
Transfer rate: 21 KB/sec, 6121 bytes/write.
Breakpoint 1 at 0x8000202: file ~/embedded-discovery/src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline ()
    at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]
led_roulette::__cortex_m_rt_main () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:9
9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="My-solution"><a href="#My-solution" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Delay<span class="token punctuation">,</span> DelayMs<span class="token punctuation">,</span> LedArray<span class="token punctuation">,</span> OutputSwitch<span class="token punctuation">,</span> entry<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> leds<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> LedArray<span class="token punctuation">)</span> <span class="token operator">=</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50_u8</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿˜æœ‰ä¸€ä»¶äº‹ï¼æ£€æŸ¥æ‚¨çš„è§£å†³æ–¹æ¡ˆåœ¨â€œå‘å¸ƒâ€æ¨¡å¼ä¸‹ç¼–è¯‘æ—¶æ˜¯å¦ä¹Ÿæœ‰æ•ˆï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build --target thumbv7em-none-eabihf --release<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹<code>gdb</code>å‘½ä»¤å¯¹å…¶è¿›è¡Œæµ‹è¯•ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # or, you could simply call `cargo run --target thumbv7em-none-eabihf --release`
$ arm-none-eabi-gdb target/thumbv7em-none-eabihf/release/led-roulette
$ #                                              ~~~~~~~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>äºŒè¿›åˆ¶å¤§å°æ˜¯æˆ‘ä»¬åº”è¯¥æ—¶åˆ»å…³æ³¨çš„ä¸œè¥¿ï¼ä½ çš„è§£å†³æ–¹æ¡ˆæœ‰å¤šå¤§ï¼Ÿæ‚¨å¯ä»¥ä½¿ç”¨<code>size</code>å‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶ä¸Šçš„å‘½ä»¤æ¥æ£€æŸ¥ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # equivalent to size target/thumbv7em-none-eabihf/debug/led-roulette
$ cargo size --target thumbv7em-none-eabihf --bin led-roulette -- -A
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
led-roulette  :
section               size        addr
.vector_table          404   0x8000000
.text                21144   0x8000194
.rodata               3144   0x800542c
.data                    0  0x20000000
.bss                     4  0x20000000
.uninit                  0  0x20000004
.debug_abbrev        19160         0x0
.debug_info         471239         0x0
.debug_aranges       18376         0x0
.debug_ranges       102536         0x0
.debug_str          508618         0x0
.debug_pubnames      76975         0x0
.debug_pubtypes     112797         0x0
.ARM.attributes         58         0x0
.debug_frame         55848         0x0
.debug_line         282067         0x0
.debug_loc             845         0x0
.comment               147         0x0
Total              1673362


$ cargo size --target thumbv7em-none-eabihf --bin led-roulette --release -- -A
    Finished release [optimized + debuginfo] target(s) in 0.03s
led-roulette  :
section              size        addr
.vector_table         404   0x8000000
.text                5380   0x8000194
.rodata               564   0x8001698
.data                   0  0x20000000
.bss                    4  0x20000000
.uninit                 0  0x20000004
.debug_loc           9994         0x0
.debug_abbrev        1821         0x0
.debug_info         74974         0x0
.debug_aranges        600         0x0
.debug_ranges        6848         0x0
.debug_str          52828         0x0
.debug_pubnames     20821         0x0
.debug_pubtypes     18891         0x0
.ARM.attributes        58         0x0
.debug_frame         1088         0x0
.debug_line         15307         0x0
.comment               19         0x0
Total              209601<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>Cargo é¡¹ç›®å·²é…ç½®ä¸ºä½¿ç”¨ LTO æ„å»ºå‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
</blockquote>
<p>çŸ¥é“å¦‚ä½•è¯»å–è¿™ä¸ªè¾“å‡ºå—ï¼Ÿè¯¥<code>text</code>éƒ¨åˆ†åŒ…å«ç¨‹åºæŒ‡ä»¤ã€‚å°±æˆ‘è€Œè¨€ï¼Œå®ƒå¤§çº¦ä¸º 5.25KBã€‚å¦ä¸€æ–¹é¢ï¼Œ<code>data</code>å’Œ<code>bss</code>éƒ¨åˆ†åŒ…å«åœ¨ RAM ä¸­é™æ€åˆ†é…çš„<code>static</code>å˜é‡ï¼ˆå˜é‡ï¼‰ã€‚<code>static</code>æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªå˜é‡<code>aux5::init</code>ï¼›è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¾ç¤º 4 ä¸ªå­—èŠ‚çš„<code>bss</code>.</p>
<p>æœ€åä¸€ä»¶äº‹ï¼æˆ‘ä»¬ä¸€ç›´åœ¨ GDB ä¸­è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºï¼Œä½†æˆ‘ä»¬çš„ç¨‹åºæ ¹æœ¬ä¸ä¾èµ–äº GDBã€‚æ‚¨å¯ä»¥ç¡®è®¤è¿™æ˜¯å…³é—­ GDB å’Œ OpenOCDï¼Œç„¶åé€šè¿‡æŒ‰ä¸‹æ¿ä¸Šçš„é»‘è‰²æŒ‰é’®é‡ç½®æ¿ã€‚LED è½®ç›˜åº”ç”¨ç¨‹åºå°†åœ¨æ²¡æœ‰ GDB å¹²é¢„çš„æƒ…å†µä¸‹è¿è¡Œã€‚</p>
<h1 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello, world!"></a>Hello, world!</h1><blockquote>
<p><strong>æ³¨æ„äº‹é¡¹ STM32F3DISCOVERY ä¸Š</strong>çš„â€œç„Šæ¡¥â€SB10ï¼ˆå‚è§ç”µè·¯æ¿èƒŒé¢ï¼‰æ˜¯ä½¿ç”¨ ITM å’Œ<code>iprint!</code>å¦‚ä¸‹æ‰€ç¤ºçš„å®æ‰€å¿…éœ€çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹<strong>æœª</strong>ç„Šæ¥ï¼ˆå‚è§<a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">ç”¨æˆ·æ‰‹å†Œçš„</a>ç¬¬ 21 é¡µï¼‰ã€‚ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼šè¿™å®é™…ä¸Šå–å†³äºç”µè·¯æ¿ç‰ˆæœ¬ã€‚å¦‚æœæ‚¨æœ‰æ—§ç‰ˆæœ¬çš„ç”µè·¯æ¿ï¼Œå¦‚<a href="https://docs.rs-online.com/5192/0900766b814876f9.pdf" target="_blank" rel="noopener">æ—§ç”¨æˆ·æ‰‹å†Œ</a>æ‰€è¿°ï¼ŒSB10 å·²ç„Šæ¥ã€‚æ£€æŸ¥æ‚¨çš„ç”µè·¯æ¿ä»¥ç¡®å®šæ˜¯å¦éœ€è¦ä¿®å¤å®ƒã€‚ï¼‰</p>
</blockquote>
<blockquote>
<p><strong>TL;DR</strong>æ‚¨æœ‰ä¸¤ç§é€‰æ‹©æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š<strong>ç„Šæ¥</strong>ç„Šæ¡¥ SB10 æˆ–åœ¨ SWO å’Œ PB3 ä¹‹é—´è¿æ¥æ¯å¯¹æ¯è·³çº¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
</blockquote>
<p><img src="/images/loading.gif" data-original="../images/language/f3-swd.png" alt=""></p>
<hr>
<p>åœ¨æˆ‘ä»¬å¼€å§‹åšä½çº§çš„ä¸œè¥¿ä¹‹å‰ï¼Œå†å¤šä¸€ç‚¹æœ‰ç”¨çš„é­”æ³•ã€‚</p>
<p>é—ªçƒ LED å°±åƒåµŒå…¥å¼ä¸–ç•Œçš„â€œä½ å¥½ï¼Œä¸–ç•Œâ€ã€‚</p>
<p>ä½†åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¿è¡Œä¸€ä¸ªé€‚å½“çš„â€œHello, worldâ€ç¨‹åºï¼Œå°†å†…å®¹æ‰“å°åˆ°æ‚¨çš„è®¡ç®—æœºæ§åˆ¶å°ã€‚</p>
<p>è¿›å…¥<code>06-hello-world</code>ç›®å½•ã€‚é‡Œé¢æœ‰ä¸€äº›å…¥é—¨ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux6<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> itm <span class="token operator">=</span> aux6<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>iprintln</code>å®å°†æ ¼å¼åŒ–æ¶ˆæ¯ï¼Œå¹¶å°†å…¶è¾“å‡ºåˆ°å¾®æ§åˆ¶å™¨çš„<em>ITM</em>ã€‚ITM ä»£è¡¨ Instrumentation Trace Macrocellï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº SWDï¼ˆä¸²è¡Œçº¿è°ƒè¯•ï¼‰çš„é€šä¿¡åè®®ï¼Œå¯ç”¨äºå°†æ¶ˆæ¯ä»å¾®æ§åˆ¶å™¨å‘é€åˆ°è°ƒè¯•ä¸»æœºã€‚è¿™ç§é€šä¿¡åªæ˜¯<em>ä¸€ç§æ–¹å¼</em>ï¼šè°ƒè¯•ä¸»æœºä¸èƒ½å‘å¾®æ§åˆ¶å™¨å‘é€æ•°æ®ã€‚</p>
<p>ç®¡ç†è°ƒè¯•ä¼šè¯çš„ OpenOCD å¯ä»¥æ¥æ”¶é€šè¿‡æ­¤ ITM<em>é€šé“</em>å‘é€çš„æ•°æ®å¹¶å°†å…¶é‡å®šå‘åˆ°æ–‡ä»¶ã€‚</p>
<p>ITM åè®®å¤„ç†<em>å¸§</em>ï¼ˆæ‚¨å¯ä»¥å°†å®ƒä»¬è§†ä¸ºä»¥å¤ªç½‘å¸§ï¼‰ã€‚æ¯ä¸ªå¸§éƒ½æœ‰ä¸€ä¸ªæŠ¥å¤´å’Œä¸€ä¸ªå¯å˜é•¿åº¦çš„æœ‰æ•ˆè½½è·ã€‚OpenOCD å°†æ¥æ”¶è¿™äº›å¸§å¹¶å°†å®ƒä»¬ç›´æ¥å†™å…¥æ–‡ä»¶è€Œä¸è¿›è¡Œè§£æã€‚æ‰€ä»¥ï¼Œå¦‚æœå¾®æ§åˆ¶å™¨å‘é€å­—ç¬¦ä¸²â€œHello, world!â€ ä½¿ç”¨ <code>iprintln</code>å®ï¼ŒOpenOCD çš„è¾“å‡ºæ–‡ä»¶ä¸ä¼šå®Œå…¨åŒ…å«è¯¥å­—ç¬¦ä¸²ã€‚</p>
<p>è¦æ£€ç´¢åŸå§‹å­—ç¬¦ä¸²ï¼Œå¿…é¡»è§£æ OpenOCD çš„è¾“å‡ºæ–‡ä»¶ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¯¥ <code>itmdump</code>ç¨‹åºåœ¨æ–°æ•°æ®åˆ°è¾¾æ—¶æ‰§è¡Œè§£æã€‚</p>
<p>æ‚¨åº”è¯¥å·²ç»<code>itmdump</code>åœ¨å®‰è£…ç« èŠ‚ä¸­å®‰è£…äº†è¯¥ç¨‹åºã€‚</p>
<p>åœ¨æ–°ç»ˆç«¯ä¸­ï¼Œ<code>/tmp</code>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ *nix æ“ä½œç³»ç»Ÿï¼Œè¯·åœ¨ç›®å½•å†…è¿è¡Œæ­¤å‘½ä»¤<code>%TEMP%</code>ï¼Œå¦‚æœæ‚¨è¿è¡Œçš„æ˜¯ Windows ï¼Œåˆ™ä»ç›®å½•å†…è¿è¡Œæ­¤å‘½ä»¤ã€‚è¿™åº”è¯¥ä¸æ‚¨è¿è¡Œ OpenOCD çš„ç›®å½•ç›¸åŒã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong><code>itmdump</code>å’Œ<code>openocd</code>éƒ½ä»åŒä¸€ç›®å½•è¿è¡Œéå¸¸é‡è¦ï¼</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal

$ # *nix
$ cd /tmp && touch itm.txt

$ # Windows
$ cd %TEMP% && type nul >> itm.txt

$ # both
$ itmdump -F -f itm.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å‘½ä»¤å°†åƒ<code>itmdump</code>ç°åœ¨ä¸€æ ·é˜»æ­¢<code>itm.txt</code>æ–‡ä»¶ã€‚ä¿æŒè¿™ä¸ªç»ˆç«¯æ‰“å¼€ã€‚</p>
<p>ç¡®ä¿ STM32F3DISCOVERY æ¿å·²è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºã€‚ä»<code>/tmp</code>ç›®å½•ä¸­æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼ˆåœ¨ Windows ä¸Š<code>%TEMP%</code>ï¼‰ä»¥å¯åŠ¨ OpenOCDã€‚</p>
<p>å¥½å§ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ„å»ºå…¥é—¨ä»£ç å¹¶å°†å…¶é—ªå­˜åˆ°å¾®æ§åˆ¶å™¨ä¸­ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å°†æ„å»ºå¹¶è¿è¡Œåº”ç”¨ç¨‹åº<code>cargo run</code>. å¹¶ä½¿ç”¨<code>next</code>. å› ä¸º<code>openocd.gdb</code>åŒ…å«OpenOCDä¸­çš„<code>monitor</code>å‘½ä»¤<code>openocd.gdb</code>ä¼šå°† ITM è¾“å‡ºé‡å®šå‘åˆ° itm.txt å¹¶å°†<code>itmdump</code>å…¶å†™å…¥å…¶ç»ˆç«¯çª—å£ã€‚æ­¤å¤–ï¼Œå®ƒè®¾ç½®æ–­ç‚¹å¹¶é€æ­¥é€šè¿‡æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªå¯æ‰§è¡Œè¯­å¥å¤„çš„è¹¦åºŠ<code>fn main()</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">~/embedded-discovery/src/06-hello-world
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q -x ../openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world...
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:14
14          loop {}
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x2828 lma 0x8000194
Loading section .rodata, size 0x638 lma 0x80029bc
Start address 0x08000194, load size 12276
Transfer rate: 18 KB/sec, 4092 bytes/write.
Breakpoint 1 at 0x80001f0: file ~/embedded-discovery/src/06-hello-world/src/main.rs, line 8.
Note: automatically using hardware breakpoints for read-only addresses.
Breakpoint 2 at 0x800092a: file /home/wink/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 570.
Breakpoint 3 at 0x80029a8: file /home/wink/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 560.

Breakpoint 1, hello_world::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/06-hello-world/src/main.rs:8
8       #[entry]
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          let mut itm = aux6::init();

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨å‘å‡ºä¸€ä¸ª<code>next</code>å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†<code>aux6::init()</code>åœ¨ ä¸­çš„ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œè¯­å¥å¤„æ‰§è¡Œå¹¶åœæ­¢<code>main.rs</code>ï¼Œå®ƒå°†æˆ‘ä»¬å®šä½åœ¨ç¬¬ 12 è¡Œï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) next
12        iprintln!(&mut itm.stim[0], "Hello, world!");<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åå‘å‡ºå¦ä¸€ä¸ª<code>next</code>å°†æ‰§è¡Œç¬¬ 12 è¡Œçš„å‘½ä»¤ï¼Œæ‰§è¡Œ<code>iprintln</code>å¹¶åœ¨ç¬¬ 14 è¡Œåœæ­¢ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) next
14        loop {}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç°åœ¨æ—¢ç„¶<code>iprintln</code>å·²ç»æ‰§è¡Œï¼Œ<code>itmdump</code> ç»ˆç«¯çª—å£ä¸Šçš„è¾“å‡ºåº”è¯¥æ˜¯<code>Hello, world!</code>å­—ç¬¦ä¸²ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ itmdump -F -f itm.txt
(...)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¾ˆæ£’ï¼Œå¯¹å§ï¼Ÿ<code>iprintln</code>åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­éšæ„ç”¨ä½œæ—¥å¿—è®°å½•å·¥å…·ã€‚</p>
<h2 id="panic"><a href="#panic" class="headerlink" title="panic!"></a><code>panic!</code></h2><p>è¯¥<code>panic!</code>å®ä¹Ÿå°†å…¶è¾“å‡ºåˆ°ITMï¼</p>
<p>å°†<code>main</code>å‡½æ•°æ›´æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿è¡Œå¦ä¸€ä¸ªå»ºè®®ä¹‹å‰ï¼Œæˆ‘å‘ç°é€€å‡º gdb æ—¶å¿…é¡»ç¡®è®¤å¾ˆä¸æ–¹ä¾¿ã€‚å°†ä»¥ä¸‹æ–‡ä»¶æ·»åŠ åˆ°æ‚¨çš„ä¸»ç›®å½•ä¸­ï¼Œ<code>~/.gdbinit</code>ä»¥ä¾¿å®ƒç«‹å³é€€å‡ºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ~/.gdbinit
define hook-quit
  set confirm off
end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¥½çš„ï¼Œç°åœ¨ä½¿ç”¨<code>cargo run</code>ï¼Œå®ƒåœåœ¨ç¬¬ä¸€è¡Œ<code>fn main()</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
   Compiling hello-world v0.2.0 (~/embedded-discovery/src/06-hello-world)
    Finished dev [unoptimized + debuginfo] target(s) in 0.11s
     Running `arm-none-eabi-gdb -q -x ../openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world...
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          panic!("Hello, world!");
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x20fc lma 0x8000194
Loading section .rodata, size 0x554 lma 0x8002290
Start address 0x08000194, load size 10212
Transfer rate: 17 KB/sec, 3404 bytes/write.
Breakpoint 1 at 0x80001f0: file ~/embedded-discovery/src/06-hello-world/src/main.rs, line 8.
Note: automatically using hardware breakpoints for read-only addresses.
Breakpoint 2 at 0x8000222: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 570.
Breakpoint 3 at 0x800227a: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 560.

Breakpoint 1, hello_world::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/06-hello-world/src/main.rs:8
8       #[entry]
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          panic!("Hello, world!");
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ç®€çŸ­çš„å‘½ä»¤åç§°æ¥ä¿å­˜è¾“å…¥ï¼Œ<code>c</code>ç„¶åè¾“å…¥<code>Enter</code>æˆ–<code>Return</code>é”®ï¼š</p>
<pre><code>(gdb) c
Continuing.</code></pre><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ‚¨å°†åœ¨<code>itmdump</code>ç»ˆç«¯ä¸­çœ‹åˆ°ä¸€äº›æ–°çš„è¾“å‡ºã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
panicked at 'Hello, world!', src/06-hello-world/src/main.rs:10:5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åé”®å…¥<code>Ctrl-c</code>which åœ¨è¿è¡Œæ—¶è·³å‡ºå¾ªç¯ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">^C
Program received signal SIGINT, Interrupt.
0x0800115c in panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:57
57            atomic::compiler_fence(Ordering::SeqCst);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€ç»ˆï¼Œ<code>panic!</code>è¿™åªæ˜¯å¦ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå› æ­¤æ‚¨å¯ä»¥çœ‹åˆ°å®ƒç•™ä¸‹äº†å‡½æ•°è°ƒç”¨çš„ç—•è¿¹ã€‚è¿™å…è®¸æ‚¨ä½¿ç”¨<code>backtrace</code>æˆ–åªæ˜¯<code>bt</code>æŸ¥çœ‹å¯¼è‡´ææ…Œçš„è°ƒç”¨å †æ ˆï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) bt
#0  panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47
#1  0x080005c2 in core::panicking::panic_fmt () at library/core/src/panicking.rs:92
#2  0x0800055a in core::panicking::panic () at library/core/src/panicking.rs:50
#3  0x08000210 in hello_world::__cortex_m_rt_main () at src/06-hello-world/src/main.rs:10
#4  0x080001f4 in hello_world::__cortex_m_rt_main_trampoline () at src/06-hello-world/src/main.rs:8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¯ä»¥åšçš„å¦ä¸€ä»¶äº‹æ˜¯åœ¨è®°å½•<em>ä¹‹å‰</em>æ•æ‰ææ…Œã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šåšå‡ ä»¶äº‹ï¼›é‡ç½®åˆ°å¼€å¤´ï¼Œç¦ç”¨æ–­ç‚¹ 1ï¼Œåœ¨ å¤„è®¾ç½®ä¸€ä¸ªæ–°æ–­ç‚¹<code>rust_begin_unwind</code>ï¼Œåˆ—å‡ºæ–­ç‚¹ï¼Œç„¶åç»§ç»­ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000

(gdb) disable 1

(gdb) break rust_begin_unwind 
Breakpoint 4 at 0x800106c: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs, line 47.

(gdb) info break
Num     Type           Disp Enb Address    What
1       breakpoint     keep n   0x080001f0 in hello_world::__cortex_m_rt_main_trampoline 
                                           at ~/prgs/rust/tutorial/embedded-discovery/src/06-hello-world/src/main.rs:8
        breakpoint already hit 1 time
2       breakpoint     keep y   0x08000222 in cortex_m_rt::DefaultHandler_ 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:570
3       breakpoint     keep y   0x0800227a in cortex_m_rt::HardFault_ 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:560
4       breakpoint     keep y   0x0800106c in panic_itm::panic 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47

(gdb) c
Continuing.

Breakpoint 4, panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47
47          interrupt::disable();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ä¼šæ³¨æ„åˆ°è¿™æ¬¡<code>itmdump</code>æ§åˆ¶å°ä¸Šæ²¡æœ‰æ‰“å°ä»»ä½•å†…å®¹ã€‚å¦‚æœæ‚¨ä½¿ç”¨æ¢å¤ç¨‹åºï¼Œ<code>continue</code>åˆ™å°†æ‰“å°ä¸€ä¸ªæ–°è¡Œã€‚</p>
<p>åœ¨åé¢çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å…¶ä»–æ›´ç®€å•çš„é€šä¿¡åè®®ã€‚</p>
<p>æœ€åï¼Œè¾“å…¥<code>q</code>é€€å‡ºå‘½ä»¤ï¼Œå®ƒç«‹å³é€€å‡ºè€Œä¸è¦æ±‚ç¡®è®¤ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) q
Detaching from program: ~/prgs/rust/tutorial/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½œä¸ºä¸€ä¸ªæ›´çŸ­çš„åºåˆ—ï¼Œæ‚¨å¯ä»¥é”®å…¥<code>Ctrl-d</code>ï¼Œè¿™æ¶ˆé™¤äº†ä¸€æ¬¡å‡»é”®ï¼</p>
<blockquote>
<p><strong>æ³¨æ„</strong>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>(gdb)</code>æç¤ºè¢«è¦†ç›–<code>quit)</code></p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">quit)
Detaching from program: ~/prgs/rust/tutorial/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a>Registers</h1><p>æ˜¯æ—¶å€™æ¢ç´¢<code>Led</code>API åœ¨å¹•ååšäº†ä»€ä¹ˆäº†ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå®ƒåªæ˜¯å†™å…¥ä¸€äº›ç‰¹æ®Šçš„å†…å­˜åŒºåŸŸã€‚è¿›å…¥<code>07-registers</code>ç›®å½•ï¼Œè®©æˆ‘ä»¬é€å¥è¿è¡Œå¯åŠ¨ä»£ç ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic address!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x48001018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ä»€ä¹ˆé­”æ³•ï¼Ÿ</p>
<p>åœ°å€<code>0x48001018</code>æŒ‡å‘ä¸€ä¸ª<em>å¯„å­˜å™¨</em>ã€‚å¯„å­˜å™¨æ˜¯æ§åˆ¶<em>å¤–å›´è®¾å¤‡</em>çš„ç‰¹æ®Šå†…å­˜åŒºåŸŸã€‚å¤–å›´è®¾å¤‡æ˜¯ä¸€ç§ç”µå­å…ƒä»¶ï¼Œå®ƒç´§é‚»å¾®æ§åˆ¶å™¨å°è£…ä¸­çš„å¤„ç†å™¨ï¼Œä¸ºå¤„ç†å™¨æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚æ¯•ç«Ÿï¼Œå¤„ç†å™¨æœ¬èº«åªèƒ½åšæ•°å­¦å’Œé€»è¾‘ã€‚</p>
<p>æ­¤ç‰¹å®šå¯„å­˜å™¨æ§åˆ¶é€šç”¨è¾“å…¥/è¾“å‡º (GPIO)<em>å¼•è„š</em>ï¼ˆGPIO<em>æ˜¯</em>å¤–è®¾ï¼‰å¹¶å¯ç”¨äºå°†è¿™äº›å¼•è„šä¸­çš„æ¯ä¸€ä¸ª<em>é©±åŠ¨</em>ä¸º<em>ä½ç”µå¹³</em>æˆ–<em>é«˜ç”µå¹³</em>ã€‚</p>
<p><strong>æ—ç™½ï¼šLEDã€æ•°å­—è¾“å‡ºå’Œç”µå‹ç”µå¹³</strong></p>
<p>é©¾é©¶ï¼Ÿåˆ«é’ˆï¼Ÿä½çš„ï¼Ÿé«˜çš„ï¼Ÿ</p>
<p>å¼•è„šæ˜¯ç”µè§¦ç‚¹ã€‚æˆ‘ä»¬çš„å¾®æ§åˆ¶å™¨æœ‰å‡ ä¸ªï¼Œå…¶ä¸­ä¸€äº›è¿æ¥åˆ° LEDã€‚LEDï¼Œå³å‘å…‰äºŒæç®¡ï¼Œåªæœ‰åœ¨æ–½åŠ å…·æœ‰ç‰¹å®šææ€§çš„ç”µå‹æ—¶æ‰ä¼šå‘å…‰ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/LED_circuit.svg" alt=""></p>
<p>å¹¸è¿çš„æ˜¯ï¼Œå¾®æ§åˆ¶å™¨çš„å¼•è„šä»¥æ­£ç¡®çš„ææ€§è¿æ¥åˆ° LEDã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯é€šè¿‡å¼•è„š<em>è¾“å‡º</em>ä¸€äº›éé›¶ç”µå‹æ¥æ‰“å¼€ LEDã€‚è¿æ¥åˆ° LED çš„å¼•è„šé…ç½®ä¸º<em>æ•°å­—è¾“å‡º</em>ï¼Œåªèƒ½è¾“å‡ºä¸¤ç§ä¸åŒçš„ç”µå‹ç”µå¹³ï¼šâ€œä½â€ï¼Œ0 ä¼ï¼Œæˆ–â€œé«˜â€ï¼Œ3 ä¼ã€‚â€œé«˜â€ï¼ˆç”µå‹ï¼‰ç”µå¹³å°†æ‰“å¼€ LEDï¼Œè€Œâ€œä½â€ï¼ˆç”µå‹ï¼‰ç”µå¹³å°†å…³é—­å®ƒã€‚</p>
<p>è¿™äº›â€œä½â€å’Œâ€œé«˜â€çŠ¶æ€ç›´æ¥æ˜ å°„åˆ°æ•°å­—é€»è¾‘çš„æ¦‚å¿µã€‚â€œä½â€æ˜¯<code>0</code>æˆ–<code>false</code> ï¼Œâ€œé«˜â€æ˜¯<code>1</code>æˆ–<code>true</code>ã€‚è¿™å°±æ˜¯è¯¥å¼•è„šé…ç½®è¢«ç§°ä¸ºæ•°å­—è¾“å‡ºçš„åŸå› ã€‚</p>
<h2 id="RTRM-Reading-The-Reference-Manual"><a href="#RTRM-Reading-The-Reference-Manual" class="headerlink" title="RTRM: Reading The Reference Manual"></a>RTRM: Reading The Reference Manual</h2><p>æˆ‘æåˆ°å¾®æ§åˆ¶å™¨æœ‰å‡ ä¸ªå¼•è„šã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿™äº›å¼•è„šè¢«åˆ†ç»„ ä¸º 16 ä¸ªå¼•è„šçš„<em>ç«¯å£</em>ã€‚æ¯ä¸ªç«¯å£éƒ½ä»¥å­—æ¯å‘½åï¼šç«¯å£ Aã€ç«¯å£ B ç­‰ï¼Œæ¯ä¸ªç«¯å£å†…çš„å¼•è„šä»¥ 0 åˆ° 15 çš„æ•°å­—å‘½åã€‚</p>
<p>æˆ‘ä»¬å¿…é¡»æ‰¾å‡ºçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å“ªä¸ªå¼•è„šè¿æ¥åˆ°å“ªä¸ª LEDã€‚æ­¤ä¿¡æ¯åœ¨ STM32F3DISCOVERY<a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">ç”¨æˆ·æ‰‹å†Œä¸­</a>ï¼ˆæ‚¨ä¸‹è½½äº†å‰¯æœ¬ï¼Œå¯¹å—ï¼Ÿï¼‰ã€‚åœ¨è¿™ä¸ªç‰¹å®šéƒ¨åˆ†ï¼š</p>
<blockquote>
<p>ç¬¬ 6.4 èŠ‚ LED - ç¬¬ 18 é¡µ</p>
</blockquote>
<p>æ‰‹å†Œä¸Šè¯´ï¼š</p>
<ul>
<li><code>LD3</code>ï¼ŒåŒ— LEDï¼Œè¿æ¥åˆ°å¼•è„š<code>PE9</code>ã€‚<code>PE9</code>æ˜¯ä»¥ä¸‹çš„ç¼©å†™å½¢å¼ï¼šç«¯å£ E ä¸Šçš„å¼•è„š 9ã€‚</li>
<li><code>LD7</code>ï¼Œä¸œ LEDï¼Œè¿æ¥åˆ°å¼•è„š<code>PE11</code>ã€‚</li>
</ul>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬è¦æ›´æ”¹å¼•è„š PE9 å’Œ PE11 çš„çŠ¶æ€ä»¥æ‰“å¼€/å…³é—­åŒ—/ä¸œ LEDã€‚è¿™äº›å¼•è„šæ˜¯ç«¯å£ E çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å¤„ç†<code>GPIOE</code> å¤–å›´è®¾å¤‡ã€‚</p>
<p>æ¯ä¸ªå¤–è®¾éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„å¯„å­˜å™¨<em>å—</em>ã€‚å¯„å­˜å™¨å—æ˜¯åˆ†é…åœ¨è¿ç»­å†…å­˜ä¸­çš„å¯„å­˜å™¨é›†åˆã€‚å¯„å­˜å™¨å—å¼€å§‹çš„åœ°å€ç§°ä¸ºåŸºåœ°å€ã€‚æˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥š<code>GPIOE</code>å¤–å›´è®¾å¤‡çš„åŸºåœ°å€æ˜¯ä»€ä¹ˆã€‚è¯¥ä¿¡æ¯ä½äºå¾®æ§åˆ¶å™¨<a href="http://www.st.com/resource/en/reference_manual/dm00043574.pdf" target="_blank" rel="noopener">å‚è€ƒæ‰‹å†Œ</a>çš„ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
<blockquote>
<p>ç¬¬ 3.2.2 èŠ‚å†…å­˜æ˜ å°„å’Œå¯„å­˜å™¨è¾¹ç•Œåœ°å€ - ç¬¬ 51 é¡µ</p>
</blockquote>
<p>è¯¥è¡¨è¡¨ç¤º<code>GPIOE</code>å¯„å­˜å™¨å—çš„åŸºåœ°å€æ˜¯<code>0x4800_1000</code>ã€‚</p>
<p>æ¯ä¸ªå¤–è®¾åœ¨æ–‡æ¡£ä¸­ä¹Ÿæœ‰è‡ªå·±çš„éƒ¨åˆ†ã€‚è¿™äº›éƒ¨åˆ†ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä»¥å¤–è®¾å¯„å­˜å™¨å—åŒ…å«çš„å¯„å­˜å™¨è¡¨ç»“æŸã€‚å¯¹äº<code>GPIO</code>å¤–å›´è®¾å¤‡ç³»åˆ—ï¼Œè¯¥è¡¨ä½äºï¼š</p>
<blockquote>
<p>ç¬¬ 11.4.12 èŠ‚ GPIO å¯„å­˜å™¨æ˜ å°„ - ç¬¬ 243 é¡µ</p>
</blockquote>
<p>â€œBSRRâ€æ˜¯æˆ‘ä»¬å°†ç”¨äºè®¾ç½®/å¤ä½çš„å¯„å­˜å™¨ã€‚å®ƒçš„åç§»å€¼æ˜¯â€œGPIOEâ€åŸºåœ°å€çš„â€œ0x18â€ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‚è€ƒæ‰‹å†Œä¸­æŸ¥æ‰¾ BSRRã€‚GPIO å¯„å­˜å™¨ -&gt; GPIO ç«¯å£ä½è®¾ç½®/å¤ä½å¯„å­˜å™¨ (GPIOx_BSRR)ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦è·³è½¬åˆ°è¯¥ç‰¹å®šå¯„å­˜å™¨çš„æ–‡æ¡£ã€‚è¿™æ˜¯ä¸Šé¢çš„å‡ é¡µï¼š</p>
<blockquote>
<p>ç¬¬ 11.4.7 èŠ‚ GPIO ç«¯å£ä½è®¾ç½®/å¤ä½å¯„å­˜å™¨ (GPIOx_BSRR) - ç¬¬ 240 é¡µ</p>
</blockquote>
<p>æœ€åï¼</p>
<p>è¿™æ˜¯æˆ‘ä»¬è¦å†™å…¥çš„å¯„å­˜å™¨ã€‚æ–‡æ¡£è¯´äº†ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚é¦–å…ˆï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯åªå†™çš„â€¦â€¦æ‰€ä»¥è®©æˆ‘ä»¬å°è¯•è¯»å–å®ƒçš„å€¼<code>:-)</code>ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨GDBçš„<code>examine</code>å‘½ä»¤ï¼š<code>x</code>ã€‚</p>
<pre><code>(gdb) next
16              *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 9;

(gdb) x 0x48001018
0x48001018:     0x00000000

(gdb) # the next command will turn the North LED on
(gdb) next
19              *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 11;

(gdb) x 0x48001018
0x48001018:     0x00000000</code></pre><p>è¯»å–å¯„å­˜å™¨è¿”å›<code>0</code>ã€‚è¿™ä¸æ–‡æ¡£æ‰€è¯´çš„ç›¸ç¬¦ã€‚</p>
<p>æ–‡æ¡£è¯´çš„å¦ä¸€ä»¶äº‹æ˜¯ä½ 0 åˆ° 15 å¯ç”¨äº<em>è®¾ç½®</em>ç›¸åº”çš„å¼•è„šã€‚å³ä½ 0 è®¾ç½®å¼•è„š 0ã€‚è¿™é‡Œï¼Œ<em>è®¾ç½®</em>æ„å‘³ç€åœ¨å¼•è„šä¸Šè¾“å‡º<em>é«˜</em>å€¼ã€‚</p>
<p>è¯¥æ–‡æ¡£è¿˜è¯´ï¼Œç¬¬ 16 åˆ° 31 ä½å¯ç”¨äº<em>é‡ç½®</em>ç›¸åº”çš„å¼•è„šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬ 16 ä½é‡ç½®å¼•è„šç¼–å· 0ã€‚æ­£å¦‚æ‚¨å¯èƒ½çŒœåˆ°çš„ï¼Œ<em>é‡ç½®</em>æ„å‘³ç€åœ¨å¼•è„šä¸Šè¾“å‡ºä¸€ä¸ª<em>ä½å€¼</em>ã€‚</p>
<p>å°†è¿™äº›ä¿¡æ¯ä¸æˆ‘ä»¬çš„ç¨‹åºç›¸å…³è”ï¼Œä¼¼ä¹éƒ½ä¸€è‡´ï¼š</p>
<ul>
<li>å†™<code>1 &lt;&lt; 9</code>( <code>BS9 = 1</code>)<code>BSRR</code> è®¾ç½®<code>PE9</code> <em>é«˜</em>ã€‚é‚£ä¼šä½¿åŒ—æ–¹LED<em>ä¸Š</em>ã€‚</li>
<li>å†™<code>1 &lt;&lt; 11</code>( <code>BS11 = 1</code>)<code>BSRR</code>è®¾ç½®<code>PE11</code> <em>é«˜</em>ã€‚é‚£ä¼šä½¿ä¸œLED<em>ä¸Š</em>ã€‚</li>
<li>å†™<code>1 &lt;&lt; 25</code>( <code>BR9 = 1</code>)<code>BSRR</code>è®¾ç½®<code>PE9</code> <em>ä½</em>ã€‚è¿™å°†<em>å…³é—­</em>åŒ—æ–¹ LED ã€‚</li>
<li>æœ€åï¼Œå°†<code>1 &lt;&lt; 27</code>( <code>BR11 = 1</code>)å†™å…¥<code>BSRR</code>è®¾ç½®ä¸º<code>PE11</code> <em>low</em>ã€‚è¿™ä¼š<em>å…³é—­</em>ä¸œ LED ã€‚</li>
</ul>
<h2 id="mis-Optimization"><a href="#mis-Optimization" class="headerlink" title="(mis)Optimization"></a>(mis)Optimization</h2><p>å¯¹å¯„å­˜å™¨çš„è¯»/å†™éå¸¸ç‰¹æ®Šã€‚æˆ‘ä»€è‡³æ•¢è¯´å®ƒä»¬æ˜¯å‰¯ä½œç”¨çš„ä½“ç°ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†å››ä¸ªä¸åŒçš„å€¼å†™å…¥åŒä¸€ä¸ªå¯„å­˜å™¨ã€‚å¦‚æœä½ ä¸çŸ¥é“åœ°å€æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä½ å¯èƒ½å·²ç»ç®€åŒ–äº†é€»è¾‘ï¼Œåªæ˜¯å°†æœ€ç»ˆå€¼<code>1 &lt;&lt; (11 + 16)</code>å†™å…¥å¯„å­˜å™¨ã€‚</p>
<p>å®é™…ä¸Šï¼Œç¼–è¯‘å™¨çš„åç«¯/ä¼˜åŒ–å™¨ LLVM ä¸çŸ¥é“æˆ‘ä»¬æ­£åœ¨å¤„ç†å¯„å­˜å™¨ï¼Œå¹¶ä¸”ä¼šåˆå¹¶å†™å…¥ä»è€Œæ”¹å˜æˆ‘ä»¬ç¨‹åºçš„è¡Œä¸ºã€‚è®©æˆ‘ä»¬å¿«é€Ÿæ£€æŸ¥ä¸€ä¸‹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run --release
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:7
7       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:9
9           aux7::init();

(gdb) next
25              *(GPIOE_BSRR as *mut u32) = 1 << (11 + 16);

(gdb) disassemble /m
Dump of assembler code for function _ZN9registers18__cortex_m_rt_main17h45b1ef53e18aa8d0E:
8       fn main() -> ! {
   0x08000248 <+0>:     push    {r7, lr}
   0x0800024a <+2>:     mov     r7, sp

9           aux7::init();
   0x0800024c <+4>:     bl      0x8000260 <aux7::init>
   0x08000250 <+8>:     movw    r0, #4120       ; 0x1018
   0x08000254 <+12>:    mov.w   r1, #134217728  ; 0x8000000
   0x08000258 <+16>:    movt    r0, #18432      ; 0x4800

10
11          unsafe {
12              // A magic address!
13              const GPIOE_BSRR: u32 = 0x48001018;
14
15              // Turn on the "North" LED (red)
16              *(GPIOE_BSRR as *mut u32) = 1 << 9;
17
18              // Turn on the "East" LED (green)
19              *(GPIOE_BSRR as *mut u32) = 1 << 11;
20
21              // Turn off the "North" LED
22              *(GPIOE_BSRR as *mut u32) = 1 << (9 + 16);
23
24              // Turn off the "East" LED
25              *(GPIOE_BSRR as *mut u32) = 1 << (11 + 16);
=> 0x0800025c <+20>:    str     r1, [r0, #0]
   0x0800025e <+22>:    b.n     0x800025e <registers::__cortex_m_rt_main+22>

End of assembler dump.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ¬¡ LED çš„çŠ¶æ€æ²¡æœ‰æ”¹å˜ï¼è¯¥<code>str</code>æŒ‡ä»¤æ˜¯å°†å€¼å†™å…¥å¯„å­˜å™¨çš„æŒ‡ä»¤ã€‚æˆ‘ä»¬çš„<em>è°ƒè¯•</em>ï¼ˆæœªä¼˜åŒ–ï¼‰ç¨‹åºæœ‰å››ä¸ªï¼Œæ¯æ¬¡å†™å…¥å¯„å­˜å™¨ä¸€ä¸ªï¼Œä½†<em>å‘å¸ƒ</em>ï¼ˆä¼˜åŒ–ï¼‰ç¨‹åºåªæœ‰ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä½¿ç”¨<code>objdump</code>å¹¶å°†è¾“å‡ºæ•è·åˆ°<code>out.asm</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console"># same as cargo objdump -- -d --no-show-raw-insn --print-imm-hex --source target/thumbv7em-none-eabihf/debug/registers
cargo objdump --bin registers -- -d --no-show-raw-insn --print-imm-hex --source > debug.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åæ£€æŸ¥<code>debug.txt</code>æŸ¥æ‰¾<code>main</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°4<code>str</code>æ¡æŒ‡ä»¤ï¼š</p>
<pre><code>080001ec &lt;main&gt;:
; #[entry]
 80001ec:       push    {r7, lr}
 80001ee:       mov     r7, sp
 80001f0:       bl      #0x2
 80001f4:       trap

080001f6 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2&gt;:
; fn main() -&gt; ! {
 80001f6:       push    {r7, lr}
 80001f8:       mov     r7, sp
;     aux7::init();
 80001fa:       bl      #0x3e
 80001fe:       b       #-0x2 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0xa&gt;
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 9;
 8000200:       movw    r0, #0x2640
 8000204:       movt    r0, #0x800
 8000208:       ldr     r0, [r0]
 800020a:       movw    r1, #0x1018
 800020e:       movt    r1, #0x4800
 8000212:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 11;
 8000214:       movw    r0, #0x2648
 8000218:       movt    r0, #0x800
 800021c:       ldr     r0, [r0]
 800021e:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; (9 + 16);
 8000220:       movw    r0, #0x2650
 8000224:       movt    r0, #0x800
 8000228:       ldr     r0, [r0]
 800022a:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; (11 + 16);
 800022c:       movw    r0, #0x2638
 8000230:       movt    r0, #0x800
 8000234:       ldr     r0, [r0]
 8000236:       str     r0, [r1]
;     loop {}
 8000238:       b       #-0x2 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0x44&gt;
 800023a:       b       #-0x4 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0x44&gt;
 (..)</code></pre><p>æˆ‘ä»¬å¦‚ä½•é˜²æ­¢ LLVM é”™è¯¯ä¼˜åŒ–æˆ‘ä»¬çš„ç¨‹åºï¼Ÿæˆ‘ä»¬ä½¿ç”¨<em>volatile</em>æ“ä½œè€Œä¸æ˜¯æ™®é€šçš„è¯»/å†™ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic address!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x48001018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>release.txt</code>ä½¿ç”¨ with<code>--release</code>æ¨¡å¼ç”Ÿæˆã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --release --bin registers -- -d --no-show-raw-insn --print-imm-hex --source > release.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç°åœ¨æ‰¾åˆ°<code>main</code>ä¾‹ç¨‹<code>release.txt</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† 4<code>str</code>æ¡æŒ‡ä»¤ã€‚</p>
<pre><code>0800023e &lt;main&gt;:
; #[entry]
 800023e:       push    {r7, lr}
 8000240:       mov     r7, sp
 8000242:       bl      #0x2
 8000246:       trap

08000248 &lt;registers::__cortex_m_rt_main::h45b1ef53e18aa8d0&gt;:
; fn main() -&gt; ! {
 8000248:       push    {r7, lr}
 800024a:       mov     r7, sp
;     aux7::init();
 800024c:       bl      #0x22
 8000250:       movw    r0, #0x1018
 8000254:       mov.w   r1, #0x200
 8000258:       movt    r0, #0x4800
;         intrinsics::volatile_store(dst, src);
 800025c:       str     r1, [r0]
 800025e:       mov.w   r1, #0x800
 8000262:       str     r1, [r0]
 8000264:       mov.w   r1, #0x2000000
 8000268:       str     r1, [r0]
 800026a:       mov.w   r1, #0x8000000
 800026e:       str     r1, [r0]
 8000270:       b       #-0x4 &lt;registers::__cortex_m_rt_main::h45b1ef53e18aa8d0+0x28&gt;
 (..)</code></pre><p>æˆ‘ä»¬çœ‹åˆ°å››ä¸ªå†™ï¼ˆ<code>str</code>æŒ‡ä»¤ï¼‰è¢«ä¿ç•™äº†ä¸‹æ¥ã€‚å¦‚æœæ‚¨ä½¿ç”¨å®ƒè¿è¡Œå®ƒï¼Œ <code>gdb</code>æ‚¨è¿˜ä¼šçœ‹åˆ°æˆ‘ä»¬å¾—åˆ°äº†é¢„æœŸçš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šæœ€åä¸€ä¸ª<code>next</code>å°†æ— é™æ‰§è¡Œ<code>loop {}</code>ï¼Œç”¨äº<code>Ctrl-c</code>è¿”å›<code>(gdb)</code>æç¤ºã€‚</p>
</blockquote>
<pre><code>$ cargo run --release
(..)

Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:9
9       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:11
11          aux7::init();

(gdb) next
18              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; 9);

(gdb) next
21              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; 11);

(gdb) next
24              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; (9 + 16));

(gdb) next
27              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; (11 + 16));

(gdb) next
^C
Program received signal SIGINT, Interrupt.
0x08000270 in registers::__cortex_m_rt_main ()
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1124
1124            intrinsics::volatile_store(dst, src);
(gdb) </code></pre><h2 id="0xBAAAAAAD-address"><a href="#0xBAAAAAAD-address" class="headerlink" title="0xBAAAAAAD address"></a><code>0xBAAAAAAD</code> address</h2><p>å¹¶éæ‰€æœ‰å¤–å›´å­˜å‚¨å™¨éƒ½å¯ä»¥è®¿é—®ã€‚çœ‹çœ‹è¿™ä¸ªç¨‹åºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x4800_1800</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªåœ°å€ä¸<code>GPIOE_BSRR</code>æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„åœ°å€å¾ˆæ¥è¿‘ï¼Œä½†æ˜¯è¿™ä¸ªåœ°å€æ˜¯<em>æ— æ•ˆçš„</em>ã€‚åœ¨è¿™ä¸ªåœ°å€æ²¡æœ‰å¯„å­˜å™¨çš„æ„ä¹‰ä¸Šæ˜¯æ— æ•ˆçš„ã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:9
9       #[entry]

(gdb) continue
Continuing.

Breakpoint 3, cortex_m_rt::HardFault_ (ef=0x20009fb0)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:560
560         loop {

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¯•å›¾åšä¸€ä¸ªæ— æ•ˆçš„æ“ä½œï¼Œè¯»å–ä¸å­˜åœ¨çš„å†…å­˜ï¼Œæ‰€ä»¥å¤„ç†å™¨å¼•å‘äº†ä¸€ä¸ª <em>å¼‚å¸¸</em>ï¼Œä¸€ä¸ª<em>ç¡¬ä»¶</em>å¼‚å¸¸ã€‚</p>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå½“å¤„ç†å™¨å°è¯•æ‰§è¡Œæ— æ•ˆæ“ä½œæ—¶ä¼šå¼•å‘å¼‚å¸¸ã€‚å¼‚å¸¸ä¼šç ´åç¨‹åºçš„æ­£å¸¸æµç¨‹å¹¶å¼ºåˆ¶å¤„ç†å™¨æ‰§è¡Œ<em>å¼‚å¸¸å¤„ç†ç¨‹åº</em>ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå‡½æ•°/å­ä¾‹ç¨‹ã€‚</p>
<p>æœ‰ä¸åŒç±»å‹çš„ä¾‹å¤–ã€‚æ¯ç§å¼‚å¸¸ç”±ä¸åŒçš„æ¡ä»¶å¼•å‘ï¼Œæ¯ç§å¼‚å¸¸ç”±ä¸åŒçš„å¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†ã€‚</p>
<p>è¯¥<code>aux7</code>ç®±å­ä¾èµ–äº<code>cortex-m-rt</code>å®ƒå®šä¹‰äº†é»˜è®¤ç®± <em>ç¡¬æ•…éšœ</em>å¤„ç†ç¨‹åºï¼Œå‘½å<code>HardFault</code>ï¼Œå¤„ç†è¯¥â€œæ— æ•ˆçš„å†…å­˜åœ°å€â€å¼‚å¸¸ã€‚<code>openocd.gdb</code>åœ¨ ä¸Šæ”¾ç½®ä¸€ä¸ªæ–­ç‚¹<code>HardFault</code>ï¼›è¿™å°±æ˜¯è°ƒè¯•å™¨åœ¨æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºæ—¶åœæ­¢ç¨‹åºçš„åŸå› ã€‚æˆ‘ä»¬å¯ä»¥ä»è°ƒè¯•å™¨ä¸­è·å–æœ‰å…³å¼‚å¸¸çš„æ›´å¤šä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼š</p>
<pre><code>(gdb) list
555     #[allow(unused_variables)]
556     #[doc(hidden)]
557     #[link_section = ".HardFault.default"]
558     #[no_mangle]
559     pub unsafe extern "C" fn HardFault_(ef: &amp;ExceptionFrame) -&gt; ! {
560         loop {
561             // add some side effect to prevent this from turning into a UDF instruction
562             // see rust-lang/rust#28728 for details
563             atomic::compiler_fence(Ordering::SeqCst);
564         }</code></pre><p><code>ef</code>æ˜¯å‘ç”Ÿå¼‚å¸¸ä¹‹å‰ç¨‹åºçŠ¶æ€çš„å¿«ç…§ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ï¼š</p>
<pre><code>(gdb) print/x *ef
$1 = cortex_m_rt::ExceptionFrame {
  r0: 0x48001800,
  r1: 0x80036b0,
  r2: 0x1,
  r3: 0x80000000,
  r12: 0xb,
  lr: 0x800020d,
  pc: 0x8001750,
  xpsr: 0xa1000200
}</code></pre><p>è¿™é‡Œæœ‰å‡ ä¸ªå­—æ®µï¼Œä½†æœ€é‡è¦çš„ä¸€ä¸ªæ˜¯<code>pc</code>ç¨‹åºè®¡æ•°å™¨å¯„å­˜å™¨ã€‚è¯¥å¯„å­˜å™¨ä¸­çš„åœ°å€æŒ‡å‘äº§ç”Ÿå¼‚å¸¸çš„æŒ‡ä»¤ã€‚è®©æˆ‘ä»¬å›´ç»•åæŒ‡ä»¤åæ±‡ç¼–ç¨‹åºã€‚</p>
<pre><code>(gdb) disassemble /m ef.pc
Dump of assembler code for function core::ptr::read_volatile&lt;u32&gt;:
1046    pub unsafe fn read_volatile&lt;T&gt;(src: *const T) -&gt; T {
   0x0800174c &lt;+0&gt;:     sub     sp, #12
   0x0800174e &lt;+2&gt;:     str     r0, [sp, #4]

1047        if cfg!(debug_assertions) &amp;&amp; !is_aligned_and_not_null(src) {
1048            // Not panicking to keep codegen impact smaller.
1049            abort();
1050        }
1051        // SAFETY: the caller must uphold the safety contract for `volatile_load`.
1052        unsafe { intrinsics::volatile_load(src) }
   0x08001750 &lt;+4&gt;:     ldr     r0, [r0, #0]
   0x08001752 &lt;+6&gt;:     str     r0, [sp, #8]
   0x08001754 &lt;+8&gt;:     ldr     r0, [sp, #8]
   0x08001756 &lt;+10&gt;:    str     r0, [sp, #0]
   0x08001758 &lt;+12&gt;:    b.n     0x800175a &lt;core::ptr::read_volatile&lt;u32&gt;+14&gt;

1053    }
   0x0800175a &lt;+14&gt;:    ldr     r0, [sp, #0]
   0x0800175c &lt;+16&gt;:    add     sp, #12
   0x0800175e &lt;+18&gt;:    bx      lr

End of assembler dump.</code></pre><p>å¼‚å¸¸æ˜¯ç”±<code>ldr r0, [r0, #0]</code>æŒ‡ä»¤å¼•èµ·çš„ï¼Œä¸€æ¡è¯»æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤è¯•å›¾è¯»å–<code>r0</code>å¯„å­˜å™¨æŒ‡ç¤ºåœ°å€å¤„çš„å†…å­˜ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œ<code>r0</code>æ˜¯CPUï¼ˆå¤„ç†å™¨ï¼‰å¯„å­˜å™¨ä¸æ˜¯å†…å­˜æ˜ å°„å¯„å­˜å™¨ï¼›å®ƒæ²¡æœ‰å…³è”çš„åœ°å€ï¼Œä¾‹å¦‚ï¼Œ <code>GPIO_BSRR</code>ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬èƒ½<code>r0</code>åœ¨å¼•å‘å¼‚å¸¸çš„é‚£ä¸€åˆ»æ£€æŸ¥å¯„å­˜å™¨çš„å€¼æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿå¥½å§ï¼Œæˆ‘ä»¬å·²ç»åšåˆ°äº†ï¼æˆ‘ä»¬ä¹‹å‰æ‰“å°<code>r0</code>çš„<code>ef</code>å€¼ä¸­çš„å­—æ®µ<code>r0</code>æ˜¯å¼•å‘å¼‚å¸¸æ—¶ registerçš„å€¼ã€‚åˆæ¥äº†ï¼š</p>
<pre><code>(gdb) print/x *ef
$1 = cortex_m_rt::ExceptionFrame {
  r0: 0x48001800,
  r1: 0x80036b0,
  r2: 0x1,
  r3: 0x80000000,
  r12: 0xb,
  lr: 0x800020d,
  pc: 0x8001750,
  xpsr: 0xa1000200
}</code></pre><p><code>r0</code>åŒ…å«<code>0x4800_1800</code>æˆ‘ä»¬è°ƒç”¨<code>read_volatile</code> å‡½æ•°çš„æ— æ•ˆåœ°å€çš„å€¼ã€‚</p>
<h2 id="Spooky-action-at-a-distance"><a href="#Spooky-action-at-a-distance" class="headerlink" title="Spooky action at a distance"></a>Spooky action at a distance</h2><p><code>BSRR</code>ä¸æ˜¯å”¯ä¸€å¯ä»¥æ§åˆ¶ç«¯å£ E å¼•è„šçš„<code>ODR</code>å¯„å­˜å™¨ã€‚è¯¥å¯„å­˜å™¨è¿˜å¯ä»¥è®©æ‚¨æ›´æ”¹å¼•è„šçš„å€¼ã€‚æ­¤å¤–ï¼Œ<code>ODR</code>è¿˜å¯ä»¥è®©æ‚¨æ£€ç´¢ç«¯å£ E çš„å½“å‰è¾“å‡ºçŠ¶æ€ã€‚</p>
<p><code>ODR</code> è®°å½•åœ¨ï¼š</p>
<blockquote>
<p>ç¬¬ 11.4.6 èŠ‚ GPIO ç«¯å£è¾“å‡ºæ•°æ®å¯„å­˜å™¨ - ç¬¬ 239 é¡µ</p>
</blockquote>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç¨‹åºã€‚è¿™ä¸ªç¨‹åºçš„å…³é”®æ˜¯<code>fn iprint_odr</code>. æ­¤å‡½æ•°å°†å½“å‰å€¼æ‰“å°<code>ODR</code>åˆ°<code>ITM</code>æ§åˆ¶å°</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> ITM<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Print the current contents of odr</span>
<span class="token keyword">fn</span> <span class="token function">iprint_odr</span><span class="token punctuation">(</span>itm<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ITM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> GPIOE_ODR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x4800_1014</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">iprintln!</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"ODR = 0x{:04x}"</span><span class="token punctuation">,</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>GPIOE_ODR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u16<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> itm<span class="token operator">=</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic addresses!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x4800_1018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Print the initial contents of ODR</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½ è¿è¡Œè¿™ä¸ªç¨‹åº</p>
<pre><code>$ cargo run
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:22
22      #[entry]

(gdb) continue
Continuing.</code></pre><p>æ‚¨å°†åœ¨ itmdump çš„æ§åˆ¶å°ä¸Šçœ‹åˆ°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump's console
(..)
ODR = 0x0000
ODR = 0x0200
ODR = 0x0a00
ODR = 0x0800
ODR = 0x0000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‰¯ä½œç”¨ï¼å°½ç®¡æˆ‘ä»¬å¤šæ¬¡è¯»å–åŒä¸€ä¸ªåœ°å€è€Œæ²¡æœ‰å®é™…ä¿®æ”¹å®ƒï¼Œä½†æ¯æ¬¡<code>BSRR</code>å†™å…¥æ—¶æˆ‘ä»¬ä»ç„¶çœ‹åˆ°å®ƒçš„å€¼å˜åŒ–ã€‚</p>
<h2 id="Type-safe-manipulation"><a href="#Type-safe-manipulation" class="headerlink" title="Type safe manipulation"></a>Type safe manipulation</h2><p>æˆ‘ä»¬ä½¿ç”¨çš„æœ€åä¸€ä¸ªå¯„å­˜å™¨<code>ODR</code>ï¼Œåœ¨å…¶æ–‡æ¡£ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<blockquote>
<p>ä½ 31:16 ä¿ç•™ï¼Œå¿…é¡»ä¿æŒåœ¨å¤ä½å€¼</p>
</blockquote>
<p>æˆ‘ä»¬ä¸åº”è¯¥å†™å…¥å¯„å­˜å™¨çš„é‚£äº›ä½ï¼Œå¦åˆ™å¯èƒ½ä¼šå‘ç”Ÿåäº‹ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªäº‹å®æ˜¯å¯„å­˜å™¨å…·æœ‰ä¸åŒçš„è¯»/å†™æƒé™ã€‚å…¶ä¸­ä¸€äº›æ˜¯åªå†™çš„ï¼Œå¦ä¸€äº›å¯ä»¥è¯»å–å’Œå†™å…¥ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€äº›æ˜¯åªè¯»çš„ã€‚</p>
<p>æœ€åï¼Œç›´æ¥ä½¿ç”¨åå…­è¿›åˆ¶åœ°å€å®¹æ˜“å‡ºé”™ã€‚æ‚¨å·²ç»çœ‹åˆ°å°è¯•è®¿é—®æ— æ•ˆçš„å†…å­˜åœ°å€ä¼šå¯¼è‡´å¼‚å¸¸ï¼Œä»è€Œä¸­æ–­æˆ‘ä»¬ç¨‹åºçš„æ‰§è¡Œã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª API æ¥ä»¥â€œå®‰å…¨â€çš„æ–¹å¼æ“ä½œå¯„å­˜å™¨ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿç†æƒ³æƒ…å†µä¸‹ï¼ŒAPI åº”è¯¥å¯¹æˆ‘æåˆ°çš„è¿™ä¸‰ç‚¹è¿›è¡Œç¼–ç ï¼šä¸è¦å¼„ä¹±å®é™…åœ°å€ï¼Œåº”è¯¥å°Šé‡è¯»/å†™æƒé™ï¼Œå¹¶åº”è¯¥é˜²æ­¢ä¿®æ”¹å¯„å­˜å™¨çš„ä¿ç•™éƒ¨åˆ†ã€‚</p>
<p>å¥½å§ï¼Œæˆ‘ä»¬æ„¿æ„ï¼<code>aux7::init()</code>å®é™…ä¸Šè¿”å›ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼æä¾›äº†ä¸€ä¸ªç±»å‹å®‰å…¨çš„ API æ¥æ“ä½œ<code>GPIOE</code>å¤–å›´è®¾å¤‡çš„å¯„å­˜å™¨ ã€‚</p>
<p>æ‚¨å¯èƒ½è¿˜è®°å¾—ï¼šä¸å¤–å›´è®¾å¤‡å…³è”çš„ä¸€ç»„å¯„å­˜å™¨ç§°ä¸ºå¯„å­˜å™¨å—ï¼Œå®ƒä½äºå†…å­˜çš„è¿ç»­åŒºåŸŸä¸­ã€‚åœ¨è¿™ç§ç±»å‹å®‰å…¨çš„ API ä¸­ï¼Œæ¯ä¸ªå¯„å­˜å™¨å—éƒ½è¢«å»ºæ¨¡ä¸ºä¸€ä¸ª<code>struct</code>å…¶ä¸­çš„æ¯ä¸ªå­—æ®µä»£è¡¨ä¸€ä¸ªå¯„å­˜å™¨ã€‚æ¯ä¸ªå¯„å­˜å™¨å­—æ®µéƒ½æ˜¯ä¸åŒçš„æ–°ç±»å‹ï¼Œä¾‹å¦‚<code>u32</code>å…¬å¼€ä»¥ä¸‹æ–¹æ³•çš„ç»„åˆï¼š<code>read</code>ï¼Œ<code>write</code>æˆ– <code>modify</code>æ ¹æ®å…¶è¯»/å†™æƒé™ã€‚æœ€åï¼Œè¿™äº›æ–¹æ³•ä¸é‡‡ç”¨åƒ é‚£æ ·çš„åŸå§‹å€¼<code>u32</code>ï¼Œè€Œæ˜¯é‡‡ç”¨å¦ä¸€ç§å¯ä»¥ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼æ„é€ çš„æ–°ç±»å‹ï¼Œå¹¶é˜²æ­¢ä¿®æ”¹å¯„å­˜å™¨çš„ä¿ç•™éƒ¨åˆ†ã€‚</p>
<p>ç†Ÿæ‚‰è¿™ä¸ª API çš„æœ€å¥½æ–¹æ³•æ˜¯å°†æˆ‘ä»¬çš„è¿è¡Œç¤ºä¾‹ç§»æ¤åˆ°å®ƒã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> ITM<span class="token punctuation">,</span> RegisterBlock<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioe <span class="token operator">=</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on the North LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">bs9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on the East LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">bs11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn off the North LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">br9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn off the East LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">br11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨æ³¨æ„åˆ°çš„ç¬¬ä¸€ä»¶äº‹ï¼šä¸æ¶‰åŠé­”æœ¯åœ°å€ã€‚ç›¸åï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´äººæ€§åŒ–çš„æ–¹å¼ï¼Œä¾‹å¦‚<code>gpioe.bsrr</code>ï¼Œ<code>BSRR</code>åœ¨<code>GPIOE</code>å¯„å­˜å™¨å—ä¸­å¼•ç”¨å¯„å­˜å™¨ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æœ‰è¿™ä¸ª<code>write</code>æ¥å—é—­åŒ…çš„æ–¹æ³•ã€‚å¦‚æœä½¿ç”¨èº«ä»½é—­åŒ… ( <code>|w| w</code>)ï¼Œæ­¤æ–¹æ³•ä¼šå°†å¯„å­˜å™¨è®¾ç½®ä¸ºå…¶<em>é»˜è®¤</em>ï¼ˆé‡ç½®ï¼‰å€¼ï¼Œå³åœ¨å¾®æ§åˆ¶å™¨ä¸Šç”µ/é‡ç½®åç«‹å³å…·æœ‰çš„å€¼ã€‚è¯¥å€¼<code>0x0</code>ç”¨äº<code>BSRR</code>å¯„å­˜å™¨ã€‚ç”±äºæˆ‘ä»¬æƒ³å‘å¯„å­˜å™¨å†™å…¥ä¸€ä¸ªéé›¶å€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨åƒ<code>bs9</code>å’Œ ä¹‹ç±»çš„æ„å»ºå™¨æ–¹æ³•<code>br9</code>æ¥è®¾ç½®é»˜è®¤å€¼çš„ä¸€äº›ä½ã€‚</p>
<p>è®©æˆ‘ä»¬è¿è¡Œè¿™ä¸ªç¨‹åºï¼<em>åœ¨</em>è°ƒè¯•ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚</p>
<p><code>gpioe</code>æ˜¯å¯¹<code>GPIOE</code>å¯„å­˜å™¨å—çš„å¼•ç”¨ã€‚<code>print gpioe</code>å°†è¿”å›å¯„å­˜å™¨å—çš„åŸºåœ°å€ã€‚</p>
<pre><code>$ cargo run
(..)

Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:7
7       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:9
9           let gpioe = aux7::init().1;

(gdb) next
12          gpioe.bsrr.write(|w| w.bs9().set_bit());

(gdb) print gpioe
$1 = (*mut stm32f3::stm32f303::gpioc::RegisterBlock) 0x48001000</code></pre><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æ”¹ä¸º<code>print *gpioe</code>ï¼Œæˆ‘ä»¬å°†è·å¾—å¯„å­˜å™¨å—çš„<em>å®Œæ•´è§†å›¾</em>ï¼šå°†æ‰“å°å…¶æ¯ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚</p>
<pre><code>(gdb) print *gpioe
$2 = stm32f3::stm32f303::gpioc::RegisterBlock {
  moder: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_MODER&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 1431633920
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_MODER&gt;
  },
  otyper: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_OTYPER&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_OTYPER&gt;
  },
  ospeedr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_OSPEEDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_OSPEEDR&gt;
  },
  pupdr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_PUPDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_PUPDR&gt;
  },
  idr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_IDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 204
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_IDR&gt;
  },
  odr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_ODR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_ODR&gt;
  },
  bsrr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_BSRR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_BSRR&gt;
  },
  lckr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_LCKR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_LCKR&gt;
  },
  afrl: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_AFRL&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_AFRL&gt;
  },
  afrh: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_AFRH&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_AFRH&gt;
  },
  brr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_BRR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_BRR&gt;
  }
}</code></pre><p>æ‰€æœ‰è¿™äº›æ–°ç±»å‹å’Œé—­åŒ…å¬èµ·æ¥åƒæ˜¯ä¼šç”Ÿæˆå¤§å‹ã€è‡ƒè‚¿çš„ç¨‹åºï¼Œä½†æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨å¯ç”¨<a href="https://en.wikipedia.org/wiki/Interprocedural_optimization" target="_blank" rel="noopener">LTO çš„æƒ…å†µ</a>ä¸‹åœ¨å‘å¸ƒæ¨¡å¼ä¸‹å®é™…ç¼–è¯‘ç¨‹åºï¼Œæ‚¨å°†çœ‹åˆ°å®ƒç”Ÿæˆçš„æŒ‡ä»¤ä¸ä½¿ç”¨çš„â€œä¸å®‰å…¨â€ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œ<code>write_volatile</code>å¹¶ä¸”åå…­è¿›åˆ¶åœ°å€åšåˆ°äº†ï¼</p>
<p>ç”¨<code>cargo objdump</code>æŠ¢çš„æ±‡ç¼–ä»£ç <code>release.txt</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin registers --release -- -d --no-show-raw-insn --print-imm-hex > release.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç„¶åæœç´¢<code>main</code>ä¸­<code>release.txt</code></p>
<pre><code>0800023e &lt;main&gt;:
 800023e:          push    {r7, lr}
 8000240:          mov    r7, sp
 8000242:          bl    #0x2
 8000246:          trap

08000248 &lt;registers::__cortex_m_rt_main::h199f1359501d5c71&gt;:
 8000248:          push    {r7, lr}
 800024a:          mov    r7, sp
 800024c:          bl    #0x22
 8000250:          movw    r0, #0x1018
 8000254:          mov.w    r1, #0x200
 8000258:          movt    r0, #0x4800
 800025c:          str    r1, [r0]
 800025e:          mov.w    r1, #0x800
 8000262:          str    r1, [r0]
 8000264:          mov.w    r1, #0x2000000
 8000268:          str    r1, [r0]
 800026a:          mov.w    r1, #0x8000000
 800026e:          str    r1, [r0]
 8000270:          b    #-0x4 &lt;registers::__cortex_m_rt_main::h199f1359501d5c71+0x28&gt;</code></pre><p>æœ€å¥½çš„éƒ¨åˆ†æ˜¯æ²¡æœ‰äººå¿…é¡»ç¼–å†™ä¸€è¡Œä»£ç æ¥å®ç° GPIOE APIã€‚æ‰€æœ‰ä»£ç éƒ½æ˜¯ä½¿ç”¨<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>å·¥å…·ä»ç³»ç»Ÿè§†å›¾æè¿° (SVD) æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ ã€‚æ­¤ SVD æ–‡ä»¶å®é™…ä¸Šæ˜¯å¾®æ§åˆ¶å™¨ä¾›åº”å•†æä¾›çš„ XML æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å…¶å¾®æ§åˆ¶å™¨çš„å¯„å­˜å™¨æ˜ å°„ã€‚è¯¥æ–‡ä»¶åŒ…å«å¯„å­˜å™¨å—çš„å¸ƒå±€ã€åŸºåœ°å€ã€æ¯ä¸ªå¯„å­˜å™¨çš„è¯»/å†™æƒé™ã€å¯„å­˜å™¨çš„å¸ƒå±€ã€å¯„å­˜å™¨æ˜¯å¦å…·æœ‰ä¿ç•™ä½ä»¥åŠè®¸å¤šå…¶ä»–æœ‰ç”¨ä¿¡æ¯ã€‚</p>
<h1 id="LEDs-again"><a href="#LEDs-again" class="headerlink" title="LEDs, again"></a>LEDs, again</h1><p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä¸ºæ‚¨æä¾›äº†<em>åˆå§‹åŒ–</em>ï¼ˆé…ç½®ï¼‰çš„å¤–å›´è®¾å¤‡ï¼ˆæˆ‘åœ¨ ä¸­åˆå§‹åŒ–äº†å®ƒä»¬ <code>aux7::init</code>ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»…ä»…å†™å…¥<code>BSRR</code>å°±è¶³ä»¥æ§åˆ¶ LED çš„åŸå› ã€‚ä½†æ˜¯ï¼Œå¤–è®¾ä¸ä¼šåœ¨å¾®æ§åˆ¶å™¨å¯åŠ¨åç«‹å³<em>åˆå§‹åŒ–</em>ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å°†è·å¾—æ›´å¤šå…³äºå¯„å­˜å™¨çš„ä¹è¶£ã€‚æˆ‘ä¸ä¼šåšä»»ä½•åˆå§‹åŒ–ï¼Œæ‚¨å¿…é¡»å°†é…ç½®<code>GPIOE</code>å¼•è„šåˆå§‹åŒ–ä¸ºæ•°å­—è¾“å‡ºå¼•è„šï¼Œä»¥ä¾¿æ‚¨èƒ½å¤Ÿå†æ¬¡é©±åŠ¨ LEDã€‚</p>
<p>è¿™æ˜¯å…¥é—¨ä»£ç ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>gpioe<span class="token punctuation">,</span> rcc<span class="token punctuation">)</span> <span class="token operator">=</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO initialize GPIOE</span>

    <span class="token comment" spellcheck="true">// Turn on all the LEDs in the compass</span>
    gpioe<span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">odr8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ‚¨è¿è¡Œå¯åŠ¨ä»£ç ï¼Œæ‚¨å°†çœ‹åˆ°è¿™æ¬¡æ²¡æœ‰ä»»ä½•ååº”ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ‰“å°<code>GPIOE</code>å¯„å­˜å™¨å—ï¼Œæ‚¨ä¼šçœ‹åˆ°å³ä½¿åœ¨<code>gpioe.odr.write</code>æ‰§è¡Œè¯­å¥ä¹‹åï¼Œæ¯ä¸ªå¯„å­˜å™¨çš„è¯»æ•°éƒ½ä¸ºé›¶ ï¼</p>
<pre><code>$ cargo run
Breakpoint 1, main () at src/08-leds-again/src/main.rs:9
9           let (gpioe, rcc) = aux8::init();

(gdb) continue
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
0x08000f3c in __bkpt ()

(gdb) finish
Run till exit from #0  0x08000f3c in __bkpt ()
main () at src/08-leds-again/src/main.rs:25
25          aux8::bkpt();

(gdb) p/x *gpioe
$1 = stm32f30x::gpioc::RegisterBlock {
  moder: stm32f30x::gpioc::MODER {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  otyper: stm32f30x::gpioc::OTYPER {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  ospeedr: stm32f30x::gpioc::OSPEEDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  pupdr: stm32f30x::gpioc::PUPDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  idr: stm32f30x::gpioc::IDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  odr: stm32f30x::gpioc::ODR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  bsrr: stm32f30x::gpioc::BSRR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  lckr: stm32f30x::gpioc::LCKR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  afrl: stm32f30x::gpioc::AFRL {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  afrh: stm32f30x::gpioc::AFRH {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  brr: stm32f30x::gpioc::BRR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  }
}</code></pre><h2 id="Power"><a href="#Power" class="headerlink" title="Power"></a>Power</h2><p>äº‹å®è¯æ˜ï¼Œä¸ºäº†çœç”µï¼Œå¤§å¤šæ•°å¤–å›´è®¾å¤‡éƒ½ä»¥æ–­ç”µçŠ¶æ€å¯åŠ¨â€”â€”è¿™æ˜¯å®ƒä»¬åœ¨å¾®æ§åˆ¶å™¨å¯åŠ¨åçš„çŠ¶æ€ã€‚</p>
<p>å¤ä½å’Œæ—¶é’Ÿæ§åˆ¶ ( <code>RCC</code>) å¤–è®¾å¯ç”¨äºæ‰“å¼€æˆ–å…³é—­æ‰€æœ‰å…¶ä»–å¤–è®¾ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®çš„<code>RCC</code>å¯„å­˜å™¨å—ä¸­æ‰¾åˆ°å¯„å­˜å™¨åˆ—è¡¨ï¼š</p>
<blockquote>
<p>ç¬¬ 9.4.14 èŠ‚ - RCC å¯„å­˜å™¨æ˜ å°„ - ç¬¬ 166 é¡µ - å‚è€ƒæ‰‹å†Œ</p>
</blockquote>
<p>æ§åˆ¶å…¶ä»–å¤–è®¾ç”µæºçŠ¶æ€çš„å¯„å­˜å™¨æœ‰ï¼š</p>
<ul>
<li><code>AHBENR</code></li>
<li><code>APB1ENR</code></li>
<li><code>APB2ENR</code></li>
</ul>
<p>è¿™äº›å¯„å­˜å™¨ä¸­çš„æ¯ä¸€ä½æ§åˆ¶å•ä¸ªå¤–è®¾çš„ç”µæºçŠ¶æ€ï¼ŒåŒ…æ‹¬<code>GPIOE</code>.</p>
<p>æ‚¨åœ¨æœ¬èŠ‚ä¸­çš„ä»»åŠ¡æ˜¯æ‰“å¼€<code>GPIOE</code>å¤–å›´è®¾å¤‡çš„ç”µæºã€‚ä½ å¿…é¡»ï¼š</p>
<ul>
<li>æ‰¾å‡ºæˆ‘ä¹‹å‰æåˆ°çš„ä¸‰ä¸ªå¯„å­˜å™¨ä¸­çš„å“ªä¸€ä¸ªå…·æœ‰æ§åˆ¶ç”µæºçŠ¶æ€çš„ä½ã€‚</li>
<li>å¼„æ¸…æ¥šè¯¥ä½å¿…é¡»è®¾ç½®ä¸ºä»€ä¹ˆå€¼ï¼Œ<code>0</code>æˆ–è€…<code>1</code>ï¼Œæ‰èƒ½æ‰“å¼€<code>GPIOE</code>å¤–è®¾ã€‚</li>
<li>æœ€åï¼Œæ‚¨å¿…é¡»æ›´æ”¹å¯åŠ¨ä»£ç ä»¥<em>ä¿®æ”¹</em>æ­£ç¡®çš„å¯„å­˜å™¨ä»¥æ‰“å¼€ <code>GPIOE</code>å¤–è®¾ã€‚</li>
</ul>
<p>å¦‚æœæˆåŠŸï¼Œæ‚¨å°†çœ‹åˆ°è¯¥<code>gpioe.odr.write</code>è¯­å¥ç°åœ¨å¯ä»¥ä¿®æ”¹<code>ODR</code>å¯„å­˜å™¨çš„å€¼ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œè¿™ä¸è¶³ä»¥å®é™…æ‰“å¼€ LEDã€‚</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>å¼€å¯GPIOEå¤–è®¾åï¼Œè¿˜éœ€è¦è¿›è¡Œé…ç½®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å¼•è„šé…ç½®ä¸ºæ•°å­—<em>è¾“å‡ºï¼Œ</em>ä»¥ä¾¿å®ƒä»¬å¯ä»¥é©±åŠ¨ LEDï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°å¼•è„šé…ç½®ä¸ºæ•°å­—<em>è¾“å…¥</em>ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®çš„<code>GPIOE</code>å¯„å­˜å™¨å—ä¸­æ‰¾åˆ°å¯„å­˜å™¨åˆ—è¡¨ï¼š</p>
<blockquote>
<p>ç¬¬ 11.4.12 èŠ‚ - GPIO å¯„å­˜å™¨ - ç¬¬ 243 é¡µ - å‚è€ƒæ‰‹å†Œ</p>
</blockquote>
<p>æˆ‘ä»¬å¿…é¡»å¤„ç†çš„å¯„å­˜å™¨æ˜¯ï¼š<code>MODER</code>ã€‚</p>
<p>æœ¬èŠ‚çš„ä»»åŠ¡æ˜¯è¿›ä¸€æ­¥æ›´æ–°å¯åŠ¨å™¨ä»£ç ä»¥å°†<em>æ­£ç¡®çš„</em> <code>GPIOE</code> å¼•è„šé…ç½®ä¸ºæ•°å­—è¾“å‡ºã€‚ä½ å¿…é¡»ï¼š</p>
<ul>
<li>æ‰¾å‡ºæ‚¨éœ€è¦å°†<em>å“ªäº›</em>å¼•è„šé…ç½®ä¸ºæ•°å­—è¾“å‡ºã€‚ï¼ˆæç¤ºï¼šæ£€æŸ¥<em>ç”¨æˆ·æ‰‹å†Œ</em>ï¼ˆç¬¬ 18 é¡µï¼‰çš„ç¬¬ 6.4 èŠ‚ LED ï¼‰ã€‚</li>
<li>é˜…è¯»æ–‡æ¡£ä»¥äº†è§£<code>MODER</code>å¯„å­˜å™¨ä¸­çš„ä½çš„ä½œç”¨ã€‚</li>
<li>ä¿®æ”¹<code>MODER</code>å¯„å­˜å™¨ä»¥å°†å¼•è„šé…ç½®ä¸ºæ•°å­—è¾“å‡ºã€‚</li>
</ul>
<p>å¦‚æœæˆåŠŸï¼Œæ‚¨å°†åœ¨è¿è¡Œç¨‹åºæ—¶çœ‹åˆ° 8 ä¸ª LED äº®èµ·ã€‚</p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>gpioe<span class="token punctuation">,</span> rcc<span class="token punctuation">)</span> <span class="token operator">=</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// enable the GPIOE peripheral</span>
    rcc<span class="token punctuation">.</span>ahbenr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">iopeen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configure the pins as outputs</span>
    gpioe<span class="token punctuation">.</span>moder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">moder8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on all the LEDs in the compass</span>
    gpioe<span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">odr8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Clocks-and-timers"><a href="#Clocks-and-timers" class="headerlink" title="Clocks and timers"></a>Clocks and timers</h1><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é‡æ–°å®ç° LED è½®ç›˜èµŒåº”ç”¨ç¨‹åºã€‚æˆ‘å°†æŠŠ<code>Led</code>æŠ½è±¡è¿˜ç»™ä½ ï¼Œ ä½†è¿™æ¬¡æˆ‘è¦æ‹¿èµ°<code>Delay</code>æŠ½è±¡<code>:-)</code>ã€‚</p>
<p>è¿™æ˜¯å…¥é—¨ä»£ç ã€‚è¯¥<code>delay</code>åŠŸèƒ½æœªå®ç°ï¼Œå› æ­¤å¦‚æœæ‚¨è¿è¡Œè¯¥ç¨‹åºï¼ŒLED å°†é—ªçƒå¾—å¦‚æ­¤ä¹‹å¿«ï¼Œä»¥è‡³äºå®ƒä»¬ä¼¼ä¹æ€»æ˜¯äº®ç€ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> tim6<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// TODO implement this</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> rcc<span class="token punctuation">,</span> tim6<span class="token punctuation">)</span> <span class="token operator">=</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO initialize TIM6</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="for-loop-delays"><a href="#for-loop-delays" class="headerlink" title="for loop delays"></a><code>for</code> loop delays</h2><p>ç¬¬ä¸€ä¸ªæŒ‘æˆ˜æ˜¯åœ¨<code>delay</code>ä¸ä½¿ç”¨ä»»ä½•å¤–è®¾çš„æƒ…å†µä¸‹å®ç°è¯¥åŠŸèƒ½ï¼Œæ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†å…¶å®ç°ä¸º<code>for</code>å¾ªç¯å»¶è¿Ÿï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“ç„¶ï¼Œä¸Šé¢çš„å®ç°æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå®ƒå¯¹äº çš„ä»»ä½•å€¼æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„å»¶è¿Ÿ<code>ms</code>ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å¿…é¡»ï¼š</p>
<ul>
<li>ä¿®å¤<code>delay</code>å‡½æ•°ä»¥ç”Ÿæˆä¸å…¶è¾“å…¥æˆæ¯”ä¾‹çš„å»¶è¿Ÿ<code>ms</code>ã€‚</li>
<li>è°ƒæ•´è¯¥<code>delay</code>åŠŸèƒ½ï¼Œä½¿ LED è½®ç›˜èµŒä»¥ 4 ç§’ï¼ˆ800 æ¯«ç§’å‘¨æœŸï¼‰å†…å¤§çº¦ 5 ä¸ªå‘¨æœŸçš„é€Ÿåº¦æ—‹è½¬ã€‚</li>
<li>å¾®æ§åˆ¶å™¨å†…éƒ¨çš„å¤„ç†å™¨æ—¶é’Ÿé¢‘ç‡ä¸º 72 MHzï¼Œå¹¶åœ¨ä¸€ä¸ªâ€œæ»´ç­”â€ï¼ˆä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰å†…æ‰§è¡Œå¤§å¤šæ•°æŒ‡ä»¤ã€‚<code>for</code>æ‚¨<em>è®¤ä¸º</em>è¯¥<code>delay</code>å‡½æ•°å¿…é¡»æ‰§è¡Œå¤šå°‘ ( ) ä¸ªå¾ªç¯æ‰èƒ½äº§ç”Ÿ 1 ç§’çš„å»¶è¿Ÿï¼Ÿ</li>
<li>å®é™…ä¸Šæœ‰å¤šå°‘ä¸ª<code>for</code>å¾ªç¯<code>delay(1000)</code>ï¼Ÿ</li>
<li>å¦‚æœåœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘æ‚¨çš„ç¨‹åºå¹¶è¿è¡Œå®ƒä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
</ul>
<h2 id="NOP"><a href="#NOP" class="headerlink" title="NOP"></a>NOP</h2><p>å¦‚æœåœ¨ä¸Šä¸€èŠ‚ä¸­æ‚¨åœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘ç¨‹åºå¹¶å®é™…æŸ¥çœ‹äº†åæ±‡ç¼–ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°è¯¥<code>delay</code>å‡½æ•°å·²è¢«ä¼˜åŒ–æ‰å¹¶ä¸”æ°¸è¿œä¸ä¼šåœ¨<code>main</code>.</p>
<p>LLVM è®¤ä¸ºè¯¥å‡½æ•°æ²¡æœ‰åšä»»ä½•æœ‰ä»·å€¼çš„äº‹æƒ…ï¼Œåªæ˜¯å°†å…¶åˆ é™¤ã€‚</p>
<p>æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥é˜²æ­¢ LLVM ä¼˜åŒ–<code>for</code>å¾ªç¯å»¶è¿Ÿï¼šæ·»åŠ <em>æ˜“å¤±æ€§</em>æ±‡ç¼–æŒ‡ä»¤ã€‚ä»»ä½•æŒ‡ä»¤éƒ½å¯ä»¥ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ NOPï¼ˆæ— æ“ä½œï¼‰æ˜¯ä¸€ä¸ªç‰¹åˆ«å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å‰¯ä½œç”¨ã€‚</p>
<p>æ‚¨çš„<code>for</code>å¾ªç¯å»¶è¿Ÿå°†å˜ä¸ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>_tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> K<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// this value needs to be tweaked</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">(</span>K <span class="token operator">*</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>delay</code>å½“ä½ åœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘ä½ çš„ç¨‹åºæ—¶ï¼Œè¿™ä¸ªæ—¶é—´ä¸ä¼šè¢« LLVM ç¼–è¯‘æ‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin clocks-and-timers --release -- -d --no-show-raw-insn
clocks-and-timers:      file format ELF32-arm-little

Disassembly of section .text:
clocks_and_timers::delay::h711ce9bd68a6328f:
 8000188:       push    {r4, r5, r7, lr}
 800018a:       movs    r4, #0
 800018c:       adds    r4, #1
 800018e:       uxth    r5, r4
 8000190:       bl      #4666
 8000194:       cmp     r5, #150
 8000196:       blo     #-14 <clocks_and_timers::delay::h711ce9bd68a6328f+0x4>
 8000198:       pop     {r4, r5, r7, pc}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼šåœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç¼–è¯‘ç¨‹åºå¹¶è¿è¡Œå®ƒï¼Œç„¶ååœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘ç¨‹åºå¹¶è¿è¡Œå®ƒã€‚å®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ‚¨è®¤ä¸ºé€ æˆå·®å¼‚çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿä½ èƒ½æƒ³å‡ºä¸€ç§æ–¹æ³•è®©å®ƒä»¬å†æ¬¡ç›¸ç­‰æˆ–è‡³å°‘æ›´ç›¸ä¼¼å—ï¼Ÿ</p>
<h2 id="One-shot-timer"><a href="#One-shot-timer" class="headerlink" title="One-shot timer"></a>One-shot timer</h2><p>æˆ‘å¸Œæœ›ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å·²ç»è®©æ‚¨ç¡®ä¿¡<code>for</code>å¾ªç¯å»¶è¿Ÿæ˜¯å®ç°å»¶è¿Ÿçš„ä¸€ç§ç³Ÿç³•æ–¹å¼ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<em>ç¡¬ä»¶è®¡æ—¶å™¨</em>å®ç°å»¶è¿Ÿã€‚ï¼ˆç¡¬ä»¶ï¼‰è®¡æ—¶å™¨çš„åŸºæœ¬åŠŸèƒ½æ˜¯â€¦â€¦ç²¾ç¡®è·Ÿè¸ªæ—¶é—´ã€‚å®šæ—¶å™¨æ˜¯å¦ä¸€ä¸ªå¯ä¾›å¾®æ§åˆ¶å™¨ä½¿ç”¨çš„å¤–è®¾ã€‚å› æ­¤å®ƒå¯ä»¥ä½¿ç”¨å¯„å­˜å™¨è¿›è¡Œæ§åˆ¶ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨çš„å¾®æ§åˆ¶å™¨æœ‰å‡ ä¸ªï¼ˆå®é™…ä¸Šè¶…è¿‡ 10 ä¸ªï¼‰ä¸åŒç±»å‹ï¼ˆåŸºæœ¬ã€é€šç”¨å’Œé«˜çº§å®šæ—¶å™¨ï¼‰çš„å®šæ—¶å™¨å¯ä¾›ä½¿ç”¨ã€‚æœ‰äº›è®¡æ—¶å™¨ æ¯”å…¶ä»–è®¡æ—¶å™¨å…·æœ‰æ›´é«˜çš„<em>åˆ†è¾¨ç‡</em>ï¼ˆä½æ•°ï¼‰ï¼Œè€Œæœ‰äº›è®¡æ—¶å™¨ä¸ä»…å¯ä»¥ç”¨äºè·Ÿè¸ªæ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨å…¶ä¸­ä¸€ç§<em>åŸºæœ¬</em>è®¡æ—¶å™¨ï¼š<code>TIM6</code>. è¿™æ˜¯æˆ‘ä»¬å¾®æ§åˆ¶å™¨ä¸­å¯ç”¨çš„æœ€ç®€å•çš„å®šæ—¶å™¨ä¹‹ä¸€ã€‚åŸºæœ¬è®¡æ—¶å™¨çš„æ–‡æ¡£åœ¨ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
<blockquote>
<p>ç¬¬ 22 èŠ‚å®šæ—¶å™¨ - ç¬¬ 670 é¡µ - å‚è€ƒæ‰‹å†Œ</p>
</blockquote>
<p>å…¶å¯„å­˜å™¨è®°å½•åœ¨ï¼š</p>
<blockquote>
<p>ç¬¬ 22.4.9 èŠ‚ TIM6/TIM7 å¯„å­˜å™¨æ˜ å°„ - ç¬¬ 682 é¡µ - å‚è€ƒæ‰‹å†Œ</p>
</blockquote>
<p>æˆ‘ä»¬å°†åœ¨æœ¬èŠ‚ä¸­ä½¿ç”¨çš„å¯„å­˜å™¨æ˜¯ï¼š</p>
<ul>
<li><code>SR</code>ï¼ŒçŠ¶æ€å¯„å­˜å™¨ã€‚</li>
<li><code>EGR</code>ï¼Œäº‹ä»¶ç”Ÿæˆå¯„å­˜å™¨ã€‚</li>
<li><code>CNT</code>ï¼Œè®¡æ•°å™¨å¯„å­˜å™¨ã€‚</li>
<li><code>PSC</code>ï¼Œé¢„åˆ†é¢‘å¯„å­˜å™¨ã€‚</li>
<li><code>ARR</code>ï¼Œè‡ªåŠ¨é‡è½½å¯„å­˜å™¨ã€‚</li>
</ul>
<p>æˆ‘ä»¬å°†ä½¿ç”¨è®¡æ—¶å™¨ä½œä¸º<em>ä¸€æ¬¡æ€§</em>è®¡æ—¶å™¨ã€‚å®ƒæœ‰ç‚¹åƒé—¹é’Ÿã€‚æˆ‘ä»¬å°†è®¡æ—¶å™¨è®¾ç½®ä¸ºåœ¨ä¸€æ®µæ—¶é—´åå…³é—­ï¼Œç„¶åæˆ‘ä»¬å°†ç­‰åˆ°è®¡æ—¶å™¨å…³é—­ã€‚è¯¥æ–‡æ¡£å°†è¿™ç§æ“ä½œæ¨¡å¼ç§°ä¸º<em>å•è„‰å†²æ¨¡å¼</em>ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å¯¹åŸºæœ¬å®šæ—¶å™¨åœ¨å•è„‰å†²æ¨¡å¼ä¸‹é…ç½®æ—¶å¦‚ä½•å·¥ä½œçš„æè¿°ï¼š</p>
<ul>
<li>è®¡æ•°å™¨ç”±ç”¨æˆ·å¯ç”¨ ( <code>CR1.CEN = 1</code>)ã€‚</li>
<li>è¯¥<code>CNT</code>å¯„å­˜å™¨å¤ä½å…¶å€¼ä¸ºé›¶ï¼Œå¹¶ä¸”ï¼Œåœ¨æ¯ä¸ªåˆ»åº¦ï¼Œå…¶å€¼è¢«åŠ ä¸€ã€‚</li>
<li>ä¸€æ—¦<code>CNT</code>å¯„å­˜å™¨è¾¾åˆ°å¯„å­˜å™¨çš„å€¼<code>ARR</code>ï¼Œè®¡æ•°å™¨å°†è¢«ç¡¬ä»¶ ( <code>CR1.CEN = 0</code>)ç¦ç”¨å¹¶å¼•å‘<em>æ›´æ–°äº‹ä»¶</em>( <code>SR.UIF = 1</code>)ã€‚</li>
</ul>
<p><code>TIM6</code>ç”± APB1 æ—¶é’Ÿé©±åŠ¨ï¼Œå…¶é¢‘ç‡ä¸å¿…ä¸å¤„ç†å™¨é¢‘ç‡åŒ¹é…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAPB1 æ—¶é’Ÿå¯ä»¥è¿è¡Œå¾—æ›´å¿«æˆ–æ›´æ…¢ã€‚ä½†æ˜¯ï¼Œé»˜è®¤è®¾ç½®æ˜¯ APB1 å’Œå¤„ç†å™¨çš„æ—¶é’Ÿé¢‘ç‡å‡ä¸º 8 MHzã€‚</p>
<p>åœ¨å•è„‰å†²æ¨¡å¼çš„åŠŸèƒ½æè¿°ä¸­æåˆ°çš„åˆ»åº¦æ˜¯<em>ä¸</em>ä¸€æ ·çš„APB1æ—¶é’Ÿçš„ä¸€ä¸ªåˆ»åº¦ã€‚çš„<code>CNT</code>åœ¨é¢‘ç‡å¯„å­˜å™¨å¢åŠ <code>apb1 / (psc + 1)</code> æ¯ç§’ï¼Œå…¶ä¸­å€<code>apb1</code>æ˜¯APB1æ—¶é’Ÿçš„é¢‘ç‡å’Œ<code>psc</code>åœ¨é¢„åˆ†é¢‘å¯„å­˜å™¨çš„å€¼ï¼Œ<code>PSC</code>ã€‚</p>
<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><p>ä¸å…¶ä»–æ‰€æœ‰å¤–è®¾ä¸€æ ·ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆåˆå§‹åŒ–æ­¤è®¡æ—¶å™¨ï¼Œç„¶åæ‰èƒ½ä½¿ç”¨å®ƒã€‚å’Œä¸Šä¸€èŠ‚ä¸€æ ·ï¼Œåˆå§‹åŒ–å°†æ¶‰åŠä¸¤ä¸ªæ­¥éª¤ï¼šå¯åŠ¨å®šæ—¶å™¨ï¼Œç„¶åé…ç½®å®ƒã€‚</p>
<p>å¯åŠ¨å®šæ—¶å™¨å¾ˆå®¹æ˜“ï¼šæˆ‘ä»¬åªéœ€å°†<code>TIM6EN</code>ä½è®¾ç½®ä¸º 1ã€‚è¯¥ä½ä½äºå¯„å­˜å™¨å—<code>APB1ENR</code> çš„<code>RCC</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Power on the TIM6 timer</span>
    rcc<span class="token punctuation">.</span>apb1enr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tim6en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>é…ç½®éƒ¨åˆ†ç¨å¾®å¤æ‚ä¸€äº›ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»å°†å®šæ—¶å™¨é…ç½®ä¸ºä»¥å•è„‰å†²æ¨¡å¼è¿è¡Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// OPM Select one pulse mode</span>
    <span class="token comment" spellcheck="true">// CEN Keep the counter disabled for now</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">opm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åï¼Œæˆ‘ä»¬å¸Œæœ›<code>CNT</code>è®¡æ•°å™¨ä»¥ 1 KHz çš„é¢‘ç‡è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬çš„<code>delay</code> å‡½æ•°å°†æ¯«ç§’æ•°ä½œä¸ºå‚æ•°ï¼Œè€Œ 1 KHz ä¼šäº§ç”Ÿ 1 æ¯«ç§’çš„å‘¨æœŸã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»é…ç½®é¢„åˆ†é¢‘å™¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Configure the prescaler to have the counter operate at 1 KHz</span>
    tim6<span class="token punctuation">.</span>psc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">psc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>psc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä¼šè®©ä½ å¼„æ¸…æ¥šé¢„åˆ†é¢‘å™¨çš„å€¼ï¼Œ<code>psc</code>. è¯·è®°ä½ï¼Œè®¡æ•°å™¨çš„é¢‘ç‡æ˜¯<code>apb1 / (psc + 1)</code>å’Œè¯¥<code>apb1</code>æ˜¯8MHzã€‚</p>
<h2 id="Busy-waiting"><a href="#Busy-waiting" class="headerlink" title="Busy waiting"></a>Busy waiting</h2><p>è®¡æ—¶å™¨ç°åœ¨åº”è¯¥æ­£ç¡®åˆå§‹åŒ–ã€‚å‰©ä¸‹çš„å°±æ˜¯<code>delay</code>ä½¿ç”¨å®šæ—¶å™¨æ¥å®ç°è¯¥åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è®¾ç½®è‡ªåŠ¨é‡è½½å¯„å­˜å™¨ ( <code>ARR</code>) ä»¥ä½¿è®¡æ—¶å™¨ä»¥<code>ms</code> æ¯«ç§’ä¸ºå•ä½ç»“æŸã€‚ç”±äºè®¡æ•°å™¨ä»¥ 1 KHz è¿è¡Œï¼Œå› æ­¤è‡ªåŠ¨é‡è½½å€¼å°†ä¸ ç›¸åŒ<code>ms</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Set the timer to go off in `ms` ticks</span>
    <span class="token comment" spellcheck="true">// 1 tick = 1 ms</span>
    tim6<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨è®¡æ•°å™¨ã€‚å®ƒå°†ç«‹å³å¼€å§‹è®¡æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// CEN: Enable the counter</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦ç­‰åˆ°è®¡æ•°å™¨è¾¾åˆ°è‡ªåŠ¨é‡è½½å¯„å­˜å™¨çš„å€¼<code>ms</code>ï¼Œç„¶åæˆ‘ä»¬å°±ä¼šçŸ¥é“<code>ms</code>æ¯«ç§’å·²ç»è¿‡å»äº†ã€‚è¿™ç§æƒ…å†µç§°ä¸º<em>æ›´æ–°äº‹ä»¶</em>ï¼Œå®ƒç”±<code>UIF</code>çŠ¶æ€å¯„å­˜å™¨ ( <code>SR</code>)çš„ä½æŒ‡ç¤ºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Wait until the alarm goes off (until the update event occurs)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¿™ç§åªç­‰å¾…ç›´åˆ°æ»¡è¶³æŸäº›æ¡ä»¶ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹<code>UIF</code>å˜ä¸º<code>1</code>ï¼‰çš„æ¨¡å¼ç§°ä¸º<em>å¿™ç­‰å¾…</em>ï¼Œæ‚¨å°†åœ¨æœ¬æ–‡ä¸­å¤šæ¬¡çœ‹åˆ°å®ƒ<code>:-)</code>ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å¿…é¡»æ¸…é™¤ï¼ˆè®¾ç½®ä¸º<code>0</code>ï¼‰è¯¥<code>UIF</code>ä½ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œä¸‹æ¬¡æˆ‘ä»¬è¿›å…¥è¯¥<code>delay</code> å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¼šè®¤ä¸ºæ›´æ–°äº‹ä»¶å·²ç»å‘ç”Ÿå¹¶è·³è¿‡å¿™ç­‰å¾…éƒ¨åˆ†ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Clear the update event flag</span>
    tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œå°†æ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€èµ·å¹¶æ£€æŸ¥å®ƒæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚</p>
<h2 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> tim6<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set the timer to go off in `ms` ticks</span>
    <span class="token comment" spellcheck="true">// 1 tick = 1 ms</span>
    tim6<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// CEN: Enable the counter</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wait until the alarm goes off (until the update event occurs)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Clear the update event flag</span>
    tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> rcc<span class="token punctuation">,</span> tim6<span class="token punctuation">)</span> <span class="token operator">=</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Power on the TIM6 timer</span>
    rcc<span class="token punctuation">.</span>apb1enr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tim6en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// OPM Select one pulse mode</span>
    <span class="token comment" spellcheck="true">// CEN Keep the counter disabled for now</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">opm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Configure the prescaler to have the counter operate at 1 KHz</span>
    <span class="token comment" spellcheck="true">// APB1_CLOCK = 8 MHz</span>
    <span class="token comment" spellcheck="true">// PSC = 7999</span>
    <span class="token comment" spellcheck="true">// 8 MHz / (7999 + 1) = 1 KHz</span>
    <span class="token comment" spellcheck="true">// The counter (CNT) will increase on every millisecond</span>
    tim6<span class="token punctuation">.</span>psc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">psc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">7_999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Serial-communication"><a href="#Serial-communication" class="headerlink" title="Serial communication"></a>Serial communication</h1><p><img src="/images/loading.gif" data-original="../images/language/800px-Serial_port.jpg" alt=""></p>
<p><em>è¿™å°±æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ã€‚æˆ‘å¸Œæœ›ä½ çš„ç”µè„‘æœ‰ä¸€ä¸ªï¼</em></p>
<p>å‘ï¼Œåˆ«æ‹…å¿ƒã€‚è¿™ç§è¿æ¥å™¨ DE-9 å¾ˆä¹…ä»¥å‰åœ¨ PC ä¸Šå·²ç»è¿‡æ—¶äº†ã€‚å®ƒè¢«é€šç”¨ä¸²è¡Œæ€»çº¿ (USB) å–ä»£ã€‚æˆ‘ä»¬ä¸ä¼šå¤„ç† DE-9 è¿æ¥å™¨æœ¬èº«ï¼Œè€Œæ˜¯å¤„ç†è¯¥ç”µç¼†é€šå¸¸ç”¨äº/é€šå¸¸ç”¨äºçš„é€šä¿¡åè®®ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ª<a href="https://en.wikipedia.org/wiki/Asynchronous_serial_communication" target="_blank" rel="noopener"><em>ä¸²è¡Œé€šä¿¡</em></a>æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯ä¸€ç§<em>å¼‚æ­¥</em>é€šä¿¡åè®®ï¼Œå…¶ä¸­ä¸¤ä¸ªè®¾å¤‡ä½¿ç”¨ä¸¤æ¡æ•°æ®çº¿ï¼ˆåŠ ä¸Šä¸€ä¸ªå…¬å…±æ¥åœ°ï¼‰<em>ä¸²è¡Œ</em>äº¤æ¢æ•°æ®ï¼Œå°±åƒä¸€æ¬¡ä¸€ä½ä¸€æ ·ã€‚è¯¥åè®®æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºå…±äº«çº¿è·¯éƒ½ä¸æºå¸¦æ—¶é’Ÿä¿¡å·ã€‚ç›¸åï¼ŒåŒæ–¹å¿…é¡»åœ¨é€šä¿¡å‘ç”Ÿ<em>ä¹‹å‰</em>å°±æ²¿çº¿è·¯å‘é€æ•°æ®çš„é€Ÿåº¦è¾¾æˆä¸€è‡´ã€‚è¯¥åè®®å…è®¸<em>åŒå·¥</em>é€šä¿¡ï¼Œå› ä¸ºæ•°æ®å¯ä»¥åŒæ—¶ä» A å‘é€åˆ° B å’Œä» B å‘é€åˆ° Aã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨æ­¤åè®®åœ¨å¾®æ§åˆ¶å™¨å’Œæ‚¨çš„è®¡ç®—æœºä¹‹é—´äº¤æ¢æ•°æ®ã€‚ä¸æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ ITM åè®®ç›¸æ¯”ï¼Œé€šè¿‡ä¸²è¡Œé€šä¿¡åè®®ï¼Œæ‚¨å¯ä»¥å°†æ•°æ®ä»è®¡ç®—æœºå‘é€åˆ°å¾®æ§åˆ¶å™¨ã€‚</p>
<p>æ‚¨å¯èƒ½è¦é—®çš„ä¸‹ä¸€ä¸ªå®é™…é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬é€šè¿‡è¯¥åè®®å‘é€æ•°æ®çš„é€Ÿåº¦æœ‰å¤šå¿«ï¼Ÿ</p>
<p>è¯¥åè®®é€‚ç”¨äºå¸§ã€‚æ¯ä¸ªå¸§æœ‰ä¸€ä¸ª<em>èµ·å§‹</em>ä½ã€5 åˆ° 9 ä½æœ‰æ•ˆè½½è·ï¼ˆæ•°æ®ï¼‰å’Œ 1 åˆ° 2 ä¸ª<em>åœæ­¢ä½</em>ã€‚åè®®çš„é€Ÿåº¦ç§°ä¸º<em>æ³¢ç‰¹ç‡</em>ï¼Œä»¥æ¯ç§’ä½æ•° (bps) ä¸ºå•ä½ã€‚å¸¸è§çš„æ³¢ç‰¹ç‡æœ‰ï¼š9600ã€19200ã€38400ã€57600 å’Œ 115200 bpsã€‚</p>
<p>å®é™…å›ç­”è¿™ä¸ªé—®é¢˜ï¼šä½¿ç”¨ 1 ä¸ªèµ·å§‹ä½ã€8 ä¸ªæ•°æ®ä½ã€1 ä¸ªåœæ­¢ä½å’Œ 115200 bps çš„æ³¢ç‰¹ç‡çš„å¸¸è§é…ç½®ï¼Œç†è®ºä¸Šå¯ä»¥æ¯ç§’å‘é€ 11,520 å¸§ã€‚ç”±äºæ¯ä¸€å¸§éƒ½æºå¸¦ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› æ­¤æ•°æ®é€Ÿç‡ä¸º 11.52 KB/sã€‚å®é™…ä¸Šï¼Œç”±äºé€šä¿¡è¾ƒæ…¢ç«¯ï¼ˆå¾®æ§åˆ¶å™¨ï¼‰çš„å¤„ç†æ—¶é—´ï¼Œæ•°æ®é€Ÿç‡å¯èƒ½ä¼šè¾ƒä½ã€‚</p>
<p>ä»Šå¤©çš„è®¡ç®—æœºä¸æ”¯æŒä¸²è¡Œé€šä¿¡åè®®ã€‚æ‰€ä»¥ä½ ä¸èƒ½ç›´æ¥å°†è®¡ç®—æœºè¿æ¥åˆ°å¾®æ§åˆ¶å™¨ã€‚ä½†è¿™å°±æ˜¯ä¸²è¡Œæ¨¡å—çš„ç”¨æ­¦ä¹‹åœ°ã€‚è¯¥æ¨¡å—å°†ä½äºä¸¤è€…ä¹‹é—´ï¼Œå¹¶ä¸ºå¾®æ§åˆ¶å™¨æä¾›ä¸€ä¸ªä¸²è¡Œæ¥å£ï¼Œå¹¶ä¸ºæ‚¨çš„è®¡ç®—æœºæä¾›ä¸€ä¸ª USB æ¥å£ã€‚å¾®æ§åˆ¶å™¨ä¼šå°†æ‚¨çš„è®¡ç®—æœºè§†ä¸ºå¦ä¸€ä¸ªä¸²è¡Œè®¾å¤‡ï¼Œè€Œæ‚¨çš„è®¡ç®—æœºä¼šå°†å¾®æ§åˆ¶å™¨è§†ä¸ºè™šæ‹Ÿä¸²è¡Œè®¾å¤‡ã€‚</p>
<h2 id="nix-tooling"><a href="#nix-tooling" class="headerlink" title="*nix tooling"></a>*nix tooling</h2><h3 id="å‘ç°æ¿çš„æ›´æ–°ç‰ˆæœ¬"><a href="#å‘ç°æ¿çš„æ›´æ–°ç‰ˆæœ¬" class="headerlink" title="å‘ç°æ¿çš„æ›´æ–°ç‰ˆæœ¬"></a>å‘ç°æ¿çš„æ›´æ–°ç‰ˆæœ¬</h3><p>åœ¨æ›´æ–°ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæ‚¨å°†å‘ç°æ¿è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªæ–°çš„ TTY è®¾å¤‡å‡ºç°åœ¨<code>/dev</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Linux
$ dmesg | tail | grep -i tty
[13560.675310] cdc_acm 1-1.1:1.2: ttyACM0: USB ACM device<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ USB &lt;-&gt; ä¸²è¡Œè®¾å¤‡ã€‚åœ¨ Linux ä¸Šï¼Œå®ƒè¢«å‘½åä¸º<code>tty*</code>ï¼ˆé€šå¸¸ä¸º <code>ttyACM*</code>æˆ–<code>ttyUSB*</code>ï¼‰ã€‚</p>
<p>å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°è®¾å¤‡å‡ºç°ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªè¾ƒæ—§çš„ç”µè·¯æ¿ç‰ˆæœ¬ï¼›æ£€æŸ¥ä¸‹ä¸€èŠ‚ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³æ—§ç‰ˆæœ¬çš„è¯´æ˜ã€‚å¦‚æœæ‚¨æœ‰è¾ƒæ–°çš„ä¿®è®¢ç‰ˆï¼Œè¯·è·³è¿‡ä¸‹ä¸€éƒ¨åˆ†å¹¶ç§»è‡³â€œminicomâ€éƒ¨åˆ†ã€‚</p>
<h3 id="å‘ç°æ¿-å¤–éƒ¨ä¸²è¡Œæ¨¡å—çš„æ—§ç‰ˆæœ¬"><a href="#å‘ç°æ¿-å¤–éƒ¨ä¸²è¡Œæ¨¡å—çš„æ—§ç‰ˆæœ¬" class="headerlink" title="å‘ç°æ¿/å¤–éƒ¨ä¸²è¡Œæ¨¡å—çš„æ—§ç‰ˆæœ¬"></a>å‘ç°æ¿/å¤–éƒ¨ä¸²è¡Œæ¨¡å—çš„æ—§ç‰ˆæœ¬</h3><p>å°†ä¸²è¡Œæ¨¡å—è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºï¼Œè®©æˆ‘ä»¬æ‰¾å‡ºæ“ä½œç³»ç»Ÿä¸ºå…¶åˆ†é…çš„åç§°ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>åœ¨ Mac ä¸Šï¼ŒUSB è®¾å¤‡å°†å‘½åä¸ºï¼š<code>/dev/cu.usbserial-*</code>. æ‚¨ä¸ä¼šä½¿ç”¨ æ‰¾åˆ°å®ƒ<code>dmesg</code>ï¼Œè€Œæ˜¯ç›¸åº”åœ°ä½¿ç”¨<code>ls -l /dev | grep cu.usb</code>å’Œè°ƒæ•´ä»¥ä¸‹å‘½ä»¤ï¼</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ dmesg | grep -i tty
(..)
[  +0.000155] usb 3-2: FTDI USB Serial Device converter now attached to ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä½†è¿™æ˜¯ä»€ä¹ˆ<code>ttyUSB0</code>ä¸œè¥¿ï¼Ÿå½“ç„¶æ˜¯æ–‡ä»¶å•¦ï¼ä¸€åˆ‡éƒ½æ˜¯ *nix ä¸­çš„æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -l /dev/ttyUSB0
crw-rw-rw- 1 root uucp 188, 0 Oct 27 00:00 /dev/ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœä¸Šè¿°æƒé™æ˜¯<code>crw-rw----</code>udev è§„åˆ™æœªæ­£ç¡®è®¾ç½®è¯·å‚é˜…<a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">udev è§„åˆ™</a></p>
</blockquote>
<p>æ‚¨å¯ä»¥é€šè¿‡ç®€å•åœ°å†™å…¥æ­¤æ–‡ä»¶æ¥å‘é€æ•°æ®ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ echo 'Hello, world!' > /dev/ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ‚¨åº”è¯¥çœ‹åˆ°ä¸²è¡Œæ¨¡å—ä¸Šçš„ TXï¼ˆçº¢è‰²ï¼‰LED é—ªçƒä¸€æ¬¡ï¼Œè€Œä¸”é€Ÿåº¦éå¸¸å¿«ï¼</p>
<h3 id="æ‰€æœ‰ç‰ˆæœ¬ï¼šminicom"><a href="#æ‰€æœ‰ç‰ˆæœ¬ï¼šminicom" class="headerlink" title="æ‰€æœ‰ç‰ˆæœ¬ï¼šminicom"></a>æ‰€æœ‰ç‰ˆæœ¬ï¼šminicom</h3><p>å¤„ç†ä½¿ç”¨çš„ä¸²è¡Œè®¾å¤‡<code>echo</code>è¿œéç¬¦åˆäººä½“å·¥ç¨‹å­¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¯¥ç¨‹åº<code>minicom</code> é€šè¿‡é”®ç›˜ä¸ä¸²è¡Œè®¾å¤‡è¿›è¡Œäº¤äº’ã€‚</p>
<p>æˆ‘ä»¬å¿…é¡»<code>minicom</code>åœ¨ä½¿ç”¨ä¹‹å‰è¿›è¡Œé…ç½®ã€‚æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†æˆ‘ä»¬å°†ä½¿ç”¨<code>.minirc.dfl</code>ä¸»ç›®å½•ä¸­çš„ æ–‡ä»¶ã€‚<code>~/.minirc.dfl</code>ä½¿ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ~/.minirc.dfl
pu baudrate 115200
pu bits 8
pu parity N
pu stopbits 1
pu rtscts No
pu xonxoff No<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ç¡®ä¿æ­¤æ–‡ä»¶ä»¥æ¢è¡Œç¬¦ç»“å°¾ï¼å¦åˆ™ï¼Œ<code>minicom</code>å°†æ— æ³•é˜…è¯»ã€‚</p>
</blockquote>
<p>è¯¥æ–‡ä»¶åº”è¯¥å¾ˆå®¹æ˜“é˜…è¯»ï¼ˆé™¤äº†æœ€åä¸¤è¡Œï¼‰ï¼Œä½†è®©æˆ‘ä»¬é€è¡Œé˜…è¯»ï¼š</p>
<ul>
<li><code>pu baudrate 115200</code>. å°†æ³¢ç‰¹ç‡è®¾ç½®ä¸º 115200 bpsã€‚</li>
<li><code>pu bits 8</code>. æ¯å¸§ 8 ä½ã€‚</li>
<li><code>pu parity N</code>. æ²¡æœ‰å¥‡å¶æ ¡éªŒã€‚</li>
<li><code>pu stopbits 1</code>. 1 ä¸ªåœæ­¢ä½ã€‚</li>
<li><code>pu rtscts No</code>. æ²¡æœ‰ç¡¬ä»¶æ§åˆ¶æµã€‚</li>
<li><code>pu xonxoff No</code>. æ²¡æœ‰è½¯ä»¶æ§åˆ¶æµç¨‹ã€‚</li>
</ul>
<p>ä¸€æ—¦åˆ°ä½ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨<code>minicom</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ # NOTE you may need to use a different device here
$ minicom -D /dev/ttyACM0 -b 115200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¿™å‘Šè¯‰<code>minicom</code>æ‰“å¼€ä¸²è¡Œè®¾å¤‡<code>/dev/ttyACM0</code>å¹¶å°†å…¶æ³¢ç‰¹ç‡è®¾ç½®ä¸º 115200ã€‚åŸºäºæ–‡æœ¬çš„ç”¨æˆ·ç•Œé¢ (TUI) å°†å¼¹å‡ºã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/minicom.png" alt=""></p>
<p>æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨é”®ç›˜å‘é€æ•°æ®äº†ï¼ç»§ç»­è¾“å…¥ä¸€äº›ä¸œè¥¿ã€‚è¯·æ³¨æ„ï¼ŒTUI<em>ä¸ä¼š</em>å›æ˜¾æ‚¨é”®å…¥çš„å†…å®¹ï¼Œä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯å¤–éƒ¨æ¨¡å—ï¼Œæ‚¨<em>å¯èƒ½ä¼š</em>çœ‹åˆ°æ¨¡å—ä¸Šçš„ä¸€äº› LED éšæ¯æ¬¡æŒ‰é”®è€Œé—ªçƒã€‚</p>
<h3 id="minicom-å‘½ä»¤"><a href="#minicom-å‘½ä»¤" class="headerlink" title="minicom å‘½ä»¤"></a><code>minicom</code> å‘½ä»¤</h3><p><code>minicom</code>é€šè¿‡é”®ç›˜å¿«æ·é”®å…¬å¼€å‘½ä»¤ã€‚åœ¨ Linux ä¸Šï¼Œå¿«æ·æ–¹å¼ä»¥<code>Ctrl+A</code>. åœ¨ Mac ä¸Šï¼Œå¿«æ·é”®ä»¥é”®å¼€å¤´<code>Meta</code>ã€‚ä¸€äº›æœ‰ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Ctrl+A</code>+ <code>Z</code>ã€‚Minicom å‘½ä»¤æ€»ç»“</li>
<li><code>Ctrl+A</code>+ <code>C</code>ã€‚æ¸…å±</li>
<li><code>Ctrl+A</code>+ <code>X</code>ã€‚é€€å‡ºå¹¶é‡ç½®</li>
<li><code>Ctrl+A</code>+ <code>Q</code>ã€‚é€€å‡ºè€Œä¸é‡ç½®</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong>mac ç”¨æˆ·ï¼šåœ¨ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œæ›¿æ¢<code>Ctrl+A</code>ä¸º<code>Meta</code>.</p>
</blockquote>
<h2 id="Windows-tooling"><a href="#Windows-tooling" class="headerlink" title="Windows tooling"></a>Windows tooling</h2><p>é¦–å…ˆæ‹”ä¸‹æ‚¨çš„å‘ç°æ¿ã€‚</p>
<p>åœ¨æ’å…¥å‘ç°æ¿æˆ–ä¸²å£æ¨¡å—ä¹‹å‰ï¼Œè¯·åœ¨ç»ˆç«¯ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ mode<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å®ƒå°†æ‰“å°è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºçš„è®¾å¤‡åˆ—è¡¨ã€‚ä¸å¯åŠ¨çš„äºº<code>COM</code>åœ¨ä»–ä»¬çš„åå­—æ˜¯ä¸²å£è®¾å¤‡ã€‚è¿™æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨çš„è®¾å¤‡ç±»å‹ã€‚<em>åœ¨</em>æ’å…¥ä¸²è¡Œæ¨¡å—<em>ä¹‹å‰ï¼Œ*è¯·è®°ä¸‹æ‰€æœ‰<code>COM</code> *ç«¯å£</em> <code>mode</code>è¾“å‡ºã€‚</p>
<p>ç°åœ¨ï¼Œæ’å…¥å‘ç°æ¿å¹¶<code>mode</code>å†æ¬¡è¿è¡Œå‘½ä»¤ã€‚å¦‚æœæ‚¨çœ‹åˆ°<code>COM</code>åˆ—è¡¨ä¸­å‡ºç°äº†ä¸€ä¸ªæ–° ç«¯å£ï¼Œé‚£ä¹ˆæ‚¨å°±æœ‰äº†ä¸€ä¸ªè¾ƒæ–°çš„å‘ç°ç‰ˆæœ¬ï¼Œè¿™æ˜¯åˆ†é…ç»™å‘ç°ä¸­ä¸²è¡ŒåŠŸèƒ½çš„ COM ç«¯å£ã€‚ä½ å¯ä»¥è·³è¿‡ä¸‹ä¸€æ®µã€‚</p>
<p>å¦‚æœæ‚¨æ²¡æœ‰è·å¾—æ–°çš„ COM ç«¯å£ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªè¾ƒæ—§çš„å‘ç°ç‰ˆæœ¬ã€‚ç°åœ¨æ’å…¥ä¸²å£æ¨¡å—ï¼›æ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ–°çš„ COM ç«¯å£å‡ºç°ï¼›é‚£æ˜¯ä¸²è¡Œæ¨¡å—çš„COMç«¯å£ã€‚</p>
<p>ç°åœ¨å¯åŠ¨<code>putty</code>ã€‚å°†å¼¹å‡ºä¸€ä¸ª GUIã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/putty-settings.png" alt=""></p>
<p>åœ¨åº”è¯¥æ‰“å¼€â€œä¼šè¯â€ç±»åˆ«çš„å¯åŠ¨å±å¹•ä¸Šï¼Œé€‰æ‹©â€œä¸²è¡Œâ€ä½œä¸ºâ€œè¿æ¥ç±»å‹â€ã€‚åœ¨â€œä¸²è¡Œçº¿è·¯â€å­—æ®µä¸­è¾“å…¥<code>COM</code>æ‚¨åœ¨ä¸Šä¸€æ­¥ä¸­è·å¾—çš„è®¾å¤‡ï¼Œä¾‹å¦‚<code>COM3</code>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œä»å·¦ä¾§èœå•ä¸­é€‰æ‹©â€œè¿æ¥/ä¸²è¡Œâ€ç±»åˆ«ã€‚åœ¨è¿™ä¸ªæ–°è§†å›¾ä¸­ï¼Œç¡®ä¿ä¸²å£é…ç½®å¦‚ä¸‹ï¼š</p>
<ul>
<li>â€œé€Ÿåº¦ï¼ˆæ³¢ç‰¹ï¼‰â€ï¼š115200</li>
<li>â€œæ•°æ®ä½â€ï¼š8</li>
<li>â€œåœæ­¢ä½â€ï¼š1</li>
<li>â€œå¥‡å¶æ ¡éªŒâ€ï¼šæ— </li>
<li>â€œæµé‡æ§åˆ¶â€ï¼šæ— </li>
</ul>
<p>æœ€åï¼Œç‚¹å‡»æ‰“å¼€æŒ‰é’®ã€‚ç°åœ¨ä¼šå‡ºç°ä¸€ä¸ªæ§åˆ¶å°ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/putty-console.png" alt=""></p>
<p>å¦‚æœæ‚¨åœ¨æ­¤æ§åˆ¶å°ä¸Šé”®å…¥ï¼Œä¸²è¡Œæ¨¡å—ä¸Šçš„ TXï¼ˆçº¢è‰²ï¼‰LED åº”é—ªçƒã€‚æ¯æ¬¡å‡»é”®éƒ½åº”ä½¿ LED é—ªçƒä¸€æ¬¡ã€‚è¯·æ³¨æ„ï¼Œæ§åˆ¶å°ä¸ä¼šå›æ˜¾æ‚¨é”®å…¥çš„å†…å®¹ï¼Œå› æ­¤å±å¹•å°†ä¿æŒç©ºç™½ã€‚</p>
<h2 id="Loopbacks"><a href="#Loopbacks" class="headerlink" title="Loopbacks"></a>Loopbacks</h2><p>æˆ‘ä»¬å·²ç»æµ‹è¯•äº†å‘é€æ•°æ®ã€‚æ˜¯æ—¶å€™æµ‹è¯•æ¥æ”¶å®ƒäº†ã€‚é™¤äº†æ²¡æœ‰å…¶ä»–è®¾å¤‡å¯ä»¥å‘æˆ‘ä»¬å‘é€ä¸€äº›æ•°æ®â€¦â€¦æˆ–è€…æœ‰å—ï¼Ÿ</p>
<p>è¾“å…¥ï¼šç¯å›</p>
<p><img src="/images/loading.gif" data-original="../images/language/serial-loopback.png" alt="ä¸²è¡Œæ¨¡å—ç¯å›"></p>
<p>æ‚¨å¯ä»¥å‘è‡ªå·±å‘é€æ•°æ®ï¼åœ¨ç”Ÿäº§ä¸­ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼Œä½†å¯¹è°ƒè¯•éå¸¸æœ‰ç”¨ã€‚</p>
<h3 id="æ—§æ¿ä¿®è®¢ç‰ˆ-å¤–éƒ¨ä¸²è¡Œæ¨¡å—"><a href="#æ—§æ¿ä¿®è®¢ç‰ˆ-å¤–éƒ¨ä¸²è¡Œæ¨¡å—" class="headerlink" title="æ—§æ¿ä¿®è®¢ç‰ˆ/å¤–éƒ¨ä¸²è¡Œæ¨¡å—"></a>æ—§æ¿ä¿®è®¢ç‰ˆ/å¤–éƒ¨ä¸²è¡Œæ¨¡å—</h3><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½¿ç”¨å…¬å¯¹å…¬è·³çº¿å°†ä¸²è¡Œæ¨¡å—çš„<code>TXO</code>å’Œ<code>RXI</code>å¼•è„šè¿æ¥åœ¨ä¸€èµ·ã€‚</p>
<p>ç°åœ¨åœ¨ minicom/PuTTY ä¸­è¾“å…¥ä¸€äº›æ–‡æœ¬å¹¶è§‚å¯Ÿã€‚å‘ç”Ÿä»€ä¹ˆäº†ï¼Ÿ</p>
<p>ä½ åº”è¯¥çœ‹åˆ°ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>å’Œä»¥å‰ä¸€æ ·ï¼Œæ¯æ¬¡æŒ‰ä¸‹æŒ‰é”®æ—¶ TXï¼ˆçº¢è‰²ï¼‰LED éƒ½ä¼šé—ªçƒã€‚</li>
<li>ä½†ç°åœ¨ RXï¼ˆç»¿è‰²ï¼‰LED ä¹Ÿä¼šåœ¨æ¯æ¬¡æŒ‰é”®æ—¶é—ªçƒï¼è¿™è¡¨ç¤ºä¸²å£æ¨¡å—æ­£åœ¨æ¥æ”¶ä¸€äº›æ•°æ®ï¼›å®ƒåˆšåˆšå‘é€çš„é‚£ä¸ªã€‚</li>
<li>æœ€åï¼Œåœ¨ minicom/PuTTY æ§åˆ¶å°ä¸Šï¼Œæ‚¨åº”è¯¥çœ‹åˆ°æ‚¨é”®å…¥çš„å†…å®¹å›æ˜¾åˆ°æ§åˆ¶å°ã€‚</li>
</ul>
<h3 id="Newer-board-revision"><a href="#Newer-board-revision" class="headerlink" title="Newer board revision"></a>Newer board revision</h3><p>å¦‚æœæ‚¨æœ‰è¾ƒæ–°ç‰ˆæœ¬çš„ç”µè·¯æ¿ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æ¯å¯¹æ¯è·³çº¿å°† PC4 å’Œ PC5 å¼•è„šçŸ­è·¯æ¥è®¾ç½®ç¯å›ï¼Œå°±åƒæ‚¨å¯¹ SWO å¼•è„šæ‰€åšçš„é‚£æ ·ã€‚</p>
<p>æ‚¨ç°åœ¨åº”è¯¥å¯ä»¥å‘è‡ªå·±å‘é€æ•°æ®äº†ã€‚</p>
<p>ç°åœ¨å°è¯•åœ¨ minicom/PuTTY ä¸­è¾“å…¥ä¸€äº›æ–‡æœ¬å¹¶è§‚å¯Ÿã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šä¸ºäº†æ’é™¤ç°æœ‰å›ºä»¶å¯¹ä¸²è¡Œå¼•è„šï¼ˆPC4 å’Œ PC5ï¼‰æ‰§è¡Œå¥‡æ€ªæ“ä½œçš„å¯èƒ½æ€§ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨åœ¨å‘ minicom/PuTTY ä¸­è¾“å…¥æ–‡æœ¬æ—¶<em>æŒ‰ä½</em>é‡ç½®æŒ‰é’®ã€‚</p>
</blockquote>
<p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°æ‚¨é”®å…¥çš„å†…å®¹å›æ˜¾åˆ° minicom/PuTTY æ§åˆ¶å°ã€‚</p>
<h1 id="USART-1"><a href="#USART-1" class="headerlink" title="USART"></a>USART</h1><p>å¾®æ§åˆ¶å™¨æœ‰ä¸€ä¸ªç§°ä¸º USART çš„å¤–è®¾ï¼Œå®ƒä»£è¡¨é€šç”¨åŒæ­¥/å¼‚æ­¥æ¥æ”¶å™¨/å‘é€å™¨ã€‚è¯¥å¤–è®¾å¯ä»¥é…ç½®ä¸ºä½¿ç”¨å¤šç§é€šä¿¡åè®®ï¼Œå¦‚ä¸²è¡Œé€šä¿¡åè®®ã€‚</p>
<p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸²è¡Œé€šä¿¡åœ¨å¾®æ§åˆ¶å™¨å’Œè®¡ç®—æœºä¹‹é—´äº¤æ¢ä¿¡æ¯ã€‚ä½†åœ¨æˆ‘ä»¬è¿™æ ·åšä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½è¿æ¥èµ·æ¥ã€‚</p>
<p>æˆ‘ä¹‹å‰æåˆ°è¿‡ï¼Œè¿™ä¸ªåè®®æ¶‰åŠä¸¤æ¡æ•°æ®çº¿ï¼šTX å’Œ RXã€‚TXä»£è¡¨å‘å°„å™¨ï¼ŒRXä»£è¡¨æ¥æ”¶å™¨ã€‚å‘å°„å™¨å’Œæ¥æ”¶å™¨è™½ç„¶æ˜¯ç›¸å¯¹æœ¯è¯­ï¼›å“ªæ¡çº¿è·¯æ˜¯å‘é€å™¨ï¼Œå“ªæ¡çº¿è·¯æ˜¯æ¥æ”¶å™¨ï¼Œå–å†³äºæ‚¨ä»é€šä¿¡çš„å“ªä¸€ä¾§æŸ¥çœ‹çº¿è·¯ã€‚</p>
<h3 id="Newer-board-revisions"><a href="#Newer-board-revisions" class="headerlink" title="Newer board revisions"></a>Newer board revisions</h3><p>å¦‚æœæ‚¨æœ‰è¾ƒæ–°ç‰ˆæœ¬çš„ç”µè·¯æ¿å¹¶ä½¿ç”¨æ¿è½½ USB &lt;-&gt; ä¸²è¡ŒåŠŸèƒ½ï¼Œé‚£ä¹ˆ<code>auxiliary</code>æ¿æ¡ç®±ä¼šå°†å¼•è„šè®¾ç½®<code>PC4</code>ä¸º TX çº¿ï¼Œå°†å¼•è„šè®¾ç½®<code>PC5</code>ä¸º RX çº¿ã€‚</p>
<p>æ¿ä¸Šçš„æ‰€æœ‰ä¸œè¥¿éƒ½å·²ç»æ¥çº¿ï¼Œå› æ­¤æ‚¨æ— éœ€è‡ªå·±æ¥çº¿ã€‚</p>
<h3 id="è¾ƒæ—§çš„ç”µè·¯æ¿ä¿®è®¢ç‰ˆ-å¤–éƒ¨ä¸²è¡Œæ¨¡å—"><a href="#è¾ƒæ—§çš„ç”µè·¯æ¿ä¿®è®¢ç‰ˆ-å¤–éƒ¨ä¸²è¡Œæ¨¡å—" class="headerlink" title="è¾ƒæ—§çš„ç”µè·¯æ¿ä¿®è®¢ç‰ˆ/å¤–éƒ¨ä¸²è¡Œæ¨¡å—"></a>è¾ƒæ—§çš„ç”µè·¯æ¿ä¿®è®¢ç‰ˆ/å¤–éƒ¨ä¸²è¡Œæ¨¡å—</h3><p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯å¤–éƒ¨USB &lt; - &gt;ä¸²è¡Œæ¨¡å—ï¼Œé‚£ä¹ˆä½ å°†<strong>éœ€è¦</strong>å¯ç”¨<code>adapter</code>çš„ç‰¹å¾<code>aux11</code>åœ¨ç®±å­çš„ä¾èµ–<code>Cargo.toml</code>ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies.aux11]
path = "auxiliary"
# enable this if you are going to use an external serial adapter
features = ["adapter"] # <- uncomment this<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ä½¿ç”¨è¯¥å¼•è„š<code>PA9</code>ä½œä¸ºå¾®æ§åˆ¶å™¨çš„ TX çº¿å’Œ<code>PA10</code>å®ƒçš„ RX çº¿ã€‚æ¢å¥è¯è¯´ï¼Œå¼•è„šå°†<code>PA9</code>æ•°æ®è¾“å‡ºåˆ°å…¶çº¿è·¯ä¸Šï¼Œè€Œå¼•è„š<code>PA10</code>åœ¨å…¶çº¿è·¯ä¸Šä¾¦å¬æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¼•è„šå¯¹ä½œä¸º TX å’Œ RX å¼•è„šã€‚<a href="http://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">æ•°æ®è¡¨</a>ç¬¬ 44 é¡µä¸­æœ‰ä¸€ä¸ªè¡¨æ ¼ ï¼Œåˆ—å‡ºäº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰å…¶ä»–å¯èƒ½çš„å¼•è„šã€‚</p>
<p>ä¸²è¡Œæ¨¡å—ä¹Ÿæœ‰ TX å’Œ RX å¼•è„šã€‚æˆ‘ä»¬å¿…é¡»<em>äº¤å‰</em>è¿™äº›å¼•è„šï¼šå³å°†å¾®æ§åˆ¶å™¨çš„ TX å¼•è„šè¿æ¥åˆ°ä¸²è¡Œæ¨¡å—çš„ RX å¼•è„šï¼Œå°†å¾®æ§åˆ¶å™¨çš„ RX å¼•è„šè¿æ¥åˆ°ä¸²è¡Œæ¨¡å—çš„ TX å¼•è„šã€‚ä¸‹é¢çš„æ¥çº¿å›¾æ˜¾ç¤ºäº†æ‰€æœ‰å¿…è¦çš„è¿æ¥ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-serial.png" alt=""></p>
<p>è¿™äº›æ˜¯è¿æ¥å¾®æ§åˆ¶å™¨å’Œä¸²è¡Œæ¨¡å—çš„æ¨èæ­¥éª¤ï¼š</p>
<ul>
<li>å…³é—­ OpenOCD å’Œ <code>itmdump</code></li>
<li>æ–­å¼€ USB ç”µç¼†ä¸ F3 å’Œä¸²è¡Œæ¨¡å—çš„è¿æ¥ã€‚</li>
<li>ä½¿ç”¨æ¯å¯¹å…¬ (F/M) çº¿å°† F3 GND å¼•è„šä¹‹ä¸€è¿æ¥åˆ°ä¸²è¡Œæ¨¡å—çš„ GND å¼•è„šã€‚æœ€å¥½æ˜¯é»‘è‰²çš„ã€‚</li>
<li>ä½¿ç”¨ F/M çº¿å°† F3 èƒŒé¢çš„ PA9 å¼•è„šè¿æ¥åˆ°ä¸²è¡Œæ¨¡å—çš„ RXI å¼•è„šã€‚</li>
<li>ä½¿ç”¨ F/M çº¿å°† F3 èƒŒé¢çš„ PA10 å¼•è„šè¿æ¥åˆ°ä¸²è¡Œæ¨¡å—çš„ TXO å¼•è„šã€‚</li>
<li>ç°åœ¨å°† USB ç”µç¼†è¿æ¥åˆ° F3ã€‚</li>
<li>æœ€åå°† USB ç”µç¼†è¿æ¥åˆ°ä¸²è¡Œæ¨¡å—ã€‚</li>
<li>é‡æ–°å¯åŠ¨ OpenOCD å’Œ <code>itmdump</code></li>
</ul>
<p>ä¸€åˆ‡éƒ½å·²æ¥å¥½ï¼è®©æˆ‘ä»¬ç»§ç»­æ¥å›å‘é€æ•°æ®ã€‚</p>
<h2 id="Send-a-single-byte"><a href="#Send-a-single-byte" class="headerlink" title="Send a single byte"></a>Send a single byte</h2><p>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯é€šè¿‡ä¸²è¡Œè¿æ¥ä»å¾®æ§åˆ¶å™¨å‘è®¡ç®—æœºå‘é€ä¸€ä¸ªå­—èŠ‚ã€‚</p>
<p>è¿™ä¸€æ¬¡ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„ USART å¤–è®¾ã€‚æ‚¨åªéœ€ä½¿ç”¨è´Ÿè´£å‘é€å’Œæ¥æ”¶æ•°æ®çš„å¯„å­˜å™¨ã€‚</p>
<p>è¿›å…¥<code>11-usart</code>ç›®å½•ï¼Œè®©æˆ‘ä»¬åœ¨å…¶ä¸­è¿è¡Œå¯åŠ¨ä»£ç ã€‚ç¡®ä¿æ‚¨å·²æ‰“å¼€ minicom/PuTTYã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send a single character</span>
    usart1
        <span class="token punctuation">.</span>tdr
        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">b'X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥ç¨‹åºå†™å…¥<code>TDR</code>å¯„å­˜å™¨ã€‚è¿™ä¼šå¯¼è‡´<code>USART</code>å¤–è®¾é€šè¿‡ä¸²è¡Œæ¥å£å‘é€ä¸€ä¸ªå­—èŠ‚çš„ä¿¡æ¯ã€‚</p>
<p>åœ¨æ¥æ”¶ç«¯ï¼Œæ‚¨çš„è®¡ç®—æœºä¸Šï¼Œæ‚¨åº”è¯¥çœ‹åˆ°æ˜¾ç¤ºå­—ç¬¦<code>X</code>å‡ºç°åœ¨ minicom/PuTTY çš„ç»ˆç«¯ä¸Šã€‚</p>
<h2 id="Send-a-string"><a href="#Send-a-string" class="headerlink" title="Send a string"></a>Send a string</h2><p>ä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯å°†æ•´ä¸ªå­—ç¬¦ä¸²ä»å¾®æ§åˆ¶å™¨å‘é€åˆ°æ‚¨çš„è®¡ç®—æœºã€‚</p>
<p>æˆ‘å¸Œæœ›æ‚¨å°†å­—ç¬¦ä¸²<code>"The quick brown fox jumps over the lazy dog."</code>ä»å¾®æ§åˆ¶å™¨å‘é€åˆ°æ‚¨çš„è®¡ç®—æœºã€‚</p>
<p>è½®åˆ°ä½ ç¼–å†™ç¨‹åºäº†ã€‚</p>
<p>åœ¨è°ƒè¯•å™¨ä¸­é€å¥æ‰§è¡Œæ‚¨çš„ç¨‹åºã€‚ä½ çœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿ</p>
<p>ç„¶åå†æ¬¡æ‰§è¡Œè¯¥ç¨‹åºï¼Œä½†<em>ä¸€æ¬¡æ€§</em>ä½¿ç”¨è¯¥<code>continue</code>å‘½ä»¤ã€‚è¿™æ¬¡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>æœ€åï¼Œåœ¨<em>å‘å¸ƒ</em>æ¨¡å¼ä¸‹æ„å»ºç¨‹åºï¼Œå¹¶å†æ¬¡ä¸€æ¬¡æ€§è¿è¡Œå®ƒã€‚è¿™æ¬¡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<h2 id="Overruns"><a href="#Overruns" class="headerlink" title="Overruns"></a>Overruns</h2><p>å¦‚æœä½ è¿™æ ·å†™ä½ çš„ç¨‹åºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usart1
            <span class="token punctuation">.</span>tdr
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“æ‚¨æ‰§è¡Œåœ¨è°ƒè¯•æ¨¡å¼ä¸‹ç¼–è¯‘çš„ç¨‹åºæ—¶ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è®¡ç®—æœºä¸Šæ”¶åˆ°ç±»ä¼¼çš„ä¿¡æ¯ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom's terminal
(..)
The uic brwn oxjums oer helaz do.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½ åœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘ï¼Œä½ å¯èƒ½åªä¼šå¾—åˆ°è¿™æ ·çš„ä¸œè¥¿ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom's terminal
(..)
T<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä»€ä¹ˆåœ°æ–¹å‡ºäº†é”™ï¼Ÿ</p>
<p>æ‚¨ä¼šçœ‹åˆ°ï¼Œé€šè¿‡çº¿è·¯å‘é€å­—èŠ‚éœ€è¦ç›¸å¯¹å¤§é‡çš„æ—¶é—´ã€‚æˆ‘å·²ç»åšäº†æ•°å­¦ï¼Œæ‰€ä»¥è®©æˆ‘å¼•ç”¨è‡ªå·±çš„è¯ï¼š</p>
<blockquote>
<p>ä½¿ç”¨ 1 ä¸ªèµ·å§‹ä½ã€8 ä¸ªæ•°æ®ä½ã€1 ä¸ªåœæ­¢ä½å’Œ 115200 bps çš„æ³¢ç‰¹ç‡çš„å¸¸è§é…ç½®ï¼Œç†è®ºä¸Šå¯ä»¥æ¯ç§’å‘é€ 11,520 å¸§ã€‚ç”±äºæ¯ä¸€å¸§éƒ½æºå¸¦ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå› æ­¤æ•°æ®é€Ÿç‡ä¸º 11.52 KB/s</p>
</blockquote>
<p>æˆ‘ä»¬çš„ pangram æœ‰ 45 ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚è¿™æ„å‘³ç€<code>45 bytes / (11,520 bytes/s) = 3,906 us</code>å‘é€å­—ç¬¦ä¸²è‡³å°‘éœ€è¦ 3,900 å¾®ç§’ ( )ã€‚å¤„ç†å™¨çš„å·¥ä½œé¢‘ç‡ä¸º 8 MHzï¼Œæ‰§è¡Œä¸€æ¡æŒ‡ä»¤éœ€è¦ 125 çº³ç§’ï¼Œå› æ­¤å¾ˆå¯èƒ½<code>for</code> åœ¨ä¸åˆ° 3,900 å¾®ç§’çš„æ—¶é—´å†…å®Œæˆå¾ªç¯ã€‚</p>
<p>æˆ‘ä»¬å®é™…ä¸Šå¯ä»¥è®¡ç®—æ‰§è¡Œ<code>for</code>å¾ªç¯æ‰€éœ€çš„æ—¶é—´ã€‚<code>aux11::init()</code>è¿”å›ä¸€ä¸ª <code>MonoTimer</code>ï¼ˆå•è°ƒè®¡æ—¶å™¨ï¼‰å€¼ï¼Œè¯¥å€¼å…¬å¼€ä¸€ä¸ª<code>Instant</code>ç±»ä¼¼äº <code>std::time</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> instant <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usart1<span class="token punctuation">.</span>tdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> elapsed <span class="token operator">=</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in ticks</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"`for` loop took {} ticks ({} us)"</span><span class="token punctuation">,</span>
        elapsed<span class="token punctuation">,</span>
        elapsed <span class="token keyword">as</span> f32 <span class="token operator">/</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">1e6</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œæˆ‘å¾—åˆ°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
`for` loop took 22415 ticks (2801.875 us)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸åˆ° 3,900 å¾®ç§’ï¼Œä½†ç›¸è·ä¸è¿œï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰å‡ ä¸ªå­—èŠ‚çš„ä¿¡æ¯ä¸¢å¤±çš„åŸå› ã€‚</p>
<p>æ€»ä¹‹ï¼Œå¤„ç†å™¨è¯•å›¾ä»¥æ¯”ç¡¬ä»¶å®é™…å¤„ç†é€Ÿåº¦æ›´å¿«çš„é€Ÿåº¦å‘é€å­—èŠ‚ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è¿™ç§æƒ…å†µç§°ä¸ºç¼“å†²åŒº<em>æº¢å‡º</em>ã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•é¿å…è¿™ç§æƒ…å†µï¼ŸçŠ¶æ€å¯„å­˜å™¨ ( <code>ISR</code>) æœ‰ä¸€ä¸ªæ ‡å¿— ï¼Œ<code>TXE</code>æŒ‡ç¤ºå†™å…¥<code>TDR</code>å¯„å­˜å™¨æ˜¯å¦â€œå®‰å…¨â€è€Œä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
<p>è®©æˆ‘ä»¬ç”¨å®ƒæ¥å‡æ…¢å¤„ç†å™¨çš„é€Ÿåº¦ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> instant <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// wait until it's safe to write to TDR</span>
        <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>

        usart1
            <span class="token punctuation">.</span>tdr
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> elapsed <span class="token operator">=</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in ticks</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"`for` loop took {} ticks ({} us)"</span><span class="token punctuation">,</span>
        elapsed<span class="token punctuation">,</span>
        elapsed <span class="token keyword">as</span> f32 <span class="token operator">/</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">1e6</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸€æ¬¡ï¼Œåœ¨è°ƒè¯•æˆ–å‘å¸ƒæ¨¡å¼ä¸‹è¿è¡Œç¨‹åºåº”è¯¥ä¼šåœ¨æ¥æ”¶ç«¯äº§ç”Ÿä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom/PuTTY's console
(..)
The quick brown fox jumps over the lazy dog.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>for</code>å¾ªç¯çš„æ—¶é—´ä¹Ÿåº”è¯¥æ›´æ¥è¿‘ç†è®ºçš„ 3,900 å¾®ç§’ã€‚ä¸‹é¢çš„æ—¶é—´æ˜¯é’ˆå¯¹è°ƒè¯•ç‰ˆæœ¬çš„ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
`for` loop took 30499 ticks (3812.375 us)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="uprintln"><a href="#uprintln" class="headerlink" title="uprintln!"></a><code>uprintln!</code></h2><p>åœ¨ä¸‹ä¸€ä¸ªç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°<code>uprint!</code>å®ç³»åˆ—ã€‚ä½ çš„ç›®æ ‡æ˜¯è®©è¿™è¡Œä»£ç å·¥ä½œï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token function">uprintln!</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span> <span class="token string">"The answer is {}"</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å…¶ä¸­å¿…é¡»<code>"The answer is 42"</code>é€šè¿‡ä¸²è¡Œæ¥å£å‘é€å­—ç¬¦ä¸²ã€‚</p>
<p>æˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿè¿™æ˜¯ä¿¡æ¯å¯»æ‰¾åˆ°<code>std</code>çš„æ‰§è¡Œ<code>println!</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/libstd/macros.rs</span>
<span class="token macro-rules function">macro_rules!</span> print <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>$<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>io<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">_print</span><span class="token punctuation">(</span><span class="token function">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆ°ç›®å‰ä¸ºæ­¢çœ‹èµ·æ¥å¾ˆç®€å•ã€‚æˆ‘ä»¬éœ€è¦å†…ç½®<code>format_args!</code>å®ï¼ˆå®ƒåœ¨ç¼–è¯‘å™¨ä¸­å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸åˆ°å®ƒå®é™…åšäº†ä»€ä¹ˆï¼‰ã€‚æˆ‘ä»¬å¿…é¡»ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼ä½¿ç”¨è¯¥å®ã€‚è¿™ä¸ª <code>_print</code>å‡½æ•°æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/libstd/io/stdio.rs</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">match</span> LOCAL_STDOUT<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Uninitialized <span class="token operator">|</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Destroyed <span class="token operator">=</span><span class="token operator">></span> <span class="token function">stdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Valid <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            LOCAL_STDOUT<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>s<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">borrow_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BorrowState<span class="token punctuation">:</span><span class="token punctuation">:</span>Unused <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> w<span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">stdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> result <span class="token punctuation">{</span>
        <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"failed printing to stdout: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™<em>çœ‹èµ·æ¥å¾ˆ</em>å¤æ‚ï¼Œä½†æˆ‘ä»¬å”¯ä¸€æ„Ÿå…´è¶£çš„éƒ¨åˆ†æ˜¯ï¼š<code>w.write_fmt(args)</code>å’Œ <code>stdout().write_fmt(args)</code>ã€‚æ˜¯ä»€ä¹ˆ<code>print!</code>æœ€ç»ˆæ‰€åšçš„å°±æ˜¯è°ƒç”¨<code>fmt::Write::write_fmt</code>æ–¹æ³•ä¸è¾“å‡º<code>format_args!</code>ä½œä¸ºå®ƒçš„å‚æ•°ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¿…å®ç°è¯¥<code>fmt::Write::write_fmt</code>æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯é»˜è®¤æ–¹æ³•ã€‚æˆ‘ä»¬åªéœ€è¦å®ç°è¿™ä¸ª<code>fmt::Write::write_str</code>æ–¹æ³•ã€‚</p>
<p>è®©æˆ‘ä»¬è¿™æ ·åšã€‚</p>
<p>è¿™å°±æ˜¯ç­‰å¼çš„å®è§‚æ–¹é¢çš„æ ·å­ã€‚å‰©ä¸‹è¦åšçš„å°±æ˜¯æä¾›<code>write_str</code>æ–¹æ³•çš„å®ç°ã€‚</p>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°<code>Write</code>åœ¨<code>std::fmt</code>. æˆ‘ä»¬æ— æ³•è®¿é—®<code>std</code>ä½†<code>Write</code>ä¹Ÿå¯ä»¥åœ¨<code>core::fmt</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Write<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> usart1<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro-rules function">macro_rules!</span> uprint <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        $serial<span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span><span class="token function">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro-rules function">macro_rules!</span> uprintln <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $fmt<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">uprint!</span><span class="token punctuation">(</span>$serial<span class="token punctuation">,</span> <span class="token function">concat!</span><span class="token punctuation">(</span>$fmt<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $fmt<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">uprint!</span><span class="token punctuation">(</span>$serial<span class="token punctuation">,</span> <span class="token function">concat!</span><span class="token punctuation">(</span>$fmt<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> SerialPort <span class="token punctuation">{</span>
    usart1<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> usart1<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write <span class="token keyword">for</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">write_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">-></span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Result <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO implement this</span>
        <span class="token comment" spellcheck="true">// hint: this will look very similar to the previous program</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> serial <span class="token operator">=</span> SerialPort <span class="token punctuation">{</span> usart1 <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">uprintln!</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span> <span class="token string">"The answer is {}"</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Receive-a-single-byte"><a href="#Receive-a-single-byte" class="headerlink" title="Receive a single byte"></a>Receive a single byte</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å°†æ•°æ®ä»å¾®æ§åˆ¶å™¨å‘é€åˆ°æ‚¨çš„è®¡ç®—æœºã€‚æ˜¯æ—¶å€™å°è¯•ç›¸åçš„æ–¹æ³•äº†ï¼šä»æ‚¨çš„è®¡ç®—æœºæ¥æ”¶æ•°æ®ã€‚</p>
<p>æœ‰ä¸€ä¸ª<code>RDR</code>å¯„å­˜å™¨å°†å¡«å……æ¥è‡ª RX çº¿çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬è¯»å–è¯¥å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å°†æ£€ç´¢é€šé“å¦ä¸€ç«¯å‘é€çš„æ•°æ®ã€‚é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬æ€ä¹ˆçŸ¥é“æˆ‘ä»¬æ”¶åˆ°äº†ï¼ˆæ–°çš„ï¼‰æ•°æ®ï¼ŸçŠ¶æ€å¯„å­˜å™¨ ï¼Œ<code>ISR</code>ï¼Œæœ‰ä¸€ä¸ªç”¨äºæ­¤ç›®çš„çš„ä½ï¼š <code>RXNE</code>ã€‚æˆ‘ä»¬å¯ä»¥å¿™ç€ç­‰å¾…é‚£é¢æ——å¸œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Wait until there's data available</span>
        <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Retrieve the data</span>
        <span class="token keyword">let</span> _byte <span class="token operator">=</span> usart1<span class="token punctuation">.</span>rdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u8<span class="token punctuation">;</span>

        aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬è¯•è¯•è¿™ä¸ªç¨‹åºå§ï¼è®©å®ƒè‡ªç”±è¿è¡Œ<code>continue</code>ï¼Œç„¶ååœ¨ minicom/PuTTY çš„æ§åˆ¶å°ä¸­è¾“å…¥ä¸€ä¸ªå­—ç¬¦ã€‚å‘ç”Ÿä»€ä¹ˆäº†ï¼Ÿ<code>_byte</code>å˜é‡çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<pre><code>(gdb) continue
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
0x8003d48 in __bkpt ()

(gdb) finish
Run till exit from #0  0x8003d48 in __bkpt ()
usart::main () at src/11-usart/src/main.rs:19
19              aux11::bkpt();

(gdb) p/c _byte
$1 = 97 'a'</code></pre><h2 id="Echo-server"><a href="#Echo-server" class="headerlink" title="Echo server"></a>Echo server</h2><p>è®©æˆ‘ä»¬å°†ä¼ è¾“å’Œæ¥æ”¶åˆå¹¶åˆ°ä¸€ä¸ªç¨‹åºä¸­å¹¶ç¼–å†™ä¸€ä¸ªå›æ˜¾æœåŠ¡å™¨ã€‚å›æ˜¾æœåŠ¡å™¨å°†å®ƒå‘é€çš„ç›¸åŒæ–‡æœ¬å‘é€å›å®¢æˆ·ç«¯ã€‚å¯¹äºæ­¤åº”ç”¨ç¨‹åºï¼Œå¾®æ§åˆ¶å™¨å°†ä½œä¸ºæœåŠ¡å™¨ï¼Œè€Œæ‚¨å’Œæ‚¨çš„è®¡ç®—æœºå°†ä½œä¸ºå®¢æˆ·ç«¯ã€‚</p>
<p>è¿™åº”è¯¥å¾ˆå®¹æ˜“å®ç°ã€‚ï¼ˆæç¤ºï¼šé€å­—èŠ‚æ‰§è¡Œï¼‰</p>
<h2 id="Reverse-a-string"><a href="#Reverse-a-string" class="headerlink" title="Reverse a string"></a>Reverse a string</h2><p>å¥½çš„ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬è®©æœåŠ¡å™¨æ›´æœ‰è¶£ï¼Œè®©æœåŠ¡å™¨ç”¨å®¢æˆ·ç«¯å‘é€çš„æ–‡æœ¬çš„åå‘å“åº”å®¢æˆ·ç«¯ã€‚æ¯æ¬¡ä»–ä»¬æŒ‰ä¸‹ ENTER é”®æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå“åº”å®¢æˆ·ç«¯ã€‚æ¯ä¸ªæœåŠ¡å™¨å“åº”å°†åœ¨ä¸€ä¸ªæ–°è¡Œä¸­ã€‚</p>
<p>è¿™æ¬¡ä½ éœ€è¦ä¸€ä¸ªç¼“å†²åŒºï¼›ä½ å¯ä»¥ä½¿ç”¨<a href="https://docs.rs/heapless/0.2.1/heapless/struct.Vec.html" target="_blank" rel="noopener"><code>heapless::Vec</code></a>. è¿™æ˜¯å…¥é—¨ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A buffer with 32 bytes of capacity</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// TODO Receive a user request. Each user request ends with ENTER</span>
        <span class="token comment" spellcheck="true">// NOTE `buffer.push` returns a `Result`. Handle the error by responding</span>
        <span class="token comment" spellcheck="true">// with an error message.</span>

        <span class="token comment" spellcheck="true">// TODO Send back the reversed string</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="My-solution-1"><a href="#My-solution-1" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A buffer with 32 bytes of capacity</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">let</span> byte <span class="token operator">=</span> usart1<span class="token punctuation">.</span>rdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u8<span class="token punctuation">;</span>

            <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// buffer full</span>
                <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"error: buffer full\n\r"</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                    usart1
                        <span class="token punctuation">.</span>tdr
                        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Carriage return</span>
            <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token number">13</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Respond</span>
                <span class="token keyword">for</span> byte <span class="token keyword">in</span> buffer<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">b'\n'</span><span class="token punctuation">,</span> <span class="token string">b'\r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                    usart1
                        <span class="token punctuation">.</span>tdr
                        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Bluetooth-setup"><a href="#Bluetooth-setup" class="headerlink" title="Bluetooth setup"></a>Bluetooth setup</h1><p>æ˜¯æ—¶å€™æ‘†è„±ä¸€äº›ç”µçº¿äº†ã€‚ä¸²è¡Œé€šä¿¡ä¸ä»…å¯ä»¥åœ¨ USB åè®®ä¹‹ä¸Šè¿›è¡Œä»¿çœŸï¼›å®ƒä¹Ÿå¯ä»¥åœ¨è“ç‰™åè®®ä¹‹ä¸Šè¿›è¡Œæ¨¡æ‹Ÿã€‚è¿™ç§ä¸²è¡Œè“ç‰™åè®®ç§°ä¸º RFCOMMã€‚</p>
<p>åœ¨æˆ‘ä»¬å°†è“ç‰™æ¨¡å—ä¸å¾®æ§åˆ¶å™¨ä¸€èµ·ä½¿ç”¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é¦–å…ˆä½¿ç”¨ minicom/PuTTY ä¸å®ƒè¿›è¡Œäº¤äº’ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ï¼šæ‰“å¼€è“ç‰™æ¨¡å—ã€‚æˆ‘ä»¬å°†ä¸å¾—ä¸ä½¿ç”¨ä»¥ä¸‹è¿æ¥å‘å®ƒåˆ†äº«ä¸€äº› F3 åŠŸèƒ½ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth-power-only.png" alt=""></p>
<p>è¿æ¥å®ƒçš„æ¨èæ­¥éª¤æ˜¯ï¼š</p>
<ul>
<li>å…³é—­ OpenOCD å’Œ <code>itmdump</code></li>
<li>æ–­å¼€ USB ç”µç¼†ä¸ F3 å’Œä¸²è¡Œæ¨¡å—çš„è¿æ¥ã€‚</li>
<li>ä½¿ç”¨æ¯å¯¹æ¯ (F/F) çº¿å°† F3 çš„ GND å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ GND å¼•è„šã€‚æœ€å¥½æ˜¯é»‘è‰²çš„ã€‚</li>
<li>ä½¿ç”¨ F/F çº¿å°† F3 çš„ 5V å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ VCC å¼•è„šã€‚æœ€å¥½æ˜¯çº¢è‰²çš„ã€‚</li>
<li>ç„¶åï¼Œå°† USB ç”µç¼†è¿æ¥å› F3ã€‚</li>
<li>é‡æ–°å¯åŠ¨ OpenOCD å’Œ <code>itmdump</code></li>
</ul>
<p>åœ¨æ‚¨æ‰“å¼€ F3 æ¿çš„ç”µæºåï¼Œè“ç‰™æ¨¡å—ä¸Šçš„ä¸¤ä¸ª LEDï¼ˆä¸€ä¸ªè“è‰²å’Œä¸€ä¸ªçº¢è‰²ï¼‰åº”ç«‹å³å¼€å§‹é—ªçƒã€‚</p>
<p>æ¥ä¸‹æ¥è¦åšçš„æ˜¯é…å¯¹æ‚¨çš„è®¡ç®—æœºå’Œè“ç‰™æ¨¡å—ã€‚AFAIKã€Windows å’Œ mac ç”¨æˆ·å¯ä»¥ç®€å•åœ°ä½¿ç”¨ä»–ä»¬çš„æ“ä½œç³»ç»Ÿé»˜è®¤è“ç‰™ç®¡ç†å™¨è¿›è¡Œé…å¯¹ã€‚è“ç‰™æ¨¡å—é»˜è®¤å¼•è„šä¸º 1234ã€‚</p>
<p>Linux ç”¨æˆ·å¿…é¡»éµå¾ªï¼ˆéƒ¨åˆ†ï¼‰<a href="https://docs.rust-embedded.org/discovery/12-bluetooth-setup/linux.html" target="_blank" rel="noopener">è¿™äº›è¯´æ˜</a>ã€‚</p>
<h2 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h2><p>å¦‚æœæ‚¨æœ‰å›¾å½¢è“ç‰™ç®¡ç†å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å°†æ‚¨çš„è®¡ç®—æœºä¸è“ç‰™æ¨¡å—é…å¯¹å¹¶è·³è¿‡è¿™äº›æ­¥éª¤ä¸­çš„å¤§éƒ¨åˆ†ã€‚</p>
<p>é¦–å…ˆï¼Œæ‚¨è®¡ç®—æœºçš„è“ç‰™æ”¶å‘å™¨å¯èƒ½å·²å…³é—­ã€‚æ£€æŸ¥å…¶çŠ¶æ€<code>hciconfig</code>å¹¶åœ¨å¿…è¦æ—¶å°†å…¶æ‰“å¼€ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ hciconfig
hci0:   Type: Primary  Bus: USB
        BD Address: 68:17:29:XX:XX:XX  ACL MTU: 310:10  SCO MTU: 64:8
        DOWN  <--
        RX bytes:580 acl:0 sco:0 events:31 errors:0
        TX bytes:368 acl:0 sco:0 commands:30 errors:0

$ sudo hciconfig hci0 up

$ hciconfig
hci0:   Type: Primary  Bus: USB
        BD Address: 68:17:29:XX:XX:XX  ACL MTU: 310:10  SCO MTU: 64:8
        UP RUNNING  <--
        RX bytes:1190 acl:0 sco:0 events:67 errors:0
        TX bytes:1072 acl:0 sco:0 commands:66 errors:0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åä½ éœ€è¦å¯åŠ¨ BlueZï¼ˆè“ç‰™ï¼‰å®ˆæŠ¤è¿›ç¨‹ï¼š</p>
<ul>
<li>åœ¨åŸºäº systemd çš„ Linux å‘è¡Œç‰ˆä¸Šï¼Œä½¿ç”¨ï¼š</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ sudo systemctl start bluetooth<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>åœ¨ Ubuntuï¼ˆæˆ–åŸºäºæ–°è´µçš„ Linux å‘è¡Œç‰ˆï¼‰ä¸Šï¼Œä½¿ç”¨ï¼š</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ sudo /etc/init.d/bluetooth start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ‚¨å¯èƒ½è¿˜éœ€è¦è§£é”è“ç‰™ï¼Œå…·ä½“å–å†³äºä»¥ä¸‹å†…å®¹<code>rfkill list</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rfkill list
9: hci0: Bluetooth
        Soft blocked: yes # <--
        Hard blocked: no

$ sudo rfkill unblock bluetooth

$ rfkill list
9: hci0: Bluetooth
        Soft blocked: no  # <--
        Hard blocked: no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ‰«æ"><a href="#æ‰«æ" class="headerlink" title="æ‰«æ"></a>æ‰«æ</h3><pre class="line-numbers language-console"><code class="language-console">$ hcitool scan
Scanning ...
        20:16:05:XX:XX:XX       Ferris
$ #                             ^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä¸€å¯¹"><a href="#ä¸€å¯¹" class="headerlink" title="ä¸€å¯¹"></a>ä¸€å¯¹</h3><pre class="line-numbers language-console"><code class="language-console">$ bluetoothctl
[bluetooth]# scan on
[bluetooth]# agent on
[bluetooth]# pair 20:16:05:XX:XX:XX
Attempting to pair with 20:16:05:XX:XX:XX
[CHG] Device 20:16:05:XX:XX:XX Connected: yes
Request PIN code
[agent] Enter PIN code: 1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å°„é¢‘é€šä¿¡è®¾å¤‡"><a href="#å°„é¢‘é€šä¿¡è®¾å¤‡" class="headerlink" title="å°„é¢‘é€šä¿¡è®¾å¤‡"></a>å°„é¢‘é€šä¿¡è®¾å¤‡</h3><p>æˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„è“ç‰™æ¨¡å—åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶<code>/dev</code>ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥åƒä½¿ç”¨<code>/dev/ttyUSB0</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ sudo rfcomm bind 0 20:16:05:XX:XX:XX<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å› ä¸ºæˆ‘ä»¬ç”¨ä½œ<code>0</code>å‚æ•°<code>bind</code>,<code>/dev/rfcomm0</code>å°†æ˜¯åˆ†é…ç»™æˆ‘ä»¬çš„è“ç‰™æ¨¡å—çš„è®¾å¤‡æ–‡ä»¶ã€‚</p>
<p>æ‚¨å¯ä»¥éšæ—¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡Šæ”¾ï¼ˆé”€æ¯ï¼‰è®¾å¤‡æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Don't actually run this command right now!
$ sudo rfcomm release 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="Loopback-again"><a href="#Loopback-again" class="headerlink" title="Loopback, again"></a>Loopback, again</h2><p>å°†æ‚¨çš„è®¡ç®—æœºä¸è“ç‰™æ¨¡å—é…å¯¹åï¼Œæ‚¨çš„æ“ä½œç³»ç»Ÿåº”è¯¥å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶/COM ç«¯å£ã€‚åœ¨ Linux ä¸Šï¼Œå®ƒåº”è¯¥æ˜¯<code>/dev/rfcomm*</code>; åœ¨ mac ä¸Šï¼Œåº”è¯¥æ˜¯<code>/dev/cu.*</code>ï¼›åœ¨ Windows ä¸Šï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªæ–°çš„ COM ç«¯å£ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ minicom/PuTTY æµ‹è¯•è“ç‰™æ¨¡å—ã€‚ç”±äºè¯¥æ¨¡å—æ²¡æœ‰åƒä¸²è¡Œæ¨¡å—é‚£æ ·ç”¨äºä¼ è¾“å’Œæ¥æ”¶äº‹ä»¶çš„ LED æŒ‡ç¤ºç¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç¯å›è¿æ¥æµ‹è¯•è¯¥æ¨¡å—ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth-loopback.png" alt=""></p>
<p>åªéœ€ä½¿ç”¨ F/F çº¿å°†æ¨¡å—çš„ TXD å¼•è„šè¿æ¥åˆ°å…¶ RXD å¼•è„šå³å¯ã€‚</p>
<p>ç°åœ¨ï¼Œä½¿ç”¨<code>minicom</code>/è¿æ¥åˆ°è®¾å¤‡<code>PuTTY</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ minicom -D /dev/rfcomm0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿æ¥åï¼Œè“ç‰™æ¨¡å—çš„é—ªçƒæ¨¡å¼åº”å˜ä¸ºï¼šé•¿æ—¶é—´æš‚åœç„¶åå¿«é€Ÿé—ªçƒä¸¤æ¬¡ã€‚</p>
<p>åœ¨ minicom/PuTTY ç»ˆç«¯å†…è¾“å…¥åº”è¯¥å›æ˜¾æ‚¨è¾“å…¥çš„å†…å®¹ã€‚</p>
<h2 id="AT-commands"><a href="#AT-commands" class="headerlink" title="AT commands"></a>AT commands</h2><p>è“ç‰™æ¨¡å—å’Œ F3 éœ€è¦é…ç½®ä¸ºä»¥ç›¸åŒçš„æ³¢ç‰¹ç‡è¿›è¡Œé€šä¿¡ã€‚æ•™ç¨‹ä»£ç å°†UART1ä¸²å£è®¾å¤‡åˆå§‹åŒ–ä¸º115200æ³¢ç‰¹ç‡ã€‚HC-05è“ç‰™æ¨¡å—é»˜è®¤é…ç½®ä¸º9600æ³¢ç‰¹ç‡ã€‚</p>
<p>è“ç‰™æ¨¡å—æ”¯æŒ AT æ¨¡å¼ï¼Œå…è®¸æ‚¨æ£€æŸ¥å’Œæ›´æ”¹å…¶é…ç½®å’Œè®¾ç½®ã€‚è¦ä½¿ç”¨ AT æ¨¡å¼ï¼Œè¯·å°†è“ç‰™æ¨¡å—è¿æ¥åˆ° F3 å’Œ FTDIï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/bluetooth-serial.png" alt=""></p>
<p>è¿›å…¥ATæ¨¡å¼çš„æ¨èæ­¥éª¤ï¼š</p>
<ul>
<li>æ–­å¼€ F3 å’Œ FTDI ä¸è®¡ç®—æœºçš„è¿æ¥ã€‚</li>
<li>ä½¿ç”¨æ¯/æ¯ (F/F) çº¿ï¼ˆæœ€å¥½æ˜¯é»‘è‰²çš„ï¼‰å°† F3 çš„ GND å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ GND å¼•è„šã€‚</li>
<li>ä½¿ç”¨ F/F çº¿ï¼ˆæœ€å¥½æ˜¯çº¢è‰²çš„ï¼‰å°† F3 çš„ 5V å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ VCC å¼•è„šã€‚</li>
<li>ä½¿ç”¨æ¯/å…¬ (F/M) çº¿å°† FTDI RXI å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ TXD å¼•è„šã€‚</li>
<li>ä½¿ç”¨æ¯/å…¬ (F/M) çº¿å°† FTDI TXO å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ RXD å¼•è„šã€‚</li>
<li>ç°åœ¨é€šè¿‡ USB ç”µç¼†å°† FTDI è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºã€‚</li>
<li>æ¥ä¸‹æ¥é€šè¿‡ USB ç”µç¼†å°† F3 è¿æ¥åˆ°æ‚¨çš„è®¡ç®—æœºï¼ŒåŒæ—¶æŒ‰ä½è“ç‰™æ¨¡å—ä¸Šçš„æŒ‰é’®ï¼ˆæœ‰ç‚¹æ£˜æ‰‹ï¼‰ã€‚</li>
<li>ç°åœ¨ï¼Œæ¾å¼€æŒ‰é’®ï¼Œè“ç‰™æ¨¡å—å°†è¿›å…¥ AT æ¨¡å¼ã€‚æ‚¨å¯ä»¥é€šè¿‡è§‚å¯Ÿè“ç‰™æ¨¡å—ä¸Šçš„çº¢è‰² LED ç¼“æ…¢é—ªçƒï¼ˆå¤§çº¦ 1-2 ç§’å¼€/å…³ï¼‰æ¥ç¡®è®¤è¿™ä¸€ç‚¹ã€‚</li>
</ul>
<p>AT æ¨¡å¼å§‹ç»ˆä»¥ 38400 çš„æ³¢ç‰¹ç‡è¿è¡Œï¼Œå› æ­¤è¯·ä¸ºè¯¥æ³¢ç‰¹ç‡é…ç½®æ‚¨çš„ç»ˆç«¯ç¨‹åºå¹¶è¿æ¥åˆ° FTDI è®¾å¤‡ã€‚</p>
<p>å½“æ‚¨çš„ä¸²è¡Œè¿æ¥å»ºç«‹åï¼Œæ‚¨å¯èƒ½ä¼š<code>ERROR: (0)</code>é‡å¤æ˜¾ç¤ºä¸€å †ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œåªéœ€æŒ‰ ENTER å³å¯åœæ­¢é”™è¯¯ã€‚</p>
<h3 id="å®Œæ•´æ€§æ£€æŸ¥"><a href="#å®Œæ•´æ€§æ£€æŸ¥" class="headerlink" title="å®Œæ•´æ€§æ£€æŸ¥"></a>å®Œæ•´æ€§æ£€æŸ¥</h3><pre><code>$ at
OK
OK
(etc...)</code></pre><p><code>OK</code>é‡å¤å›ç­”ï¼Œç›´åˆ°æ‚¨å†æ¬¡æŒ‰ ENTERã€‚</p>
<h3 id="é‡å‘½åè®¾å¤‡"><a href="#é‡å‘½åè®¾å¤‡" class="headerlink" title="é‡å‘½åè®¾å¤‡"></a>é‡å‘½åè®¾å¤‡</h3><pre><code>$ at+name=ferris
OK</code></pre><h3 id="æŸ¥è¯¢è“ç‰™æ¨¡å—å½“å‰æ³¢ç‰¹ç‡"><a href="#æŸ¥è¯¢è“ç‰™æ¨¡å—å½“å‰æ³¢ç‰¹ç‡" class="headerlink" title="æŸ¥è¯¢è“ç‰™æ¨¡å—å½“å‰æ³¢ç‰¹ç‡"></a>æŸ¥è¯¢è“ç‰™æ¨¡å—å½“å‰æ³¢ç‰¹ç‡</h3><pre><code>at+uart?
+UART:9600,0,0
OK
+UART:9600,0,0
OK
(etc ...)</code></pre><h3 id="æ›´æ”¹æ³¢ç‰¹ç‡"><a href="#æ›´æ”¹æ³¢ç‰¹ç‡" class="headerlink" title="æ›´æ”¹æ³¢ç‰¹ç‡"></a>æ›´æ”¹æ³¢ç‰¹ç‡</h3><pre><code>$ at+uart=115200,0,0
OK</code></pre><h1 id="Serial-over-Bluetooth"><a href="#Serial-over-Bluetooth" class="headerlink" title="Serial over Bluetooth"></a>Serial over Bluetooth</h1><p>ç°åœ¨æˆ‘ä»¬éªŒè¯äº†è“ç‰™æ¨¡å—ä¸ minicom/PuTTY å…¼å®¹ï¼Œè®©æˆ‘ä»¬å°†å…¶è¿æ¥åˆ°å¾®æ§åˆ¶å™¨ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth.png" alt=""></p>
<p>è¿æ¥å®ƒçš„æ¨èæ­¥éª¤ï¼š</p>
<ul>
<li>å…³é—­ OpenOCD å’Œ<code>itmdump</code>.</li>
<li>æ–­å¼€ F3 ä¸è®¡ç®—æœºçš„è¿æ¥ã€‚</li>
<li>ä½¿ç”¨æ¯å¯¹æ¯ (F/F) çº¿ï¼ˆæœ€å¥½æ˜¯é»‘è‰²çš„ï¼‰å°† F3 çš„ GND å¼•è„šè¿æ¥åˆ°æ¨¡å—çš„ GND å¼•è„šã€‚</li>
<li>ä½¿ç”¨ F/F çº¿ï¼ˆæœ€å¥½æ˜¯çº¢è‰²çš„ï¼‰å°† F3 çš„ 5V å¼•è„šè¿æ¥åˆ°æ¨¡å—çš„ VCC å¼•è„šã€‚</li>
<li>ä½¿ç”¨ F/F çº¿å°† F3 èƒŒé¢çš„ PA9 (TX) å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ RXD å¼•è„šã€‚</li>
<li>ä½¿ç”¨ F/F çº¿å°† F3 èƒŒé¢çš„ PA10 (RX) å¼•è„šè¿æ¥åˆ°è“ç‰™çš„ TXD å¼•è„šã€‚</li>
<li>ç°åœ¨ä½¿ç”¨ USB ç”µç¼†è¿æ¥ F3 å’Œæ‚¨çš„è®¡ç®—æœºã€‚</li>
<li>é‡æ–°å¯åŠ¨ OpenOCD å’Œ<code>itmdump</code>.</li>
</ul>
<p>å°±æ˜¯è¿™æ ·ï¼æ‚¨åº”è¯¥å¯ä»¥ä¸åŠ ä¿®æ”¹åœ°è¿è¡Œæ‚¨åœ¨USARTç« èŠ‚ä¸­ç¼–å†™çš„æ‰€æœ‰ç¨‹åºï¼åªè¦ç¡®ä¿æ‚¨æ‰“å¼€äº†æ­£ç¡®çš„ä¸²è¡Œè®¾å¤‡/COM ç«¯å£ã€‚</p>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨åœ¨ä¸è“ç‰™è®¾å¤‡é€šä¿¡æ—¶é‡åˆ°é—®é¢˜ï¼Œæ‚¨å¯èƒ½éœ€è¦ä»¥è¾ƒä½çš„æ³¢ç‰¹ç‡åˆå§‹åŒ– USART1ã€‚ä»ç­‰äº115200ä¸º9600bpsé™ä½å®ƒå¯èƒ½ä¼šå¸®åŠ©ï¼Œå¦‚æ‰€æè¿°<a href="https://github.com/rust-embedded/discovery/blob/master/src/11-usart/auxiliary/src/lib.rs#L31" target="_blank" rel="noopener">è¿™é‡Œ</a></p>
<h1 id="I2C-1"><a href="#I2C-1" class="headerlink" title="I2C"></a>I2C</h1><p>æˆ‘ä»¬åˆšåˆšçœ‹åˆ°äº†ä¸²è¡Œé€šä¿¡åè®®ã€‚å®ƒæ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„åè®®ï¼Œå› ä¸ºå®ƒéå¸¸ç®€å•ï¼Œè€Œä¸”è¿™ç§ç®€å•æ€§ä½¿å…¶æ˜“äºåœ¨è“ç‰™å’Œ USB ç­‰å…¶ä»–åè®®ä¹‹ä¸Šå®ç°ã€‚</p>
<p>ç„¶è€Œï¼Œå®ƒçš„ç®€å•æ€§ä¹Ÿæ˜¯ä¸€ä¸ªç¼ºç‚¹ã€‚æ›´å¤æ‚çš„æ•°æ®äº¤æ¢ï¼Œå¦‚è¯»å–æ•°å­—ä¼ æ„Ÿå™¨ï¼Œéœ€è¦ä¼ æ„Ÿå™¨ä¾›åº”å•†åœ¨å…¶ä¹‹ä¸Šæå‡ºå¦ä¸€ç§åè®®ã€‚</p>
<p>(Un)å¯¹æˆ‘ä»¬æ¥è¯´å¹¸è¿çš„æ˜¯ï¼ŒåµŒå…¥å¼é¢†åŸŸè¿˜æœ‰<em>å¾ˆå¤š</em>å…¶ä»–çš„é€šä¿¡åè®®ã€‚å…¶ä¸­ä¸€äº›è¢«å¹¿æ³›ç”¨äºæ•°å­—ä¼ æ„Ÿå™¨ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨çš„ F3 æ¿æœ‰ä¸‰ä¸ªè¿åŠ¨ä¼ æ„Ÿå™¨ï¼šåŠ é€Ÿåº¦è®¡ã€ç£åŠ›è®¡å’Œé™€èºä»ªã€‚åŠ é€Ÿåº¦è®¡å’Œç£åŠ›è®¡å°è£…åœ¨å•ä¸ªç»„ä»¶ä¸­ï¼Œå¯é€šè¿‡ I2C æ€»çº¿è¿›è¡Œè®¿é—®ã€‚</p>
<p>I2C ä»£è¡¨å†…éƒ¨é›†æˆç”µè·¯ï¼Œæ˜¯ä¸€ç§<em>åŒæ­¥</em> <em>ä¸²è¡Œ</em>é€šä¿¡åè®®ã€‚å®ƒä½¿ç”¨ä¸¤æ¡çº¿æ¥äº¤æ¢æ•°æ®ï¼šä¸€æ¡æ•°æ®çº¿ï¼ˆSDAï¼‰å’Œä¸€æ¡æ—¶é’Ÿçº¿ï¼ˆSCLï¼‰ã€‚å› ä¸ºä½¿ç”¨æ—¶é’Ÿçº¿æ¥åŒæ­¥é€šä¿¡ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ª<em>åŒæ­¥</em>åè®®ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C.svg" alt=""></p>
<p>è¯¥åè®®ä½¿ç”¨<em>ä¸»</em> <em>ä»</em>æ¨¡å‹ï¼Œå…¶ä¸­ä¸»æ˜¯<em>å¯åŠ¨</em>å’Œé©±åŠ¨ä¸ä»è®¾å¤‡é€šä¿¡çš„è®¾å¤‡ã€‚å¤šä¸ªè®¾å¤‡ï¼ŒåŒ…æ‹¬ä¸»è®¾å¤‡å’Œä»è®¾å¤‡ï¼Œå¯ä»¥åŒæ—¶è¿æ¥åˆ°åŒä¸€æ¡æ€»çº¿ã€‚ä¸»è®¾å¤‡å¯ä»¥é€šè¿‡é¦–å…ˆå‘æ€»çº¿å¹¿æ’­å…¶<em>åœ°å€</em>æ¥ä¸ç‰¹å®šä»è®¾å¤‡é€šä¿¡ã€‚è¯¥åœ°å€å¯ä»¥æ˜¯ 7 ä½æˆ– 10 ä½é•¿ã€‚ä¸€æ—¦ä¸»æœº<em>å¼€å§‹</em>ä¸ä»æœºé€šä¿¡ï¼Œåœ¨ä¸»æœº<em>åœæ­¢</em>é€šä¿¡ä¹‹å‰ï¼Œå…¶ä»–è®¾å¤‡éƒ½ä¸èƒ½ä½¿ç”¨æ€»çº¿ã€‚</p>
<p>æ—¶é’Ÿçº¿å†³å®šäº†æ•°æ®äº¤æ¢çš„é€Ÿåº¦ï¼Œå®ƒé€šå¸¸ä»¥ 100 KHzï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰æˆ– 400 KHzï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰çš„é¢‘ç‡è¿è¡Œã€‚</p>
<h2 id="General-protocol"><a href="#General-protocol" class="headerlink" title="General protocol"></a>General protocol</h2><p>I2C åè®®æ¯”ä¸²è¡Œé€šä¿¡åè®®æ›´å¤æ‚ï¼Œå› ä¸ºå®ƒå¿…é¡»æ”¯æŒå¤šä¸ªè®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ç¤ºä¾‹æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p>
<h3 id="ä¸»-gt-ä»"><a href="#ä¸»-gt-ä»" class="headerlink" title="ä¸» -> ä»"></a>ä¸» -&gt; ä»</h3><p>å¦‚æœä¸»ç«™è¦å‘ä»ç«™å‘é€æ•°æ®ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C-163136770520141.svg" alt=""></p>
<ol>
<li>ä¸»ï¼šå¹¿æ’­å¼€å§‹</li>
<li>Mï¼šå¹¿æ’­ä»åœ°å€ï¼ˆ7 ä½ï¼‰+ R/Wï¼ˆç¬¬ 8 ä½ï¼‰è®¾ç½®ä¸º WRITE</li>
<li>ä»æœºï¼šå“åº” ACKï¼ˆç¡®è®¤ï¼‰</li>
<li>Mï¼šå‘é€ä¸€ä¸ªå­—èŠ‚</li>
<li>Sï¼šå“åº” ACK</li>
<li>é‡å¤æ­¥éª¤ 4 å’Œ 5 é›¶æ¬¡æˆ–æ›´å¤šæ¬¡</li>
<li>Mï¼šå¹¿æ’­åœæ­¢æˆ–ï¼ˆå¹¿æ’­é‡æ–°å¯åŠ¨å¹¶è¿”å›ï¼ˆ2ï¼‰ï¼‰</li>
</ol>
<blockquote>
<p><strong>æ³¨æ„</strong>ä»åœ°å€å¯ä»¥æ˜¯ 10 ä½è€Œä¸æ˜¯ 7 ä½é•¿ã€‚å…¶ä»–éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>
</blockquote>
<h3 id="ä¸»-lt-ä»"><a href="#ä¸»-lt-ä»" class="headerlink" title="ä¸» <- ä»"></a>ä¸» &lt;- ä»</h3><p>å¦‚æœmasteræƒ³ä»slaveè¯»å–æ•°æ®ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C-163136770520141.svg" alt=""></p>
<ol>
<li>Mï¼šå¹¿æ’­å¼€å§‹</li>
<li>Mï¼šå¹¿æ’­ä»åœ°å€ï¼ˆ7 ä½ï¼‰+ R/Wï¼ˆç¬¬ 8 ä½ï¼‰è®¾ç½®ä¸º READ</li>
<li>Sï¼šä»¥ ACK å“åº”</li>
<li>Sï¼šå‘é€å­—èŠ‚</li>
<li>Mï¼šä»¥ ACK å“åº”</li>
<li>é‡å¤æ­¥éª¤ 4 å’Œ 5 é›¶æ¬¡æˆ–æ›´å¤šæ¬¡</li>
<li>Mï¼šå¹¿æ’­åœæ­¢æˆ–ï¼ˆå¹¿æ’­é‡æ–°å¯åŠ¨å¹¶è¿”å›ï¼ˆ2ï¼‰ï¼‰</li>
</ol>
<blockquote>
<p><strong>æ³¨æ„</strong>ä»åœ°å€å¯ä»¥æ˜¯ 10 ä½è€Œä¸æ˜¯ 7 ä½é•¿ã€‚å…¶ä»–éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>
</blockquote>
<h2 id="LSM303DLHC"><a href="#LSM303DLHC" class="headerlink" title="LSM303DLHC"></a>LSM303DLHC</h2><p><strong>*æ³¨æ„</strong>ï¼šè¾ƒæ–°çš„ï¼ˆä» 2020/09 å·¦å³å¼€å§‹ï¼‰æ¢ç´¢æ¿å¯èƒ½æœ‰<a href="https://www.st.com/resource/en/datasheet/lsm303agr.pdf" target="_blank" rel="noopener">LSM303AGR</a> è€Œä¸æ˜¯<a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">LSM303DLHC</a>ã€‚æŸ¥çœ‹åƒ<a href="https://github.com/rust-embedded/discovery/issues/274" target="_blank" rel="noopener">è¿™æ ·</a>çš„ github é—®é¢˜ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<p>F3 ä¸­çš„ä¸¤ä¸ªä¼ æ„Ÿå™¨ï¼Œç£åŠ›è®¡å’ŒåŠ é€Ÿåº¦è®¡ï¼Œå°è£…åœ¨å•ä¸ªç»„ä»¶ä¸­ï¼šLSM303DLHC é›†æˆç”µè·¯ã€‚è¿™ä¸¤ä¸ªä¼ æ„Ÿå™¨å¯ä»¥é€šè¿‡ I2C æ€»çº¿è®¿é—®ã€‚æ¯ä¸ªä¼ æ„Ÿå™¨çš„è¡Œä¸ºç±»ä¼¼äº I2C ä»è®¾å¤‡ï¼Œå¹¶å…·æœ‰<em>ä¸åŒçš„</em>åœ°å€ã€‚</p>
<p>æ¯ä¸ªä¼ æ„Ÿå™¨éƒ½æœ‰è‡ªå·±çš„å­˜å‚¨å™¨ï¼Œç”¨äºå­˜å‚¨æ„ŸçŸ¥ç¯å¢ƒçš„ç»“æœã€‚æˆ‘ä»¬ä¸è¿™äº›ä¼ æ„Ÿå™¨çš„äº¤äº’å°†ä¸»è¦æ¶‰åŠè¯»å–å®ƒä»¬çš„è®°å¿†ã€‚</p>
<p>è¿™äº›ä¼ æ„Ÿå™¨çš„å­˜å‚¨å™¨è¢«å»ºæ¨¡ä¸ºå­—èŠ‚å¯å¯»å€å¯„å­˜å™¨ã€‚è¿™äº›ä¼ æ„Ÿå™¨ä¹Ÿå¯ä»¥é…ç½®ï¼›è¿™æ˜¯é€šè¿‡å†™å…¥ä»–ä»¬çš„å¯„å­˜å™¨æ¥å®Œæˆçš„ã€‚å› æ­¤ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œè¿™äº›ä¼ æ„Ÿå™¨ä¸å¾®æ§åˆ¶å™¨<em>å†…éƒ¨</em>çš„å¤–å›´è®¾å¤‡éå¸¸ç›¸ä¼¼ã€‚ä¸åŒä¹‹å¤„åœ¨äºå®ƒä»¬çš„å¯„å­˜å™¨æ²¡æœ‰æ˜ å°„åˆ°å¾®æ§åˆ¶å™¨çš„å­˜å‚¨å™¨ä¸­ã€‚ç›¸åï¼Œå®ƒä»¬çš„å¯„å­˜å™¨å¿…é¡»é€šè¿‡ I2C æ€»çº¿è®¿é—®ã€‚</p>
<p>æœ‰å…³ LSM303DLHC çš„ä¸»è¦ä¿¡æ¯æ¥æºæ˜¯å…¶<a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">æ•°æ®è¡¨</a>ã€‚é€šè¯»å®ƒä»¥äº†è§£å¦‚ä½•è¯»å–ä¼ æ„Ÿå™¨çš„å¯„å­˜å™¨ã€‚é‚£éƒ¨åˆ†åœ¨ï¼š</p>
<blockquote>
<p>ç¬¬ 5.1.1 èŠ‚ I2C æ“ä½œ - ç¬¬ 20 é¡µ - LSM303DLHC æ•°æ®è¡¨</p>
</blockquote>
<p>ä¸æœ¬ä¹¦ç›¸å…³çš„æ–‡æ¡£çš„å¦ä¸€éƒ¨åˆ†æ˜¯å¯„å­˜å™¨çš„æè¿°ã€‚é‚£éƒ¨åˆ†åœ¨ï¼š</p>
<blockquote>
<p>ç¬¬ 7 èŠ‚å¯„å­˜å™¨æè¿° - ç¬¬ 25 é¡µ - LSM303DLHC æ•°æ®è¡¨</p>
</blockquote>
<h2 id="Read-a-single-register"><a href="#Read-a-single-register" class="headerlink" title="Read a single register"></a>Read a single register</h2><p>è®©æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›ç†è®ºä»˜è¯¸å®è·µï¼</p>
<p>å°±åƒä½¿ç”¨ USART å¤–è®¾ä¸€æ ·ï¼Œæˆ‘å·²ç»è´Ÿè´£åœ¨æ‚¨åˆ°è¾¾ä¹‹å‰åˆå§‹åŒ–æ‰€æœ‰å†…å®¹ï¼Œ <code>main</code>å› æ­¤æ‚¨åªéœ€è¦å¤„ç†ä»¥ä¸‹å¯„å­˜å™¨ï¼š</p>
<ul>
<li><code>CR2</code>. æ§åˆ¶å¯„å­˜å™¨ 2ã€‚</li>
<li><code>ISR</code>. ä¸­æ–­å’ŒçŠ¶æ€å¯„å­˜å™¨ã€‚</li>
<li><code>TXDR</code>. å‘é€æ•°æ®å¯„å­˜å™¨ã€‚</li>
<li><code>RXDR</code>. æ¥æ”¶æ•°æ®å¯„å­˜å™¨ã€‚</li>
</ul>
<p>è¿™äº›å¯„å­˜å™¨è®°å½•åœ¨å‚è€ƒæ‰‹å†Œçš„ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
<blockquote>
<p>ç¬¬ 28.7 èŠ‚ I2C å¯„å­˜å™¨ - ç¬¬ 868 é¡µ - å‚è€ƒæ‰‹å†Œ</p>
</blockquote>
<p>æˆ‘ä»¬å°†æŠŠ<code>I2C1</code>å¤–å›´è®¾å¤‡ä¸å¼•è„š<code>PB6</code>( <code>SCL</code>) å’Œ<code>PB7</code>( <code>SDA</code>)ç»“åˆä½¿ç”¨ã€‚</p>
<p>è¿™æ¬¡æ‚¨æ— éœ€è¿æ¥ä»»ä½•ä¸œè¥¿ï¼Œå› ä¸ºä¼ æ„Ÿå™¨åœ¨æ¿ä¸Šå¹¶ä¸”å·²ç»è¿æ¥åˆ°å¾®æ§åˆ¶å™¨ã€‚ä½†æ˜¯ï¼Œæˆ‘å»ºè®®æ‚¨å°†ä¸²è¡Œ/è“ç‰™æ¨¡å—ä¸ F3 æ–­å¼€è¿æ¥ï¼Œä»¥ä½¿å…¶æ›´æ˜“äºæ“ä½œã€‚ç¨åï¼Œæˆ‘ä»¬å°†ç§»åŠ¨ç”µè·¯æ¿ç›¸å½“å¤šã€‚</p>
<p>æ‚¨çš„ä»»åŠ¡æ˜¯ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥è¯»å–ç£åŠ›è®¡<code>IRA_REG_M</code>å¯„å­˜å™¨çš„å†…å®¹ã€‚è¯¥å¯„å­˜å™¨æ˜¯åªè¯»çš„å¹¶ä¸”å§‹ç»ˆåŒ…å«å€¼<code>0b01001000</code>ã€‚</p>
<p>å¾®æ§åˆ¶å™¨å°†æ‰®æ¼” I2C ä¸»è®¾å¤‡çš„è§’è‰²ï¼Œè€Œ LSM303DLHC å†…éƒ¨çš„ç£åŠ›è®¡å°†æˆä¸º I2C ä»è®¾å¤‡ã€‚</p>
<p>è¿™æ˜¯å…¥é—¨ä»£ç ã€‚ä½ å¿…é¡»å®ç°<code>TODO</code>sã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> _delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Stage 1: Send the address of the register we want to read to the</span>
    <span class="token comment" spellcheck="true">// magnetometer</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO Broadcast START</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>

        <span class="token comment" spellcheck="true">// TODO Send the address of the register that we want to read: IRA_REG_M</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Stage 2: Receive the contents of the register we asked for</span>
    <span class="token keyword">let</span> byte <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO Broadcast RESTART</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>

        <span class="token comment" spellcheck="true">// TODO Receive the contents of the register</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast STOP</span>
        <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Expected output: 0x0A - 0b01001000</span>
    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"0x{:02X} - 0b{:08b}"</span><span class="token punctuation">,</span> IRA_REG_M<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†ç»™æ‚¨ä¸€äº›é¢å¤–çš„å¸®åŠ©ï¼Œè¿™äº›æ˜¯æ‚¨å°†è¦ä½¿ç”¨çš„ç¡®åˆ‡ä½åŸŸï¼š</p>
<ul>
<li><code>CR2</code>: <code>SADD1</code>, <code>RD_WRN</code>, <code>NBYTES</code>, <code>START</code>,<code>AUTOEND</code></li>
<li><code>ISR</code>: <code>TXIS</code>, <code>RXNE</code>,<code>TC</code></li>
<li><code>TXDR</code>ï¼š <code>TXDATA</code></li>
<li><code>RXDR</code>ï¼š <code>RXDATA</code></li>
</ul>
<h2 id="The-solution-1"><a href="#The-solution-1" class="headerlink" title="The solution"></a>The solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> _delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Stage 1: Send the address of the register we want to read to the</span>
    <span class="token comment" spellcheck="true">// magnetometer</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast START</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>MAGNETOMETER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we can send more data</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: IRA_REG_M</span>
        i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>IRA_REG_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until the previous byte has been transmitted</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Stage 2: Receive the contents of the register we asked for</span>
    <span class="token keyword">let</span> byte <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we have received the contents of the register</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span>

        i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Expected output: 0x0A - 0b01001000</span>
    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"0x{:02X} - 0b{:08b}"</span><span class="token punctuation">,</span> IRA_REG_M<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Read-several-registers"><a href="#Read-several-registers" class="headerlink" title="Read several registers"></a>Read several registers</h2><p>è¯»å–<code>IRA_REG_M</code>å¯„å­˜å™¨å¾ˆå¥½åœ°æµ‹è¯•äº†æˆ‘ä»¬å¯¹ I2C åè®®çš„ç†è§£ï¼Œä½†è¯¥å¯„å­˜å™¨åŒ…å«æ— è¶£çš„ä¿¡æ¯ã€‚</p>
<p>è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†è¯»å–å®é™…æš´éœ²ä¼ æ„Ÿå™¨è¯»æ•°çš„ç£åŠ›è®¡å¯„å­˜å™¨ã€‚æ¶‰åŠå…­ä¸ªè¿ç»­çš„å¯„å­˜å™¨ï¼Œå®ƒä»¬<code>OUT_X_H_M</code>ä»¥åœ°å€å¼€å¤´<code>0x03</code>ã€‚</p>
<p>æˆ‘ä»¬å°†ä¿®æ”¹æˆ‘ä»¬ä¹‹å‰çš„ç¨‹åºæ¥è¯»å–è¿™å…­ä¸ªå¯„å­˜å™¨ã€‚åªéœ€è¦è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬ä»ç£åŠ›è®¡è¯·æ±‚çš„åœ°å€ä» æ›´æ”¹<code>IRA_REG_M</code>ä¸º<code>OUT_X_H_M</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: OUT_X_H_M</span>
    i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>OUT_X_H_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¿…é¡»å‘ä»ç«™è¯·æ±‚å…­ä¸ªå­—èŠ‚è€Œä¸æ˜¯ä¸€ä¸ªå­—èŠ‚ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
    <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
    i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¹¶å¡«å……ç¼“å†²åŒºè€Œä¸æ˜¯ä»…è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Wait until we have received the contents of the register</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token operator">*</span>byte <span class="token operator">=</span> i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°†å®ƒä»¬å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªå¾ªç¯ä¸­å¹¶å»¶è¿Ÿä»¥é™ä½æ•°æ®ååé‡ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast START</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>MAGNETOMETER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we can send more data</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: OUT_X_H_M</span>
        i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>OUT_X_H_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until the previous byte has been transmitted</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Wait until we have received something</span>
            <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token operator">*</span>byte <span class="token operator">=</span> i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½ è¿è¡Œå®ƒï¼Œä½ åº”è¯¥åœ¨<code>itmdump</code>â€˜s çš„æ§åˆ¶å°ä¸­æ¯ç§’æ‰“å°ä¸€ä¸ª 6 ä¸ªå­—èŠ‚çš„æ–°æ•°ç»„ã€‚å¦‚æœæ‚¨åœ¨æ¿ä¸Šç§»åŠ¨ï¼Œæ•°ç»„ä¸­çš„å€¼åº”è¯¥ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
[0, 45, 255, 251, 0, 193]
[0, 44, 255, 249, 0, 193]
[0, 49, 255, 250, 0, 195]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯è¿™äº›å­—èŠ‚æ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚è®©æˆ‘ä»¬æŠŠå®ƒä»¬å˜æˆå®é™…çš„è¯»æ•°ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust">        <span class="token keyword">let</span> x_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> x_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> x_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> y_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>z_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> z_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨å®ƒåº”è¯¥çœ‹èµ·æ¥æ›´å¥½ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # `itmdump terminal
(..)
(44, 196, -7)
(45, 195, -6)
(46, 196, -9)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯æ²¿ç£åŠ›è®¡çš„ XYZ è½´åˆ†è§£çš„åœ°çƒç£åœºã€‚</p>
<h1 id="LED-compass"><a href="#LED-compass" class="headerlink" title="LED compass"></a>LED compass</h1><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ F3 ä¸Šçš„ LED å®ç°æŒ‡å—é’ˆã€‚å°±åƒæ­£ç¡®çš„æŒ‡å—é’ˆä¸€æ ·ï¼Œæˆ‘ä»¬çš„ LED æŒ‡å—é’ˆå¿…é¡»ä»¥æŸç§æ–¹å¼æŒ‡å‘åŒ—æ–¹ã€‚å®ƒä¼šé€šè¿‡æ‰“å¼€å…«ä¸ª LED ä¸­çš„ä¸€ä¸ªæ¥å®ç°è¿™ä¸€ç‚¹ã€‚æ‰“å¼€çš„ LED åº”æŒ‡å‘åŒ—æ–¹ã€‚</p>
<p>ç£åœºæœ‰å¤§å°ï¼ˆä»¥é«˜æ–¯æˆ–ç‰¹æ–¯æ‹‰ä¸ºå•ä½ï¼‰å’Œ<em>æ–¹å‘</em>ã€‚F3 ä¸Šçš„ç£åŠ›è®¡æµ‹é‡å¤–éƒ¨ç£åœºçš„å¤§å°å’Œæ–¹å‘ï¼Œä½†å®ƒä¼šæŠ¥å‘Šæ‰€è¿°ç£åœºæ²¿<em>å…¶è½´</em>çš„<em>åˆ†è§£</em>ã€‚</p>
<p>è§ä¸‹æ–‡ï¼Œç£åŠ›è®¡æœ‰ä¸‰ä¸ªä¸ä¹‹å…³è”çš„è½´ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-lsm303dlhc.png" alt=""></p>
<p>ä¸Šé¢åªæ˜¾ç¤ºäº† X å’Œ Y è½´ã€‚Z è½´æŒ‡å‘å±å¹•çš„â€œå¤–éƒ¨â€ã€‚</p>
<p>è®©æˆ‘ä»¬é€šè¿‡è¿è¡Œä»¥ä¸‹å¯åŠ¨ä»£ç æ¥ç†Ÿæ‚‰ç£åŠ›è®¡çš„è¯»æ•°ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>lsm303dlhc</code>æ¨¡å—é€šè¿‡ LSM303DLHC æä¾›é«˜çº§ APIã€‚åœ¨åº•å±‚ï¼Œå®ƒæ‰§è¡Œä¸æ‚¨åœ¨ä¸Šä¸€èŠ‚ä¸­å®ç°çš„ç›¸åŒçš„ I2C ä¾‹ç¨‹ï¼Œä½†å®ƒåœ¨<code>I16x3</code>ç»“æ„è€Œä¸æ˜¯å…ƒç»„ä¸­æŠ¥å‘Š Xã€Y å’Œ Z å€¼ ã€‚</p>
<p>å®šä½åŒ—åœ¨æ‚¨å½“å‰ä½ç½®çš„ä½ç½®ã€‚ç„¶åæ—‹è½¬ç”µè·¯æ¿ï¼Œä½¿å…¶â€œæœåŒ—â€å¯¹é½ï¼šåŒ—æ–¹ LED (LD3) åº”æŒ‡å‘åŒ—æ–¹ã€‚</p>
<p>ç°åœ¨è¿è¡Œå¯åŠ¨ä»£ç å¹¶è§‚å¯Ÿè¾“å‡ºã€‚ä½ çœ‹åˆ°ä»€ä¹ˆ Xã€Y å’Œ Z å€¼ï¼Ÿ</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
I16x3 { x: 45, y: 194, z: -3 }
I16x3 { x: 46, y: 195, z: -8 }
I16x3 { x: 47, y: 197, z: -2 }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨å°†æ¿æ—‹è½¬ 90 åº¦ï¼ŒåŒæ—¶ä¿æŒå®ƒä¸åœ°é¢å¹³è¡Œã€‚è¿™æ¬¡ä½ çœ‹åˆ°äº†ä»€ä¹ˆ Xã€Y å’Œ Z å€¼ï¼Ÿç„¶åå†æ¬¡å°†å…¶æ—‹è½¬ 90 åº¦ã€‚ä½ çœ‹åˆ°äº†ä»€ä¹ˆä»·å€¼è§‚ï¼Ÿ</p>
<h2 id="Take-1"><a href="#Take-1" class="headerlink" title="Take 1"></a>Take 1</h2><p>æˆ‘ä»¬å¯ä»¥å®ç° LED æŒ‡å—é’ˆçš„æœ€ç®€å•æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿå³ä½¿å®ƒå¹¶ä¸å®Œç¾ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åªå…³å¿ƒç£åœºçš„ X å’Œ Y åˆ†é‡ï¼Œå› ä¸ºå½“æ‚¨æŸ¥çœ‹æŒ‡å—é’ˆæ—¶ï¼Œæ‚¨æ€»æ˜¯å°†å…¶ä¿æŒåœ¨æ°´å¹³ä½ç½®ï¼Œå› æ­¤æŒ‡å—é’ˆä½äº XY å¹³é¢å†…ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‚¨ä¼šæ‰“å¼€ä»€ä¹ˆ LEDã€‚EMF ä»£è¡¨åœ°çƒç£åœºï¼Œç»¿è‰²ç®­å¤´è¡¨ç¤º EMF çš„æ–¹å‘ï¼ˆæŒ‡å‘åŒ—æ–¹ï¼‰ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/quadrant-i.png" alt=""></p>
<p>è¯¥<code>Southeast</code>LEDï¼Œå¯¹ä¸å¯¹ï¼Ÿ</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç£åœºçš„ X å’Œ Y åˆ†é‡æœ‰ä»€ä¹ˆ<em>è¿¹è±¡</em>ï¼Ÿä¸¤è€…éƒ½æ˜¯ç§¯æçš„ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åªçœ‹ X å’Œ Y åˆ†é‡çš„ç¬¦å·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šç£åœºå±äºå“ªä¸ªè±¡é™ã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/quadrants.png" alt=""></p>
<p>åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œç£åœºä½äºç¬¬ä¸€è±¡é™ï¼ˆx å’Œ y ä¸ºæ­£ï¼‰ï¼Œå› æ­¤æ‰“å¼€<code>SouthEast</code>LEDæ˜¯æœ‰æ„ä¹‰çš„ã€‚åŒæ ·ï¼Œå¦‚æœç£åœºä½äºä¸åŒçš„è±¡é™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ä¸åŒçš„ LEDã€‚</p>
<p>è®©æˆ‘ä»¬è¯•è¯•è¿™ä¸ªé€»è¾‘ã€‚è¿™æ˜¯å…¥é—¨ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Look at the signs of the X and Y components to determine in which</span>
        <span class="token comment" spellcheck="true">// quadrant the magnetic field is</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰ä¸€ä¸ª<code>Direction</code>åœ¨æšä¸¾<code>led</code>æœ‰8ä¸ªå˜ç§ä¸œå—è¥¿åŒ—å‘½åçš„æ¨¡å—ï¼š <code>North</code>ï¼Œ<code>East</code>ï¼Œ<code>Southwest</code>ç­‰ã€‚è¿™äº›å˜ä½“ä»£è¡¨äº†æŒ‡å—é’ˆçš„8ä¸ªLEDä¹‹ä¸€ã€‚è¯¥<code>Leds</code>å€¼å¯ä»¥ä½¿ç”¨<code>Direction</code> <code>enum</code>;è¿›è¡Œç´¢å¼•ã€‚ç´¢å¼•çš„ç»“æœæ˜¯æŒ‡å‘é‚£ä¸ªçš„ LED <code>Direction</code>ã€‚</p>
<h2 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1"></a>Solution 1</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Look at the signs of the X and Y components to determine in which</span>
        <span class="token comment" spellcheck="true">// quadrant the magnetic field is</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Quadrant I</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant II</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant III</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northwest<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant IV</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southwest<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Take-2"><a href="#Take-2" class="headerlink" title="Take 2"></a>Take 2</h2><p>è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ•°å­¦æ¥è·å¾—ç£åœºä¸ç£åŠ›è®¡çš„ X è½´å’Œ Y è½´å½¢æˆçš„ç²¾ç¡®è§’åº¦ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨è¯¥<code>atan2</code>åŠŸèƒ½ã€‚æ­¤å‡½æ•°è¿”å›<code>-PI</code>to<code>PI</code>èŒƒå›´å†…çš„è§’åº¦ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚ä½•æµ‹é‡è¯¥è§’åº¦ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/Atan2_60.svg" alt=""></p>
<p>å°½ç®¡æ­¤å›¾ä¸­æœªæ˜ç¡®æ˜¾ç¤ºï¼Œä½† X è½´æŒ‡å‘å³ä¾§ï¼ŒY è½´æŒ‡å‘ä¸Šæ–¹ã€‚</p>
<p>è¿™æ˜¯å…¥é—¨ä»£ç ã€‚<code>theta</code>ï¼Œä»¥å¼§åº¦è¡¨ç¤ºï¼Œå·²ç»è¢«è®¡ç®—å‡ºæ¥ã€‚æ‚¨éœ€è¦æ ¹æ® çš„å€¼é€‰æ‹©è¦æ‰“å¼€çš„ LED <code>theta</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// You'll find this useful ;-)</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>f32<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span>PI<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// this trait provides the `atan2` method</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> _theta <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>x <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in radians</span>

        <span class="token comment" spellcheck="true">// FIXME pick a direction to point to based on `theta`</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å»ºè®®/æç¤ºï¼š</p>
<ul>
<li>ä¸€æ•´åœˆæ—‹è½¬ç­‰äº 360 åº¦ã€‚</li>
<li><code>PI</code> å¼§åº¦ç›¸å½“äº 180 åº¦ã€‚</li>
<li>å¦‚æœ<code>theta</code>ä¸ºé›¶ï¼Œä½ ä¼šæ‰“å¼€ä»€ä¹ˆ LEDï¼Ÿ</li>
<li><code>theta</code>ç›¸åï¼Œå¦‚æœéå¸¸æ¥è¿‘äºé›¶ï¼Œæ‚¨ä¼šæ‰“å¼€ä»€ä¹ˆ LEDï¼Ÿ</li>
<li>å¦‚æœ<code>theta</code>ç»§ç»­å¢åŠ ï¼Œæ‚¨ä¼šåœ¨ä»€ä¹ˆå€¼ä¸‹æ‰“å¼€ä¸åŒçš„ LEDï¼Ÿ</li>
</ul>
<h2 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2"></a>Solution 2</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// You'll find this useful ;-)</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>f32<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span>PI<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> theta <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>x <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in radians</span>

        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>North
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northwest
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>West
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span>PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southwest
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>South
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>East
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northeast
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>North
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Magnitude"><a href="#Magnitude" class="headerlink" title="Magnitude"></a>Magnitude</h2><p>æˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶ç£åœºçš„æ–¹å‘ï¼Œä½†å®ƒçš„å®é™…å¤§å°æ˜¯å¤šå°‘ï¼Ÿ<code>magnetic_field</code>å‡½æ•°æŠ¥å‘Šçš„æ•°å­—æ˜¯æ— å•ä½çš„ã€‚æˆ‘ä»¬å¦‚ä½•å°†è¿™äº›å€¼è½¬æ¢ä¸ºé«˜æ–¯ï¼Ÿ</p>
<p>æ–‡æ¡£å°†å›ç­”è¿™ä¸ªé—®é¢˜ã€‚</p>
<blockquote>
<p>ç¬¬ 2.1 èŠ‚ä¼ æ„Ÿå™¨ç‰¹æ€§ - ç¬¬ 10 é¡µ - LSM303DLHC æ•°æ®è¡¨</p>
</blockquote>
<p>è¯¥é¡µé¢ä¸­çš„è¡¨æ ¼æ˜¾ç¤ºäº†æ ¹æ® GN ä½çš„å€¼å…·æœ‰ä¸åŒå€¼çš„<em>ç£å¢ç›Šè®¾ç½®</em>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº› GN ä½è®¾ç½®ä¸º<code>001</code>ã€‚è¿™æ„å‘³ç€ X è½´å’Œ Y è½´<code>1100 LSB / Gauss</code>çš„ç£å¢ç›Šä¸º ï¼ŒZ è½´çš„ç£å¢ç›Šä¸º<code>980 LSB / Gauss</code>ã€‚LSB ä»£è¡¨æœ€ä½æœ‰æ•ˆä½ï¼Œ<code>1100 LSB / Gauss</code>æ•°å­—è¡¨ç¤ºè¯»æ•° <code>1100</code>ç­‰äº<code>1 Gauss</code>ï¼Œè¯»æ•°<code>2200</code>ç­‰äº 2 é«˜æ–¯ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å°†ä¼ æ„Ÿå™¨è¾“å‡ºçš„ Xã€Y å’Œ Z å€¼é™¤ä»¥å…¶ç›¸åº”çš„ <em>å¢ç›Š</em>ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è·å¾—ä»¥é«˜æ–¯ä¸ºå•ä½çš„ç£åœºçš„ Xã€Y å’Œ Z åˆ†é‡ã€‚</p>
<p>é€šè¿‡ä¸€äº›é¢å¤–çš„æ•°å­¦è¿ç®—ï¼Œæˆ‘ä»¬å¯ä»¥ä» Xã€Y å’Œ Z åˆ†é‡ä¸­æ£€ç´¢ç£åœºçš„å¤§å°ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> magnitude <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å°†æ‰€æœ‰è¿™äº›æ”¾åœ¨ä¸€ä¸ªç¨‹åºä¸­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> XY_GAIN<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">1100</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LSB / G</span>
    <span class="token keyword">const</span> Z_GAIN<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">980</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LSB / G</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> XY_GAIN<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> XY_GAIN<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token operator">/</span> Z_GAIN<span class="token punctuation">;</span>

        <span class="token keyword">let</span> mag <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{} mG"</span><span class="token punctuation">,</span> mag <span class="token operator">*</span> <span class="token number">1_000</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥ç¨‹åºå°†ä»¥æ¯«é«˜æ–¯ ( <code>mG</code>)ä¸ºå•ä½æŠ¥å‘Šç£åœºçš„å¤§å°ï¼ˆå¼ºåº¦ï¼‰ã€‚åœ°çƒç£åœºçš„å¹…åº¦æ˜¯åœ¨èŒƒå›´å†…<code>250 mG</code>ï¼Œä»¥<code>650 mG</code>ï¼ˆå¹…åº¦å–å†³äºæ‚¨çš„åœ°ç†ä½ç½®ï¼‰ï¼Œæ‰€ä»¥ä½ åº”è¯¥åœ¨è¿™ä¸ªèŒƒå›´å†…çœ‹åˆ°çš„å€¼æˆ–æ¥è¿‘è¯¥èŒƒå›´-æˆ‘çœ‹åˆ°å‘¨å›´210æ¯«å…‹çš„å¹…åº¦ã€‚</p>
<p>ä¸€äº›é—®é¢˜ï¼š</p>
<p>ä¸ç§»åŠ¨æ¿å­ï¼Œä½ çœ‹åˆ°äº†ä»€ä¹ˆä»·å€¼ï¼Ÿä½ æ€»æ˜¯çœ‹åˆ°ç›¸åŒçš„å€¼å—ï¼Ÿ</p>
<p>å¦‚æœä½ æ—‹è½¬æœ¨æ¿ï¼Œå¹…åº¦ä¼šæ”¹å˜å—ï¼Ÿåº”è¯¥æ”¹å˜å—ï¼Ÿ</p>
<h2 id="Calibration"><a href="#Calibration" class="headerlink" title="Calibration"></a>Calibration</h2><p>å¦‚æœæˆ‘ä»¬æ—‹è½¬æ¿å­ï¼Œåœ°çƒç£åœºç›¸å¯¹äºç£åŠ›è®¡çš„æ–¹å‘åº”è¯¥æ”¹å˜ï¼Œä½†å®ƒçš„å¤§å°ä¸åº”è¯¥ï¼ç„¶è€Œï¼Œç£åŠ›è®¡è¡¨æ˜ç£åœºçš„å¤§å°ä¼šéšç€ç”µè·¯æ¿çš„æ—‹è½¬è€Œå˜åŒ–ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿäº‹å®è¯æ˜ï¼Œç£åŠ›è®¡éœ€è¦æ ¡å‡†æ‰èƒ½è¿”å›æ­£ç¡®çš„ç­”æ¡ˆã€‚</p>
<p>æ ¡å‡†æ¶‰åŠç›¸å½“å¤šçš„æ•°å­¦ï¼ˆçŸ©é˜µï¼‰ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šåœ¨è¿™é‡Œä»‹ç»å®ƒï¼Œä½†å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæœ¬ <a href="https://www.nxp.com/docs/en/application-note/AN4246.pdf" target="_blank" rel="noopener">åº”ç”¨è¯´æ˜</a>ä¼šä»‹ç»è¯¥è¿‡ç¨‹ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†åœ¨æœ¬èŠ‚ä¸­åšçš„æ˜¯<em>å¯è§†åŒ–</em>æˆ‘ä»¬çš„çŠ¶æ€ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥è¯•è¯•è¿™ä¸ªå®éªŒï¼šè®©æˆ‘ä»¬è®°å½•ç£åŠ›è®¡çš„è¯»æ•°ï¼ŒåŒæ—¶æˆ‘ä»¬æ…¢æ…¢åœ°å‘ä¸åŒæ–¹å‘æ—‹è½¬æ¿ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<code>iprintln</code>å®å°†è¯»æ•°æ ¼å¼åŒ–ä¸ºåˆ¶è¡¨ç¬¦åˆ†éš”å€¼ (TSV)ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{}\t{}\t{}"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨åº”è¯¥åœ¨æ§åˆ¶å°ä¸­è·å¾—å¦‚ä¸‹æ‰€ç¤ºçš„è¾“å‡ºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump console
-76     213     -54
-76     213     -54
-76     213     -54
-76     213     -54
-73     213     -55<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ç®¡é“å°†å…¶ä¼ è¾“åˆ°æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Careful! Exit any running other `itmdump` instance that may be running
$ itmdump -F -f itm.txt > emf.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>åœ¨è®°å½•æ•°æ®å‡ ç§’é’Ÿçš„åŒæ—¶ï¼Œæ²¿è®¸å¤šä¸åŒçš„æ–¹å‘æ—‹è½¬æ¿ã€‚</p>
<p>ç„¶åå°†è¯¥ TSV æ–‡ä»¶å¯¼å…¥ç”µå­è¡¨æ ¼ç¨‹åºï¼ˆæˆ–ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ Python è„šæœ¬ï¼‰å¹¶å°†å‰ä¸¤åˆ—ç»˜åˆ¶ä¸ºæ•£ç‚¹å›¾ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>

<span class="token keyword">import</span> csv
<span class="token keyword">import</span> math
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token keyword">import</span> sys

<span class="token comment" spellcheck="true"># apply plot style</span>
sns<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token punctuation">)</span>

x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> open<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    rows <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># discard rows that are missing data</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">or</span> <span class="token operator">not</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">or</span> <span class="token operator">not</span> row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>max<span class="token punctuation">(</span>max<span class="token punctuation">(</span>np<span class="token punctuation">.</span>abs<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>np<span class="token punctuation">.</span>abs<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token operator">-</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token operator">-</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_aspect<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'emf.svg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/language/emf.svg" alt=""></p>
<p>å¦‚æœæ‚¨åœ¨å¹³å¦çš„æ°´å¹³é¢ä¸Šæ—‹è½¬ç”µè·¯æ¿ï¼Œç£åœºçš„ Z åˆ†é‡åº”è¯¥ä¿æŒç›¸å¯¹æ’å®šï¼Œå¹¶ä¸”è¯¥å›¾åº”è¯¥æ˜¯ä»¥åŸç‚¹ä¸ºä¸­å¿ƒçš„åœ†å‘¨ï¼ˆè€Œä¸æ˜¯æ¤­åœ†ï¼‰ã€‚å¦‚æœæ‚¨ä»¥éšæœºæ–¹å‘æ—‹è½¬æ£‹ç›˜ï¼Œè¿™å°±æ˜¯ä¸Šé¢çš„æƒ…èŠ‚ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å¾—åˆ°ä¸€ä¸ªç”±ä»¥åŸç‚¹ä¸ºä¸­å¿ƒçš„ä¸€å †ç‚¹ç»„æˆçš„åœ†ã€‚ä¸åœ†å½¢çš„åå·®è¡¨æ˜éœ€è¦æ ¡å‡†ç£åŠ›è®¡ã€‚</p>
<p>å¸¦å›å®¶çš„ä¿¡æ¯ï¼šä¸è¦åªç›¸ä¿¡ä¼ æ„Ÿå™¨çš„è¯»æ•°ã€‚éªŒè¯å®ƒæ­£åœ¨è¾“å‡ºåˆç†çš„å€¼ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™æ ¡å‡†å®ƒã€‚</p>
<h1 id="Punch-o-meterï¼ˆæ‰“å­”è®¡ï¼‰"><a href="#Punch-o-meterï¼ˆæ‰“å­”è®¡ï¼‰" class="headerlink" title="Punch-o-meterï¼ˆæ‰“å­”è®¡ï¼‰"></a>Punch-o-meterï¼ˆæ‰“å­”è®¡ï¼‰</h1><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¿ä¸Šçš„åŠ é€Ÿåº¦è®¡ã€‚</p>
<p>è¿™æ¬¡æˆ‘ä»¬è¦å»ºé€ ä»€ä¹ˆï¼Ÿæ‰“å­”è®¡ï¼æˆ‘ä»¬å°†æµ‹é‡ä½ çš„åˆºæˆ³çš„åŠ›é‡ã€‚å—¯ï¼Œå®é™…ä¸Šä½ å¯ä»¥è¾¾åˆ°çš„æœ€å¤§åŠ é€Ÿåº¦ï¼Œå› ä¸ºåŠ é€Ÿåº¦æ˜¯åŠ é€Ÿåº¦è®¡æµ‹é‡çš„ã€‚å¼ºåº¦å’ŒåŠ é€Ÿåº¦æ˜¯æˆæ¯”ä¾‹çš„ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è¿‘ä¼¼å€¼ã€‚</p>
<p>åŠ é€Ÿåº¦è®¡ä¹Ÿå†…ç½®åœ¨ LSM303DLHC å°è£…å†…ã€‚å°±åƒç£åŠ›è®¡ä¸€æ ·ï¼Œå®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ I2C æ€»çº¿è¿›è¡Œè®¿é—®ã€‚å®ƒè¿˜å…·æœ‰ä¸ç£åŠ›è®¡ç›¸åŒçš„åæ ‡ç³»ã€‚è¿™é‡Œåˆæ˜¯åæ ‡ç³»ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-lsm303dlhc-163136835024848.png" alt=""></p>
<p>å°±åƒåœ¨ä¸Šä¸€ä¸ªå•å…ƒä¸­ä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é«˜çº§ API ç›´æ¥è·å–å°è£…è‰¯å¥½çš„<code>struct</code>.</p>
<h2 id="Gravity-is-up"><a href="#Gravity-is-up" class="headerlink" title="Gravity is up?"></a>Gravity is up?</h2><p>æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æ‰§è¡Œå¥å…¨æ€§æ£€æŸ¥ï¼</p>
<p>å¯åŠ¨å™¨ä»£ç æ‰“å°åŠ é€Ÿåº¦è®¡æµ‹é‡çš„åŠ é€Ÿåº¦çš„ Xã€Y å’Œ Z åˆ†é‡ã€‚è¿™äº›å€¼å·²ç»è¢«â€œç¼©æ”¾â€å¹¶ä¸”å•ä½ä¸º<code>g</code>sã€‚å…¶ä¸­<code>1 g</code>ç­‰äºé‡åŠ›åŠ é€Ÿåº¦ï¼Œçº¦<code>9.8</code>ç±³æ¯ç§’çš„å¹³æ–¹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">,</span> Sensitivity<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// extend sensing range to `[-12g, +12g]`</span>
    lsm303dlhc<span class="token punctuation">.</span><span class="token function">set_accel_sensitivity</span><span class="token punctuation">(</span>Sensitivity<span class="token punctuation">:</span><span class="token punctuation">:</span>G12<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> SENSITIVITY<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f32<span class="token punctuation">;</span>

        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">accel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªç¨‹åºåœ¨è‘£äº‹ä¼šé™æ­¢æ—¶çš„è¾“å‡ºå°†æ˜¯è¿™æ ·çš„ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump console
(..)
(0.0, 0.0, 1.078125)
(0.0, 0.0, 1.078125)
(0.0, 0.0, 1.171875)
(0.0, 0.0, 1.03125)
(0.0, 0.0, 1.078125)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™å¾ˆå¥‡æ€ªï¼Œå› ä¸ºæ¿æ²¡æœ‰ç§»åŠ¨ï¼Œä½†å®ƒçš„åŠ é€Ÿåº¦ä¸ä¸ºé›¶ã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿè¿™ä¸€å®šå’Œé‡åŠ›æœ‰å…³å§ï¼Ÿå› ä¸ºé‡åŠ›åŠ é€Ÿåº¦æ˜¯<code>1 g</code>ã€‚ä½†æ˜¯é‡åŠ›å°†ç‰©ä½“å‘ä¸‹æ‹‰ï¼Œæ‰€ä»¥æ²¿ Z è½´çš„åŠ é€Ÿåº¦åº”è¯¥æ˜¯è´Ÿçš„è€Œä¸æ˜¯æ­£çš„â€¦â€¦</p>
<p>ç¨‹åºæ˜¯å¦ä½¿ Z è½´å‘åï¼Ÿä¸ï¼Œæ‚¨å¯ä»¥æµ‹è¯•æ—‹è½¬æ¿ä»¥ä½¿é‡åŠ›ä¸ X æˆ– Y è½´å¯¹é½ï¼Œä½†åŠ é€Ÿåº¦è®¡æµ‹é‡çš„åŠ é€Ÿåº¦å§‹ç»ˆæŒ‡å‘ä¸Šæ–¹ã€‚</p>
<p>è¿™é‡Œå‘ç”Ÿçš„æƒ…å†µæ˜¯ï¼ŒåŠ é€Ÿåº¦è®¡æµ‹é‡çš„æ˜¯ç”µè·¯æ¿çš„<em>æ­£ç¡®åŠ é€Ÿåº¦</em>ï¼Œè€Œä¸æ˜¯<em>æ‚¨</em>è§‚å¯Ÿåˆ°çš„åŠ é€Ÿåº¦ã€‚è¿™ä¸ªé€‚å½“çš„åŠ é€Ÿåº¦æ˜¯ä»è‡ªç”±è½ä½“çš„è§‚å¯Ÿè€…é‚£é‡Œçœ‹åˆ°çš„æ¿çš„åŠ é€Ÿåº¦ã€‚è‡ªç”±è½ä½“çš„è§‚å¯Ÿè€…æ­£ä»¥ çš„åŠ é€Ÿåº¦å‘åœ°çƒä¸­å¿ƒç§»åŠ¨<code>1g</code>ï¼›ä»å®ƒçš„è§’åº¦æ¥çœ‹ï¼Œæ£‹ç›˜å®é™…ä¸Šæ˜¯ä»¥ çš„åŠ é€Ÿåº¦å‘ä¸Šç§»åŠ¨ï¼ˆè¿œç¦»åœ°çƒä¸­å¿ƒï¼‰<code>1g</code>ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­£ç¡®çš„åŠ é€Ÿåº¦æŒ‡å‘ä¸Šæ–¹çš„åŸå› ã€‚è¿™ä¹Ÿæ„å‘³ç€å¦‚æœç”µè·¯æ¿å¤„äºè‡ªç”±è½ä½“çŠ¶æ€ï¼ŒåŠ é€Ÿåº¦è®¡ä¼šæŠ¥å‘Šæ­£ç¡®çš„é›¶åŠ é€Ÿåº¦ã€‚è¯·ä¸è¦åœ¨å®¶é‡Œå°è¯•ã€‚</p>
<h2 id="The-challenge-1"><a href="#The-challenge-1" class="headerlink" title="The challenge"></a>The challenge</h2><p>ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ä»…åœ¨æ¿ä¿æŒæ°´å¹³æ—¶æµ‹é‡ X è½´ä¸Šçš„åŠ é€Ÿåº¦ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸å¿…å¤„ç†å‡å»æˆ‘ä»¬ä¹‹å‰è§‚å¯Ÿåˆ°çš„<em>è™šæ„çš„</em> <code>1g</code>äº‹æƒ…ï¼Œè¿™ä¼šå¾ˆå›°éš¾ï¼Œå› ä¸º<code>1g</code>æ ¹æ®ç”µè·¯æ¿çš„æ–¹å‘ï¼Œè¿™å¯èƒ½ä¼šæœ‰ XYZ ç»„ä»¶ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ‰“å­”æœºå¿…é¡»æ‰§è¡Œçš„æ“ä½œï¼š</p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¸ä¼šâ€œè§‚å¯Ÿâ€æ¿çš„åŠ é€Ÿåº¦ã€‚</li>
<li>å½“æ£€æµ‹åˆ°æ˜¾ç€çš„ X åŠ é€Ÿåº¦æ—¶ï¼ˆå³åŠ é€Ÿåº¦è¶…è¿‡æŸä¸ªé˜ˆå€¼ï¼‰ï¼Œåº”ç”¨ç¨‹åºåº”å¼€å§‹æ–°çš„æµ‹é‡ã€‚</li>
<li>åœ¨è¯¥æµ‹é‡é—´éš”æœŸé—´ï¼Œåº”ç”¨ç¨‹åºåº”è·Ÿè¸ªè§‚å¯Ÿåˆ°çš„æœ€å¤§åŠ é€Ÿåº¦</li>
<li>æµ‹é‡é—´éš”ç»“æŸåï¼Œåº”ç”¨ç¨‹åºå¿…é¡»æŠ¥å‘Šè§‚å¯Ÿåˆ°çš„æœ€å¤§åŠ é€Ÿåº¦ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>iprintln</code>å®æŠ¥å‘Šè¯¥å€¼ã€‚</li>
</ul>
<p>è¯•ä¸€è¯•ï¼Œè®©æˆ‘çŸ¥é“ä½ èƒ½æ‰“å‡ºå¤šç”¨åŠ›<code>;-)</code>ã€‚</p>
<h2 id="My-solution-2"><a href="#My-solution-2" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">,</span> Sensitivity<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SENSITIVITY<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f32<span class="token punctuation">;</span>
    <span class="token keyword">const</span> THRESHOLD<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    lsm303dlhc<span class="token punctuation">.</span><span class="token function">set_accel_sensitivity</span><span class="token punctuation">(</span>Sensitivity<span class="token punctuation">:</span><span class="token punctuation">:</span>G12<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> measurement_time <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1 second in ticks</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> instant <span class="token operator">=</span> None<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> max_g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> g_x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>lsm303dlhc<span class="token punctuation">.</span><span class="token function">accel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>

        <span class="token keyword">match</span> instant <span class="token punctuation">{</span>
            None <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// If acceleration goes above a threshold, we start measuring</span>
                <span class="token keyword">if</span> g_x <span class="token operator">></span> THRESHOLD <span class="token punctuation">{</span>
                    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"START!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    max_g <span class="token operator">=</span> g_x<span class="token punctuation">;</span>
                    instant <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Still measuring</span>
            <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> instant<span class="token punctuation">)</span> <span class="token keyword">if</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> measurement_time <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> g_x <span class="token operator">></span> max_g <span class="token punctuation">{</span>
                    max_g <span class="token operator">=</span> g_x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Report max value</span>
                <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Max acceleration: {}g"</span><span class="token punctuation">,</span> max_g<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Measurement done</span>
                instant <span class="token operator">=</span> None<span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Reset</span>
                max_g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">50_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Whatâ€™s-left-for-you-to-explore"><a href="#Whatâ€™s-left-for-you-to-explore" class="headerlink" title="Whatâ€™s left for you to explore"></a>Whatâ€™s left for you to explore</h1><p>æˆ‘ä»¬å‡ ä¹æ²¡æœ‰è§¦åŠè¡¨é¢ï¼è¿˜æœ‰å¾ˆå¤šä¸œè¥¿ç­‰ä½ å»æ¢ç´¢ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨æ­£åœ¨é˜…è¯»æœ¬æ–‡ï¼Œå¹¶ä¸”å¸Œæœ›å¸®åŠ©åœ¨ Discovery ä¹¦ä¸­æ·»åŠ ä»¥ä¸‹ä»»ä½•é¡¹ç›®çš„ç¤ºä¾‹æˆ–ç»ƒä¹ ï¼Œæˆ–ä»»ä½•å…¶ä»–ç›¸å…³çš„åµŒå…¥ä¸»é¢˜ï¼Œæˆ‘ä»¬å¾ˆä¹æ„å¾—åˆ°æ‚¨çš„å¸®åŠ©ï¼</p>
<p>å¦‚æœæ‚¨æƒ³æä¾›å¸®åŠ©ï¼Œè¯·<a href="https://github.com/rust-embedded/discovery/issues/new" target="_blank" rel="noopener">æ‰“å¼€ä¸€ä¸ªé—®é¢˜</a>ï¼Œä½†éœ€è¦å¸®åŠ©æˆ–æŒ‡å¯¼å¦‚ä½•å°†å…¶è´¡çŒ®ç»™æœ¬ä¹¦ï¼Œæˆ–è€…æ‰“å¼€ä¸€ä¸ªæ·»åŠ ä¿¡æ¯çš„æ‹‰å–è¯·æ±‚ï¼</p>
</blockquote>
<h2 id="å…³äºåµŒå…¥å¼è½¯ä»¶çš„è¯é¢˜"><a href="#å…³äºåµŒå…¥å¼è½¯ä»¶çš„è¯é¢˜" class="headerlink" title="å…³äºåµŒå…¥å¼è½¯ä»¶çš„è¯é¢˜"></a>å…³äºåµŒå…¥å¼è½¯ä»¶çš„è¯é¢˜</h2><p>è¿™äº›ä¸»é¢˜è®¨è®ºç¼–å†™åµŒå…¥å¼è½¯ä»¶çš„ç­–ç•¥ã€‚å°½ç®¡å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼è§£å†³è®¸å¤šé—®é¢˜ï¼Œä½†è¿™äº›éƒ¨åˆ†è®¨è®ºäº†ä¸€äº›ç­–ç•¥ï¼Œä»¥åŠä½•æ—¶ä½¿ç”¨å®ƒä»¬æœ‰æ„ä¹‰ï¼ˆæˆ–æ²¡æœ‰æ„ä¹‰ï¼‰ã€‚</p>
<h3 id="å¤šä»»åŠ¡å¤„ç†"><a href="#å¤šä»»åŠ¡å¤„ç†" class="headerlink" title="å¤šä»»åŠ¡å¤„ç†"></a>å¤šä»»åŠ¡å¤„ç†</h3><p>æˆ‘ä»¬æ‰€æœ‰çš„ç¨‹åºéƒ½æ‰§è¡Œäº†ä¸€ä¸ªä»»åŠ¡ã€‚æˆ‘ä»¬å¦‚ä½•åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿä¸­å®ç°å¤šä»»åŠ¡å¤„ç†ï¼Œå› æ­¤æ²¡æœ‰çº¿ç¨‹ã€‚å¤šä»»åŠ¡å¤„ç†æœ‰ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼šæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†å’Œåä½œå¤šä»»åŠ¡å¤„ç†ã€‚</p>
<p>åœ¨æŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ä¸­ï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹ è¢«å¦ä¸€ä¸ªä»»åŠ¡<em>æŠ¢å </em>ï¼ˆä¸­æ–­ï¼‰ã€‚åœ¨æŠ¢å æ—¶ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡å°†è¢«æŒ‚èµ·ï¼Œå¤„ç†å™¨å°†è½¬è€Œæ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡ã€‚åœ¨æŸä¸ªæ—¶å€™ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡å°†æ¢å¤ã€‚å¾®æ§åˆ¶å™¨ä»¥<em>ä¸­æ–­</em>çš„å½¢å¼ä¸ºæŠ¢å æä¾›ç¡¬ä»¶æ”¯æŒã€‚</p>
<p>åœ¨åä½œå¤šä»»åŠ¡å¤„ç†ä¸­ï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°åˆ°è¾¾<em>æš‚åœç‚¹<em>ã€‚å½“å¤„ç†å™¨åˆ°è¾¾è¯¥æš‚åœç‚¹æ—¶ï¼Œå®ƒå°†åœæ­¢æ‰§è¡Œå½“å‰ä»»åŠ¡å¹¶è½¬è€Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨æŸä¸ªæ—¶å€™ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡å°†æ¢å¤ã€‚è¿™ä¸¤ç§å¤šä»»åŠ¡å¤„ç†æ–¹æ³•ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œåœ¨åä½œå¤šä»»åŠ¡å¤„ç†ä¸­ï¼Œåœ¨</em>å·²çŸ¥çš„<em>æš‚åœç‚¹</em>äº§ç”Ÿ</em> æ‰§è¡Œæ§åˆ¶ï¼Œè€Œä¸æ˜¯åœ¨å…¶æ‰§è¡Œçš„ä»»ä½•ç‚¹è¢«å¼ºè¡ŒæŠ¢å ã€‚</p>
<h3 id="ç¡çœ "><a href="#ç¡çœ " class="headerlink" title="ç¡çœ "></a>ç¡çœ </h3><p>æˆ‘ä»¬æ‰€æœ‰çš„ç¨‹åºéƒ½åœ¨ä¸æ–­åœ°è½®è¯¢å¤–å›´è®¾å¤‡ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä»€ä¹ˆéœ€è¦åšçš„ã€‚ç„¶è€Œï¼Œæœ‰æ—¶æ²¡æœ‰ä»€ä¹ˆå¯åšçš„ï¼åœ¨é‚£ä¸ªæ—¶å€™ï¼Œå¾®æ§åˆ¶å™¨åº”è¯¥â€œä¼‘çœ â€ã€‚</p>
<p>å½“å¤„ç†å™¨ä¼‘çœ æ—¶ï¼Œå®ƒä¼šåœæ­¢æ‰§è¡ŒæŒ‡ä»¤ï¼Œä»è€ŒèŠ‚çœç”µé‡ã€‚èŠ‚çœç”µé‡å‡ ä¹æ€»æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› æ­¤æ‚¨çš„å¾®æ§åˆ¶å™¨åº”è¯¥å°½å¯èƒ½å¤šåœ°ä¼‘çœ ã€‚ä½†æ˜¯ï¼Œå®ƒå¦‚ä½•çŸ¥é“ä½•æ—¶å¿…é¡»é†’æ¥æ‰èƒ½æ‰§è¡ŒæŸäº›æ“ä½œï¼Ÿâ€œä¸­æ–­â€æ˜¯å”¤é†’å¾®æ§åˆ¶å™¨çš„äº‹ä»¶ä¹‹ä¸€ï¼Œä½†è¿˜æœ‰å…¶ä»–äº‹ä»¶ï¼Œ<code>wfi</code>å¹¶ä¸”<code>wfe</code>æ˜¯ä½¿å¤„ç†å™¨â€œä¼‘çœ â€çš„æŒ‡ä»¤ã€‚</p>
<h2 id="ä¸å¾®æ§åˆ¶å™¨åŠŸèƒ½ç›¸å…³çš„ä¸»é¢˜"><a href="#ä¸å¾®æ§åˆ¶å™¨åŠŸèƒ½ç›¸å…³çš„ä¸»é¢˜" class="headerlink" title="ä¸å¾®æ§åˆ¶å™¨åŠŸèƒ½ç›¸å…³çš„ä¸»é¢˜"></a>ä¸å¾®æ§åˆ¶å™¨åŠŸèƒ½ç›¸å…³çš„ä¸»é¢˜</h2><p>å¾®æ§åˆ¶å™¨ï¼ˆå¦‚æˆ‘ä»¬çš„ STM32F3ï¼‰å…·æœ‰è®¸å¤šä¸åŒçš„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œè®¸å¤šå…±äº«ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå¯ç”¨äºè§£å†³å„ç§ä¸åŒçš„é—®é¢˜ã€‚</p>
<p>è¿™äº›ä¸»é¢˜è®¨è®ºäº†å…¶ä¸­çš„ä¸€äº›åŠŸèƒ½ï¼Œä»¥åŠå¦‚ä½•åœ¨åµŒå…¥å¼å¼€å‘ä¸­æœ‰æ•ˆåœ°ä½¿ç”¨å®ƒä»¬ã€‚</p>
<h3 id="ç›´æ¥å†…å­˜è®¿é—®-DMA"><a href="#ç›´æ¥å†…å­˜è®¿é—®-DMA" class="headerlink" title="ç›´æ¥å†…å­˜è®¿é—® (DMA)"></a>ç›´æ¥å†…å­˜è®¿é—® (DMA)</h3><p>è¿™ä¸ªå¤–è®¾æ˜¯ä¸€ç§<em>å¼‚æ­¥çš„</em> <code>memcpy</code>ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¸€ç›´åœ¨é€å­—èŠ‚åœ°å°†æ•°æ®æ³µé€åˆ° UART å’Œ I2C ç­‰å¤–è®¾ä¸­ã€‚è¯¥ DMA å¤–è®¾å¯ç”¨äºæ‰§è¡Œæ‰¹é‡æ•°æ®ä¼ è¾“ã€‚ä» RAM åˆ° RAMï¼Œä»å¤–å›´è®¾å¤‡ï¼ˆå¦‚ UARTï¼‰åˆ° RAM æˆ–ä» RAM åˆ°å¤–å›´è®¾å¤‡ã€‚æ‚¨å¯ä»¥å®‰æ’ DMA ä¼ è¾“ï¼Œä¾‹å¦‚ä» USART1 è¯»å– 256 ä¸ªå­—èŠ‚åˆ°æ­¤ç¼“å†²åŒºä¸­ï¼Œè®©å®ƒåœ¨åå°è¿è¡Œï¼Œç„¶åè½®è¯¢æŸä¸ªå¯„å­˜å™¨ä»¥æŸ¥çœ‹å®ƒæ˜¯å¦å·²å®Œæˆï¼Œä»¥ä¾¿æ‚¨å¯ä»¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–æ“ä½œã€‚</p>
<h3 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h3><p>ä¸ºäº†ä¸ç°å®ä¸–ç•Œè¿›è¡Œäº¤äº’ï¼Œå¾®æ§åˆ¶å™¨é€šå¸¸éœ€è¦åœ¨å‘ç”ŸæŸç§äº‹ä»¶æ—¶<em>ç«‹å³</em>åšå‡ºå“åº”ã€‚</p>
<p>å¾®æ§åˆ¶å™¨å…·æœ‰è¢«ä¸­æ–­çš„èƒ½åŠ›ï¼Œè¿™æ„å‘³ç€å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå®ƒä¼šåœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»ä½•æ“ä½œï¼Œè½¬è€Œå“åº”è¯¥äº‹ä»¶ã€‚å½“æˆ‘ä»¬æƒ³åœ¨æŒ‰ä¸‹æŒ‰é’®æ—¶åœæ­¢ç”µæœºæˆ–åœ¨è®¡æ—¶å™¨å®Œæˆå€’è®¡æ—¶æ—¶æµ‹é‡ä¼ æ„Ÿå™¨æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚</p>
<p>å°½ç®¡è¿™äº›ä¸­æ–­å¯èƒ½éå¸¸æœ‰ç”¨ï¼Œä½†å®ƒä»¬ä¹Ÿå¯èƒ½æœ‰ç‚¹éš¾ä»¥æ­£ç¡®ä½¿ç”¨ã€‚æˆ‘ä»¬å¸Œæœ›ç¡®ä¿å¿«é€Ÿå“åº”äº‹ä»¶ï¼ŒåŒæ—¶ä¹Ÿå…è®¸å…¶ä»–å·¥ä½œç»§ç»­è¿›è¡Œã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¸­æ–­è¿›è¡Œå»ºæ¨¡ï¼Œç±»ä¼¼äºæ¡Œé¢ Rust ç¨‹åºä¸Šçš„çº¿ç¨‹æ¦‚å¿µã€‚è¿™æ„å‘³ç€æˆ‘ä»¬è¿˜å¿…é¡»è€ƒè™‘ Rust æ¦‚å¿µ<code>Send</code>ä»¥åŠ<code>Sync</code> åœ¨æˆ‘ä»¬çš„ä¸»åº”ç”¨ç¨‹åºå’Œä½œä¸ºå¤„ç†ä¸­æ–­äº‹ä»¶çš„ä¸€éƒ¨åˆ†æ‰§è¡Œçš„ä»£ç ä¹‹é—´å…±äº«æ•°æ®æ—¶ã€‚</p>
<h3 id="è„‰å®½è°ƒåˆ¶-PWM"><a href="#è„‰å®½è°ƒåˆ¶-PWM" class="headerlink" title="è„‰å®½è°ƒåˆ¶ (PWM)"></a>è„‰å®½è°ƒåˆ¶ (PWM)</h3><p>ç®€è€Œè¨€ä¹‹ï¼ŒPWM ä¼šæ‰“å¼€æŸäº›ä¸œè¥¿ï¼Œç„¶åå®šæœŸå°†å…¶å…³é—­ï¼ŒåŒæ—¶åœ¨â€œå¼€å¯æ—¶é—´â€å’Œâ€œå…³é—­æ—¶é—´â€ä¹‹é—´ä¿æŒä¸€å®šæ¯”ä¾‹ï¼ˆâ€œå ç©ºæ¯”â€ï¼‰ã€‚å½“ç”¨äºå…·æœ‰è¶³å¤Ÿé«˜é¢‘ç‡çš„ LED æ—¶ï¼Œè¿™å¯ç”¨äºä½¿ LED å˜æš—ã€‚ä½å ç©ºæ¯”ï¼Œæ¯”å¦‚ 10% çš„æ—¶é—´å’Œ 90% çš„å…³é—­æ—¶é—´ï¼Œä¼šä½¿ LED éå¸¸æš—ï¼Œè€Œé«˜å ç©ºæ¯”ï¼Œæ¯”å¦‚ 90% çš„æ—¶é—´å’Œ 10% çš„å…³é—­æ—¶é—´ï¼Œä¼šä½¿ LED æ›´äº®ï¼ˆå‡ ä¹å¥½åƒå®ƒå·²å®Œå…¨é€šç”µï¼‰ã€‚</p>
<p>é€šå¸¸ï¼ŒPWM å¯ç”¨äºæ§åˆ¶å‘æŸäº›ç”µå­è®¾å¤‡æä¾›å¤šå°‘<em>åŠŸç‡</em>ã€‚é€šè¿‡å¾®æ§åˆ¶å™¨å’Œç”µåŠ¨æœºä¹‹é—´çš„é€‚å½“ï¼ˆåŠŸç‡ï¼‰ç”µå­è®¾å¤‡ï¼ŒPWM å¯ç”¨äºæ§åˆ¶å‘ç”µåŠ¨æœºæä¾›å¤šå°‘åŠŸç‡ï¼Œä»è€Œå¯ç”¨äºæ§åˆ¶å…¶æ‰­çŸ©å’Œé€Ÿåº¦ã€‚ç„¶åä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªè§’ä½ç½®ä¼ æ„Ÿå™¨ï¼Œä½ å°±å¾—åˆ°äº†ä¸€ä¸ªé—­ç¯æ§åˆ¶å™¨ï¼Œå¯ä»¥æ§åˆ¶ç”µæœºåœ¨ä¸åŒè´Ÿè½½ä¸‹çš„ä½ç½®ã€‚</p>
<h3 id="æ•°å­—è¾“å…¥"><a href="#æ•°å­—è¾“å…¥" class="headerlink" title="æ•°å­—è¾“å…¥"></a>æ•°å­—è¾“å…¥</h3><p>æˆ‘ä»¬ä½¿ç”¨å¾®æ§åˆ¶å™¨å¼•è„šä½œä¸ºæ•°å­—è¾“å‡ºæ¥é©±åŠ¨ LEDã€‚ä½†è¿™äº›å¼•è„šä¹Ÿå¯ä»¥é…ç½®ä¸ºæ•°å­—è¾“å…¥ã€‚ä½œä¸ºæ•°å­—è¾“å…¥ï¼Œè¿™äº›å¼•è„šå¯ä»¥è¯»å–å¼€å…³ï¼ˆå¼€/å…³ï¼‰æˆ–æŒ‰é’®ï¼ˆæŒ‰ä¸‹/æœªæŒ‰ä¸‹ï¼‰çš„äºŒè¿›åˆ¶çŠ¶æ€ã€‚</p>
<p>ï¼ˆ<em>å‰§é€</em>é˜…è¯»å¼€å…³/æŒ‰é’®çš„äºŒè¿›åˆ¶çŠ¶æ€å¹¶ä¸åƒå¬èµ·æ¥é‚£ä¹ˆç®€å•;-)</p>
<h3 id="æ¨¡æ•°è½¬æ¢å™¨-ADC"><a href="#æ¨¡æ•°è½¬æ¢å™¨-ADC" class="headerlink" title="æ¨¡æ•°è½¬æ¢å™¨ (ADC)"></a>æ¨¡æ•°è½¬æ¢å™¨ (ADC)</h3><p>é‚£é‡Œæœ‰å¾ˆå¤šæ•°å­—ä¼ æ„Ÿå™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ I2C å’Œ SPI ä¹‹ç±»çš„åè®®æ¥è¯»å–å®ƒä»¬ã€‚ä½†æ¨¡æ‹Ÿä¼ æ„Ÿå™¨ä¹Ÿå­˜åœ¨ï¼è¿™äº›ä¼ æ„Ÿå™¨åªæ˜¯è¾“å‡ºä¸€ä¸ªä¸å®ƒä»¬æ„Ÿæµ‹çš„å¹…åº¦æˆæ­£æ¯”çš„ç”µå‹ç”µå¹³ã€‚</p>
<p>ADC å¤–è®¾å¯ç”¨äºå°†è¯¥â€œæ¨¡æ‹Ÿâ€ç”µå‹ç”µå¹³ï¼ˆä¾‹å¦‚<code>1.25</code> ä¼ç‰¹ï¼‰è½¬æ¢ä¸º<code>[0, 65535]</code>å¤„ç†å™¨å¯ç”¨äºå…¶è®¡ç®—çš„èŒƒå›´å†…çš„â€œæ•°å­—â€æ•°å­—ã€‚</p>
<h3 id="æ•°æ¨¡è½¬æ¢å™¨-DAC"><a href="#æ•°æ¨¡è½¬æ¢å™¨-DAC" class="headerlink" title="æ•°æ¨¡è½¬æ¢å™¨ (DAC)"></a>æ•°æ¨¡è½¬æ¢å™¨ (DAC)</h3><p>æ­£å¦‚æ‚¨æ‰€æœŸæœ›çš„é‚£æ ·ï¼ŒDAC ä¸ ADC å®Œå…¨ç›¸åã€‚æ‚¨å¯ä»¥å°†ä¸€äº›æ•°å­—å€¼å†™å…¥å¯„å­˜å™¨ä»¥åœ¨æŸä¸ªâ€œæ¨¡æ‹Ÿâ€å¼•è„šä¸Šäº§ç”Ÿ<code>[0, 3.3V]</code>èŒƒå›´å†…çš„ç”µå‹ï¼ˆå‡è®¾æœ‰<code>3.3V</code>ç”µæºï¼‰ã€‚å½“è¿™ä¸ªæ¨¡æ‹Ÿå¼•è„šè¿æ¥åˆ°ä¸€äº›åˆé€‚çš„ç”µå­è®¾å¤‡å¹¶ä¸”å¯„å­˜å™¨ä»¥æŸä¸ªæ’å®šçš„ã€å¿«é€Ÿçš„é€Ÿç‡ï¼ˆé¢‘ç‡ï¼‰å’Œæ­£ç¡®çš„å€¼è¢«å†™å…¥æ—¶ï¼Œä½ å¯ä»¥äº§ç”Ÿå£°éŸ³ç”šè‡³éŸ³ä¹ï¼</p>
<h3 id="å®æ—¶æ—¶é’Ÿ-RTC"><a href="#å®æ—¶æ—¶é’Ÿ-RTC" class="headerlink" title="å®æ—¶æ—¶é’Ÿ (RTC)"></a>å®æ—¶æ—¶é’Ÿ (RTC)</h3><p>è¯¥å¤–å›´è®¾å¤‡å¯ç”¨äºä»¥â€œäººç±»æ ¼å¼â€è·Ÿè¸ªæ—¶é—´ã€‚ç§’ã€åˆ†é’Ÿã€å°æ—¶ã€å¤©ã€æœˆå’Œå¹´ã€‚è¿™ä¸ªå¤–å›´è®¾å¤‡å¤„ç†ä»â€œæ»´ç­”â€åˆ°è¿™äº›äººç±»å‹å¥½çš„æ—¶é—´å•ä½çš„è½¬æ¢ã€‚å®ƒç”šè‡³å¯ä»¥ä¸ºæ‚¨å¤„ç†é—°å¹´å’Œå¤ä»¤æ—¶ï¼</p>
<h3 id="å…¶ä»–é€šè®¯åè®®"><a href="#å…¶ä»–é€šè®¯åè®®" class="headerlink" title="å…¶ä»–é€šè®¯åè®®"></a>å…¶ä»–é€šè®¯åè®®</h3><p>SPIã€I2Sã€SMBUSã€CANã€IrDAã€ä»¥å¤ªç½‘ã€USBã€è“ç‰™ç­‰ã€‚</p>
<p>ä¸åŒçš„åº”ç”¨ç¨‹åºä½¿ç”¨ä¸åŒçš„é€šä¿¡åè®®ã€‚é¢å‘ç”¨æˆ·çš„åº”ç”¨ç¨‹åºé€šå¸¸æœ‰ä¸€ä¸ª USB è¿æ¥å™¨ï¼Œå› ä¸º USB æ˜¯ PC å’Œæ™ºèƒ½æ‰‹æœºä¸­æ— å¤„ä¸åœ¨çš„åè®®ã€‚è€Œåœ¨æ±½è½¦å†…ï¼Œæ‚¨ä¼šå‘ç°å¾ˆå¤š CANâ€œæ€»çº¿â€ã€‚ä¸€äº›æ•°å­—ä¼ æ„Ÿå™¨ä½¿ç”¨ SPIï¼Œå…¶ä»–ä½¿ç”¨ I2Cï¼Œå…¶ä»–ä½¿ç”¨ SMBUSã€‚</p>
<h2 id="ä¸€èˆ¬åµŒå…¥å¼ç›¸å…³ä¸»é¢˜"><a href="#ä¸€èˆ¬åµŒå…¥å¼ç›¸å…³ä¸»é¢˜" class="headerlink" title="ä¸€èˆ¬åµŒå…¥å¼ç›¸å…³ä¸»é¢˜"></a>ä¸€èˆ¬åµŒå…¥å¼ç›¸å…³ä¸»é¢˜</h2><p>è¿™äº›ä¸»é¢˜æ¶µç›–äº†ä¸ç‰¹å®šäºæˆ‘ä»¬çš„è®¾å¤‡æˆ–å…¶ä¸Šçš„ç¡¬ä»¶çš„é¡¹ç›®ã€‚ç›¸åï¼Œä»–ä»¬è®¨è®ºäº†å¯ç”¨äºåµŒå…¥å¼ç³»ç»Ÿçš„æœ‰ç”¨æŠ€æœ¯ã€‚</p>
<h3 id="é™€èºä»ª"><a href="#é™€èºä»ª" class="headerlink" title="é™€èºä»ª"></a>é™€èºä»ª</h3><p>ä½œä¸ºæˆ‘ä»¬çš„ Punch-o-meter ç»ƒä¹ çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨åŠ é€Ÿåº¦è®¡æ¥æµ‹é‡ä¸‰ä¸ªç»´åº¦çš„åŠ é€Ÿåº¦å˜åŒ–ã€‚æˆ‘ä»¬çš„ç”µè·¯æ¿è¿˜é…å¤‡äº†ä¸€ä¸ªç§°ä¸ºé™€èºä»ªçš„ä¼ æ„Ÿå™¨ï¼Œå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿæµ‹é‡ä¸‰ä¸ªç»´åº¦çš„â€œè‡ªæ—‹â€å˜åŒ–ã€‚</p>
<p>è¿™åœ¨å°è¯•æ„å»ºæŸäº›ç³»ç»Ÿæ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚æƒ³è¦é¿å…ç¿»å€’çš„æœºå™¨äººã€‚æ­¤å¤–ï¼Œæ¥è‡ªé™€èºä»ªç­‰ä¼ æ„Ÿå™¨çš„æ•°æ®ä¹Ÿå¯ä»¥ä½¿ç”¨ç§°ä¸ºä¼ æ„Ÿå™¨èåˆçš„æŠ€æœ¯ä¸æ¥è‡ªåŠ é€Ÿåº¦è®¡çš„æ•°æ®ç›¸ç»“åˆï¼ˆæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ï¼‰ã€‚</p>
<h3 id="ä¼ºæœå’Œæ­¥è¿›ç”µæœº"><a href="#ä¼ºæœå’Œæ­¥è¿›ç”µæœº" class="headerlink" title="ä¼ºæœå’Œæ­¥è¿›ç”µæœº"></a>ä¼ºæœå’Œæ­¥è¿›ç”µæœº</h3><p>è™½ç„¶æœ‰äº›ç”µæœºä¸»è¦ç”¨äºå‘ä¸€ä¸ªæ–¹å‘æˆ–å¦ä¸€ä¸ªæ–¹å‘æ—‹è½¬ï¼Œä¾‹å¦‚å‘å‰æˆ–å‘åé©±åŠ¨é¥æ§è½¦ï¼Œä½†æœ‰æ—¶æ›´ç²¾ç¡®åœ°æµ‹é‡ç”µæœºçš„æ—‹è½¬æ–¹å¼å¾ˆæœ‰ç”¨ã€‚</p>
<p>æˆ‘ä»¬çš„å¾®æ§åˆ¶å™¨å¯ç”¨äºé©±åŠ¨ä¼ºæœæˆ–æ­¥è¿›ç”µæœºï¼Œä»è€Œå¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶ç”µæœºè½¬åŠ¨çš„åœˆæ•°ï¼Œç”šè‡³å¯ä»¥å°†ç”µæœºå®šä½åœ¨ä¸€ä¸ªç‰¹å®šä½ç½®ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç§»åŠ¨æŒ‡å‘ç‰¹å®šæ–¹å‘çš„æ—¶é’Ÿã€‚</p>
<h3 id="ä¼ æ„Ÿå™¨èåˆ"><a href="#ä¼ æ„Ÿå™¨èåˆ" class="headerlink" title="ä¼ æ„Ÿå™¨èåˆ"></a>ä¼ æ„Ÿå™¨èåˆ</h3><p>STM32F3DISCOVERY åŒ…å«ä¸‰ä¸ªè¿åŠ¨ä¼ æ„Ÿå™¨ï¼šåŠ é€Ÿåº¦è®¡ã€é™€èºä»ªå’Œç£åŠ›è®¡ã€‚è¿™äº›æªæ–½æœ¬èº«å°±æ˜¯ï¼šï¼ˆé€‚å½“çš„ï¼‰åŠ é€Ÿåº¦ã€è§’é€Ÿåº¦å’Œï¼ˆåœ°çƒçš„ï¼‰ç£åœºã€‚ä½†æ˜¯è¿™äº›é‡çº§å¯ä»¥â€œèåˆâ€æˆæ›´æœ‰ç”¨çš„ä¸œè¥¿ï¼šç”µè·¯æ¿æ–¹å‘çš„â€œç¨³å¥â€æµ‹é‡ã€‚å…·æœ‰æ¯”å•ä¸ªä¼ æ„Ÿå™¨æ›´å°‘çš„æµ‹é‡è¯¯å·®çš„ç¨³å¥æ‰‹æ®µå°†èƒ½å¤Ÿåšåˆ°ã€‚</p>
<p>è¿™ç§ä»ä¸åŒæ¥æºè·å–æ›´å¯é æ•°æ®çš„æƒ³æ³•è¢«ç§°ä¸ºä¼ æ„Ÿå™¨èåˆã€‚</p>
<hr>
<p>é‚£ä¹ˆä¸‹ä¸€æ­¥å»å“ªé‡Œï¼Ÿæœ‰å‡ ç§é€‰æ‹©ï¼š</p>
<ul>
<li><p>æ‚¨å¯ä»¥æŸ¥çœ‹<a href="https://docs.rs/f3" target="_blank" rel="noopener"><code>f3</code></a>è‘£äº‹ä¼šæ”¯æŒç®±ä¸­çš„ç¤ºä¾‹ã€‚æ‰€æœ‰è¿™äº›ç¤ºä¾‹éƒ½é€‚ç”¨äºæ‚¨æ‹¥æœ‰çš„ STM32F3DISCOVERY æ¿ã€‚</p>
</li>
<li><p>ä½ å¯ä»¥è¯•è¯•<a href="https://mobile.twitter.com/japaricious/status/962770003325005824" target="_blank" rel="noopener">è¿™ä¸ªè¿åŠ¨ä¼ æ„Ÿå™¨æ¼”ç¤º</a>ã€‚<a href="http://blog.japaric.io/wd-1-2-l3gd20-lsm303dlhc-madgwick/" target="_blank" rel="noopener">è¿™ç¯‡åšæ–‡</a>ä¸­æä¾›äº†æœ‰å…³å®ç°å’Œæºä»£ç çš„è¯¦ç»†<a href="http://blog.japaric.io/wd-1-2-l3gd20-lsm303dlhc-madgwick/" target="_blank" rel="noopener">ä¿¡æ¯</a>ã€‚</p>
</li>
<li><p>ä½ å¯ä»¥æŸ¥çœ‹<a href="https://docs.rs/cortex-m-rtfm" target="_blank" rel="noopener">ç¾¤ä¼—å®æ—¶</a>ã€‚ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„æŠ¢å å¼å¤šä»»åŠ¡æ¡†æ¶ï¼Œæ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§å’Œæ— æ­»é”æ‰§è¡Œã€‚</p>
</li>
<li><p>æ‚¨å¯ä»¥å°è¯•åœ¨ä¸åŒçš„å¼€å‘æ¿ä¸Šè¿è¡Œ Rustã€‚æœ€ç®€å•çš„å…¥é—¨æ–¹æ³•æ˜¯ä½¿ç”¨<a href="https://docs.rs/cortex-m-quickstart/0.2.4/cortex_m_quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>Cargo é¡¹ç›®æ¨¡æ¿ã€‚</p>
</li>
<li><p>ä½ å¯ä»¥æŸ¥çœ‹<a href="http://blog.japaric.io/brave-new-io/" target="_blank" rel="noopener">è¿™ç¯‡åšå®¢æ–‡ç« </a>ï¼Œå®ƒæè¿°äº† Rust ç±»å‹ç³»ç»Ÿå¦‚ä½•é˜²æ­¢ I/O é…ç½®ä¸­çš„é”™è¯¯ã€‚</p>
</li>
<li><p>æ‚¨å¯ä»¥æŸ¥çœ‹æˆ‘çš„<a href="http://blog.japaric.io/" target="_blank" rel="noopener">åšå®¢</a>ï¼Œäº†è§£æœ‰å…³ä½¿ç”¨ Rust è¿›è¡ŒåµŒå…¥å¼å¼€å‘çš„å…¶ä»–ä¸»é¢˜ã€‚</p>
</li>
<li><p>æ‚¨å¯ä»¥æŸ¥çœ‹<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>æ—¨åœ¨ä¸ºå¾®æ§åˆ¶å™¨ä¸Šå¸¸è§çš„æ‰€æœ‰åµŒå…¥å¼ I/O åŠŸèƒ½æ„å»ºæŠ½è±¡ï¼ˆç‰¹å¾ï¼‰çš„é¡¹ç›®ã€‚</p>
</li>
<li><p>æ‚¨å¯ä»¥åŠ å…¥<a href="https://github.com/rust-lang-nursery/embedded-wg/issues/39" target="_blank" rel="noopener">Weekly driver è®¡åˆ’</a>å¹¶å¸®åŠ©æˆ‘ä»¬åœ¨<code>embedded-hal</code>ç‰¹å¾ä¹‹ä¸Šç¼–å†™é€šç”¨é©±åŠ¨ç¨‹åºï¼Œ å¹¶é€‚ç”¨äºå„ç§å¹³å°ï¼ˆARM Cortex-Mã€AVRã€MSP430ã€RISCV ç­‰ï¼‰</p>
</li>
</ul>
<h1 id="General-troubleshooting"><a href="#General-troubleshooting" class="headerlink" title="General troubleshooting"></a>General troubleshooting</h1><h2 id="OpenOCD-é—®é¢˜"><a href="#OpenOCD-é—®é¢˜" class="headerlink" title="OpenOCD é—®é¢˜"></a>OpenOCD é—®é¢˜</h2><h3 id="æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œé”™è¯¯ï¼šæ‰“å¼€å¤±è´¥â€"><a href="#æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œé”™è¯¯ï¼šæ‰“å¼€å¤±è´¥â€" class="headerlink" title="æ— æ³•è¿æ¥åˆ° OpenOCD - â€œé”™è¯¯ï¼šæ‰“å¼€å¤±è´¥â€"></a>æ— æ³•è¿æ¥åˆ° OpenOCD - â€œé”™è¯¯ï¼šæ‰“å¼€å¤±è´¥â€</h3><h4 id="ç—‡çŠ¶"><a href="#ç—‡çŠ¶" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><p>åœ¨å°è¯•ä¸è®¾å¤‡å»ºç«‹<em>æ–°è¿æ¥</em>æ—¶ï¼Œæ‚¨ä¼šæ”¶åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯ï¼š</p>
<pre><code>$ openocd -f (..)
(..)
Error: open failed
in procedure 'init'
in procedure 'ocd_bouncer'</code></pre><h4 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h4><p>è®¾å¤‡æœªï¼ˆæ­£ç¡®ï¼‰è¿æ¥æˆ–æœªä½¿ç”¨æ­£ç¡®çš„ ST-LINK æ¥å£é…ç½®ã€‚</p>
<h4 id="ä½¿å›ºå®š"><a href="#ä½¿å›ºå®š" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><p>Linuxï¼š</p>
<ul>
<li>ä½¿ç”¨ æ¥æ£€æŸ¥ USB è¿æ¥<code>lsusb</code>ã€‚</li>
<li>æ‚¨å¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ‰“å¼€è®¾å¤‡ã€‚å†è¯•ä¸€æ¬¡<code>sudo</code>ã€‚å¦‚æœå¯è¡Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">è¿™äº›è¯´æ˜</a>ä½¿ OpenOCD åœ¨æ²¡æœ‰ root æƒé™çš„æƒ…å†µä¸‹å·¥ä½œã€‚</li>
<li>æ‚¨å¯èƒ½ä¸º ST-LINK ä½¿ç”¨äº†é”™è¯¯çš„æ¥å£é…ç½®ã€‚å°è¯•<code>interface/stlink-v2.cfg</code>ä»£æ›¿<code>interface/stlink-v2-1.cfg</code>.</li>
</ul>
<p>è§†çª—ï¼š</p>
<ul>
<li>æ‚¨å¯èƒ½ç¼ºå°‘ ST-LINK USB é©±åŠ¨ç¨‹åºã€‚å®‰è£…è¯´æ˜ <a href="https://docs.rust-embedded.org/discovery/03-setup/windows.html#st-link-usb-driver" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ã€‚</li>
</ul>
<h3 id="æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œX00ms-åå†æ¬¡è½®è¯¢â€"><a href="#æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œX00ms-åå†æ¬¡è½®è¯¢â€" class="headerlink" title="æ— æ³•è¿æ¥åˆ° OpenOCD - â€œX00ms åå†æ¬¡è½®è¯¢â€"></a>æ— æ³•è¿æ¥åˆ° OpenOCD - â€œX00ms åå†æ¬¡è½®è¯¢â€</h3><h4 id="ç—‡çŠ¶-1"><a href="#ç—‡çŠ¶-1" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><p>åœ¨å°è¯•ä¸è®¾å¤‡å»ºç«‹<em>æ–°è¿æ¥</em>æ—¶ï¼Œæ‚¨ä¼šæ”¶åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯ï¼š</p>
<pre><code>$ openocd -f (..)
(..)
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 100ms
Info : Previous state query failed, trying to reconnect
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 300ms
Info : Previous state query failed, trying to reconnect</code></pre><h4 id="åŸå› -1"><a href="#åŸå› -1" class="headerlink" title="åŸå› "></a>åŸå› </h4><p>å¾®æ§åˆ¶å™¨å¯èƒ½é™·å…¥äº†æŸç§ç´§å¯†çš„æ— é™å¾ªç¯ä¸­ï¼Œæˆ–è€…å®ƒå¯èƒ½ä¸æ–­å¼•å‘å¼‚å¸¸ï¼Œä¾‹å¦‚å¼‚å¸¸å¤„ç†ç¨‹åºæ­£åœ¨å¼•å‘å¼‚å¸¸ã€‚</p>
<h4 id="ä½¿å›ºå®š-1"><a href="#ä½¿å›ºå®š-1" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><ul>
<li>å…³é—­ OpenOCDï¼Œå¦‚æœæ­£åœ¨è¿è¡Œ</li>
<li>æŒ‰ä½é‡ç½®ï¼ˆé»‘è‰²ï¼‰æŒ‰é’®</li>
<li>å¯åŠ¨ OpenOCD å‘½ä»¤</li>
<li>ç°åœ¨ï¼Œæ¾å¼€é‡ç½®æŒ‰é’®</li>
</ul>
<h3 id="OpenOCD-è¿æ¥ä¸¢å¤±-â€œåœ¨-X00-æ¯«ç§’å†…å†æ¬¡è½®è¯¢â€"><a href="#OpenOCD-è¿æ¥ä¸¢å¤±-â€œåœ¨-X00-æ¯«ç§’å†…å†æ¬¡è½®è¯¢â€" class="headerlink" title="OpenOCD è¿æ¥ä¸¢å¤± - â€œåœ¨ X00 æ¯«ç§’å†…å†æ¬¡è½®è¯¢â€"></a>OpenOCD è¿æ¥ä¸¢å¤± - â€œåœ¨ X00 æ¯«ç§’å†…å†æ¬¡è½®è¯¢â€</h3><h4 id="ç—‡çŠ¶-2"><a href="#ç—‡çŠ¶-2" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><p>ä¸€ä¸ª<em>è¿è¡Œ</em>OpenOCDçš„ä¼šè¯çªç„¶é”™è¯¯æœ‰ï¼š</p>
<pre><code># openocd -f (..)
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 100ms
Info : Previous state query failed, trying to reconnect
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 300ms
Info : Previous state query failed, trying to reconnect</code></pre><h4 id="åŸå› -2"><a href="#åŸå› -2" class="headerlink" title="åŸå› "></a>åŸå› </h4><p>USB è¿æ¥ä¸¢å¤±ã€‚</p>
<h4 id="ä½¿å›ºå®š-2"><a href="#ä½¿å›ºå®š-2" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><ul>
<li>å…³é—­ OpenOCD</li>
<li>æ–­å¼€å¹¶é‡æ–°è¿æ¥ USB ç”µç¼†ã€‚</li>
<li>é‡æ–°å¯åŠ¨ OpenOCD</li>
</ul>
<h3 id="æ— æ³•åˆ·æ–°è®¾å¤‡-â€œå¿½ç•¥æ•°æ®åŒ…é”™è¯¯ï¼Œç»§ç»­â€¦â€"><a href="#æ— æ³•åˆ·æ–°è®¾å¤‡-â€œå¿½ç•¥æ•°æ®åŒ…é”™è¯¯ï¼Œç»§ç»­â€¦â€" class="headerlink" title="æ— æ³•åˆ·æ–°è®¾å¤‡ - â€œå¿½ç•¥æ•°æ®åŒ…é”™è¯¯ï¼Œç»§ç»­â€¦â€"></a>æ— æ³•åˆ·æ–°è®¾å¤‡ - â€œå¿½ç•¥æ•°æ®åŒ…é”™è¯¯ï¼Œç»§ç»­â€¦â€</h3><h4 id="ç—‡çŠ¶-3"><a href="#ç—‡çŠ¶-3" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><p>åˆ·æ–°è®¾å¤‡æ—¶ï¼Œæ‚¨å°†è·å¾—ï¼š</p>
<pre><code>$ arm-none-eabi-gdb $file
Start address 0x8000194, load size 31588
Transfer rate: 22 KB/sec, 5264 bytes/write.
Ignoring packet error, continuing...
Ignoring packet error, continuing...</code></pre><h4 id="åŸå› -3"><a href="#åŸå› -3" class="headerlink" title="åŸå› "></a>åŸå› </h4><p><code>itmdump</code>åœ¨â€œæ‰“å°â€åˆ° ITM çš„ç¨‹åºè¿è¡Œæ—¶å…³é—­ã€‚å½“å‰ GDB ä¼šè¯å°†æ˜¾ç¤ºæ­£å¸¸å·¥ä½œï¼Œåªæ˜¯æ²¡æœ‰ ITM è¾“å‡ºï¼Œä½†ä¸‹ä¸€ä¸ª GDB ä¼šè¯å°†å‡ºç°é”™è¯¯ï¼Œå¹¶æ˜¾ç¤ºä¸Šä¸€èŠ‚ä¸­æ˜¾ç¤ºçš„æ¶ˆæ¯ã€‚</p>
<p>æˆ–è€…ï¼Œ<code>itmdump</code>è¢«ç§°ä¸º<strong>åï¼Œ</strong>å°†<code>monitor tpiu</code>å‘å‡ºä»è€Œä½¿ <code>itmdump</code>åˆ é™¤çš„æ–‡ä»¶/æ–‡ä»¶å‘½åç®¡é“æ˜¯OpenOCDçš„è¢«å†™å…¥ã€‚</p>
<h4 id="ä½¿å›ºå®š-3"><a href="#ä½¿å›ºå®š-3" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><ul>
<li>å…³é—­/æ€æ­» GDBã€OpenOCD å’Œ <code>itmdump</code></li>
<li>åˆ é™¤<code>itmdump</code>æ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶/å‘½åç®¡é“ï¼ˆä¾‹å¦‚ï¼Œ <code>itm.txt</code>ï¼‰ã€‚</li>
<li>å¯åŠ¨ OpenOCD</li>
<li>ç„¶åï¼Œå¯åŠ¨ <code>itmdump</code></li>
<li>ç„¶åï¼Œå¯åŠ¨æ‰§è¡Œ<code>monitor tpiu</code>å‘½ä»¤çš„ GDB ä¼šè¯ã€‚</li>
</ul>
<h3 id="æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œé”™è¯¯ï¼šæ— æ³•å°†-telnet-ç»‘å®šåˆ°å¥—æ¥å­—ï¼šåœ°å€å·²åœ¨ä½¿ç”¨ä¸­â€"><a href="#æ— æ³•è¿æ¥åˆ°-OpenOCD-â€œé”™è¯¯ï¼šæ— æ³•å°†-telnet-ç»‘å®šåˆ°å¥—æ¥å­—ï¼šåœ°å€å·²åœ¨ä½¿ç”¨ä¸­â€" class="headerlink" title="æ— æ³•è¿æ¥åˆ° OpenOCD - â€œé”™è¯¯ï¼šæ— æ³•å°† telnet ç»‘å®šåˆ°å¥—æ¥å­—ï¼šåœ°å€å·²åœ¨ä½¿ç”¨ä¸­â€"></a>æ— æ³•è¿æ¥åˆ° OpenOCD - â€œé”™è¯¯ï¼šæ— æ³•å°† telnet ç»‘å®šåˆ°å¥—æ¥å­—ï¼šåœ°å€å·²åœ¨ä½¿ç”¨ä¸­â€</h3><h4 id="ç—‡çŠ¶-4"><a href="#ç—‡çŠ¶-4" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><p>åœ¨å°è¯•ä¸è®¾å¤‡å»ºç«‹<em>æ–°è¿æ¥</em>æ—¶ï¼Œæ‚¨ä¼šæ”¶åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯ï¼š</p>
<pre><code>$ openocd -f (..)
(..)
Error: couldn't bind telnet to socket: Address already in use</code></pre><h4 id="åŸå› -4"><a href="#åŸå› -4" class="headerlink" title="åŸå› "></a>åŸå› </h4><p>OpenOCD éœ€è¦è®¿é—®çš„ä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ 3333ã€4444 æˆ– 6666 æ­£è¢«å¦ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚è¿™äº›ç«¯å£ä¸­çš„æ¯ä¸€ä¸ªéƒ½ç”¨äºå¦ä¸€ä¸ªæ–¹é¢ï¼š3333 ç”¨äº gdbï¼Œ4444 ç”¨äº telnetï¼Œ6666 ç”¨äº TCL çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ (RPC) å‘½ä»¤</p>
<h4 id="ä½¿å›ºå®š-4"><a href="#ä½¿å›ºå®š-4" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><p>ä½ å¯ä»¥èµ°ä¸¤æ¡è·¯çº¿æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚A) ç»ˆæ­¢ä½¿ç”¨è¿™äº›ç«¯å£ä¹‹ä¸€çš„ä»»ä½•è¿›ç¨‹ã€‚B) æŒ‡å®šæ‚¨çŸ¥é“å¯ä¾› OpenOCD å…è´¹ä½¿ç”¨çš„ä¸åŒç«¯å£ã€‚</p>
<p>æ–¹æ¡ˆä¸€</p>
<p>è‹¹æœç”µè„‘ï¼š</p>
<ul>
<li>é€šè¿‡è¿è¡Œè·å–ä½¿ç”¨ç«¯å£çš„è¿›ç¨‹åˆ—è¡¨ <code>sudo lsof -PiTCP -sTCP:LISTEN</code></li>
<li>é€šè¿‡è®°å½•å®ƒä»¬çš„ pid å¹¶<code>kill [pid]</code>ä¸ºæ¯ä¸ªè¿›ç¨‹è¿è¡Œæ¥ç»ˆæ­¢é˜»å¡å…³é”®ç«¯å£çš„è¿›ç¨‹ã€‚ï¼ˆå‡è®¾æ‚¨å¯ä»¥ç¡®è®¤ä»–ä»¬æ²¡æœ‰åœ¨æ‚¨çš„æœºå™¨ä¸Šè¿è¡Œä»»ä½•å…³é”®ä»»åŠ¡ï¼ï¼‰</li>
</ul>
<p>æ–¹æ¡ˆB</p>
<p>å…¨éƒ¨ï¼š</p>
<ul>
<li>å¯åŠ¨æ—¶å°†é…ç½®è¯¦ç»†ä¿¡æ¯å‘é€åˆ° OpenOCDï¼Œä»¥ä¾¿å®ƒå¯¹ä»»ä½•è¿›ç¨‹ä½¿ç”¨ä¸é»˜è®¤ç«¯å£ä¸åŒçš„ç«¯å£ã€‚</li>
<li>ä¾‹å¦‚ï¼Œè¦åœ¨ 4441 è€Œä¸æ˜¯é»˜è®¤çš„ 4444 ä¸Šæ‰§è¡Œå…¶ telnet åŠŸèƒ½ï¼Œæ‚¨å°†è¿è¡Œ <code>openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg -c "telnet_port 4441"</code></li>
<li>æ›´å¤šå…³äº OpenOCD é…ç½®é˜¶æ®µçš„ç»†èŠ‚å¯ä»¥åœ¨ä»–ä»¬çš„ [official docs online] ä¸­æ‰¾åˆ°ï¼š<a href="http://openocd.org/doc/html/Server-Configuration.html" target="_blank" rel="noopener">http://openocd.org/doc/html/Server-Configuration.html</a></li>
</ul>
<h2 id="Cargoé—®é¢˜"><a href="#Cargoé—®é¢˜" class="headerlink" title="Cargoé—®é¢˜"></a>Cargoé—®é¢˜</h2><h3 id="â€œæ‰¾ä¸åˆ°Crate-coreâ€"><a href="#â€œæ‰¾ä¸åˆ°Crate-coreâ€" class="headerlink" title="â€œæ‰¾ä¸åˆ°Crate coreâ€"></a>â€œæ‰¾ä¸åˆ°Crate <code>core</code>â€</h3><h4 id="ç—‡çŠ¶-5"><a href="#ç—‡çŠ¶-5" class="headerlink" title="ç—‡çŠ¶"></a>ç—‡çŠ¶</h4><pre><code>   Compiling volatile-register v0.1.2
   Compiling rlibc v1.0.0
   Compiling r0 v0.1.0
error[E0463]: can't find crate for `core`

error: aborting due to previous error

error[E0463]: can't find crate for `core`

error: aborting due to previous error

error[E0463]: can't find crate for `core`

error: aborting due to previous error

Build failed, waiting for other jobs to finish...
Build failed, waiting for other jobs to finish...
error: Could not compile `r0`.

To learn more, run the command again with --verbose.</code></pre><h4 id="åŸå› -5"><a href="#åŸå› -5" class="headerlink" title="åŸå› "></a>åŸå› </h4><p>æ‚¨ä½¿ç”¨çš„å·¥å…·é“¾æ—©äº<code>nightly-2018-04-08</code>å¹¶ä¸”å¿˜è®°è°ƒç”¨<code>rustup target add thumbv7em-none-eabihf</code>.</p>
<h4 id="ä½¿å›ºå®š-5"><a href="#ä½¿å›ºå®š-5" class="headerlink" title="ä½¿å›ºå®š"></a>ä½¿å›ºå®š</h4><p>æ¯æ™šæ›´æ–°å¹¶å®‰è£…<code>thumbv7em-none-eabihf</code>ç›®æ ‡ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup update nightly

$ rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="How-to-use-GDB"><a href="#How-to-use-GDB" class="headerlink" title="How to use GDB"></a>How to use GDB</h1><p>ä¸‹é¢æ˜¯ä¸€äº›æœ‰ç”¨çš„ GDB å‘½ä»¤ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è°ƒè¯•æˆ‘ä»¬çš„ç¨‹åºã€‚è¿™å‡è®¾æ‚¨å·²å°†<a href="https://docs.rust-embedded.org/discovery/05-led-roulette/flash-it.html" target="_blank" rel="noopener">ç¨‹åº</a>åˆ·å…¥å¾®æ§åˆ¶å™¨å¹¶è¿æ¥åˆ° OpenOCD ä¼šè¯ã€‚</p>
<h2 id="ä¸€èˆ¬è°ƒè¯•"><a href="#ä¸€èˆ¬è°ƒè¯•" class="headerlink" title="ä¸€èˆ¬è°ƒè¯•"></a>ä¸€èˆ¬è°ƒè¯•</h2><blockquote>
<p><strong>æ³¨æ„ï¼š</strong>æ‚¨åœ¨ä¸‹é¢çœ‹åˆ°çš„è®¸å¤šå‘½ä»¤éƒ½å¯ä»¥ä½¿ç”¨ç®€çŸ­çš„å½¢å¼æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œ<code>continue</code>å¯ä»¥ç®€å•åœ°ç”¨ä½œ<code>c</code>ï¼Œæˆ–è€…<code>break $location</code>å¯ä»¥ç”¨ä½œ<code>b $location</code>ã€‚ä¸€æ—¦æ‚¨å¯¹ä¸‹é¢çš„å‘½ä»¤æœ‰äº†ç»éªŒï¼Œè¯·å°è¯•çœ‹çœ‹åœ¨ GDB æ— æ³•è¯†åˆ«å®ƒä»¬ä¹‹å‰ï¼Œæ‚¨å¯ä»¥è®©è¿™äº›å‘½ä»¤è¿è¡Œå¤šçŸ­ï¼</p>
</blockquote>
<h3 id="å¤„ç†æ–­ç‚¹"><a href="#å¤„ç†æ–­ç‚¹" class="headerlink" title="å¤„ç†æ–­ç‚¹"></a>å¤„ç†æ–­ç‚¹</h3><ul>
<li><pre><code>break $location</code></pre><p>: åœ¨ä»£ç ä¸­çš„æŸä¸ªä½ç½®è®¾ç½®æ–­ç‚¹ã€‚çš„å€¼</p>
<pre><code>$location</code></pre><p>å¯ä»¥åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>break *main</code> - ä¸­æ–­å‡½æ•°çš„ç¡®åˆ‡åœ°å€ <code>main</code></li>
<li><code>break *0x080012f2</code> - æ‰“ç ´ç¡®åˆ‡çš„å†…å­˜ä½ç½® <code>0x080012f2</code></li>
<li><code>break 123</code> - åœ¨å½“å‰æ˜¾ç¤ºæ–‡ä»¶çš„ç¬¬ 123 è¡Œä¸­æ–­</li>
<li><code>break main.rs:123</code> - åœ¨æ–‡ä»¶çš„ç¬¬ 123 è¡Œä¸­æ–­ <code>main.rs</code></li>
</ul>
</li>
<li><p><code>info break</code>: æ˜¾ç¤ºå½“å‰æ–­ç‚¹</p>
</li>
<li><pre><code>delete</code></pre><p>: åˆ é™¤æ‰€æœ‰æ–­ç‚¹</p>
<ul>
<li><code>delete $n</code>ï¼šåˆ é™¤æ–­ç‚¹<code>$n</code>ï¼ˆ<code>n</code>æ˜¯ä¸€ä¸ªæ•°ï¼Œä¾‹å¦‚ï¼š<code>delete $2</code>ï¼‰</li>
</ul>
</li>
<li><pre><code>clear</code></pre><p>: åˆ é™¤ä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ–­ç‚¹</p>
<ul>
<li><code>clear main.rs:$function</code>: åˆ é™¤<code>$function</code>inå…¥å£å¤„çš„æ–­ç‚¹<code>main.rs</code></li>
<li><code>clear main.rs:123</code>: åˆ é™¤ç¬¬ 123 è¡Œçš„æ–­ç‚¹ <code>main.rs</code></li>
</ul>
</li>
<li><pre><code>enable</code></pre><p>: å¯ç”¨æ‰€æœ‰è®¾ç½®çš„æ–­ç‚¹</p>
<ul>
<li><code>enable $n</code>: å¯ç”¨æ–­ç‚¹ <code>$n</code></li>
</ul>
</li>
<li><pre><code>disable</code></pre><p>: ç¦ç”¨æ‰€æœ‰è®¾ç½®çš„æ–­ç‚¹</p>
<ul>
<li><code>disable $n</code>: ç¦ç”¨æ–­ç‚¹ <code>$n</code></li>
</ul>
</li>
</ul>
<h3 id="æ§åˆ¶æ‰§è¡Œ"><a href="#æ§åˆ¶æ‰§è¡Œ" class="headerlink" title="æ§åˆ¶æ‰§è¡Œ"></a>æ§åˆ¶æ‰§è¡Œ</h3><ul>
<li><p><code>continue</code>: å¼€å§‹æˆ–ç»§ç»­æ‰§è¡Œä½ çš„ç¨‹åº</p>
</li>
<li><pre><code>next</code></pre><p>: æ‰§è¡Œç¨‹åºçš„ä¸‹ä¸€è¡Œ</p>
<ul>
<li><code>next $n</code>: é‡å¤<code>next</code> <code>$n</code>æ•°æ¬¡</li>
</ul>
</li>
<li><p><code>nexti</code>: åŒï¼Œ<code>next</code>ä½†ç”¨æœºå™¨æŒ‡ä»¤ä»£æ›¿</p>
</li>
<li><pre><code>step</code></pre><p>: æ‰§è¡Œä¸‹ä¸€è¡Œï¼Œå¦‚æœä¸‹ä¸€è¡ŒåŒ…å«å¯¹å¦ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼Œåˆ™å•æ­¥æ‰§è¡Œè¯¥ä»£ç </p>
<ul>
<li><code>step $n</code>: é‡å¤<code>step</code> <code>$n</code>æ•°æ¬¡</li>
</ul>
</li>
<li><p><code>stepi</code>: åŒï¼Œ<code>step</code>ä½†ç”¨æœºå™¨æŒ‡ä»¤ä»£æ›¿</p>
</li>
<li><pre><code>jump $location</code></pre><p>ï¼šåœ¨æŒ‡å®šä½ç½®æ¢å¤æ‰§è¡Œï¼š</p>
<ul>
<li><code>jump 123</code>: åœ¨ç¬¬ 123 è¡Œæ¢å¤æ‰§è¡Œ</li>
<li><code>jump 0x080012f2</code>: åœ¨åœ°å€ 0x080012f2 å¤„æ¢å¤æ‰§è¡Œ</li>
</ul>
</li>
</ul>
<h3 id="å°åˆ·ä¿¡æ¯"><a href="#å°åˆ·ä¿¡æ¯" class="headerlink" title="å°åˆ·ä¿¡æ¯"></a>å°åˆ·ä¿¡æ¯</h3><ul>
<li><pre><code>print /$f $data</code></pre><p>- æ‰“å°å˜é‡åŒ…å«çš„å€¼</p>
<pre><code>$data</code></pre><p>ã€‚å¯ä»¥é€‰æ‹©ä½¿ç”¨ æ ¼å¼åŒ–è¾“å‡º</p>
<pre><code>$f</code></pre><p>ï¼Œå…¶ä¸­å¯ä»¥åŒ…æ‹¬ï¼š</p>
<pre class="line-numbers language-txt"><code class="language-txt">x: hexadecimal 
d: signed decimal
u: unsigned decimal
o: octal
t: binary
a: address
c: character
f: floating point<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>print /t 0xA</code>: å°†åå…­è¿›åˆ¶å€¼æ‰“å°<code>0xA</code>ä¸ºäºŒè¿›åˆ¶ (0b1010)</li>
</ul>
</li>
<li><pre><code>x /$n$u$f $address</code></pre><p>: æ£€æŸ¥å†…å­˜åœ¨</p>
<pre><code>$address</code></pre><p>ã€‚å¯é€‰åœ°ï¼Œ</p>
<pre><code>$n</code></pre><p>å®šä¹‰è¦æ˜¾ç¤ºçš„å•ä½æ•°ã€</p>
<pre><code>$u</code></pre><p>å•ä½å¤§å°ï¼ˆå­—èŠ‚ã€åŠå­—ã€å­—ç­‰ï¼‰ã€ä¸Šé¢å®šä¹‰çš„</p>
<pre><code>$f</code></pre><p>ä»»ä½•</p>
<pre><code>print</code></pre><p>æ ¼å¼</p>
<ul>
<li><code>x /5i 0x080012c4</code>: æ‰“å°5æ¡æœºå™¨æŒ‡ä»¤ç›¯ç€åœ°å€ <code>0x080012c4</code></li>
<li><code>x/4xb $pc</code>: ä»<code>$pc</code>å½“å‰æŒ‡å‘çš„ä½ç½®å¼€å§‹æ‰“å° 4 ä¸ªå­—èŠ‚çš„å†…å­˜</li>
</ul>
</li>
<li><pre><code>disassemble $location</code></pre><ul>
<li><code>disassemble /r main</code>ï¼šåæ±‡ç¼–å‡½æ•°<code>main</code>ï¼Œ<code>/r</code>ç”¨äºæ˜¾ç¤ºç»„æˆæ¯æ¡æŒ‡ä»¤çš„å­—èŠ‚</li>
</ul>
</li>
</ul>
<h3 id="æŸ¥çœ‹ç¬¦å·è¡¨"><a href="#æŸ¥çœ‹ç¬¦å·è¡¨" class="headerlink" title="æŸ¥çœ‹ç¬¦å·è¡¨"></a>æŸ¥çœ‹ç¬¦å·è¡¨</h3><ul>
<li><pre><code>info functions $regex</code></pre><p>: æ‰“å°åŒ¹é…çš„å‡½æ•°çš„åç§°å’Œæ•°æ®ç±»å‹</p>
<pre><code>$regex</code></pre><p>ï¼Œçœç•¥</p>
<pre><code>$regex</code></pre><p>æ‰“å°æ‰€æœ‰å‡½æ•°</p>
<ul>
<li><code>info functions main</code>: æ‰“å°åŒ…å«å•è¯çš„å·²å®šä¹‰å‡½æ•°çš„åç§°å’Œç±»å‹ <code>main</code></li>
</ul>
</li>
<li><pre><code>info address $symbol</code></pre><p>: æ‰“å°</p>
<pre><code>$symbol</code></pre><p>å†…å­˜ä¸­çš„å­˜å‚¨ä½ç½®</p>
<ul>
<li><code>info address GPIOC</code>: æ‰“å°å˜é‡çš„å†…å­˜åœ°å€ <code>GPIOC</code></li>
</ul>
</li>
<li><p><code>info variables $regex</code>: æ‰“å°åŒ¹é…çš„å…¨å±€å˜é‡çš„åç§°å’Œç±»å‹<code>$regex</code>ï¼Œçœç•¥<code>$regex</code>æ‰“å°æ‰€æœ‰å…¨å±€å˜é‡</p>
</li>
<li><pre><code>ptype $data</code></pre><p>: æ‰“å°æ›´å¤šè¯¦ç»†ä¿¡æ¯ </p>
<pre><code>$data</code></pre><ul>
<li><code>ptype cp</code>: æ‰“å°å˜é‡çš„è¯¦ç»†ç±»å‹ä¿¡æ¯ <code>cp</code></li>
</ul>
</li>
</ul>
<h3 id="æµè§ˆç¨‹åºå †æ ˆ"><a href="#æµè§ˆç¨‹åºå †æ ˆ" class="headerlink" title="æµè§ˆç¨‹åºå †æ ˆ"></a>æµè§ˆç¨‹åºå †æ ˆ</h3><ul>
<li><pre><code>backtrace $n</code></pre><p>: æ‰“å°</p>
<pre><code>$n</code></pre><p>å¸§è½¨è¿¹ï¼Œæˆ–çœç•¥</p>
<pre><code>$n</code></pre><p>æ‰“å°æ‰€æœ‰å¸§</p>
<ul>
<li><code>backtrace 2</code>: æ‰“å°å‰ 2 å¸§çš„è½¨è¿¹</li>
</ul>
</li>
<li><p><code>frame $n</code>: é€‰æ‹©å¸¦ç¼–å·æˆ–åœ°å€çš„å¸§<code>$n</code>ï¼Œçœç•¥<code>$n</code>æ˜¾ç¤ºå½“å‰å¸§</p>
</li>
<li><p><code>up $n</code>: é€‰æ‹©å¸§<code>$n</code>å¸§å‘ä¸Š</p>
</li>
<li><p><code>down $n</code>:<code>$n</code>å‘ä¸‹é€‰æ‹©å¸§å¸§</p>
</li>
<li><p><code>info frame $address</code>: æè¿°å¸§å¤„<code>$address</code>ï¼Œçœç•¥<code>$address</code>å½“å‰é€‰å®šçš„å¸§</p>
</li>
<li><p><code>info args</code>: æ‰“å°é€‰å®šå¸§çš„å‚æ•°</p>
</li>
<li><pre><code>info registers $r</code></pre><p>: æ‰“å°</p>
<pre><code>$r</code></pre><p>é€‰å®šå¸§ä¸­å¯„å­˜å™¨çš„å€¼ï¼Œ</p>
<pre><code>$r</code></pre><p>æ‰€æœ‰å¯„å­˜å™¨ çœç•¥</p>
<ul>
<li><code>info registers $sp</code>: æ‰“å°<code>$sp</code>å½“å‰å¸§ä¸­æ ˆæŒ‡é’ˆå¯„å­˜å™¨çš„å€¼</li>
</ul>
</li>
</ul>
<h3 id="è¿œç¨‹æ§åˆ¶-OpenOCD"><a href="#è¿œç¨‹æ§åˆ¶-OpenOCD" class="headerlink" title="è¿œç¨‹æ§åˆ¶ OpenOCD"></a>è¿œç¨‹æ§åˆ¶ OpenOCD</h3><ul>
<li><pre><code>monitor reset run</code></pre><p>ï¼šé‡ç½®CPUï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œ</p>
<ul>
<li><code>monitor reset</code>: å’Œä¸Šé¢ä¸€æ ·</li>
</ul>
</li>
<li><p><code>monitor reset init</code>: é‡ç½® CPUï¼Œåœ¨å¼€å§‹æ—¶åœæ­¢æ‰§è¡Œ</p>
</li>
<li><p><code>monitor targets</code>: æ˜¾ç¤ºå½“å‰ç›®æ ‡çš„ä¿¡æ¯å’ŒçŠ¶æ€</p>
</li>
</ul>
<h1 id="ğŸ˜ã€ŠThe-Embedonomiconã€‹"><a href="#ğŸ˜ã€ŠThe-Embedonomiconã€‹" class="headerlink" title="ğŸ˜ã€ŠThe Embedonomiconã€‹"></a>ğŸ˜ã€ŠThe Embedonomiconã€‹</h1><h1 id="The-embedonomicon"><a href="#The-embedonomicon" class="headerlink" title="The embedonomicon"></a>The embedonomicon</h1><p>embedonomion å°†å¼•å¯¼æ‚¨å®Œæˆ<code>#![no_std]</code>ä»å¤´å¼€å§‹åˆ›å»ºåº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ï¼Œä»¥åŠä¸º Cortex-M å¾®æ§åˆ¶å™¨æ„å»ºç‰¹å®šäºæ¶æ„çš„åŠŸèƒ½çš„è¿­ä»£è¿‡ç¨‹ã€‚</p>
<h2 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h2><p>è¿™æœ¬ä¹¦æ˜¯è‡ªåŒ…å«çš„ã€‚è¯»è€…ä¸éœ€è¦ç†Ÿæ‚‰ Cortex-M æ¶æ„ï¼Œä¹Ÿä¸éœ€è¦è®¿é—® Cortex-M å¾®æ§åˆ¶å™¨â€”â€”æœ¬ä¹¦ä¸­åŒ…å«çš„æ‰€æœ‰ç¤ºä¾‹éƒ½å¯ä»¥åœ¨ QEMU ä¸­è¿›è¡Œæµ‹è¯•ã€‚ä½†æ˜¯ï¼Œæ‚¨éœ€è¦å®‰è£…ä»¥ä¸‹å·¥å…·æ¥è¿è¡Œå’Œæ£€æŸ¥æœ¬ä¹¦ä¸­çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li>æœ¬ä¹¦æ‰€æœ‰ä»£ç å‡ä½¿ç”¨2018ç‰ˆã€‚å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰ 2018 å¹´çš„åŠŸèƒ½å’Œä¹ æƒ¯ç”¨æ³•ï¼Œè¯·æŸ¥çœ‹<a href="https://rust-lang-nursery.github.io/edition-guide/" target="_blank" rel="noopener"><code>edition guide</code></a>.</li>
<li>Rust 1.31 æˆ–æ›´æ–°çš„å·¥å…·é“¾åŠ ä¸Š ARM Cortex-M ç¼–è¯‘æ”¯æŒã€‚</li>
<li><a href="https://github.com/japaric/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a>. v0.1.4 æˆ–æ›´æ–°ç‰ˆæœ¬ã€‚</li>
<li><a href="https://crates.io/crates/cargo-edit" target="_blank" rel="noopener"><code>cargo-edit</code></a>.</li>
<li>QEMU æ”¯æŒ ARM ä»¿çœŸã€‚è¯¥<code>qemu-system-arm</code>ç¨‹åºå¿…é¡»å®‰è£…åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šã€‚</li>
<li>å…·æœ‰ ARM æ”¯æŒçš„ GDBã€‚</li>
</ul>
<h3 id="ç¤ºä¾‹è®¾ç½®"><a href="#ç¤ºä¾‹è®¾ç½®" class="headerlink" title="ç¤ºä¾‹è®¾ç½®"></a>ç¤ºä¾‹è®¾ç½®</h3><p>æ‰€æœ‰æ“ä½œç³»ç»Ÿé€šç”¨çš„æŒ‡ä»¤</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Rust toolchain
$ # If you start from scratch, get rustup from https://rustup.rs/
$ rustup default stable

$ # toolchain should be newer than this one
$ rustc -V
rustc 1.31.0 (abe02cefd 2018-12-04)

$ rustup target add thumbv7m-none-eabi

$ # cargo-binutils
$ cargo install cargo-binutils

$ rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="è‹¹æœç³»ç»Ÿ-1"><a href="#è‹¹æœç³»ç»Ÿ-1" class="headerlink" title="è‹¹æœç³»ç»Ÿ"></a>è‹¹æœç³»ç»Ÿ</h4><pre class="line-numbers language-console"><code class="language-console">$ # arm-none-eabi-gdb
$ # you may need to run `brew tap Caskroom/tap` first
$ brew cask install gcc-arm-embedded

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-16-04"><a href="#Ubuntu-16-04" class="headerlink" title="Ubuntu 16.04"></a>Ubuntu 16.04</h4><pre class="line-numbers language-console"><code class="language-console">$ # arm-none-eabi-gdb
$ sudo apt install gdb-arm-none-eabi

$ # QEMU
$ sudo apt install qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-18-04-æˆ–-Debian"><a href="#Ubuntu-18-04-æˆ–-Debian" class="headerlink" title="Ubuntu 18.04 æˆ– Debian"></a>Ubuntu 18.04 æˆ– Debian</h4><pre class="line-numbers language-console"><code class="language-console">$ # gdb-multiarch -- use `gdb-multiarch` when you wish to invoke gdb
$ sudo apt install gdb-multiarch

$ # QEMU
$ sudo apt install qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="è§†çª—"><a href="#è§†çª—" class="headerlink" title="è§†çª—"></a>è§†çª—</h4><ul>
<li><a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">arm-none-eabi-gdb</a>ã€‚GNU Arm åµŒå…¥å¼å·¥å…·é“¾åŒ…æ‹¬ GDBã€‚</li>
<li><a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">qemu</a></li>
</ul>
<h2 id="ä»-ARM-å®‰è£…å·¥å…·é“¾åŒ…ï¼ˆå¯é€‰æ­¥éª¤ï¼‰ï¼ˆåœ¨-Ubuntu-18-04-ä¸Šæµ‹è¯•ï¼‰"><a href="#ä»-ARM-å®‰è£…å·¥å…·é“¾åŒ…ï¼ˆå¯é€‰æ­¥éª¤ï¼‰ï¼ˆåœ¨-Ubuntu-18-04-ä¸Šæµ‹è¯•ï¼‰" class="headerlink" title="ä» ARM å®‰è£…å·¥å…·é“¾åŒ…ï¼ˆå¯é€‰æ­¥éª¤ï¼‰ï¼ˆåœ¨ Ubuntu 18.04 ä¸Šæµ‹è¯•ï¼‰"></a>ä» ARM å®‰è£…å·¥å…·é“¾åŒ…ï¼ˆå¯é€‰æ­¥éª¤ï¼‰ï¼ˆåœ¨ Ubuntu 18.04 ä¸Šæµ‹è¯•ï¼‰</h2><ul>
<li>éšç€ 2018 å¹´åº•ä»<a href="https://rust-embedded.github.io/blog/2018-08-2x-psa-cortex-m-breakage/" target="_blank" rel="noopener">GCC çš„é“¾æ¥å™¨</a>åˆ‡æ¢ åˆ°Cortex-M å¾®æ§åˆ¶å™¨çš„<a href="https://rust-embedded.github.io/blog/2018-08-2x-psa-cortex-m-breakage/" target="_blank" rel="noopener">LLD</a>ï¼Œä¸å†éœ€è¦<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">gcc-arm-none-eabi</a>ã€‚ä½†æ˜¯å¯¹äºé‚£äº›å¸Œæœ›ä½¿ç”¨å·¥å…·é“¾çš„äººæ¥è¯´ï¼Œä»<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">è¿™é‡Œ</a>å®‰è£…å¹¶æŒ‰ç…§ä¸‹é¢åˆ—å‡ºçš„æ­¥éª¤æ“ä½œï¼š</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ tar xvjf gcc-arm-none-eabi-8-2018-q4-major-linux.tar.bz2
$ mv gcc-arm-none-eabi-<version_downloaded> <your_desired_path> # optional
$ export PATH=${PATH}:<path_to_arm_none_eabi_folder>/bin # add this line to .bashrc to make persisten<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="The-smallest-no-std-program"><a href="#The-smallest-no-std-program" class="headerlink" title="The smallest #![no_std] program"></a>The smallest <code>#![no_std]</code> program</h1><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™æœ€å°çš„<code>#![no_std]</code>ç¨‹åºæ¥<em>ç¼–è¯‘</em>.</p>
<h2 id="ä»€ä¹ˆ-no-std-æ„æ€ï¼Ÿ"><a href="#ä»€ä¹ˆ-no-std-æ„æ€ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆ#![no_std]æ„æ€ï¼Ÿ"></a>ä»€ä¹ˆ<code>#![no_std]</code>æ„æ€ï¼Ÿ</h2><p><code>#![no_std]</code>æ˜¯ä¸€ä¸ª crate çº§åˆ«å±æ€§ï¼Œè¡¨ç¤º crate å°†é“¾æ¥åˆ°<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener"><code>core</code></a> crate è€Œä¸æ˜¯<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener"><code>std</code></a>crateï¼Œä½†è¿™å¯¹åº”ç”¨ç¨‹åºæ„å‘³ç€ä»€ä¹ˆï¼Ÿ</p>
<p>è¯¥<code>std</code>ç®±æ˜¯é™¤é”ˆçš„æ ‡å‡†åº“ã€‚å®ƒåŒ…å«å‡å®šç¨‹åºå°†åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œè€Œä¸æ˜¯<a href="https://en.wikipedia.org/wiki/Bare_machine" target="_blank" rel="noopener"><em>ç›´æ¥åœ¨é‡‘å±ä¸Šè¿è¡Œçš„åŠŸèƒ½</em></a>ã€‚<code>std</code>è¿˜å‡è®¾æ“ä½œç³»ç»Ÿæ˜¯é€šç”¨æ“ä½œç³»ç»Ÿï¼Œå°±åƒåœ¨æœåŠ¡å™¨å’Œå°å¼æœºä¸­æ‰¾åˆ°çš„æ“ä½œç³»ç»Ÿä¸€æ ·ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œ<code>std</code>æä¾›äº†ä¸€ä¸ªæ ‡å‡† APIï¼Œè€Œä¸æ˜¯é€šå¸¸åœ¨ä»¥ä¸‹æ“ä½œç³»ç»Ÿä¸­å¯ä»¥æ‰¾åˆ°çš„åŠŸèƒ½ï¼šçº¿ç¨‹ã€æ–‡ä»¶ã€å¥—æ¥å­—ã€æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹ç­‰ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œ<code>core</code>åŒ…æ˜¯åŒ…çš„å­é›†ï¼Œ<code>std</code>å®ƒå¯¹ç¨‹åºå°†åœ¨å…¶ä¸Šè¿è¡Œçš„ç³»ç»Ÿåšå‡ºé›¶å‡è®¾ã€‚å› æ­¤ï¼Œå®ƒä¸ºæµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡ç­‰è¯­è¨€åŸè¯­æä¾› APIï¼Œä»¥åŠå…¬å¼€åŸå­æ“ä½œå’Œ SIMD æŒ‡ä»¤ç­‰å¤„ç†å™¨åŠŸèƒ½çš„ APIã€‚ç„¶è€Œï¼Œå®ƒç¼ºå°‘ä»»ä½•æ¶‰åŠå †å†…å­˜åˆ†é…å’Œ I/O çš„ APIã€‚</p>
<p>å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œ<code>std</code>ä¸ä»…ä»…æ˜¯æä¾›ä¸€ç§è®¿é—®æ“ä½œç³»ç»ŸæŠ½è±¡çš„æ–¹æ³•ã€‚<code>std</code>å®ƒè¿˜è´Ÿè´£è®¾ç½®å †æ ˆæº¢å‡ºä¿æŠ¤ã€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ä»¥åŠåœ¨<code>main</code>è°ƒç”¨ç¨‹åºå‡½æ•°ä¹‹å‰ç”Ÿæˆä¸»çº¿ç¨‹ç­‰ã€‚ä¸€ä¸ª<code>#![no_std]</code> åº”ç”¨ç¨‹åºç¼ºä¹æ‰€æœ‰æ ‡å‡†è¿è¡Œï¼Œæ‰€ä»¥å®ƒå¿…é¡»åˆå§‹åŒ–å®ƒè‡ªå·±çš„è¿è¡Œæ—¶ï¼Œå¦‚æœæœ‰éœ€è¦ã€‚</p>
<p>ç”±äºè¿™äº›å±æ€§ï¼Œ<code>#![no_std]</code>åº”ç”¨ç¨‹åºå¯ä»¥æ˜¯ç³»ç»Ÿä¸Šè¿è¡Œçš„ç¬¬ä¸€ä¸ªå’Œ/æˆ–å”¯ä¸€çš„ä»£ç ã€‚å®ƒå¯ä»¥æ˜¯æ ‡å‡† Rust åº”ç”¨ç¨‹åºæ°¸è¿œæ— æ³•åšåˆ°çš„è®¸å¤šäº‹æƒ…ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>æ“ä½œç³»ç»Ÿçš„å†…æ ¸ã€‚</li>
<li>å›ºä»¶ã€‚</li>
<li>ä¸€ä¸ªå¼•å¯¼ç¨‹åºã€‚</li>
</ul>
<h2 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h2><p>æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­<code>#![no_std]</code>ç¼–è¯‘æœ€å°çš„ç¨‹åºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --edition 2018 --bin app

$ cd app
$ # modify main.rs so it has these contents
$ cat src/main.rs
#![no_main]
#![no_std]

use core::panic::PanicInfo;

#[panic_handler]
fn panic(_panic: &PanicInfo<'_>) -> ! {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªç¨‹åºåŒ…å«ä¸€äº›ä½ åœ¨æ ‡å‡† Rust ç¨‹åºä¸­çœ‹ä¸åˆ°çš„ä¸œè¥¿ï¼š</p>
<p><code>#![no_std]</code>æˆ‘ä»¬å·²ç»å¹¿æ³›æ¶µç›–çš„å±æ€§ã€‚</p>
<p>è¯¥<code>#![no_main]</code>å±æ€§æ„å‘³ç€ç¨‹åºä¸ä¼šä½¿ç”¨æ ‡å‡†<code>main</code>å‡½æ•°ä½œä¸ºå…¶å…¥å£ç‚¹ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒRust çš„<code>main</code>æ¥å£å¯¹ç¨‹åºæ‰§è¡Œçš„ç¯å¢ƒåšäº†ä¸€äº›å‡è®¾ï¼šä¾‹å¦‚ï¼Œå®ƒå‡è®¾å­˜åœ¨å‘½ä»¤è¡Œå‚æ•°ï¼Œå› æ­¤ä¸€èˆ¬æ¥è¯´ï¼Œå®ƒä¸é€‚ç”¨äº<code>#![no_std]</code>ç¨‹åºã€‚</p>
<p>è¯¥<code>#[panic_handler]</code>å±æ€§ã€‚æ ‡æœ‰æ­¤å±æ€§çš„å‡½æ•°å®šä¹‰äº†ææ…Œçš„è¡Œä¸ºï¼ŒåŒ…æ‹¬åº“çº§ææ…Œ ( <code>core::panic!</code>) å’Œè¯­è¨€çº§ææ…Œï¼ˆè¶Šç•Œç´¢å¼•ï¼‰ã€‚</p>
<p>è¿™ä¸ªç¨‹åºä¸ä¼šäº§ç”Ÿä»»ä½•æœ‰ç”¨çš„ä¸œè¥¿ã€‚äº‹å®ä¸Šï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ªç©ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # equivalent to `size target/thumbv7m-none-eabi/debug/app`
$ cargo size --target thumbv7m-none-eabi --bin app
   text       data        bss        dec        hex    filename
      0          0          0          0          0    app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨é“¾æ¥æ¿æ¡ç®±ä¹‹å‰ç¡®å®åŒ…å«ææ…Œç¬¦å·ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo rustc --target thumbv7m-none-eabi -- --emit=obj

$ cargo nm -- target/thumbv7m-none-eabi/debug/deps/app-*.o | grep '[0-9]* [^N] '
00000000 T rust_begin_unwind<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶è€Œï¼Œè¿™æ˜¯æˆ‘ä»¬çš„èµ·ç‚¹ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€äº›æœ‰ç”¨çš„ä¸œè¥¿ã€‚ä½†åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªé»˜è®¤æ„å»ºç›®æ ‡ï¼Œä»¥é¿å…å¿…é¡»å°†<code>--target</code>æ ‡å¿—ä¼ é€’ç»™æ¯ä¸ª Cargo è°ƒç”¨ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ mkdir .cargo

$ # modify .cargo/config so it has these contents
$ cat .cargo/config
[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="eh-personality"><a href="#eh-personality" class="headerlink" title="eh_personality"></a>eh_personality</h2><p>å¦‚æœæ‚¨çš„é…ç½®æ²¡æœ‰å› ææ…Œè€Œæ— æ¡ä»¶ä¸­æ­¢ï¼Œè€Œå®Œæ•´æ“ä½œç³»ç»Ÿçš„å¤§å¤šæ•°ç›®æ ‡éƒ½æ²¡æœ‰ï¼ˆæˆ–è€…å¦‚æœæ‚¨çš„<a href="https://docs.rust-embedded.org/embedonomicon/custom-target.html" target="_blank" rel="noopener">è‡ªå®šä¹‰ç›®æ ‡</a>ä¸åŒ…å« <code>"panic-strategy": "abort"</code>ï¼‰ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»å‘Šè¯‰ Cargo è¿™æ ·åšæˆ–æ·»åŠ ä¸€ä¸ª<code>eh_personality</code>å‡½æ•°ï¼Œè¿™éœ€è¦æ¯æ™šç¼–è¯‘å™¨ã€‚<a href="https://doc.rust-lang.org/unstable-book/language-features/lang-items.html#more-about-the-language-items" target="_blank" rel="noopener">è¿™æ˜¯ Rust å…³äºå®ƒçš„æ–‡æ¡£</a>ï¼Œ<a href="https://www.reddit.com/r/rust/comments/estvau/til_why_the_eh_personality_language_item_is/" target="_blank" rel="noopener">è¿™é‡Œæœ‰ä¸€äº›å…³äºå®ƒçš„è®¨è®º</a>ã€‚</p>
<p>åœ¨ Cargo.toml ä¸­ï¼Œæ·»åŠ ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ–è€…ï¼Œå£°æ˜<code>eh_personality</code>å‡½æ•°ã€‚ä¸€ä¸ªåœ¨å±•å¼€æ—¶ä¸åšä»»ä½•ç‰¹æ®Šäº‹æƒ…çš„ç®€å•å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(lang_items)]</span>

#<span class="token punctuation">[</span>lang <span class="token operator">=</span> <span class="token string">"eh_personality"</span><span class="token punctuation">]</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">eh_personality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>language item required, but not found: 'eh_personality'</code>å¦‚æœä¸åŒ…æ‹¬åœ¨å†…ï¼Œæ‚¨å°†æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ã€‚</p>
<h1 id="Memory-layout"><a href="#Memory-layout" class="headerlink" title="Memory layout"></a>Memory layout</h1><p>ä¸‹ä¸€æ­¥æ˜¯ç¡®ä¿ç¨‹åºå…·æœ‰æ­£ç¡®çš„å†…å­˜å¸ƒå±€ï¼Œä»¥ä¾¿ç›®æ ‡ç³»ç»Ÿèƒ½å¤Ÿæ‰§è¡Œå®ƒã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è™šæ‹Ÿ Cortex-M3 å¾®æ§åˆ¶å™¨ï¼š <a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>ã€‚æˆ‘ä»¬çš„ç¨‹åºå°†æ˜¯è®¾å¤‡ä¸Šè¿è¡Œçš„å”¯ä¸€è¿›ç¨‹ï¼Œå› æ­¤å®ƒè¿˜å¿…é¡»è´Ÿè´£åˆå§‹åŒ–è®¾å¤‡ã€‚</p>
<h2 id="èƒŒæ™¯èµ„æ–™"><a href="#èƒŒæ™¯èµ„æ–™" class="headerlink" title="èƒŒæ™¯èµ„æ–™"></a>èƒŒæ™¯èµ„æ–™</h2><p>Cortex-M è®¾å¤‡è¦æ±‚åœ¨å…¶<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/memory-model" target="_blank" rel="noopener">ä»£ç å­˜å‚¨åŒº</a>çš„å¼€å¤´å­˜åœ¨ä¸€ä¸ª<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/exception-model/vector-table" target="_blank" rel="noopener">å‘é‡è¡¨</a>ã€‚å‘é‡è¡¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼›å¯åŠ¨è®¾å¤‡éœ€è¦å‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œå…¶ä½™æŒ‡é’ˆä¸å¼‚å¸¸æœ‰å…³ã€‚æˆ‘ä»¬æš‚æ—¶å¿½ç•¥å®ƒä»¬ã€‚</p>
<p>é“¾æ¥å™¨å†³å®šç¨‹åºçš„æœ€ç»ˆå†…å­˜å¸ƒå±€ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://sourceware.org/binutils/docs/ld/Scripts.html" target="_blank" rel="noopener">é“¾æ¥å™¨è„šæœ¬</a>å¯¹å…¶è¿›è¡Œä¸€äº›æ§åˆ¶ã€‚é“¾æ¥å™¨è„šæœ¬ä¸ºæˆ‘ä»¬æä¾›çš„å¸ƒå±€æ§åˆ¶ç²’åº¦æ˜¯åœ¨<em>éƒ¨åˆ†</em>çº§åˆ«ã€‚èŠ‚æ˜¯åœ¨è¿ç»­å†…å­˜ä¸­å¸ƒç½®çš„<em>ç¬¦å·</em>é›†åˆã€‚åè¿‡æ¥ï¼Œç¬¦å·å¯ä»¥æ˜¯æ•°æ®ï¼ˆé™æ€å˜é‡ï¼‰æˆ–æŒ‡ä»¤ï¼ˆRust å‡½æ•°ï¼‰ã€‚</p>
<p>æ¯ä¸ªç¬¦å·éƒ½æœ‰ä¸€ä¸ªç”±ç¼–è¯‘å™¨åˆ†é…çš„åç§°ã€‚ä½œä¸ºé˜²é”ˆ1.28çš„ï¼Œåç§°ï¼Œè¯¥é”ˆç¼–è¯‘å—è®©äººä»¥ç¬¦å·çš„å½¢å¼ä¸ºï¼š<code>_ZN5krate6module8function17he1dfc17c86fe16daE</code>ï¼Œå…¶ä¸­demanglesåˆ° <code>krate::module::function::he1dfc17c86fe16da</code>å“ªé‡Œ<code>krate::module::function</code>æ˜¯å‡½æ•°æˆ–å˜é‡çš„è·¯å¾„å’Œ<code>he1dfc17c86fe16da</code>æ˜¯æŸç§æ•£åˆ—ã€‚Rust ç¼–è¯‘å™¨ä¼šå°†æ¯ä¸ªç¬¦å·æ”¾å…¥è‡ªå·±å”¯ä¸€çš„éƒ¨åˆ†ï¼›ä¾‹å¦‚ï¼Œå‰é¢æåˆ°çš„ç¬¦å·å°†æ”¾ç½®åœ¨åä¸º<code>.text._ZN5krate6module8function17he1dfc17c86fe16daE</code>.</p>
<p>è¿™äº›ç¼–è¯‘å™¨ç”Ÿæˆçš„ç¬¦å·å’ŒèŠ‚åç§°ä¸èƒ½ä¿è¯åœ¨ Rust ç¼–è¯‘å™¨çš„ä¸åŒç‰ˆæœ¬ä¸­ä¿æŒä¸å˜ã€‚ä½†æ˜¯ï¼Œè¯¥è¯­è¨€å…è®¸æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å±æ€§æ§åˆ¶ç¬¦å·åç§°å’Œéƒ¨åˆ†ä½ç½®ï¼š</p>
<ul>
<li><code>#[export_name = "foo"]</code>å°†ç¬¦å·åç§°è®¾ç½®ä¸º<code>foo</code>.</li>
<li><code>#[no_mangle]</code>æ„æ€æ˜¯ï¼šä½¿ç”¨å‡½æ•°æˆ–å˜é‡åï¼ˆä¸æ˜¯å®ƒçš„å®Œæ•´è·¯å¾„ï¼‰ä½œä¸ºå®ƒçš„ç¬¦å·åã€‚ <code>#[no_mangle] fn bar()</code>å°†äº§ç”Ÿä¸€ä¸ªåä¸º çš„ç¬¦å·<code>bar</code>ã€‚</li>
<li><code>#[link_section = ".bar"]</code>å°†ç¬¦å·æ”¾åœ¨åä¸º çš„éƒ¨åˆ†ä¸­<code>.bar</code>ã€‚</li>
</ul>
<p>é€šè¿‡è¿™äº›å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å…¬å¼€ç¨‹åºçš„ç¨³å®š ABI å¹¶åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­ä½¿ç”¨å®ƒã€‚</p>
<h2 id="The-Rust-side"><a href="#The-Rust-side" class="headerlink" title="The Rust side"></a>The Rust side</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå¯¹äº Cortex-M è®¾å¤‡ï¼Œæˆ‘ä»¬éœ€è¦å¡«å……å‘é‡è¡¨çš„å‰ä¸¤ä¸ªæ¡ç›®ã€‚ç¬¬ä¸€ä¸ªï¼Œå †æ ˆæŒ‡é’ˆçš„åˆå§‹å€¼ï¼Œå¯ä»¥ä»…ä½¿ç”¨é“¾æ¥æè¿°æ–‡ä»¶å¡«å……ã€‚ç¬¬äºŒä¸ªæ˜¯é‡ç½®å‘é‡ï¼Œéœ€è¦åœ¨ Rust ä»£ç ä¸­åˆ›å»ºå¹¶ä½¿ç”¨é“¾æ¥æè¿°æ–‡ä»¶æ­£ç¡®æ”¾ç½®ã€‚</p>
<p>é‡ç½®å‘é‡æ˜¯æŒ‡å‘é‡ç½®å¤„ç†ç¨‹åºçš„æŒ‡é’ˆã€‚å¤ä½å¤„ç†ç¨‹åºæ˜¯è®¾å¤‡åœ¨ç³»ç»Ÿå¤ä½åæˆ–ç¬¬ä¸€æ¬¡ä¸Šç”µåå°†æ‰§è¡Œçš„å‡½æ•°ã€‚é‡ç½®å¤„ç†ç¨‹åºå§‹ç»ˆæ˜¯ç¡¬ä»¶è°ƒç”¨å †æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå †æ ˆå¸§ï¼›ä»å®ƒè¿”å›æ˜¯æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› ä¸ºæ²¡æœ‰å…¶ä»–å †æ ˆå¸§è¦è¿”å›ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿å…¶æˆä¸ºä¸€ä¸ªå‘æ•£å‡½æ•°æ¥å¼ºåˆ¶é‡ç½®å¤„ç†ç¨‹åºæ°¸è¿œä¸ä¼šè¿”å›ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰ç­¾åçš„å‡½æ•°<code>fn(/* .. */) -&gt; !</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// can't return so we go into an infinite loop here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// The reset vector, a pointer into the reset handler</span>
#<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".vector_table.reset_vector"</span><span class="token punctuation">]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">static</span> RESET_VECTOR<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token operator">=</span> Reset<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¡¬ä»¶åœ¨è¿™é‡Œéœ€è¦æŸç§æ ¼å¼ï¼Œæˆ‘ä»¬åšæŒä½¿ç”¨å®ƒ<code>extern "C"</code>æ¥å‘Šè¯‰ç¼–è¯‘å™¨ä½¿ç”¨ C ABI é™ä½å‡½æ•°ï¼Œè€Œä¸æ˜¯ä¸ç¨³å®šçš„ Rust ABIã€‚</p>
<p>è¦ä»é“¾æ¥æè¿°æ–‡ä»¶ä¸­å¼•ç”¨é‡ç½®å¤„ç†ç¨‹åºå’Œé‡ç½®å‘é‡ï¼Œæˆ‘ä»¬éœ€è¦å®ƒä»¬æœ‰ä¸€ä¸ªç¨³å®šçš„ç¬¦å·åç§°ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨<code>#[no_mangle]</code>. æˆ‘ä»¬éœ€è¦å¯¹ çš„ä½ç½®è¿›è¡Œç²¾ç»†æ§åˆ¶<code>RESET_VECTOR</code>ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶æ”¾ç½®åœ¨å·²çŸ¥éƒ¨åˆ† ä¸­<code>.vector_table.reset_vector</code>ã€‚é‡ç½®å¤„ç†ç¨‹åºæœ¬èº«çš„ç¡®åˆ‡ä½ç½®<code>Reset</code>å¹¶ä¸é‡è¦ã€‚æˆ‘ä»¬åªæ˜¯åšæŒä½¿ç”¨é»˜è®¤çš„ç¼–è¯‘å™¨ç”Ÿæˆéƒ¨åˆ†ã€‚</p>
<p>é“¾æ¥å™¨åœ¨éå†è¾“å…¥ç›®æ ‡æ–‡ä»¶åˆ—è¡¨æ—¶å°†å¿½ç•¥å…·æœ‰å†…éƒ¨é“¾æ¥çš„ç¬¦å·ï¼ˆä¹Ÿç§°ä¸ºå†…éƒ¨ç¬¦å·ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æˆ‘ä»¬çš„ä¸¤ä¸ªç¬¦å·å…·æœ‰å¤–éƒ¨é“¾æ¥ã€‚åœ¨ Rust ä¸­å°†ç¬¦å·è®¾ä¸ºå¤–éƒ¨çš„å”¯ä¸€æ–¹æ³•æ˜¯å°†å…¶å¯¹åº”çš„é¡¹ç›®è®¾ä¸ºå…¬å¼€ ( <code>pub</code>) ä¸”<em>å¯è®¿é—®</em>ï¼ˆé¡¹ç›®å’Œ crate çš„æ ¹ä¹‹é—´æ²¡æœ‰ç§æœ‰æ¨¡å—ï¼‰ã€‚</p>
<h2 id="é“¾æ¥å™¨è„šæœ¬ç«¯"><a href="#é“¾æ¥å™¨è„šæœ¬ç«¯" class="headerlink" title="é“¾æ¥å™¨è„šæœ¬ç«¯"></a>é“¾æ¥å™¨è„šæœ¬ç«¯</h2><p>å°†å‘é‡è¡¨æ”¾ç½®åœ¨æ­£ç¡®ä½ç½®çš„æœ€å°é“¾æ¥æè¿°æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat link.x
/* Memory layout of the LM3S6965 microcontroller */
/* 1K = 1 KiBi = 1024 bytes */
MEMORY
{
  FLASH : ORIGIN = 0x00000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 64K
}

/* The entry point is the reset handler */
ENTRY(Reset);

EXTERN(RESET_VECTOR);

SECTIONS
{
  .vector_table ORIGIN(FLASH) :
  {
    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));
  } > FLASH

  .text :
  {
    *(.text .text.*);
  } > FLASH

  /DISCARD/ :
  {
    *(.ARM.exidx .ARM.exidx.*);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="MEMORY"><a href="#MEMORY" class="headerlink" title="MEMORY"></a><code>MEMORY</code></h3><p>é“¾æ¥æè¿°æ–‡ä»¶çš„è¿™ä¸€éƒ¨åˆ†æè¿°äº†ç›®æ ‡å†…å­˜å—çš„ä½ç½®å’Œå¤§å°ã€‚å®šä¹‰äº†ä¸¤ä¸ªå†…å­˜å—ï¼š<code>FLASH</code>å’Œ<code>RAM</code>; å®ƒä»¬å¯¹åº”äºç›®æ ‡ä¸­å¯ç”¨çš„ç‰©ç†å†…å­˜ã€‚æ­¤å¤„ä½¿ç”¨çš„å€¼å¯¹åº”äº LM3S6965 å¾®æ§åˆ¶å™¨ã€‚</p>
<h3 id="ENTRY"><a href="#ENTRY" class="headerlink" title="ENTRY"></a><code>ENTRY</code></h3><p>è¿™é‡Œæˆ‘ä»¬å‘é“¾æ¥å™¨æŒ‡ç¤ºç¬¦å·åç§°ä¸º çš„é‡ç½®å¤„ç†ç¨‹åº<code>Reset</code>æ˜¯ç¨‹åºçš„ <em>å…¥å£ç‚¹</em>ã€‚é“¾æ¥å™¨ç§¯æä¸¢å¼ƒæœªä½¿ç”¨çš„éƒ¨åˆ†ã€‚é“¾æ¥å™¨å°†å…¥å£ç‚¹å’Œä»ä¸­è°ƒç”¨çš„å‡½æ•°è§†ä¸ºå·²<em>ä½¿ç”¨ï¼Œ</em>å› æ­¤ä¸ä¼šä¸¢å¼ƒå®ƒä»¬ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€è¡Œï¼Œé“¾æ¥å™¨å°†ä¸¢å¼ƒè¯¥<code>Reset</code>å‡½æ•°ä»¥åŠä»å®ƒè°ƒç”¨çš„æ‰€æœ‰åç»­å‡½æ•°ã€‚</p>
<h3 id="EXTERN"><a href="#EXTERN" class="headerlink" title="EXTERN"></a><code>EXTERN</code></h3><p>é“¾æ¥å™¨æ˜¯æ‡’æƒ°çš„ï¼›ä¸€æ—¦ä»–ä»¬æ‰¾åˆ°äº†ä»å…¥å£ç‚¹é€’å½’å¼•ç”¨çš„æ‰€æœ‰ç¬¦å·ï¼Œä»–ä»¬å°†åœæ­¢æŸ¥çœ‹è¾“å…¥ç›®æ ‡æ–‡ä»¶ã€‚å³ä½¿åœ¨æ‰¾åˆ°æ‰€æœ‰å…¶ä»–å¼•ç”¨çš„ç¬¦å·ä¹‹åï¼Œä¹Ÿ<code>EXTERN</code>å¼ºåˆ¶é“¾æ¥å™¨æŸ¥æ‰¾<code>EXTERN</code>çš„å‚æ•°ã€‚æ ¹æ®ç»éªŒï¼Œå¦‚æœæ‚¨éœ€è¦ä¸€ä¸ªæœªä»å…¥å£ç‚¹è°ƒç”¨çš„ç¬¦å·å§‹ç»ˆå‡ºç°åœ¨è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œåˆ™åº”<code>EXTERN</code>ä¸<code>KEEP</code>.</p>
<h3 id="SECTIONS"><a href="#SECTIONS" class="headerlink" title="SECTIONS"></a><code>SECTIONS</code></h3><p>è¿™éƒ¨åˆ†æè¿°äº†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„èŠ‚ï¼ˆä¹Ÿç§°ä¸º<em>è¾“å…¥èŠ‚</em>ï¼‰å¦‚ä½•å®‰æ’åœ¨è¾“å‡ºç›®æ ‡æ–‡ä»¶çš„èŠ‚ï¼ˆä¹Ÿç§°ä¸ºè¾“å‡ºèŠ‚ï¼‰ä¸­ï¼Œæˆ–è€…å®ƒä»¬æ˜¯å¦åº”è¯¥è¢«ä¸¢å¼ƒã€‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªè¾“å‡ºéƒ¨åˆ†ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">  .vector_table ORIGIN(FLASH) : { /* .. */ } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>.vector_table</code>åŒ…å«å‘é‡è¡¨å¹¶ä½äº<code>FLASH</code>å†…å­˜çš„å¼€å¤´ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">  .text : { /* .. */ } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>.text</code>åŒ…å«ç¨‹åºå­ç¨‹åºå¹¶ä½äº<code>FLASH</code>. å®ƒçš„èµ·å§‹åœ°å€æ²¡æœ‰æŒ‡å®šï¼Œä½†é“¾æ¥å™¨å°†æŠŠå®ƒæ”¾åœ¨å‰ä¸€ä¸ªè¾“å‡ºæ®µä¹‹å <code>.vector_table</code>ã€‚</p>
<p>è¾“å‡º<code>.vector_table</code>éƒ¨åˆ†åŒ…å«ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ï¼ˆè°ƒç”¨ï¼‰å †æ ˆæ”¾åœ¨ RAM çš„æœ«å°¾ï¼ˆå †æ ˆ<em>å·²æ»¡é™åº</em>ï¼›å®ƒå‘æ›´å°çš„åœ°å€å¢é•¿ï¼‰ï¼Œå› æ­¤ RAM çš„ç»“æŸåœ°å€å°†ç”¨ä½œåˆå§‹å †æ ˆæŒ‡é’ˆ (SP) å€¼ã€‚è¯¥åœ°å€æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¸º<code>RAM</code> å†…å­˜å—è¾“å…¥çš„ä¿¡æ¯åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<pre><code>    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>KEEP</code>å¼ºåˆ¶é“¾æ¥å™¨<code>.vector_table.reset_vector</code>åœ¨åˆå§‹ SP å€¼ä¹‹åæ’å…¥æ‰€æœ‰å‘½åçš„è¾“å…¥èŠ‚ ã€‚ä½äºè¯¥éƒ¨åˆ†çš„å”¯ä¸€ç¬¦å·æ˜¯<code>RESET_VECTOR</code>ï¼Œå› æ­¤è¿™å°†æœ‰æ•ˆåœ°<code>RESET_VECTOR</code>æ’åœ¨å‘é‡è¡¨ä¸­çš„ç¬¬äºŒä½ã€‚</p>
<p>è¾“å‡º<code>.text</code>éƒ¨åˆ†åŒ…å«ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">    *(.text .text.*);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™åŒ…æ‹¬æ‰€æœ‰åä¸º<code>.text</code>å’Œçš„è¾“å…¥éƒ¨åˆ†<code>.text.*</code>ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬<code>KEEP</code> åœ¨æ­¤å¤„ä¸ä½¿ç”¨è®©é“¾æ¥å™¨ä¸¢å¼ƒæœªä½¿ç”¨çš„éƒ¨åˆ†ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ç‰¹æ®Š<code>/DISCARD/</code>éƒ¨åˆ†ä¸¢å¼ƒ</p>
<pre class="line-numbers language-text"><code class="language-text">    *(.ARM.exidx .ARM.exidx.*);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åä¸º<code>.ARM.exidx.*</code>. è¿™äº›éƒ¨åˆ†ä¸å¼‚å¸¸å¤„ç†æœ‰å…³ï¼Œä½†æˆ‘ä»¬ä¸ä¼šå¯¹ææ…Œè¿›è¡Œå †æ ˆå±•å¼€ï¼Œå®ƒä»¬ä¼šå ç”¨é—ªå­˜ä¸­çš„ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬åªæ˜¯å°†å®ƒä»¬ä¸¢å¼ƒã€‚</p>
<h2 id="æŠŠè¿™ä¸€åˆ‡æ”¾åœ¨ä¸€èµ·"><a href="#æŠŠè¿™ä¸€åˆ‡æ”¾åœ¨ä¸€èµ·" class="headerlink" title="æŠŠè¿™ä¸€åˆ‡æ”¾åœ¨ä¸€èµ·"></a>æŠŠè¿™ä¸€åˆ‡æ”¾åœ¨ä¸€èµ·</h2><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é“¾æ¥åº”ç”¨ç¨‹åºã€‚ä½œä¸ºå‚è€ƒï¼Œè¿™é‡Œæ˜¯å®Œæ•´çš„ Rust ç¨‹åºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>panic<span class="token punctuation">:</span><span class="token punctuation">:</span>PanicInfo<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// The reset handler</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// can't return so we go into an infinite loop here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// The reset vector, a pointer into the reset handler</span>
#<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".vector_table.reset_vector"</span><span class="token punctuation">]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">static</span> RESET_VECTOR<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token operator">=</span> Reset<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[panic_handler]</span>
<span class="token keyword">fn</span> <span class="token function">panic</span><span class="token punctuation">(</span>_panic<span class="token punctuation">:</span> <span class="token operator">&amp;</span>PanicInfo<span class="token operator">&lt;</span>'_<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¿…é¡»è°ƒæ•´é“¾æ¥å™¨è¿›ç¨‹ä»¥ä½¿å…¶ä½¿ç”¨æˆ‘ä»¬çš„é“¾æ¥å™¨è„šæœ¬ã€‚è¿™æ˜¯é€šè¿‡å°†<code>-C link-arg</code>æ ‡å¿—ä¼ é€’ç»™<code>rustc</code>. è¿™å¯ä»¥é€šè¿‡<code>cargo-rustc</code>æˆ– æ¥å®Œæˆ<code>cargo-build</code>ã€‚</p>
<p><strong>é‡è¦æç¤º</strong>ï¼š<code>.cargo/config</code>åœ¨è¿è¡Œæ­¤å‘½ä»¤ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨æ‹¥æœ‰åœ¨æœ€åä¸€èŠ‚æœ«å°¾æ·»åŠ çš„æ–‡ä»¶ã€‚</p>
<p>ä½¿ç”¨<code>cargo-rustc</code>å­å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo rustc -- -C link-arg=-Tlink.x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ–è€…æ‚¨å¯ä»¥è®¾ç½® rustflags<code>.cargo/config</code>å¹¶ç»§ç»­ä½¿ç”¨ <code>cargo-build</code>å­å‘½ä»¤ã€‚æˆ‘ä»¬ä¼šåšåè€…ï¼Œå› ä¸ºå®ƒå¯ä»¥æ›´å¥½åœ°ä¸ <code>cargo-binutils</code>.</p>
<pre class="line-numbers language-console"><code class="language-console"># modify .cargo/config so it has these contents
$ cat .cargo/config
[target.thumbv7m-none-eabi]
rustflags = ["-C", "link-arg=-Tlink.x"]

[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>[target.thumbv7m-none-eabi]</code>éƒ¨åˆ†è¡¨ç¤ºè¿™äº›æ ‡å¿—ä»…åœ¨äº¤å‰ç¼–è¯‘åˆ°è¯¥ç›®æ ‡æ—¶æ‰ä¼šä½¿ç”¨ã€‚</p>
<h2 id="æ£€æŸ¥å®ƒ"><a href="#æ£€æŸ¥å®ƒ" class="headerlink" title="æ£€æŸ¥å®ƒ"></a>æ£€æŸ¥å®ƒ</h2><p>ç°åœ¨è®©æˆ‘ä»¬æ£€æŸ¥è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä»¥ç¡®è®¤å†…å­˜å¸ƒå±€çœ‹èµ·æ¥åƒæˆ‘ä»¬æƒ³è¦çš„é‚£æ ·ï¼ˆè¿™éœ€è¦<a href="https://github.com/rust-embedded/cargo-binutils#readme" target="_blank" rel="noopener"><code>cargo-binutils</code></a>ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -d -no-show-raw-insn
app:    file format elf32-littlearm


Disassembly of section .text:

<Reset>:
                   sub    sp, #4
                   movs    r0, #42
                   str    r0, [sp]
                   b    #-2 <Reset+0x8>
                   b    #-4 <Reset+0x8><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯è¯¥<code>.text</code>éƒ¨åˆ†çš„æ‹†è§£ã€‚æˆ‘ä»¬çœ‹åˆ°åä¸º çš„é‡ç½®å¤„ç†ç¨‹åº<code>Reset</code>ä½äº address <code>0x8</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -s -section .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 09000000                    ... ....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¾ç¤ºäº†è¯¥<code>.vector_table</code>éƒ¨åˆ†çš„å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥éƒ¨åˆ†ä»åœ°å€å¼€å§‹ï¼Œ<code>0x0</code>å¹¶ä¸”è¯¥éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå­—æ˜¯<code>0x2001_0000</code>ï¼ˆ<code>objdump</code>è¾“å‡ºä¸ºå°ç«¯æ ¼å¼ï¼‰ã€‚è¿™æ˜¯åˆå§‹ SP å€¼å¹¶åŒ¹é… RAM çš„ç»“æŸåœ°å€ã€‚ç¬¬äºŒä¸ªå­—æ˜¯<code>0x9</code>; è¿™æ˜¯é‡ç½®å¤„ç†ç¨‹åºçš„<em>æ‹‡æŒ‡æ¨¡å¼</em>åœ°å€ã€‚å½“è¦åœ¨æ‹‡æŒ‡æ¨¡å¼ä¸‹æ‰§è¡ŒåŠŸèƒ½æ—¶ï¼Œå…¶åœ°å€çš„ç¬¬ä¸€ä½è®¾ç½®ä¸º 1ã€‚</p>
<h2 id="æµ‹è¯•å®ƒ"><a href="#æµ‹è¯•å®ƒ" class="headerlink" title="æµ‹è¯•å®ƒ"></a>æµ‹è¯•å®ƒ</h2><p>è¯¥ç¨‹åºæ˜¯æœ‰æ•ˆçš„LM3S6965ç¨‹åºï¼›æˆ‘ä»¬å¯ä»¥åœ¨è™šæ‹Ÿå¾®æ§åˆ¶å™¨ (QEMU) ä¸­æ‰§è¡Œå®ƒæ¥æµ‹è¯•å®ƒã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # this program will block
$ qemu-system-arm \
      -cpu cortex-m3 \
      -machine lm3s6965evb \
      -gdb tcp::3333 \
      -S \
      -nographic \
      -kernel target/thumbv7m-none-eabi/debug/app
$ # on a different terminal
$ arm-none-eabi-gdb -q target/thumbv7m-none-eabi/debug/app
Reading symbols from target/thumbv7m-none-eabi/debug/app...done.

(gdb) target remote :3333
Remote debugging using :3333
Reset () at src/main.rs:8
8       pub unsafe extern "C" fn Reset() -> ! {

(gdb) # the SP has the initial value we programmed in the vector table
(gdb) print/x $sp
$1 = 0x20010000

(gdb) step
9           let _x = 42;

(gdb) step
12          loop {}

(gdb) # next we inspect the stack variable `_x`
(gdb) print _x
$2 = 42

(gdb) print &_x
$3 = (i32 *) 0x2000fffc

(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="A-main-interface"><a href="#A-main-interface" class="headerlink" title="A main interface"></a>A <code>main</code> interface</h1><p>æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªæœ€å°çš„å·¥ä½œç¨‹åºï¼Œä½†æˆ‘ä»¬éœ€è¦ä»¥æœ€ç»ˆç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸Šæ„å»ºå®‰å…¨ç¨‹åºçš„æ–¹å¼å¯¹å…¶è¿›è¡Œæ‰“åŒ…ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ª<code>main</code>ç±»ä¼¼äºæ ‡å‡† Rust ç¨‹åºä½¿ç”¨çš„æ¥å£ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†äºŒè¿›åˆ¶ crate è½¬æ¢ä¸º library crateï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ mv src/main.rs src/lib.rs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç„¶åå°†å…¶é‡å‘½åä¸º<code>rt</code>ä»£è¡¨â€œè¿è¡Œæ—¶â€çš„åç§°ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -i s/app/rt/ Cargo.toml

$ head -n4 Cargo.toml
[package]
edition = "2018"
name = "rt" # <-
version = "0.1.0"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¬¬ä¸€ä¸ªæ›´æ”¹æ˜¯è®©é‡ç½®å¤„ç†ç¨‹åºè°ƒç”¨å¤–éƒ¨<code>main</code>å‡½æ•°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ head -n13 src/lib.rs
#![no_std]

use core::panic::PanicInfo;

// CHANGED!
#[no_mangle]
pub unsafe extern "C" fn Reset() -> ! {
    extern "Rust" {
        fn main() -> !;
    }

    main()
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿˜åˆ é™¤äº†è¯¥<code>#![no_main]</code>å±æ€§ï¼Œå› ä¸ºå®ƒå¯¹åº“ç®±æ²¡æœ‰å½±å“ã€‚</p>
<blockquote>
<p>æœ‰è¿™ä¹ˆå‡ºç°åœ¨è¿™ä¸ªé˜¶æ®µæ­£äº¤é—®é¢˜ï¼šå¦‚è‹¥<code>rt</code> åº“æä¾›äº†ä¸€ä¸ªæ ‡å‡†ææ…Œè¡Œä¸ºï¼Œè¿˜æ˜¯åº”è¯¥<em>ä¸æ˜¯</em>æä¾›ä¸€ä¸ª <code>#[panic_handler]</code>åŠŸèƒ½ï¼Œè®©æœ€ç»ˆç”¨æˆ·é€‰æ‹©ææ…Œè¡Œä¸ºï¼Ÿæœ¬æ–‡æ¡£ä¸ä¼šæ·±å…¥ç ”ç©¶è¯¥é—®é¢˜ï¼Œå¹¶ä¸”ä¸ºç®€å•èµ·è§ï¼Œå°†<code>#[panic_handler]</code>åœ¨<code>rt</code>crate ä¸­ä¿ç•™è™šæ‹Ÿå‡½æ•°ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æƒ³é€šçŸ¥è¯»è€…è¿˜æœ‰å…¶ä»–é€‰æ‹©ã€‚</p>
</blockquote>
<p>ç¬¬äºŒä¸ªæ›´æ”¹æ¶‰åŠå°†æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„é“¾æ¥æè¿°æ–‡ä»¶æä¾›ç»™åº”ç”¨ç¨‹åºåŒ…ã€‚é“¾æ¥å™¨å°†åœ¨åº“æœç´¢è·¯å¾„ ( <code>-L</code>) å’Œè°ƒç”¨å®ƒçš„ç›®å½•ä¸­æœç´¢é“¾æ¥å™¨è„šæœ¬ã€‚åº”ç”¨ç¨‹åºåŒ…ä¸éœ€è¦æºå¸¦ çš„å‰¯æœ¬ï¼Œ<code>link.x</code>å› æ­¤æˆ‘ä»¬å°†<code>rt</code>ä½¿ç”¨<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">æ„å»ºè„šæœ¬</a>å°†é“¾æ¥å™¨è„šæœ¬æ”¾åœ¨åº“æœç´¢è·¯å¾„ä¸­ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # create a build.rs file in the root of `rt` with these contents
$ cat build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œç”¨æˆ·å¯ä»¥ç¼–å†™ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¥å…¬å¼€<code>main</code>ç¬¦å·å¹¶å°†å…¶é“¾æ¥åˆ°<code>rt</code>crateã€‚åœ¨<code>rt</code>å°†ç»™äºˆè¯¥èŠ‚ç›®å†…å­˜å¸ƒå±€æŠ¤ç†ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cd ..

$ cargo new --edition 2018 --bin app

$ cd app

$ # modify Cargo.toml to include the `rt` crate as a dependency
$ tail -n2 Cargo.toml
[dependencies]
rt = { path = "../rt" }
$ # copy over the config file that sets a default target and tweaks the linker invocation
$ cp -r ../rt/.cargo .

$ # change the contents of `main.rs` to
$ cat src/main.rs
#![no_std]
#![no_main]

extern crate rt;

#[no_mangle]
pub fn main() -> ! {
    let _x = 42;

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åæ±‡ç¼–å°†ç±»ä¼¼ï¼Œä½†ç°åœ¨å°†åŒ…æ‹¬ç”¨æˆ·<code>main</code>åŠŸèƒ½ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -d -no-show-raw-insn
app:    file format elf32-littlearm


Disassembly of section .text:

<main>:
                   sub    sp, #4
                   movs    r0, #42
                   str    r0, [sp]
                   b    #-2 <main+0x8>
                   b    #-4 <main+0x8>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-18
                   trap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ä½¿å…¶ç±»å‹å®‰å…¨"><a href="#ä½¿å…¶ç±»å‹å®‰å…¨" class="headerlink" title="ä½¿å…¶ç±»å‹å®‰å…¨"></a>ä½¿å…¶ç±»å‹å®‰å…¨</h2><p>è¯¥<code>main</code>æ¥å£çš„å·¥ä½œåŸç†ï¼Œä½†å®ƒå¾ˆå®¹æ˜“ç†è§£é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯ä»¥ç¼–å†™<code>main</code> ä¸ºéå‘æ•£å‡½æ•°ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°ç¼–è¯‘æ—¶é”™è¯¯å’Œæœªå®šä¹‰çš„è¡Œä¸ºï¼ˆç¼–è¯‘å™¨ä¼šé”™è¯¯ä¼˜åŒ–ç¨‹åºï¼‰ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ç”¨æˆ·å…¬å¼€å®è€Œä¸æ˜¯ç¬¦å·æ¥å£æ¥æ·»åŠ ç±»å‹å®‰å…¨æ€§ã€‚åœ¨ <code>rt</code>crate ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™è¿™ä¸ªå®ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n12 ../rt/src/lib.rs
#[macro_export]
macro_rules! entry {
    ($path:path) => {
        #[export_name = "main"]
        pub unsafe fn __main() -> ! {
            // type check the given path
            let f: fn() -> ! = $path;

            f()
        }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶ååº”ç”¨ç¨‹åºç¼–å†™è€…å¯ä»¥åƒè¿™æ ·è°ƒç”¨å®ƒï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_std]
#![no_main]

use rt::entry;

entry!(main);

fn main() -> ! {
    let _x = 42;

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œå¦‚æœä½œè€…å°† çš„ç­¾åæ›´æ”¹<code>main</code>ä¸ºéå‘æ•£å‡½æ•°ï¼Œä¾‹å¦‚<code>fn()</code>.</p>
<h2 id="ä¸»çº¿å‰çš„ç”Ÿæ´»"><a href="#ä¸»çº¿å‰çš„ç”Ÿæ´»" class="headerlink" title="ä¸»çº¿å‰çš„ç”Ÿæ´»"></a>ä¸»çº¿å‰çš„ç”Ÿæ´»</h2><p><code>rt</code>çœ‹èµ·æ¥ä¸é”™ï¼Œä½†åŠŸèƒ½ä¸å®Œæ•´ï¼é’ˆå¯¹å®ƒç¼–å†™çš„åº”ç”¨ç¨‹åºä¸èƒ½ä½¿ç”¨ <code>static</code>å˜é‡æˆ–å­—ç¬¦ä¸²æ–‡å­—ï¼Œå› ä¸º<code>rt</code>çš„é“¾æ¥å™¨è„šæœ¬æ²¡æœ‰å®šä¹‰æ ‡å‡†çš„ <code>.bss</code>,<code>.data</code>å’Œ<code>.rodata</code>éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼</p>
<p>ç¬¬ä¸€æ­¥æ˜¯åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­å®šä¹‰è¿™äº›éƒ¨åˆ†ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,46p ../rt/link.x
  .text :
  {
    *(.text .text.*);
  } > FLASH

  /* NEW! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } > FLASH

  .bss :
  {
    *(.bss .bss.*);
  } > RAM

  .data :
  {
    *(.data .data.*);
  } > RAM

  /DISCARD/ :<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»–ä»¬åªæ˜¯é‡æ–°å¯¼å‡ºè¾“å…¥éƒ¨åˆ†å¹¶æŒ‡å®šæ¯ä¸ªè¾“å‡ºéƒ¨åˆ†å°†ä½äºå“ªä¸ªå†…å­˜åŒºåŸŸã€‚</p>
<p>é€šè¿‡è¿™äº›æ›´æ”¹ï¼Œå°†ç¼–è¯‘ä»¥ä¸‹ç¨‹åºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> RODATA<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">b"Hello, world!"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> BSS<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> DATA<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> RODATA<span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span>BSS <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _z <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span>DATA <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨çœŸå®ç¡¬ä»¶ä¸Šè¿è¡Œæ­¤ç¨‹åºå¹¶å¯¹å…¶è¿›è¡Œè°ƒè¯•ï¼Œæ‚¨å°†è§‚å¯Ÿåˆ°<code>static</code> å˜é‡<code>BSS</code>å’Œ<code>DATA</code>æ²¡æœ‰å€¼<code>0</code>å¹¶ä¸”<code>1</code>åˆ°äº†æ—¶é—´<code>main</code>ã€‚ç›¸åï¼Œè¿™äº›å˜é‡å°†å…·æœ‰åƒåœ¾å€¼ã€‚é—®é¢˜æ˜¯åœ¨è®¾å¤‡ä¸Šç”µå RAM çš„å†…å®¹æ˜¯éšæœºçš„ã€‚å¦‚æœæ‚¨åœ¨ QEMU ä¸­è¿è¡Œç¨‹åºï¼Œæ‚¨å°†æ— æ³•è§‚å¯Ÿåˆ°è¿™ç§æ•ˆæœã€‚</p>
<p>äº‹å®ä¸Šï¼Œå¦‚æœæ‚¨çš„ç¨‹åº<code>static</code>åœ¨æ‰§è¡Œå†™å…¥ä¹‹å‰è¯»å–ä»»ä½•å˜é‡ï¼Œé‚£ä¹ˆæ‚¨çš„ç¨‹åºå…·æœ‰æœªå®šä¹‰çš„è¡Œä¸ºã€‚è®©æˆ‘ä»¬é€šè¿‡<code>static</code>åœ¨è°ƒç”¨ä¹‹å‰åˆå§‹åŒ–æ‰€æœ‰å˜é‡æ¥è§£å†³è¿™ä¸ªé—®é¢˜<code>main</code>ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ç¨å¾®è°ƒæ•´é“¾æ¥å™¨è„šæœ¬ä»¥è¿›è¡Œ RAM åˆå§‹åŒ–ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,52p ../rt/link.x
  .text :
  {
    *(.text .text.*);
  } > FLASH

  /* CHANGED! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } > FLASH

  .bss :
  {
    _sbss = .;
    *(.bss .bss.*);
    _ebss = .;
  } > RAM

  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
  {
    _sdata = .;
    *(.data .data.*);
    _edata = .;
  } > RAM

  _sidata = LOADADDR(.data);

  /DISCARD/ :<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›å˜åŒ–çš„ç»†èŠ‚ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">    _sbss = .;
    _ebss = .;
    _sdata = .;
    _edata = .;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ç¬¦å·ä¸<code>.bss</code>å’Œ<code>.data</code>èŠ‚çš„å¼€å§‹å’Œç»“æŸåœ°å€ç›¸å…³è”ï¼Œç¨åæˆ‘ä»¬å°†åœ¨ Rust ä»£ç ä¸­ä½¿ç”¨å®ƒä»¬ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†èŠ‚çš„åŠ è½½å†…å­˜åœ°å€ (LMA) è®¾ç½®ä¸º<code>.data</code>èŠ‚çš„æœ«å°¾<code>.rodata</code> ã€‚è¯¥<code>.data</code>åŒ…å«<code>static</code>å…·æœ‰éé›¶åˆå§‹å€¼å˜é‡; è¯¥éƒ¨åˆ†çš„è™šæ‹Ÿå†…å­˜åœ°å€ (VMA)<code>.data</code>ä½äº RAM ä¸­çš„æŸä¸ªä½ç½®â€”â€”è¿™æ˜¯<code>static</code>å˜é‡æ‰€åœ¨çš„ä½ç½®ã€‚<code>static</code>ä½†æ˜¯ï¼Œè¿™äº›å˜é‡çš„åˆå§‹å€¼å¿…é¡»åˆ†é…åœ¨éæ˜“å¤±æ€§å­˜å‚¨å™¨ (Flash) ä¸­ï¼›LMA æ˜¯é—ªå­˜ä¸­å­˜å‚¨è¿™äº›åˆå§‹å€¼çš„ä½ç½®ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">  _sidata = LOADADDR(.data);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªç¬¦å·ä¸ çš„ LMA ç›¸å…³è”<code>.data</code>ã€‚</p>
<p>åœ¨ Rust æ–¹é¢ï¼Œæˆ‘ä»¬å°†<code>.bss</code>éƒ¨åˆ†å½’é›¶å¹¶åˆå§‹åŒ–<code>.data</code>éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥ä» Rust ä»£ç ä¸­å¼•ç”¨æˆ‘ä»¬åœ¨é“¾æ¥æè¿°æ–‡ä»¶ä¸­åˆ›å»ºçš„ç¬¦å·ã€‚è¿™äº›ç¬¦å·çš„<em>åœ°å€</em><a href="https://docs.rust-embedded.org/embedonomicon/main.html#1" target="_blank" rel="noopener">1</a>æ˜¯<code>.bss</code>å’Œ<code>.data</code>æ®µçš„è¾¹ç•Œã€‚</p>
<p>æ›´æ–°åçš„é‡ç½®å¤„ç†ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ head -n32 ../rt/src/lib.rs
#![no_std]

use core::panic::PanicInfo;
use core::ptr;

#[no_mangle]
pub unsafe extern "C" fn Reset() -> ! {
    // NEW!
    // Initialize RAM
    extern "C" {
        static mut _sbss: u8;
        static mut _ebss: u8;

        static mut _sdata: u8;
        static mut _edata: u8;
        static _sidata: u8;
    }

    let count = &_ebss as *const u8 as usize - &_sbss as *const u8 as usize;
    ptr::write_bytes(&mut _sbss as *mut u8, 0, count);

    let count = &_edata as *const u8 as usize - &_sdata as *const u8 as usize;
    ptr::copy_nonoverlapping(&_sidata as *const u8, &mut _sdata as *mut u8, count);

    // Call user entry point
    extern "Rust" {
        fn main() -> !;
    }

    main()
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æœ€ç»ˆç”¨æˆ·å¯ä»¥ç›´æ¥æˆ–é—´æ¥åœ°ä½¿ç”¨<code>static</code>å˜é‡è€Œä¸ä¼šé‡åˆ°æœªå®šä¹‰çš„è¡Œä¸ºï¼</p>
<blockquote>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»¥å­—èŠ‚æ–¹å¼æ‰§è¡Œäº†å†…å­˜åˆå§‹åŒ–ã€‚å¯ä»¥å¼ºåˆ¶å°†<code>.bss</code>å’Œ<code>.data</code>éƒ¨åˆ†å¯¹é½åˆ° 4 ä¸ªå­—èŠ‚ã€‚ç„¶åå¯ä»¥åœ¨ Rust ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªäº‹å®æ¥æ‰§è¡Œé€å­—åˆå§‹åŒ–ï¼ŒåŒæ—¶çœç•¥å¯¹é½æ£€æŸ¥ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£äº†è§£å¦‚ä½•å®ç°è¿™ä¸€ç‚¹ï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/japaric/cortex-m-rt/tree/v0.5.1" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>æ¿æ¡ç®±ã€‚</p>
</blockquote>
<h1 id="Exception-handling"><a href="#Exception-handling" class="headerlink" title="Exception handling"></a>Exception handling</h1><p>åœ¨â€œå†…å­˜å¸ƒå±€â€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å†³å®šä»ç®€å•å¼€å§‹ï¼Œå¿½ç•¥å¼‚å¸¸å¤„ç†ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ å¯¹å¤„ç†å®ƒä»¬çš„æ”¯æŒï¼›è¿™æ˜¯å¦‚ä½•åœ¨ç¨³å®šçš„ Rust ä¸­å®ç°ç¼–è¯‘æ—¶å¯è¦†ç›–è¡Œä¸ºçš„ç¤ºä¾‹ï¼ˆå³ä¸ä¾èµ–ä¸ç¨³å®šçš„<code>#[linkage = "weak"]</code>å±æ€§ï¼Œè¿™ä¼šä½¿ç¬¦å·å˜å¼±ï¼‰ã€‚</p>
<h2 id="èƒŒæ™¯èµ„æ–™-1"><a href="#èƒŒæ™¯èµ„æ–™-1" class="headerlink" title="èƒŒæ™¯èµ„æ–™"></a>èƒŒæ™¯èµ„æ–™</h2><p>ç®€è€Œè¨€ä¹‹ï¼Œ<em>å¼‚å¸¸</em>æ˜¯ Cortex-M å’Œå…¶ä»–æ¶æ„æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºè®©åº”ç”¨ç¨‹åºå“åº”å¼‚æ­¥äº‹ä»¶ï¼Œé€šå¸¸æ˜¯å¤–éƒ¨äº‹ä»¶ã€‚å¤§å¤šæ•°äººéƒ½çŸ¥é“çš„æœ€çªå‡ºçš„å¼‚å¸¸ç±»å‹æ˜¯ç»å…¸ï¼ˆç¡¬ä»¶ï¼‰ä¸­æ–­ã€‚</p>
<p>Cortex-M å¼‚å¸¸æœºåˆ¶çš„å·¥ä½œåŸç†æ˜¯è¿™æ ·çš„ï¼šå½“å¤„ç†å™¨æ¥æ”¶åˆ°ä¸æŸç§å¼‚å¸¸ç›¸å…³çš„ä¿¡å·æˆ–äº‹ä»¶æ—¶ï¼Œå®ƒä¼šæš‚åœå½“å‰å­ç¨‹åºçš„æ‰§è¡Œï¼ˆé€šè¿‡å°†çŠ¶æ€å­˜å‚¨åœ¨è°ƒç”¨å †æ ˆä¸­ï¼‰ï¼Œç„¶åç»§ç»­æ‰§è¡Œç›¸åº”çš„å­ç¨‹åºå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¦ä¸€ä¸ªå­ç¨‹åºï¼Œåœ¨ä¸€ä¸ªæ–°çš„å †æ ˆå¸§ä¸­ã€‚åœ¨å®Œæˆå¼‚å¸¸å¤„ç†ç¨‹åºçš„æ‰§è¡Œï¼ˆå³ä»å®ƒè¿”å›ï¼‰åï¼Œå¤„ç†å™¨æ¢å¤æ‰§è¡ŒæŒ‚èµ·çš„å­ç¨‹åºã€‚</p>
<p>å¤„ç†å™¨ä½¿ç”¨å‘é‡è¡¨æ¥å†³å®šè¦æ‰§è¡Œçš„å¤„ç†ç¨‹åºã€‚è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘å¤„ç†ç¨‹åºçš„æŒ‡é’ˆï¼Œæ¯ä¸ªæ¡ç›®å¯¹åº”ä¸åŒçš„å¼‚å¸¸ç±»å‹ã€‚ä¾‹å¦‚ï¼Œç¬¬äºŒä¸ªæ¡ç›®æ˜¯é‡ç½®å¤„ç†ç¨‹åºï¼Œç¬¬ä¸‰ä¸ªæ¡ç›®æ˜¯ NMIï¼ˆä¸å¯å±è”½ä¸­æ–­ï¼‰å¤„ç†ç¨‹åºï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œå¤„ç†å™¨æœŸæœ›å‘é‡è¡¨ä½äºå†…å­˜ä¸­çš„æŸä¸ªç‰¹å®šä½ç½®ï¼Œå¹¶ä¸”å…¶ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½å¯èƒ½åœ¨è¿è¡Œæ—¶è¢«å¤„ç†å™¨ä½¿ç”¨ã€‚å› æ­¤ï¼Œæ¡ç›®å¿…é¡»å§‹ç»ˆåŒ…å«æœ‰æ•ˆå€¼ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›<code>rt</code>crate æ˜¯çµæ´»çš„ï¼Œä»¥ä¾¿æœ€ç»ˆç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ¯ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºçš„è¡Œä¸ºã€‚æœ€åï¼Œå‘é‡è¡¨é©»ç•™åœ¨åªè¯»å†…å­˜ä¸­ï¼Œæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´æ˜¯åœ¨ä¸å®¹æ˜“ä¿®æ”¹çš„å†…å­˜ä¸­ï¼Œå› æ­¤ç”¨æˆ·å¿…é¡»é™æ€æ³¨å†Œå¤„ç†ç¨‹åºï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ã€‚</p>
<p>ä¸ºäº†æ»¡è¶³æ‰€æœ‰è¿™äº›çº¦æŸï¼Œæˆ‘ä»¬å°†ä¸ºcrate ä¸­å‘é‡è¡¨çš„æ‰€æœ‰æ¡ç›®åˆ†é…ä¸€ä¸ª<em>é»˜è®¤</em>å€¼<code>rt</code>ï¼Œä½†ä½¿è¿™äº›å€¼æœ‰ç‚¹<em>å¼±ï¼Œ</em>ä»¥ä¾¿æœ€ç»ˆç”¨æˆ·åœ¨ç¼–è¯‘æ—¶è¦†ç›–å®ƒä»¬ã€‚</p>
<h2 id="Rust-side"><a href="#Rust-side" class="headerlink" title="Rust side"></a>Rust side</h2><p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°æ‰€æœ‰è¿™äº›ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åªå¤„ç†å‘é‡è¡¨çš„å‰ 16 ä¸ªæ¡ç›®ï¼›è¿™äº›æ¡ç›®ä¸æ˜¯ç‰¹å®šäºè®¾å¤‡çš„ï¼Œå› æ­¤å®ƒä»¬åœ¨ä»»ä½•ç±»å‹çš„ Cortex-M å¾®æ§åˆ¶å™¨ä¸Šéƒ½å…·æœ‰ç›¸åŒçš„åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åœ¨<code>rt</code>crate çš„ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªå‘é‡æ•°ç»„ï¼ˆæŒ‡å‘å¼‚å¸¸å¤„ç†ç¨‹åºçš„æŒ‡é’ˆï¼‰ ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -n 56,91p ../rt/src/lib.rs
pub union Vector {
    reserved: u32,
    handler: unsafe extern "C" fn(),
}

extern "C" {
    fn NMI();
    fn HardFault();
    fn MemManage();
    fn BusFault();
    fn UsageFault();
    fn SVCall();
    fn PendSV();
    fn SysTick();
}

#[link_section = ".vector_table.exceptions"]
#[no_mangle]
pub static EXCEPTIONS: [Vector; 14] = [
    Vector { handler: NMI },
    Vector { handler: HardFault },
    Vector { handler: MemManage },
    Vector { handler: BusFault },
    Vector {
        handler: UsageFault,
    },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: SVCall },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: PendSV },
    Vector { handler: SysTick },
];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘é‡è¡¨ä¸­çš„ä¸€äº›æ¡ç›®æ˜¯<em>ä¿ç•™çš„</em>ï¼›ARM æ–‡æ¡£æŒ‡å‡ºåº”è¯¥ä¸ºå®ƒä»¬åˆ†é…å€¼ï¼Œ<code>0</code>å› æ­¤æˆ‘ä»¬ä½¿ç”¨è”åˆæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚å¿…é¡»æŒ‡å‘å¤„ç†ç¨‹åºçš„æ¡ç›®ä½¿ç”¨<em>å¤–éƒ¨</em>å‡½æ•°ï¼›è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒè®©æœ€ç»ˆç”¨æˆ· <em>æä¾›</em>å®é™…çš„å‡½æ•°å®šä¹‰ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ Rust ä»£ç ä¸­å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚æœ€ç»ˆç”¨æˆ·æœªåˆ†é…å¤„ç†ç¨‹åºçš„å¼‚å¸¸å°†ä½¿ç”¨æ­¤é»˜è®¤å¤„ç†ç¨‹åºã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n4 ../rt/src/lib.rs
#[no_mangle]
pub extern "C" fn DefaultExceptionHandler() {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="é“¾æ¥å™¨è„šæœ¬ç«¯-1"><a href="#é“¾æ¥å™¨è„šæœ¬ç«¯-1" class="headerlink" title="é“¾æ¥å™¨è„šæœ¬ç«¯"></a>é“¾æ¥å™¨è„šæœ¬ç«¯</h2><p>åœ¨é“¾æ¥æè¿°æ–‡ä»¶ç«¯ï¼Œæˆ‘ä»¬å°†è¿™äº›æ–°çš„å¼‚å¸¸å‘é‡æ”¾åœ¨é‡ç½®å‘é‡ä¹‹åã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -n 12,25p ../rt/link.x
EXTERN(RESET_VECTOR);
EXTERN(EXCEPTIONS); /* <- NEW */

SECTIONS
{
  .vector_table ORIGIN(FLASH) :
  {
    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));

    /* The next 14 entries are exception vectors */
    KEEP(*(.vector_table.exceptions)); /* <- NEW */
  } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç”¨æ¥<code>PROVIDE</code>ä¸ºæˆ‘ä»¬åœ¨<code>rt</code>ï¼ˆ<code>NMI</code> å’Œä¸Šé¢çš„å…¶ä»–äººï¼‰ä¸­æœªå®šä¹‰çš„å¤„ç†ç¨‹åºæä¾›é»˜è®¤å€¼ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n8 ../rt/link.x
PROVIDE(NMI = DefaultExceptionHandler);
PROVIDE(HardFault = DefaultExceptionHandler);
PROVIDE(MemManage = DefaultExceptionHandler);
PROVIDE(BusFault = DefaultExceptionHandler);
PROVIDE(UsageFault = DefaultExceptionHandler);
PROVIDE(SVCall = DefaultExceptionHandler);
PROVIDE(PendSV = DefaultExceptionHandler);
PROVIDE(SysTick = DefaultExceptionHandler);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>PROVIDE</code>ä»…å½“æ£€æŸ¥æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶åç­‰å·å·¦ä¾§çš„ç¬¦å·ä»æœªå®šä¹‰æ—¶æ‰ç”Ÿæ•ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ²¡æœ‰ä¸ºç›¸åº”çš„å¼‚å¸¸å®ç°å¤„ç†ç¨‹åºã€‚</p>
<h2 id="æµ‹è¯•å®ƒ-1"><a href="#æµ‹è¯•å®ƒ-1" class="headerlink" title="æµ‹è¯•å®ƒ"></a>æµ‹è¯•å®ƒ</h2><p>å°±æ˜¯è¿™æ ·ï¼è¯¥<code>rt</code>ç®±å­ç°åœ¨æœ‰å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ”¯æŒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹åº”ç”¨ç¨‹åºå¯¹å…¶è¿›è¡Œæµ‹è¯•ï¼š</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šäº‹å®è¯æ˜åœ¨ QEMU ä¸­å¾ˆéš¾äº§ç”Ÿå¼‚å¸¸ã€‚åœ¨çœŸå®ç¡¬ä»¶ä¸Šï¼Œè¯»å–æ— æ•ˆçš„å†…å­˜åœ°å€ï¼ˆå³åœ¨ Flash å’Œ RAM åŒºåŸŸä¹‹å¤–ï¼‰å°±è¶³å¤Ÿäº†ï¼Œä½† QEMU å¾ˆä¹æ„æ¥å—è¯¥æ“ä½œå¹¶è¿”å›é›¶ã€‚é™·é˜±æŒ‡ä»¤é€‚ç”¨äº QEMU å’Œç¡¬ä»¶ï¼Œä½†ä¸å¹¸çš„æ˜¯å®ƒåœ¨ç¨³å®šç‰ˆä¸Šä¸å¯ç”¨ï¼Œå› æ­¤æ‚¨å¿…é¡»æš‚æ—¶åˆ‡æ¢åˆ° nightly æ‰èƒ½è¿è¡Œæ­¤ç¤ºä¾‹å’Œä¸‹ä¸€ä¸ªç¤ºä¾‹ã€‚</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(core_intrinsics)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>intrinsics<span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// this executes the undefined instruction (UDF) and causes a HardFault exception</span>
    intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> target remote <span class="token punctuation">:</span><span class="token number">3333</span>
Remote debugging using <span class="token punctuation">:</span><span class="token number">3333</span>
<span class="token function">Reset</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">7</span>
<span class="token number">7</span>       <span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b DefaultExceptionHandler
Breakpoint <span class="token number">1</span> at <span class="token number">0xec</span><span class="token punctuation">:</span> file <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">,</span> line <span class="token number">95</span><span class="token punctuation">.</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token keyword">continue</span>
Continuing<span class="token punctuation">.</span>

Breakpoint <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">DefaultExceptionHandler</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    at <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">95</span>
<span class="token number">95</span>          <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> list
<span class="token number">90</span>          Vector <span class="token punctuation">{</span> handler<span class="token punctuation">:</span> SysTick <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">91</span>      <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">92</span>
<span class="token number">93</span>      <span class="token attribute attr-name">#[no_mangle]</span>
<span class="token number">94</span>      <span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">DefaultExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">95</span>          <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token number">96</span>      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†å®Œæ•´èµ·è§ï¼Œè¿™é‡Œæ˜¯ç¨‹åºä¼˜åŒ–ç‰ˆæœ¬çš„åæ±‡ç¼–ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<main>:
                   trap
                   trap

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   movw    r1, #0x0
                   movw    r0, #0x0
                   movt    r1, #0x2000
                   movt    r0, #0x2000
                   subs    r1, r1, r0
                   bl    #0x34
                   movw    r1, #0x0
                   movw    r0, #0x0
                   movt    r1, #0x2000
                   movt    r0, #0x2000
                   subs    r2, r1, r0
                   movw    r1, #0x16c
                   movt    r1, #0x0
                   bl    #0x8
                   bl    #-0x40
                   trap
$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 83000000 83000000  ... E...........
 0010 83000000 83000000 83000000 00000000  ................
 0020 00000000 00000000 00000000 83000000  ................
 0030 00000000 00000000 83000000 83000000  ................<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘é‡è¡¨ç°åœ¨ç±»ä¼¼äºæœ¬ä¹¦è¿„ä»Šä¸ºæ­¢æ‰€æœ‰ä»£ç ç‰‡æ®µçš„ç»“æœã€‚æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li><p>åœ¨å‰é¢å†…å­˜ç« èŠ‚çš„</p>
<p><em>æ£€æŸ¥</em></p>
<p>éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼š</p>
<ul>
<li><p>å‘é‡è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ¡ç›®åŒ…å«å †æ ˆæŒ‡é’ˆçš„åˆå§‹å€¼ã€‚</p>
</li>
<li><p>Objdump ä»¥<code>little endian</code>æ ¼å¼æ‰“å°ï¼Œå› æ­¤å †æ ˆä» <code>0x2001_0000</code>.</p>
</li>
<li><p>ç¬¬äºŒä¸ªå…¥å£æŒ‡å‘ address </p>
<pre><code>0x0000_0045</code></pre><p>ï¼Œå³é‡ç½®å¤„ç†ç¨‹åºã€‚</p>
<ul>
<li>é‡ç½®å¤„ç†ç¨‹åºçš„åœ°å€å¯ä»¥åœ¨ä¸Šé¢çš„åæ±‡ç¼–ä¸­çœ‹åˆ°ï¼Œæ˜¯<code>0x44</code>.</li>
<li>ç”±äºå¯¹é½è¦æ±‚ï¼Œè®¾ç½®ä¸º 1 çš„ç¬¬ä¸€ä½ä¸ä¼šæ”¹å˜åœ°å€ã€‚ç›¸åï¼Œå®ƒä¼šå¯¼è‡´å‡½æ•°ä»¥<em>æ‹‡æŒ‡æ¨¡å¼</em>æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°åœ¨</p>
<pre><code>0x7f</code></pre><p>å’Œä¹‹é—´äº¤æ›¿çš„åœ°å€æ¨¡å¼</p>
<pre><code>0x00</code></pre><p>ã€‚</p>
<ul>
<li>çœ‹ä¸Šé¢çš„åæ±‡ç¼–ï¼Œå¾ˆæ˜æ˜¾<code>0x7f</code>æŒ‡çš„æ˜¯ <code>DefaultExceptionHandler</code>ï¼ˆ<code>0x7e</code>ä»¥æ‹‡æŒ‡æ¨¡å¼æ‰§è¡Œï¼‰ã€‚</li>
<li>å°†æ¨¡å¼ä¸æœ¬ç« å‰é¢è®¾ç½®çš„å‘é‡è¡¨ï¼ˆå‚è§ çš„å®šä¹‰<code>pub static EXCEPTIONS</code>ï¼‰ä¸<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/exception-model/vector-table" target="_blank" rel="noopener">Cortex-M çš„å‘é‡è¡¨å¸ƒå±€</a>äº¤å‰å¼•ç”¨ï¼Œå¾ˆæ˜æ˜¾<code>DefaultExceptionHandler</code>æ¯æ¬¡å‡ºç°ç›¸åº”çš„å¤„ç†ç¨‹åºæ¡ç›®æ—¶éƒ½ä¼šå‡ºç°çš„åœ°å€ å‡ºç°åœ¨è¡¨ä¸­ã€‚</li>
<li>åè¿‡æ¥ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒRust ä»£ç ä¸­å‘é‡è¡¨æ•°æ®ç»“æ„çš„å¸ƒå±€ä¸ Cortex-M å‘é‡è¡¨ä¸­çš„æ‰€æœ‰ä¿ç•™æ§½å¯¹é½ã€‚å› æ­¤ï¼Œæ‰€æœ‰ä¿ç•™æ—¶éš™éƒ½æ­£ç¡®è®¾ç½®ä¸ºé›¶å€¼ã€‚</li>
</ul>
</li>
</ul>
<h2 id="è¦†ç›–å¤„ç†ç¨‹åº"><a href="#è¦†ç›–å¤„ç†ç¨‹åº" class="headerlink" title="è¦†ç›–å¤„ç†ç¨‹åº"></a>è¦†ç›–å¤„ç†ç¨‹åº</h2><p>è¦è¦†ç›–å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œç”¨æˆ·å¿…é¡»æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ç¬¦å·åç§°ä¸æˆ‘ä»¬åœ¨ ä¸­ä½¿ç”¨çš„åç§°å®Œå…¨åŒ¹é…<code>EXCEPTIONS</code>ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(core_intrinsics)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>intrinsics<span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something interesting here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½ å¯ä»¥åœ¨ QEMU ä¸­æµ‹è¯•</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
Reset () at /home/japaric/rust/embedonomicon/ci/exceptions/rt/src/lib.rs:7
7       pub unsafe extern "C" fn Reset() -> ! {

(gdb) b HardFault
Breakpoint 1 at 0x44: file src/main.rs, line 18.

(gdb) continue
Continuing.

Breakpoint 1, HardFault () at src/main.rs:18
18          loop {}

(gdb) list
13      }
14
15      #[no_mangle]
16      pub extern "C" fn HardFault() -> ! {
17          // do something interesting here
18          loop {}
19      }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¨‹åºç°åœ¨æ‰§è¡Œç”¨æˆ·å®šä¹‰çš„<code>HardFault</code>å‡½æ•°ï¼Œè€Œä¸æ˜¯ <code>DefaultExceptionHandler</code>åœ¨<code>rt</code>crate ä¸­ã€‚</p>
<p>å°±åƒæˆ‘ä»¬å¯¹<code>main</code>æ¥å£çš„ç¬¬ä¸€æ¬¡å°è¯•ä¸€æ ·ï¼Œè¿™ä¸ªç¬¬ä¸€ä¸ªå®ç°å­˜åœ¨æ²¡æœ‰ç±»å‹å®‰å…¨çš„é—®é¢˜ã€‚é”™è¯¯è¾“å…¥å¼‚å¸¸çš„åç§°ä¹Ÿå¾ˆå®¹æ˜“ï¼Œä½†è¿™ä¸ä¼šäº§ç”Ÿé”™è¯¯æˆ–è­¦å‘Šã€‚ç›¸åï¼Œç”¨æˆ·å®šä¹‰çš„å¤„ç†ç¨‹åºè¢«ç®€å•åœ°å¿½ç•¥ã€‚è¿™äº›é—®é¢˜å¯ä»¥é€šè¿‡è±¡çš„å®è¢«å›ºå®š<a href="https://github.com/japaric/cortex-m-rt/blob/v0.5.1/src/lib.rs#L792" target="_blank" rel="noopener"><code>exception!</code></a>åœ¨å®šä¹‰çš„å®<code>cortex-m-rt</code>v0.5.xæˆ– <a href="https://github.com/rust-embedded/cortex-m-rt/blob/v0.6.3/macros/src/lib.rs#L254" target="_blank" rel="noopener"><code>exception</code></a>åœ¨å±æ€§<code>cortex-m-rt</code>v0.6.x.</p>
<h1 id="Assembly-on-stable"><a href="#Assembly-on-stable" class="headerlink" title="Assembly on stable"></a>Assembly on stable</h1><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¾æ³•å¯åŠ¨è®¾å¤‡å¹¶å¤„ç†ä¸­æ–­ï¼Œè€Œæ— éœ€ä¸€è¡Œæ±‡ç¼–ã€‚è¿™çœŸæ˜¯ä¸€ä¸ªå£®ä¸¾ï¼ä½†æ˜¯æ ¹æ®æ‚¨æ‰€é’ˆå¯¹çš„æ¶æ„ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸€äº›ç»„è£…æ‰èƒ½è¾¾åˆ°è¿™ä¸€ç‚¹ã€‚è¿˜æœ‰ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚éœ€è¦æ±‡ç¼–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ã€‚</p>
<p>é—®é¢˜æ˜¯<em>å†…è”</em>æ±‡ç¼– ( <code>asm!</code>) å’Œ<em>è‡ªç”±å½¢å¼</em>æ±‡ç¼– ( <code>global_asm!</code>) éƒ½ä¸ç¨³å®šï¼Œå¹¶ä¸”æ— æ³•ä¼°è®¡å®ƒä»¬ä½•æ—¶ä¼šç¨³å®šä¸‹æ¥ï¼Œå› æ­¤æ‚¨ä¸èƒ½åœ¨ stable ä¸Šä½¿ç”¨å®ƒä»¬ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨æ­¤å¤„è®°å½•ä¸€äº›è§£å†³æ–¹æ³•ã€‚</p>
<p>ä¸ºäº†æ¿€å‘æœ¬èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†è°ƒæ•´<code>HardFault</code>å¤„ç†ç¨‹åºä»¥æä¾›æœ‰å…³ç”Ÿæˆå¼‚å¸¸çš„å †æ ˆå¸§çš„ä¿¡æ¯ã€‚</p>
<p>è¿™æ˜¯æˆ‘ä»¬æƒ³è¦åšçš„ï¼š</p>
<p>æˆ‘ä»¬ä¸ä¼šè®©ç”¨æˆ·ç›´æ¥å°†ä»–ä»¬çš„<code>HardFault</code>å¤„ç†ç¨‹åºæ”¾åœ¨å‘é‡è¡¨ä¸­ï¼Œè€Œæ˜¯è®©<code>rt</code>crate å°†ä¸€ä¸ªè¹¦åºŠæ”¾åˆ°å‘é‡è¡¨ä¸­çš„ç”¨æˆ·å®šä¹‰çš„<code>HardFault</code> å¤„ç†ç¨‹åºä¸­ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n36 ../rt/src/lib.rs
extern "C" {
    fn NMI();
    fn HardFaultTrampoline(); // <- CHANGED!
    fn MemManage();
    fn BusFault();
    fn UsageFault();
    fn SVCall();
    fn PendSV();
    fn SysTick();
}

#[link_section = ".vector_table.exceptions"]
#[no_mangle]
pub static EXCEPTIONS: [Vector; 14] = [
    Vector { handler: NMI },
    Vector { handler: HardFaultTrampoline }, // <- CHANGED!
    Vector { handler: MemManage },
    Vector { handler: BusFault },
    Vector {
        handler: UsageFault,
    },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: SVCall },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: PendSV },
    Vector { handler: SysTick },
];

#[no_mangle]
pub extern "C" fn DefaultExceptionHandler() {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªè¹¦åºŠå°†è¯»å–å †æ ˆæŒ‡é’ˆï¼Œç„¶åè°ƒç”¨ç”¨æˆ·<code>HardFault</code> å¤„ç†ç¨‹åºã€‚è¹¦åºŠå¿…é¡»ç”¨æ±‡ç¼–ç¼–å†™ï¼š</p>
<pre class="line-numbers language-armasm"><code class="language-armasm">  mrs r0, MSP
  b HardFault<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç”±äº ARM ABI çš„å·¥ä½œæ–¹å¼ï¼Œè¿™å°†ä¸»å †æ ˆæŒ‡é’ˆ (MSP) è®¾ç½®ä¸º<code>HardFault</code>å‡½æ•°/ä¾‹ç¨‹çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™ä¸ª MSP å€¼ä¹Ÿæ°å¥½æ˜¯ä¸€ä¸ªæŒ‡å‘ç”±å¼‚å¸¸å‹å…¥å †æ ˆçš„å¯„å­˜å™¨çš„æŒ‡é’ˆã€‚é€šè¿‡è¿™äº›æ›´æ”¹ï¼Œç”¨æˆ·<code>HardFault</code>å¤„ç†ç¨‹åºç°åœ¨å¿…é¡»å…·æœ‰ç­¾å <code>fn(&amp;StackedRegisters) -&gt; !</code>ã€‚</p>
<h2 id="s-æ¡£æ¡ˆ"><a href="#s-æ¡£æ¡ˆ" class="headerlink" title=".s æ¡£æ¡ˆ"></a><code>.s</code> æ¡£æ¡ˆ</h2><p>ç¨³å®šç¨‹åºé›†çš„ä¸€ç§æ–¹æ³•æ˜¯å°†ç¨‹åºé›†å†™å…¥å¤–éƒ¨æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/asm.s
  .section .text.HardFaultTrampoline
  .global HardFaultTrampoline
  .thumb_func
HardFaultTrampoline:
  mrs r0, MSP
  b HardFault<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¹¶ä½¿ç”¨<code>cc</code>crate çš„æ„å»ºè„šæœ¬ä¸­çš„<code>rt</code>crate å°†è¯¥æ–‡ä»¶ç»„è£…æˆç›®æ ‡æ–‡ä»¶ ( <code>.o</code>)ï¼Œç„¶åç»„è£…æˆå­˜æ¡£ ( <code>.a</code>)ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

use cc::Build;

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    // assemble the `asm.s` file
    Build::new().file("asm.s").compile("asm"); // <- NEW!

    // rebuild if `asm.s` changed
    println!("cargo:rerun-if-changed=asm.s"); // <- NEW!

    Ok(())
}
$ tail -n2 ../rt/Cargo.toml
[build-dependencies]
cc = "1.0.25"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°±æ˜¯è¿™æ ·ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥<code>HardFaultTrampoline</code> é€šè¿‡ç¼–å†™ä¸€ä¸ªéå¸¸ç®€å•çš„ç¨‹åºæ¥ç¡®è®¤å‘é‡è¡¨åŒ…å«ä¸€ä¸ªæŒ‡å‘çš„æŒ‡é’ˆã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[allow(non_snake_case)]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>_ef<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸‹é¢æ˜¯æ‹†è§£ã€‚çœ‹çœ‹åœ°å€<code>HardFaultTrampoline</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<HardFault>:
                   b    #-0x4 <HardFault>

<main>:
                   b    #-0x4 <main>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-0xa
                   trap

<UsageFault>:
                   b    #-0x4 <UsageFault>

<HardFaultTrampoline>:
                   mrs    r0, msp
                   b    #-0x18 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>ä¸ºäº†ä½¿è¿™ä¸ªåæ±‡ç¼–æ›´å°ï¼Œæˆ‘æ³¨é‡Šæ‰äº† RAM çš„åˆå§‹åŒ–</p>
</blockquote>
<p>ç°åœ¨çœ‹çœ‹å‘é‡è¡¨ã€‚ç¬¬å››ä¸ªæ¡ç›®åº”è¯¥æ˜¯<code>HardFaultTrampoline</code>åŠ ä¸€çš„åœ°å€ ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 4f000000 51000000  ... E...O...Q...
 0010 4f000000 4f000000 4f000000 00000000  O...O...O.......
 0020 00000000 00000000 00000000 4f000000  ............O...
 0030 00000000 00000000 4f000000 4f000000  ........O...O...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="o-aæ–‡ä»¶"><a href="#o-aæ–‡ä»¶" class="headerlink" title=".o/.aæ–‡ä»¶"></a><code>.o</code>/<code>.a</code>æ–‡ä»¶</h2><p>ä½¿ç”¨<code>cc</code>crateçš„ç¼ºç‚¹æ˜¯å®ƒéœ€è¦åœ¨æ„å»ºæœºå™¨ä¸Šå®‰è£…ä¸€äº›æ±‡ç¼–ç¨‹åºã€‚ä¾‹å¦‚ï¼Œå½“ä»¥ ARM Cortex-M ä¸ºç›®æ ‡æ—¶ï¼Œ<code>cc</code>crate<code>arm-none-eabi-gcc</code>ç”¨ä½œæ±‡ç¼–å™¨ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨<code>rt</code>crateè¿é€ä¸€ä¸ªé¢„ç»„è£…çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨æ„å»ºæœºå™¨ä¸Šç»„è£…æ–‡ä»¶ã€‚è¿™æ ·ï¼Œæ„å»ºæœºå™¨ä¸Šå°±ä¸éœ€è¦æ±‡ç¼–ç¨‹åºã€‚ä½†æ˜¯ï¼Œæ‚¨ä»ç„¶éœ€è¦åœ¨æ‰“åŒ…å’Œå‘å¸ƒ crate çš„æœºå™¨ä¸Šå®‰è£…ä¸€ä¸ªæ±‡ç¼–ç¨‹åºã€‚</p>
<p>ç¨‹åºé›† ( <code>.s</code>) æ–‡ä»¶ä¸å…¶<em>ç¼–è¯‘</em> ç‰ˆæœ¬ä¹‹é—´æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼šå¯¹è±¡ ( <code>.o</code>) æ–‡ä»¶ã€‚æ±‡ç¼–å™¨ä¸åšä»»ä½•ä¼˜åŒ–ï¼›å®ƒåªæ˜¯ä¸ºç›®æ ‡æ¶æ„é€‰æ‹©æ­£ç¡®çš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ã€‚</p>
<p>Cargo æ”¯æŒå°†æ¡£æ¡ˆ ( <code>.a</code>) ä¸ crateæ†ç»‘åœ¨ä¸€èµ·ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥<code>ar</code>å‘½ä»¤å°†ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆæ¡£æ¡ˆï¼Œç„¶åå°†æ¡£æ¡ˆä¸ crate æ†ç»‘åœ¨ä¸€èµ·ã€‚äº‹å®ä¸Šï¼Œè¿™å°±æ˜¯<code>cc</code>æ¿æ¡ç®±çš„ä½œç”¨ï¼›ä½ å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨é€šè¿‡æœç´¢æŒ‡å®šæ–‡ä»¶ä¸­çš„å‘½ä»¤<code>output</code>åœ¨<code>target</code>ç›®å½•ä¸­ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ grep running $(find target -name output)
running: "arm-none-eabi-gcc" "-O0" "-ffunction-sections" "-fdata-sections" "-fPIC" "-g" "-fno-omit-frame-pointer" "-mthumb" "-march=armv7-m" "-Wall" "-Wextra" "-o" "/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/asm.o" "-c" "asm.s"
running: "ar" "crs" "/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/libasm.a" "/home/japaric/rust-embedded/embedonomicon/ci/asm/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/asm.o"
$ grep cargo $(find target -name output)
cargo:rustc-link-search=/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out
cargo:rustc-link-lib=static=asm
cargo:rustc-link-search=native=/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä¼šåšä¸€äº›ç±»ä¼¼çš„äº‹æƒ…æ¥ç”Ÿæˆä¸€ä¸ªå­˜æ¡£ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ # most of flags `cc` uses have no effect when assembling so we drop them
$ arm-none-eabi-as -march=armv7-m asm.s -o asm.o

$ ar crs librt.a asm.o

$ arm-none-eabi-objdump -Cd librt.a
In archive librt.a:

asm.o:     file format elf32-littlearm


Disassembly of section .text.HardFaultTrampoline:

00000000 <HardFaultTrampoline>:
   0:    f3ef 8008     mrs    r0, MSP
   4:    e7fe          b.n    0 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹æ„å»ºè„šæœ¬ä»¥å°†æ­¤å­˜æ¡£ä¸<code>rt</code>rlibæ†ç»‘åœ¨ä¸€èµ·ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/build.rs
use std::{
    env,
    error::Error,
    fs::{self, File},
    io::Write,
    path::PathBuf,
};

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    // link to `librt.a`
    fs::copy("librt.a", out_dir.join("librt.a"))?; // <- NEW!
    println!("cargo:rustc-link-lib=static=rt"); // <- NEW!

    // rebuild if `librt.a` changed
    println!("cargo:rerun-if-changed=librt.a"); // <- NEW!

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ä¹‹å‰çš„ç®€å•ç¨‹åºæµ‹è¯•è¿™ä¸ªæ–°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ç›¸åŒçš„è¾“å‡ºã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<HardFault>:
                   b    #-0x4 <HardFault>

<main>:
                   b    #-0x4 <main>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-0xa
                   trap

<UsageFault>:
                   b    #-0x4 <UsageFault>

<HardFaultTrampoline>:
                   mrs    r0, msp
                   b    #-0x18 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šå’Œä¹‹å‰ä¸€æ ·ï¼Œæˆ‘å·²ç»æ³¨é‡Šæ‰äº† RAM åˆå§‹åŒ–ä»¥ä½¿åæ±‡ç¼–æ›´å°ã€‚</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 4f000000 51000000  ... E...O...Q...
 0010 4f000000 4f000000 4f000000 00000000  O...O...O.......
 0020 00000000 00000000 00000000 4f000000  ............O...
 0030 00000000 00000000 4f000000 4f000000  ........O...O...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿é€é¢„ç»„è£…æ¡£æ¡ˆçš„ç¼ºç‚¹æ˜¯ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä¸ºæ‚¨çš„åº“æ”¯æŒçš„æ¯ä¸ªç¼–è¯‘ç›®æ ‡è¿é€ä¸€ä¸ªæ„å»ºå·¥ä»¶ã€‚</p>
<h1 id="Logging-with-symbols"><a href="#Logging-with-symbols" class="headerlink" title="Logging with symbols"></a>Logging with symbols</h1><p>æœ¬èŠ‚å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åˆ©ç”¨ç¬¦å·å’Œ ELF æ ¼å¼æ¥å®ç°è¶…å»‰ä»·çš„æ—¥å¿—è®°å½•ã€‚</p>
<h2 id="ä»»æ„ç¬¦å·"><a href="#ä»»æ„ç¬¦å·" class="headerlink" title="ä»»æ„ç¬¦å·"></a>ä»»æ„ç¬¦å·</h2><p>æ¯å½“æˆ‘ä»¬éœ€è¦åœ¨ crate ä¹‹é—´ä½¿ç”¨ç¨³å®šçš„ç¬¦å·æ¥å£æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨<code>no_mangle</code>å±æ€§ï¼Œæœ‰æ—¶ä½¿ç”¨<code>export_name</code>å±æ€§ã€‚è¯¥ <code>export_name</code>å±æ€§é‡‡ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²æˆä¸ºç¬¦å·çš„åç§°ï¼Œè€Œ<code>#[no_mangle]</code>åŸºæœ¬ä¸Šæ˜¯<code>#[export_name = &lt;item-name&gt;]</code>.</p>
<p>äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬ä¸ä»…é™äºå•ä¸ªå•è¯åç§°ï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚å¥å­ï¼Œä½œä¸º<code>export_name</code>å±æ€§çš„å‚æ•°ã€‚è‡³å°‘å½“è¾“å‡ºæ ¼å¼æ˜¯ ELF æ—¶ï¼Œä»»ä½•ä¸åŒ…å«ç©ºå­—èŠ‚çš„ä¸œè¥¿éƒ½å¯ä»¥ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --lib foo

$ cat foo/src/lib.rs
#[export_name = "Hello, world!"]
#[used]
static A: u8 = 0;

#[export_name = "ã“ã‚“ã«ã¡ã¯"]
#[used]
static B: u8 = 0;
$ ( cd foo && cargo nm --lib )
foo-d26a39c34b4e80ce.3lnzqy0jbpxj4pld.rcgu.o:
0000000000000000 r Hello, world!
0000000000000000 V __rustc_debug_gdb_scripts_section__
0000000000000000 r ã“ã‚“ã«ã¡ã¯<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½ èƒ½çœ‹å‡ºè¿™æ˜¯æ€ä¹ˆå›äº‹å—ï¼Ÿ</p>
<h2 id="ç¼–ç -1"><a href="#ç¼–ç -1" class="headerlink" title="ç¼–ç "></a>ç¼–ç </h2><p>è¿™æ˜¯æˆ‘ä»¬è¦åšçš„ï¼šæˆ‘ä»¬å°†ä¸º<code>static</code>æ¯ä¸ªæ—¥å¿—æ¶ˆæ¯åˆ›å»ºä¸€ä¸ªå˜é‡ï¼Œä½†ä¸æ˜¯å°†æ¶ˆæ¯å­˜å‚¨<em>åœ¨</em>å˜é‡ä¸­ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å­˜å‚¨åœ¨å˜é‡çš„<em>ç¬¦å·åç§°ä¸­</em>ã€‚æˆ‘ä»¬å°†è®°å½•çš„ä¸æ˜¯<code>static</code>å˜é‡çš„å†…å®¹ï¼Œè€Œæ˜¯å®ƒä»¬çš„åœ°å€ã€‚</p>
<p>åªè¦<code>static</code>å˜é‡ä¸æ˜¯é›¶å¤§å°ï¼Œæ¯ä¸ªå˜é‡éƒ½ä¼šæœ‰ä¸åŒçš„åœ°å€ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„æ˜¯æœ‰æ•ˆåœ°å°†æ¯æ¡æ¶ˆæ¯ç¼–ç ä¸ºä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè¿™æ°å¥½æ˜¯å˜é‡åœ°å€ã€‚æ—¥å¿—ç³»ç»Ÿçš„æŸäº›éƒ¨åˆ†å¿…é¡»å°†æ­¤ ID è§£ç å›æ¶ˆæ¯ä¸­ã€‚</p>
<p>è®©æˆ‘ä»¬å†™ä¸€äº›ä»£ç æ¥è¯´æ˜è¿™ä¸ªæƒ³æ³•ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æ–¹å¼æ¥è¿›è¡Œ I/Oï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨ <a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>crate æ¥å®ç°ã€‚åŠä¸»æœºæ˜¯ä¸€ç§è®©ç›®æ ‡è®¾å¤‡å€Ÿç”¨ä¸»æœº I/O åŠŸèƒ½çš„æŠ€æœ¯ï¼›è¿™é‡Œçš„ä¸»æœºé€šå¸¸æ˜¯æŒ‡æ­£åœ¨è°ƒè¯•ç›®æ ‡è®¾å¤‡çš„æœºå™¨ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒQEMU æ”¯æŒå¼€ç®±å³ç”¨çš„åŠä¸»æœºï¼Œå› æ­¤ä¸éœ€è¦è°ƒè¯•å™¨ã€‚åœ¨çœŸå®è®¾å¤‡ä¸Šï¼Œæ‚¨å°†æœ‰å…¶ä»–æ–¹å¼è¿›è¡Œ I/Oï¼Œå¦‚ä¸²è¡Œç«¯å£ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨åŠä¸»æœºï¼Œå› ä¸ºè¿™æ˜¯åœ¨ QEMU ä¸Šè¿›è¡Œ I/O çš„æœ€ç®€å•æ–¹æ³•ã€‚</p>
<p>è¿™æ˜¯ä»£ç </p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hio<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> hstdout <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> A<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#x}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>A <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Goodbye"</span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> B<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#x}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>B <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿˜ä½¿ç”¨<code>debug::exit</code>API æ¥è®©ç¨‹åºç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚è¿™å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤æˆ‘ä»¬ä¸å¿…æ‰‹åŠ¨ç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚</p>
<p>è¿™<code>dependencies</code>æ˜¯ Cargo.tomlçš„éƒ¨åˆ†ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
cortex-m-semihosting = "0.3.1"
rt = { path = "../rt" }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºç¨‹åº</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¦è¿è¡Œå®ƒï¼Œæˆ‘ä»¬å¿…é¡»å°†<code>--semihosting-config</code>æ ‡å¿—æ·»åŠ åˆ°æˆ‘ä»¬çš„ QEMU è°ƒç”¨ä¸­ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ qemu-system-arm \
      -cpu cortex-m3 \
      -machine lm3s6965evb \
      -nographic \
      -semihosting-config enable=on,target=native \
      -kernel target/thumbv7m-none-eabi/debug/app
0x1fe0
0x1fe1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šè¿™äº›åœ°å€å¯èƒ½ä¸æ˜¯æ‚¨åœ¨æœ¬åœ°è·å¾—çš„åœ°å€ï¼Œå› ä¸º<code>static</code>åœ¨æ›´æ”¹å·¥å…·é“¾æ—¶ä¸èƒ½ä¿è¯å˜é‡çš„åœ°å€ä¿æŒä¸å˜ï¼ˆä¾‹å¦‚ä¼˜åŒ–å¯èƒ½å·²ç»æ”¹è¿›ï¼‰ã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ä¸ªåœ°å€æ‰“å°åˆ°æ§åˆ¶å°ã€‚</p>
<h2 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h2><p>æˆ‘ä»¬å¦‚ä½•å°†è¿™äº›åœ°å€è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Ÿç­”æ¡ˆåœ¨ ELF æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.rodata\s*0*1\b'
00001fe1 g       .rodata         00000001 Goodbye
00001fe0 g       .rodata         00000001 Hello, world!
$ # first column is the symbol address; last column is the symbol name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>objdump -t</code>æ‰“å°ç¬¦å·è¡¨ã€‚è¯¥è¡¨åŒ…å«<em>æ‰€æœ‰</em>ç¬¦å·ï¼Œä½†æˆ‘ä»¬åªåœ¨è¯¥<code>.rodata</code>éƒ¨åˆ†ä¸­æŸ¥æ‰¾å¤§å°ä¸º 1 ä¸ªå­—èŠ‚çš„ç¬¦å·ï¼ˆæˆ‘ä»¬çš„å˜é‡å…·æœ‰ type <code>u8</code>ï¼‰ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¼˜åŒ–ç¨‹åºæ—¶ï¼Œç¬¦å·çš„åœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ã€‚</p>
<blockquote>
<p><strong>æ™®ç½—è’‚æ™®</strong>æ‚¨å¯ä»¥è®¾ç½®<code>target.thumbv7m-none-eabi.runner</code>ä»ä¹‹å‰çš„é•¿QEMUå‘½ä»¤ï¼ˆ<code>qemu-system-arm -cpu (..) -kernel</code>ï¼‰çš„è´§ç‰©é…ç½®æ–‡ä»¶ï¼ˆä¸­<code>.cargo/conifg</code>ï¼‰æœ‰<code>cargo run</code>ä½¿ç”¨è¯¥<em>äºšå†›</em>æ‰§è¡ŒäºŒè¿›åˆ¶è¾“å‡ºã€‚</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ head -n2 .cargo/config
[target.thumbv7m-none-eabi]
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"
$ cargo run --release
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/app`
0xb9c
0xb9d
$ cargo objdump --bin app --release -- -t | grep '\.rodata\s*0*1\b'
00000b9d g     O .rodata    00000001 Goodbye
00000b9c g     O .rodata    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å› æ­¤ï¼Œè¯·ç¡®ä¿å§‹ç»ˆåœ¨æ‚¨æ‰§è¡Œçš„ ELF æ–‡ä»¶ä¸­æŸ¥æ‰¾å­—ç¬¦ä¸²ã€‚</p>
<p>å½“ç„¶ï¼Œåœ¨ ELF æ–‡ä»¶ä¸­æŸ¥æ‰¾å­—ç¬¦ä¸²çš„è¿‡ç¨‹å¯ä»¥ä½¿ç”¨è§£æ<code>.symtab</code>ELF æ–‡ä»¶ä¸­åŒ…å«çš„ç¬¦å·è¡¨ï¼ˆèŠ‚ï¼‰çš„å·¥å…·æ¥è‡ªåŠ¨åŒ–ã€‚å®ç°è¿™æ ·çš„å·¥å…·è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ï¼Œç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚</p>
<h2 id="å®ç°é›¶æˆæœ¬"><a href="#å®ç°é›¶æˆæœ¬" class="headerlink" title="å®ç°é›¶æˆæœ¬"></a>å®ç°é›¶æˆæœ¬</h2><p>æˆ‘ä»¬èƒ½åšå¾—æ›´å¥½å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ï¼</p>
<p>å½“å‰çš„å®ç°å°†<code>static</code>å˜é‡æ”¾åœ¨ ä¸­<code>.rodata</code>ï¼Œè¿™æ„å‘³ç€å³ä½¿æˆ‘ä»¬ä»ä¸ä½¿ç”¨å®ƒä»¬çš„å†…å®¹ï¼Œå®ƒä»¬ä¹Ÿå ç”¨ Flash ä¸­çš„å¤§å°ã€‚ä½¿ç”¨ä¸€ç‚¹é“¾æ¥è„šæœ¬é­”æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®ƒä»¬åœ¨ Flash ä¸­å æ®<em>é›¶</em>ç©ºé—´ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat log.x
SECTIONS
{
  .log 0 (INFO) : {
    *(.log);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†æŠŠ<code>static</code>å˜é‡æ”¾åœ¨è¿™ä¸ªæ–°çš„è¾“å‡º<code>.log</code>éƒ¨åˆ†ã€‚æ­¤é“¾æ¥æè¿°æ–‡ä»¶å°†æ”¶é›†<code>.log</code>è¾“å…¥ç›®æ ‡æ–‡ä»¶éƒ¨åˆ†ä¸­çš„æ‰€æœ‰ç¬¦å·ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥è¾“å‡º<code>.log</code>éƒ¨åˆ†ã€‚æˆ‘ä»¬å·²ç»åœ¨<a href="https://docs.rust-embedded.org/embedonomicon/memory-layout.html" target="_blank" rel="noopener">å†…å­˜å¸ƒå±€</a>ç« èŠ‚ä¸­çœ‹åˆ°äº†è¿™ç§æ¨¡å¼ã€‚</p>
<p>è¿™é‡Œçš„æ–°<code>(INFO)</code>éƒ¨åˆ†æ˜¯é›¶ä»¶ï¼›è¿™å‘Šè¯‰é“¾æ¥å™¨è¿™ä¸ªéƒ¨åˆ†æ˜¯ä¸€ä¸ªä¸å¯åˆ†é…çš„éƒ¨åˆ†ã€‚ä¸å¯åˆ†é…çš„éƒ¨åˆ†ä½œä¸ºå…ƒæ•°æ®ä¿å­˜åœ¨ ELF äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä½†å®ƒä»¬ä¸ä¼šåŠ è½½åˆ°ç›®æ ‡è®¾å¤‡ä¸Šã€‚</p>
<p>æˆ‘ä»¬è¿˜æŒ‡å®šäº†è¿™ä¸ªè¾“å‡ºéƒ¨åˆ†çš„èµ·å§‹åœ°å€ï¼š<code>0</code>in <code>.log 0 (INFO)</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åšçš„å¦ä¸€ä¸ªæ”¹è¿›æ˜¯ä»æ ¼å¼åŒ– I/O ( <code>fmt::Write</code>) åˆ‡æ¢åˆ°äºŒè¿›åˆ¶ I/Oï¼Œå³å°†åœ°å€ä½œä¸ºå­—èŠ‚è€Œä¸æ˜¯å­—ç¬¦ä¸²å‘é€åˆ°ä¸»æœºã€‚</p>
<p>äºŒè¿›åˆ¶åºåˆ—åŒ–å¯èƒ½å¾ˆå›°éš¾ï¼Œä½†æˆ‘ä»¬å°†é€šè¿‡å°†æ¯ä¸ªåœ°å€åºåˆ—åŒ–ä¸ºå•ä¸ªå­—èŠ‚æ¥ä½¿äº‹æƒ…å˜å¾—éå¸¸ç®€å•ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒå­—èŠ‚åºæˆ–æ¡†æ¶ã€‚è¿™ç§æ ¼å¼çš„ç¼ºç‚¹æ˜¯å•ä¸ªå­—èŠ‚æœ€å¤šåªèƒ½è¡¨ç¤º 256 ä¸ªä¸åŒçš„åœ°å€ã€‚</p>
<p>è®©æˆ‘ä»¬è¿›è¡Œè¿™äº›æ›´æ”¹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hio<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> hstdout <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">]</span>
    #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>
    <span class="token keyword">static</span> A<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token operator">&amp;</span>A <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">;</span>
    hstdout<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt;- CHANGED!</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Goodbye"</span><span class="token punctuation">]</span>
    #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>
    <span class="token keyword">static</span> B<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token operator">&amp;</span>B <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">;</span>
    hstdout<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt;- CHANGED!</span>

    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿è¡Œä¹‹å‰ï¼Œæ‚¨å¿…é¡»é™„åŠ <code>-Tlog.x</code>åˆ°ä¼ é€’ç»™é“¾æ¥å™¨çš„å‚æ•°ã€‚è¿™å¯ä»¥åœ¨ Cargo é…ç½®æ–‡ä»¶ä¸­å®Œæˆã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat .cargo/config
[target.thumbv7m-none-eabi]
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"
rustflags = [
  "-C", "link-arg=-Tlink.x",
  "-C", "link-arg=-Tlog.x", # <- NEW!
]

[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ä½ å¯ä»¥è¿è¡Œå®ƒäº†ï¼ç”±äºè¾“å‡ºç°åœ¨å…·æœ‰äºŒè¿›åˆ¶æ ¼å¼ï¼Œæˆ‘ä»¬å°†é€šè¿‡<code>xxd</code>å‘½ä»¤å°†å…¶é€šè¿‡ç®¡é“å°†å…¶é‡æ–°æ ¼å¼åŒ–ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>åœ°å€æ˜¯<code>0x00</code>å’Œ<code>0x01</code>ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ç¬¦å·è¡¨ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æœ‰æˆ‘ä»¬çš„å­—ç¬¦ä¸²ã€‚ä½ ä¼šæ³¨æ„åˆ°ä»–ä»¬çš„åœ°å€ç°åœ¨ä»é›¶å¼€å§‹ï¼›è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸ºè¾“å‡º<code>.log</code>éƒ¨åˆ†è®¾ç½®äº†èµ·å§‹åœ°å€ã€‚</p>
<p>æ¯ä¸ªå˜é‡çš„å¤§å°ä¸º 1 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæˆ‘ä»¬å°†<code>u8</code>å…¶ç”¨ä½œå®ƒä»¬çš„ç±»å‹ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼çš„ä¸œè¥¿ï¼Œ<code>u16</code>é‚£ä¹ˆæ‰€æœ‰åœ°å€éƒ½ä¼šæ˜¯å¶æ•°ï¼Œæˆ‘ä»¬å°†æ— æ³•æœ‰æ•ˆåœ°ä½¿ç”¨æ‰€æœ‰åœ°å€ç©ºé—´ ( <code>0...255</code>)ã€‚</p>
<h2 id="åŒ…è£…èµ·æ¥"><a href="#åŒ…è£…èµ·æ¥" class="headerlink" title="åŒ…è£…èµ·æ¥"></a>åŒ…è£…èµ·æ¥</h2><p>æ‚¨å·²ç»æ³¨æ„åˆ°è®°å½•å­—ç¬¦ä¸²çš„æ­¥éª¤æ€»æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬é‡æ„ä¸ºä¸€ä¸ªå­˜åœ¨äºå…¶è‡ªå·±çš„ crate ä¸­çš„å®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ½è±¡ç‰¹å¾èƒŒåçš„ I/O éƒ¨åˆ†æ¥ä½¿æ—¥å¿—åº“æ›´å¯é‡ç”¨ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --lib log

$ cat log/src/lib.rs
#![no_std]

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

#[macro_export]
macro_rules! log {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log"]
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‰´äºè¿™ä¸ªåº“ä¾èµ–äº<code>.log</code>éƒ¨åˆ†ï¼Œå®ƒåº”è¯¥è´Ÿè´£æä¾›<code>log.x</code>é“¾æ¥æè¿°æ–‡ä»¶ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å®ç°è¿™ä¸€ç‚¹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ mv log.x ../log/
$ cat ../log/build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

fn main() -> Result<(), Box<dyn Error>> {
    // Put the linker script somewhere the linker can find it
    let out = PathBuf::from(env::var("OUT_DIR")?);

    File::create(out.join("log.x"))?.write_all(include_bytes!("log.x"))?;

    println!("cargo:rustc-link-search={}", out.display());

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡æ„æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨<code>log!</code>å®ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{log, Log};
use rt::entry;

struct Logger {
    hstdout: HStdout,
}

impl Log for Logger {
    type Error = ();

    fn log(&mut self, address: u8) -> Result<(), ()> {
        self.hstdout.write_all(&[address])
    }
}

entry!(main);

fn main() -> ! {
    let hstdout = hio::hstdout().unwrap();
    let mut logger = Logger { hstdout };

    let _ = log!(logger, "Hello, world!");

    let _ = log!(logger, "Goodbye");

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸è¦å¿˜è®°æ›´æ–°<code>Cargo.toml</code>æ–‡ä»¶ä»¥ä¾èµ–æ–°çš„<code>log</code>crateã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n4 Cargo.toml
[dependencies]
cortex-m-semihosting = "0.3.1"
log = { path = "../log" }
rt = { path = "../rt" }
$ cargo run | xxd -p
0001
$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å’Œä»¥å‰ä¸€æ ·çš„è¾“å‡ºï¼</p>
<h2 id="å¥–åŠ±ï¼šå¤šä¸ªæ—¥å¿—çº§åˆ«"><a href="#å¥–åŠ±ï¼šå¤šä¸ªæ—¥å¿—çº§åˆ«" class="headerlink" title="å¥–åŠ±ï¼šå¤šä¸ªæ—¥å¿—çº§åˆ«"></a>å¥–åŠ±ï¼šå¤šä¸ªæ—¥å¿—çº§åˆ«</h2><p>è®¸å¤šæ—¥å¿—æ¡†æ¶æä¾›äº†åœ¨ä¸åŒ<em>æ—¥å¿—çº§åˆ«</em>è®°å½•æ¶ˆæ¯çš„æ–¹æ³•ã€‚è¿™äº›æ—¥å¿—çº§åˆ«ä¼ è¾¾äº†æ¶ˆæ¯çš„ä¸¥é‡æ€§ï¼šâ€œè¿™æ˜¯ä¸€ä¸ªé”™è¯¯â€ã€â€œè¿™åªæ˜¯ä¸€ä¸ªè­¦å‘Šâ€ç­‰ã€‚è¿™äº›æ—¥å¿—çº§åˆ«å¯ç”¨äºåœ¨æœç´¢ä¾‹å¦‚é”™è¯¯æ¶ˆæ¯æ—¶è¿‡æ»¤æ‰ä¸é‡è¦çš„æ¶ˆæ¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰©å±•æˆ‘ä»¬çš„æ—¥å¿—åº“ä»¥æ”¯æŒæ—¥å¿—çº§åˆ«ï¼Œè€Œä¸ä¼šå¢åŠ å…¶å ç”¨ç©ºé—´ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å°†å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼š</p>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨äºæ¶ˆæ¯çš„å¹³é¢åœ°å€ç©ºé—´ï¼šä»<code>0</code>åˆ°<code>255</code>ï¼ˆåŒ…æ‹¬ï¼‰ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå‡è®¾æˆ‘ä»¬åªæƒ³åŒºåˆ†é”™è¯¯æ¶ˆæ¯å’Œè­¦å‘Šæ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥æŠŠåœ¨åœ°å€ç©ºé—´çš„å¼€å§‹æ‰€æœ‰çš„é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸”æ‰€æœ‰çš„è­¦å‘Šæ¶ˆæ¯<em>å</em>çš„é”™è¯¯æ¶ˆæ¯ã€‚å¦‚æœè§£ç å™¨çŸ¥é“ç¬¬ä¸€æ¡è­¦å‘Šæ¶ˆæ¯çš„åœ°å€ï¼Œåˆ™å®ƒå¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†ç±»ã€‚è¿™ä¸ªæƒ³æ³•å¯ä»¥æ‰©å±•åˆ°æ”¯æŒä¸¤ä¸ªä»¥ä¸Šçš„æ—¥å¿—çº§åˆ«ã€‚</p>
<p>è®©æˆ‘ä»¬é€šè¿‡ç”¨<code>log</code>ä¸¤ä¸ªæ–°å®æ›¿æ¢å®æ¥æµ‹è¯•è¿™ä¸ªæƒ³æ³•ï¼š<code>error!</code> å’Œ<code>warn!</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/src/lib.rs
#![no_std]

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

/// Logs messages at the ERROR log level
#[macro_export]
macro_rules! error {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log.error"] // <- CHANGED!
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}

/// Logs messages at the WARNING log level
#[macro_export]
macro_rules! warn {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log.warning"] // <- CHANGED!
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬é€šè¿‡å°†æ¶ˆæ¯æ”¾åœ¨ä¸åŒçš„é“¾æ¥éƒ¨åˆ†æ¥åŒºåˆ†é”™è¯¯å’Œè­¦å‘Šã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯æ›´æ–°é“¾æ¥æè¿°æ–‡ä»¶ï¼Œå°†é”™è¯¯ä¿¡æ¯æ”¾åœ¨è­¦å‘Šä¿¡æ¯ä¹‹å‰ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/log.x
SECTIONS
{
  .log 0 (INFO) : {
    *(.log.error);
    __log_warning_start__ = .;
    *(.log.warning);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿˜ä¸º<code>__log_warning_start__</code>é”™è¯¯å’Œè­¦å‘Šä¹‹é—´çš„è¾¹ç•Œå‘½åä¸º ã€‚è¯¥ç¬¦å·çš„åœ°å€å°†æ˜¯ç¬¬ä¸€æ¡è­¦å‘Šæ¶ˆæ¯çš„åœ°å€ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´æ–°åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨è¿™äº›æ–°çš„å®ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{error, warn, Log};
use rt::entry;

entry!(main);

fn main() -> ! {
    let hstdout = hio::hstdout().unwrap();
    let mut logger = Logger { hstdout };

    let _ = warn!(logger, "Hello, world!"); // <- CHANGED!

    let _ = error!(logger, "Goodbye"); // <- CHANGED!

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}

struct Logger {
    hstdout: HStdout,
}

impl Log for Logger {
    type Error = ();

    fn log(&mut self, address: u8) -> Result<(), ()> {
        self.hstdout.write_all(&[address])
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¾“å‡ºä¸ä¼šæœ‰å¤ªå¤§å˜åŒ–ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä»ç„¶åœ¨è¾“å‡ºä¸­å¾—åˆ°ä¸¤ä¸ªå­—èŠ‚ï¼Œä½†é”™è¯¯çš„åœ°å€ä¸º 0ï¼Œè­¦å‘Šçš„åœ°å€ä¸º 1ï¼Œå³ä½¿è­¦å‘Šæ˜¯æœ€å…ˆè®°å½•çš„ã€‚</p>
<p>ç°åœ¨çœ‹çœ‹ç¬¦å·è¡¨ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.log'
00000000 g     O .log    00000001 Goodbye
00000001 g     O .log    00000001 Hello, world!
00000001 g       .log    00000000 __log_warning_start__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨<code>__log_warning_start__</code>ï¼Œè¯¥<code>.log</code>éƒ¨åˆ†ä¸­æœ‰ä¸€ä¸ªé¢å¤–çš„ç¬¦å·ã€‚è¿™ä¸ªç¬¦å·çš„åœ°å€æ˜¯ç¬¬ä¸€æ¡è­¦å‘Šä¿¡æ¯çš„åœ°å€ã€‚åœ°å€ä½äºæ­¤å€¼çš„ç¬¦å·æ˜¯é”™è¯¯ï¼Œå…¶ä½™ç¬¦å·æ˜¯è­¦å‘Šã€‚</p>
<p>ä½¿ç”¨é€‚å½“çš„è§£ç å™¨ï¼Œæ‚¨å¯ä»¥ä»æ‰€æœ‰è¿™äº›ä¿¡æ¯ä¸­è·å¾—ä»¥ä¸‹äººç±»å¯è¯»çš„è¾“å‡ºï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">WARNING Hello, world!
ERROR Goodbye<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Global-singletonsï¼ˆå•ä¾‹ï¼‰"><a href="#Global-singletonsï¼ˆå•ä¾‹ï¼‰" class="headerlink" title="Global singletonsï¼ˆå•ä¾‹ï¼‰"></a>Global singletonsï¼ˆå•ä¾‹ï¼‰</h1><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•å®ç°å…¨å±€å…±äº«å•ä¾‹ã€‚åµŒå…¥å¼ Rust ä¹¦ç±æ¶µç›–äº† Rust éå¸¸ç‹¬ç‰¹çš„æœ¬åœ°æ‹¥æœ‰çš„å•èº«äººå£«ã€‚å…¨å±€å•ä¾‹æœ¬è´¨ä¸Šæ˜¯æ‚¨åœ¨ C å’Œ C++ ä¸­çœ‹åˆ°çš„å•ä¾‹æ¨¡å¼ï¼›å®ƒä»¬å¹¶éç‰¹å®šäºåµŒå…¥å¼å¼€å‘ï¼Œä½†ç”±äºå®ƒä»¬æ¶‰åŠç¬¦å·ï¼Œå› æ­¤å®ƒä»¬ä¼¼ä¹éå¸¸é€‚åˆåµŒå…¥å¼å¼€å‘ã€‚</p>
<blockquote>
<p><strong>TODO</strong>ï¼ˆèµ„æºå›¢é˜Ÿï¼‰åœ¨å¯åŠ¨æ—¶å°†â€œåµŒå…¥å¼ Rust ä¹¦â€é“¾æ¥åˆ°å•ä¾‹éƒ¨åˆ†</p>
</blockquote>
<p>ä¸ºäº†è¯´æ˜æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†æ‰©å±•æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­å¼€å‘çš„è®°å½•å™¨ä»¥æ”¯æŒå…¨å±€æ—¥å¿—è®°å½•ã€‚ç»“æœå°†<code>#[global_allocator]</code>ä¸åµŒå…¥å¼ Rust ä¹¦ä¸­æ¶µç›–çš„åŠŸèƒ½éå¸¸ç›¸ä¼¼ ã€‚</p>
<blockquote>
<p><strong>TODO</strong>ï¼ˆèµ„æºå›¢é˜Ÿï¼‰<code>#[global_allocator]</code>åœ¨æ›´ç¨³å®šçš„ä½ç½®é“¾æ¥åˆ°æœ¬ä¹¦çš„æ”¶è—ç« èŠ‚ã€‚</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬æƒ³è¦åšçš„æ€»ç»“ï¼š</p>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>log!</code>å®æ¥é€šè¿‡ç‰¹å®šçš„è®°å½•å™¨è®°å½•æ¶ˆæ¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå®ç°<code>Log</code>traitçš„å€¼ã€‚<code>log!</code>å®çš„è¯­æ³•æ˜¯<code>log!(logger, "String")</code>. æˆ‘ä»¬æƒ³æ‰©å±•å®ï¼Œä½¿å…¶ <code>log!("String")</code>ä¹Ÿèƒ½å·¥ä½œã€‚ä½¿ç”¨<code>logger</code>-less ç‰ˆæœ¬åº”è¯¥é€šè¿‡å…¨å±€è®°å½•å™¨è®°å½•æ¶ˆæ¯ï¼›è¿™å°±æ˜¯<code>std::println!</code>å·¥ä½œåŸç†ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§æœºåˆ¶æ¥å£°æ˜å…¨å±€è®°å½•å™¨æ˜¯ä»€ä¹ˆï¼›è¿™æ˜¯ç±»ä¼¼äº<code>#[global_allocator]</code>.</p>
<p>å¯èƒ½æ˜¯å…¨å±€è®°å½•å™¨æ˜¯åœ¨ top crate ä¸­å£°æ˜çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¨å±€è®°å½•å™¨çš„ç±»å‹æ˜¯åœ¨ top crate ä¸­å®šä¹‰çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¾èµ–é¡¹<em>æ— æ³•</em>çŸ¥é“å…¨å±€è®°å½•å™¨çš„ç¡®åˆ‡ç±»å‹ã€‚ä¸ºäº†æ”¯æŒè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›é—´æ¥æ€§ã€‚</p>
<p><code>log</code>æˆ‘ä»¬ä¸ä¼šåœ¨crateä¸­å¯¹å…¨å±€è®°å½•å™¨çš„ç±»å‹è¿›è¡Œç¡¬ç¼–ç ï¼Œè€Œæ˜¯åœ¨è¯¥crate ä¸­ä»…å£°æ˜å…¨å±€è®°å½•å™¨çš„<em>æ¥å£</em>ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªæ–°çš„ç‰¹ç‚¹ï¼Œ<code>GlobalLog</code>åˆ°<code>log</code>ç®±å­ã€‚è¯¥<code>log!</code>å®è¿˜å¿…é¡»åˆ©ç”¨è¯¥æ€§çŠ¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/src/lib.rs
#![no_std]

// NEW!
pub trait GlobalLog: Sync {
    fn log(&self, address: u8);
}

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

#[macro_export]
macro_rules! log {
    // NEW!
    ($string:expr) => {
        unsafe {
            extern "Rust" {
                static LOGGER: &'static dyn $crate::GlobalLog;
            }

            #[export_name = $string]
            #[link_section = ".log"]
            static SYMBOL: u8 = 0;

            $crate::GlobalLog::log(LOGGER, &SYMBOL as *const u8 as usize as u8)
        }
    };

    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log"]
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}

// NEW!
#[macro_export]
macro_rules! global_logger {
    ($logger:expr) => {
        #[no_mangle]
        pub static LOGGER: &dyn $crate::GlobalLog = &$logger;
    };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæœ‰å¾ˆå¤šä¸œè¥¿è¦è§£å¼€ã€‚</p>
<p>è®©æˆ‘ä»¬ä»ç‰¹å¾å¼€å§‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> GlobalLog<span class="token punctuation">:</span> Sync <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> u8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>åŒæ–¹<code>GlobalLog</code>å¹¶<code>Log</code>æœ‰ä¸€ä¸ª<code>log</code>æ–¹æ³•ã€‚ä¸åŒä¹‹å¤„åœ¨äºå®ƒ <code>GlobalLog.log</code>é‡‡ç”¨å¯¹æ¥æ”¶è€…çš„å…±äº«å¼•ç”¨ ( <code>&amp;self</code>)ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå…¨å±€è®°å½•å™¨å°†æ˜¯ä¸€ä¸ª<code>static</code>å˜é‡ã€‚ç¨åå†è°ˆã€‚</p>
<p>å¦ä¸€ä¸ªåŒºåˆ«æ˜¯<code>GlobalLog.log</code>ä¸è¿”å› a <code>Result</code>ã€‚è¿™æ„å‘³ç€å®ƒ<em>ä¸èƒ½</em>å‘è°ƒç”¨è€…æŠ¥å‘Šé”™è¯¯ã€‚è¿™ä¸æ˜¯å¯¹ç”¨äºå®ç°å…¨å±€å•ä¾‹çš„ç‰¹å¾çš„ä¸¥æ ¼è¦æ±‚ã€‚å…¨å±€å•ä¾‹ä¸­çš„é”™è¯¯å¤„ç†å¾ˆå¥½ï¼Œä½†æ˜¯<code>log!</code> å®çš„å…¨å±€ç‰ˆæœ¬çš„æ‰€æœ‰ç”¨æˆ·éƒ½å¿…é¡»å°±é”™è¯¯ç±»å‹è¾¾æˆä¸€è‡´ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡è®©<code>GlobalLog</code>å®ç°è€…å¤„ç†é”™è¯¯æ¥ç¨å¾®ç®€åŒ–æ¥å£ã€‚</p>
<p>å¦ä¸€ä¸ªåŒºåˆ«æ˜¯<code>GlobalLog</code>è¦æ±‚å®ç°è€…æ˜¯ <code>Sync</code>ï¼Œå³å®ƒå¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚è¿™æ˜¯å¯¹æ”¾ç½®åœ¨<code>static</code>å˜é‡ä¸­çš„å€¼çš„è¦æ±‚ï¼›å®ƒä»¬çš„ç±»å‹å¿…é¡»å®ç°<code>Sync</code> traitã€‚</p>
<p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œå¯èƒ½ä¸å®Œå…¨æ¸…æ¥šä¸ºä»€ä¹ˆç•Œé¢å¿…é¡»è¿™æ ·ã€‚æ¿æ¡ç®±çš„å…¶ä»–éƒ¨åˆ†å°†ä½¿è¿™ä¸€ç‚¹æ›´æ¸…æ¥šï¼Œæ‰€ä»¥è¯·ç»§ç»­é˜…è¯»ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯<code>log!</code>å®ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token punctuation">(</span>$string<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">extern</span> <span class="token string">"Rust"</span> <span class="token punctuation">{</span>
                <span class="token keyword">static</span> LOGGER<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> dyn $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token attribute attr-name">#[export_name = $string]</span>
            #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span>
            <span class="token keyword">static</span> SYMBOL<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">log</span><span class="token punctuation">(</span>LOGGER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SYMBOL <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“æ²¡æœ‰ç‰¹å®š<code>$logger</code>çš„è°ƒç”¨æ—¶ï¼Œå®ä½¿ç”¨ä¸€ä¸ª<code>extern</code> <code>static</code> è¢«è°ƒç”¨çš„å˜é‡<code>LOGGER</code>æ¥è®°å½•æ¶ˆæ¯ã€‚è¿™ä¸ªå˜é‡<em>æ˜¯</em>åœ¨åˆ«å¤„å®šä¹‰çš„å…¨å±€è®°å½•å™¨ï¼›è¿™å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨<code>extern</code>å—çš„åŸå› ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ªç±»å‹ï¼Œ<code>LOGGER</code>å¦åˆ™ä»£ç ä¸ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ç›®å‰æˆ‘ä»¬ä¸çŸ¥é“ çš„å…·ä½“ç±»å‹ï¼Œ<code>LOGGER</code>ä½†æˆ‘ä»¬çŸ¥é“ï¼Œæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒå®ç°äº†<code>GlobalLog</code>traitï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ trait å¯¹è±¡ã€‚</p>
<p>å®æ‰©å±•çš„å…¶ä½™éƒ¨åˆ†çœ‹èµ·æ¥ä¸å®çš„æœ¬åœ°ç‰ˆæœ¬çš„æ‰©å±•éå¸¸ç›¸ä¼¼ï¼Œ<code>log!</code>å› æ­¤æˆ‘ä¸ä¼šåœ¨è¿™é‡Œè§£é‡Šï¼Œå› ä¸ºå®ƒåœ¨å‰ä¸€ç« ä¸­è§£é‡Š <a href="https://docs.rust-embedded.org/embedonomicon/logging.html" target="_blank" rel="noopener">è¿‡</a>ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“å®ƒ<code>LOGGER</code>å¿…é¡»æ˜¯ä¸€ä¸ª trait å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´æ¸…æ¥šä¸ºä»€ä¹ˆæˆ‘ä»¬<code>Error</code>åœ¨<code>GlobalLog</code>. å¦‚æœæˆ‘ä»¬æ²¡æœ‰çœç•¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†éœ€è¦<code>Error</code>åœ¨<code>LOGGER</code>. è¿™å°±æ˜¯æˆ‘ä¹‹å‰æ‰€è¯´çš„â€œæ‰€æœ‰ç”¨æˆ·<code>log!</code>éƒ½éœ€è¦å°±é”™è¯¯ç±»å‹è¾¾æˆä¸€è‡´â€çš„æ„æ€ã€‚</p>
<p>ç°åœ¨æ˜¯æœ€åä¸€å—ï¼š<code>global_logger!</code>å®ã€‚å®ƒå¯èƒ½æ˜¯ä¸€ä¸ª proc å®å±æ€§ï¼Œä½†ç¼–å†™<code>macro_rules!</code>å®æ›´å®¹æ˜“ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro-rules function">macro_rules!</span> global_logger <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$logger<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[no_mangle]</span>
        <span class="token keyword">pub</span> <span class="token keyword">static</span> LOGGER<span class="token punctuation">:</span> <span class="token operator">&amp;</span>dyn $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog <span class="token operator">=</span> <span class="token operator">&amp;</span>$logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å®åˆ›å»ºä½¿ç”¨çš„<code>LOGGER</code>å˜é‡<code>log!</code>ã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¨³å®šçš„ ABI æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¯¥<code>no_mangle</code>å±æ€§ã€‚è¿™æ ·ï¼Œç¬¦å·åç§°<code>LOGGER</code>å°†æ˜¯â€œLOGGERâ€ï¼Œè¿™æ˜¯<code>log!</code>å®æ‰€æœŸæœ›çš„ã€‚</p>
<p>å¦ä¸€ä¸ªé‡è¦çš„ä¸€ç‚¹æ˜¯è¿™ä¸ªé™æ€å˜é‡çš„ç±»å‹å¿…é¡»ä¸<code>log!</code>å®æ‰©å±•ä¸­ä½¿ç”¨çš„ç±»å‹å®Œå…¨åŒ¹é…ã€‚å¦‚æœå®ƒä»¬ä¸åŒ¹é…ï¼Œåˆ™ä¼šç”±äº ABI ä¸åŒ¹é…è€Œå‘ç”Ÿ Bad Stuffã€‚</p>
<p>è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªä½¿ç”¨æ­¤æ–°å…¨å±€è®°å½•å™¨åŠŸèƒ½çš„ç¤ºä¾‹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m::interrupt;
use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{global_logger, log, GlobalLog};
use rt::entry;

struct Logger;

global_logger!(Logger);

entry!(main);

fn main() -> ! {
    log!("Hello, world!");

    log!("Goodbye");

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}

impl GlobalLog for Logger {
    fn log(&self, address: u8) {
        // we use a critical section (`interrupt::free`) to make the access to the
        // `static mut` variable interrupt safe which is required for memory safety
        interrupt::free(|_| unsafe {
            static mut HSTDOUT: Option<HStdout> = None;

            // lazy initialization
            if HSTDOUT.is_none() {
                HSTDOUT = Some(hio::hstdout()?);
            }

            let hstdout = HSTDOUT.as_mut().unwrap();

            hstdout.write_all(&[address])
        }).ok(); // `.ok()` = ignore errors
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>TODO</strong>ï¼ˆèµ„æºå›¢é˜Ÿï¼‰ åœ¨ç¨³å®šæ—¶ä½¿ç”¨<code>cortex_m::Mutex</code>è€Œä¸æ˜¯<code>static mut</code>å˜é‡<code>const fn</code>ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å¿…é¡»æ·»åŠ <code>cortex-m</code>ä¾èµ–é¡¹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n5 Cargo.toml
[dependencies]
cortex-m = "0.5.7"
cortex-m-semihosting = "0.3.1"
log = { path = "../log" }
rt = { path = "../rt" }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ä¸Šä¸€èŠ‚ä¸­ç¼–å†™çš„ç¤ºä¾‹ä¹‹ä¸€çš„ç§»æ¤ã€‚è¾“å‡ºä¸æˆ‘ä»¬å›åˆ°é‚£é‡Œçš„è¾“å‡ºç›¸åŒã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0001
$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p>ä¸€äº›è¯»è€…å¯èƒ½ä¼šæ‹…å¿ƒå…¨å±€å•ä¾‹çš„è¿™ç§å®ç°ä¸æ˜¯é›¶æˆæœ¬ï¼Œå› ä¸ºå®ƒä½¿ç”¨æ¶‰åŠåŠ¨æ€è°ƒåº¦çš„ trait å¯¹è±¡ï¼Œå³é€šè¿‡ vtable æŸ¥æ‰¾æ‰§è¡Œæ–¹æ³•è°ƒç”¨ã€‚</p>
<p>ä½†æ˜¯ï¼ŒLLVM ä¼¼ä¹è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥åœ¨ä½¿ç”¨ä¼˜åŒ– / LTO è¿›è¡Œç¼–è¯‘æ—¶æ¶ˆé™¤åŠ¨æ€è°ƒåº¦ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨<code>LOGGER</code>ç¬¦å·è¡¨ä¸­æœç´¢æ¥ç¡®è®¤ ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -t | grep LOGGER
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¦‚æœ<code>static</code>ç¼ºå°‘ï¼Œåˆ™æ„å‘³ç€æ²¡æœ‰ vtable å¹¶ä¸” LLVM èƒ½å¤Ÿå°†æ‰€æœ‰<code>LOGGER.log</code>è°ƒç”¨è½¬æ¢ä¸º<code>Logger.log</code>è°ƒç”¨ã€‚</p>
<h1 id="Direct-Memory-Access-DMA"><a href="#Direct-Memory-Access-DMA" class="headerlink" title="Direct Memory Access (DMA)"></a>Direct Memory Access (DMA)</h1><p>æœ¬èŠ‚æ¶µç›–å›´ç»• DMA ä¼ è¾“æ„å»ºå†…å­˜å®‰å…¨ API çš„æ ¸å¿ƒè¦æ±‚ã€‚</p>
<p>DMA å¤–è®¾ç”¨äºä¸å¤„ç†å™¨çš„å·¥ä½œï¼ˆä¸»ç¨‹åºçš„æ‰§è¡Œï¼‰å¹¶è¡Œæ‰§è¡Œå†…å­˜ä¼ è¾“ã€‚DMA ä¼ è¾“æˆ–å¤šæˆ–å°‘ç›¸å½“äºç”Ÿæˆä¸€ä¸ªçº¿ç¨‹ï¼ˆè¯·å‚é˜…<a href="https://doc.rust-lang.org/std/thread/fn.spawn.html" target="_blank" rel="noopener"><code>thread::spawn</code></a>ï¼‰æ¥æ‰§è¡Œ<code>memcpy</code>. æˆ‘ä»¬å°†ä½¿ç”¨ fork-join æ¨¡å‹æ¥è¯´æ˜å†…å­˜å®‰å…¨ API çš„è¦æ±‚ã€‚</p>
<p>è€ƒè™‘ä»¥ä¸‹ DMA åŸè¯­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents a single DMA channel (channel 1 in this case)</span>
<span class="token comment" spellcheck="true">///</span>
<span class="token comment" spellcheck="true">/// This singleton has exclusive access to the registers of the DMA channel 1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Dma1Channel1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Dma1Channel1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Data will be written to this `address`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// `inc` indicates whether the address will be incremented after every byte transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_destination_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> usize<span class="token punctuation">,</span> inc<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Data will be read from this `address`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// `inc` indicates whether the address will be incremented after every byte transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_source_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> usize<span class="token punctuation">,</span> inc<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Number of bytes to transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_transfer_length</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Starts the DMA transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Stops the DMA transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Returns `true` if there's a transfer in progress</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile read</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">in_progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡è®¾<code>Dma1Channel1</code>é™æ€é…ç½®ä¸º<code>Serial1</code>åœ¨ä¸€æ¬¡æ€§æ¨¡å¼ï¼ˆå³éå¾ªç¯æ¨¡å¼ï¼‰ä¸‹ä¸ä¸²è¡Œç«¯å£ï¼ˆAKA UART æˆ– USARTï¼‰#1 ä¸€èµ·ä½¿ç”¨ã€‚ <code>Serial1</code>æä¾›ä»¥ä¸‹<em>é˜»å¡</em>APIï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents serial port #1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Reads out a single byte</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE: blocks if no byte is available to be read</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out a single byte</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE: blocks if the output FIFO buffer is full</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> byte<span class="token punctuation">:</span> u8<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡è®¾æˆ‘ä»¬æƒ³å°†<code>Serial1</code>APIæ‰©å±•ä¸º (a) å¼‚æ­¥å‘é€ç¼“å†²åŒºå’Œ (b) å¼‚æ­¥å¡«å……ç¼“å†²åŒºã€‚</p>
<p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªå†…å­˜ä¸å®‰å…¨çš„ API å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œç›´åˆ°å®ƒå®Œå…¨å†…å­˜å®‰å…¨ã€‚åœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ç ´å APIï¼Œè®©æ‚¨äº†è§£åœ¨å¤„ç†å¼‚æ­¥å†…å­˜æ“ä½œæ—¶éœ€è¦è§£å†³çš„é—®é¢˜ã€‚</p>
<h2 id="A-first-stab"><a href="#A-first-stab" class="headerlink" title="A first stab"></a>A first stab</h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°è¯•ä½¿ç”¨<a href="https://doc.rust-lang.org/std/io/trait.Write.html#method.write_all" target="_blank" rel="noopener"><code>Write::write_all</code></a>API ä½œä¸ºå‚è€ƒã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œè®©æˆ‘ä»¬å¿½ç•¥æ‰€æœ‰é”™è¯¯å¤„ç†ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents serial port #1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: we extend this struct by adding the DMA channel singleton</span>
    dma<span class="token punctuation">:</span> Dma1Channel1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span><span class="token string">'a>(mut self, buffer: &amp;'</span>a <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> B<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Returns `true` if the DMA transfer has finished</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">is_done</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token operator">!</span>Dma1Channel1<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">in_progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> B <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Busy wait until the transfer is done</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>buffer
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong> <code>Transfer</code>å¯ä»¥å…¬å¼€åŸºäºæœŸè´§æˆ–ç”Ÿæˆå™¨çš„ APIï¼Œè€Œä¸æ˜¯ä¸Šé¢æ˜¾ç¤ºçš„ APIã€‚è¿™æ˜¯ä¸€ä¸ª API è®¾è®¡é—®é¢˜ï¼Œä¸æ•´ä¸ª API çš„å†…å­˜å®‰å…¨æ€§å…³ç³»ä¸å¤§ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šåœ¨æœ¬æ–‡ä¸­æ·±å…¥ç ”ç©¶ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å®ç°<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.read_exact" target="_blank" rel="noopener"><code>Read::read_exact</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span><span class="token string">'a>(&amp;mut self, buffer: &amp;'</span>a <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma
            <span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>write_all</code>APIçš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">write</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// fire and forget</span>
    serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// do other stuff</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯ä½¿ç”¨<code>read_exact</code>APIçš„ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// do other stuff</span>

    t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> buf<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">|</span>b<span class="token operator">|</span> <span class="token operator">*</span>b <span class="token operator">==</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">b"some-command"</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* do something */</span> <span class="token punctuation">}</span>
        _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* do something else */</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="mem-forget"><a href="#mem-forget" class="headerlink" title="mem::forget"></a><code>mem::forget</code></h2><p><a href="https://doc.rust-lang.org/std/mem/fn.forget.html" target="_blank" rel="noopener"><code>mem::forget</code></a>æ˜¯ä¸€ä¸ªå®‰å…¨çš„ APIã€‚å¦‚æœæˆ‘ä»¬çš„ API çœŸçš„å®‰å…¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥èƒ½å¤ŸåŒæ—¶ä½¿ç”¨ä¸¤è€…è€Œä¸ä¼šé‡åˆ°æœªå®šä¹‰çš„è¡Œä¸ºã€‚ç„¶è€Œï¼Œäº‹å®å¹¶éå¦‚æ­¤ã€‚è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">unsound</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// start a DMA transfer and forget the returned `Transfer` value</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¼€å§‹ DMA ä¼ è¾“ in <code>start</code>ï¼Œä»¥å¡«å……åœ¨å †æ ˆä¸Šåˆ†é…çš„æ•°ç»„ï¼Œç„¶å<code>mem::forget</code>æ˜¯è¿”å›<code>Transfer</code>å€¼ã€‚ç„¶åæˆ‘ä»¬ç»§ç»­è¿”å›<code>start</code>å¹¶æ‰§è¡Œå‡½æ•°<code>bar</code>ã€‚</p>
<p>è¿™ä¸€ç³»åˆ—æ“ä½œä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚DMA ä¼ è¾“å†™å…¥å †æ ˆå†…å­˜ï¼Œä½†è¯¥å†…å­˜åœ¨<code>start</code>è¿”å›æ—¶è¢«é‡Šæ”¾ï¼Œç„¶åè¢«é‡æ–°<code>bar</code>ç”¨äºåˆ†é…å˜é‡ï¼Œå¦‚<code>x</code>å’Œ<code>y</code>ã€‚åœ¨è¿è¡Œæ—¶ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å˜é‡<code>x</code>å¹¶<code>y</code>éšæœºæ›´æ”¹å…¶å€¼ã€‚DMA ä¼ è¾“è¿˜å¯ä»¥è¦†ç›–ç”±å‡½æ•°çš„åºè¨€æ¨å…¥å †æ ˆçš„çŠ¶æ€ï¼ˆä¾‹å¦‚é“¾æ¥å¯„å­˜å™¨ï¼‰<code>bar</code>ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>mem::forget</code>, but <code>mem::drop</code>ï¼Œåˆ™æœ‰å¯èƒ½ä½¿ make<code>Transfer</code>çš„ææ„å‡½æ•°åœæ­¢ DMA ä¼ è¾“ï¼Œç„¶åç¨‹åºå°±ä¼šæ˜¯å®‰å…¨çš„ã€‚ä½†æ˜¯<em>ä¸èƒ½</em>ä¾é è¿è¡Œçš„ææ„å‡½æ•°æ¥å¼ºåˆ¶æ‰§è¡Œå†…å­˜å®‰å…¨ï¼Œå› ä¸º<code>mem::forget</code>å†…å­˜æ³„æ¼ï¼ˆå‚è§ RC å¾ªç¯ï¼‰åœ¨ Rust ä¸­æ˜¯å®‰å…¨çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜ç¼“å†²åŒºçš„ç”Ÿå­˜æœŸè§£å†³è¿™æ–¹é¢çš„é—®é¢˜ <code>'a</code>ï¼Œä»¥<code>'static</code>åœ¨è¿™ä¸¤ä¸ªAPIã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæˆ‘ä»¬å°è¯•å¤åˆ¶ä¹‹å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°å®ƒ<code>mem::forget</code>ä¸å†å¼•èµ·é—®é¢˜ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[allow(dead_code)]</span>
<span class="token keyword">fn</span> <span class="token function">sound</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE `buf` is moved into `foo`</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> serial<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// start a DMA transfer and forget the returned `Transfer` value</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å’Œä»¥å‰ä¸€æ ·ï¼ŒDMA ä¼ è¾“<code>mem::forget</code>åœ¨<code>Transfer</code> å€¼ä¹‹åç»§ç»­ã€‚è¿™ä¸€æ¬¡ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºå®ƒ<code>buf</code>æ˜¯é™æ€åˆ†é…çš„ï¼ˆä¾‹å¦‚<code>static mut</code>å˜é‡ï¼‰è€Œä¸æ˜¯åœ¨å †æ ˆä¸Šã€‚</p>
<h2 id="é‡å ä½¿ç”¨"><a href="#é‡å ä½¿ç”¨" class="headerlink" title="é‡å ä½¿ç”¨"></a>é‡å ä½¿ç”¨</h2><p>æˆ‘ä»¬çš„ API ä¸ä¼šé˜»æ­¢ç”¨æˆ·<code>Serial</code>åœ¨ DMA ä¼ è¾“è¿‡ç¨‹ä¸­ä½¿ç”¨è¯¥æ¥å£ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¼ è¾“å¤±è´¥æˆ–æ•°æ®ä¸¢å¤±ã€‚</p>
<p>æœ‰å‡ ç§æ–¹æ³•å¯ä»¥é˜²æ­¢é‡å ä½¿ç”¨ã€‚ä¸€ç§æ–¹æ³•æ˜¯<code>Transfer</code> å–å¾—æ‰€æœ‰æƒ<code>Serial1</code>å¹¶åœ¨<code>wait</code>è¢«è°ƒç”¨æ—¶å°†å…¶å½’è¿˜ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> B<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// NOTE: added</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token comment" spellcheck="true">// NOTE: the return value has changed</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>B<span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Busy wait until the transfer is done</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token comment" spellcheck="true">// NOTE we now take `self` by value</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// NOTE: added</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token comment" spellcheck="true">// NOTE we now take `self` by value</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// NOTE: added</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç§»åŠ¨è¯­ä¹‰<code>Serial1</code>åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­é™æ€åœ°é˜»æ­¢è®¿é—®ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// let byte = serial.read(); //~ ERROR: `serial` has been moved</span>

    <span class="token comment" spellcheck="true">// .. do stuff ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>serial<span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do more stuff ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥é˜²æ­¢é‡å ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥<code>Cell</code>å°†æŒ‡ç¤º DMA ä¼ è¾“æ˜¯å¦æ­£åœ¨è¿›è¡Œçš„ ( ) æ ‡å¿—æ·»åŠ åˆ° <code>Serial1</code>. å½“è®¾ç½®æ ‡å¿—æ—¶<code>read</code>ï¼Œ<code>write</code>,<code>read_exact</code>å’Œ<code>write_all</code> éƒ½å°†<code>Error::InUse</code>åœ¨è¿è¡Œæ—¶è¿”å›é”™è¯¯ï¼ˆä¾‹å¦‚ï¼‰ã€‚è¯¥æ ‡å¿—å°†åœ¨ä½¿ç”¨<code>write_all</code>/æ—¶è®¾ç½®<code>read_exact</code>å¹¶åœ¨<code>Transfer.wait</code>.</p>
<h2 id="ç¼–è¯‘å™¨ï¼ˆé”™è¯¯ï¼‰ä¼˜åŒ–"><a href="#ç¼–è¯‘å™¨ï¼ˆé”™è¯¯ï¼‰ä¼˜åŒ–" class="headerlink" title="ç¼–è¯‘å™¨ï¼ˆé”™è¯¯ï¼‰ä¼˜åŒ–"></a>ç¼–è¯‘å™¨ï¼ˆé”™è¯¯ï¼‰ä¼˜åŒ–</h2><p>ç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°é‡æ–°æ’åºå’Œåˆå¹¶éæ˜“å¤±æ€§å­˜å‚¨å™¨æ“ä½œä»¥æ›´å¥½åœ°ä¼˜åŒ–ç¨‹åºã€‚ä½¿ç”¨æˆ‘ä»¬å½“å‰çš„ APIï¼Œè¿™ç§è‡ªç”±å¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reorder</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// zero the buffer (for no particular reason)</span>
    buf<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>byte<span class="token operator">|</span> <span class="token operator">*</span>byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ... do other stuff ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    buf<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œï¼Œç¼–è¯‘å™¨å¯è‡ªç”±ç§»åŠ¨<code>buf.reverse()</code>ä¹‹å‰<code>t.wait()</code>ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®äº‰ç”¨ï¼šä¸¤ä¸ªå¤„ç†å™¨å’ŒDMAæœ€ç»ˆä¼šä¿®æ”¹ <code>buf</code>åœ¨åŒä¸€æ—¶é—´ã€‚ç±»ä¼¼åœ°ï¼Œç¼–è¯‘å™¨å¯ä»¥å°†å½’é›¶æ“ä½œç§»åˆ° after <code>read_exact</code>ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢è¿™äº›æœ‰é—®é¢˜çš„é‡æ–°æ’åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://doc.rust-lang.org/core/sync/atomic/fn.compiler_fence.html" target="_blank" rel="noopener"><code>compiler_fence</code></a></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma
            <span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *write*</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *write*</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>B<span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *read*</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä½¿ç”¨<code>Ordering::Release</code>in<code>read_exact</code>å’Œ<code>write_all</code>æ¥é˜²æ­¢æ‰€æœ‰å‰é¢çš„å†…å­˜æ“ä½œè¢«ç§»åŠ¨åˆ°<em>ä¹‹å</em> <code>self.dma.start()</code>ï¼Œå®ƒæ‰§è¡Œæ˜“å¤±æ€§å†™å…¥ã€‚</p>
<p>åŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>Ordering::Acquire</code>in<code>Transfer.wait</code>æ¥é˜²æ­¢æ‰€æœ‰åç»­å†…å­˜æ“ä½œè¢«ç§»åŠ¨åˆ°<em>ä¹‹å‰</em> <code>self.is_done()</code>ï¼Œå®ƒæ‰§è¡Œæ˜“å¤±æ€§è¯»å–ã€‚</p>
<p>ä¸ºäº†æ›´å¥½åœ°å¯è§†åŒ–å›´æ çš„æ•ˆæœï¼Œè¿™é‡Œæ˜¯ä¸Šä¸€èŠ‚ç¤ºä¾‹çš„ç¨å¾®è°ƒæ•´ç‰ˆæœ¬ã€‚æˆ‘ä»¬åœ¨è¯„è®ºä¸­æ·»åŠ äº†å›´æ åŠå…¶é¡ºåºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reorder</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// zero the buffer (for no particular reason)</span>
    buf<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>byte<span class="token operator">|</span> <span class="token operator">*</span>byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Release) â–²</span>

    <span class="token comment" spellcheck="true">// NOTE: the processor can't access `buf` between the fences</span>
    <span class="token comment" spellcheck="true">// ... do other stuff ..</span>
    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Acquire) â–¼</span>

    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    buf<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”±äºæœ‰ å›´æ ï¼Œè°ƒé›¶æ“ä½œ<em>å*</em>ä¸èƒ½<em>ç§»åŠ¨ã€‚åŒæ ·ï¼Œ</em>ä¹‹å‰<em>ç”±äºå›´æ </em>æ— æ³•<em>ç§»åŠ¨æ“ä½œã€‚ä¸¤ä¸ªå›´æ  *ä¹‹é—´</em>çš„å†…å­˜æ“ä½œ<em>å¯ä»¥</em>è·¨å›´æ è‡ªç”±é‡æ–°æ’åºï¼Œä½†è¿™äº›æ“ä½œéƒ½æ²¡æœ‰æ¶‰åŠï¼Œå› æ­¤æ­¤ç±»é‡æ–°æ’åº<em>ä¸ä¼š</em>å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ <code>read_exact``Release``reverse</code> <code>wait``Acquire``buf</code></p>
<p>è¯·æ³¨æ„ï¼Œè¿™<code>compiler_fence</code>æ¯”æ‰€éœ€çš„è¦å¼ºä¸€äº›ã€‚ä¾‹å¦‚ï¼Œ<code>x</code>å³ä½¿æˆ‘ä»¬çŸ¥é“<code>buf</code>ä¸ä¸<code>x</code>ï¼ˆç”±äº Rust åˆ«åè§„åˆ™ï¼‰é‡å ï¼Œå›´æ ä¹Ÿä¼šé˜»æ­¢æ“ä½œè¢«åˆå¹¶ã€‚ä½†æ˜¯ï¼Œä¸å­˜åœ¨æ¯”<code>compiler_fence</code>.</p>
<h3 id="æˆ‘ä»¬ä¸éœ€è¦å†…å­˜å±éšœå—ï¼Ÿ"><a href="#æˆ‘ä»¬ä¸éœ€è¦å†…å­˜å±éšœå—ï¼Ÿ" class="headerlink" title="æˆ‘ä»¬ä¸éœ€è¦å†…å­˜å±éšœå—ï¼Ÿ"></a>æˆ‘ä»¬ä¸éœ€è¦å†…å­˜å±éšœå—ï¼Ÿ</h3><p>è¿™å–å†³äºç›®æ ‡æ¶æ„ã€‚å¯¹äº Cortex M0 åˆ° M4F å†…æ ¸ï¼Œ <a href="https://static.docs.arm.com/dai0321/a/DAI0321A_programming_guide_memory_barriers_for_m_profile.pdf" target="_blank" rel="noopener">AN321</a>è¡¨ç¤ºï¼š</p>
<blockquote>
<p>3.2 å…¸å‹ç”¨æ³•</p>
<p>(..)</p>
<p>åœ¨ Cortex-M å¤„ç†å™¨ä¸­å¾ˆå°‘éœ€è¦ä½¿ç”¨ DMBï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šé‡æ–°æ’åºå†…å­˜äº‹åŠ¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¦åœ¨å…¶ä»– ARM å¤„ç†å™¨ä¸Šé‡ç”¨è¯¥è½¯ä»¶ï¼Œå°¤å…¶æ˜¯å¤šä¸»ç³»ç»Ÿï¼Œåˆ™éœ€è¦å®ƒã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>DMA æ§åˆ¶å™¨é…ç½®ã€‚CPU å†…å­˜è®¿é—®å’Œ DMA æ“ä½œä¹‹é—´éœ€è¦ä¸€ä¸ªå±éšœã€‚</li>
</ul>
<p>(..)</p>
<p>4.18 å¤šä¸»ç³»ç»Ÿ</p>
<p>(..)</p>
<p>åœ¨ç¬¬ 47 é¡µçš„å›¾ 41 å’Œå›¾ 42 çš„ç¤ºä¾‹ä¸­çœç•¥ DMB æˆ– DSB æŒ‡ä»¤ä¸ä¼šå¯¼è‡´ä»»ä½•é”™è¯¯ï¼Œå› ä¸º Cortex-M å¤„ç†å™¨ï¼š</p>
<ul>
<li>ä¸è¦é‡æ–°æ’åºå†…å­˜ä¼ è¾“</li>
<li>ä¸å…è®¸ä¸¤ä¸ªå†™ä¼ è¾“é‡å ã€‚</li>
</ul>
</blockquote>
<p>å…¶ä¸­å›¾ 41 æ˜¾ç¤ºäº†åœ¨å¼€å§‹ DMA äº‹åŠ¡ä¹‹å‰ä½¿ç”¨çš„ DMBï¼ˆå†…å­˜å±éšœï¼‰æŒ‡ä»¤ã€‚</p>
<p>å¯¹äº Cortex-M7 å†…æ ¸ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æ•°æ®ç¼“å­˜ (DCache)ï¼Œæ‚¨å°†éœ€è¦å†…å­˜å±éšœ (DMB/DSB)ï¼Œé™¤éæ‚¨æ‰‹åŠ¨ä½¿ DMA ä½¿ç”¨çš„ç¼“å†²åŒºæ— æ•ˆã€‚å³ä½¿ç¦ç”¨äº†æ•°æ®ç¼“å­˜ï¼Œä»å¯èƒ½éœ€è¦å†…å­˜å±éšœæ¥é¿å…åœ¨å­˜å‚¨ç¼“å†²åŒºä¸­é‡æ–°æ’åºã€‚</p>
<p>å¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯å¤šæ ¸ç³»ç»Ÿï¼Œé‚£ä¹ˆæ‚¨å¾ˆå¯èƒ½éœ€è¦å†…å­˜å±éšœã€‚</p>
<p>å¦‚æœç¡®å®éœ€è¦å†…å­˜å±éšœï¼Œåˆ™éœ€è¦ä½¿ç”¨<a href="https://doc.rust-lang.org/core/sync/atomic/fn.fence.html" target="_blank" rel="noopener"><code>atomic::fence</code></a>è€Œä¸æ˜¯<code>compiler_fence</code>. è¿™åº”è¯¥ä¼šåœ¨ Cortex-M è®¾å¤‡ä¸Šç”Ÿæˆä¸€æ¡ DMB æŒ‡ä»¤ã€‚</p>
<h2 id="Generic-buffer"><a href="#Generic-buffer" class="headerlink" title="Generic buffer"></a>Generic buffer</h2><p>æˆ‘ä»¬çš„ API æ¯”å®ƒéœ€è¦çš„æ›´å…·é™åˆ¶æ€§ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¨‹åºå³ä½¿æœ‰æ•ˆä¹Ÿä¸ä¼šè¢«æ¥å—ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reuse</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// send a message</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t1<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// `msg` is now `&amp;'static [u8]`</span>

    msg<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// now send it in reverse</span>
    <span class="token keyword">let</span> t2 <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t2<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†æ¥å—è¿™æ ·çš„ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç¼“å†²åŒºå‚æ•°é€šç”¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// as-slice = "0.1.0"</span>
<span class="token keyword">use</span> as_slice<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AsMutSlice<span class="token punctuation">,</span> AsSlice<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> B<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: added</span>
        <span class="token keyword">let</span> slice <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">as_mut_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>slice<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: tweaked</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>ptr <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> B<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: added</span>
        <span class="token keyword">let</span> slice <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>slice<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: tweaked</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>ptr <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨ï¼š</strong> <code>AsRef&lt;[u8]&gt;</code>ï¼ˆ<code>AsMut&lt;[u8]&gt;</code>ï¼‰å¯èƒ½å·²è¢«ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ <code>AsSlice&lt;Element = u8&gt;</code>ï¼ˆ<code>AsMutSlice&lt;Element = u8</code>ï¼‰ã€‚</p>
</blockquote>
<p>ç°åœ¨è¯¥<code>reuse</code>è®¡åˆ’å°†è¢«æ¥å—ã€‚</p>
<h2 id="ä¸å¯ç§»åŠ¨çš„ç¼“å†²åŒº"><a href="#ä¸å¯ç§»åŠ¨çš„ç¼“å†²åŒº" class="headerlink" title="ä¸å¯ç§»åŠ¨çš„ç¼“å†²åŒº"></a>ä¸å¯ç§»åŠ¨çš„ç¼“å†²åŒº</h2><p>é€šè¿‡æ­¤ä¿®æ”¹ï¼ŒAPI è¿˜å°†æŒ‰å€¼æ¥å—æ•°ç»„ï¼ˆä¾‹å¦‚<code>[u8; 16]</code>ï¼‰ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨æ•°ç»„ä¼šå¯¼è‡´æŒ‡é’ˆå¤±æ•ˆã€‚è€ƒè™‘ä»¥ä¸‹ç¨‹åºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">invalidate</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// array allocated in this frame</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>read_exact</code>æ“ä½œå°†ä½¿ç”¨å‡½æ•°çš„<code>buffer</code>æœ¬åœ° åœ°å€<code>start</code>ã€‚è¿”å›<code>buffer</code>æ—¶è¯¥æœ¬åœ°å°†è¢«é‡Šæ”¾ï¼Œ<code>start</code>å¹¶ä¸”ä½¿ç”¨çš„æŒ‡é’ˆ<code>read_exact</code>å°†å¤±æ•ˆã€‚æ‚¨æœ€ç»ˆä¼šé‡åˆ°ä¸<a href="https://docs.rust-embedded.org/embedonomicon/dma.html#dealing-with-memforget" target="_blank" rel="noopener"><code>unsound</code></a>ç¤ºä¾‹ç±»ä¼¼çš„æƒ…å†µã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦æ±‚ä¸æˆ‘ä»¬çš„ API ä¸€èµ·ä½¿ç”¨çš„ç¼“å†²åŒºå³ä½¿åœ¨ç§»åŠ¨æ—¶ä¹Ÿä¿ç•™å…¶å†…å­˜ä½ç½®ã€‚è¯¥<a href="https://doc.rust-lang.org/nightly/std/pin/index.html" target="_blank" rel="noopener"><code>Pin</code></a>NEWTYPEæä¾›è¿™æ ·çš„ä¿è¯ã€‚æˆ‘ä»¬å¯ä»¥æ›´æ–°æˆ‘ä»¬çš„ API ä»¥è¦æ±‚æ‰€æœ‰ç¼“å†²åŒºé¦–å…ˆâ€œå›ºå®šâ€ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>è¦ç¼–è¯‘æ­¤ç‚¹ä»¥ä¸‹çš„æ‰€æœ‰ç¨‹åºï¼Œæ‚¨å°†éœ€è¦ Rust <code>&gt;=1.33.0</code>ã€‚æˆªè‡³æ’°å†™æœ¬æ–‡æ—¶ (2019-01-04)ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨å¤œé—´é¢‘é“ã€‚</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: changed</span>
    buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: bounds changed</span>
        B<span class="token punctuation">:</span> DerefMut<span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: bounds changed</span>
        B<span class="token punctuation">:</span> Deref<span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>æˆ‘ä»¬æœ¬å¯ä»¥ä½¿ç”¨<a href="https://crates.io/crates/stable_deref_trait" target="_blank" rel="noopener"><code>StableDeref</code></a>trait è€Œä¸æ˜¯<code>Pin</code> newtype ä½†é€‰æ‹©äº†<code>Pin</code>å®ƒï¼Œå› ä¸ºå®ƒæ˜¯åœ¨æ ‡å‡†åº“ä¸­æä¾›çš„ã€‚</p>
</blockquote>
<p>é€šè¿‡è¿™ä¸ªæ–° APIï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>&amp;'static mut</code>å¼•ç”¨ã€<code>Box</code>-ed åˆ‡ç‰‡ã€<code>Rc</code>-ed åˆ‡ç‰‡ç­‰ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">static_mut</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">boxed</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="39-static-è¾¹ç•Œ"><a href="#39-static-è¾¹ç•Œ" class="headerlink" title="'static è¾¹ç•Œ"></a><code>'static</code> è¾¹ç•Œ</h2><p>å›ºå®šæ˜¯å¦è®©æˆ‘ä»¬å®‰å…¨åœ°ä½¿ç”¨å †æ ˆåˆ†é…çš„æ•°ç»„ï¼Ÿç­”æ¡ˆæ˜¯<em>å¦å®šçš„</em>ã€‚è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">unsound</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// pin-utils = "0.1.0-alpha.4"</span>
<span class="token keyword">use</span> pin_utils<span class="token punctuation">:</span><span class="token punctuation">:</span>pin_mut<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// pin the `buffer` to this stack frame</span>
    <span class="token comment" spellcheck="true">// `buffer` now has type `Pin&lt;&amp;mut [u8; 16]>`</span>
    <span class="token function">pin_mut!</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚å‰æ‰€è¿°ï¼Œç”±äºå †æ ˆå¸§æŸåï¼Œä¸Šè¿°ç¨‹åºä¼šé‡åˆ°æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<p>è¯¥APIä¸å¥å…¨ç±»å‹çš„ç¼“å†²åŒº<code>Pin&lt;&amp;'a mut [u8]&gt;</code>ï¼Œå…¶ä¸­<code>'a</code>æ˜¯<em>ä¸æ˜¯</em> <code>'static</code>ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»<code>'static</code>åœ¨æŸäº›åœ°æ–¹æ·»åŠ ä¸€ä¸ªè¾¹ç•Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: added 'static bound</span>
        B<span class="token punctuation">:</span> DerefMut <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: added 'static bound</span>
        B<span class="token punctuation">:</span> Deref <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨æœ‰é—®é¢˜çš„ç¨‹åºå°†è¢«æ‹’ç»ã€‚</p>
<h2 id="ææ„å‡½æ•°"><a href="#ææ„å‡½æ•°" class="headerlink" title="ææ„å‡½æ•°"></a>ææ„å‡½æ•°</h2><p>ç°åœ¨ API æ¥å—<code>Box</code>-es å’Œå…¶ä»–å…·æœ‰ææ„å‡½æ•°çš„ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šåœ¨<code>Transfer</code>æå‰åˆ é™¤æ—¶åšä»€ä¹ˆã€‚</p>
<p>é€šå¸¸ï¼Œ<code>Transfer</code>ä½¿ç”¨è¯¥<code>wait</code>æ–¹æ³•ä½¿ç”¨å€¼ï¼Œä½†ä¹Ÿå¯ä»¥éšå¼æˆ–æ˜¾å¼åœ°<code>drop</code>åœ¨ä¼ è¾“ç»“æŸä¹‹å‰ä½¿ç”¨è¯¥å€¼ã€‚ä¾‹å¦‚ï¼Œåˆ é™¤ä¸€ä¸ª<code>Transfer&lt;Box&lt;[u8]&gt;&gt;</code>å€¼å°†å¯¼è‡´ç¼“å†²åŒºè¢«é‡Šæ”¾ã€‚å¦‚æœä¼ è¾“ä»åœ¨è¿›è¡Œä¸­ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› ä¸º DMA æœ€ç»ˆä¼šå†™å…¥å·²é‡Šæ”¾çš„å†…å­˜ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ç§é€‰æ‹©æ˜¯<code>Transfer.drop</code>åœæ­¢ DMA ä¼ è¾“ã€‚å¦ä¸€ç§é€‰æ‹©æ˜¯<code>Transfer.drop</code>ç­‰å¾…ä¼ è¾“å®Œæˆã€‚æˆ‘ä»¬ä¼šé€‰æ‹©å‰è€…ï¼Œå› ä¸ºå®ƒæ›´ä¾¿å®œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: always `Some` variant</span>
    inner<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Inner<span class="token operator">&lt;</span>B<span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// NOTE: previously named `Transfer&lt;B>`</span>
<span class="token keyword">struct</span> Inner<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> inner <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token operator">||</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> hint<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">unreachable_unchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>inner<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> inner<span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Drop <span class="token keyword">for</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// NOTE: this is a volatile write</span>
            inner<span class="token punctuation">.</span>serial<span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// we need a read here to make the Acquire fence effective</span>
            <span class="token comment" spellcheck="true">// we do *not* need this if `dma.stop` does a RMW operation</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// we need a fence here for the same reason we need one in `Transfer.wait`</span>
            atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> DerefMut <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Inner <span class="token punctuation">{</span>
                buffer<span class="token punctuation">,</span>
                serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> Deref <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Inner <span class="token punctuation">{</span>
                buffer<span class="token punctuation">,</span>
                serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ DMA ä¼ è¾“å°†åœ¨é‡Šæ”¾ç¼“å†²åŒºä¹‹å‰åœæ­¢ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reuse</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Release) â–²</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token comment" spellcheck="true">// this stops the DMA transfer and frees memory</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">drop</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Acquire) â–¼</span>

    <span class="token comment" spellcheck="true">// this likely reuses the previous memory allocation</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="æ¦‚æ‹¬-1"><a href="#æ¦‚æ‹¬-1" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h2><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå®ç°å†…å­˜å®‰å…¨çš„DMAä¼ è¾“éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨ä¸å¯ç§»åŠ¨çš„ç¼“å†²åŒºåŠ ä¸Šé—´æ¥ï¼š<code>Pin&lt;B&gt;</code>ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>StableDeref</code>traitã€‚</li>
<li>ç¼“å†²åŒºçš„æ‰€æœ‰æƒå¿…é¡»ä¼ é€’ç»™ DMA : <code>B: 'static</code>ã€‚</li>
<li>ä¸è¦<em>ä¸</em>ä¾èµ–äºå­˜å‚¨å®‰å…¨è¿è¡Œææ„å‡½æ•°ã€‚è€ƒè™‘å¦‚æœ<code>mem::forget</code>ä¸æ‚¨çš„ API ä¸€èµ·ä½¿ç”¨ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</li>
<li><em>ä¸è¦</em>ä¸ºå®ƒæ·»åŠ è‡ªå®šä¹‰çš„ææ„åœæ­¢DMAä¼ è¾“ï¼Œæˆ–è€…ç­‰å¾…åˆ°ç»“æŸã€‚è€ƒè™‘å¦‚æœ<code>mem::drop</code>ä¸æ‚¨çš„ API ä¸€èµ·ä½¿ç”¨ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</li>
</ul>
<hr>
<p>æœ¬æ–‡çœç•¥äº†æ„å»ºç”Ÿäº§çº§ DMA æŠ½è±¡æ‰€éœ€çš„å‡ ä¸ªç»†èŠ‚ï¼Œä¾‹å¦‚é…ç½® DMA é€šé“ï¼ˆä¾‹å¦‚æµã€å¾ªç¯ä¸å•æ¬¡æ¨¡å¼ç­‰ï¼‰ã€ç¼“å†²åŒºå¯¹é½ã€é”™è¯¯å¤„ç†ã€å¦‚ä½•åˆ¶ä½œæŠ½è±¡è®¾å¤‡ -ä¸å¯çŸ¥è®ºç­‰ã€‚æ‰€æœ‰è¿™äº›æ–¹é¢éƒ½ç•™ç»™è¯»è€…/ç¤¾åŒºä½œä¸ºç»ƒä¹ ï¼ˆ<code>:P</code>ï¼‰ã€‚</p>
<h1 id="å…³äºç¼–è¯‘å™¨æ”¯æŒçš„è¯´æ˜"><a href="#å…³äºç¼–è¯‘å™¨æ”¯æŒçš„è¯´æ˜" class="headerlink" title="å…³äºç¼–è¯‘å™¨æ”¯æŒçš„è¯´æ˜"></a>å…³äºç¼–è¯‘å™¨æ”¯æŒçš„è¯´æ˜</h1><p>æœ¬ä¹¦ä½¿ç”¨äº†ä¸€ä¸ªå†…ç½®çš„<em>ç¼–è¯‘å™¨</em>ç›®æ ‡ ï¼Œ<code>thumbv7m-none-eabi</code>Rust å›¢é˜Ÿä¸ºå…¶åˆ†å‘äº†ä¸€ä¸ª<code>rust-std</code>ç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢„ç¼–è¯‘çš„ crate é›†åˆï¼Œå¦‚<a href="https://doc.rust-lang.org/core/index.html" target="_blank" rel="noopener"><code>core</code></a> å’Œ<a href="https://doc.rust-lang.org/std/index.html" target="_blank" rel="noopener"><code>std</code></a>ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³å°è¯•ä¸ºä¸åŒçš„ç›®æ ‡æ¶æ„å¤åˆ¶æœ¬ä¹¦çš„å†…å®¹ï¼Œæ‚¨éœ€è¦è€ƒè™‘ Rust ä¸ºï¼ˆç¼–è¯‘ï¼‰ç›®æ ‡æä¾›çš„ä¸åŒçº§åˆ«çš„æ”¯æŒã€‚</p>
<h2 id="LLVM-æ”¯æŒ"><a href="#LLVM-æ”¯æŒ" class="headerlink" title="LLVM æ”¯æŒ"></a>LLVM æ”¯æŒ</h2><p>ä» Rust 1.28 å¼€å§‹ï¼Œå®˜æ–¹çš„ Rust ç¼–è¯‘å™¨<code>rustc</code>ä½¿ç”¨ LLVM æ¥ç”Ÿæˆï¼ˆæœºå™¨ï¼‰ä»£ç ã€‚Rust ä¸ºæ¶æ„æä¾›çš„æœ€ä½çº§åˆ«æ”¯æŒæ˜¯åœ¨ <code>rustc</code>. æ‚¨å¯ä»¥<code>rustc</code>é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡ LLVMæŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æ¶æ„ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ # you need to have `cargo-binutils` installed to run this command
$ cargo objdump -- -version
LLVM (http://llvm.org/):
  LLVM version 7.0.0svn
  Optimized build.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: skylake

  Registered Targets:
    aarch64    - AArch64 (little endian)
    aarch64_be - AArch64 (big endian)
    arm        - ARM
    arm64      - ARM64 (little endian)
    armeb      - ARM (big endian)
    hexagon    - Hexagon
    mips       - Mips
    mips64     - Mips64 [experimental]
    mips64el   - Mips64el [experimental]
    mipsel     - Mipsel
    msp430     - MSP430 [experimental]
    nvptx      - NVIDIA PTX 32-bit
    nvptx64    - NVIDIA PTX 64-bit
    ppc32      - PowerPC 32
    ppc64      - PowerPC 64
    ppc64le    - PowerPC 64 LE
    sparc      - Sparc
    sparcel    - Sparc LE
    sparcv9    - Sparc V9
    systemz    - SystemZ
    thumb      - Thumb
    thumbeb    - Thumb (big endian)
    wasm32     - WebAssembly 32-bit
    wasm64     - WebAssembly 64-bit
    x86        - 32-bit X86: Pentium-Pro and above
    x86-64     - 64-bit X86: EM64T and AMD64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœ LLVM æ”¯æŒæ‚¨æ„Ÿå…´è¶£çš„æ¶æ„ï¼Œä½†<code>rustc</code>æ„å»ºæ—¶ç¦ç”¨äº†åç«¯ï¼ˆè¿™æ˜¯ Rust 1.28 ä¸­çš„ AVR çš„æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆæ‚¨å°†éœ€è¦ä¿®æ”¹ Rust æºä»¥å¯ç”¨å®ƒã€‚PR <a href="https://github.com/rust-lang/rust/pull/52787" target="_blank" rel="noopener">rust-lang/rust#52787</a>çš„å‰ä¸¤æ¬¡æäº¤è®©æ‚¨äº†è§£æ‰€éœ€çš„æ›´æ”¹ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ LLVM ä¸æ”¯æŒè¯¥æ¶æ„ï¼Œä½† LLVM çš„ä¸€ä¸ªåˆ†æ”¯æ”¯æŒï¼Œåˆ™åœ¨æ„å»º<code>rustc</code>. Rust æ„å»ºç³»ç»Ÿå…è®¸è¿™æ ·åšï¼ŒåŸåˆ™ä¸Šå®ƒåº”è¯¥åªéœ€è¦æ›´æ”¹<code>llvm</code>å­æ¨¡å—ä»¥æŒ‡å‘ forkã€‚</p>
<p>å¦‚æœæ‚¨çš„ç›®æ ‡æ¶æ„ä»…ç”±æŸäº›ä¾›åº”å•†æä¾›çš„ GCC æ”¯æŒï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨<a href="https://github.com/thepowersgang/mrustc" target="_blank" rel="noopener"><code>mrustc</code></a>ï¼Œä¸€ä¸ªéå®˜æ–¹çš„ Rust ç¼–è¯‘å™¨ï¼Œå°†æ‚¨çš„ Rust ç¨‹åºè½¬æ¢ä¸º C ä»£ç ï¼Œç„¶åä½¿ç”¨ GCC ç¼–è¯‘å®ƒã€‚</p>
<h2 id="å†…ç½®ç›®æ ‡"><a href="#å†…ç½®ç›®æ ‡" class="headerlink" title="å†…ç½®ç›®æ ‡"></a>å†…ç½®ç›®æ ‡</h2><p>ç¼–è¯‘ç›®æ ‡ä¸ä»…ä»…æ˜¯å®ƒçš„æ¶æ„ã€‚æ¯ä¸ªç›®æ ‡éƒ½æœ‰ä¸€ä¸ª ä¸å…¶ç›¸å…³è”çš„<a href="https://github.com/rust-lang/rfcs/blob/master/text/0131-target-specification.md" target="_blank" rel="noopener">è§„èŒƒ</a>ï¼Œå…¶ä¸­æè¿°äº†å…¶ä½“ç³»ç»“æ„ã€æ“ä½œç³»ç»Ÿå’Œé»˜è®¤é“¾æ¥å™¨ã€‚</p>
<p>Rust ç¼–è¯‘å™¨çŸ¥é“å‡ ä¸ªç›®æ ‡ã€‚è¿™äº›<em>å†…ç½®</em>åœ¨ç¼–è¯‘å™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ—å‡ºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc --print target-list | column
aarch64-fuchsia                   mipsisa32r6el-unknown-linux-gnu
aarch64-linux-android             mipsisa64r6-unknown-linux-gnuabi64
aarch64-pc-windows-msvc           mipsisa64r6el-unknown-linux-gnuabi64
aarch64-unknown-cloudabi          msp430-none-elf
aarch64-unknown-freebsd           nvptx64-nvidia-cuda
aarch64-unknown-hermit            powerpc-unknown-linux-gnu
aarch64-unknown-linux-gnu         powerpc-unknown-linux-gnuspe
aarch64-unknown-linux-musl        powerpc-unknown-linux-musl
aarch64-unknown-netbsd            powerpc-unknown-netbsd
aarch64-unknown-none              powerpc-wrs-vxworks
aarch64-unknown-none-softfloat    powerpc-wrs-vxworks-spe
aarch64-unknown-openbsd           powerpc64-unknown-freebsd
aarch64-unknown-redox             powerpc64-unknown-linux-gnu
aarch64-uwp-windows-msvc          powerpc64-unknown-linux-musl
aarch64-wrs-vxworks               powerpc64-wrs-vxworks
arm-linux-androideabi             powerpc64le-unknown-linux-gnu
arm-unknown-linux-gnueabi         powerpc64le-unknown-linux-musl
arm-unknown-linux-gnueabihf       riscv32i-unknown-none-elf
arm-unknown-linux-musleabi        riscv32imac-unknown-none-elf
arm-unknown-linux-musleabihf      riscv32imc-unknown-none-elf
armebv7r-none-eabi                riscv64gc-unknown-linux-gnu
armebv7r-none-eabihf              riscv64gc-unknown-none-elf
armv4t-unknown-linux-gnueabi      riscv64imac-unknown-none-elf
armv5te-unknown-linux-gnueabi     s390x-unknown-linux-gnu
armv5te-unknown-linux-musleabi    sparc-unknown-linux-gnu
armv6-unknown-freebsd             sparc64-unknown-linux-gnu
armv6-unknown-netbsd-eabihf       sparc64-unknown-netbsd
armv7-linux-androideabi           sparc64-unknown-openbsd
armv7-unknown-cloudabi-eabihf     sparcv9-sun-solaris
armv7-unknown-freebsd             thumbv6m-none-eabi
armv7-unknown-linux-gnueabi       thumbv7a-pc-windows-msvc
armv7-unknown-linux-gnueabihf     thumbv7em-none-eabi
armv7-unknown-linux-musleabi      thumbv7em-none-eabihf
armv7-unknown-linux-musleabihf    thumbv7m-none-eabi
armv7-unknown-netbsd-eabihf       thumbv7neon-linux-androideabi
armv7-wrs-vxworks-eabihf          thumbv7neon-unknown-linux-gnueabihf
armv7a-none-eabi                  thumbv7neon-unknown-linux-musleabihf
armv7a-none-eabihf                thumbv8m.base-none-eabi
armv7r-none-eabi                  thumbv8m.main-none-eabi
armv7r-none-eabihf                thumbv8m.main-none-eabihf
asmjs-unknown-emscripten          wasm32-unknown-emscripten
hexagon-unknown-linux-musl        wasm32-unknown-unknown
i586-pc-windows-msvc              wasm32-wasi
i586-unknown-linux-gnu            x86_64-apple-darwin
i586-unknown-linux-musl           x86_64-fortanix-unknown-sgx
i686-apple-darwin                 x86_64-fuchsia
i686-linux-android                x86_64-linux-android
i686-pc-windows-gnu               x86_64-linux-kernel
i686-pc-windows-msvc              x86_64-pc-solaris
i686-unknown-cloudabi             x86_64-pc-windows-gnu
i686-unknown-freebsd              x86_64-pc-windows-msvc
i686-unknown-haiku                x86_64-rumprun-netbsd
i686-unknown-linux-gnu            x86_64-sun-solaris
i686-unknown-linux-musl           x86_64-unknown-cloudabi
i686-unknown-netbsd               x86_64-unknown-dragonfly
i686-unknown-openbsd              x86_64-unknown-freebsd
i686-unknown-uefi                 x86_64-unknown-haiku
i686-uwp-windows-gnu              x86_64-unknown-hermit
i686-uwp-windows-msvc             x86_64-unknown-hermit-kernel
i686-wrs-vxworks                  x86_64-unknown-illumos
mips-unknown-linux-gnu            x86_64-unknown-l4re-uclibc
mips-unknown-linux-musl           x86_64-unknown-linux-gnu
mips-unknown-linux-uclibc         x86_64-unknown-linux-gnux32
mips64-unknown-linux-gnuabi64     x86_64-unknown-linux-musl
mips64-unknown-linux-muslabi64    x86_64-unknown-netbsd
mips64el-unknown-linux-gnuabi64   x86_64-unknown-openbsd
mips64el-unknown-linux-muslabi64  x86_64-unknown-redox
mipsel-unknown-linux-gnu          x86_64-unknown-uefi
mipsel-unknown-linux-musl         x86_64-uwp-windows-gnu
mipsel-unknown-linux-uclibc       x86_64-uwp-windows-msvc
mipsisa32r6-unknown-linux-gnu     x86_64-wrs-vxworks<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“å°è¿™äº›ç›®æ ‡ä¹‹ä¸€çš„è§„èŒƒï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc +nightly -Z unstable-options --print target-spec-json --target thumbv7m-none-eabi
{
  "abi-blacklist": [
    "stdcall",
    "fastcall",
    "vectorcall",
    "thiscall",
    "win64",
    "sysv64"
  ],
  "arch": "arm",
  "data-layout": "e-m:e-p:32:32-i64:64-v128:64:128-a:0:32-n32-S64",
  "emit-debug-gdb-scripts": false,
  "env": "",
  "executables": true,
  "is-builtin": true,
  "linker": "arm-none-eabi-gcc",
  "linker-flavor": "gcc",
  "llvm-target": "thumbv7m-none-eabi",
  "max-atomic-width": 32,
  "os": "none",
  "panic-strategy": "abort",
  "relocation-model": "static",
  "target-c-int-width": "32",
  "target-endian": "little",
  "target-pointer-width": "32",
  "vendor": ""
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœè¿™äº›å†…ç½®ç›®æ ‡ä¼¼ä¹éƒ½ä¸é€‚åˆæ‚¨çš„ç›®æ ‡ç³»ç»Ÿï¼Œåˆ™å¿…é¡»é€šè¿‡ç¼–å†™è‡ªå·±çš„ JSON æ ¼å¼çš„ç›®æ ‡è§„èŒƒæ–‡ä»¶æ¥åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡ï¼Œ<a href="https://docs.rust-embedded.org/embedonomicon/custom-target.html" target="_blank" rel="noopener">ä¸‹ä¸€èŠ‚</a>å°†å¯¹æ­¤è¿›è¡Œä»‹ç» ã€‚</p>
<h2 id="rust-std-æˆåˆ†"><a href="#rust-std-æˆåˆ†" class="headerlink" title="rust-std æˆåˆ†"></a><code>rust-std</code> æˆåˆ†</h2><p>å¯¹äºä¸€äº›å†…ç½®ç›®æ ‡ï¼ŒRust å›¢é˜Ÿ<code>rust-std</code>é€šè¿‡<code>rustup</code>. è¿™ä¸ªç»„ä»¶æ˜¯ä¸€ä¸ªé¢„ç¼–è¯‘çš„ crate çš„é›†åˆï¼Œæ¯”å¦‚<code>core</code>å’Œ<code>std</code>ï¼Œäº¤å‰ç¼–è¯‘éœ€è¦å®ƒã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°å…·æœ‰<code>rust-std</code>å¯ç”¨ç»„ä»¶çš„ç›®æ ‡åˆ—è¡¨<code>rustup</code>ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup target list | column
aarch64-apple-ios                       mipsel-unknown-linux-musl
aarch64-fuchsia                         nvptx64-nvidia-cuda
aarch64-linux-android                   powerpc-unknown-linux-gnu
aarch64-pc-windows-msvc                 powerpc64-unknown-linux-gnu
aarch64-unknown-linux-gnu               powerpc64le-unknown-linux-gnu
aarch64-unknown-linux-musl              riscv32i-unknown-none-elf
aarch64-unknown-none                    riscv32imac-unknown-none-elf
aarch64-unknown-none-softfloat          riscv32imc-unknown-none-elf
arm-linux-androideabi                   riscv64gc-unknown-linux-gnu
arm-unknown-linux-gnueabi               riscv64gc-unknown-none-elf
arm-unknown-linux-gnueabihf             riscv64imac-unknown-none-elf
arm-unknown-linux-musleabi              s390x-unknown-linux-gnu
arm-unknown-linux-musleabihf            sparc64-unknown-linux-gnu
armebv7r-none-eabi                      sparcv9-sun-solaris
armebv7r-none-eabihf                    thumbv6m-none-eabi
armv5te-unknown-linux-gnueabi           thumbv7em-none-eabi
armv5te-unknown-linux-musleabi          thumbv7em-none-eabihf
armv7-linux-androideabi                 thumbv7m-none-eabi
armv7-unknown-linux-gnueabi             thumbv7neon-linux-androideabi
armv7-unknown-linux-gnueabihf           thumbv7neon-unknown-linux-gnueabihf
armv7-unknown-linux-musleabi            thumbv8m.base-none-eabi
armv7-unknown-linux-musleabihf          thumbv8m.main-none-eabi
armv7a-none-eabi                        thumbv8m.main-none-eabihf
armv7r-none-eabi                        wasm32-unknown-emscripten
armv7r-none-eabihf                      wasm32-unknown-unknown
asmjs-unknown-emscripten                wasm32-wasi
i586-pc-windows-msvc                    x86_64-apple-darwin
i586-unknown-linux-gnu                  x86_64-apple-ios
i586-unknown-linux-musl                 x86_64-fortanix-unknown-sgx
i686-linux-android                      x86_64-fuchsia
i686-pc-windows-gnu                     x86_64-linux-android
i686-pc-windows-msvc                    x86_64-pc-windows-gnu
i686-unknown-freebsd                    x86_64-pc-windows-msvc
i686-unknown-linux-gnu                  x86_64-rumprun-netbsd
i686-unknown-linux-musl                 x86_64-sun-solaris
mips-unknown-linux-gnu                  x86_64-unknown-cloudabi
mips-unknown-linux-musl                 x86_64-unknown-freebsd
mips64-unknown-linux-gnuabi64           x86_64-unknown-linux-gnu (default)
mips64-unknown-linux-muslabi64          x86_64-unknown-linux-gnux32
mips64el-unknown-linux-gnuabi64         x86_64-unknown-linux-musl
mips64el-unknown-linux-muslabi64        x86_64-unknown-netbsd
mipsel-unknown-linux-gnu                x86_64-unknown-redox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœ<code>rust-std</code>æ‚¨çš„ç›®æ ‡æ²¡æœ‰ç»„ä»¶ï¼Œæˆ–è€…æ‚¨ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰ç›®æ ‡ï¼Œé‚£ä¹ˆæ‚¨å°†ä¸å¾—ä¸ä½¿ç”¨å¤œé—´å·¥å…·é“¾æ¥æ„å»ºæ ‡å‡†åº“ã€‚</p>
<h1 id="åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡"><a href="#åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡"></a>åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡</h1><p>å¦‚æœè‡ªå®šä¹‰ç›®æ ‡ä¸‰å…ƒç»„ä¸é€‚ç”¨äºæ‚¨çš„å¹³å°ï¼Œæ‚¨å¿…é¡»åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç›®æ ‡æ–‡ä»¶ï¼Œå°†æ‚¨çš„ç›®æ ‡æè¿°ä¸º rustcã€‚</p>
<p>è¯·è®°ä½ï¼Œéœ€è¦ä½¿ç”¨å¤œé—´ç¼–è¯‘å™¨æ¥æ„å»ºæ ¸å¿ƒåº“ï¼Œè¿™å¿…é¡»é’ˆå¯¹ rustc æœªçŸ¥çš„ç›®æ ‡å®Œæˆã€‚</p>
<h2 id="ç¡®å®šç›®æ ‡ä¸‰å…ƒç»„"><a href="#ç¡®å®šç›®æ ‡ä¸‰å…ƒç»„" class="headerlink" title="ç¡®å®šç›®æ ‡ä¸‰å…ƒç»„"></a>ç¡®å®šç›®æ ‡ä¸‰å…ƒç»„</h2><p>è®¸å¤šç›®æ ‡å·²ç»æœ‰ä¸€ä¸ªå·²çŸ¥çš„ä¸‰å…ƒç»„æ¥æè¿°å®ƒä»¬ï¼Œé€šå¸¸é‡‡ç”¨ ARCH-VENDOR-SYS-ABI çš„å½¢å¼ã€‚ä½ çš„ç›®æ ‡åº”è¯¥æ˜¯ä½¿ç”¨ä¸<a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple" target="_blank" rel="noopener">LLVM</a>ç›¸åŒçš„ä¸‰å…ƒç»„ï¼›ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦å‘ Rust æŒ‡å®š LLVM ä¸çŸ¥é“çš„å…¶ä»–ä¿¡æ¯ï¼Œåˆ™å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚è™½ç„¶ä¸‰å…ƒç»„åœ¨æŠ€æœ¯ä¸Šä»…ä¾›äººç±»ä½¿ç”¨ï¼Œä½†å®ƒçš„ç‹¬ç‰¹æ€§å’Œæè¿°æ€§å¾ˆé‡è¦ï¼Œå°¤å…¶æ˜¯å¦‚æœç›®æ ‡å°†æ¥ä¼šè¢«ä¸Šæ¸¸ã€‚</p>
<p>ARCH éƒ¨åˆ†é€šå¸¸åªæ˜¯æ¶æ„åç§°ï¼Œ32 ä½ ARM é™¤å¤–ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¼šä¸ºè¿™äº›å¤„ç†å™¨ä½¿ç”¨ x86_64ï¼Œä½†è¦æŒ‡å®šç¡®åˆ‡çš„ ARM æ¶æ„ç‰ˆæœ¬ã€‚å…¸å‹å€¼å¯èƒ½æ˜¯<code>armv7</code>ï¼Œ<code>armv5te</code>æˆ–<code>thumbv7neon</code>ã€‚æŸ¥çœ‹<a href="https://docs.rust-embedded.org/embedonomicon/compiler-support.html#built-in-target" target="_blank" rel="noopener">å†…ç½®ç›®æ ‡</a>çš„åç§°ä»¥è·å¾—çµæ„Ÿã€‚</p>
<p>VENDOR éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œå®ƒæè¿°äº†åˆ¶é€ å•†ã€‚çœç•¥æ­¤å­—æ®µä¸ä½¿ç”¨<code>unknown</code>.</p>
<p>SYS éƒ¨åˆ†æè¿°äº†æ‰€ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿã€‚ å¯¹äºæ¡Œé¢å¹³å°ï¼Œå…¸å‹å€¼åŒ…æ‹¬<code>win32</code>ã€<code>linux</code>å’Œ<code>darwin</code>ã€‚<code>none</code>ç”¨äºè£¸æœºä½¿ç”¨ã€‚</p>
<p>ABI éƒ¨åˆ†æè¿°äº†æµç¨‹æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚<code>eabi</code>ç”¨äºè£¸æœºï¼Œè€Œ<code>gnu</code>ç”¨äº glibcã€<code>musl</code>musl ç­‰ã€‚</p>
<p>ç°åœ¨æ‚¨æœ‰äº†ä¸€ä¸ªç›®æ ‡ä¸‰å…ƒç»„ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸‰å…ƒç»„åç§°å’Œ<code>.json</code> æ‰©å±•åçš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œæè¿°çš„æ–‡ä»¶<code>armv7a-none-eabi</code>å°†å…·æœ‰æ–‡ä»¶å <code>armv7a-none-eabi.json</code>ã€‚</p>
<h2 id="å¡«å……ç›®æ ‡æ–‡ä»¶"><a href="#å¡«å……ç›®æ ‡æ–‡ä»¶" class="headerlink" title="å¡«å……ç›®æ ‡æ–‡ä»¶"></a>å¡«å……ç›®æ ‡æ–‡ä»¶</h2><p>ç›®æ ‡æ–‡ä»¶å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSONã€‚æœ‰ä¸¤ä¸ªåœ°æ–¹æè¿°äº†å®ƒçš„å†…å®¹ï¼š <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.Target.html" target="_blank" rel="noopener"><code>Target</code></a>ï¼Œå…¶ä¸­æ¯ä¸ªå­—æ®µéƒ½æ˜¯å¿…éœ€çš„ï¼Œä»¥åŠ<a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.TargetOptions.html" target="_blank" rel="noopener"><code>TargetOptions</code></a>ï¼Œæ¯ä¸ªå­—æ®µéƒ½æ˜¯å¯é€‰çš„ã€‚ <strong>æ‰€æœ‰ä¸‹åˆ’çº¿éƒ½æ›¿æ¢ä¸ºè¿å­—ç¬¦</strong>ã€‚</p>
<p>æ¨èçš„æ–¹æ³•æ˜¯å°†ç›®æ ‡æ–‡ä»¶åŸºäºä¸ç›®æ ‡ç³»ç»Ÿç›¸ä¼¼çš„å†…ç½®ç›®æ ‡çš„è§„èŒƒï¼Œç„¶åè°ƒæ•´å®ƒä»¥åŒ¹é…ç›®æ ‡ç³»ç»Ÿçš„å±æ€§ã€‚ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨å‘½ä»¤ <code>rustc +nightly -Z unstable-options --print target-spec-json --target $SOME_SIMILAR_TARGET</code>ï¼Œä½¿ç”¨ <a href="https://docs.rust-embedded.org/embedonomicon/compiler-support.html#built-in-target" target="_blank" rel="noopener">ç¼–è¯‘å™¨ä¸­å·²å†…ç½®çš„ç›®æ ‡</a>ã€‚</p>
<p>æ‚¨å‡ ä¹å¯ä»¥å°†è¯¥è¾“å‡ºå¤åˆ¶åˆ°æ‚¨çš„æ–‡ä»¶ä¸­ã€‚ä»ä¸€äº›ä¿®æ”¹å¼€å§‹ï¼š</p>
<ul>
<li><p>æ¶ˆé™¤ <code>"is-builtin": true</code></p>
</li>
<li><p>å¡«å……<code>llvm-target</code>ç”¨çš„<a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple" target="_blank" rel="noopener">ä¸‰å€LLVMé¢„æœŸ</a></p>
</li>
<li><p>å†³å®šä¸€ä¸ªææ…Œçš„ç­–ç•¥ã€‚è£¸æœºå®ç°å¯èƒ½ä¼šä½¿ç”¨ <code>"panic-strategy": "abort"</code>. å¦‚æœä½ å†³å®šä¸<code>abort</code>ææ…Œï¼Œé™¤éä½ <a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html#eh_personality" target="_blank" rel="noopener">å‘Šè¯‰ Cargo</a>æ¯ä¸ªé¡¹ç›®ï¼Œä½ å¿…é¡»å®šä¹‰ä¸€ä¸ª<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html#eh_personality" target="_blank" rel="noopener">eh_personality</a>å‡½æ•°ã€‚</p>
</li>
<li><p>é…ç½®åŸå­ã€‚é€‰æ‹©æè¿°æ‚¨çš„ç›®æ ‡çš„ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>æˆ‘æœ‰ä¸€ä¸ªå•æ ¸å¤„ç†å™¨ï¼Œæ²¡æœ‰çº¿ç¨‹ï¼Œ<a href="https://github.com/rust-lang/rust/issues/58500#issuecomment-654341233" target="_blank" rel="noopener"><strong>æ²¡æœ‰ä¸­æ–­</strong></a>ï¼Œæˆ–è€…ä»¥ä»»ä½•æ–¹å¼å¹¶è¡Œå‘ç”Ÿå¤šç§äº‹æƒ…ï¼šå¦‚æœæ‚¨<strong>ç¡®å®š</strong>æ˜¯è¿™ç§æƒ…å†µï¼Œä¾‹å¦‚ WASMï¼ˆç›®å‰ï¼‰ï¼Œæ‚¨å¯ä»¥è®¾ç½®<code>"singlethread": true</code>. è¿™å°†é…ç½® LLVM ä»¥å°†æ‰€æœ‰åŸå­æ“ä½œè½¬æ¢ä¸ºä½¿ç”¨å®ƒä»¬çš„å•çº¿ç¨‹å¯¹åº”é¡¹ã€‚å¦‚æœä½¿ç”¨çº¿ç¨‹æˆ–ä¸­æ–­ï¼Œé”™è¯¯åœ°ä½¿ç”¨æ­¤é€‰é¡¹å¯èƒ½ä¼šå¯¼è‡´ UBã€‚</li>
<li>æˆ‘æœ‰æœ¬æœºåŸå­æ“ä½œï¼šè®¾ç½®<code>max-atomic-width</code>ä¸ºæ‚¨çš„ç›®æ ‡å¯ä»¥åŸå­æ“ä½œçš„æœ€å¤§ä½ç±»å‹ã€‚ä¾‹å¦‚ï¼Œè®¸å¤š ARM å†…æ ¸å…·æœ‰ 32 ä½åŸå­æ“ä½œã€‚<code>"max-atomic-width": 32</code>åœ¨è¿™ç§æƒ…å†µä¸‹ä½ å¯ä»¥è®¾ç½®ã€‚</li>
<li>æˆ‘æ²¡æœ‰æœ¬æœºåŸå­æ“ä½œï¼Œä½†æˆ‘å¯ä»¥è‡ªå·±æ¨¡æ‹Ÿå®ƒä»¬ï¼šè®¾ç½®<code>max-atomic-width</code>ä¸ºæœ€å¤šå¯ä»¥æ¨¡æ‹Ÿ 128 ä½çš„æœ€é«˜ä½æ•°ï¼Œç„¶åå°† LLVM æœŸæœ›çš„æ‰€æœ‰<a href="http://llvm.org/docs/Atomics.html#libcalls-atomic" target="_blank" rel="noopener">åŸå­</a>å’Œ<a href="http://llvm.org/docs/Atomics.html#libcalls-atomic" target="_blank" rel="noopener">åŒæ­¥</a>åŠŸèƒ½å®ç° ä¸º <code>#[no_mangle] unsafe extern "C"</code>. è¿™äº›å‡½æ•°å·²ç»è¢«gccæ ‡å‡†åŒ–äº†ï¼Œæ‰€ä»¥<a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html" target="_blank" rel="noopener">gccçš„æ–‡æ¡£</a>å¯èƒ½æœ‰æ›´å¤šçš„æ³¨é‡Šã€‚ç¼ºå°‘å‡½æ•°ä¼šå¯¼è‡´é“¾æ¥å™¨é”™è¯¯ï¼Œè€Œé”™è¯¯å®ç°çš„å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´ UBã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªå¸¦ä¸­æ–­çš„å•æ ¸ã€å•çº¿ç¨‹å¤„ç†å™¨ï¼Œæ‚¨å¯ä»¥å®ç°è¿™äº›å‡½æ•°æ¥ç¦ç”¨ä¸­æ–­ï¼Œæ‰§è¡Œå¸¸è§„æ“ä½œï¼Œç„¶åé‡æ–°å¯ç”¨å®ƒä»¬ã€‚</li>
<li>æˆ‘æ²¡æœ‰æœ¬æœºåŸå­æ“ä½œï¼šæ‚¨å¿…é¡»åšä¸€äº›ä¸å®‰å…¨çš„å·¥ä½œæ¥æ‰‹åŠ¨ç¡®ä¿ä»£ç ä¸­çš„åŒæ­¥ã€‚æ‚¨å¿…é¡»è®¾ç½®<code>"max-atomic-width": 0</code>.</li>
</ul>
</li>
<li><p>å¦‚æœä¸ç°æœ‰å·¥å…·é“¾é›†æˆï¼Œè¯·æ›´æ”¹é“¾æ¥å™¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„å·¥å…·é“¾ä½¿ç”¨ gcc çš„è‡ªå®šä¹‰æ„å»ºï¼Œè¯·å°†</p>
<pre><code>"linker-flavor": "gcc"</code></pre><p>å’Œè®¾ç½®</p>
<pre><code>linker</code></pre><p>ä¸ºé“¾æ¥å™¨çš„å‘½ä»¤åç§°ã€‚å¦‚æœæ‚¨éœ€è¦é¢å¤–çš„é“¾æ¥å™¨å‚æ•°ï¼Œè¯·ä½¿ç”¨</p>
<pre><code>pre-link-args</code></pre><p>and </p>
<pre><code>post-link-args</code></pre><p>ï¼š</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"pre-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--as-needed"</span><span class="token punctuation">,</span>
        <span class="token string">"-Wl,-z,noexecstack"</span><span class="token punctuation">,</span>
        <span class="token string">"-m64"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token property">"post-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--allow-multiple-definition"</span><span class="token punctuation">,</span>
        <span class="token string">"-Wl,--start-group,-lc,-lm,-lgcc,-lstdc++,-lsupc++,--end-group"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¡®ä¿é“¾æ¥å™¨ç±»å‹æ˜¯</p>
<pre><code>link-args</code></pre><p>.</p>
</li>
<li><p>é…ç½® LLVM åŠŸèƒ½ã€‚<code>llc -march=ARCH -mattr=help</code>åœ¨ ARCH æ˜¯åŸºæœ¬æ¶æ„çš„åœ°æ–¹è¿è¡Œï¼ˆä¸åŒ…æ‹¬ ARM çš„ç‰ˆæœ¬ï¼‰ä»¥åˆ—å‡ºå¯ç”¨åŠŸèƒ½åŠå…¶æè¿°ã€‚<strong>å¦‚æœæ‚¨çš„ç›®æ ‡éœ€è¦ä¸¥æ ¼çš„å†…å­˜å¯¹é½è®¿é—®ï¼ˆä¾‹å¦‚<code>armv5te</code>ï¼‰ï¼Œè¯·ç¡®ä¿å¯ç”¨<code>strict-align</code></strong>. è¦å¯ç”¨æŸä¸ªåŠŸèƒ½ï¼Œè¯·åœ¨å®ƒä¹‹å‰æ”¾ç½®ä¸€ä¸ªåŠ å·ã€‚åŒæ ·ï¼Œè¦ç¦ç”¨æŸä¸ªåŠŸèƒ½ï¼Œè¯·åœ¨å®ƒä¹‹å‰æ”¾ç½®ä¸€ä¸ªå‡å·ã€‚åŠŸèƒ½åº”è¯¥åƒè¿™æ ·ç”¨é€—å·åˆ†éš”ï¼š <code>"features": "+soft-float,+neon</code>. è¯·æ³¨æ„ï¼Œå¦‚æœ LLVM æ ¹æ®æä¾›çš„ä¸‰å…ƒç»„å’Œ CPU å¯¹æ‚¨çš„ç›®æ ‡æœ‰è¶³å¤Ÿçš„äº†è§£ï¼Œåˆ™è¿™å¯èƒ½æ²¡æœ‰å¿…è¦ã€‚</p>
</li>
<li><p>å¦‚æœæ‚¨çŸ¥é“ï¼Œè¯·é…ç½® LLVM ä½¿ç”¨çš„ CPUã€‚è¿™å°†å¯ç”¨ç‰¹å®šäº CPU çš„ä¼˜åŒ–å’ŒåŠŸèƒ½ã€‚åœ¨ä¸Šä¸€æ­¥å‘½ä»¤è¾“å‡ºçš„é¡¶éƒ¨ï¼Œæœ‰ä¸€ä¸ªå·²çŸ¥ CPU çš„åˆ—è¡¨ã€‚å¦‚æœæ‚¨çŸ¥é“å°†é’ˆå¯¹ç‰¹å®š CPUï¼Œåˆ™å¯ä»¥<code>cpu</code>åœ¨ JSON ç›®æ ‡æ–‡ä»¶çš„å­—æ®µä¸­è¿›è¡Œè®¾ç½®ã€‚</p>
</li>
</ul>
<h2 id="ä½¿ç”¨ç›®æ ‡æ–‡ä»¶"><a href="#ä½¿ç”¨ç›®æ ‡æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨ç›®æ ‡æ–‡ä»¶"></a>ä½¿ç”¨ç›®æ ‡æ–‡ä»¶</h2><p>ä¸€æ—¦ä½ æœ‰äº†ä¸€ä¸ªç›®æ ‡è§„èŒƒæ–‡ä»¶ï¼Œ<code>.json</code>å¦‚æœå®ƒåœ¨å½“å‰ç›®å½•æˆ–<code>$RUST_TARGET_PATH</code>.</p>
<p>éªŒè¯å®ƒæ˜¯å¦å¯ä»¥è¢« rustc è¯»å–ï¼š</p>
<pre class="line-numbers language-sh"><code class="language-sh">â± rustc --print cfg --target foo.json # or just foo if in the current directory
debug_assertions
target_arch="arm"
target_endian="little"
target_env=""
target_feature="mclass"
target_feature="v7"
target_has_atomic="16"
target_has_atomic="32"
target_has_atomic="8"
target_has_atomic="cas"
target_has_atomic="ptr"
target_os="none"
target_pointer_width="32"
target_vendor=""<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œæ‚¨ç»ˆäºå¯ä»¥ä½¿ç”¨å®ƒäº†ï¼è®¸å¤šèµ„æºä¸€ç›´åœ¨æ¨è<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener"><code>xargo</code></a>æˆ–<a href="https://github.com/rust-osdev/cargo-xbuild" target="_blank" rel="noopener"><code>cargo-xbuild</code></a>. ç„¶è€Œï¼Œå®ƒçš„ç»§ä»»è€…ï¼Œcargo çš„<code>build-std</code>åŠŸèƒ½ï¼Œæœ€è¿‘æ”¶åˆ°äº†å¾ˆå¤šå·¥ä½œï¼Œå¹¶ä¸”å¾ˆå¿«å°±è¾¾åˆ°äº†ä¸å…¶ä»–é€‰é¡¹ç›¸åŒçš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œæœ¬æŒ‡å—å°†ä»…æ¶µç›–è¯¥é€‰é¡¹ã€‚</p>
<p>ä»ä¸€ä¸ªæœ€ä½é™åº¦çš„<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html" target="_blank" rel="noopener"><code>no_std</code>ç¨‹åºå¼€å§‹</a>ã€‚ç°åœ¨ï¼Œ<code>cargo build -Z build-std=core --target foo.json</code>å†æ¬¡ä½¿ç”¨ä¸Šè¿°æœ‰å…³å¼•ç”¨è·¯å¾„çš„è§„åˆ™è¿è¡Œ ã€‚å¸Œæœ›æ‚¨ç°åœ¨åº”è¯¥åœ¨ç›®æ ‡ç›®å½•ä¸­æœ‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>æ‚¨å¯ä»¥é€‰æ‹©å°†è´§ç‰©é…ç½®ä¸ºå§‹ç»ˆä½¿ç”¨æ‚¨çš„ç›®æ ‡ã€‚è¯·å‚é˜…é¡µé¢æœ«å°¾å…³äº<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html" target="_blank" rel="noopener">æœ€å°<code>no_std</code>ç¨‹åºçš„å»ºè®®</a>ã€‚ä½†æ˜¯ï¼Œæ‚¨ç›®å‰å¿…é¡»ä½¿ç”¨è¯¥æ ‡å¿—ï¼Œ<code>-Z build-std=core</code>å› ä¸ºè¯¥é€‰é¡¹ä¸ç¨³å®šã€‚</p>
<h3 id="æ„å»ºé¢å¤–çš„å†…ç½®crate"><a href="#æ„å»ºé¢å¤–çš„å†…ç½®crate" class="headerlink" title="æ„å»ºé¢å¤–çš„å†…ç½®crate"></a>æ„å»ºé¢å¤–çš„å†…ç½®crate</h3><p>åœ¨ä½¿ç”¨cargo çš„<code>build-std</code>ç‰¹æ€§æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©åœ¨å“ªä¸ª crate ä¸­ç¼–è¯‘ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“åªä¼ é€’<code>-Z build-std</code>, <code>std</code>, <code>core</code>, å’Œ<code>alloc</code>è¢«ç¼–è¯‘æ—¶ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½å¸Œæœ›<code>std</code>åœ¨ä¸ºè£¸æœºç¼–è¯‘æ—¶æ’é™¤ã€‚ä¸ºæ­¤ï¼Œè¯·åœ¨ ä¹‹åæŒ‡å®šæ‚¨æƒ³è¦çš„æ¿æ¡ç®± <code>build-std</code>ã€‚ä¾‹å¦‚ï¼Œè¦åŒ…å«<code>core</code>å’Œ<code>alloc</code>ï¼Œé€šè¿‡<code>-Z build-std=core,alloc</code>ã€‚</p>
<h2 id="æ•…éšœæ’é™¤"><a href="#æ•…éšœæ’é™¤" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><h3 id="éœ€è¦è¯­è¨€é¡¹ï¼Œä½†æœªæ‰¾åˆ°ï¼š-eh-personality"><a href="#éœ€è¦è¯­è¨€é¡¹ï¼Œä½†æœªæ‰¾åˆ°ï¼š-eh-personality" class="headerlink" title="éœ€è¦è¯­è¨€é¡¹ï¼Œä½†æœªæ‰¾åˆ°ï¼š eh_personality"></a>éœ€è¦è¯­è¨€é¡¹ï¼Œä½†æœªæ‰¾åˆ°ï¼š <code>eh_personality</code></h3><p>æ·»åŠ <code>"panic-strategy": "abort"</code>åˆ°æ‚¨çš„ç›®æ ‡æ–‡ä»¶ï¼Œæˆ–å®šä¹‰ä¸€ä¸ªeh_personalityå‡½æ•°ã€‚æˆ–è€…ï¼Œå‘Šè¯‰ Cargo å¿½ç•¥å®ƒã€‚</p>
<h3 id="æœªå®šä¹‰çš„å¼•ç”¨-sync-val-compare-and-swap"><a href="#æœªå®šä¹‰çš„å¼•ç”¨-sync-val-compare-and-swap" class="headerlink" title="æœªå®šä¹‰çš„å¼•ç”¨ __sync_val_compare_and_swap_#"></a>æœªå®šä¹‰çš„å¼•ç”¨ <code>__sync_val_compare_and_swap_#</code></h3><p>Rust è®¤ä¸ºæ‚¨çš„ç›®æ ‡å…·æœ‰åŸå­æŒ‡ä»¤ï¼Œä½† LLVM æ²¡æœ‰ã€‚å›åˆ°å…³äºé…ç½®åŸå­çš„æ­¥éª¤ ã€‚æ‚¨å°†éœ€è¦å‡å°‘ ä¸­çš„æ•°é‡<code>max-atomic-width</code>ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://github.com/rust-lang/rust/issues/58500" target="_blank" rel="noopener">#58500</a>ã€‚</p>
<h3 id="æ‰¾ä¸åˆ°syncåœ¨alloc"><a href="#æ‰¾ä¸åˆ°syncåœ¨alloc" class="headerlink" title="æ‰¾ä¸åˆ°syncåœ¨alloc"></a>æ‰¾ä¸åˆ°<code>sync</code>åœ¨<code>alloc</code></h3><p>ä¸ä¸Šè¿°æƒ…å†µç±»ä¼¼ï¼ŒRust ä¸è®¤ä¸ºä½ æœ‰åŸå­ã€‚ä½ å¿…é¡»è‡ªå·±å®ç°å®ƒä»¬æˆ–è€…å‘Šè¯‰ Rust ä½ æœ‰åŸå­æŒ‡ä»¤ã€‚</p>
<h3 id="å¤šé‡å®šä¹‰-something"><a href="#å¤šé‡å®šä¹‰-something" class="headerlink" title="å¤šé‡å®šä¹‰ __(something)"></a>å¤šé‡å®šä¹‰ <code>__(something)</code></h3><p>æ‚¨å¯èƒ½ä¼šå°† Rust ç¨‹åºä¸ä»å¦ä¸€ç§è¯­è¨€æ„å»ºçš„ä»£ç ç›¸å…³è”ï¼Œè€Œå¦ä¸€ç§è¯­è¨€åŒ…æ‹¬ Rust ä¹Ÿåˆ›å»ºçš„ç¼–è¯‘å™¨å†…ç½®ç¨‹åºã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨éœ€è¦å‘Šè¯‰é“¾æ¥å™¨å…è®¸å¤šä¸ªå®šä¹‰ã€‚å¦‚æœä½¿ç”¨ gccï¼Œæ‚¨å¯ä»¥æ·»åŠ ï¼š</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"post-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--allow-multiple-definition"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ·»åŠ ç¬¦å·æ—¶å‡ºé”™ï¼šæ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼"><a href="#æ·»åŠ ç¬¦å·æ—¶å‡ºé”™ï¼šæ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼" class="headerlink" title="æ·»åŠ ç¬¦å·æ—¶å‡ºé”™ï¼šæ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼"></a>æ·»åŠ ç¬¦å·æ—¶å‡ºé”™ï¼šæ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼</h3><p>åˆ‡æ¢åˆ°è´§ç‰©çš„<code>build-std</code>åŠŸèƒ½å¹¶æ›´æ–°æ‚¨çš„ç¼–è¯‘å™¨ã€‚è¿™æ˜¯ä¸ºä¸€äº›è¯•å›¾å°†å†…éƒ¨ Rust å¯¹è±¡ä¼ é€’ç»™å¤–éƒ¨é“¾æ¥å™¨çš„ç¼–è¯‘å™¨æ„å»ºå¼•å…¥<a href="https://github.com/rust-lang/cargo/issues/8239" target="_blank" rel="noopener">çš„é”™è¯¯</a>ã€‚</p>
<h1 id="ğŸ˜„ã€ŠMicroRustã€‹"><a href="#ğŸ˜„ã€ŠMicroRustã€‹" class="headerlink" title="ğŸ˜„ã€ŠMicroRustã€‹"></a>ğŸ˜„ã€ŠMicroRustã€‹</h1><h1 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h1><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬åƒå¾€å¸¸ä¸€æ ·å¼€å§‹ä½¿ç”¨ Rustã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è®©æ‚¨çš„å·¥å…·é“¾ä¿æŒæœ€æ–°æ€»æ˜¯å¥½çš„ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„äºŒè¿›åˆ¶é¡¹ç›®ã€‚ä½ å¯èƒ½ä¸ç»å¸¸è¿™æ ·åšï¼Œæ‰€ä»¥å¿˜è®°æ˜¯å¯ä»¥ç†è§£çš„ã€‚å¦‚æœä½ è¿è¡Œ<code>$ cargo</code>ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªæç¤ºã€‚</p>
<h2 id="Buiding"><a href="#Buiding" class="headerlink" title="Buiding"></a>Buiding</h2><pre class="line-numbers language-shell"><code class="language-shell">$ cargo new microrust-start
     Created binary (application) `microrust-start` project
$ cd microrust-start
Cargo.toml  src<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™å·²ç»åˆ›å»ºäº†ä¸€ä¸ªäºŒè¿›åˆ¶æ¿æ¡ç®±ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥<code>$ cargo build</code>è¿™æ ·åšï¼Œç”šè‡³<code>$ cargo run</code>å¯ä»¥ï¼Œä½†æ˜¯ä¸€åˆ‡éƒ½åœ¨ä¸ºæ‚¨çš„è®¡ç®—æœºç¼–è¯‘å’Œè¿è¡Œã€‚</p>
<h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>micro:bit çš„æ¶æ„ä¸æ‚¨çš„è®¡ç®—æœºä¸åŒï¼Œå› æ­¤ç¬¬ä¸€æ­¥å°†æ˜¯é’ˆå¯¹ micro:bit çš„æ¶æ„è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚å¦‚æœæ‚¨è¿›è¡Œ Internet æœç´¢ï¼Œæ‚¨ä¼šæ‰¾åˆ°Rustçš„<a href="https://forge.rust-lang.org/platform-support.html" target="_blank" rel="noopener">å¹³å°æ”¯æŒåˆ—è¡¨</a>ã€‚æŸ¥çœ‹æ­¤é¡µé¢ï¼Œæ‚¨ä¼šå‘ç° micro:bit çš„ nRF51822 Cortex-M0 å¾®å¤„ç†å™¨ï¼š</p>
<blockquote>
<pre><code>thumbv6m-none-eabi [*] [ ] [ ] Bare Cortex-M0, M0+, M1</code></pre></blockquote>
<p>â€œthumbv6m-none-eabiâ€æ˜¯å·²çŸ¥çš„ç›®æ ‡ä¸‰å…ƒç»„ã€‚æ³¨æ„æ˜Ÿæ˜Ÿä»£è¡¨ä»€ä¹ˆï¼š</p>
<blockquote>
<p>è¿™äº›æ˜¯è£¸æœºå¾®æ§åˆ¶å™¨ç›®æ ‡ï¼Œåªèƒ½è®¿é—®æ ¸å¿ƒåº“ï¼Œä¸èƒ½è®¿é—® stdã€‚</p>
</blockquote>
<p>è¦å®‰è£…æ­¤ç›®æ ‡ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="æ„å»º-1"><a href="#æ„å»º-1" class="headerlink" title="æ„å»º 1"></a>æ„å»º 1</h3><p>ç°åœ¨æˆ‘ä»¬åº”è¯¥å¦‚ä½•ä½¿ç”¨å®ƒï¼Ÿå¥½å§ï¼Œå¦‚æœæ‚¨è¦æŸ¥çœ‹<code>$ cargo build -h</code>ï¼Œæ‚¨ä¼šå°è¯•ï¼š</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error[E0463]: can't find crate for `std`
  |
  = note: the `thumbv6m-none-eabi` target may not be installed

error: aborting due to previous error

For more information about this error, try `rustc --explain E0463`.
error: Could not compile `microrust-start`.

To learn more, run the command again with --verbose.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¸®åŠ©è¯´æ˜ç›¸å½“æ— ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬åˆšåˆšå®‰è£…äº†è¯¥ç›®æ ‡ã€‚æˆ‘ä»¬è¿˜æ³¨æ„åˆ°ï¼Œthumbv6m-none-eabi ç›®æ ‡ä¸åŒ…æ‹¬ stdï¼Œåªæœ‰æ ¸å¿ƒ crateï¼Œå®ƒå…·æœ‰ä¸å¹³å°æ— å…³çš„ std åŠŸèƒ½å­é›†ã€‚ä¸ºä»€ä¹ˆåœ¨æˆ‘ä»¬æ„å»ºæ—¶å®ƒä»ç„¶åœ¨å¯»æ‰¾ std crateï¼Ÿ</p>
<h4 id="no-std"><a href="#no-std" class="headerlink" title="no_std"></a><code>no_std</code></h4><p>äº‹å®è¯æ˜ï¼Œé™¤éæ˜ç¡®ç¦ç”¨ï¼Œå¦åˆ™ rust å°†å§‹ç»ˆå¯»æ‰¾ std crateï¼Œå› æ­¤æˆ‘ä»¬å°†æ·»åŠ  no_std å±æ€§</p>
<pre><code>src/main.rs
#![no_std]

fn main() {
    println!("Hello, world!");
}</code></pre><h3 id="æ„å»º-2"><a href="#æ„å»º-2" class="headerlink" title="æ„å»º 2"></a>æ„å»º 2</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: cannot find macro `println!` in this scope
 --> src/main.rs:4:5
  |
4 |     println!("Hello, world!");
  |     ^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>println</code>æ˜¯åœ¨ std crate ä¸­æ‰¾åˆ°çš„å®ã€‚æˆ‘ä»¬ç›®å‰ä¸éœ€è¦å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ é™¤å®ƒå¹¶å°è¯•é‡æ–°æ„å»ºã€‚</p>
<h3 id="æ„å»º-3"><a href="#æ„å»º-3" class="headerlink" title="æ„å»º 3"></a>æ„å»º 3</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: `#[panic_handler]` function required, but not found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸º rustc éœ€è¦å®ç°ä¸€ä¸ªææ…Œå¤„ç†ç¨‹åºã€‚</p>
<h4 id="panic-impl"><a href="#panic-impl" class="headerlink" title="panic_impl"></a><code>panic_impl</code></h4><p>æˆ‘ä»¬å¯ä»¥å°è¯•è‡ªå·±å®ç° panic å®ï¼Œä½†æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸ºæˆ‘ä»¬å®Œæˆå®ƒçš„ crate æ›´å®¹æ˜“å’Œæ›´ä¾¿æºã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨<a href="https://crates.io/keywords/panic-impl" target="_blank" rel="noopener">crates.io ä¸ŠæŸ¥çœ‹ panic-impl å…³é”®å­—ï¼Œ</a>æˆ‘ä»¬ä¼šæ‰¾åˆ°ä¸€äº›ä¾‹å­ã€‚è®©æˆ‘ä»¬ç”»ä¸€ä¸ªæœ€ç®€å•çš„ï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ Cargo.tomlã€‚å¦‚æœæ‚¨å¿˜è®°äº†å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼Œè¯·å°è¯•æŸ¥çœ‹<a href="https://doc.rust-lang.org/stable/cargo/" target="_blank" rel="noopener">è´§ç‰©æ‰‹å†Œ</a>ã€‚</p>
<pre><code>Cargo.toml
[dependencies]
panic-halt = "~0.2"
src/main.rs
#![no_std]

extern crate panic_halt;

fn main() {
}</code></pre><h3 id="å»ºé€ -4"><a href="#å»ºé€ -4" class="headerlink" title="å»ºé€  4"></a>å»ºé€  4</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: requires `start` lang_item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="no-main"><a href="#no-main" class="headerlink" title="no_main"></a><code>no_main</code></h4><p>åœ¨æ‚¨ä¹ æƒ¯åˆ¶ä½œçš„æ™®é€šå‘½ä»¤è¡Œ rust äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶é€šå¸¸ä¼šé€šè¿‡æ‰§è¡Œ C è¿è¡Œæ—¶åº“ (crt0) æ¥å¯åŠ¨æ“ä½œç³»ç»Ÿã€‚è¿™åˆä¼šè°ƒç”¨ Rust è¿è¡Œæ—¶ï¼Œå¦‚<code>start</code>è¯­è¨€é¡¹æ‰€æ ‡è®°ï¼Œåè€…åˆä¼šè°ƒç”¨ main å‡½æ•°ã€‚</p>
<p>å¯ç”¨å<code>no_std</code>ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¾®æ§åˆ¶å™¨ï¼Œcrt0 å’Œ rust è¿è¡Œæ—¶éƒ½ä¸å¯ç”¨ï¼Œæ‰€ä»¥å³ä½¿å®ç°<code>start</code>ä¹Ÿæ— æµäºäº‹ã€‚æˆ‘ä»¬éœ€è¦æ›´æ¢æ“ä½œç³»ç»Ÿå…¥å£ç‚¹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨é»˜è®¤å…¥å£ç‚¹ä¹‹åå‘½åä¸€ä¸ªå‡½æ•°ï¼Œå¯¹äº linux æ˜¯<code>_start</code>ï¼Œå¹¶ä»¥è¿™ç§æ–¹å¼å¯åŠ¨ã€‚è¯·æ³¨æ„ï¼Œæ‚¨è¿˜éœ€è¦ç¦ç”¨<a href="https://en.wikipedia.org/wiki/Name_mangling" target="_blank" rel="noopener">name mangling</a>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯å°è¯•è®©æˆ‘ä»¬è‡ªå·±å·¥ä½œçš„é“è·¯çš„å°½å¤´ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ç‰¹å®šäºæ¿çš„æ”¯æŒç®±å’Œä¸€äº›è´§ç‰©è°ƒæ•´çš„å¸®åŠ©æ‰èƒ½ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚</p>
<h4 id="microbit-crate"><a href="#microbit-crate" class="headerlink" title="microbit-crate"></a>microbit-crate</h4><p>è®©æˆ‘ä»¬ä¸º micro:bit æ·»åŠ å¯¹æ¿æ¡ç®±çš„ä¾èµ–ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
panic-halt = "~0.2"
microbit="~0.7"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>microbit crate æœ‰ä¸¤ä¸ªå€¼å¾—æ³¨æ„çš„ä¾èµ–é¡¹ï¼š</p>
<h4 id="embedded-hal"><a href="#embedded-hal" class="headerlink" title="embedded-hal"></a><code>embedded-hal</code></h4><p>è¿™ä¸ª crate æ˜¯ä¸€ä¸ª HAL å®ç° crateï¼Œå…¶ä¸­ HAL ä»£è¡¨<em>ç¡¬ä»¶æŠ½è±¡å±‚</em>ã€‚éšç€ Rust åœ¨åµŒå…¥å¼å¼€å‘ä¸­å˜å¾—è¶Šæ¥è¶Šæµè¡Œï¼Œå¸Œæœ›å°½å¯èƒ½å°‘çš„ç¡¬ä»¶ç‰¹å®šå®ç°ã€‚</p>
<p>å‡ºäºè¿™ä¸ªåŸå› ï¼Œ<code>embedded-hal</code>æ¿æ¡ç®±åŒ…å«ä¸€ç³»åˆ—ç¡¬ä»¶æŠ½è±¡ç‰¹å¾ï¼Œå¯ä»¥ç”±æ¿ç‰¹å®šçš„æ¿æ¡ç®±å®ç°ã€‚</p>
<h4 id="cortex-m-rt"><a href="#cortex-m-rt" class="headerlink" title="cortex-m-rt"></a><code>cortex-m-rt</code></h4><p>è¿™ä¸ª crate å®ç°äº† Cortex-M å¾®æ§åˆ¶å™¨çš„æœ€å°å¯åŠ¨/è¿è¡Œæ—¶é—´ã€‚é™¤å…¶ä»–å¤–ï¼Œè¿™ä¸ªæ¿æ¡ç®±æä¾›ï¼š</p>
<ul>
<li>çš„<code>#[entry]</code>å±æ€§ï¼Œæ¥å®šä¹‰ç¨‹åºçš„å…¥å£ç‚¹ã€‚</li>
<li>ç¡¬æ•…éšœå¤„ç†ç¨‹åºçš„å®šä¹‰</li>
<li>é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åºçš„å®šä¹‰</li>
</ul>
<p>è¿™ä¸ªç®±å­éœ€è¦ï¼š</p>
<ul>
<li>å°†ç‰¹å®šå¾®æ§åˆ¶å™¨çš„å­˜å‚¨å™¨å¸ƒå±€å®šä¹‰ä¸º memory.x æ–‡ä»¶ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™é€šå¸¸ç”±è‘£äº‹ä¼šæ”¯æŒç®±æä¾›</li>
</ul>
<p>è¦ä½¿ç”¨è¯¥<code>#[entry]</code>å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ·»åŠ ä¸ºä¾èµ–é¡¹ã€‚</p>
<p>æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æœ‰ç”¨çš„<a href="https://docs.rs/crate/cortex-m-quickstart" target="_blank" rel="noopener">Cortex-Mçš„ï¼Œå¿«é€Ÿå¯åŠ¨ç®±</a>å’Œ<a href="https://docs.rs/cortex-m-quickstart" target="_blank" rel="noopener">å®ƒçš„æ–‡æ¡£</a>ã€‚</p>
<h4 id="cargo-config"><a href="#cargo-config" class="headerlink" title="cargo-config"></a>cargo-config</h4><p>åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬å°†é€šè¿‡ç¼–è¾‘æ¥è°ƒæ•´è´§ç‰©çš„é…ç½®<code>microrust-start/.cargo/config</code>ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥<a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener">åœ¨æ­¤å¤„</a>é˜…è¯»<a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p>
<p><a href="https://droogmic.github.io/microrust/getting-started/01.00.BUILD.html#cargoconfig" target="_blank" rel="noopener"><code>.cargo/config</code></a></p>
<pre class="line-numbers language-toml"><code class="language-toml"># Configure builds for our target, the micro:bit's architecture
[target.thumbv6m-none-eabi]
# Execute binary using gdb when calling cargo run
runner = "arm-none-eabi-gdb"
# Tweak to the linking process required by the cortex-m-rt crate
rustflags = [
    "-C", "link-arg=-Tlink.x",
    # The LLD linker is selected by default
    #"-C", "linker=arm-none-eabi-ld",
]

# Automatically select this target when cargo building this project
[build]
target = "thumbv6m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="arm-none-eabi-gdb-2"><a href="#arm-none-eabi-gdb-2" class="headerlink" title="arm-none-eabi-gdb"></a>arm-none-eabi-gdb</h4><p>è¿™æ˜¯ç”¨äº ARM EABIï¼ˆåµŒå…¥å¼åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼‰çš„ gdbï¼ˆGNU è°ƒè¯•å™¨ï¼‰ç‰ˆæœ¬ã€‚å®ƒå°†å…è®¸æˆ‘ä»¬ä»æ‚¨çš„è®¡ç®—æœºè°ƒè¯•åœ¨æˆ‘ä»¬çš„ micro:bit ä¸Šè¿è¡Œçš„ä»£ç ã€‚</p>
<h3 id="æ„å»ºç›®æ ‡"><a href="#æ„å»ºç›®æ ‡" class="headerlink" title="æ„å»ºç›®æ ‡"></a>æ„å»ºç›®æ ‡</h3><p>ç°åœ¨ï¼Œæ‚¨éœ€è¦åšçš„å°±æ˜¯è¿è¡Œ<code>$ cargo build</code>ï¼Œcargo ä¼šè‡ªåŠ¨æ·»åŠ <code>--target thumbv6m-none-eabi</code>.</p>
<h3 id="å»ºé€ -5"><a href="#å»ºé€ -5" class="headerlink" title="å»ºé€  5"></a>å»ºé€  5</h3><p><code>Cargo.toml</code></p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
panic-halt = "~0.2"
microbit="~0.7"
cortex-m-rt="~0.6"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>src/main.rs</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
$ cargo build
error<span class="token punctuation">:</span> custom attribute panicked
 <span class="token operator">-</span><span class="token punctuation">-></span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">1</span>
  <span class="token operator">|</span>
<span class="token number">7</span> <span class="token operator">|</span> <span class="token attribute attr-name">#[entry]</span>
  <span class="token operator">|</span> <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span>
  <span class="token operator">|</span>
  <span class="token operator">=</span> help<span class="token punctuation">:</span> message<span class="token punctuation">:</span> `<span class="token attribute attr-name">#[entry]</span>` function must have signature `<span class="token punctuation">[</span><span class="token keyword">unsafe</span><span class="token punctuation">]</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span>`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>!</code> è¿”å›ç±»å‹</p>
<p>ä¸€ä¸ªé²œä¸ºäººçŸ¥çš„é”ˆåŠŸèƒ½ï¼Œæ‰€ä»¥å¦‚æœä½ ä¸çŸ¥é“è¿™æ„å‘³ç€ä»€ä¹ˆï¼Œæˆ‘ä¼šåŸè°…ä½ ã€‚è¿”å›ç±»å‹ä¸ºçš„<code>!</code>æ„å‘³ç€å‡½æ•°ä¸èƒ½è¿”å›ã€‚å®ç°è¿™ä¸€ç‚¹çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨æ— é™å¾ªç¯ã€‚</p>
<p><code>src/main.rs</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å»ºé€ -6"><a href="#å»ºé€ -6" class="headerlink" title="å»ºé€  6"></a>å»ºé€  6</h3><p>å¦‚æœæ‚¨ç°åœ¨å°è¯•æ„å»ºï¼Œæ‚¨åº”è¯¥æœ€ç»ˆä¼šå—åˆ°æ¬¢è¿<code>Finished</code>ï¼</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ cargo build
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="æ„å»ºå®Œæˆ"><a href="#æ„å»ºå®Œæˆ" class="headerlink" title="æ„å»ºå®Œæˆ"></a>æ„å»ºå®Œæˆ</h3><p>ä½œä¸ºå®Œæ•´æ€§æ£€æŸ¥ï¼Œè®©æˆ‘ä»¬éªŒè¯ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ ARM äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ file target/thumbv6m-none-eabi/debug/microrust-start
target/thumbv6m-none-eabi/debug/microrust-start: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped
                                                                            ^^^  ^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Flashing"><a href="#Flashing" class="headerlink" title="Flashing"></a>Flashing</h2><p>Flashing is the process of moving our program into the microcontrollerâ€™s (persistent) memory. Once flashed, the microcontroller will execute the flashed program every time it is powered on.</p>
<p>In this case, our <code>rustled</code> program will be the only program in the microcontroller memory. By this I mean that thereâ€™s nothing else running on the microcontroller: no OS, no daemon, nothing. <code>rustled</code> has full control over the device. This is what is meant by <em>bare-metal</em> programming.</p>
<ul>
<li><p>OS</p>
<p>operating system</p>
</li>
<li><p>Daemon</p>
<p>program running in the background</p>
</li>
</ul>
<p>Connect the micro:bit to your computer and run the following commands on a new terminal.</p>
<p>We need to give OCD the name of the interfaces we are using:</p>
<pre class="line-numbers language-console"><code class="language-console">$ # All
$ # Windows: remember that you need an extra `-s %PATH_TO_OPENOCD%\<version>\scripts`
$ openocd -f interface/cmsis-dap.cfg -f target/nrf51.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>The program will block; leave that terminal open.</p>
<p>Now itâ€™s a good time to explain what this command is actually doing.</p>
<p>I mentioned that the micro:bit actually has two microcontrollers. One of them is used as a USB interface and programmer/debugger. This microcontroller is connected to the target microcontroller using a Serial Wire Debug (SWD) interface (this interface is an ARM standard so youâ€™ll run into it when dealing with other Cortex-M based microcontrollers). This SWD interface can be used to flash and debug a microcontroller. It uses the CMSIS-DAP protocol for host debugging of application programs. It will appear as a USB device when you connect the micro:bit to your laptop.</p>
<p>As for OpenOCD, itâ€™s software that provides some services like a <em>GDB server</em> on top of USB devices that expose a debugging protocol like SWD or JTAG.</p>
<blockquote>
<p>GDB: The <strong>G</strong>NU <strong>d</strong>e<strong>b</strong>ugger will allow us to debug our software by controlling the execution of our program. We will learn more about this a little bit later.</p>
</blockquote>
<p>Onto the actual command: those <code>.cfg</code> files we are using instruct OpenOCD to look for</p>
<ul>
<li>a CMSIS-DAP USB interface device (<code>interface/cmsis-dap.cfg</code>)</li>
<li>a nRF51XXX microcontroller target (<code>target/nrf51.cfg</code>) to be connected to the USB interface.</li>
</ul>
<p>The OpenOCD output looks like this:</p>
<pre class="line-numbers language-console"><code class="language-console">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "swd". To override use 'transport select <transport>'.
cortex_m reset_config sysresetreq
adapter speed: 1000 kHz
Info : CMSIS-DAP: SWD  Supported
Info : CMSIS-DAP: Interface Initialised (SWD)
Info : CMSIS-DAP: FW Version = 1.0
Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1
Info : CMSIS-DAP: Interface ready
Info : clock speed 1000 kHz
Info : SWD DPIDR 0x0bb11477
Info : nrf51.cpu: hardware has 4 breakpoints, 2 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The â€œ4 breakpoints, 2 watchpointsâ€ part indicates the debugging features the processor has available.</p>
<p>I mentioned that OpenOCD provides a GDB server so letâ€™s connect to that right now:</p>
<pre class="line-numbers language-console"><code class="language-console">$ arm-none-eabi-gdb -q target/thumbv6m-none-eabi/debug/rustled
Reading symbols from target/thumbv6m-none-eabi/debug/rustled...done.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>This only opens a GDB shell. To actually connect to the OpenOCD GDB server, use the following command within the GDB shell:</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>By default OpenOCDâ€™s GDB server listens on TCP port 3333 (localhost). This command is connecting to that port.</p>
<p>After entering this command, youâ€™ll see new output in the OpenOCD terminal:</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : stm32f3x.cpu: hardware has 4 breakpoints, 2 watchpoints
<span class="token inserted">+Info : accepting 'gdb' connection on tcp/3333</span>
<span class="token inserted">+Info : nRF51822-QFAA(build code: H0) 256kB Flash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Almost there. To flash the device, weâ€™ll use the <code>load</code> command inside the GDB shell:</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) load
Loading section .vector_table, size 0x188 lma 0x8000000
Loading section .text, size 0x38a lma 0x8000188
Loading section .rodata, size 0x8 lma 0x8000514
Start address 0x8000188, load size 1306
Transfer rate: 6 KB/sec, 435 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>And thatâ€™s it. Youâ€™ll also see new output in the OpenOCD terminal.</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : flash size = 256kbytes
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+adapter speed: 4000 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to breakpoint, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x61000000 pc: 0x2000003a msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Our program is loaded, we can now run it!</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) continue
Continuing.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Continue runs the program until the next breakpoint. This time it blocks, nothing happens. This is because all we have in our code is a loop!</p>
<h3 id="gdbinit"><a href="#gdbinit" class="headerlink" title=".gdbinit"></a><code>.gdbinit</code></h3><p>Before we move on though, we are going to add one more file to our project. This will automate the last few steps so we donâ€™t need to repeatedly do the same actions in gdb:</p>
<pre><code>.gdbinit
# Connects GDB to OpenOCD server port
target remote :3333
# (optional) Unmangle function names when debugging
set print asm-demangle on
# Load your program, breaks at entry
load
# (optional) Add breakpoint at function
break rustled::main
# Continue with execution
continue</code></pre><p>Now we can learn how to debug code on the micro:bit.</p>
<h2 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h2><h3 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h3><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›ä»£ç è¿›è¡Œè°ƒè¯•ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// -- snip --</span>
<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="GDB-ä¼šè¯"><a href="#GDB-ä¼šè¯" class="headerlink" title="GDB ä¼šè¯"></a>GDB ä¼šè¯</h3><p>æˆ‘ä»¬å·²ç»åœ¨è°ƒè¯•ä¼šè¯ä¸­ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è°ƒè¯•æˆ‘ä»¬çš„ç¨‹åºã€‚</p>
<p>åœ¨<code>load</code>å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬çš„ç¨‹åºåœ¨å®ƒçš„<em>å…¥å£ç‚¹</em>åœæ­¢ã€‚è¿™ç”± GDB è¾“å‡ºçš„â€œèµ·å§‹åœ°å€ 0x8000XXXâ€éƒ¨åˆ†æŒ‡ç¤ºã€‚å…¥å£ç‚¹æ˜¯å¤„ç†å™¨/CPU å°†é¦–å…ˆæ‰§è¡Œçš„ç¨‹åºçš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>æˆ‘æä¾›ç»™æ‚¨çš„å…¥é—¨é¡¹ç›®æœ‰ä¸€äº›åœ¨å‡½æ•°<em>ä¹‹å‰</em>è¿è¡Œçš„é¢å¤–ä»£ç <code>main</code>ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯¹â€œpre-mainâ€éƒ¨åˆ†ä¸æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç›´æ¥è·³åˆ°<code>main</code>å‡½æ•°çš„å¼€å¤´ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ–­ç‚¹æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š</p>
<pre><code>(gdb) break rustled::main
Breakpoint 1 at 0x8000218: file src/main.rs, line 8.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, rustled::main () at src/rustled/src/main.rs:13
13          let x = 42;</code></pre><p>æ–­ç‚¹å¯ç”¨äºåœæ­¢ç¨‹åºçš„æ­£å¸¸æµç¨‹ã€‚è¯¥<code>continue</code>å‘½ä»¤å°†ä½¿ç¨‹åºè‡ªç”±è¿è¡Œï¼Œ<em>ç›´åˆ°</em>åˆ°è¾¾æ–­ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´åˆ°å®ƒåˆ°è¾¾<code>main</code>å‡½æ•°ï¼Œå› ä¸ºé‚£é‡Œæœ‰ä¸€ä¸ªæ–­ç‚¹ã€‚</p>
<p>è¯·æ³¨æ„ï¼ŒGDB è¾“å‡ºæ˜¾ç¤ºâ€œæ–­ç‚¹ 1â€ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨åªèƒ½ä½¿ç”¨å…¶ä¸­çš„å››ä¸ªæ–­ç‚¹ï¼Œå› æ­¤æœ€å¥½æ³¨æ„è¿™äº›æ¶ˆæ¯ã€‚</p>
<p>ä¸ºäº†è·å¾—æ›´å¥½çš„è°ƒè¯•ä½“éªŒï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ GDB çš„æ–‡æœ¬ç”¨æˆ·ç•Œé¢ (TUI)ã€‚è¦è¿›å…¥è¯¥æ¨¡å¼ï¼Œè¯·åœ¨ GDB shell ä¸Šè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code>(gdb) layout src</code></pre><blockquote>
<p><strong>æ³¨æ„ å‘</strong>Windows ç”¨æˆ·é“æ­‰ã€‚GNU ARM Embedded Toolchain é™„å¸¦çš„ GDB ä¸æ”¯æŒæ­¤ TUI æ¨¡å¼<code>:(</code>ã€‚</p>
</blockquote>
<p>æ‚¨å¯ä»¥éšæ—¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€€å‡º TUI æ¨¡å¼ï¼š</p>
<pre><code>(gdb) tui disable</code></pre><p>å¥½çš„ã€‚æˆ‘ä»¬ç°åœ¨å¤„äº<code>main</code>. æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>step</code>å‘½ä»¤é€å¥æ¨è¿›ç¨‹åºè¯­å¥ã€‚æ‰€ä»¥è®©æˆ‘ä»¬ä½¿ç”¨å®ƒä¸¤æ¬¡æ¥è¾¾åˆ°<code>y = x</code>è¯­å¥ã€‚è¾“å…¥<code>step</code>ä¸€æ¬¡åï¼Œæ‚¨åªéœ€æŒ‰ Enter å³å¯å†æ¬¡è¿è¡Œå®ƒã€‚</p>
<pre><code>(gdb) step
14           _y = x;</code></pre><p>å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨ TUI æ¨¡å¼ï¼Œåˆ™åœ¨æ¯æ¬¡<code>step</code>è°ƒç”¨æ—¶ GDB éƒ½ä¼šæ‰“å°å›å½“å‰è¯­å¥åŠå…¶è¡Œå·ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨â€œåœ¨â€<code>y = x</code>å£°æ˜ï¼›è¯¥è¯­å¥å°šæœªæ‰§è¡Œã€‚è¿™æ„å‘³ç€<code>x</code> å·²åˆå§‹åŒ–ä½†æœªåˆå§‹åŒ–<code>y</code>ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹<code>print</code>å‘½ä»¤æ£€æŸ¥è¿™äº›å †æ ˆ/å±€éƒ¨å˜é‡ï¼š</p>
<pre><code>(gdb) print x
$1 = 42

(gdb) print &amp;x
$2 = (i32 *) 0x10001fdc

(gdb) print _y
$3 = 134219052

(gdb) print &amp;_y
$4 = (i32 *) 0x10001fd8</code></pre><p>æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œ<code>x</code>åŒ…å«å€¼<code>42</code>ã€‚ <code>_y</code>ä½†æ˜¯ï¼ŒåŒ…å«å€¼<code>134219052</code>(?)ã€‚å› ä¸º<code>_y</code>è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæ‰€ä»¥åŒ…å«äº†ä¸€äº›åƒåœ¾å€¼ã€‚</p>
<p>è¯¥å‘½ä»¤<code>print &amp;x</code>æ‰“å°å˜é‡çš„åœ°å€<code>x</code>ã€‚è¿™é‡Œæœ‰è¶£çš„ä¸€ç‚¹æ˜¯ GDB è¾“å‡ºæ˜¾ç¤ºäº†å¼•ç”¨çš„ç±»å‹ï¼š <code>i32*</code>ï¼Œä¸€ä¸ªæŒ‡å‘<code>i32</code>å€¼çš„æŒ‡é’ˆã€‚å¦ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯ï¼Œåœ°å€<code>x</code>å’Œ<code>_y</code>éå¸¸æ¥è¿‘å¯¹æ–¹ï¼šä»–ä»¬çš„åœ°å€åªæ˜¯<code>4</code>ä¸ªå­—èŠ‚åˆ†å¼€ã€‚</p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹<code>info locals</code>å‘½ä»¤ï¼Œè€Œä¸æ˜¯ä¸€ä¸€æ‰“å°å±€éƒ¨å˜é‡ï¼š</p>
<pre><code>(gdb) info locals
x = 42
_y = 134219052</code></pre><p>å¥½çš„ã€‚ä½¿ç”¨ another <code>step</code>ï¼Œæˆ‘ä»¬å°†åœ¨<code>loop {}</code>è¯­å¥ä¹‹ä¸Šï¼š</p>
<pre><code>(gdb) step
17          loop {}</code></pre><p>å¹¶ä¸”<code>_y</code>ç°åœ¨åº”è¯¥è¢«åˆå§‹åŒ–ã€‚</p>
<pre><code>(gdb) print _y
$5 = 42</code></pre><p>å¦‚æœæˆ‘ä»¬<code>step</code>å†æ¬¡åœ¨<code>loop {}</code>è¯­å¥ä¹‹ä¸Šä½¿ç”¨ï¼Œæˆ‘ä»¬ä¼šå¡ä½ï¼Œå› ä¸ºç¨‹åºæ°¸è¿œä¸ä¼šé€šè¿‡è¯¥è¯­å¥ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>layout asm</code> å‘½ä»¤åˆ‡æ¢åˆ°åæ±‡ç¼–è§†å›¾ï¼Œå¹¶ä½¿ç”¨ ä¸€æ¬¡æ¨è¿›ä¸€æ¡æŒ‡ä»¤<code>stepi</code>ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨<code>step</code>é”™è¯¯åœ°ä½¿ç”¨äº†è¯¥å‘½ä»¤å¹¶ä¸” GDB å¡ä½äº†ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç‚¹å‡» æ¥è§£é™¤å¡ä½<code>Ctrl+C</code>ã€‚</p>
</blockquote>
<pre><code>(gdb) layout asm</code></pre><p>å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨ TUI æ¨¡å¼ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥<code>disassemble /m</code>å‘½ä»¤åœ¨æ‚¨å½“å‰æ‰€åœ¨çš„è¡Œå‘¨å›´åæ±‡ç¼–ç¨‹åºã€‚</p>
<pre><code>(gdb) disassemble /m
Dump of assembler code for function led_roulette::main:
11      fn main() -&gt; ! {
   0x08000188 &lt;+0&gt;:     sub     sp, #8

12          let _y;
13          let x = 42;
   0x0800018a &lt;+2&gt;:     movs    r0, #42 ; 0x2a
   0x0800018c &lt;+4&gt;:     str     r0, [sp, #4]

14          _y = x;
   0x0800018e &lt;+6&gt;:     ldr     r0, [sp, #4]
   0x08000190 &lt;+8&gt;:     str     r0, [sp, #0]

15
16          // infinite loop; just so we don't leave this stack frame
17          loop {}
=&gt; 0x08000192 &lt;+10&gt;:    b.n     0x8000194 &lt;led_roulette::main+12&gt;
   0x08000194 &lt;+12&gt;:    b.n     0x8000194 &lt;led_roulette::main+12&gt;

End of assembler dump.</code></pre><p>çœ‹åˆ°<code>=&gt;</code>å·¦ä¾§çš„ç²—ç®­å¤´äº†å—ï¼Ÿå®ƒæ˜¾ç¤ºäº†å¤„ç†å™¨æ¥ä¸‹æ¥å°†æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p>
<p>å¦‚æœä¸åœ¨æ¯ä¸ª<code>stepi</code>å‘½ä»¤çš„ TUI æ¨¡å¼å†…ï¼ŒGDB å°†æ‰“å°è¯­å¥ã€è¡Œå·<em>å’Œ</em>å¤„ç†å™¨æ¥ä¸‹æ¥å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚</p>
<pre><code>(gdb) stepi
0x08000194      17          loop {}

(gdb) stepi
0x08000194      17          loop {}</code></pre><p>åœ¨æˆ‘ä»¬è½¬å‘æ›´æœ‰è¶£çš„äº‹æƒ…ä¹‹å‰çš„æœ€åä¸€ä¸ªæŠ€å·§ã€‚åœ¨ GDB ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code>(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08000188 msp: 0x10002000

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::main () at src/main.rs:8
8           let x = 42;</code></pre><p>æˆ‘ä»¬ç°åœ¨å›åˆ°äº†å¼€å¤´<code>main</code>ï¼</p>
<p><code>monitor reset halt</code>å°†é‡ç½®å¾®æ§åˆ¶å™¨å¹¶åœ¨ç¨‹åºå…¥å£ç‚¹åœæ­¢å®ƒã€‚ä¸‹é¢çš„<code>continue</code>å‘½ä»¤å°†è®©ç¨‹åºè‡ªç”±è¿è¡Œï¼Œç›´åˆ°å®ƒåˆ°è¾¾<code>main</code>æœ‰æ–­ç‚¹çš„å‡½æ•°ã€‚</p>
<p>å½“æ‚¨é”™è¯¯åœ°è·³è¿‡æ‚¨æœ‰å…´è¶£æ£€æŸ¥çš„ç¨‹åºéƒ¨åˆ†æ—¶ï¼Œæ­¤ç»„åˆéå¸¸æ–¹ä¾¿ã€‚æ‚¨å¯ä»¥è½»æ¾åœ°å°†ç¨‹åºçš„çŠ¶æ€å›æ»šåˆ°æœ€åˆçš„çŠ¶æ€ã€‚</p>
<blockquote>
<p><strong>ç»†åˆ™</strong>ï¼šæ­¤<code>reset</code>å‘½ä»¤ä¸ä¼šæ¸…é™¤æˆ–è§¦æ‘¸ RAMã€‚è¯¥å†…å­˜å°†ä¿ç•™å…¶ä¸Šæ¬¡è¿è¡Œçš„å€¼ã€‚ä¸è¿‡ï¼Œè¿™åº”è¯¥ä¸æ˜¯é—®é¢˜ï¼Œé™¤éæ‚¨çš„ç¨‹åºè¡Œä¸ºå–å†³äº<em>æœªåˆå§‹åŒ–<em>å˜é‡çš„å€¼ï¼Œä½†è¿™å°±æ˜¯</em>æœªå®šä¹‰è¡Œä¸º</em>(UB)çš„å®šä¹‰ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å®Œæˆäº†è¿™ä¸ªè°ƒè¯•ä¼šè¯ã€‚ä½ å¯ä»¥ç”¨<code>quit</code>å‘½ä»¤ç»“æŸå®ƒã€‚</p>
<pre><code>(gdb) quit
A debugging session is active.

        Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: $PWD/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.</code></pre><blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨ä¸å–œæ¬¢é»˜è®¤çš„ GDB CLIï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/cyrus-and/gdb-dashboard#gdb-dashboard" target="_blank" rel="noopener">gdb-dashboard</a>ã€‚å®ƒä½¿ç”¨ Python å°†é»˜è®¤çš„ GDB CLI è½¬æ¢ä¸ºæ˜¾ç¤ºå¯„å­˜å™¨ã€æºä»£ç è§†å›¾ã€ç¨‹åºé›†è§†å›¾å’Œå…¶ä»–å†…å®¹çš„ä»ªè¡¨æ¿ã€‚</p>
</blockquote>
<p>ä½†æ˜¯ä¸è¦å…³é—­ OpenOCDï¼ä»¥åæˆ‘ä»¬ä¼šä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨å®ƒã€‚æœ€å¥½è®©å®ƒç»§ç»­è¿è¡Œã€‚</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>è¿™æ˜¯æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢æ‰€åšå·¥ä½œçš„å›é¡¾ã€‚</p>
<h3 id="Cargo-toml"><a href="#Cargo-toml" class="headerlink" title="Cargo.toml"></a>Cargo.toml</h3><pre class="line-numbers language-toml"><code class="language-toml">[package]
name = "start"
version = "0.2.0"

[dependencies]
panic-halt = "~0.2"
microbit="~0.7"
cortex-m-rt="~0.6"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m_rt<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> microbit<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-config-1"><a href="#cargo-config-1" class="headerlink" title=".cargo/config"></a><code>.cargo/config</code></h3><pre class="line-numbers language-toml"><code class="language-toml"># Configure builds for our target, the micro:bit's architecture
[target.thumbv6m-none-eabi]
# Execute binary using gdb when calling cargo run
runner = "arm-none-eabi-gdb"
# Tweak to the linking process required by the cortex-m-rt crate
rustflags = [
    "-C", "link-arg=-Tlink.x",
    # The LLD linker is selected by default
    #"-C", "linker=arm-none-eabi-ld",
]

# Automatically select this target when cargo building this project
[build]
target = "thumbv6m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="gdbinit-1"><a href="#gdbinit-1" class="headerlink" title=".gdbinit"></a><code>.gdbinit</code></h3><pre class="line-numbers language-gdb"><code class="language-gdb"># Connects GDB to OpenOCD server port
target remote :3333
# (optional) Unmangle function names when debugging
set print asm-demangle on
# Load your program, breaks at entry
load
# (optional) Add breakpoint at function
break main
# Continue with execution
continue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">æ°å…‹æˆ</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/embedded-rust.html">https://jackhcc.github.io/posts/embedded-rust.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="https://jackhcc.github.io" target="_blank">æ°å…‹æˆ</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Rust/">
                                    <span class="chip bg-color">Rust</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>è¯„è®º</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-09-08T21-32-49',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/posts/ml-algorithm.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/2.jpg" class="responsive-img" alt="Machine Learning Algorithm">
                        
                        <span class="card-title">Machine Learning Algorithm</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            æœºå™¨å­¦ä¹ ç»å…¸ç®—æ³•
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-09-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Algorithm/" class="post-category">
                                    Algorithm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Machine-Learning/">
                        <span class="chip bg-color">Machine Learning</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/awesome-bcsd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/22.jpg" class="responsive-img" alt="Awesome BCSD 2021">
                        
                        <span class="card-title">Awesome BCSD 2021</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Binary Code Similarity Detection 2021 ç ”ç©¶æ±‡æ€»
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Awesome/" class="post-category">
                                    Awesome
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BCSD/">
                        <span class="chip bg-color">BCSD</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- ä»£ç å—æŠ˜è¡Œ -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">æ°å…‹æˆ</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;ç«™ç‚¹æ€»å­—æ•°:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;å­—
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <span id="sitetime">è½½å…¥è¿è¡Œæ—¶é—´...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ " + diffDays + " å¤© " + diffHours +
                            " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ " + diffYears + " å¹´ " + diffDays +
                            " å¤© " + diffHours + " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„å¾®åš: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„çŸ¥ä¹: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">çŸ¥</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //åªåœ¨æ¡Œé¢ç‰ˆç½‘é¡µå¯ç”¨ç‰¹æ•ˆ
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

