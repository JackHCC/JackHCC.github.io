<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Embedded Rustè¯¦è§£, JackHCC">
    <meta name="description" content="RuståµŒå…¥å¼ç¼–ç¨‹">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Embedded Rustè¯¦è§£ | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Embedded Rustè¯¦è§£</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Rust/">
                                <span class="chip bg-color">Rust</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Embedded/" class="post-category">
                                Embedded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2021-09-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2021-09-11
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    38.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>é˜…è¯»æ—¶é•¿:&nbsp;&nbsp;
                    155 åˆ†
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="âœ”Learning-Resource"><a href="#âœ”Learning-Resource" class="headerlink" title="âœ”Learning Resource"></a>âœ”Learning Resource</h1><ul>
<li><a href="https://rust-embedded.github.io/book/" target="_blank" rel="noopener">The Embedded Rust Book</a> - An introductory book about using the Rust Programming Language on â€œBare Metalâ€ embedded systems, such as Microcontrollers.</li>
<li><a href="https://rust-embedded.github.io/discovery" target="_blank" rel="noopener">Discovery</a> by @rust-embedded â€” this book is an introductory course on microcontroller-based embedded systems that uses Rust as the teaching language. Original author: @japaric</li>
<li><a href="https://docs.rs/cortex-m-quickstart/0.3.1/cortex_m_quickstart/" target="_blank" rel="noopener">Cortex-M Quickstart</a> by @japaric â€“ a template and introduction to embedded Rust, suitable for developers familiar to embedded development but new to embedded Rust.</li>
<li><a href="https://os.phil-opp.com/" target="_blank" rel="noopener">Writing an OS in rust</a> A blog series creating a small operating system in Rust</li>
<li><a href="https://droogmic.github.io/microrust/" target="_blank" rel="noopener">MicroRust</a> Introductory book for embedded development in Rust on the micro:bit.</li>
<li><a href="https://rahul-thakoor.github.io/physical-computing-rust/" target="_blank" rel="noopener">Physical Computing With Rust</a> A (WIP) guide to physical computing with Rust on the Raspberry Pi.</li>
<li><a href="https://github.com/rust-embedded/rust-raspi3-OS-tutorials" target="_blank" rel="noopener">Writing an embedded OS in Rust on the Raspberry Pi</a> A set of tutorials that give a guided, step-by-step tour of how to write a monolithic Operating System kernel for an embedded system from scratch. Runs on the Raspberry Pi 3 and the Raspberry Pi 4.</li>
<li><a href="https://hboeving.dev/blog/rust-2c-driver-p1/" target="_blank" rel="noopener">Writing embedded drivers in Rust isnâ€™t that hard</a> A guide to building an embedded-hal driver. <a href="https://hboeving.dev/blog/rust-i2c-driver-p2/" target="_blank" rel="noopener">Part 2</a></li>
<li><a href="https://github.com/ferrous-systems/embedded-trainings-2020" target="_blank" rel="noopener">Ferrous Systemsâ€™ Embedded Training Courses: 2020-current edition</a> A hands-on training course for beginner and advanced learners of Embedded Rust, based on Nordic Semiconductorâ€™s nRF52840 harware. This training was given at Oxidize Conferences and by <a href="https://ferrous-systems.com/" target="_blank" rel="noopener">Ferrous Systems</a> to corporate customers.</li>
<li><a href="https://knurling.ferrous-systems.com/sessions/" target="_blank" rel="noopener">Ferrous Systemsâ€™ Knurling Sessions</a> are hands-on embedded projects that explore specific concepts using generally available hardware, building full systems and components using microcontrollers, sensors, and actuators.</li>
<li><a href="https://github.com/jacobrosenthal/dsp-discoveryf4-rust/" target="_blank" rel="noopener">DSP on STM32F407G-DISC1</a> Unofficial oxidization of the <a href="https://www.amazon.com/Digital-Signal-Processing-Cortex-M-Microcontrollers/dp/1911531166" target="_blank" rel="noopener">Digital Signal Processing using Arm Cortex-M based Microcontrollers: Theory and Practice</a> book. The book isnâ€™t necessary to enjoy the examples and learn a functional DSP Rust coding style.</li>
</ul>
<hr>
<h1 id="ğŸ˜€ã€ŠThe-Embedded-Rust-Bookã€‹"><a href="#ğŸ˜€ã€ŠThe-Embedded-Rust-Bookã€‹" class="headerlink" title="ğŸ˜€ã€ŠThe Embedded Rust Bookã€‹"></a>ğŸ˜€ã€ŠThe Embedded Rust Bookã€‹</h1><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><h2 id="è®¤è¯†ç¡¬ä»¶"><a href="#è®¤è¯†ç¡¬ä»¶" class="headerlink" title="è®¤è¯†ç¡¬ä»¶"></a>è®¤è¯†ç¡¬ä»¶</h2><p>è®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ç¡¬ä»¶ã€‚</p>
<h3 id="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰"><a href="#STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰" class="headerlink" title="STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰"></a>STM32F3DISCOVERYï¼ˆâ€œF3â€ï¼‰</h3><p><img src="/images/loading.gif" data-original="../images/language/f3-16313292317231.jpg" alt=""></p>
<p>è¿™ä¸ªæ¿å­åŒ…å«ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ä¸€ä¸ª<a href="https://www.st.com/en/microcontrollers/stm32f303vc.html" target="_blank" rel="noopener">STM32F303VCT6</a>å¾®æ§åˆ¶å™¨ã€‚è¿™ä¸ªå¾®æ§åˆ¶å™¨æœ‰<ul>
<li>å•æ ¸ ARM Cortex-M4F å¤„ç†å™¨ï¼Œç¡¬ä»¶æ”¯æŒå•ç²¾åº¦æµ®ç‚¹è¿ç®—ï¼Œæœ€å¤§æ—¶é’Ÿé¢‘ç‡ä¸º 72 MHzã€‚</li>
<li>256 KiB çš„â€œé—ªå­˜â€å†…å­˜ã€‚ï¼ˆ1 KiB = 10 <strong>24</strong>å­—èŠ‚ï¼‰</li>
<li>48 KiB å†…å­˜ã€‚</li>
<li>å¤šç§é›†æˆå¤–è®¾ï¼Œå¦‚å®šæ—¶å™¨ã€I2Cã€SPI å’Œ USARTã€‚</li>
<li>é€šç”¨è¾“å…¥è¾“å‡º (GPIO) å’Œå…¶ä»–ç±»å‹çš„å¼•è„šå¯é€šè¿‡æ¿æ—è¾¹çš„ä¸¤æ’æ¥å¤´è®¿é—®ã€‚</li>
<li>å¯é€šè¿‡æ ‡æœ‰â€œUSB USERâ€çš„ USB ç«¯å£è®¿é—®çš„ USB æ¥å£ã€‚</li>
</ul>
</li>
<li>ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">åŠ é€Ÿè®¡</a>ä½œä¸ºçš„ä¸€éƒ¨åˆ†<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>èŠ¯ç‰‡ã€‚</li>
<li>ç”²<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">ç£åŠ›</a>ä½œä¸ºä¸€éƒ¨åˆ†<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>èŠ¯ç‰‡ã€‚</li>
<li>ç”²<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">é™€èºä»ª</a>ä½œä¸ºä¸€éƒ¨åˆ†<a href="https://www.pololu.com/file/0J563/L3GD20.pdf" target="_blank" rel="noopener">L3GD20</a>èŠ¯ç‰‡ã€‚</li>
<li>8 ä¸ªç”¨æˆ· LED æ’åˆ—æˆæŒ‡å—é’ˆå½¢çŠ¶ã€‚</li>
<li>ç¬¬äºŒä¸ªå¾®æ§åˆ¶å™¨ï¼š<a href="https://www.st.com/en/microcontrollers/stm32f103cb.html" target="_blank" rel="noopener">STM32F103</a>ã€‚è¯¥å¾®æ§åˆ¶å™¨å®é™…ä¸Šæ˜¯æ¿è½½ç¼–ç¨‹å™¨/è°ƒè¯•å™¨çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶è¿æ¥åˆ°åä¸ºâ€œUSB ST-LINKâ€çš„ USB ç«¯å£ã€‚</li>
</ul>
<p>å¦‚éœ€æ›´è¯¦ç»†çš„åŠŸèƒ½åˆ—è¡¨å’Œç”µè·¯æ¿çš„è¿›ä¸€æ­¥è§„æ ¼ï¼Œè¯·è®¿é—®<a href="https://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STMicroelectronics</a>ç½‘ç«™ã€‚</p>
<p>è­¦å‘Šï¼šå¦‚æœæ‚¨æƒ³å°†å¤–éƒ¨ä¿¡å·åº”ç”¨äºç”µè·¯æ¿ï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚å¾®æ§åˆ¶å™¨ STM32F303VCT6 å¼•è„šçš„æ ‡ç§°ç”µå‹ä¸º 3.3 ä¼ã€‚å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ‰‹å†Œä¸­çš„<a href="https://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">6.2 ç»å¯¹æœ€å¤§é¢å®šå€¼éƒ¨åˆ†</a></p>
<h2 id="ä¸€ä¸ªno-std-rustç¯å¢ƒ"><a href="#ä¸€ä¸ªno-std-rustç¯å¢ƒ" class="headerlink" title="ä¸€ä¸ªno_std rustç¯å¢ƒ"></a>ä¸€ä¸ª<code>no_std</code> rustç¯å¢ƒ</h2><p>æœ¯è¯­åµŒå…¥å¼ç¼–ç¨‹ç”¨äºå¹¿æ³›çš„ä¸åŒç±»åˆ«çš„ç¼–ç¨‹ã€‚ä»ç¼–ç¨‹åªæœ‰å‡  KB RAM å’Œ ROM çš„8 ä½ MCUï¼ˆå¦‚<a href="https://www.st.com/resource/en/datasheet/st72325j6.pdf" target="_blank" rel="noopener">ST72325xx</a>ï¼‰ï¼Œåˆ°å…·æœ‰ 32/64 ä½ 4 æ ¸ Cortex-A53 @çš„ Raspberry Piï¼ˆ<a href="https://en.wikipedia.org/wiki/Raspberry_Pi#Specifications" target="_blank" rel="noopener">B å‹ 3+</a>ï¼‰ç­‰ç³»ç»Ÿ1.4 GHz å’Œ 1GB å†…å­˜ã€‚ç¼–å†™ä»£ç æ—¶å°†åº”ç”¨ä¸åŒçš„é™åˆ¶/é™åˆ¶ï¼Œå…·ä½“å–å†³äºæ‚¨æ‹¥æœ‰çš„ç›®æ ‡å’Œç”¨ä¾‹ç±»å‹ã€‚</p>
<p>æœ‰ä¸¤ç§é€šç”¨çš„åµŒå…¥å¼ç¼–ç¨‹åˆ†ç±»ï¼š</p>
<h3 id="æ‰˜ç®¡ç¯å¢ƒ"><a href="#æ‰˜ç®¡ç¯å¢ƒ" class="headerlink" title="æ‰˜ç®¡ç¯å¢ƒ"></a>æ‰˜ç®¡ç¯å¢ƒ</h3><p>è¿™äº›ç±»å‹çš„ç¯å¢ƒæ¥è¿‘äºæ­£å¸¸çš„ PC ç¯å¢ƒã€‚è¿™æ„å‘³ç€æ‚¨æä¾›äº†ä¸€ä¸ªç³»ç»Ÿæ¥å£<a href="https://en.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener">EG POSIX</a> ï¼Œå®ƒä¸ºæ‚¨æä¾›äº†ä¸å„ç§ç³»ç»Ÿäº¤äº’çš„åŸè¯­ï¼Œä¾‹å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹ç­‰ã€‚æ ‡å‡†åº“é€šå¸¸åˆä¾èµ–äºè¿™äº›åŸè¯­æ¥å®ç°ä»–ä»¬çš„åŠŸèƒ½ã€‚æ‚¨å¯èƒ½è¿˜æœ‰æŸç§ sysroot å’Œ RAM/ROM ä½¿ç”¨é™åˆ¶ï¼Œä¹Ÿè®¸è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„ç¡¬ä»¶æˆ– I/Oã€‚æ€»ä½“è€Œè¨€ï¼Œæ„Ÿè§‰å°±åƒåœ¨ä¸“ç”¨ PC ç¯å¢ƒä¸­ç¼–ç ã€‚</p>
<h3 id="è£¸æœºç¯å¢ƒ"><a href="#è£¸æœºç¯å¢ƒ" class="headerlink" title="è£¸æœºç¯å¢ƒ"></a>è£¸æœºç¯å¢ƒ</h3><p>åœ¨è£¸æœºç¯å¢ƒä¸­ï¼Œåœ¨æ‚¨çš„ç¨‹åºä¹‹å‰æ²¡æœ‰åŠ è½½ä»»ä½•ä»£ç ã€‚å¦‚æœæ²¡æœ‰æ“ä½œç³»ç»Ÿæä¾›çš„è½¯ä»¶ï¼Œæˆ‘ä»¬å°†æ— æ³•åŠ è½½æ ‡å‡†åº“ã€‚ç›¸åï¼Œç¨‹åºåŠå…¶ä½¿ç”¨çš„æ¿æ¡ç®±åªèƒ½ä½¿ç”¨ç¡¬ä»¶ï¼ˆè£¸æœºï¼‰æ¥è¿è¡Œã€‚ä¸ºäº†é˜²æ­¢ Rust åŠ è½½æ ‡å‡†åº“ï¼Œè¯·ä½¿ç”¨<code>no_std</code>. æ ‡å‡†åº“çš„å¹³å°æ— å…³éƒ¨åˆ†å¯é€šè¿‡<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore è·å¾—</a>ã€‚libcore è¿˜æ’é™¤äº†åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­å¹¶ä¸æ€»æ˜¯éœ€è¦çš„ä¸œè¥¿ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ç”¨äºåŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åˆ†é…å™¨ã€‚å¦‚æœæ‚¨éœ€è¦æ­¤åŠŸèƒ½æˆ–ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œé€šå¸¸æœ‰æä¾›è¿™äº›åŠŸèƒ½çš„æ¿æ¡ç®±ã€‚</p>
<p>libstd è¿è¡Œæ—¶</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œä½¿ç”¨<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>éœ€è¦æŸç§ç³»ç»Ÿé›†æˆï¼Œä½†è¿™ä¸ä»…æ˜¯å› ä¸º <a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>åªæ˜¯æä¾›ä¸€ç§è®¿é—®æ“ä½œç³»ç»ŸæŠ½è±¡çš„é€šç”¨æ–¹æ³•ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªè¿è¡Œæ—¶ã€‚è¯¥è¿è¡Œæ—¶è´Ÿè´£è®¾ç½®å †æ ˆæº¢å‡ºä¿æŠ¤ã€å¤„ç†å‘½ä»¤è¡Œå‚æ•°ä»¥åŠåœ¨è°ƒç”¨ç¨‹åºçš„ä¸»å‡½æ•°ä¹‹å‰ç”Ÿæˆä¸»çº¿ç¨‹ã€‚æ­¤è¿è¡Œæ—¶åœ¨<code>no_std</code>ç¯å¢ƒä¸­ä¹Ÿä¸å¯ç”¨ã€‚</p>
<h3 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h3><p><code>#![no_std]</code>æ˜¯ä¸€ä¸ª crate çº§åˆ«çš„å±æ€§ï¼Œè¡¨ç¤º crate å°†é“¾æ¥åˆ° core-crate è€Œä¸æ˜¯ std-crateã€‚åè¿‡æ¥ï¼Œ<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a> crate æ˜¯ std crate ä¸å¹³å°æ— å…³çš„å­é›†ï¼Œå®ƒä¸å¯¹ç¨‹åºå°†åœ¨å…¶ä¸Šè¿è¡Œçš„ç³»ç»Ÿåšä»»ä½•å‡è®¾ã€‚å› æ­¤ï¼Œå®ƒä¸ºæµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡ç­‰è¯­è¨€åŸè¯­æä¾› APIï¼Œä»¥åŠå…¬å¼€åŸå­æ“ä½œå’Œ SIMD æŒ‡ä»¤ç­‰å¤„ç†å™¨åŠŸèƒ½çš„ APIã€‚ç„¶è€Œï¼Œå®ƒç¼ºå°‘ä»»ä½•æ¶‰åŠå¹³å°é›†æˆçš„ APIã€‚ç”±äºè¿™äº›å±æ€§ï¼Œno_std å’Œ<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a>ä»£ç å¯ç”¨äºä»»ä½•ç±»å‹çš„å¼•å¯¼ï¼ˆé˜¶æ®µ 0ï¼‰ä»£ç ï¼Œå¦‚å¼•å¯¼åŠ è½½ç¨‹åºã€å›ºä»¶æˆ–å†…æ ¸ã€‚</p>
<h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><table>
<thead>
<tr>
<th>ç‰¹å¾</th>
<th>no_std</th>
<th>æ ‡å‡†</th>
</tr>
</thead>
<tbody><tr>
<td>å †ï¼ˆåŠ¨æ€å†…å­˜ï¼‰</td>
<td>*</td>
<td>âœ“</td>
</tr>
<tr>
<td>é›†åˆï¼ˆVecã€HashMap ç­‰ï¼‰</td>
<td>**</td>
<td>âœ“</td>
</tr>
<tr>
<td>å †æ ˆæº¢å‡ºä¿æŠ¤</td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>åœ¨ main ä¹‹å‰è¿è¡Œåˆå§‹åŒ–ä»£ç </td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>libstd å¯ç”¨</td>
<td>âœ˜</td>
<td>âœ“</td>
</tr>
<tr>
<td>libcore å¯ç”¨</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
<tr>
<td>ç¼–å†™å›ºä»¶ã€å†…æ ¸æˆ–å¼•å¯¼åŠ è½½ç¨‹åºä»£ç </td>
<td>âœ“</td>
<td>âœ˜</td>
</tr>
</tbody></table>
<p>* ä»…å½“æ‚¨ä½¿ç”¨<code>alloc</code>crate å¹¶ä½¿ç”¨åˆé€‚çš„åˆ†é…å™¨ï¼ˆå¦‚<a href="https://github.com/rust-embedded/alloc-cortex-m" target="_blank" rel="noopener">alloc-cortex-m ï¼‰æ—¶</a>ã€‚</p>
<p>** ä»…å½“æ‚¨ä½¿ç”¨<code>collections</code>crate å¹¶é…ç½®å…¨å±€é»˜è®¤åˆ†é…å™¨æ—¶ã€‚</p>
<h3 id="ä¹Ÿå¯ä»¥çœ‹çœ‹"><a href="#ä¹Ÿå¯ä»¥çœ‹çœ‹" class="headerlink" title="ä¹Ÿå¯ä»¥çœ‹çœ‹"></a>ä¹Ÿå¯ä»¥çœ‹çœ‹</h3><ul>
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1184-stabilize-no_std.md" target="_blank" rel="noopener">RFC-1184</a></li>
</ul>
<h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>å¤„ç†å¾®æ§åˆ¶å™¨æ¶‰åŠä½¿ç”¨å‡ ç§ä¸åŒçš„å·¥å…·ï¼Œå› ä¸ºæˆ‘ä»¬å°†å¤„ç†ä¸ç¬”è®°æœ¬ç”µè„‘ä¸åŒçš„æ¶æ„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨<em>è¿œç¨‹</em>è®¾å¤‡ä¸Šè¿è¡Œå’Œè°ƒè¯•ç¨‹åºã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢åˆ—å‡ºçš„æ‰€æœ‰å·¥å…·ã€‚å½“æœªæŒ‡å®šæœ€ä½ç‰ˆæœ¬æ—¶ï¼Œä»»ä½•æœ€æ–°ç‰ˆæœ¬éƒ½åº”è¯¥å¯ä»¥å·¥ä½œï¼Œä½†æˆ‘ä»¬å·²ç»åˆ—å‡ºäº†æˆ‘ä»¬æµ‹è¯•è¿‡çš„ç‰ˆæœ¬ã€‚</p>
<ul>
<li>Rust 1.31ã€1.31-beta æˆ–æ›´æ–°çš„å·¥å…·é“¾åŠ ä¸Š ARM Cortex-M ç¼–è¯‘æ”¯æŒã€‚</li>
<li><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a> ~0.1.4</li>
<li><a href="https://www.qemu.org/" target="_blank" rel="noopener"><code>qemu-system-arm</code></a>. æµ‹è¯•ç‰ˆæœ¬ï¼š3.0.0</li>
<li>OpenOCD &gt;=0.8ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼šv0.9.0 å’Œ v0.10.0</li>
<li>å…·æœ‰ ARM æ”¯æŒçš„ GDBã€‚å¼ºçƒˆå»ºè®®ä½¿ç”¨ 7.12 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚æµ‹è¯•ç‰ˆæœ¬ï¼š7.10ã€7.11ã€7.12 å’Œ 8.1</li>
<li><a href="https://github.com/ashleygwilliams/cargo-generate" target="_blank" rel="noopener"><code>cargo-generate</code></a>æˆ–<code>git</code>ã€‚è¿™äº›å·¥å…·æ˜¯å¯é€‰çš„ï¼Œä½†å¯ä»¥æ›´è½»æ¾åœ°è·Ÿéšæœ¬ä¹¦è¿›è¡Œå­¦ä¹ ã€‚</li>
</ul>
<p>ä¸‹é¢çš„æ–‡å­—è§£é‡Šäº†æˆ‘ä»¬ä½¿ç”¨è¿™äº›å·¥å…·çš„åŸå› ã€‚å®‰è£…è¯´æ˜å¯ä»¥åœ¨ä¸‹ä¸€é¡µæ‰¾åˆ°ã€‚</p>
<h3 id="cargo-generate-æˆ–è€…-git"><a href="#cargo-generate-æˆ–è€…-git" class="headerlink" title="cargo-generate æˆ–è€… git"></a><code>cargo-generate</code> æˆ–è€… <code>git</code></h3><p>è£¸æœºç¨‹åºæ˜¯éæ ‡å‡†çš„ ( <code>no_std</code>) Rust ç¨‹åºï¼Œéœ€è¦å¯¹é“¾æ¥è¿‡ç¨‹è¿›è¡Œä¸€äº›è°ƒæ•´æ‰èƒ½ä½¿ç¨‹åºçš„å†…å­˜å¸ƒå±€æ­£ç¡®ã€‚è¿™éœ€è¦ä¸€äº›é¢å¤–çš„æ–‡ä»¶ï¼ˆå¦‚é“¾æ¥å™¨è„šæœ¬ï¼‰å’Œè®¾ç½®ï¼ˆå¦‚é“¾æ¥å™¨æ ‡å¿—ï¼‰ã€‚æˆ‘ä»¬ä¸ºæ‚¨æ‰“åŒ…äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œæ‚¨åªéœ€å¡«å†™ç¼ºå°‘çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚é¡¹ç›®åç§°å’Œç›®æ ‡ç¡¬ä»¶çš„ç‰¹æ€§ï¼‰ã€‚</p>
<p>æˆ‘ä»¬çš„æ¨¡æ¿å…¼å®¹<code>cargo-generate</code>ï¼šç”¨äºä»æ¨¡æ¿åˆ›å»ºæ–° Cargo é¡¹ç›®çš„ Cargo å­å‘½ä»¤ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸‹è½½æ¨¡æ¿<code>git</code>ï¼Œ<code>curl</code>ï¼Œ<code>wget</code>ï¼Œæˆ–Webæµè§ˆå™¨ã€‚</p>
<h3 id="cargo-binutils"><a href="#cargo-binutils" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><p><code>cargo-binutils</code>æ˜¯ Cargo å­å‘½ä»¤çš„é›†åˆï¼Œå¯ä»¥è½»æ¾ä½¿ç”¨ Rust å·¥å…·é“¾é™„å¸¦çš„ LLVM å·¥å…·ã€‚è¿™äº›å·¥å…·åŒ…æ‹¬<code>objdump</code>ã€<code>nm</code>å’Œçš„ LLVM ç‰ˆæœ¬ï¼Œ<code>size</code>ç”¨äºæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>ä¸ GNU binutils ç›¸æ¯”ï¼Œä½¿ç”¨è¿™äº›å·¥å…·çš„ä¼˜åŠ¿åœ¨äº (a) å®‰è£… LLVM å·¥å…·æ˜¯ç›¸åŒçš„å•å‘½ä»¤å®‰è£… ( <code>rustup component add llvm-tools-preview</code>)ï¼Œæ— è®ºæ‚¨çš„æ“ä½œç³»ç»Ÿå¦‚ä½•ï¼Œä»¥åŠ (b)<code>objdump</code>æ”¯æŒæ‰€æœ‰<code>rustc</code>æ”¯æŒæ¶æ„çš„å·¥å…·â€”â€”ä» ARM åˆ° x86_64â€”â€” - å› ä¸ºå®ƒä»¬å…±äº«ç›¸åŒçš„ LLVM åç«¯ã€‚</p>
<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu-system-arm"></a><code>qemu-system-arm</code></h3><p>QEMU æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯ä»¥å®Œå…¨æ¨¡æ‹Ÿ ARM ç³»ç»Ÿçš„å˜ä½“ã€‚æˆ‘ä»¬ä½¿ç”¨ QEMU åœ¨ä¸»æœºä¸Šè¿è¡ŒåµŒå…¥å¼ç¨‹åºã€‚å¤šäºäº†è¿™ä¸€ç‚¹ï¼Œå³ä½¿æ‚¨æ²¡æœ‰ä»»ä½•ç¡¬ä»¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥éµå¾ªæœ¬ä¹¦çš„æŸäº›éƒ¨åˆ†ï¼</p>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><p>è°ƒè¯•å™¨æ˜¯åµŒå…¥å¼å¼€å‘çš„ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼Œå› ä¸ºæ‚¨å¯èƒ½å¹¶ä¸æ€»æ˜¯èƒ½å¤Ÿå°†å†…å®¹è®°å½•åˆ°ä¸»æœºæ§åˆ¶å°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨çš„ç¡¬ä»¶ç”šè‡³å¯èƒ½æ²¡æœ‰ LED æŒ‡ç¤ºç¯é—ªçƒï¼</p>
<p>æ€»çš„æ¥è¯´ï¼ŒLLDB åœ¨è°ƒè¯•æ–¹é¢çš„æ•ˆæœä¸ GDB ä¸€æ ·å¥½ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾åˆ° GDB çš„<code>load</code>å‘½ä»¤çš„ LLDB å¯¹åº”é¡¹ï¼Œå®ƒå°†ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡ç¡¬ä»¶ï¼Œå› æ­¤ç›®å‰æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ GDBã€‚</p>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>GDB æ— æ³•ç›´æ¥ä¸ STM32F3DISCOVERY å¼€å‘æ¿ä¸Šçš„ ST-Link è°ƒè¯•ç¡¬ä»¶é€šä¿¡ã€‚å®ƒéœ€è¦ä¸€ä¸ªè½¬æ¢å™¨ï¼Œè€Œå¼€æ”¾å¼ç‰‡ä¸Šè°ƒè¯•å™¨ OpenOCD å°±æ˜¯é‚£ä¸ªè½¬æ¢å™¨ã€‚OpenOCD æ˜¯ä¸€ä¸ªåœ¨æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC ä¸Šè¿è¡Œçš„ç¨‹åºï¼Œå¯åœ¨ GDB çš„åŸºäº TCP/IP çš„è¿œç¨‹è°ƒè¯•åè®®å’Œ ST-Link çš„åŸºäº USB çš„åè®®ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p>
<p>OpenOCD è¿˜æ‰§è¡Œå…¶ä»–é‡è¦å·¥ä½œï¼Œä½œä¸ºå…¶åœ¨ STM32F3DISCOVERY å¼€å‘æ¿ä¸Šè°ƒè¯•åŸºäº ARM Cortex-M çš„å¾®æ§åˆ¶å™¨çš„ç¿»è¯‘çš„ä¸€éƒ¨åˆ†ï¼š</p>
<ul>
<li>å®ƒçŸ¥é“å¦‚ä½•ä¸ ARM CoreSight è°ƒè¯•å¤–è®¾ä½¿ç”¨çš„å†…å­˜æ˜ å°„å¯„å­˜å™¨è¿›è¡Œäº¤äº’ã€‚æ­£æ˜¯è¿™äº› CoreSight å¯„å­˜å™¨å…è®¸ï¼š<ul>
<li>æ–­ç‚¹/è§‚å¯Ÿç‚¹æ“ä½œ</li>
<li>è¯»å–å’Œå†™å…¥ CPU å¯„å­˜å™¨</li>
<li>æ£€æµ‹ CPU ä½•æ—¶å› è°ƒè¯•äº‹ä»¶è€Œåœæ­¢</li>
<li>é‡åˆ°è°ƒè¯•äº‹ä»¶åç»§ç»­æ‰§è¡Œ CPU</li>
<li>ç­‰ç­‰ã€‚</li>
</ul>
</li>
<li>å®ƒè¿˜çŸ¥é“å¦‚ä½•æ“¦é™¤å’Œå†™å…¥å¾®æ§åˆ¶å™¨çš„ FLASH</li>
</ul>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>æ­¤é¡µé¢åŒ…å«ä¸€äº›å·¥å…·çš„ä¸æ“ä½œç³»ç»Ÿæ— å…³çš„å®‰è£…è¯´æ˜ï¼š</p>
<h3 id="Rust-å·¥å…·é“¾"><a href="#Rust-å·¥å…·é“¾" class="headerlink" title="Rust å·¥å…·é“¾"></a>Rust å·¥å…·é“¾</h3><p>æŒ‰ç…§<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs </a>ä¸Šçš„è¯´æ˜å®‰è£… rustup ã€‚</p>
<p><strong>æ³¨æ„</strong>ç¡®ä¿æ‚¨çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ç­‰äºæˆ–é«˜äº<code>1.31</code>. <code>rustc -V</code>åº”è¯¥è¿”å›ä¸€ä¸ªæ¯”ä¸‹é¢æ˜¾ç¤ºçš„æ—¥æœŸæ–°çš„æ—¥æœŸã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ rustc -V
rustc 1.31.1 (b6c32da9b 2018-12-18)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¯¹äºå¸¦å®½å’Œç£ç›˜ä½¿ç”¨é—®é¢˜ï¼Œé»˜è®¤å®‰è£…ä»…æ”¯æŒæœ¬æœºç¼–è¯‘ã€‚è¦ä¸º ARM Cortex-M æ¶æ„æ·»åŠ äº¤å‰ç¼–è¯‘æ”¯æŒï¼Œè¯·é€‰æ‹©ä»¥ä¸‹ç¼–è¯‘ç›®æ ‡ä¹‹ä¸€ã€‚å¯¹äºæœ¬ä¹¦ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ STM32F3DISCOVERY æ¿ï¼Œè¯·ä½¿ç”¨<code>thumbv7em-none-eabihf</code>ç›®æ ‡ã€‚</p>
<p>Cortex-M0ã€M0+ å’Œ M1ï¼ˆARMv6-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M3ï¼ˆARMv7-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ— ç¡¬ä»¶æµ®ç‚¹çš„ Cortex-M4 å’Œ M7ï¼ˆARMv7E-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¸¦æœ‰ç¡¬ä»¶æµ®ç‚¹çš„ Cortex-M4F å’Œ M7Fï¼ˆARMv7E-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M23ï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.base-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33 å’Œ M35Pï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33F å’Œ M35PF å¸¦ç¡¬ä»¶æµ®ç‚¹ï¼ˆARMv8-M æ¶æ„ï¼‰ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="cargo-binutils-1"><a href="#cargo-binutils-1" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><pre class="line-numbers language-text"><code class="language-text">cargo install cargo-binutils

rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-generate"><a href="#cargo-generate" class="headerlink" title="cargo-generate"></a><code>cargo-generate</code></h3><p>ç¨åæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»æ¨¡æ¿ç”Ÿæˆé¡¹ç›®ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>ä»¥ä¸‹æ˜¯ä¸€äº› Linux å‘è¡Œç‰ˆçš„å®‰è£…å‘½ä»¤ã€‚</p>
<h4 id="å¥—é¤"><a href="#å¥—é¤" class="headerlink" title="å¥—é¤"></a>å¥—é¤</h4><ul>
<li>Ubuntu 18.04 æˆ–æ›´é«˜ç‰ˆæœ¬/Debian å»¶ä¼¸ç‰ˆæˆ–æ›´é«˜ç‰ˆæœ¬</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>gdb-multiarch</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-multiarch openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Ubuntu 14.04 å’Œ 16.04</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-arm-none-eabi openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Fedora 27 æˆ–æ›´æ–°ç‰ˆæœ¬</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo dnf install arm-none-eabi-gdb openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>æ‹±å½¢Linux</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong> <code>arm-none-eabi-gdb</code>æ˜¯æ‚¨å°†ç”¨äºè°ƒè¯• ARM Cortex-M ç¨‹åºçš„ GDB å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S arm-none-eabi-gdb qemu-arch-extra openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="udev-è§„åˆ™"><a href="#udev-è§„åˆ™" class="headerlink" title="udev è§„åˆ™"></a>udev è§„åˆ™</h4><p>æ­¤è§„åˆ™å…è®¸æ‚¨åœ¨æ²¡æœ‰ root æƒé™çš„æƒ…å†µä¸‹å°† OpenOCD ä¸ Discovery æ¿ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p><code>/etc/udev/rules.d/70-st-link.rules</code>ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å†…å®¹åˆ›å»ºæ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY rev A/B - ST-LINK/V2
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="3748", TAG+="uaccess"

# STM32F3DISCOVERY rev C+ - ST-LINK/V2-1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", TAG+="uaccess"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°åŠ è½½æ‰€æœ‰ udev è§„åˆ™ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¦‚æœæ‚¨å°†ç”µè·¯æ¿æ’å…¥ç¬”è®°æœ¬ç”µè„‘ï¼Œè¯·å°†å…¶æ‹”ä¸‹ï¼Œç„¶åå†é‡æ–°æ’å…¥ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥æƒé™ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å“ªä¸ªåº”è¯¥æ˜¾ç¤ºç±»ä¼¼</p>
<pre class="line-numbers language-text"><code class="language-text">(..)
Bus 001 Device 018: ID 0483:374b STMicroelectronics ST-LINK/V2.1
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è®°ä¸‹æ€»çº¿å’Œè®¾å¤‡ç¼–å·ã€‚ä½¿ç”¨è¿™äº›æ•°å­—åˆ›å»ºä¸€ä¸ªç±»ä¼¼ <code>/dev/bus/usb/&lt;bus&gt;/&lt;device&gt;</code>. ç„¶ååƒè¿™æ ·ä½¿ç”¨è¿™ä¸ªè·¯å¾„ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">ls -l /dev/bus/usb/001/018
crw-------+ 1 root root 189, 17 Sep 13 12:34 /dev/bus/usb/001/018
getfacl /dev/bus/usb/001/018 | grep user
user::rw-
user:you:rw-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨<code>+</code>é™„åŠ åˆ°æƒé™æŒ‡ç¤ºæ‰©å±•çš„è®¸å¯çš„å­˜åœ¨ã€‚è¯¥<code>getfacl</code>å‘½ä»¤å‘Šè¯‰ç”¨æˆ·<code>you</code>å¯ä»¥ä½¿ç”¨è¯¥è®¾å¤‡ã€‚</p>
<h3 id="è‹¹æœç³»ç»Ÿ"><a href="#è‹¹æœç³»ç»Ÿ" class="headerlink" title="è‹¹æœç³»ç»Ÿ"></a>è‹¹æœç³»ç»Ÿ</h3><p>æ‰€æœ‰å·¥å…·éƒ½å¯ä»¥ä½¿ç”¨<a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>å®‰è£…ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ # GDB
$ brew install armmbed/formulae/arm-none-eabi-gcc

$ # OpenOCD
$ brew install openocd

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="arm-none-eabi-gdb"><a href="#arm-none-eabi-gdb" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h4><p>ARM<code>.exe</code>ä¸º Windowsæä¾›å®‰è£…ç¨‹åºã€‚ä»<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‹¿ä¸€ä¸ªï¼Œç„¶åæŒ‰ç…§è¯´æ˜æ“ä½œã€‚å°±åœ¨å®‰è£…è¿‡ç¨‹å®Œæˆä¹‹å‰ï¼Œå‹¾é€‰/é€‰æ‹©â€œæ·»åŠ ç¯å¢ƒå˜é‡è·¯å¾„â€é€‰é¡¹ã€‚ç„¶åéªŒè¯å·¥å…·æ˜¯å¦åœ¨æ‚¨çš„<code>%PATH%</code>ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ arm-none-eabi-gdb -v
GNU gdb (GNU Tools for Arm Embedded Processors 7-2018-q2-update) 8.1.0.20180315-git
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="å¼€æ”¾å¼å¼ºè¿«ç—‡"><a href="#å¼€æ”¾å¼å¼ºè¿«ç—‡" class="headerlink" title="å¼€æ”¾å¼å¼ºè¿«ç—‡"></a>å¼€æ”¾å¼å¼ºè¿«ç—‡</h4><p>æ²¡æœ‰ç”¨äº Windows çš„ OpenOCD çš„å®˜æ–¹äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨ä¸æƒ³è‡ªå·±ç¼–è¯‘å®ƒï¼ŒxPack é¡¹ç›®æä¾›äº†ä¸€ä¸ªäºŒè¿›åˆ¶å‘è¡Œç‰ˆï¼Œè¯·<a href="https://xpack.github.io/openocd/" target="_blank" rel="noopener">ç‚¹å‡»æ­¤å¤„</a>ã€‚æŒ‰ç…§æä¾›çš„å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œã€‚ç„¶åæ›´æ–°æ‚¨çš„<code>%PATH%</code>ç¯å¢ƒå˜é‡ä»¥åŒ…å«å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ã€‚( <code>C:\Users\USERNAME\AppData\Roaming\xPacks\@xpack-dev-tools\openocd\0.10.0-13.1\.content\bin\</code>, å¦‚æœæ‚¨ä¸€ç›´åœ¨ä½¿ç”¨ç®€æ˜“å®‰è£…)</p>
<p>éªŒè¯ OpenOCD æ˜¯å¦åœ¨æ‚¨çš„ç›®å½•<code>%PATH%</code>ä¸­ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="åŠ¨è½¦ç»„"><a href="#åŠ¨è½¦ç»„" class="headerlink" title="åŠ¨è½¦ç»„"></a>åŠ¨è½¦ç»„</h4><p>ä»<a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™è·å–</a>QEMU ã€‚</p>
<h4 id="ST-LINK-USB-é©±åŠ¨"><a href="#ST-LINK-USB-é©±åŠ¨" class="headerlink" title="ST-LINK USB é©±åŠ¨"></a>ST-LINK USB é©±åŠ¨</h4><p>æ‚¨è¿˜éœ€è¦å®‰è£…<a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">æ­¤ USB é©±åŠ¨ç¨‹åº</a>ï¼Œå¦åˆ™ OpenOCD å°†æ— æ³•å·¥ä½œã€‚æŒ‰ç…§å®‰è£…ç¨‹åºè¯´æ˜è¿›è¡Œæ“ä½œï¼Œå¹¶ç¡®ä¿å®‰è£…æ­£ç¡®ç‰ˆæœ¬ï¼ˆ32 ä½æˆ– 64 ä½ï¼‰çš„é©±åŠ¨ç¨‹åºã€‚</p>
<h3 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h3><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€äº›å¿…éœ€çš„å·¥å…·/é©±åŠ¨ç¨‹åºæ˜¯å¦å·²æ­£ç¡®å®‰è£…å’Œé…ç½®ã€‚</p>
<p>ä½¿ç”¨å¾®å‹ USB ç”µç¼†å°†æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC è¿æ¥åˆ°å‘ç°æ¿ã€‚å‘ç°æ¿æœ‰ä¸¤ä¸ª USB è¿æ¥å™¨ï¼›ä½¿ç”¨ä½äºç”µè·¯æ¿è¾¹ç¼˜ä¸­å¿ƒçš„æ ‡æœ‰â€œUSB ST-LINKâ€çš„é‚£ä¸ªã€‚</p>
<p>è¿˜è¦æ£€æŸ¥æ˜¯å¦å¡«å……äº† ST-LINK æ ‡å¤´ã€‚è§ä¸‹å›¾ï¼›ST-LINK æ ‡å¤´ä»¥çº¢è‰²åœˆå‡ºã€‚</p>
<p><img src="/images/loading.gif" data-original="../images/language/verify.jpeg" alt=""></p>
<p>ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šæ—§ç‰ˆæœ¬çš„ openocdï¼ŒåŒ…æ‹¬ 2017 å¹´çš„ 0.10.0 ç‰ˆæœ¬ï¼Œä¸åŒ…å«æ–°çš„ï¼ˆå’Œæ›´å¯å–çš„ï¼‰<code>interface/stlink.cfg</code>æ–‡ä»¶ï¼›ç›¸åï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨<code>interface/stlink-v2.cfg</code>æˆ–<code>interface/stlink-v2-1.cfg</code>ã€‚</p>
</blockquote>
<p>æ‚¨åº”è¯¥å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œå¹¶ä¸”ç¨‹åºåº”è¯¥é˜»æ­¢æ§åˆ¶å°ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.919881
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†…å®¹å¯èƒ½ä¸å®Œå…¨åŒ¹é…ï¼Œä½†æ‚¨åº”è¯¥å¾—åˆ°å…³äºæ–­ç‚¹å’Œè§‚å¯Ÿç‚¹çš„æœ€åä¸€è¡Œã€‚å¦‚æœæ‚¨å¾—åˆ°å®ƒï¼Œåˆ™ç»ˆæ­¢ OpenOCD è¿›ç¨‹å¹¶è½¬åˆ°<a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">ä¸‹ä¸€éƒ¨åˆ†</a>ã€‚</p>
<p>å¦‚æœæ‚¨æ²¡æœ‰å¾—åˆ°â€œæ–­ç‚¹â€è¡Œï¼Œè¯·å°è¯•ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2.cfg -f target/stm32f3x.cfg
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¦‚æœå…¶ä¸­ä¸€ä¸ªå‘½ä»¤æœ‰æ•ˆï¼Œåˆ™æ„å‘³ç€æ‚¨è·å¾—äº†å‘ç°æ¿çš„æ—§ç¡¬ä»¶ç‰ˆæœ¬ã€‚è¿™ä¸ä¼šæˆä¸ºé—®é¢˜ï¼Œä½†è¯·å°†æ­¤äº‹å®è®°å…¥å†…å­˜ï¼Œå› ä¸ºæ‚¨ç¨åéœ€è¦ä»¥ä¸åŒçš„æ–¹å¼é…ç½®å†…å®¹ã€‚æ‚¨å¯ä»¥è½¬åˆ° <a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">ä¸‹ä¸€éƒ¨åˆ†</a>ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ä»»ä½•å‘½ä»¤ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œï¼Œåˆ™å°è¯•ä»¥ root æƒé™ï¼ˆä¾‹å¦‚<code>sudo openocd ..</code>ï¼‰è¿è¡Œå®ƒä»¬ã€‚å¦‚æœå‘½ä»¤ç¡®å®åœ¨ root æƒé™ä¸‹å·¥ä½œï¼Œåˆ™æ£€æŸ¥<a href="https://docs.rust-embedded.org/book/intro/install/linux.html#udev-rules" target="_blank" rel="noopener">udev è§„åˆ™</a>æ˜¯å¦å·²æ­£ç¡®è®¾ç½®ã€‚</p>
<h1 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h1><h2 id="QUEM"><a href="#QUEM" class="headerlink" title="QUEM"></a>QUEM</h2><p>æˆ‘ä»¬å°†å¼€å§‹ä¸ºCortex-M3 å¾®æ§åˆ¶å™¨<a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>ç¼–å†™ç¨‹åºã€‚æˆ‘ä»¬é€‰æ‹©å®ƒä½œä¸ºæˆ‘ä»¬çš„åˆå§‹ç›®æ ‡ï¼Œå› ä¸ºå®ƒ<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">å¯ä»¥</a>ä½¿ç”¨ QEMU<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">è¿›è¡Œæ¨¡æ‹Ÿ</a>ï¼Œå› æ­¤æ‚¨æ— éœ€åœ¨æœ¬èŠ‚ä¸­æ‘†å¼„ç¡¬ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“æ³¨äºå·¥å…·å’Œå¼€å‘è¿‡ç¨‹ã€‚</p>
<p><strong>é‡è¦ä¿¡æ¯</strong> åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åç§°â€œappâ€ä½œä¸ºé¡¹ç›®åç§°ã€‚æ¯å½“æ‚¨çœ‹åˆ°â€œappâ€ä¸€è¯æ—¶ï¼Œæ‚¨éƒ½åº”è¯¥å°†å…¶æ›¿æ¢ä¸ºæ‚¨ä¸ºé¡¹ç›®é€‰æ‹©çš„åç§°ã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†æ‚¨çš„é¡¹ç›®å‘½åä¸ºâ€œappâ€å¹¶é¿å…æ›¿æ¢ã€‚</p>
<h3 id="åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„-Rust-ç¨‹åº"><a href="#åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„-Rust-ç¨‹åº" class="headerlink" title="åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„ Rust ç¨‹åº"></a>åˆ›å»ºä¸€ä¸ªéæ ‡å‡†çš„ Rust ç¨‹åº</h3><p>æˆ‘ä»¬å°†ä½¿ç”¨<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>é¡¹ç›®æ¨¡æ¿ä»ä¸­ç”Ÿæˆä¸€ä¸ªæ–°é¡¹ç›®ã€‚åˆ›å»ºçš„é¡¹ç›®å°†åŒ…å«ä¸€ä¸ªå‡†ç³»ç»Ÿåº”ç”¨ç¨‹åºï¼šä¸€ä¸ªæ–°çš„åµŒå…¥å¼ Rust åº”ç”¨ç¨‹åºçš„è‰¯å¥½èµ·ç‚¹ã€‚æ­¤å¤–ï¼Œè¯¥é¡¹ç›®å°†åŒ…å«ä¸€ä¸ª<code>examples</code>ç›®å½•ï¼Œå…¶ä¸­åŒ…å«å‡ ä¸ªå•ç‹¬çš„åº”ç”¨ç¨‹åºï¼Œçªå‡ºæ˜¾ç¤ºäº†ä¸€äº›å…³é”®çš„åµŒå…¥å¼ Rust åŠŸèƒ½ã€‚</p>
<h4 id="ä½¿ç”¨-cargo-generate"><a href="#ä½¿ç”¨-cargo-generate" class="headerlink" title="ä½¿ç”¨ cargo-generate"></a>ä½¿ç”¨ <code>cargo-generate</code></h4><p>é¦–å…ˆå®‰è£…è´§ç‰©ç”Ÿæˆ</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç„¶åç”Ÿæˆä¸€ä¸ªæ–°é¡¹ç›®</p>
<pre class="line-numbers language-console"><code class="language-console">cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä½¿ç”¨-git"><a href="#ä½¿ç”¨-git" class="headerlink" title="ä½¿ç”¨ git"></a>ä½¿ç”¨ <code>git</code></h4><p>å…‹éš†å­˜å‚¨åº“</p>
<pre class="line-numbers language-console"><code class="language-console">git clone https://github.com/rust-embedded/cortex-m-quickstart app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åå¡«å†™<code>Cargo.toml</code>æ–‡ä»¶ä¸­çš„å ä½ç¬¦</p>
<pre class="line-numbers language-toml"><code class="language-toml">[package]
authors = ["{{authors}}"] # "{{authors}}" -> "John Smith"
edition = "2018"
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
version = "0.1.0"

# ..

[[bin]]
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
test = false
bench = false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ä½¿ç”¨neither"><a href="#ä½¿ç”¨neither" class="headerlink" title="ä½¿ç”¨neither"></a>ä½¿ç”¨<code>neither</code></h4><p>è·å–<code>cortex-m-quickstart</code>æ¨¡æ¿çš„æœ€æ–°å¿«ç…§å¹¶æå–å®ƒã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">curl -LO https://github.com/rust-embedded/cortex-m-quickstart/archive/master.zip
unzip master.zip
mv cortex-m-quickstart-master app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ–è€…æ‚¨å¯ä»¥æµè§ˆåˆ°<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>ï¼Œå•å‡»ç»¿è‰²çš„â€œå…‹éš†æˆ–ä¸‹è½½â€æŒ‰é’®ï¼Œç„¶åå•å‡»â€œä¸‹è½½ ZIPâ€ã€‚</p>
<p>ç„¶å<code>Cargo.toml</code>æŒ‰ç…§â€œä½¿ç”¨<code>git</code>â€ç‰ˆæœ¬çš„ç¬¬äºŒéƒ¨åˆ†ä¸­çš„æ–¹æ³•å¡«å†™æ–‡ä»¶ä¸­çš„å ä½ç¬¦ã€‚</p>
<h3 id="ç¨‹åºæ¦‚è§ˆ"><a href="#ç¨‹åºæ¦‚è§ˆ" class="headerlink" title="ç¨‹åºæ¦‚è§ˆ"></a>ç¨‹åºæ¦‚è§ˆ</h3><p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œæ˜¯æºä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†<code>src/main.rs</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// your code goes here</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªç¨‹åºä¸æ ‡å‡†çš„ Rust ç¨‹åºæœ‰ç‚¹ä¸åŒï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ã€‚</p>
<p><code>#![no_std]</code>è¡¨ç¤ºè¿™ä¸ªç¨‹åº<em>ä¸ä¼š</em>é“¾æ¥åˆ°æ ‡å‡†åŒ…ï¼Œ <code>std</code>. ç›¸åï¼Œå®ƒå°†é“¾æ¥åˆ°å®ƒçš„å­é›†ï¼š<code>core</code>æ¿æ¡ç®±ã€‚</p>
<p><code>#![no_main]</code>è¡¨ç¤ºè¿™ä¸ªç¨‹åºä¸ä¼šä½¿ç”¨<code>main</code> å¤§å¤šæ•° Rust ç¨‹åºä½¿ç”¨çš„æ ‡å‡†æ¥å£ã€‚ä¸»è¦ï¼ˆæ²¡æœ‰åŒå…³è¯­ï¼‰çš„åŸå› <code>no_main</code>æ˜¯<code>main</code>åœ¨<code>no_std</code>ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ç•Œé¢éœ€è¦æ¯æ™šã€‚</p>
<p><code>use panic_halt as _;</code>. è¿™ä¸ª crate æä¾›äº†ä¸€ä¸ª<code>panic_handler</code>å®šä¹‰ç¨‹åºçš„ææ…Œè¡Œä¸ºã€‚</p>
<p><a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.entry.html" target="_blank" rel="noopener"><code>#[entry]</code></a>æ˜¯<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>crateæä¾›çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæ ‡è®°ç¨‹åºçš„å…¥å£ç‚¹ã€‚ç”±äºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨æ ‡å‡†<code>main</code> æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ç§æ–¹å¼æ¥æŒ‡ç¤ºç¨‹åºçš„å…¥å£ç‚¹ï¼Œé‚£å°±æ˜¯<code>#[entry]</code>.</p>
<p><code>fn main() -&gt; !</code>. æˆ‘ä»¬çš„ç¨‹åºå°†æ˜¯ç›®æ ‡ç¡¬ä»¶ä¸Šè¿è¡Œçš„<em>å”¯ä¸€</em>è¿›ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¸Œæœ›å®ƒç»“æŸï¼æˆ‘ä»¬ä½¿ç”¨<a href="https://doc.rust-lang.org/rust-by-example/fn/diverging.html" target="_blank" rel="noopener">å‘æ•£å‡½æ•°</a>ï¼ˆ<code>-&gt; !</code> å‡½æ•°ç­¾åä¸­çš„ä½ï¼‰æ¥ç¡®ä¿åœ¨ç¼–è¯‘æ—¶å°±æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<h3 id="äº¤å‰ç¼–è¯‘"><a href="#äº¤å‰ç¼–è¯‘" class="headerlink" title="äº¤å‰ç¼–è¯‘"></a>äº¤å‰ç¼–è¯‘</h3><p>ä¸‹ä¸€æ­¥æ˜¯<em>äº¤å‰</em>ç¼–è¯‘ Cortex-M3 æ¶æ„çš„ç¨‹åºã€‚<code>cargo build --target $TRIPLE</code>å¦‚æœæ‚¨çŸ¥é“ç¼–è¯‘ç›®æ ‡ ( <code>$TRIPLE</code>) åº”è¯¥æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆè¿™å°±åƒè¿è¡Œä¸€æ ·ç®€å•ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<code>.cargo/config.toml</code>æ¨¡æ¿ä¸­æœ‰ç­”æ¡ˆï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n6 .cargo/config.toml
[build]
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
# target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¦äº¤å‰ç¼–è¯‘ Cortex-M3 æ¶æ„ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>thumbv7m-none-eabi</code>. å®‰è£… Rust å·¥å…·é“¾æ—¶ä¸ä¼šè‡ªåŠ¨å®‰è£…è¯¥ç›®æ ‡ï¼Œç°åœ¨æ˜¯å°†è¯¥ç›®æ ‡æ·»åŠ åˆ°å·¥å…·é“¾çš„å¥½æ—¶æœºï¼Œå¦‚æœæ‚¨è¿˜æ²¡æœ‰è¿™æ ·åšï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç”±äº<code>thumbv7m-none-eabi</code>ç¼–è¯‘ç›®æ ‡å·²åœ¨æ‚¨çš„<code>.cargo/config.toml</code>æ–‡ä»¶ä¸­è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå› æ­¤ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7m-none-eabi
cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h3><p>ç°åœ¨æˆ‘ä»¬åœ¨<code>target/thumbv7m-none-eabi/debug/app</code>. æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>cargo-binutils</code>.</p>
<p>éšç€<code>cargo-readobj</code>æˆ‘ä»¬å¯ä»¥æ‰“å°ELFå¤´ï¼Œä»¥ç¡®è®¤è¿™æ˜¯ä¸€ä¸ªARMäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --bin app -- -file-headers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>--bin app</code> æ˜¯ç”¨äºæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ç³– <code>target/$TRIPLE/debug/app</code></li>
<li><code>--bin app</code> å¦‚æœ‰å¿…è¦ï¼Œè¿˜å°†ï¼ˆé‡æ–°ï¼‰ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶</li>
</ul>
<pre class="line-numbers language-text"><code class="language-text">ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0x0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x405
  Start of program headers:          52 (bytes into file)
  Start of section headers:          153204 (bytes into file)
  Flags:                             0x5000200
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         19
  Section header string table index: 18<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>cargo-size</code> å¯ä»¥æ‰“å°äºŒè¿›åˆ¶æ–‡ä»¶çš„é“¾æ¥å™¨éƒ¨åˆ†çš„å¤§å°ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo size --bin app --release -- -A<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬<code>--release</code>ç”¨æ¥æ£€æŸ¥ä¼˜åŒ–ç‰ˆæœ¬</p>
<pre class="line-numbers language-text"><code class="language-text">app  :
section             size        addr
.vector_table       1024         0x0
.text                 92       0x400
.rodata                0       0x45c
.data                  0  0x20000000
.bss                   0  0x20000000
.debug_str          2958         0x0
.debug_loc            19         0x0
.debug_abbrev        567         0x0
.debug_info         4929         0x0
.debug_ranges         40         0x0
.debug_macinfo         1         0x0
.debug_pubnames     2035         0x0
.debug_pubtypes     1892         0x0
.ARM.attributes       46         0x0
.debug_frame         100         0x0
.debug_line          867         0x0
Total              14570<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ELF é“¾æ¥å™¨éƒ¨åˆ†çš„å¤ä¹ </p>
<ul>
<li><code>.text</code> åŒ…å«ç¨‹åºæŒ‡ä»¤</li>
<li><code>.rodata</code> åŒ…å«å¸¸é‡å€¼ï¼Œå¦‚å­—ç¬¦ä¸²</li>
<li><code>.data</code>åŒ…å«åˆå§‹å€¼<em>ä¸</em>ä¸ºé›¶çš„é™æ€åˆ†é…å˜é‡</li>
<li><code>.bss</code>ä¹ŸåŒ…å«é™æ€åˆ†é…çš„å˜é‡ï¼Œå…¶åˆå§‹å€¼ <em>æ˜¯</em>é›¶</li>
<li><code>.vector_table</code>æ˜¯æˆ‘ä»¬ç”¨æ¥å­˜å‚¨å‘é‡ï¼ˆä¸­æ–­ï¼‰è¡¨çš„<em>éæ ‡å‡†</em>éƒ¨åˆ†</li>
<li><code>.ARM.attributes</code>å¹¶ä¸”è¿™äº›<code>.debug_*</code>éƒ¨åˆ†åŒ…å«å…ƒæ•°æ®ï¼Œå¹¶ä¸” åœ¨é—ªçƒäºŒè¿›åˆ¶æ–‡ä»¶æ—¶<em>ä¸ä¼š</em>åŠ è½½åˆ°ç›®æ ‡ä¸Šã€‚</li>
</ul>
</blockquote>
<p><strong>é‡è¦æç¤º</strong>ï¼šELF æ–‡ä»¶åŒ…å«è¯¸å¦‚è°ƒè¯•ä¿¡æ¯ä¹‹ç±»çš„å…ƒæ•°æ®ï¼Œå› æ­¤å®ƒä»¬<em>åœ¨ç£ç›˜</em>ä¸Šçš„<em>å¤§å°*</em>ä¸èƒ½<em>å‡†ç¡®åæ˜ ç¨‹åºåœ¨è®¾å¤‡ä¸Šé—ªçƒæ—¶å°†å ç”¨çš„ç©ºé—´ã€‚</em>å§‹ç»ˆ*ä½¿ç”¨<code>cargo-size</code>æ¥æ£€æŸ¥äºŒè¿›åˆ¶çœŸçš„æœ‰å¤šå¤§ã€‚</p>
<p><code>cargo-objdump</code> å¯ç”¨äºåæ±‡ç¼–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin app --release -- --disassemble --no-show-raw-insn --print-imm-hex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœä¸Šé¢çš„å‘½ä»¤æŠ±æ€¨<code>Unknown command line argument</code>çœ‹åˆ°ä»¥ä¸‹é”™è¯¯æŠ¥å‘Šï¼š<a href="https://github.com/rust-embedded/book/issues/269" target="_blank" rel="noopener">https://github.com/rust-embedded/book/issues/269</a></p>
</blockquote>
<blockquote>
<p><strong>æ³¨æ„</strong>æ­¤è¾“å‡ºåœ¨æ‚¨çš„ç³»ç»Ÿä¸Šå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚æ–°ç‰ˆæœ¬çš„ rustcã€LLVM å’Œåº“å¯ä»¥ç”Ÿæˆä¸åŒçš„ç¨‹åºé›†ã€‚æˆ‘ä»¬æˆªæ–­äº†ä¸€äº›æŒ‡ä»¤ä»¥ä¿æŒä»£ç ç‰‡æ®µè¾ƒå°ã€‚</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">app:  file format ELF32-arm-little

Disassembly of section .text:
main:
     400: bl  #0x256
     404: b #-0x4 <main+0x4>

Reset:
     406: bl  #0x24e
     40a: movw  r0, #0x0
     < .. truncated any more instructions .. >

DefaultHandler_:
     656: b #-0x4 <DefaultHandler_>

UsageFault:
     657: strb  r7, [r4, #0x3]

DefaultPreInit:
     658: bx  lr

__pre_init:
     659: strb  r7, [r0, #0x1]

__nop:
     65a: bx  lr

HardFaultTrampoline:
     65c: mrs r0, msp
     660: b #-0x2 <HardFault_>

HardFault_:
     662: b #-0x4 <HardFault_>

HardFault:
     663: <unknown><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ QEMU ä¸Šè¿è¡ŒåµŒå…¥å¼ç¨‹åºï¼è¿™æ¬¡æˆ‘ä»¬å°†ä½¿ç”¨<code>hello</code>å®é™…æ‰§è¡ŒæŸäº›æ“ä½œçš„ ç¤ºä¾‹ã€‚</p>
<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œçš„æºä»£ç <code>examples/hello.rs</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! Prints "Hello, world!" on the host console using semihosting</span>

<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥ç¨‹åºä½¿ç”¨ç§°ä¸ºåŠä¸»æœºçš„ä¸œè¥¿å°†æ–‡æœ¬æ‰“å°åˆ°<em>ä¸»æœº</em> æ§åˆ¶å°ã€‚å½“ä½¿ç”¨çœŸæ­£çš„ç¡¬ä»¶æ—¶ï¼Œè¿™éœ€è¦ä¸€ä¸ªè°ƒè¯•ä¼šè¯ï¼Œä½†å½“ä½¿ç”¨ QEMU æ—¶ï¼Œå®ƒå°±å¯ä»¥å·¥ä½œã€‚</p>
<p>è®©æˆ‘ä»¬ä»ç¼–è¯‘ç¤ºä¾‹å¼€å§‹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶å°†ä½äº <code>target/thumbv7m-none-eabi/debug/examples/hello</code>.</p>
<p>è¦åœ¨ QEMU ä¸Šè¿è¡Œæ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰“å°æ–‡æœ¬åï¼Œè¯¥å‘½ä»¤åº”æˆåŠŸé€€å‡ºï¼ˆé€€å‡ºä»£ç  = 0ï¼‰ã€‚åœ¨ *nix ä¸Šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">echo $?
0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹ QEMU å‘½ä»¤ï¼š</p>
<ul>
<li><code>qemu-system-arm</code>. è¿™æ˜¯ QEMU æ¨¡æ‹Ÿå™¨ã€‚è¿™äº› QEMU äºŒè¿›åˆ¶æ–‡ä»¶æœ‰å‡ ä¸ªå˜ä½“ï¼›è¿™ä¸ªå¯¹<em>ARM</em>æœºå™¨è¿›è¡Œå®Œæ•´çš„<em>ç³»ç»Ÿ</em>ä»¿çœŸï¼Œå› æ­¤å¾—åã€‚</li>
<li><code>-cpu cortex-m3</code>. è¿™å‘Šè¯‰ QEMU æ¨¡æ‹Ÿ Cortex-M3 CPUã€‚æŒ‡å®š CPU å‹å·å¯ä»¥è®©æˆ‘ä»¬æ•è·ä¸€äº›é”™è¯¯ç¼–è¯‘é”™è¯¯ï¼šä¾‹å¦‚ï¼Œè¿è¡Œä¸º Cortex-M4F ç¼–è¯‘çš„ç¨‹åºï¼Œå®ƒå…·æœ‰ç¡¬ä»¶ FPUï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¼è‡´ QEMU é”™è¯¯ã€‚</li>
<li><code>-machine lm3s6965evb</code>. è¿™å‘Šè¯‰ QEMU æ¨¡æ‹Ÿ LM3S6965EVBï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å« LM3S6965 å¾®æ§åˆ¶å™¨çš„è¯„ä¼°æ¿ã€‚</li>
<li><code>-nographic</code>. è¿™å‘Šè¯‰ QEMU ä¸è¦å¯åŠ¨å®ƒçš„ GUIã€‚</li>
<li><code>-semihosting-config (..)</code>. è¿™å‘Šè¯‰ QEMU å¯ç”¨åŠä¸»æœºã€‚åŠä¸»æœºå…è®¸æ¨¡æ‹Ÿè®¾å¤‡ä½¿ç”¨ä¸»æœº stdoutã€stderr å’Œ stdin å¹¶åœ¨ä¸»æœºä¸Šåˆ›å»ºæ–‡ä»¶ã€‚</li>
<li><code>-kernel $file</code>. è¿™ä¼šå‘Šè¯‰ QEMU åœ¨æ¨¡æ‹Ÿæœºå™¨ä¸ŠåŠ è½½å’Œè¿è¡Œå“ªä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li>
</ul>
<p>è¾“å…¥è¿™ä¹ˆé•¿çš„ QEMU å‘½ä»¤å¤ªè´¹åŠ›äº†ï¼æˆ‘ä»¬å¯ä»¥è®¾ç½®è‡ªå®šä¹‰è¿è¡Œå™¨æ¥ç®€åŒ–æµç¨‹ã€‚<code>.cargo/config.toml</code>æœ‰ä¸€ä¸ªè¢«æ³¨é‡Šæ‰çš„è°ƒç”¨ QEMU çš„è¿è¡Œç¨‹åºï¼›è®©æˆ‘ä»¬å–æ¶ˆæ³¨é‡Šï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">head -n3 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤è¿è¡Œç¨‹åºä»…é€‚ç”¨äº<code>thumbv7m-none-eabi</code>ç›®æ ‡ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„é»˜è®¤ç¼–è¯‘ç›®æ ‡ã€‚ç°åœ¨<code>cargo run</code>å°†ç¼–è¯‘ç¨‹åºå¹¶åœ¨ QEMU ä¸Šè¿è¡Œå®ƒï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run --example hello --release
   Compiling app v0.1.0 (file:///tmp/app)
    Finished release [optimized + debuginfo] target(s) in 0.26s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/examples/hello`
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>è°ƒè¯•å¯¹äºåµŒå…¥å¼å¼€å‘è‡³å…³é‡è¦ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p>
<p>è°ƒè¯•åµŒå…¥å¼è®¾å¤‡æ¶‰åŠ<em>è¿œç¨‹</em>è°ƒè¯•ï¼Œå› ä¸ºæˆ‘ä»¬è¦è°ƒè¯•çš„ç¨‹åºä¸ä¼šåœ¨è¿è¡Œè°ƒè¯•å™¨ç¨‹åºï¼ˆGDB æˆ– LLDBï¼‰çš„æœºå™¨ä¸Šè¿è¡Œã€‚</p>
<p>è¿œç¨‹è°ƒè¯•æ¶‰åŠå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚åœ¨ QEMU è®¾ç½®ä¸­ï¼Œå®¢æˆ·ç«¯å°†æ˜¯ä¸€ä¸ª GDBï¼ˆæˆ– LLDBï¼‰è¿›ç¨‹ï¼Œè€ŒæœåŠ¡å™¨å°†æ˜¯è¿è¡ŒåµŒå…¥å¼ç¨‹åºçš„ QEMU è¿›ç¨‹ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>hello</code>æˆ‘ä»¬å·²ç»ç¼–è¯‘çš„ç¤ºä¾‹ã€‚</p>
<p>è°ƒè¯•çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯åŠ¨ QEMUï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -gdb tcp::3333 \
  -S \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å‘½ä»¤ä¸ä¼šå‘æ§åˆ¶å°æ‰“å°ä»»ä½•å†…å®¹å¹¶å°†é˜»æ­¢ç»ˆç«¯ã€‚è¿™æ¬¡æˆ‘ä»¬ä¼ é€’äº†ä¸¤ä¸ªé¢å¤–çš„æ ‡å¿—ï¼š</p>
<ul>
<li><code>-gdb tcp::3333</code>. è¿™å‘Šè¯‰ QEMU ç­‰å¾… TCP ç«¯å£ 3333 ä¸Šçš„ GDB è¿æ¥ã€‚</li>
<li><code>-S</code>. è¿™å‘Šè¯‰ QEMU åœ¨å¯åŠ¨æ—¶å†»ç»“æœºå™¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªï¼Œç¨‹åºå°†åœ¨æˆ‘ä»¬æœ‰æœºä¼šå¯åŠ¨è°ƒè¯•å™¨ä¹‹å‰åˆ°è¾¾ main çš„æœ«å°¾ï¼</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨ GDB å¹¶å‘Šè¯‰å®ƒåŠ è½½ç¤ºä¾‹çš„è°ƒè¯•ç¬¦å·ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">gdb-multiarch -q target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>æ³¨æ„</strong>ï¼šæ‚¨å¯èƒ½éœ€è¦å¦ä¸€ä¸ªç‰ˆæœ¬çš„ gdb è€Œä¸æ˜¯<code>gdb-multiarch</code>å–å†³äºæ‚¨åœ¨å®‰è£…ç« èŠ‚ä¸­å®‰è£…çš„é‚£ä¸ªç‰ˆæœ¬ã€‚è¿™ä¹Ÿå¯ä»¥æ˜¯ <code>arm-none-eabi-gdb</code>æˆ–åªæ˜¯<code>gdb</code>.</p>
<p>ç„¶ååœ¨ GDB shell ä¸­æˆ‘ä»¬è¿æ¥åˆ° QEMUï¼Œå®ƒæ­£åœ¨ç­‰å¾… TCP ç«¯å£ 3333 ä¸Šçš„è¿æ¥ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">target remote :3333
Remote debugging using :3333
Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473
473     pub unsafe extern "C" fn Reset() -> ! {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å°†çœ‹åˆ°è¯¥è¿›ç¨‹å·²åœæ­¢ï¼Œå¹¶ä¸”ç¨‹åºè®¡æ•°å™¨æŒ‡å‘åä¸º<code>Reset</code>. è¿™å°±æ˜¯é‡ç½®å¤„ç†ç¨‹åºï¼šCortex-M å†…æ ¸åœ¨å¯åŠ¨æ—¶æ‰§è¡Œçš„æ“ä½œã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œåœ¨æŸäº›è®¾ç½®<code>Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473</code>ä¸­ï¼Œgdb å¯èƒ½ä¼šæ‰“å°ä¸€äº›è­¦å‘Šï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºå¦‚ä¸Šæ‰€ç¤ºçš„è¡Œï¼š</p>
<pre><code>core::num::bignum::Big32x40::mul_small () at src/libcore/num/bignum.rs:254` `src/libcore/num/bignum.rs: No such file or directory.</code></pre><p>è¿™æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„æ•…éšœã€‚æ‚¨å¯ä»¥æ”¾å¿ƒåœ°å¿½ç•¥è¿™äº›è­¦å‘Šï¼Œæ‚¨å¾ˆå¯èƒ½åœ¨ Reset() å¤„ã€‚</p>
</blockquote>
<p>è¿™ä¸ªé‡ç½®å¤„ç†ç¨‹åºæœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬çš„ä¸»å‡½æ•°ã€‚è®©æˆ‘ä»¬ä½¿ç”¨æ–­ç‚¹å’Œ<code>continue</code>å‘½ä»¤ä¸€è·¯è·³è¿‡ã€‚è¦è®¾ç½®æ–­ç‚¹ï¼Œè®©æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹æˆ‘ä»¬æƒ³è¦åœ¨ä»£ç ä¸­ä¸­æ–­çš„ä½ç½®ï¼Œä½¿ç”¨<code>list</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">list main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™å°†æ˜¾ç¤ºæ¥è‡ªæ–‡ä»¶ examples/hello.rs çš„æºä»£ç ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">6       use panic_halt as _;
7
8       use cortex_m_rt::entry;
9       use cortex_m_semihosting::{debug, hprintln};
10
11      #[entry]
12      fn main() -> ! {
13          hprintln!("Hello, world!").unwrap();
14
15          // exit QEMU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬æƒ³åœ¨ç¬¬ 13 è¡Œçš„â€œHello, world!â€ä¹‹å‰æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ã€‚æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹<code>break</code>å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">break 13<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹<code>continue</code>å‘½ä»¤æŒ‡ç¤º gdb è¿è¡Œåˆ°æˆ‘ä»¬çš„ main å‡½æ•°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">continue
Continuing.

Breakpoint 1, hello::__cortex_m_rt_main () at examples\hello.rs:13
13          hprintln!("Hello, world!").unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨æ¥è¿‘æ‰“å°â€œHello, world!â€çš„ä»£ç ã€‚è®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨<code>next</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">next
16          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ­¤æ—¶æ‚¨åº”è¯¥çœ‹åˆ°â€œHello, world!â€ æ‰“å°åœ¨æ­£åœ¨è¿è¡Œçš„ç»ˆç«¯ä¸Š<code>qemu-system-arm</code>ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>next</code>å†æ¬¡è°ƒç”¨å°†ç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">next
[Inferior 1 (Remote target) exited normally]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ‚¨ç°åœ¨å¯ä»¥é€€å‡º GDB ä¼šè¯ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Hardwareï¼ˆç¡¬ä»¶ï¼‰"><a href="#Hardwareï¼ˆç¡¬ä»¶ï¼‰" class="headerlink" title="Hardwareï¼ˆç¡¬ä»¶ï¼‰"></a>Hardwareï¼ˆç¡¬ä»¶ï¼‰</h2><h3 id="äº†è§£ç¡¬ä»¶"><a href="#äº†è§£ç¡¬ä»¶" class="headerlink" title="äº†è§£ç¡¬ä»¶"></a>äº†è§£ç¡¬ä»¶</h3><p>åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦ç¡®å®šç›®æ ‡è®¾å¤‡çš„ä¸€äº›ç‰¹å¾ï¼Œå› ä¸ºè¿™äº›ç‰¹å¾å°†ç”¨äºé…ç½®é¡¹ç›®ï¼š</p>
<ul>
<li>ARM æ ¸å¿ƒã€‚ä¾‹å¦‚çš®è´¨-M3ã€‚</li>
<li>ARM å†…æ ¸æ˜¯å¦åŒ…å« FPUï¼ŸCortex-M4 <strong>F</strong>å’Œ Cortex-M7 <strong>F</strong>å†…æ ¸å¯ä»¥ã€‚</li>
<li>ç›®æ ‡è®¾å¤‡æœ‰å¤šå°‘é—ªå­˜å’Œ RAMï¼Ÿä¾‹å¦‚ 256 KiB çš„é—ªå­˜å’Œ 32 KiB çš„ RAMã€‚</li>
<li>é—ªå­˜å’Œ RAM åœ¨åœ°å€ç©ºé—´ä¸­æ˜ å°„åˆ°å“ªé‡Œï¼Ÿä¾‹å¦‚ï¼ŒRAM é€šå¸¸ä½äº address <code>0x2000_0000</code>ã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥åœ¨æ•°æ®è¡¨æˆ–è®¾å¤‡çš„å‚è€ƒæ‰‹å†Œä¸­æ‰¾åˆ°æ­¤ä¿¡æ¯ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘ä»¬çš„å‚è€ƒç¡¬ä»¶ STM32F3DISCOVERYã€‚è¯¥æ¿åŒ…å«ä¸€ä¸ª STM32F303VCT6 å¾®æ§åˆ¶å™¨ã€‚è¯¥å¾®æ§åˆ¶å™¨å…·æœ‰ï¼š</p>
<ul>
<li>åŒ…å«å•ç²¾åº¦ FPU çš„ Cortex-M4F å†…æ ¸</li>
<li>ä½äºåœ°å€ 0x0800_0000 çš„ 256 KiB é—ªå­˜ã€‚</li>
<li>ä½äºåœ°å€ 0x2000_0000 çš„ 40 KiB RAMã€‚ï¼ˆè¿˜æœ‰å¦ä¸€ä¸ª RAM åŒºåŸŸï¼Œä½†ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†å¿½ç•¥å®ƒï¼‰ã€‚</li>
</ul>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªæ–°çš„æ¨¡æ¿å®ä¾‹å¼€å§‹ã€‚è¯·å‚é˜… QEMUå…³äºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹æ²¡æœ‰å¤ä¹  <code>cargo-generate</code>ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app

$ cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¬¬ä¸€æ­¥æ˜¯åœ¨<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n5 .cargo/config.toml
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
# target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å°†ä½¿ç”¨<code>thumbv7em-none-eabihf</code>å®ƒè¦†ç›– Cortex-M4F å†…æ ¸ã€‚</p>
<p>ç¬¬äºŒæ­¥æ˜¯å°†å†…å­˜åŒºåŸŸä¿¡æ¯è¾“å…¥åˆ°<code>memory.x</code> æ–‡ä»¶ä¸­ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cat memory.x
/* Linker script for the STM32F303VCT6 */
MEMORY
{
  /* NOTE 1 K = 1 KiBi = 1024 bytes */
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ‚¨<code>memory.x</code>åœ¨å®Œæˆç‰¹å®šæ„å»ºç›®æ ‡çš„ç¬¬ä¸€æ¬¡æ„å»ºåå‡ºäºæŸç§åŸå› æ›´æ”¹äº†æ–‡ä»¶ï¼Œè¯·<code>cargo clean</code>åœ¨ä¹‹å‰æ‰§è¡Œ <code>cargo build</code>ï¼Œå› ä¸º<code>cargo build</code>å¯èƒ½æ— æ³•è·Ÿè¸ª<code>memory.x</code>.</p>
</blockquote>
<p>æˆ‘ä»¬å°†å†æ¬¡ä» hello ç¤ºä¾‹å¼€å§‹ï¼Œä½†é¦–å…ˆæˆ‘ä»¬å¿…é¡»è¿›è¡Œä¸€äº›å°çš„æ›´æ”¹ã€‚</p>
<p>åœ¨ ä¸­<code>examples/hello.rs</code>ï¼Œç¡®ä¿<code>debug::exit()</code>å·²æ³¨é‡Šæ‰æˆ–åˆ é™¤è¯¥è°ƒç”¨ã€‚å®ƒä»…ç”¨äºåœ¨ QEMU ä¸­è¿è¡Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    <span class="token comment" spellcheck="true">// debug::exit(debug::EXIT_SUCCESS);</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ç°åœ¨å¯ä»¥åƒä»¥å‰ä¸€æ ·ä½¿ç”¨äº¤å‰ç¼–è¯‘ç¨‹åº<code>cargo build</code> å’Œæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶<code>cargo-binutils</code>ã€‚è¯¥ <code>cortex-m-rt</code>ç®±å¤„ç†æ‰€æœ‰çš„é­”æ³•éœ€è¦å¾—åˆ°ä½ çš„èŠ¯ç‰‡ä¸Šè¿è¡Œï¼Œå¦‚æœ‰ç›Šï¼Œå‡ ä¹æ‰€æœ‰çš„Cortex-M CPUçš„å¯åŠ¨ä»¥åŒæ ·çš„æ–¹å¼ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="è°ƒè¯•-1"><a href="#è°ƒè¯•-1" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>è°ƒè¯•çœ‹èµ·æ¥æœ‰ç‚¹ä¸åŒã€‚äº‹å®ä¸Šï¼Œæ ¹æ®ç›®æ ‡è®¾å¤‡çš„ä¸åŒï¼Œç¬¬ä¸€æ­¥çœ‹èµ·æ¥å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºè°ƒè¯•åœ¨ STM32F3DISCOVERY ä¸Šè¿è¡Œçš„ç¨‹åºæ‰€éœ€çš„æ­¥éª¤ã€‚è¿™æ˜¯ä¸ºäº†ä½œä¸ºå‚è€ƒï¼›æœ‰å…³è°ƒè¯•çš„è®¾å¤‡ç‰¹å®šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/rust-embedded/debugonomicon" target="_blank" rel="noopener">Debugonomicon</a>ã€‚</p>
<p>å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å°†è¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼Œå®¢æˆ·ç«¯å°†æ˜¯ä¸€ä¸ª GDB è¿›ç¨‹ã€‚ç„¶è€Œï¼Œè¿™ä¸€æ¬¡ï¼ŒæœåŠ¡å™¨å°†æ˜¯ OpenOCDã€‚</p>
<p>æ­£å¦‚åœ¨å®‰è£…éªŒè¯éƒ¨åˆ†æ‰€åšçš„é‚£æ ·ï¼Œå°†å‘ç°æ¿è¿æ¥åˆ°æ‚¨çš„ç¬”è®°æœ¬ç”µè„‘/PC å¹¶æ£€æŸ¥ ST-LINK æ ‡å¤´æ˜¯å¦å·²å¡«å……ã€‚</p>
<p>åœ¨ç»ˆç«¯ä¸Šè¿è¡Œ<code>openocd</code>ä»¥è¿æ¥åˆ°å‘ç°æ¿ä¸Šçš„ ST-LINKã€‚ä»æ¨¡æ¿çš„æ ¹ç›®å½•è¿è¡Œæ­¤å‘½ä»¤ï¼›<code>openocd</code>å°†æ‹¾å– <code>openocd.cfg</code>æŒ‡ç¤ºä½¿ç”¨å“ªä¸ªæ¥å£æ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶çš„æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.cfg
# Sample OpenOCD configuration for the STM32F3DISCOVERY development board

# Depending on the hardware revision you got you'll have to pick ONE of these
# interfaces. At any time only one interface should be commented out.

# Revision C (newer revision)
source [find interface/stlink.cfg]

# Revision A and B (older revisions)
# source [find interface/stlink-v2.cfg]

source [find target/stm32f3x.cfg]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœæ‚¨åœ¨éªŒè¯éƒ¨åˆ†å‘ç°å‘ç°æ¿çš„ç‰ˆæœ¬è¾ƒæ—§ï¼Œåˆ™æ­¤æ—¶åº”ä¿®æ”¹<code>openocd.cfg</code> æ–‡ä»¶ä»¥ä½¿ç”¨<code>interface/stlink-v2.cfg</code>.</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.913879
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸Šè¿è¡Œ GDBï¼Œä¹Ÿæ˜¯ä»æ¨¡æ¿çš„æ ¹ç›®å½•ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ <gdb> -q target/thumbv7em-none-eabihf/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥å°† GDB è¿æ¥åˆ° OpenOCDï¼Œå®ƒæ­£åœ¨ç­‰å¾…ç«¯å£ 3333 ä¸Šçš„ TCP è¿æ¥ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ç»§ç»­ä½¿ç”¨å‘½ä»¤å°†ç¨‹åº<em>é—ªå­˜</em>ï¼ˆåŠ è½½ï¼‰åˆ°å¾®æ§åˆ¶å™¨ä¸Š <code>load</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) load
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¨‹åºç°åœ¨å·²åŠ è½½ã€‚è¯¥ç¨‹åºä½¿ç”¨åŠä¸»æœºï¼Œå› æ­¤åœ¨æˆ‘ä»¬è¿›è¡Œä»»ä½•åŠä¸»æœºè°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å‘Šè¯‰ OpenOCD å¯ç”¨åŠä¸»æœºã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤å‘ OpenOCD å‘é€å‘½ä»¤<code>monitor</code>ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨<code>monitor help</code>å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ OpenOCD å‘½ä»¤ã€‚</p>
</blockquote>
<p>åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ç›´è·³è¿‡<code>main</code>ä½¿ç”¨æ–­ç‚¹å’Œ <code>continue</code>å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main
Breakpoint 1 at 0x8000d18: file examples/hello.rs, line 15.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, main () at examples/hello.rs:15
15          let mut stdout = hio::hstdout().unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>å¦‚æœåœ¨æ‚¨å‘å‡ºä¸Šè¿°<code>continue</code>å‘½ä»¤å GDB é˜»å¡ç»ˆç«¯è€Œä¸æ˜¯ç‚¹å‡»æ–­ç‚¹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä»”ç»†æ£€æŸ¥æ–‡ä»¶ä¸­çš„å†…å­˜åŒºåŸŸä¿¡æ¯<code>memory.x</code>æ˜¯å¦ä¸ºæ‚¨çš„è®¾å¤‡æ­£ç¡®è®¾ç½®ï¼ˆå¼€å§‹<em>å’Œ</em>é•¿åº¦ï¼‰ã€‚</p>
</blockquote>
<p>æ¨è¿›ç¨‹åº<code>next</code>åº”è¯¥äº§ç”Ÿä¸ä»¥å‰ç›¸åŒçš„ç»“æœã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next
16          writeln!(stdout, "Hello, world!").unwrap();

(gdb) next
19          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤æ—¶æ‚¨åº”è¯¥çœ‹åˆ°â€œHello, world!â€ æ‰“å°åœ¨ OpenOCD æ§åˆ¶å°ä¸Šï¼Œç­‰ç­‰ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08000e6c
Hello, world!
Info : halted: PC: 0x08000d62
Info : halted: PC: 0x08000d64
Info : halted: PC: 0x08000d66
Info : halted: PC: 0x08000d6a
Info : halted: PC: 0x08000a0c
Info : halted: PC: 0x08000d70
Info : halted: PC: 0x08000d72<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‘å‡ºå¦ä¸€ä¸ª<code>next</code>å°†ä½¿å¤„ç†å™¨æ‰§è¡Œ<code>debug::exit</code>ã€‚è¿™å……å½“æ–­ç‚¹å¹¶åœæ­¢è¿›ç¨‹ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next

Program received signal SIGTRAP, Trace/breakpoint trap.
0x0800141a in __syscall ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®ƒè¿˜ä¼šå¯¼è‡´å°†å…¶æ‰“å°åˆ° OpenOCD æ§åˆ¶å°ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08001188
semihosting: *** application exited ***
Warn : target not halted
Warn : target not halted
target halted due to breakpoint, current mode: Thread
xPSR: 0x21000000 pc: 0x08000d76 msp: 0x20009fc0, semihosting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯ï¼Œåœ¨å¾®æ§åˆ¶å™¨ä¸Šè¿è¡Œçš„è¿›ç¨‹å°šæœªç»ˆæ­¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>continue</code>æˆ–ç±»ä¼¼å‘½ä»¤æ¢å¤å®ƒã€‚</p>
<p>æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨è¯¥<code>quit</code>å‘½ä»¤é€€å‡º GDB ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è°ƒè¯•ç°åœ¨éœ€è¦æ›´å¤šçš„æ­¥éª¤ï¼Œå› æ­¤æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›æ­¥éª¤æ‰“åŒ…åˆ°ä¸€ä¸ªåä¸º<code>openocd.gdb</code>. è¯¥æ–‡ä»¶æ˜¯åœ¨è¯¥<code>cargo generate</code>æ­¥éª¤ä¸­åˆ›å»ºçš„ï¼Œåº”è¯¥æ— éœ€ä»»ä½•ä¿®æ”¹å³å¯å·¥ä½œã€‚è®©æˆ‘ä»¬æœ‰ä¸€ä¸ªé«˜å³°ï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.gdb
target extended-remote :3333

# print demangled symbols
set print asm-demangle on

# detect unhandled exceptions, hard faults and panics
break DefaultHandler
break HardFault
break rust_begin_unwind

monitor arm semihosting enable

load

# start the process but immediately halt the processor
stepi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨è¿è¡Œ<code>&lt;gdb&gt; -x openocd.gdb target/thumbv7em-none-eabihf/debug/examples/hello</code>å°†ç«‹å³å°† GDB è¿æ¥åˆ° OpenOCDï¼Œå¯ç”¨åŠä¸»æœºï¼ŒåŠ è½½ç¨‹åºå¹¶å¯åŠ¨è¿›ç¨‹ã€‚</p>
<p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥å˜æˆ<code>&lt;gdb&gt; -x openocd.gdb</code>è‡ªå®šä¹‰è¿è¡Œ<code>cargo run</code>ç¨‹åºæ¥ æ„å»ºç¨‹åº<em>å¹¶</em>å¯åŠ¨ GDB ä¼šè¯ã€‚æ­¤è¿è¡Œç¨‹åºåŒ…å«åœ¨<code>.cargo/config.toml</code>ä½†å·²æ³¨é‡Šæ‰ã€‚</p>
<pre class="line-numbers language-console"><code class="language-console">head -n10 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
# runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"

[target.'cfg(all(target_arch = "arm", target_os = "none"))']
# uncomment ONE of these three option to make `cargo run` start a GDB session
# which option to pick depends on your system
runner = "arm-none-eabi-gdb -x openocd.gdb"
# runner = "gdb-multiarch -x openocd.gdb"
# runner = "gdb -x openocd.gdb"
$ cargo run --example hello
(..)
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Memory-Mapped-Registers"><a href="#Memory-Mapped-Registers" class="headerlink" title="Memory Mapped Registers"></a>Memory Mapped Registers</h2><p>åµŒå…¥å¼ç³»ç»Ÿåªèƒ½é€šè¿‡æ‰§è¡Œæ™®é€šçš„ Rust ä»£ç å¹¶åœ¨ RAM ä¸­ç§»åŠ¨æ•°æ®æ¥å®ç°ã€‚å¦‚æœæˆ‘ä»¬æƒ³å°†ä»»ä½•ä¿¡æ¯è¾“å…¥æˆ–è¾“å‡ºæˆ‘ä»¬çš„ç³»ç»Ÿï¼ˆä¾‹å¦‚é—ªçƒ LEDã€æ£€æµ‹æŒ‰é’®æŒ‰ä¸‹æˆ–ä¸æŸç§æ€»çº¿ä¸Šçš„ç‰‡å¤–å¤–å›´è®¾å¤‡é€šä¿¡ï¼‰ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ·±å…¥äº†è§£å¤–è®¾åŠå…¶â€œå†…å­˜æ˜ å°„å¯„å­˜å™¨â€ã€‚</p>
<p>æ‚¨å¯èƒ½ä¼šå‘ç°è®¿é—®å¾®æ§åˆ¶å™¨ä¸­çš„å¤–å›´è®¾å¤‡æ‰€éœ€çš„ä»£ç å·²ç»ç¼–å†™å¥½äº†ï¼Œä½äºä»¥ä¸‹çº§åˆ«ä¹‹ä¸€ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/crates.png" alt=""></p>
<ul>
<li>Micro-architecture Crate - æ­¤ç±» crate å¤„ç†æ‚¨çš„å¾®æ§åˆ¶å™¨ä½¿ç”¨çš„å¤„ç†å™¨å†…æ ¸é€šç”¨çš„ä»»ä½•æœ‰ç”¨ä¾‹ç¨‹ï¼Œä»¥åŠä½¿ç”¨è¯¥ç‰¹å®šç±»å‹å¤„ç†å™¨å†…æ ¸çš„æ‰€æœ‰å¾®æ§åˆ¶å™¨é€šç”¨çš„ä»»ä½•å¤–å›´è®¾å¤‡ã€‚ä¾‹å¦‚ï¼Œ<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate ä¸ºæ‚¨æä¾›äº†å¯ç”¨å’Œç¦ç”¨ä¸­æ–­çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¯¹äºæ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨éƒ½æ˜¯ç›¸åŒçš„ã€‚å®ƒè¿˜å…è®¸æ‚¨è®¿é—®æ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨ä¸­åŒ…å«çš„â€œSysTickâ€å¤–è®¾ã€‚</li>
<li>å¤–è®¾è®¿é—®æ¿æ¡ç®± (PAC) - è¿™ç§æ¿æ¡ç®±æ˜¯ä¸ºæ‚¨æ­£åœ¨ä½¿ç”¨çš„å¾®æ§åˆ¶å™¨çš„ç‰¹å®šéƒ¨ä»¶å·å®šä¹‰çš„å„ç§å†…å­˜åŒ…è£…å™¨å¯„å­˜å™¨çš„è–„åŒ…è£…å™¨ã€‚ä¾‹å¦‚ï¼Œ<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>é€‚ç”¨äº Texas Instruments Tiva-C TM4C123 ç³»åˆ—ï¼Œæˆ–<a href="https://crates.io/crates/stm32f30x" target="_blank" rel="noopener">stm32f30x</a>é€‚ç”¨äº ST-Micro STM32F30x ç³»åˆ—ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å°†æŒ‰ç…§å¾®æ§åˆ¶å™¨æŠ€æœ¯å‚è€ƒæ‰‹å†Œä¸­ç»™å‡ºçš„æ¯ä¸ªå¤–å›´è®¾å¤‡çš„æ“ä½œè¯´æ˜ç›´æ¥ä¸å¯„å­˜å™¨äº¤äº’ã€‚</li>
<li>HAL Crate - è¿™äº› crate ä¸ºæ‚¨çš„ç‰¹å®šå¤„ç†å™¨æä¾›æ›´åŠ ç”¨æˆ·å‹å¥½çš„ APIï¼Œé€šå¸¸é€šè¿‡å®ç°ä¸€äº›åœ¨<a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener">Embedded-hal </a>ä¸­å®šä¹‰çš„å¸¸è§ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ª crate å¯èƒ½æä¾›ä¸€ä¸ª<code>Serial</code>ç»“æ„ä½“ï¼Œå¸¦æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°é‡‡ç”¨ä¸€ç»„é€‚å½“çš„ GPIO å¼•è„šå’Œæ³¢ç‰¹ç‡ï¼Œå¹¶æä¾›æŸç§<code>write_byte</code>å‘é€æ•°æ®çš„åŠŸèƒ½ã€‚</li>
<li>Board Crate - è¿™äº› crate æ¯” HAL Crate æ›´è¿›ä¸€æ­¥ï¼Œé€šè¿‡é¢„é…ç½®å„ç§å¤–è®¾å’Œ GPIO å¼•è„šä»¥é€‚åˆæ‚¨æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šå¼€å‘äººå‘˜å¥—ä»¶æˆ–æ¿ï¼Œä¾‹å¦‚<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>ç”¨äº STM32F3DISCOVERY æ¿ã€‚</li>
</ul>
<h3 id="æ¿æ¡ç®±"><a href="#æ¿æ¡ç®±" class="headerlink" title="æ¿æ¡ç®±"></a>æ¿æ¡ç®±</h3><p>å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰åµŒå…¥å¼ Rustï¼Œæ¿æ¡ç®±æ˜¯å®Œç¾çš„èµ·ç‚¹ã€‚ä»–ä»¬å¾ˆå¥½åœ°æŠ½è±¡äº†å¼€å§‹å­¦ä¹ è¿™ä¸ªä¸»é¢˜æ—¶å¯èƒ½ä¼šè®©äººä¸çŸ¥æ‰€æªçš„ç¡¬ä»¶ç»†èŠ‚ï¼Œå¹¶ä½¿æ ‡å‡†ä»»åŠ¡å˜å¾—ç®€å•ï¼Œæ¯”å¦‚æ‰“å¼€æˆ–å…³é—­ LEDã€‚å®ƒä»¬å…¬å¼€çš„åŠŸèƒ½å› æ¿è€Œå¼‚ã€‚ç”±äºæœ¬ä¹¦æ—¨åœ¨ä¿æŒä¸ç¡¬ä»¶æ— å…³ï¼Œå› æ­¤æœ¬ä¹¦ä¸ä¼šæ¶µç›–æ¿æ¡ç®±ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³è¯•ç”¨ STM32F3DISCOVERY æ¿ï¼Œå¼ºçƒˆå»ºè®®æŸ¥çœ‹<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>æ¿ç®±ï¼Œå®ƒæä¾›ä½¿æ¿ LED é—ªçƒã€è®¿é—®æŒ‡å—é’ˆã€è“ç‰™ç­‰åŠŸèƒ½ã€‚<a href="https://rust-embedded.github.io/discovery/" target="_blank" rel="noopener">discovery</a>æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»ä½¿ç”¨æ¿ç®±çš„ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªè¿˜æ²¡æœ‰ä¸“ç”¨æ¿æ¡ç®±çš„ç³»ç»Ÿï¼Œæˆ–è€…æ‚¨éœ€è¦ç°æœ‰æ¿æ¡ç®±æœªæä¾›çš„åŠŸèƒ½ï¼Œè¯·ç»§ç»­é˜…è¯»æˆ‘ä»¬ä»åº•éƒ¨å¼€å§‹çš„å¾®æ¶æ„æ¿æ¡ç®±ã€‚</p>
<h3 id="å¾®æ¶æ„ç®±"><a href="#å¾®æ¶æ„ç®±" class="headerlink" title="å¾®æ¶æ„ç®±"></a>å¾®æ¶æ„ç®±</h3><p>è®©æˆ‘ä»¬çœ‹çœ‹æ‰€æœ‰åŸºäº Cortex-M çš„å¾®æ§åˆ¶å™¨é€šç”¨çš„ SysTick å¤–è®¾ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate ä¸­æ‰¾åˆ°ä¸€ä¸ªéå¸¸ä½çº§çš„ API ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨å®ƒï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>syst<span class="token punctuation">,</span> Peripherals<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> systick <span class="token operator">=</span> peripherals<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>systick<span class="token punctuation">.</span><span class="token function">has_wrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Loop</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨åŠŸèƒ½<code>SYST</code>ç»“æ„éå¸¸ç´§å¯†æ˜ å°„åˆ°ç”±ARMæŠ€æœ¯å‚è€ƒæ‰‹å†Œæ­¤å¤–è®¾å®šä¹‰çš„åŠŸèƒ½ã€‚è¿™ä¸ª API ä¸­æ²¡æœ‰å…³äºâ€œå»¶è¿Ÿ X æ¯«ç§’â€çš„å†…å®¹â€”â€”æˆ‘ä»¬å¿…é¡»è‡ªå·±ä½¿ç”¨<code>while</code>å¾ªç¯ç²—ç•¥åœ°å®ç°å®ƒã€‚è¯·æ³¨æ„ï¼Œ<code>SYST</code>åœ¨è°ƒç”¨ä¹‹å‰æˆ‘ä»¬æ— æ³•è®¿é—®æˆ‘ä»¬çš„ç»“æ„<code>Peripherals::take()</code>- è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹ç¨‹ï¼Œå¯ä¿è¯<code>SYST</code>æˆ‘ä»¬æ•´ä¸ªç¨‹åºä¸­åªæœ‰ä¸€ä¸ªç»“æ„ã€‚</p>
<h3 id="ä½¿ç”¨å¤–è®¾è®¿é—®ç®±-PAC"><a href="#ä½¿ç”¨å¤–è®¾è®¿é—®ç®±-PAC" class="headerlink" title="ä½¿ç”¨å¤–è®¾è®¿é—®ç®± (PAC)"></a>ä½¿ç”¨å¤–è®¾è®¿é—®ç®± (PAC)</h3><p>å¦‚æœæˆ‘ä»¬å°†è‡ªå·±é™åˆ¶åœ¨æ¯ä¸ª Cortex-M é™„å¸¦çš„åŸºæœ¬å¤–å›´è®¾å¤‡ä¸Šï¼Œæˆ‘ä»¬çš„åµŒå…¥å¼è½¯ä»¶å¼€å‘å°±ä¸ä¼šèµ°å¾—å¤ªè¿œã€‚åœ¨æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬å°†éœ€è¦ç¼–å†™ä¸€äº›ç‰¹å®šäºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šå¾®æ§åˆ¶å™¨çš„ä»£ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Texas Instruments TM4C123â€”â€”ä¸€ä¸ªä¸­ç­‰çš„ 80MHz Cortex-M4ï¼Œå…·æœ‰ 256 KiB çš„é—ªå­˜ã€‚æˆ‘ä»¬å°†æ‹‰å…¥<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>æ¿æ¡ç®±ä»¥ä½¿ç”¨è¯¥èŠ¯ç‰‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> Leds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> tm4c123x<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> pwm <span class="token operator">=</span> p<span class="token punctuation">.</span>PWM0<span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Mode = 1 => Count up/down mode</span>
    pwm<span class="token punctuation">.</span>_2_ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_gena<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">actcmpau</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actcmpad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 528 cycles (264 up and down) = 4 loops per video line (2112 cycles)</span>
    pwm<span class="token punctuation">.</span>_2_load<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">263</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_cmpa<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">compa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">pwm4en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è®¿é—®çš„<code>PWM0</code>å¤–è®¾å®Œå…¨ç›¸åŒçš„æ–¹å¼ï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®çš„<code>SYST</code>å¤–å›´è¾ƒæ—©ï¼Œä½†æˆ‘ä»¬å«<code>tm4c123x::Peripherals::take()</code>ã€‚ç”±äºè¿™ä¸ª crate æ˜¯ä½¿ç”¨<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¯„å­˜å™¨å­—æ®µçš„è®¿é—®å‡½æ•°é‡‡ç”¨é—­åŒ…ï¼Œè€Œä¸æ˜¯æ•°å­—å‚æ•°ã€‚è™½ç„¶è¿™çœ‹èµ·æ¥åƒå¾ˆå¤šä»£ç ï¼Œä½† Rust ç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨å®ƒä¸ºæˆ‘ä»¬æ‰§è¡Œä¸€å †æ£€æŸ¥ï¼Œç„¶åç”Ÿæˆéå¸¸æ¥è¿‘æ‰‹å†™æ±‡ç¼–å™¨çš„æœºå™¨ä»£ç ï¼è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç æ— æ³•ç¡®å®šç‰¹å®šè®¿é—®å™¨å‡½æ•°çš„æ‰€æœ‰å¯èƒ½å‚æ•°éƒ½æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼Œå¦‚æœ SVD å°†å¯„å­˜å™¨å®šä¹‰ä¸º 32 ä½ï¼Œä½†æ²¡æœ‰è¯´æ˜è¿™äº› 32 ä½å€¼ä¸­çš„æŸäº›å€¼æ˜¯å¦æœ‰æ•ˆï¼‰æœ‰ç‰¹æ®Šæ„ä¹‰ï¼‰ï¼Œåˆ™è¯¥å‡½æ•°è¢«æ ‡è®°ä¸º<code>unsafe</code>. åœ¨ä½¿ç”¨è¯¥å‡½æ•°è®¾ç½®<code>load</code>å’Œ<code>compa</code>å­å­—æ®µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹<code>bits()</code>ã€‚</p>
<h4 id="è¯»"><a href="#è¯»" class="headerlink" title="è¯»"></a>è¯»</h4><p>è¯¥<code>read()</code>å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æä¾›å¯¹è¯¥å¯„å­˜å™¨ä¸­å„ä¸ªå­å­—æ®µçš„åªè¯»è®¿é—®ï¼Œå¦‚è¯¥èŠ¯ç‰‡åˆ¶é€ å•†çš„ SVD æ–‡ä»¶æ‰€å®šä¹‰ã€‚æ‚¨å¯ä»¥<code>R</code>åœ¨<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.R.html" target="_blank" rel="noopener">tm4c123x æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æ­¤ç‰¹å®šå¯„å­˜å™¨çš„ç‰¹æ®Šè¿”å›ç±»å‹ã€æ­¤ç‰¹å®šå¤–è®¾ã€æ­¤ç‰¹å®šèŠ¯ç‰‡ä¸Šçš„æ‰€æœ‰å¯ç”¨å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">if</span> pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Do a thing</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="å†™"><a href="#å†™" class="headerlink" title="å†™"></a>å†™</h4><p>è¯¥<code>write()</code>å‡½æ•°é‡‡ç”¨å¸¦æœ‰å•ä¸ªå‚æ•°çš„é—­åŒ…ã€‚é€šå¸¸æˆ‘ä»¬ç§°ä¹‹ä¸º<code>w</code>. ç„¶åï¼Œæ­¤å‚æ•°æä¾›å¯¹è¯¥å¯„å­˜å™¨å†…çš„å„ç§å­å­—æ®µçš„è¯»å†™è®¿é—®ï¼Œå¦‚è¯¥èŠ¯ç‰‡åˆ¶é€ å•†çš„ SVD æ–‡ä»¶æ‰€å®šä¹‰çš„é‚£æ ·ã€‚åŒæ ·ï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.W.html" target="_blank" rel="noopener">tm4c123x æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æ­¤ç‰¹å®šå¯„å­˜å™¨ã€æ­¤ç‰¹å®šå¤–è®¾ã€æ­¤ç‰¹å®šèŠ¯ç‰‡ä¸Šçš„â€œwâ€ä¸Šå¯ç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æœªè®¾ç½®çš„æ‰€æœ‰å­å­—æ®µå°†ä¸ºæˆ‘ä»¬è®¾ç½®ä¸ºé»˜è®¤å€¼ - å¯„å­˜å™¨ä¸­çš„ä»»ä½•ç°æœ‰å†…å®¹éƒ½å°†ä¸¢å¤±ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h4><p>å¦‚æœæˆ‘ä»¬åªæƒ³æ”¹å˜è¿™ä¸ªå¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªç‰¹å®šå­å­—æ®µè€Œå…¶ä»–å­å­—æ®µä¿æŒä¸å˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥<code>modify</code>å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªå‚æ•°çš„é—­åŒ…â€”â€”ä¸€ä¸ªç”¨äºè¯»å–ï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚é€šå¸¸æˆ‘ä»¬åˆ†åˆ«ç§°å®ƒä»¬ä¸º<code>r</code>å’Œ<code>w</code>ã€‚è¯¥<code>r</code>å‚æ•°å¯ä»¥ç”¨æ¥æ£€æŸ¥æ‰€è¿°å¯„å­˜å™¨çš„å½“å‰å†…å®¹ï¼Œå¹¶ä¸”<code>w</code>å‚æ•°å¯ä»¥ç”¨æ¥ä¿®æ”¹å¯„å­˜å™¨çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¯¥<code>modify</code>å‡½æ•°åœ¨è¿™é‡ŒçœŸæ­£å±•ç¤ºäº†é—­åŒ…çš„å¨åŠ›ã€‚åœ¨ C ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è¯»å…¥ä¸€äº›ä¸´æ—¶å€¼ï¼Œä¿®æ”¹æ­£ç¡®çš„ä½ï¼Œç„¶åå°†å€¼å†™å›ã€‚è¿™æ„å‘³ç€å­˜åœ¨ç›¸å½“å¤§çš„é”™è¯¯èŒƒå›´ï¼š</p>
<pre class="line-numbers language-C"><code class="language-C">uint32_t temp = pwm0.ctl.read();
temp |= PWM0_CTL_GLOBALSYNC0;
pwm0.ctl.write(temp);
uint32_t temp2 = pwm0.enable.read();
temp2 |= PWM0_ENABLE_PWM4EN;
pwm0.enable.write(temp); // Uh oh! Wrong variable!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä½¿ç”¨-HAL-æ¿æ¡ç®±"><a href="#ä½¿ç”¨-HAL-æ¿æ¡ç®±" class="headerlink" title="ä½¿ç”¨ HAL æ¿æ¡ç®±"></a>ä½¿ç”¨ HAL æ¿æ¡ç®±</h3><p>èŠ¯ç‰‡çš„ HAL crate é€šå¸¸é€šè¿‡ä¸º PAC å…¬å¼€çš„åŸå§‹ç»“æ„å®ç°è‡ªå®šä¹‰ Trait æ¥å·¥ä½œã€‚é€šå¸¸ï¼Œæ­¤ç‰¹å¾ä¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨<code>constrain()</code>å•ä¸ªå¤–è®¾æˆ–<code>split()</code>å…·æœ‰å¤šä¸ªå¼•è„šçš„ GPIO ç«¯å£ä¹‹ç±»çš„ä¸œè¥¿ã€‚æ­¤å‡½æ•°å°†æ¶ˆè€—åº•å±‚åŸå§‹å¤–å›´ç»“æ„å¹¶è¿”å›å…·æœ‰æ›´é«˜çº§åˆ« API çš„æ–°å¯¹è±¡ã€‚è¿™ä¸ª API ä¹Ÿå¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®©ä¸²å£<code>new</code>åŠŸèƒ½éœ€è¦å€Ÿç”¨ä¸€äº›<code>Clock</code>ç»“æ„ï¼Œåªèƒ½é€šè¿‡è°ƒç”¨é…ç½® PLL å’Œè®¾ç½®æ‰€æœ‰æ—¶é’Ÿé¢‘ç‡çš„å‡½æ•°æ¥ç”Ÿæˆã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œé™æ€åœ°ä¸å¯èƒ½åœ¨æ²¡æœ‰é¦–å…ˆé…ç½®æ—¶é’Ÿé€Ÿç‡çš„æƒ…å†µä¸‹åˆ›å»ºä¸²è¡Œç«¯å£å¯¹è±¡ï¼Œæˆ–è€…ä¸²è¡Œç«¯å£å¯¹è±¡å°†æ³¢ç‰¹ç‡é”™è¯¯åœ°è½¬æ¢ä¸ºæ—¶é’Ÿæ»´ç­”ã€‚ä¸€äº› crate ç”šè‡³ä¸ºæ¯ä¸ª GPIO å¼•è„šå¯ä»¥å¤„äºçš„çŠ¶æ€å®šä¹‰ç‰¹æ®Šç‰¹å¾ï¼Œè¦æ±‚ç”¨æˆ·åœ¨å°†å¼•è„šä¼ é€’åˆ°å¤–è®¾ä¹‹å‰å°†å¼•è„šç½®äºæ­£ç¡®çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡é€‰æ‹©é€‚å½“çš„å¤‡ç”¨åŠŸèƒ½æ¨¡å¼ï¼‰ã€‚ä¸€åˆ‡éƒ½æ²¡æœ‰è¿è¡Œæ—¶æˆæœ¬ï¼</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal <span class="token keyword">as</span> hal<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>NewlineMode<span class="token punctuation">,</span> Serial<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>sysctl<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>CorePeripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the SYSCTL struct into an object with a higher-layer API</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sc <span class="token operator">=</span> p<span class="token punctuation">.</span>SYSCTL<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Pick our oscillation settings</span>
    sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span>oscillator <span class="token operator">=</span> sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>Oscillator<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Main</span><span class="token punctuation">(</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>CrystalFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_16mhz<span class="token punctuation">,</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>SystemClock<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UsePll</span><span class="token punctuation">(</span>sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>PllOutputFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_80_00mhz<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Configure the PLL with those settings</span>
    <span class="token keyword">let</span> clocks <span class="token operator">=</span> sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the GPIO_PORTA struct into an object with a higher-layer API.</span>
    <span class="token comment" spellcheck="true">// Note it needs to borrow `sc.power_control` so it can power up the GPIO</span>
    <span class="token comment" spellcheck="true">// peripheral automatically.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> porta <span class="token operator">=</span> p<span class="token punctuation">.</span>GPIO_PORTA<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Activate the UART.</span>
    <span class="token keyword">let</span> uart <span class="token operator">=</span> Serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">uart0</span><span class="token punctuation">(</span>
        p<span class="token punctuation">.</span>UART0<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The transmit pin</span>
        porta
            <span class="token punctuation">.</span>pa1
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The receive pin</span>
        porta
            <span class="token punctuation">.</span>pa0
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// No RTS or CTS required</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The baud rate</span>
        <span class="token number">115200_u32</span><span class="token punctuation">.</span><span class="token function">bps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// Output handling</span>
        NewlineMode<span class="token punctuation">:</span><span class="token punctuation">:</span>SwapLFtoCRLF<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need the clock rates to calculate the baud rate divisors</span>
        <span class="token operator">&amp;</span>clocks<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need this to power up the UART peripheral</span>
        <span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>uart<span class="token punctuation">,</span> <span class="token string">"Hello, World!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Semihostingï¼ˆåŠä¸»æœºï¼‰"><a href="#Semihostingï¼ˆåŠä¸»æœºï¼‰" class="headerlink" title="Semihostingï¼ˆåŠä¸»æœºï¼‰"></a>Semihostingï¼ˆåŠä¸»æœºï¼‰</h2><p>åŠä¸»æœºæ˜¯ä¸€ç§è®©åµŒå…¥å¼è®¾å¤‡åœ¨ä¸»æœºä¸Šè¿›è¡Œ I/O çš„æœºåˆ¶ï¼Œä¸»è¦ç”¨äºå°†æ¶ˆæ¯è®°å½•åˆ°ä¸»æœºæ§åˆ¶å°ã€‚åŠä¸»æœºéœ€è¦ä¸€ä¸ªè°ƒè¯•ä¼šè¯ï¼Œå‡ ä¹ä¸éœ€è¦å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼ˆæ²¡æœ‰é¢å¤–çš„ç”µçº¿ï¼ï¼‰æ‰€ä»¥å®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚ç¼ºç‚¹æ˜¯å®ƒéå¸¸æ…¢ï¼šæ ¹æ®æ‚¨ä½¿ç”¨çš„ç¡¬ä»¶è°ƒè¯•å™¨ï¼ˆä¾‹å¦‚ ST-Linkï¼‰ï¼Œæ¯ä¸ªå†™å…¥æ“ä½œå¯èƒ½éœ€è¦å‡ æ¯«ç§’ã€‚</p>
<p>è¯¥<a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>ç®±æä¾›äº†ä¸€ä¸ªAPIåšçš„Cortex-Mçš„è®¾å¤‡åŠä¸»æœºæ“ä½œã€‚ä¸‹é¢çš„ç¨‹åºæ˜¯â€œHello, world!â€çš„åŠä¸»æœºç‰ˆæœ¬ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hprintln<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½ åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä½ ä¼šçœ‹åˆ°â€œHello, world!â€ OpenOCD æ—¥å¿—ä¸­çš„æ¶ˆæ¯ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Hello, world!
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ç¡®å®éœ€è¦å…ˆä» GDB åœ¨ OpenOCD ä¸­å¯ç”¨åŠä¸»æœºï¼š</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>QEMU ç†è§£åŠä¸»æœºæ“ä½œï¼Œå› æ­¤ä¸Šè¿°ç¨‹åºä¹Ÿå¯ä»¥è¿è¡Œè€Œ <code>qemu-system-arm</code>æ— éœ€å¯åŠ¨è°ƒè¯•ä¼šè¯ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦å°†<code>-semihosting-config</code>æ ‡å¿—ä¼ é€’ç»™ QEMU ä»¥å¯ç”¨åŠä¸»æœºæ”¯æŒï¼›è¿™äº›æ ‡å¿—å·²ç»åŒ…å«åœ¨<code>.cargo/config.toml</code>æ¨¡æ¿æ–‡ä»¶ä¸­ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ # this program will block the terminal
$ cargo run
     Running `qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿˜æœ‰ä¸€ä¸ª<code>exit</code>åŠä¸»æœºæ“ä½œå¯ç”¨äºç»ˆæ­¢ QEMU è¿›ç¨‹ã€‚é‡è¦æç¤ºï¼šåƒä¸‡<strong>ä¸èƒ½</strong>ä½¿ç”¨<code>debug::exit</code>ç¡¬ä»¶; æ­¤åŠŸèƒ½å¯èƒ½ä¼šæŸåæ‚¨çš„ OpenOCD ä¼šè¯ï¼Œå¹¶ä¸”åœ¨æ‚¨é‡æ–°å¯åŠ¨å®ƒä¹‹å‰æ‚¨å°†æ— æ³•è°ƒè¯•æ›´å¤šç¨‹åºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> roses <span class="token operator">==</span> <span class="token string">"red"</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€åä¸€ä¸ªæç¤ºï¼šæ‚¨å¯ä»¥å°†ææ…Œè¡Œä¸ºè®¾ç½®ä¸º<code>exit(EXIT_FAILURE)</code>. è¿™å°†è®©æ‚¨ç¼–å†™<code>no_std</code>å¯ä»¥åœ¨ QEMU ä¸Šè¿è¡Œçš„è¿è¡Œé€šè¿‡æµ‹è¯•ã€‚</p>
<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œ<code>panic-semihosting</code>æ¿æ¡ç®±å…·æœ‰â€œé€€å‡ºâ€åŠŸèƒ½ï¼Œå¯ç”¨<code>exit(EXIT_FAILURE)</code>åä¼šåœ¨å°†ç´§æ€¥æ¶ˆæ¯è®°å½•åˆ°ä¸»æœº stderr åè°ƒç”¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// features = ["exit"]</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>roses<span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
panicked at 'assertion failed<span class="token punctuation">:</span> `<span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span>`
  left<span class="token punctuation">:</span> `<span class="token string">"blue"</span>`<span class="token punctuation">,</span>
 right<span class="token punctuation">:</span> `<span class="token string">"red"</span>`'<span class="token punctuation">,</span> examples<span class="token operator">/</span>hello<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">5</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>æ³¨æ„</strong>ï¼šè¦åœ¨ ä¸Šå¯ç”¨æ­¤åŠŸèƒ½<code>panic-semihosting</code>ï¼Œè¯·ç¼–è¾‘æ‚¨çš„ <code>Cargo.toml</code>ä¾èµ–é¡¹éƒ¨åˆ†ï¼Œå…¶ä¸­<code>panic-semihosting</code>æŒ‡å®šä¸ºï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">panic-semihosting = { version = "VERSION", features = ["exit"] }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>VERSION</code>æƒ³è¦çš„ç‰ˆæœ¬åœ¨å“ªé‡Œã€‚æœ‰å…³ä¾èµ–é¡¹åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html" target="_blank" rel="noopener"><code>specifying dependencies</code></a>Cargo ä¹¦çš„éƒ¨åˆ†ã€‚</p>
<h2 id="Panickingï¼ˆææ…Œï¼‰"><a href="#Panickingï¼ˆææ…Œï¼‰" class="headerlink" title="Panickingï¼ˆææ…Œï¼‰"></a>Panickingï¼ˆææ…Œï¼‰</h2><p>ææ…Œæ˜¯ Rust è¯­è¨€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚ç´¢å¼•ç­‰å†…ç½®æ“ä½œä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥å†…å­˜å®‰å…¨ã€‚å½“å°è¯•è¶Šç•Œç´¢å¼•æ—¶ï¼Œè¿™ä¼šå¯¼è‡´ææ…Œã€‚</p>
<p>åœ¨æ ‡å‡†åº“ä¸­ï¼Œææ…Œæœ‰ä¸€ä¸ªå®šä¹‰çš„è¡Œä¸ºï¼šå®ƒå±•å¼€ææ…Œçº¿ç¨‹çš„å †æ ˆï¼Œé™¤éç”¨æˆ·é€‰æ‹©åœ¨ææ…Œæ—¶ä¸­æ­¢ç¨‹åºã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨æ²¡æœ‰æ ‡å‡†åº“çš„ç¨‹åºä¸­ï¼Œææ…Œè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯ä»¥é€šè¿‡å£°æ˜<code>#[panic_handler]</code>å‡½æ•°æ¥é€‰æ‹©è¡Œä¸ºã€‚è¯¥å‡½æ•°å¿…é¡»åœ¨ç¨‹åºçš„ä¾èµ–å›¾ä¸­åªå‡ºç°<em>ä¸€æ¬¡</em>ï¼Œå¹¶ä¸”å¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åï¼š<code>fn(&amp;PanicInfo) -&gt; !</code>ï¼Œå…¶ä¸­<a href="https://doc.rust-lang.org/core/panic/struct.PanicInfo.html" target="_blank" rel="noopener"><code>PanicInfo</code></a> æ˜¯ä¸€ä¸ªåŒ…å«æœ‰å…³ææ…Œä½ç½®ä¿¡æ¯çš„ç»“æ„ã€‚</p>
<p>é‰´äºåµŒå…¥å¼ç³»ç»Ÿçš„èŒƒå›´ä»é¢å‘ç”¨æˆ·åˆ°å®‰å…¨å…³é”®ï¼ˆä¸èƒ½å´©æºƒï¼‰ï¼Œæ²¡æœ‰ä¸€ç§é€‚åˆæ‰€æœ‰ææ…Œè¡Œä¸ºçš„å°ºå¯¸ï¼Œä½†æœ‰å¾ˆå¤šå¸¸ç”¨è¡Œä¸ºã€‚è¿™äº›å¸¸è§çš„è¡Œä¸ºå·²ç»è¢«æ‰“åŒ…åˆ°å®šä¹‰<code>#[panic_handler]</code>å‡½æ•°çš„crate ä¸­ã€‚ä¸€äº›ä¾‹å­åŒ…æ‹¬ï¼š</p>
<ul>
<li><a href="https://crates.io/crates/panic-abort" target="_blank" rel="noopener"><code>panic-abort</code></a>. ææ…Œå¯¼è‡´ä¸­æ­¢æŒ‡ä»¤è¢«æ‰§è¡Œã€‚</li>
<li><a href="https://crates.io/crates/panic-halt" target="_blank" rel="noopener"><code>panic-halt</code></a>. ææ…Œå¯¼è‡´ç¨‹åºæˆ–å½“å‰çº¿ç¨‹é€šè¿‡è¿›å…¥æ— é™å¾ªç¯è€Œåœæ­¢ã€‚</li>
<li><a href="https://crates.io/crates/panic-itm" target="_blank" rel="noopener"><code>panic-itm</code></a>. ä½¿ç”¨ ITMï¼ˆä¸€ç§ ARM Cortex-M ç‰¹å®šå¤–è®¾ï¼‰è®°å½•ç´§æ€¥æ¶ˆæ¯ã€‚</li>
<li><a href="https://crates.io/crates/panic-semihosting" target="_blank" rel="noopener"><code>panic-semihosting</code></a>. ä½¿ç”¨åŠä¸»æœºæŠ€æœ¯å°†ææ…Œæ¶ˆæ¯è®°å½•åˆ°ä¸»æœºã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥<a href="https://crates.io/keywords/panic-handler" target="_blank" rel="noopener"><code>panic-handler</code></a> åœ¨ crates.io ä¸Šæ‰¾åˆ°æ›´å¤šæœç´¢å…³é”®å­—çš„ crateã€‚</p>
<p>ç¨‹åºå¯ä»¥é€šè¿‡é“¾æ¥åˆ°ç›¸åº”çš„ crate æ¥é€‰æ‹©è¿™äº›è¡Œä¸ºä¹‹ä¸€ã€‚åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­å°†ææ…Œè¡Œä¸ºè¡¨ç¤ºä¸ºä¸€è¡Œä»£ç è¿™ä¸€äº‹å®ä¸ä»…å¯ç”¨ä½œæ–‡æ¡£ï¼Œè€Œä¸”è¿˜å¯ç”¨äºæ ¹æ®ç¼–è¯‘é…ç½®æ–‡ä»¶æ›´æ”¹ææ…Œè¡Œä¸ºã€‚ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// dev profile: easier to debug panics; can put a breakpoint on `rust_begin_unwind`</span>
<span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// release profile: minimize the binary size of the application</span>
<span class="token attribute attr-name">#[cfg(not(debug_assertions))]</span>
<span class="token keyword">use</span> panic_abort <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>panic-halt</code>ä½¿ç”¨ dev é…ç½®æ–‡ä»¶ ( <code>cargo build</code>)æ„å»ºæ—¶crate é“¾æ¥åˆ°crate ï¼Œä½†<code>panic-abort</code>ä½¿ç”¨ release é…ç½®æ–‡ä»¶ ( <code>cargo build --release</code>)æ„å»ºæ—¶é“¾æ¥åˆ°crate ã€‚</p>
<blockquote>
<p>è¯­å¥çš„<code>use panic_abort as _;</code>å½¢å¼<code>use</code>ç”¨äºç¡®ä¿<code>panic_abort</code>ææ…Œå¤„ç†ç¨‹åºåŒ…å«åœ¨æˆ‘ä»¬çš„æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒåŒæ—¶å‘ç¼–è¯‘å™¨æ˜ç¡®æˆ‘ä»¬ä¸ä¼šæ˜¾å¼ä½¿ç”¨ crate ä¸­çš„ä»»ä½•å†…å®¹ã€‚å¦‚æœæ²¡æœ‰<code>as _</code>é‡å‘½åï¼Œç¼–è¯‘å™¨ä¼šè­¦å‘Šæˆ‘ä»¬æœ‰ä¸€ä¸ªæœªä½¿ç”¨çš„å¯¼å…¥ã€‚æœ‰æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°<code>extern crate panic_abort</code>ï¼Œè€Œä¸æ˜¯ï¼Œè¿™æ˜¯2018å¹´ç‰ˆçš„é”ˆä¹‹å‰ä½¿ç”¨çš„æ—§é£æ ¼ï¼Œç°åœ¨åº”è¯¥ä»…ç”¨äºâ€œSYSROOTâ€ç®±å­ï¼ˆé‚£äº›æ•£å‘ç€é“é”ˆæœ¬èº«ï¼‰ï¼Œä¾‹å¦‚<code>proc_macro</code>ï¼Œ<code>alloc</code>ï¼Œ<code>std</code>ï¼Œå’Œ<code>test</code>ã€‚</p>
</blockquote>
<h3 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h3><p>è¿™æ˜¯ä¸€ä¸ªå°è¯•å¯¹è¶…å‡ºå…¶é•¿åº¦çš„æ•°ç»„è¿›è¡Œç´¢å¼•çš„ç¤ºä¾‹ã€‚æ“ä½œå¯¼è‡´ææ…Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> xs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// out of bounds access</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤ç¤ºä¾‹é€‰æ‹©äº†<code>panic-semihosting</code>ä½¿ç”¨åŠä¸»æœºå°†ç´§æ€¥æ¶ˆæ¯æ‰“å°åˆ°ä¸»æœºæ§åˆ¶å°çš„è¡Œä¸ºã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo run
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb (..)
panicked at 'index out of bounds: the len is 3 but the index is 4', src/main.rs:12:13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥å°è¯•å°†è¡Œä¸ºæ›´æ”¹ä¸º<code>panic-halt</code>å¹¶ç¡®è®¤åœ¨è¿™ç§æƒ…å†µä¸‹ä¸ä¼šæ‰“å°ä»»ä½•æ¶ˆæ¯ã€‚</p>
<h2 id="Exceptionsï¼ˆå¼‚å¸¸ï¼‰"><a href="#Exceptionsï¼ˆå¼‚å¸¸ï¼‰" class="headerlink" title="Exceptionsï¼ˆå¼‚å¸¸ï¼‰"></a>Exceptionsï¼ˆå¼‚å¸¸ï¼‰</h2><p>å¼‚å¸¸å’Œä¸­æ–­æ˜¯å¤„ç†å™¨å¤„ç†å¼‚æ­¥äº‹ä»¶å’Œè‡´å‘½é”™è¯¯ï¼ˆä¾‹å¦‚æ‰§è¡Œæ— æ•ˆæŒ‡ä»¤ï¼‰çš„ç¡¬ä»¶æœºåˆ¶ã€‚å¼‚å¸¸æ„å‘³ç€æŠ¢å å¹¶æ¶‰åŠå¼‚å¸¸å¤„ç†ç¨‹åºã€å“åº”è§¦å‘äº‹ä»¶çš„ä¿¡å·è€Œæ‰§è¡Œçš„å­ç¨‹åºã€‚</p>
<p>è¯¥<code>cortex-m-rt</code>ç®±æä¾›äº†ä¸€ä¸ª<a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.exception.html" target="_blank" rel="noopener"><code>exception</code></a>å£°æ˜å¼‚å¸¸å¤„ç†ç¨‹åºå±æ€§ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Exception handler for the SysTick (System Timer) exception</span>
<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™¤äº†<code>exception</code>å±æ€§å¼‚å¸¸å¤„ç†ç¨‹åºçœ‹èµ·æ¥åƒæ™®é€šå‡½æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ï¼š<code>exception</code>å¤„ç†ç¨‹åº<em>ä¸èƒ½</em>è¢«è½¯ä»¶è°ƒç”¨ã€‚æŒ‰ç…§å‰é¢çš„ç¤ºä¾‹ï¼Œè¯¥è¯­å¥<code>SysTick();</code> å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>è¿™ç§è¡Œä¸ºå‡ ä¹æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œå®ƒéœ€è¦æä¾›ä¸€ä¸ªç‰¹æ€§ï¼š <em>åœ¨</em>å¤„ç†ç¨‹åºä¸­<code>static mut</code>å£°æ˜çš„å˜é‡å¯ä»¥<em>å®‰å…¨</em>ä½¿ç”¨ã€‚ <code>exception</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has transformed to type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯èƒ½çŸ¥é“ï¼Œ<code>static mut</code>åœ¨å‡½æ•°ä¸­ä½¿ç”¨å˜é‡ä¼šä½¿å…¶ <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)" target="_blank" rel="noopener"><em>ä¸å¯é‡å…¥</em></a>ã€‚ä»å¤šä¸ªå¼‚å¸¸/ä¸­æ–­å¤„ç†ç¨‹åºæˆ–ä»<code>main</code>ä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸/ä¸­æ–­å¤„ç†ç¨‹åºç›´æ¥æˆ–é—´æ¥è°ƒç”¨ä¸å¯é‡å…¥å‡½æ•°æ˜¯æœªå®šä¹‰çš„è¡Œä¸º ã€‚</p>
<p>å®‰å…¨ Rust ç»ä¸èƒ½å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå› æ­¤ä¸å¯é‡å…¥å‡½æ•°å¿…é¡»æ ‡è®°ä¸º<code>unsafe</code>. ç„¶è€Œæˆ‘åªæ˜¯å‘Šè¯‰<code>exception</code>å¤„ç†ç¨‹åºå¯ä»¥å®‰å…¨åœ°ä½¿ç”¨<code>static mut</code>å˜é‡ã€‚è¿™æ€ä¹ˆå¯èƒ½ï¼Ÿè¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º <code>exception</code>å¤„ç†ç¨‹åº<em>ä¸èƒ½</em>è¢«è½¯ä»¶è°ƒç”¨ï¼Œå› æ­¤é‡å…¥æ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œè¯¥<code>exception</code>å±æ€§é€šè¿‡å°†é™æ€å˜é‡åŒ…è£…åˆ°<code>unsafe</code>å—ä¸­å¹¶ä¸ºæˆ‘ä»¬æä¾›æ–°çš„é€‚å½“ç±»å‹<code>&amp;mut</code>çš„åŒåå˜é‡æ¥è½¬æ¢å‡½æ•°å†…é™æ€å˜é‡çš„å®šä¹‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>*</code>è®¿é—®å˜é‡çš„å€¼æ¥å–æ¶ˆå¼•ç”¨å¼•ç”¨ï¼Œè€Œæ— éœ€å°†å®ƒä»¬åŒ…è£…åœ¨ä¸€ä¸ª<code>unsafe</code>å—ä¸­ã€‚</p>
</blockquote>
<h3 id="ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­"><a href="#ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­"></a>ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­</h3><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ç³»ç»Ÿè®¡æ—¶å™¨<code>SysTick</code>å¤§çº¦æ¯ç§’å¼•å‘ä¸€æ¬¡å¼‚å¸¸çš„ç¤ºä¾‹ã€‚åœ¨<code>SysTick</code>å¼‚å¸¸å¤„ç†ç¨‹åºè·Ÿè¸ªå®ƒå·²ç»å¤šå°‘æ¬¡è¢«ç§°ä¸ºåœ¨<code>COUNT</code>å˜é‡ï¼Œç„¶åæ‰“å°å‡ºçš„å€¼ <code>COUNT</code>ä½¿ç”¨åŠä¸»æœºä¸»æœºæ§åˆ¶å°ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šæ‚¨å¯ä»¥åœ¨ä»»ä½• Cortex-M è®¾å¤‡ä¸Šè¿è¡Œæ­¤ç¤ºä¾‹ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ QEMU ä¸Šè¿è¡Œå®ƒ</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    debug<span class="token punctuation">,</span>
    hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> HStdout<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> syst <span class="token operator">=</span> p<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configures the system timer to trigger a SysTick exception every second</span>
    syst<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// this is configured for the LM3S6965 which has a default CPU clock of 12 MHz</span>
    syst<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">12_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> STDOUT<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>HStdout<span class="token operator">></span> <span class="token operator">=</span> None<span class="token punctuation">;</span>

    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Lazy initialization</span>
    <span class="token keyword">if</span> STDOUT<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>STDOUT <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> STDOUT<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// IMPORTANT omit this `if` block if running on real hardware or your</span>
    <span class="token comment" spellcheck="true">// debugger will end in an inconsistent state</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>COUNT <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This will terminate the QEMU process</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
tail <span class="token operator">-</span>n5 Cargo<span class="token punctuation">.</span>toml
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
cortex<span class="token operator">-</span>m <span class="token operator">=</span> <span class="token string">"0.5.7"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">"0.6.3"</span>
panic<span class="token operator">-</span>halt <span class="token operator">=</span> <span class="token string">"0.2.0"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>semihosting <span class="token operator">=</span> <span class="token string">"0.3.1"</span>
$ cargo run <span class="token operator">-</span><span class="token operator">-</span>release
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span>arm <span class="token operator">-</span>cpu cortex<span class="token operator">-</span>m3 <span class="token operator">-</span>machine <span class="token function">lm3s6965evb</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
<span class="token number">123456789</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ‚¨åœ¨ Discovery æ¿ä¸Šè¿è¡Œå®ƒï¼Œæ‚¨å°†åœ¨ OpenOCD æ§åˆ¶å°ä¸Šçœ‹åˆ°è¾“å‡ºã€‚æ­¤å¤–ï¼Œå½“è®¡æ•°è¾¾åˆ° 9 æ—¶ï¼Œç¨‹åº<em>ä¸ä¼š</em>åœæ­¢ã€‚</p>
<h3 id="é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº"><a href="#é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº" class="headerlink" title="é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº"></a>é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åº</h3><p>è¯¥<code>exception</code>å±æ€§çš„å®é™…ä½œç”¨æ˜¯<em>è¦†ç›–</em>ç‰¹å®šå¼‚å¸¸çš„é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åºã€‚å¦‚æœæ‚¨ä¸è¦†ç›–ç‰¹å®šå¼‚å¸¸çš„å¤„ç†ç¨‹åºï¼Œå®ƒå°†ç”±<code>DefaultHandler</code>å‡½æ•°å¤„ç†ï¼Œè¯¥å‡½æ•°é»˜è®¤ä¸ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ­¤å‡½æ•°ç”±<code>cortex-m-rt</code>crateæä¾›å¹¶æ ‡è®°ä¸ºï¼Œ <code>#[no_mangle]</code>ä»¥ä¾¿æ‚¨å¯ä»¥åœ¨â€œDefaultHandlerâ€ä¸Šæ”¾ç½®æ–­ç‚¹å¹¶æ•è· <em>æœªå¤„ç†çš„</em>å¼‚å¸¸ã€‚</p>
<p>å¯ä»¥<code>DefaultHandler</code>ä½¿ç”¨<code>exception</code>å±æ€§è¦†ç›–å®ƒï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span>irqn<span class="token punctuation">:</span> i16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// custom default handler</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>irqn</code>å‚æ•°æŒ‡ç¤ºæ­£åœ¨å¤„ç†å“ªä¸ªå¼‚å¸¸ã€‚è´Ÿå€¼è¡¨ç¤ºæ­£åœ¨å¤„ç† Cortex-M å¼‚å¸¸ï¼›é›¶æˆ–æ­£å€¼è¡¨ç¤ºæ­£åœ¨å¤„ç†è®¾å¤‡ç‰¹å®šå¼‚å¸¸ï¼ˆAKA ä¸­æ–­ï¼‰ã€‚</p>
<h3 id="ç¡¬æ•…éšœå¤„ç†ç¨‹åº"><a href="#ç¡¬æ•…éšœå¤„ç†ç¨‹åº" class="headerlink" title="ç¡¬æ•…éšœå¤„ç†ç¨‹åº"></a>ç¡¬æ•…éšœå¤„ç†ç¨‹åº</h3><p>åœ¨<code>HardFault</code>ä¾‹å¤–çš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šã€‚å½“ç¨‹åºè¿›å…¥æ— æ•ˆçŠ¶æ€æ—¶ä¼šè§¦å‘æ­¤å¼‚å¸¸ï¼Œå› æ­¤å…¶å¤„ç†ç¨‹åº<em>æ— æ³•</em>è¿”å›ï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚æ­¤å¤–ï¼Œè¿è¡Œæ—¶ crate åœ¨<code>HardFault</code>è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„å¤„ç†ç¨‹åºä¹‹å‰ä¼šåšä¸€äº›å·¥ä½œï¼Œä»¥æé«˜å¯è°ƒè¯•æ€§ã€‚</p>
<p>ç»“æœæ˜¯<code>HardFault</code>å¤„ç†ç¨‹åºå¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åï¼š <code>fn(&amp;ExceptionFrame) -&gt; !</code>. å¤„ç†ç¨‹åºçš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘ç”±å¼‚å¸¸å‹å…¥å †æ ˆçš„å¯„å­˜å™¨çš„æŒ‡é’ˆã€‚è¿™äº›å¯„å­˜å™¨æ˜¯è§¦å‘å¼‚å¸¸æ—¶å¤„ç†å™¨çŠ¶æ€çš„å¿«ç…§ï¼Œå¯ç”¨äºè¯Šæ–­ç¡¬æ•…éšœã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªæ‰§è¡Œéæ³•æ“ä½œçš„ç¤ºä¾‹ï¼šè¯»å–ä¸å­˜åœ¨çš„å†…å­˜ä½ç½®ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šè¿™ä¸ªç¨‹åºåœ¨ QEMU<code>qemu-system-arm -machine lm3s6965evb</code>ä¸Šæ— æ³•è¿è¡Œï¼Œå³å®ƒä¸ä¼šå´©æºƒï¼Œå› ä¸º å®ƒä¸æ£€æŸ¥å†…å­˜è´Ÿè½½ï¼Œå¹¶ä¸”ä¼šå¾ˆé«˜å…´åœ°<code>0</code>åœ¨è¯»å–æ— æ•ˆå†…å­˜æ—¶è¿”å›ã€‚</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> ExceptionFrame<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hio<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// read a nonexistent memory location</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x3FFF_FFFE</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>ef<span class="token punctuation">:</span> <span class="token operator">&amp;</span>ExceptionFrame<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">mut</span> hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#?}"</span><span class="token punctuation">,</span> ef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>HardFault</code>å¤„ç†å™¨æ‰“å°<code>ExceptionFrame</code>å€¼ã€‚å¦‚æœæ‚¨è¿è¡Œå®ƒï¼Œæ‚¨å°†åœ¨ OpenOCD æ§åˆ¶å°ä¸Šçœ‹åˆ°ç±»ä¼¼çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
ExceptionFrame {
    r0: 0x3ffffffe,
    r1: 0x00f00000,
    r2: 0x20000000,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x080008f7,
    pc: 0x0800094a,
    xpsr: 0x61000000
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥<code>pc</code>å€¼æ˜¯å¼‚å¸¸å‘ç”Ÿæ—¶ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œå®ƒæŒ‡å‘è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤ã€‚</p>
<p>å¦‚æœä½ çœ‹ä¸€ä¸‹ç¨‹åºçš„åæ±‡ç¼–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
(..)
ResetTrampoline:
 8000942:       movw    r0, #0xfffe
 8000946:       movt    r0, #0x3fff
 800094a:       ldr     r0, [r0]
 800094c:       b       #-0x4 <ResetTrampoline+0xa><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨å¯ä»¥åœ¨å<code>0x0800094a</code>æ±‡ç¼–ä¸­æŸ¥æ‰¾ç¨‹åºè®¡æ•°å™¨çš„å€¼ã€‚æ‚¨å°†çœ‹åˆ°åŠ è½½æ“ä½œ ( <code>ldr r0, [r0]</code>) å¯¼è‡´äº†å¼‚å¸¸ã€‚æœ¬<code>r0</code>åœº<code>ExceptionFrame</code>ä¼šå‘Šè¯‰ä½ å¯„å­˜å™¨çš„å€¼<code>r0</code> æ˜¯<code>0x3fff_fffe</code>åœ¨é‚£ä¸ªæ—¶å€™ã€‚</p>
<h2 id="Interruptsï¼ˆä¸­æ–­ï¼‰"><a href="#Interruptsï¼ˆä¸­æ–­ï¼‰" class="headerlink" title="Interruptsï¼ˆä¸­æ–­ï¼‰"></a>Interruptsï¼ˆä¸­æ–­ï¼‰</h2><p>ä¸­æ–­åœ¨å¾ˆå¤šæ–¹é¢ä¸å¼‚å¸¸ä¸åŒï¼Œä½†å®ƒä»¬çš„æ“ä½œå’Œä½¿ç”¨å¤§ä½“ç›¸ä¼¼ï¼Œå¹¶ä¸”å®ƒä»¬ä¹Ÿç”±ç›¸åŒçš„ä¸­æ–­æ§åˆ¶å™¨å¤„ç†ã€‚å°½ç®¡å¼‚å¸¸ç”± Cortex-M æ¶æ„å®šä¹‰ï¼Œä½†ä¸­æ–­å§‹ç»ˆæ˜¯ä¾›åº”å•†ï¼ˆé€šå¸¸ç”šè‡³æ˜¯èŠ¯ç‰‡ï¼‰åœ¨å‘½åå’ŒåŠŸèƒ½æ–¹é¢çš„ç‰¹å®šå®ç°ã€‚</p>
<p>ä¸­æ–­ç¡®å®æä¾›äº†å¾ˆå¤§çš„çµæ´»æ€§ï¼Œåœ¨å°è¯•ä»¥é«˜çº§æ–¹å¼ä½¿ç”¨å®ƒä»¬æ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬ä¸ä¼šåœ¨æœ¬ä¹¦ä¸­ä»‹ç»è¿™äº›ç”¨é€”ï¼Œä½†è®°ä½ä»¥ä¸‹å‡ ç‚¹æ˜¯ä¸ªå¥½ä¸»æ„ï¼š</p>
<ul>
<li>ä¸­æ–­å…·æœ‰å¯ç¼–ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¿™äº›ä¼˜å…ˆçº§å†³å®šäº†å®ƒä»¬çš„å¤„ç†ç¨‹åºçš„æ‰§è¡Œé¡ºåº</li>
<li>ä¸­æ–­å¯ä»¥åµŒå¥—å’ŒæŠ¢å ï¼Œå³ä¸­æ–­å¤„ç†ç¨‹åºçš„æ‰§è¡Œå¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çš„ä¸­æ–­ä¸­æ–­</li>
<li>ä¸€èˆ¬éœ€è¦æ¸…é™¤å¯¼è‡´ä¸­æ–­è§¦å‘çš„åŸå› ï¼Œé˜²æ­¢æ— ä¼‘æ­¢åœ°é‡æ–°è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åº</li>
</ul>
<p>è¿è¡Œæ—¶çš„ä¸€èˆ¬åˆå§‹åŒ–æ­¥éª¤å§‹ç»ˆç›¸åŒï¼š</p>
<ul>
<li>è®¾ç½®å¤–è®¾ä»¥åœ¨æ‰€éœ€åœºåˆç”Ÿæˆä¸­æ–­è¯·æ±‚</li>
<li>åœ¨ä¸­æ–­æ§åˆ¶å™¨ä¸­è®¾ç½®ä¸­æ–­å¤„ç†ç¨‹åºæ‰€éœ€çš„ä¼˜å…ˆçº§</li>
<li>åœ¨ä¸­æ–­æ§åˆ¶å™¨ä¸­å¯ç”¨ä¸­æ–­å¤„ç†ç¨‹åº</li>
</ul>
<p>ä¸å¼‚å¸¸ç±»ä¼¼ï¼Œ<code>cortex-m-rt</code>crate æä¾›äº†ä¸€ä¸ª<a href="https://docs.rs/cortex-m-rt-macros/0.1.5/cortex_m_rt_macros/attr.interrupt.html" target="_blank" rel="noopener"><code>interrupt</code></a> å±æ€§æ¥å£°æ˜ä¸­æ–­å¤„ç†ç¨‹åºã€‚å¯ç”¨çš„ä¸­æ–­ï¼ˆä»¥åŠå®ƒä»¬åœ¨ä¸­æ–­å¤„ç†ç¨‹åºè¡¨ä¸­çš„ä½ç½®ï¼‰é€šå¸¸æ˜¯é€šè¿‡<code>svd2rust</code>SVD æè¿°è‡ªåŠ¨ç”Ÿæˆçš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Interrupt handler for the Timer2 interrupt</span>
<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
    <span class="token comment" spellcheck="true">// Clear reason for the generated interrupt request</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸­æ–­å¤„ç†ç¨‹åºçœ‹èµ·æ¥åƒæ™®é€šå‡½æ•°ï¼ˆé™¤äº†ç¼ºå°‘å‚æ•°ï¼‰ç±»ä¼¼äºå¼‚å¸¸å¤„ç†ç¨‹åºã€‚ç„¶è€Œï¼Œç”±äºç‰¹æ®Šçš„è°ƒç”¨çº¦å®šï¼Œå®ƒä»¬ä¸èƒ½è¢«å›ºä»¶çš„å…¶ä»–éƒ¨åˆ†ç›´æ¥è°ƒç”¨ã€‚ç„¶è€Œï¼Œå¯ä»¥åœ¨è½¯ä»¶ä¸­ç”Ÿæˆä¸­æ–­è¯·æ±‚ä»¥è§¦å‘å¯¹ä¸­æ–­å¤„ç†ç¨‹åºçš„è½¬ç§»ã€‚</p>
<p>ä¸å¼‚å¸¸å¤„ç†ç¨‹åºç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥<code>static mut</code> åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­å£°æ˜å˜é‡ä»¥ä¿æŒ<em>å®‰å…¨</em>çŠ¶æ€ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p><strong>TODO</strong> Cover memory mapped I/O using registers.</p>
<h1 id="Peripheralsï¼ˆå¤–è®¾ï¼‰"><a href="#Peripheralsï¼ˆå¤–è®¾ï¼‰" class="headerlink" title="Peripheralsï¼ˆå¤–è®¾ï¼‰"></a>Peripheralsï¼ˆå¤–è®¾ï¼‰</h1><h3 id="ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å¤–è®¾ï¼Ÿ</h3><p>å¤§å¤šæ•°å¾®æ§åˆ¶å™¨ä¸ä»…ä»…æ˜¯ä¸€ä¸ª CPUã€RAM æˆ–é—ªå­˜â€”â€”å®ƒä»¬åŒ…å«ç¡…ç‰‡éƒ¨åˆ†ï¼Œç”¨äºä¸å¾®æ§åˆ¶å™¨ä¹‹å¤–çš„ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œä»¥åŠé€šè¿‡ä¼ æ„Ÿå™¨ã€ç”µæœºæ§åˆ¶å™¨ç›´æ¥æˆ–é—´æ¥åœ°ä¸å‘¨å›´ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œæˆ–äººæœºç•Œé¢ï¼Œå¦‚æ˜¾ç¤ºå™¨æˆ–é”®ç›˜ã€‚è¿™äº›ç»„ä»¶ç»Ÿç§°ä¸ºå¤–å›´è®¾å¤‡ã€‚</p>
<p>è¿™äº›å¤–è®¾å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å…è®¸å¼€å‘äººå‘˜å°†å¤„ç†å·¥ä½œå¸è½½ç»™å®ƒä»¬ï¼Œä»è€Œé¿å…å¿…é¡»åœ¨è½¯ä»¶ä¸­å¤„ç†æ‰€æœ‰äº‹æƒ…ã€‚ç±»ä¼¼äºæ¡Œé¢å¼€å‘äººå‘˜å°†å›¾å½¢å¤„ç†å¸è½½åˆ°è§†é¢‘å¡çš„æ–¹å¼ï¼ŒåµŒå…¥å¼å¼€å‘äººå‘˜å¯ä»¥å°†ä¸€äº›ä»»åŠ¡å¸è½½åˆ°å¤–å›´è®¾å¤‡ï¼Œä»è€Œè®© CPU å°†æ—¶é—´èŠ±åœ¨åšå…¶ä»–é‡è¦çš„äº‹æƒ…ä¸Šï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšä»¥èŠ‚çœç”µé‡ã€‚</p>
<p>å¦‚æœæ‚¨æŸ¥çœ‹ 1970 å¹´ä»£æˆ– 1980 å¹´ä»£çš„è€å¼å®¶ç”¨è®¡ç®—æœºçš„ä¸»ç”µè·¯æ¿ï¼ˆå®é™…ä¸Šï¼Œæ˜¨å¤©çš„å°å¼ PC ä¸ä»Šå¤©çš„åµŒå…¥å¼ç³»ç»Ÿç›¸è·ç”šè¿œï¼‰ï¼Œæ‚¨ä¼šæœŸæœ›çœ‹åˆ°ï¼š</p>
<ul>
<li>å¤„ç†å™¨</li>
<li>ä¸€ä¸ªå†…å­˜èŠ¯ç‰‡</li>
<li>ä¸€ä¸ªROMèŠ¯ç‰‡</li>
<li>ä¸€ä¸ª I/O æ§åˆ¶å™¨</li>
</ul>
<p>RAM èŠ¯ç‰‡ã€ROM èŠ¯ç‰‡å’Œ I/O æ§åˆ¶å™¨ï¼ˆè¯¥ç³»ç»Ÿä¸­çš„å¤–å›´è®¾å¤‡ï¼‰å°†é€šè¿‡ä¸€ç³»åˆ—ç§°ä¸ºâ€œæ€»çº¿â€çš„å¹¶è¡Œè¿¹çº¿è¿æ¥åˆ°å¤„ç†å™¨ã€‚è¯¥æ€»çº¿æ‰¿è½½åœ°å€ä¿¡æ¯ï¼Œå®ƒé€‰æ‹©å¤„ç†å™¨å¸Œæœ›ä¸æ€»çº¿ä¸Šçš„å“ªä¸ªè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œä»¥åŠæ‰¿è½½å®é™…æ•°æ®çš„æ•°æ®æ€»çº¿ã€‚åœ¨æˆ‘ä»¬çš„åµŒå…¥å¼å¾®æ§åˆ¶å™¨ä¸­ï¼ŒåŒæ ·çš„åŸåˆ™é€‚ç”¨ - åªæ˜¯æ‰€æœ‰ä¸œè¥¿éƒ½å°è£…åœ¨ä¸€å—ç¡…ä¸Šã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸é€šå¸¸å…·æœ‰ Vulkanã€Metal æˆ– OpenGL ç­‰è½¯ä»¶ API çš„å›¾å½¢å¡ä¸åŒï¼Œå¤–å›´è®¾å¤‡é€šè¿‡ç¡¬ä»¶æ¥å£æš´éœ²ç»™æˆ‘ä»¬çš„å¾®æ§åˆ¶å™¨ï¼Œè¯¥æ¥å£æ˜ å°„åˆ°ä¸€å—å†…å­˜ã€‚</p>
<h3 id="çº¿æ€§å’Œå®å†…å­˜ç©ºé—´"><a href="#çº¿æ€§å’Œå®å†…å­˜ç©ºé—´" class="headerlink" title="çº¿æ€§å’Œå®å†…å­˜ç©ºé—´"></a>çº¿æ€§å’Œå®å†…å­˜ç©ºé—´</h3><p>åœ¨å¾®æ§åˆ¶å™¨ä¸Šï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥å…¶ä»–ä»»æ„åœ°å€ï¼ˆä¾‹å¦‚<code>0x4000_0000</code>æˆ–<code>0x0000_0000</code>ï¼‰ä¹Ÿå¯èƒ½æ˜¯å®Œå…¨æœ‰æ•ˆçš„æ“ä½œã€‚</p>
<p>åœ¨æ¡Œé¢ç³»ç»Ÿä¸Šï¼Œå¯¹å†…å­˜çš„è®¿é—®ç”± MMU æˆ–å†…å­˜ç®¡ç†å•å…ƒä¸¥æ ¼æ§åˆ¶ã€‚è¯¥ç»„ä»¶æœ‰ä¸¤ä¸ªä¸»è¦èŒè´£ï¼šå¼ºåˆ¶æ‰§è¡Œå¯¹å†…å­˜éƒ¨åˆ†çš„è®¿é—®æƒé™ï¼ˆé˜²æ­¢ä¸€ä¸ªè¿›ç¨‹è¯»å–æˆ–ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ï¼‰ï¼›å¹¶å°†ç‰©ç†å†…å­˜çš„æ®µé‡æ–°æ˜ å°„åˆ°è½¯ä»¶ä¸­ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜èŒƒå›´ã€‚å¾®æ§åˆ¶å™¨é€šå¸¸æ²¡æœ‰ MMUï¼Œè€Œæ˜¯ä»…åœ¨è½¯ä»¶ä¸­ä½¿ç”¨çœŸå®çš„ç‰©ç†åœ°å€ã€‚</p>
<p>å°½ç®¡ 32 ä½å¾®æ§åˆ¶å™¨å…·æœ‰æ¥è‡ª<code>0x0000_0000</code>, å’Œçš„çœŸå®çº¿æ€§åœ°å€ç©ºé—´<code>0xFFFF_FFFF</code>ï¼Œä½†å®ƒä»¬é€šå¸¸åªä½¿ç”¨è¯¥èŒƒå›´çš„å‡ ç™¾ KB ç”¨äºå®é™…å†…å­˜ã€‚è¿™ç•™ä¸‹äº†å¤§é‡çš„åœ°å€ç©ºé—´ã€‚åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº† RAM ä½äº address <code>0x2000_0000</code>ã€‚å¦‚æœæˆ‘ä»¬çš„RAMä¸º64æ˜†æ˜æ¤ç‰©ç ”ç©¶æ‰€é•¿ï¼ˆå³0xFFFFçš„æœ€å¤§åœ°å€ï¼‰ï¼Œç„¶ååœ°å€<code>0x2000_0000</code>ï¼Œä»¥<code>0x2000_FFFF</code>å°†å¯¹åº”äºæˆ‘ä»¬çš„RAMã€‚å½“æˆ‘ä»¬å†™å…¥ä¸€ä¸ªä½äº address çš„å˜é‡<code>0x2000_1234</code>æ—¶ï¼Œå†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…æ˜¯ä¸€äº›é€»è¾‘æ£€æµ‹åœ°å€çš„é«˜ä½éƒ¨åˆ†ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º 0x2000ï¼‰ï¼Œç„¶åæ¿€æ´» RAM ä»¥ä¾¿å®ƒå¯ä»¥å¯¹åœ°å€çš„ä½ä½éƒ¨åˆ†ï¼ˆ0x1234åœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰ã€‚åœ¨ Cortex-M ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå°†é—ªå­˜ ROM æ˜ å°„åˆ°åœ°å€<code>0x0000_0000</code>ç›´åˆ°åœ°å€<code>0x0007_FFFF</code>ï¼ˆå¦‚æœæˆ‘ä»¬æœ‰ 512 KiB é—ªå­˜ ROMï¼‰ã€‚å¾®æ§åˆ¶å™¨è®¾è®¡è€…å¹¶æ²¡æœ‰å¿½ç•¥è¿™ä¸¤ä¸ªåŒºåŸŸä¹‹é—´çš„æ‰€æœ‰å‰©ä½™ç©ºé—´ï¼Œè€Œæ˜¯å°†å¤–å›´è®¾å¤‡çš„æ¥å£æ˜ å°„åˆ°æŸäº›å­˜å‚¨å™¨ä½ç½®ã€‚è¿™æœ€ç»ˆçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-memory-map.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 æ•°æ®è¡¨ (pdf)</a></p>
<h3 id="å†…å­˜æ˜ å°„å¤–è®¾"><a href="#å†…å­˜æ˜ å°„å¤–è®¾" class="headerlink" title="å†…å­˜æ˜ å°„å¤–è®¾"></a>å†…å­˜æ˜ å°„å¤–è®¾</h3><p>ä¹ä¸€çœ‹ï¼Œä¸è¿™äº›å¤–è®¾çš„äº¤äº’å¾ˆç®€å•â€”â€”å°†æ­£ç¡®çš„æ•°æ®å†™å…¥æ­£ç¡®çš„åœ°å€ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä¸²è¡Œç«¯å£å‘é€ 32 ä½å­—å¯èƒ½ä¸å°†è¯¥ 32 ä½å­—å†™å…¥æŸä¸ªå†…å­˜åœ°å€ä¸€æ ·ç›´æ¥ã€‚ç„¶åä¸²è¡Œç«¯å£å¤–å›´è®¾å¤‡å°†æ¥ç®¡å¹¶è‡ªåŠ¨å‘é€æ•°æ®ã€‚</p>
<p>è¿™äº›å¤–è®¾çš„é…ç½®å·¥ä½œç±»ä¼¼ã€‚ä¸æ˜¯è°ƒç”¨å‡½æ•°æ¥é…ç½®å¤–è®¾ï¼Œè€Œæ˜¯å…¬å¼€äº†ä¸€å—å†…å­˜ï¼Œç”¨ä½œç¡¬ä»¶ APIã€‚å†™å…¥<code>0x8000_0000</code>SPI é¢‘ç‡é…ç½®å¯„å­˜å™¨ï¼ŒSPI ç«¯å£å°†ä»¥æ¯ç§’ 8 å…†ä½çš„é€Ÿåº¦å‘é€æ•°æ®ã€‚å†™å…¥<code>0x0200_0000</code>ç›¸åŒçš„åœ°å€ï¼ŒSPI ç«¯å£å°†ä»¥æ¯ç§’ 125 åƒä½çš„é€Ÿåº¦å‘é€æ•°æ®ã€‚è¿™äº›é…ç½®å¯„å­˜å™¨çœ‹èµ·æ¥æœ‰ç‚¹åƒè¿™æ ·ï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-spi-frequency-register.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 æ•°æ®è¡¨ (pdf)</a></p>
<p>æ— è®ºä½¿ç”¨ä½•ç§è¯­è¨€ï¼Œæ— è®ºè¯¥è¯­è¨€æ˜¯æ±‡ç¼–ã€C è¿˜æ˜¯ Rustï¼Œæ­¤æ¥å£éƒ½æ˜¯ä¸ç¡¬ä»¶è¿›è¡Œäº¤äº’çš„æ–¹å¼ã€‚</p>
<h2 id="A-First-Attempt"><a href="#A-First-Attempt" class="headerlink" title="A First Attempt"></a>A First Attempt</h2><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><p>è®©æˆ‘ä»¬çœ‹çœ‹â€œSysTickâ€å¤–è®¾ - æ¯ä¸ª Cortex-M å¤„ç†å™¨å†…æ ¸éƒ½é™„å¸¦ä¸€ä¸ªç®€å•çš„è®¡æ—¶å™¨ã€‚é€šå¸¸ï¼Œæ‚¨ä¼šåœ¨èŠ¯ç‰‡åˆ¶é€ å•†çš„æ•°æ®è¡¨æˆ–<em>æŠ€æœ¯å‚è€ƒæ‰‹å†Œä¸­</em>æŸ¥æ‰¾è¿™äº›å†…å®¹ï¼Œä½†æ­¤ç¤ºä¾‹é€‚ç”¨äºæ‰€æœ‰ ARM Cortex-M å†…æ ¸ï¼Œè®©æˆ‘ä»¬æŸ¥çœ‹<a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0553a/Babieigh.html" target="_blank" rel="noopener">ARM å‚è€ƒæ‰‹å†Œ</a>ã€‚æˆ‘ä»¬çœ‹åˆ°æœ‰å››ä¸ªå¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>æŠµæ¶ˆ</th>
<th>å§“å</th>
<th>æè¿°</th>
<th>å®½åº¦</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>SYST_CSR</td>
<td>æ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x04</td>
<td>SYST_RVR</td>
<td>é‡è½½å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x08</td>
<td>SYST_CVR</td>
<td>å½“å‰å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
<tr>
<td>0x0C</td>
<td>SYST_CALIB</td>
<td>æ ¡å‡†å€¼å¯„å­˜å™¨</td>
<td>32ä½</td>
</tr>
</tbody></table>
<h3 id="C-æ–¹æ³•"><a href="#C-æ–¹æ³•" class="headerlink" title="C æ–¹æ³•"></a>C æ–¹æ³•</h3><p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸åœ¨ C ä¸­å®Œå…¨ç›¸åŒçš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ç»„å¯„å­˜å™¨ - ä½¿ç”¨<code>struct</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™å®šç¬¦<code>#[repr(C)]</code>å‘Šè¯‰ Rust ç¼–è¯‘å™¨åƒ C ç¼–è¯‘å™¨é‚£æ ·å¸ƒç½®è¿™ä¸ªç»“æ„ã€‚è¿™éå¸¸é‡è¦ï¼Œå› ä¸º Rust å…è®¸é‡æ–°æ’åºç»“æ„å­—æ®µï¼Œè€Œ C åˆ™ä¸å…è®¸ã€‚æ‚¨å¯ä»¥æƒ³è±¡å¦‚æœè¿™äº›å­—æ®µè¢«ç¼–è¯‘å™¨é»˜é»˜åœ°é‡æ–°æ’åˆ—ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸è¿›è¡Œè°ƒè¯•ï¼æœ‰äº†è¿™ä¸ªé™å®šç¬¦ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸ä¸Šè¡¨ç›¸å¯¹åº”çš„å››ä¸ª 32 ä½å­—æ®µã€‚ä½†æ˜¯å½“ç„¶ï¼Œè¿™<code>struct</code>æœ¬èº«æ˜¯æ²¡æœ‰ç”¨çš„â€”â€”æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token operator">*</span>systick<span class="token punctuation">)</span><span class="token punctuation">.</span>cvr <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Volatile-Accesses"><a href="#Volatile-Accesses" class="headerlink" title="Volatile Accesses"></a>Volatile Accesses</h3><p>ç°åœ¨ï¼Œä¸Šè¿°æ–¹æ³•å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚</p>
<ol>
<li>æ¯æ¬¡æˆ‘ä»¬æƒ³è®¿é—®æˆ‘ä»¬çš„å¤–è®¾æ—¶ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»ä½¿ç”¨ unsafeã€‚</li>
<li>æˆ‘ä»¬æ— æ³•æŒ‡å®šå“ªäº›å¯„å­˜å™¨æ˜¯åªè¯»çš„æˆ–è¯»å†™çš„ã€‚</li>
<li>ç¨‹åºä¸­ä»»ä½•ä½ç½®çš„ä»»ä½•ä»£ç éƒ½å¯ä»¥é€šè¿‡æ­¤ç»“æ„è®¿é—®ç¡¬ä»¶ã€‚</li>
<li>æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå®é™…ä¸Šä¸èµ·ä½œç”¨â€¦â€¦</li>
</ol>
<p>ç°åœ¨ï¼Œé—®é¢˜æ˜¯ç¼–è¯‘å™¨å¾ˆèªæ˜ã€‚å¦‚æœæ‚¨å¯¹åŒä¸€å— RAM è¿›è¡Œä¸¤æ¬¡å†™å…¥ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œç¼–è¯‘å™¨ä¼šæ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”å®Œå…¨è·³è¿‡ç¬¬ä¸€æ¬¡å†™å…¥ã€‚åœ¨ C ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å˜é‡æ ‡è®°ä¸º<code>volatile</code>ç¡®ä¿æ¯æ¬¡è¯»å–æˆ–å†™å…¥éƒ½æŒ‰é¢„æœŸè¿›è¡Œã€‚åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å°†<em>è®¿é—®</em>æ ‡è®°ä¸º volatileï¼Œè€Œä¸æ˜¯å˜é‡ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> systick<span class="token punctuation">.</span>cvr<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†å››ä¸ªé—®é¢˜ä¹‹ä¸€ï¼Œä½†ç°åœ¨æˆ‘ä»¬æœ‰æ›´å¤šçš„<code>unsafe</code>ä»£ç ï¼å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¿æ¡ç®±å¯ä»¥æä¾›å¸®åŠ© - <a href="https://crates.io/crates/volatile_register" target="_blank" rel="noopener"><code>volatile_register</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
    <span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œæ˜“å¤±æ€§è®¿é—®æ˜¯é€šè¿‡<code>read</code>å’Œ<code>write</code>æ–¹æ³•è‡ªåŠ¨æ‰§è¡Œçš„ã€‚å®ƒä»ç„¶<code>unsafe</code>æ˜¯æ‰§è¡Œå†™å…¥ï¼Œä½†å…¬å¹³åœ°è¯´ï¼Œç¡¬ä»¶æ˜¯ä¸€å †å¯å˜çŠ¶æ€ï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¿™äº›å†™å…¥æ˜¯å¦çœŸæ­£å®‰å…¨ï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤ä½ç½®ã€‚</p>
<h3 id="The-Rusty-Wrapper"><a href="#The-Rusty-Wrapper" class="headerlink" title="The Rusty Wrapper"></a>The Rusty Wrapper</h3><p>æˆ‘ä»¬éœ€è¦å°†å…¶å°è£…<code>struct</code>åˆ°ä¸€ä¸ªæ›´é«˜å±‚çš„ API ä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„ç”¨æˆ·å¯ä»¥å®‰å…¨åœ°è°ƒç”¨ã€‚ä½œä¸ºé©±åŠ¨ç¨‹åºä½œè€…ï¼Œæˆ‘ä»¬æ‰‹åŠ¨éªŒè¯ä¸å®‰å…¨ä»£ç æ˜¯å¦æ­£ç¡®ï¼Œç„¶åä¸ºæˆ‘ä»¬çš„ç”¨æˆ·æä¾›ä¸€ä¸ªå®‰å…¨çš„ APIï¼Œè¿™æ ·ä»–ä»¬å°±ä¸å¿…æ‹…å¿ƒï¼ˆå‰ææ˜¯ä»–ä»¬ç›¸ä¿¡æˆ‘ä»¬ä¼šåšå¯¹ï¼ï¼‰ã€‚</p>
<p>ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> SystemTimer <span class="token punctuation">{</span>
    p<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> RegisterBlock
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> RegisterBlock <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> SystemTimer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SystemTimer <span class="token punctuation">{</span>
        SystemTimer <span class="token punctuation">{</span>
            p<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> RegisterBlock<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> reload_value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>rvr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reload_value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">example_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">0x00FF_FFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"Time is now 0x{:08x}"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨ï¼Œè¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯ç¼–è¯‘å™¨å®Œå…¨å¯ä»¥æ¥å—ä»¥ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬<code>&amp;mut self</code>å¯¹è¯¥<code>set_reload</code>å‡½æ•°çš„å‚æ•°æ£€æŸ¥æ˜¯å¦æ²¡æœ‰<em>å¯¹è¯¥</em>ç‰¹å®š<code>SystemTimer</code>ç»“æ„çš„å…¶ä»–å¼•ç”¨ï¼Œä½†å®ƒä»¬ä¸ä¼šé˜»æ­¢ç”¨æˆ·åˆ›å»ºç¬¬äºŒä¸ª<code>SystemTimer</code>æŒ‡å‘å®Œå…¨ç›¸åŒçš„å¤–å›´è®¾å¤‡ï¼å¦‚æœä½œè€…è¶³å¤Ÿå‹¤å¥‹åœ°å‘ç°æ‰€æœ‰è¿™äº›â€œé‡å¤â€çš„é©±åŠ¨ç¨‹åºå®ä¾‹ï¼Œä»¥è¿™ç§æ–¹å¼ç¼–å†™çš„ä»£ç å°†èµ·ä½œç”¨ï¼Œä½†æ˜¯ä¸€æ—¦ä»£ç åˆ†å¸ƒåœ¨å¤šä¸ªæ¨¡å—ã€é©±åŠ¨ç¨‹åºã€å¼€å‘äººå‘˜å’Œæ•°å¤©ä¸­ï¼Œç¼–å†™è¿™äº›ä»£ç ä¼šå˜å¾—è¶Šæ¥è¶Šå®¹æ˜“å„ç§é”™è¯¯ã€‚</p>
<h2 id="The-Borrow-Checker"><a href="#The-Borrow-Checker" class="headerlink" title="The Borrow Checker"></a>The Borrow Checker</h2><h3 id="å¯å˜å…¨å±€çŠ¶æ€"><a href="#å¯å˜å…¨å±€çŠ¶æ€" class="headerlink" title="å¯å˜å…¨å±€çŠ¶æ€"></a>å¯å˜å…¨å±€çŠ¶æ€</h3><p>ä¸å¹¸çš„æ˜¯ï¼Œç¡¬ä»¶åŸºæœ¬ä¸Šåªæ˜¯å¯å˜çš„å…¨å±€çŠ¶æ€ï¼Œè¿™å¯¹äº Rust å¼€å‘äººå‘˜æ¥è¯´å¯èƒ½ä¼šæ„Ÿåˆ°éå¸¸å¯æ€•ã€‚ç¡¬ä»¶ç‹¬ç«‹äºæˆ‘ä»¬ç¼–å†™çš„ä»£ç ç»“æ„è€Œå­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥éšæ—¶è¢«ç°å®ä¸–ç•Œä¿®æ”¹ã€‚</p>
<h3 id="æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æˆ‘ä»¬çš„è§„åˆ™åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æˆ‘ä»¬å¦‚ä½•æ‰èƒ½å¯é åœ°ä¸è¿™äº›å¤–å›´è®¾å¤‡äº¤äº’ï¼Ÿ</p>
<ol>
<li>å§‹ç»ˆä½¿ç”¨<code>volatile</code>è¯»å–æˆ–å†™å…¥å¤–å›´å­˜å‚¨å™¨çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒå¯ä»¥éšæ—¶æ›´æ”¹</li>
<li>åœ¨è½¯ä»¶ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå…±äº«å¯¹è¿™äº›å¤–è®¾çš„ä»»æ„æ•°é‡çš„åªè¯»è®¿é—®</li>
<li>å¦‚æœæŸäº›è½¯ä»¶åº”è¯¥å…·æœ‰å¯¹å¤–å›´è®¾å¤‡çš„è¯»å†™è®¿é—®æƒé™ï¼Œåˆ™å®ƒåº”è¯¥æŒæœ‰å¯¹è¯¥å¤–å›´è®¾å¤‡çš„å”¯ä¸€å¼•ç”¨</li>
</ol>
<h3 id="å€Ÿç”¨æ£€æŸ¥å™¨"><a href="#å€Ÿç”¨æ£€æŸ¥å™¨" class="headerlink" title="å€Ÿç”¨æ£€æŸ¥å™¨"></a>å€Ÿç”¨æ£€æŸ¥å™¨</h3><p>è¿™äº›è§„åˆ™ä¸­çš„æœ€åä¸¤æ¡å¬èµ·æ¥ä¸ Borrow Checker å·²ç»åšçš„å¾ˆç›¸ä¼¼ï¼</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä¼ é€’è¿™äº›å¤–å›´è®¾å¤‡çš„æ‰€æœ‰æƒï¼Œæˆ–è€…ä¸ºå®ƒä»¬æä¾›ä¸å¯å˜æˆ–å¯å˜çš„å¼•ç”¨ï¼Ÿ</p>
<p>å—¯ï¼Œæˆ‘ä»¬å¯ä»¥ï¼Œä½†æ˜¯å¯¹äº Borrow Checkerï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªå¤–è®¾æ­£å¥½æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ · Rust æ‰èƒ½æ­£ç¡®å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚å¥½å§ï¼Œå¹¸è¿çš„æ˜¯åœ¨ç¡¬ä»¶ä¸­ï¼Œä»»ä½•ç»™å®šçš„å¤–å›´è®¾å¤‡åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨ä»£ç ç»“æ„ä¸­å…¬å¼€å®ƒï¼Ÿ</p>
<h2 id="Singletons"><a href="#Singletons" class="headerlink" title="Singletons"></a>Singletons</h2><blockquote>
<p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œå•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†ç±»çš„å®ä¾‹åŒ–é™åˆ¶ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p><em>ç»´åŸºç™¾ç§‘ï¼š<a href="https://en.wikipedia.org/wiki/Singleton_pattern" target="_blank" rel="noopener">å•ä¾‹æ¨¡å¼</a></em></p>
</blockquote>
<h3 id="ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ"><a href="#ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ" class="headerlink" title="ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ"></a>ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼Ÿ</h3><p>æˆ‘ä»¬å¯ä»¥è®©ä¸€åˆ‡éƒ½å˜æˆå…¬å…±é™æ€ï¼Œå°±åƒè¿™æ ·</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> THE_SERIAL_PORT<span class="token punctuation">:</span> SerialPort <span class="token operator">=</span> SerialPort<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        THE_SERIAL_PORT<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†è¿™æœ‰å‡ ä¸ªé—®é¢˜ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯å˜çš„å…¨å±€å˜é‡ï¼Œåœ¨ Rust ä¸­ï¼Œä¸è¿™äº›å˜é‡äº¤äº’æ€»æ˜¯ä¸å®‰å…¨çš„ã€‚è¿™äº›å˜é‡åœ¨æ•´ä¸ªç¨‹åºä¸­ä¹Ÿæ˜¯å¯è§çš„ï¼Œè¿™æ„å‘³ç€å€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•å¸®åŠ©æ‚¨è·Ÿè¸ªè¿™äº›å˜é‡çš„å¼•ç”¨å’Œæ‰€æœ‰æƒã€‚</p>
<h3 id="æˆ‘ä»¬å¦‚ä½•åœ¨-Rust-ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ"><a href="#æˆ‘ä»¬å¦‚ä½•åœ¨-Rust-ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ" class="headerlink" title="æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ"></a>æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ</h3><p>æˆ‘ä»¬ä¸åªæ˜¯è®©æˆ‘ä»¬çš„å¤–è®¾æˆä¸ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè€Œæ˜¯å†³å®šåˆ›å»ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç§°ä¸º<code>PERIPHERALS</code>ï¼Œå®ƒåŒ…å«<code>Option&lt;T&gt;</code>æˆ‘ä»¬æ¯ä¸ªå¤–è®¾çš„ ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>SerialPort<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Peripherals <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SerialPort <span class="token punctuation">{</span>
        <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> PERIPHERALS<span class="token punctuation">:</span> Peripherals <span class="token operator">=</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>SerialPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ç§ç»“æ„ä½¿æˆ‘ä»¬èƒ½å¤Ÿè·å¾—å¤–å›´è®¾å¤‡çš„å•ä¸ªå®ä¾‹ã€‚å¦‚æœæˆ‘ä»¬å°è¯•<code>take_serial()</code>å¤šæ¬¡è°ƒç”¨ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä¼šå´©æºƒï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// This panics!</span>
    <span class="token comment" spellcheck="true">// let serial_2 = unsafe { PERIPHERALS.take_serial() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°½ç®¡ä¸è¿™ä¸ªç»“æ„äº¤äº’æ˜¯<code>unsafe</code>ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬åŒ…å«äº†<code>SerialPort</code>å®ƒï¼Œæˆ‘ä»¬å°±ä¸å†éœ€è¦ä½¿ç”¨<code>unsafe</code>ï¼Œæˆ–è€…æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨è¯¥<code>PERIPHERALS</code>ç»“æ„ã€‚</p>
<p>è¿™æœ‰ä¸€ä¸ªå°çš„è¿è¡Œæ—¶å¼€é”€ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»å°†<code>SerialPort</code>ç»“æ„åŒ…è£…åœ¨ä¸€ä¸ªé€‰é¡¹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨<code>take_serial()</code>ä¸€æ¬¡ï¼Œä½†æ˜¯è¿™ä¸ªå°çš„å‰æœŸæˆæœ¬å…è®¸æˆ‘ä»¬åœ¨æˆ‘ä»¬ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ä¸­åˆ©ç”¨å€Ÿç”¨æ£€æŸ¥å™¨ã€‚</p>
<h3 id="ç°æœ‰åº“æ”¯æŒ"><a href="#ç°æœ‰åº“æ”¯æŒ" class="headerlink" title="ç°æœ‰åº“æ”¯æŒ"></a>ç°æœ‰åº“æ”¯æŒ</h3><p>å°½ç®¡æˆ‘ä»¬åœ¨<code>Peripherals</code>ä¸Šé¢åˆ›å»ºäº†è‡ªå·±çš„ç»“æ„ï¼Œä½†æ²¡æœ‰å¿…è¦ä¸ºæ‚¨çš„ä»£ç æ‰§è¡Œæ­¤æ“ä½œã€‚åœ¨<code>cortex_m</code>ç®±å­ä¸­å«æœ‰ä¸€ç§å«å®<code>singleton!()</code>ï¼Œä¼šä¸ºä½ æ‰§è¡Œæ­¤æ“ä½œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_use(singleton)]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// OK if `main` is executed only once</span>
    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> bool <span class="token operator">=</span>
        <span class="token function">singleton!</span><span class="token punctuation">(</span><span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://docs.rs/cortex-m/latest/cortex_m/macro.singleton.html" target="_blank" rel="noopener">cortex_m æ–‡æ¡£</a></p>
<p>æ­¤å¤–ï¼Œå¦‚æœæ‚¨ä½¿ç”¨<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener"><code>cortex-m-rtic</code></a>ï¼Œåˆ™å®šä¹‰å’Œè·å–è¿™äº›å¤–è®¾çš„æ•´ä¸ªè¿‡ç¨‹éƒ½ä¼šä¸ºæ‚¨æŠ½è±¡åŒ–ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ª<code>Peripherals</code>ç»“æ„ï¼Œå…¶ä¸­åŒ…å«<code>Option&lt;T&gt;</code>æ‚¨å®šä¹‰çš„æ‰€æœ‰é¡¹ç›®çš„éç‰ˆæœ¬ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// cortex-m-rtic v0.5.x</span>
#<span class="token punctuation">[</span>rtic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">app</span><span class="token punctuation">(</span>device <span class="token operator">=</span> lm3s6965<span class="token punctuation">,</span> peripherals <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> APP<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[init]</span>
    <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>cx<span class="token punctuation">:</span> init<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">mut</span> X<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Cortex-M peripherals</span>
        <span class="token keyword">let</span> core<span class="token punctuation">:</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>core<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Device specific peripherals</span>
        <span class="token keyword">let</span> device<span class="token punctuation">:</span> lm3s6965<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä½†ä¸ºä»€ä¹ˆï¼Ÿ"><a href="#ä½†ä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä½†ä¸ºä»€ä¹ˆï¼Ÿ"></a>ä½†ä¸ºä»€ä¹ˆï¼Ÿ</h3><p>ä½†æ˜¯è¿™äº›å•ä¾‹å¦‚ä½•å¯¹æˆ‘ä»¬çš„ Rust ä»£ç çš„å·¥ä½œæ–¹å¼äº§ç”Ÿæ˜¾ç€çš„å½±å“ï¼Ÿ</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SER_PORT_SPEED_REG<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32 <span class="token operator">=</span> <span class="token number">0x4000_1000</span> <span class="token keyword">as</span> _<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">read_speed</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token comment" spellcheck="true">// &lt;------ This is really, really important</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>SER_PORT_SPEED_REG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªé‡è¦å› ç´ åœ¨èµ·ä½œç”¨ï¼š</p>
<ul>
<li>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å•ä¾‹ï¼Œæ‰€ä»¥åªæœ‰ä¸€ç§æ–¹æ³•æˆ–åœ°æ–¹å¯ä»¥è·å–<code>SerialPort</code>ç»“æ„</li>
<li>è¦è°ƒç”¨è¯¥<code>read_speed()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»æ‹¥æœ‰æ‰€æœ‰æƒæˆ–å¯¹<code>SerialPort</code>ç»“æ„çš„å¼•ç”¨</li>
</ul>
<p>è¿™ä¸¤ä¸ªå› ç´ æ”¾åœ¨ä¸€èµ·æ„å‘³ç€åªæœ‰åœ¨æˆ‘ä»¬é€‚å½“æ»¡è¶³å€Ÿç”¨æ£€æŸ¥å™¨çš„æƒ…å†µä¸‹æ‰èƒ½è®¿é—®ç¡¬ä»¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šå¯¹åŒä¸€ç¡¬ä»¶æœ‰å¤šä¸ªå¯å˜å¼•ç”¨ï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// missing reference to `self`! Won't work.</span>
    <span class="token comment" spellcheck="true">// SerialPort::read_speed();</span>

    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// you can only read what you have access to</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> serial_1<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶"><a href="#åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶" class="headerlink" title="åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶"></a>åƒå¯¹å¾…æ•°æ®ä¸€æ ·å¯¹å¾…ç¡¬ä»¶</h3><p>æ­¤å¤–ï¼Œç”±äºä¸€äº›å¼•ç”¨æ˜¯å¯å˜çš„ï¼Œè€Œä¸€äº›å¼•ç”¨æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤å¯ä»¥æŸ¥çœ‹å‡½æ•°æˆ–æ–¹æ³•æ˜¯å¦æœ‰å¯èƒ½ä¿®æ”¹ç¡¬ä»¶çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œ</p>
<p>å…è®¸æ›´æ”¹ç¡¬ä»¶è®¾ç½®ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">setup_spi_port</span><span class="token punctuation">(</span>
    spi<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> SpiPort<span class="token punctuation">,</span>
    cs_pin<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> GpioPin
<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸æ˜¯ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read_button</span><span class="token punctuation">(</span>gpio<span class="token punctuation">:</span> <span class="token operator">&amp;</span>GpioPin<span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™å…è®¸æˆ‘ä»¬å¼ºåˆ¶ä»£ç æ˜¯å¦åº”è¯¥æˆ–ä¸åº”è¯¥åœ¨<strong>ç¼–è¯‘æ—¶è€Œ</strong>ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¯¹ç¡¬ä»¶è¿›è¡Œæ›´æ”¹ã€‚è¯·æ³¨æ„ï¼Œè¿™é€šå¸¸ä»…é€‚ç”¨äºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†å¯¹äºè£¸æœºç³»ç»Ÿï¼Œæˆ‘ä»¬çš„è½¯ä»¶å°†è¢«ç¼–è¯‘ä¸ºå•ä¸ªåº”ç”¨ç¨‹åºï¼Œå› æ­¤è¿™é€šå¸¸ä¸æ˜¯é™åˆ¶ã€‚</p>
<h1 id="Static-Guarantees"><a href="#Static-Guarantees" class="headerlink" title="Static Guarantees"></a>Static Guarantees</h1><p>Rust çš„ç±»å‹ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶é˜²æ­¢æ•°æ®ç«äº‰ï¼ˆè¯·å‚é˜…<a href="https://doc.rust-lang.org/core/marker/trait.Send.html" target="_blank" rel="noopener"><code>Send</code></a>å’Œ <a href="https://doc.rust-lang.org/core/marker/trait.Sync.html" target="_blank" rel="noopener"><code>Sync</code></a>ç‰¹å¾ï¼‰ã€‚ç±»å‹ç³»ç»Ÿè¿˜å¯ç”¨äºåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å…¶ä»–å±æ€§ï¼›åœ¨æŸäº›æƒ…å†µä¸‹å‡å°‘è¿è¡Œæ—¶æ£€æŸ¥çš„éœ€è¦ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå½“åº”ç”¨äºåµŒå…¥å¼ç¨‹åºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›<em>é™æ€æ£€æŸ¥</em>æ¥å¼ºåˆ¶æ­£ç¡®å®Œæˆ I/O æ¥å£çš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ª APIï¼Œå…¶ä¸­åªèƒ½é€šè¿‡é¦–å…ˆé…ç½®æ¥å£å°†ä½¿ç”¨çš„å¼•è„šæ¥åˆå§‹åŒ–ä¸²è¡Œæ¥å£ã€‚</p>
<p>è¿˜å¯ä»¥é™æ€æ£€æŸ¥æ“ä½œï¼Œä¾‹å¦‚å°†å¼•è„šè®¾ç½®ä¸ºä½ç”µå¹³ï¼Œåªèƒ½åœ¨æ­£ç¡®é…ç½®çš„å¤–è®¾ä¸Šæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå°è¯•æ›´æ”¹é…ç½®ä¸ºæµ®åŠ¨è¾“å…¥æ¨¡å¼çš„å¼•è„šçš„è¾“å‡ºçŠ¶æ€ä¼šå¼•å‘ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>å¹¶ä¸”ï¼Œå¦‚å‰ä¸€ç« æ‰€è§ï¼Œæ‰€æœ‰æƒçš„æ¦‚å¿µå¯ä»¥åº”ç”¨äºå¤–è®¾ï¼Œä»¥ç¡®ä¿åªæœ‰ç¨‹åºçš„æŸäº›éƒ¨åˆ†å¯ä»¥ä¿®æ”¹å¤–è®¾ã€‚ä¸å°†å¤–å›´è®¾å¤‡è§†ä¸ºå…¨å±€å¯å˜çŠ¶æ€çš„æ›¿ä»£æ–¹æ¡ˆç›¸æ¯”ï¼Œè¿™ç§<em>è®¿é—®æ§åˆ¶</em>ä½¿è½¯ä»¶æ›´å®¹æ˜“æ¨ç†ã€‚</p>
<h2 id="Typestate-Programming"><a href="#Typestate-Programming" class="headerlink" title="Typestate Programming"></a>Typestate Programming</h2><p><a href="https://en.wikipedia.org/wiki/Typestate_analysis" target="_blank" rel="noopener">typestates</a>çš„æ¦‚å¿µæè¿°äº†å°†æœ‰å…³å¯¹è±¡å½“å‰çŠ¶æ€çš„ä¿¡æ¯ç¼–ç ä¸ºè¯¥å¯¹è±¡çš„ç±»å‹ã€‚è™½ç„¶è¿™å¬èµ·æ¥æœ‰ç‚¹ç¥ç§˜ï¼Œä½†å¦‚æœæ‚¨åœ¨ Rust ä¸­ä½¿ç”¨è¿‡<a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html" target="_blank" rel="noopener">æ„å»ºå™¨æ¨¡å¼</a>ï¼Œé‚£ä¹ˆæ‚¨å·²ç»å¼€å§‹ä½¿ç”¨ Typestate Programmingï¼</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">mod</span> foo_module <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[derive(Debug)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
        inner<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">struct</span> FooBuilder <span class="token punctuation">{</span>
        a<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> FooBuilder <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>starter<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">double_a</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Foo <span class="token punctuation">{</span>
            Foo <span class="token punctuation">{</span>
                inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> foo_module<span class="token punctuation">:</span><span class="token punctuation">:</span>FooBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">double_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª<code>Foo</code>å¯¹è±¡ã€‚æˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ª<code>FooBuilder</code>ï¼Œå¹¶æ­£ç¡®åˆå§‹åŒ–å®ƒï¼Œç„¶åæ‰èƒ½è·å¾—<code>Foo</code>æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡ã€‚</p>
<p>è¿™ä¸ªæœ€å°çš„ä¾‹å­ç¼–ç äº†ä¸¤ä¸ªçŠ¶æ€ï¼š</p>
<ul>
<li><code>FooBuilder</code>ï¼Œè¡¨ç¤ºâ€œæœªé…ç½®â€æˆ–â€œé…ç½®è¿›è¡Œä¸­â€çŠ¶æ€</li>
<li><code>Foo</code>ï¼Œè¡¨ç¤ºâ€œå·²é…ç½®â€æˆ–â€œå‡†å¤‡ä½¿ç”¨â€çŠ¶æ€ã€‚</li>
</ul>
<h3 id="å¼ºç±»å‹"><a href="#å¼ºç±»å‹" class="headerlink" title="å¼ºç±»å‹"></a>å¼ºç±»å‹</h3><p>å› ä¸º Rust æœ‰ä¸€ä¸ª<a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing" target="_blank" rel="noopener">å¼ºç±»å‹ç³»ç»Ÿ</a>ï¼Œæ²¡æœ‰ç®€å•çš„æ–¹æ³•å¯ä»¥ç¥å¥‡åœ°åˆ›å»º çš„å®ä¾‹<code>Foo</code>ï¼Œæˆ–è€…åœ¨ä¸è°ƒç”¨æ–¹æ³•<code>FooBuilder</code>çš„<code>Foo</code>æƒ…å†µä¸‹å°† aå˜æˆ a <code>into_foo()</code>ã€‚æ­¤å¤–ï¼Œè°ƒç”¨è¯¥<code>into_foo()</code>æ–¹æ³•ä¼šæ¶ˆè€—åŸå§‹<code>FooBuilder</code>ç»“æ„ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸åˆ›å»ºæ–°å®ä¾‹å°±æ— æ³•é‡ç”¨å®ƒã€‚</p>
<p>è¿™å…è®¸æˆ‘ä»¬å°†ç³»ç»Ÿçš„çŠ¶æ€è¡¨ç¤ºä¸ºç±»å‹ï¼Œå¹¶å°†çŠ¶æ€è½¬æ¢çš„å¿…è¦æ“ä½œåŒ…å«åˆ°å°†ä¸€ç§ç±»å‹äº¤æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„æ–¹æ³•ä¸­ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>FooBuilder</code>å¹¶å°†å…¶äº¤æ¢ä¸ºä¸€ä¸ª<code>Foo</code>å¯¹è±¡ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†åŸºæœ¬çŠ¶æ€æœºçš„æ­¥éª¤ã€‚</p>
<h2 id="Peripherals-as-State-Machines"><a href="#Peripherals-as-State-Machines" class="headerlink" title="Peripherals as State Machines"></a>Peripherals as State Machines</h2><p>å¾®æ§åˆ¶å™¨çš„å¤–å›´è®¾å¤‡å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç»„çŠ¶æ€æœºã€‚ä¾‹å¦‚ï¼Œç®€åŒ–<a href="https://en.wikipedia.org/wiki/General-purpose_input/output" target="_blank" rel="noopener">GPIO å¼•è„š</a>çš„é…ç½®å¯ä»¥è¡¨ç¤ºä¸ºä»¥ä¸‹çŠ¶æ€æ ‘ï¼š</p>
<ul>
<li>å·²ç¦ç”¨</li>
<li>å¯ç”¨<ul>
<li>é…ç½®ä¸ºè¾“å‡º<ul>
<li>è¾“å‡ºï¼šé«˜</li>
<li>è¾“å‡ºï¼šä½</li>
</ul>
</li>
<li>é…ç½®ä¸ºè¾“å…¥<ul>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
<li>è¾“å…¥ï¼šæ‹‰é«˜</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¦‚æœå¤–è®¾åœ¨<code>Disabled</code>æ¨¡å¼ä¸‹å¯åŠ¨ï¼Œè¦ç§»åŠ¨åˆ°<code>Input: High Resistance</code>æ¨¡å¼ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å·²ç¦ç”¨</li>
<li>å¯ç”¨</li>
<li>é…ç½®ä¸ºè¾“å…¥</li>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
</ol>
<p>å¦‚æœæˆ‘ä»¬æƒ³ä» ç§»åŠ¨<code>Input: High Resistance</code>åˆ°<code>Input: Pulled Low</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>è¾“å…¥ï¼šé«˜é˜»</li>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
</ol>
<p>åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬è¦å°† GPIO å¼•è„šä»é…ç½®ä¸º ç§»åŠ¨<code>Input: Pulled Low</code>åˆ°<code>Output: High</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>è¾“å…¥ï¼šæ‹‰ä½</li>
<li>é…ç½®ä¸ºè¾“å…¥</li>
<li>é…ç½®ä¸ºè¾“å‡º</li>
<li>è¾“å‡ºï¼šé«˜</li>
</ol>
<h3 id="ç¡¬ä»¶è¡¨ç¤º"><a href="#ç¡¬ä»¶è¡¨ç¤º" class="headerlink" title="ç¡¬ä»¶è¡¨ç¤º"></a>ç¡¬ä»¶è¡¨ç¤º</h3><p>é€šå¸¸ï¼Œä¸Šé¢åˆ—å‡ºçš„çŠ¶æ€æ˜¯é€šè¿‡å°†å€¼å†™å…¥æ˜ å°„åˆ° GPIO å¤–è®¾çš„ç»™å®šå¯„å­˜å™¨æ¥è®¾ç½®çš„ã€‚è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè™šæ„çš„ GPIO é…ç½®å¯„å­˜å™¨æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼š</p>
<table>
<thead>
<tr>
<th>å§“å</th>
<th>ä½æ•°</th>
<th>ä»·å€¼</th>
<th>æ„ä¹‰</th>
<th>ç¬”è®°</th>
</tr>
</thead>
<tbody><tr>
<td>ä½¿èƒ½å¤Ÿ</td>
<td>0</td>
<td>0</td>
<td>æ®‹ç–¾</td>
<td>ç¦ç”¨ GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>å¯ç”¨</td>
<td>å¯ç”¨ GPIO</td>
</tr>
<tr>
<td>æ–¹å‘</td>
<td>1</td>
<td>0</td>
<td>è¾“å…¥</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å…¥</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è¾“å‡º</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å‡º</td>
</tr>
<tr>
<td>è¾“å…¥æ¨¡å¼</td>
<td>2..3</td>
<td>00</td>
<td>é«˜é˜»æŠ—</td>
<td>å°†è¾“å…¥è®¾ç½®ä¸ºé«˜ç”µé˜»</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>ä¸‹æ‹‰</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰ä½</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>æ‹‰é«˜</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰é«˜</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>ä¸é€‚ç”¨</td>
<td>æ— æ•ˆçŠ¶æ€ã€‚ä¸è¦è®¾ç½®</td>
</tr>
<tr>
<td>è¾“å‡ºæ¨¡å¼</td>
<td>4</td>
<td>0</td>
<td>è®¾ç½®ä½</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºä½ç”µå¹³</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è®¾ç½®é«˜</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºé«˜ç”µå¹³</td>
</tr>
<tr>
<td>è¾“å…¥çŠ¶æ€</td>
<td>5</td>
<td>X</td>
<td>æœ‰æ•ˆå€¼</td>
<td>0 å¦‚æœè¾“å…¥ &lt; 1.5vï¼Œ1 å¦‚æœè¾“å…¥ &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>æˆ‘ä»¬<em>å¯ä»¥</em>åœ¨ Rust ä¸­æš´éœ²ä»¥ä¸‹ç»“æ„æ¥æ§åˆ¶è¿™ä¸ª GPIOï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬ä¿®æ”¹æŸäº›æ²¡æœ‰æ„ä¹‰çš„å¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬<code>output_mode</code>åœ¨ GPIO é…ç½®ä¸ºè¾“å…¥æ—¶è®¾ç½®è¯¥å­—æ®µä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨è¿™ç§ç»“æ„å°†å…è®¸æˆ‘ä»¬è¾¾åˆ°ä¸Šé¢çŠ¶æ€æœºæœªå®šä¹‰çš„çŠ¶æ€ï¼šä¾‹å¦‚ï¼Œè¾“å‡ºè¢«æ‹‰ä½ï¼Œæˆ–è¾“å…¥è¢«è®¾ç½®ä¸ºé«˜ã€‚å¯¹äºæŸäº›ç¡¬ä»¶ï¼Œè¿™å¯èƒ½æ— å…³ç´§è¦ã€‚åœ¨å…¶ä»–ç¡¬ä»¶ä¸Šï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´æ„å¤–æˆ–æœªå®šä¹‰çš„è¡Œä¸ºï¼</p>
<p>è™½ç„¶è¿™ä¸ªæ¥å£ç¼–å†™èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å¼ºåˆ¶æ‰§è¡Œæˆ‘ä»¬çš„ç¡¬ä»¶å®ç°æ‰€è§„å®šçš„è®¾è®¡å¥‘çº¦ã€‚</p>
<h2 id="Design-Contracts"><a href="#Design-Contracts" class="headerlink" title="Design Contracts"></a>Design Contracts</h2><p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª<em>ä¸</em>å¼ºåˆ¶æ‰§è¡Œè®¾è®¡å¥‘çº¦çš„æ¥å£ã€‚è®©æˆ‘ä»¬å†çœ‹çœ‹æˆ‘ä»¬æƒ³è±¡ä¸­çš„ GPIO é…ç½®å¯„å­˜å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>å§“å</th>
<th>ä½æ•°</th>
<th>ä»·å€¼</th>
<th>æ„ä¹‰</th>
<th>ç¬”è®°</th>
</tr>
</thead>
<tbody><tr>
<td>ä½¿èƒ½å¤Ÿ</td>
<td>0</td>
<td>0</td>
<td>æ®‹ç–¾</td>
<td>ç¦ç”¨ GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>å¯ç”¨</td>
<td>å¯ç”¨ GPIO</td>
</tr>
<tr>
<td>æ–¹å‘</td>
<td>1</td>
<td>0</td>
<td>è¾“å…¥</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å…¥</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è¾“å‡º</td>
<td>å°†æ–¹å‘è®¾ç½®ä¸ºè¾“å‡º</td>
</tr>
<tr>
<td>è¾“å…¥æ¨¡å¼</td>
<td>2..3</td>
<td>00</td>
<td>é«˜é˜»æŠ—</td>
<td>å°†è¾“å…¥è®¾ç½®ä¸ºé«˜ç”µé˜»</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>ä¸‹æ‹‰</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰ä½</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>æ‹‰é«˜</td>
<td>è¾“å…¥å¼•è„šè¢«æ‹‰é«˜</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>ä¸é€‚ç”¨</td>
<td>æ— æ•ˆçŠ¶æ€ã€‚ä¸è¦è®¾ç½®</td>
</tr>
<tr>
<td>è¾“å‡ºæ¨¡å¼</td>
<td>4</td>
<td>0</td>
<td>è®¾ç½®ä½</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºä½ç”µå¹³</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>è®¾ç½®é«˜</td>
<td>è¾“å‡ºå¼•è„šè¢«é©±åŠ¨ä¸ºé«˜ç”µå¹³</td>
</tr>
<tr>
<td>è¾“å…¥çŠ¶æ€</td>
<td>5</td>
<td>X</td>
<td>æœ‰æ•ˆå€¼</td>
<td>0 å¦‚æœè¾“å…¥ &lt; 1.5vï¼Œ1 å¦‚æœè¾“å…¥ &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>å¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨åº•å±‚ç¡¬ä»¶ä¹‹å‰æ£€æŸ¥çŠ¶æ€ï¼Œåœ¨è¿è¡Œæ—¶æ‰§è¡Œæˆ‘ä»¬çš„è®¾è®¡å¥‘çº¦ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set direction</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set input mode</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set output status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be output</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>bool<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to get status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å› ä¸ºæˆ‘ä»¬éœ€è¦å¯¹ç¡¬ä»¶å®æ–½é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä¼šè¿›è¡Œå¤§é‡çš„è¿è¡Œæ—¶æ£€æŸ¥ï¼Œè¿™ä¼šæµªè´¹æ—¶é—´å’Œèµ„æºï¼Œè€Œä¸”è¿™äº›ä»£ç å¯¹äºå¼€å‘äººå‘˜æ¥è¯´ä½¿ç”¨èµ·æ¥ä¼šå¾ˆä¸æ„‰å¿«ã€‚</p>
<h3 id="ç±»å‹çŠ¶æ€"><a href="#ç±»å‹çŠ¶æ€" class="headerlink" title="ç±»å‹çŠ¶æ€"></a>ç±»å‹çŠ¶æ€</h3><p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Rust çš„ç±»å‹ç³»ç»Ÿæ¥å¼ºåˆ¶æ‰§è¡ŒçŠ¶æ€è½¬æ¢è§„åˆ™å‘¢ï¼Ÿæ‹¿è¿™ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig<span class="token operator">&lt;</span>ENABLED<span class="token punctuation">,</span> DIRECTION<span class="token punctuation">,</span> MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
    enabled<span class="token punctuation">:</span> ENABLED<span class="token punctuation">,</span>
    direction<span class="token punctuation">:</span> DIRECTION<span class="token punctuation">,</span>
    mode<span class="token punctuation">:</span> MODE<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Type states for MODE in GpioConfig</span>
<span class="token keyword">struct</span> Disabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Output<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Input<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledLow<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledHigh<span class="token punctuation">;</span>
<span class="token keyword">struct</span> HighZ<span class="token punctuation">;</span>
<span class="token keyword">struct</span> DontCare<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/// These functions may be used on any GPIO Pin</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_disabled</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> DontCare<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Disabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">set_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Output<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// This function may be used on an Output Pin</span>
<span class="token keyword">impl</span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> set_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>set_high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// These methods may be used on any enabled input GPIO</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_status<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledLow<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_low</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledLow<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_up</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledHigh<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨å®ƒçš„ä»£ç ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/*
 * Example 1: Unconfigured to High-Z input
 */</span>
<span class="token keyword">let</span> pin<span class="token punctuation">:</span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">get_gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, pin isn't enabled!</span>
<span class="token comment" spellcheck="true">// pin.into_input_pull_down();</span>

<span class="token comment" spellcheck="true">// Now turn the pin from unconfigured to a high-z input</span>
<span class="token keyword">let</span> input_pin <span class="token operator">=</span> pin<span class="token punctuation">.</span><span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Read from the pin</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, input pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// input_pin.set_bit(true);</span>

<span class="token comment" spellcheck="true">/*
 * Example 2: High-Z input to Pulled Low input
 */</span>
<span class="token keyword">let</span> pulled_low <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Example 3: Pulled Low input to Output, set high
 */</span>
<span class="token keyword">let</span> output_pin <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
output_pin<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, output pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// output_pin.into_input_pull_down();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ç»å¯¹æ˜¯ä¸€ç§å­˜å‚¨å¼•è„šçŠ¶æ€çš„ä¾¿æ·æ–¹å¼ï¼Œä½†ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿™æ¯”å°†çŠ¶æ€å­˜å‚¨åœ¨<code>enum</code>æˆ‘ä»¬çš„<code>GpioConfig</code>ç»“æ„å†…éƒ¨æ›´å¥½ï¼Ÿ</p>
<h3 id="ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨"><a href="#ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨" class="headerlink" title="ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨"></a>ç¼–è¯‘æ—¶åŠŸèƒ½å®‰å…¨</h3><p>å› ä¸ºæˆ‘ä»¬å®Œå…¨åœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡Œæˆ‘ä»¬çš„è®¾è®¡çº¦æŸï¼Œæ‰€ä»¥è¿™ä¸ä¼šäº§ç”Ÿè¿è¡Œæ—¶æˆæœ¬ã€‚å½“å¼•è„šå¤„äºè¾“å…¥æ¨¡å¼æ—¶ï¼Œæ— æ³•è®¾ç½®è¾“å‡ºæ¨¡å¼ã€‚ç›¸åï¼Œæ‚¨å¿…é¡»é€šè¿‡å°†å…¶è½¬æ¢ä¸ºè¾“å‡ºå¼•è„šæ¥éå†çŠ¶æ€ï¼Œç„¶åè®¾ç½®è¾“å‡ºæ¨¡å¼ã€‚å› æ­¤ï¼Œåœ¨æ‰§è¡Œå‡½æ•°ä¹‹å‰æ£€æŸ¥å½“å‰çŠ¶æ€ä¸ä¼šé€ æˆè¿è¡Œæ—¶æŸå¤±ã€‚</p>
<p>æ­¤å¤–ï¼Œç”±äºè¿™äº›çŠ¶æ€æ˜¯ç”±ç±»å‹ç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œçš„ï¼Œå› æ­¤è¯¥æ¥å£çš„ä½¿ç”¨è€…ä¸å†æœ‰é”™è¯¯çš„ä½™åœ°ã€‚å¦‚æœä»–ä»¬å°è¯•æ‰§è¡Œéæ³•çš„çŠ¶æ€è½¬æ¢ï¼Œä»£ç å°†æ— æ³•ç¼–è¯‘ï¼</p>
<h2 id="Zero-Cost-Abstractions"><a href="#Zero-Cost-Abstractions" class="headerlink" title="Zero Cost Abstractions"></a>Zero Cost Abstractions</h2><p>ç±»å‹çŠ¶æ€ä¹Ÿæ˜¯é›¶æˆæœ¬æŠ½è±¡çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ - å°†æŸäº›è¡Œä¸ºç§»åŠ¨åˆ°ç¼–è¯‘æ—¶æ‰§è¡Œæˆ–åˆ†æçš„èƒ½åŠ›ã€‚è¿™äº›ç±»å‹çŠ¶æ€ä¸åŒ…å«å®é™…æ•°æ®ï¼Œè€Œæ˜¯ç”¨ä½œæ ‡è®°ã€‚ç”±äºå®ƒä»¬ä¸åŒ…å«æ•°æ®ï¼Œå› æ­¤å®ƒä»¬åœ¨è¿è¡Œæ—¶åœ¨å†…å­˜ä¸­æ²¡æœ‰å®é™…è¡¨ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>mem<span class="token punctuation">:</span><span class="token punctuation">:</span>size_of<span class="token punctuation">;</span>

<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Enabled<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Input<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>PulledHigh<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="é›¶å°ºå¯¸ç±»å‹"><a href="#é›¶å°ºå¯¸ç±»å‹" class="headerlink" title="é›¶å°ºå¯¸ç±»å‹"></a>é›¶å°ºå¯¸ç±»å‹</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åƒè¿™æ ·å®šä¹‰çš„ç»“æ„ç§°ä¸ºé›¶å¤§å°ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬ä¸åŒ…å«å®é™…æ•°æ®ã€‚å°½ç®¡è¿™äº›ç±»å‹åœ¨ç¼–è¯‘æ—¶æ˜¯â€œçœŸå®çš„â€â€”â€”æ‚¨å¯ä»¥å¤åˆ¶å®ƒä»¬ã€ç§»åŠ¨å®ƒä»¬ã€å¼•ç”¨å®ƒä»¬ç­‰ç­‰ï¼Œä½†æ˜¯ä¼˜åŒ–å™¨å°†å®Œå…¨å‰¥ç¦»å®ƒä»¬ã€‚</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GpioConfig <span class="token punctuation">{</span>
        periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
        enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
        direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿”å›çš„ GpioConfig åœ¨è¿è¡Œæ—¶ä»ä¸å­˜åœ¨ã€‚è°ƒç”¨æ­¤å‡½æ•°é€šå¸¸å½’ç»“ä¸ºå•ä¸ªæ±‡ç¼–æŒ‡ä»¤ - å°†å¸¸é‡å¯„å­˜å™¨å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ä½ç½®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¼€å‘çš„ç±»å‹çŠ¶æ€æ¥å£æ˜¯ä¸€ç§é›¶æˆæœ¬æŠ½è±¡â€”â€”å®ƒä¸å†ä½¿ç”¨ CPUã€RAM æˆ–ä»£ç ç©ºé—´æ¥è·Ÿè¸ª çš„çŠ¶æ€<code>GpioConfig</code>ï¼Œå¹¶å‘ˆç°ä¸ºä¸ç›´æ¥å¯„å­˜å™¨è®¿é—®ç›¸åŒçš„æœºå™¨ä»£ç ã€‚</p>
<h3 id="åµŒå¥—"><a href="#åµŒå¥—" class="headerlink" title="åµŒå¥—"></a>åµŒå¥—</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œè¿™äº›æŠ½è±¡å¯ä»¥æ ¹æ®æ‚¨çš„éœ€è¦è¿›è¡ŒåµŒå¥—ã€‚åªè¦ä½¿ç”¨çš„æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯é›¶å°ºå¯¸ç±»å‹ï¼Œæ•´ä¸ªç»“æ„åœ¨è¿è¡Œæ—¶å°±ä¸ä¼šå­˜åœ¨ã€‚</p>
<p>å¯¹äºå¤æ‚æˆ–æ·±åº¦åµŒå¥—çš„ç»“æ„ï¼Œå®šä¹‰æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€ç»„åˆå¯èƒ½å¾ˆä¹å‘³ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå®å¯ç”¨äºç”Ÿæˆæ‰€æœ‰å®ç°ã€‚</p>
<h1 id="Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰"><a href="#Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰" class="headerlink" title="Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰"></a>Portabilityï¼ˆå¯ç§»æ¤æ€§ï¼‰</h1><p>åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­ï¼Œå¯ç§»æ¤æ€§æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯é¢˜ï¼šæ¯ä¸ªä¾›åº”å•†ç”šè‡³æ¥è‡ªå•ä¸ªåˆ¶é€ å•†çš„æ¯ä¸ªç³»åˆ—éƒ½æä¾›ä¸åŒçš„å¤–å›´è®¾å¤‡å’ŒåŠŸèƒ½ï¼ŒåŒæ ·ï¼Œä¸å¤–å›´è®¾å¤‡äº¤äº’çš„æ–¹å¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<p>å¹³è¡¡è¿™ç§å·®å¼‚çš„å¸¸ç”¨æ–¹æ³•æ˜¯é€šè¿‡ç§°ä¸ºç¡¬ä»¶æŠ½è±¡å±‚æˆ–<strong>HAL çš„</strong>å±‚ã€‚</p>
<blockquote>
<p>ç¡¬ä»¶æŠ½è±¡æ˜¯è½¯ä»¶ä¸­çš„ä¸€ç»„ä¾‹ç¨‹ï¼Œç”¨äºæ¨¡æ‹ŸæŸäº›ç‰¹å®šäºå¹³å°çš„ç»†èŠ‚ï¼Œä½¿ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºã€‚</p>
<p>å®ƒä»¬é€šå¸¸å…è®¸ç¨‹åºå‘˜é€šè¿‡å‘ç¡¬ä»¶æä¾›æ ‡å‡†æ“ä½œç³»ç»Ÿ (OS) è°ƒç”¨æ¥ç¼–å†™ç‹¬ç«‹äºè®¾å¤‡çš„é«˜æ€§èƒ½åº”ç”¨ç¨‹åºã€‚</p>
<p><em>ç»´åŸºç™¾ç§‘ï¼š<a href="https://en.wikipedia.org/wiki/Hardware_abstraction" target="_blank" rel="noopener">ç¡¬ä»¶æŠ½è±¡å±‚</a></em></p>
</blockquote>
<p>åµŒå…¥å¼ç³»ç»Ÿåœ¨è¿™æ–¹é¢æœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸æ²¡æœ‰æ“ä½œç³»ç»Ÿå’Œç”¨æˆ·å¯å®‰è£…çš„è½¯ä»¶ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“ç¼–è¯‘çš„å›ºä»¶æ˜ åƒä»¥åŠè®¸å¤šå…¶ä»–é™åˆ¶ã€‚å› æ­¤ï¼Œè™½ç„¶ç»´åŸºç™¾ç§‘å®šä¹‰çš„ä¼ ç»Ÿæ–¹æ³•å¯èƒ½æœ‰æ•ˆï¼Œä½†å®ƒå¯èƒ½ä¸æ˜¯ç¡®ä¿å¯ç§»æ¤æ€§çš„æœ€æœ‰æ•ˆæ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•åœ¨ Rust ä¸­åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿè¾“å…¥<strong>åµŒå…¥å¼å“ˆ</strong>â€¦</p>
<h2 id="ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åµŒå…¥å¼halï¼Ÿ</h2><p>ç®€è€Œè¨€ä¹‹ï¼Œå®ƒæ˜¯ä¸€ç»„ç‰¹æ€§ï¼Œå®šä¹‰äº†<strong>HAL å®ç°</strong>ã€<strong>é©±åŠ¨ç¨‹åº</strong>å’Œ<strong>åº”ç”¨ç¨‹åºï¼ˆæˆ–å›ºä»¶ï¼‰</strong>ä¹‹é—´çš„å®ç°å¥‘çº¦ã€‚è¿™äº›å¥‘çº¦åŒ…æ‹¬èƒ½åŠ›ï¼ˆå³å¦‚æœä¸ºæŸç§ç±»å‹å®ç°äº†ç‰¹å¾ï¼Œ<strong>HAL å®ç°</strong>æä¾›äº†æŸç§èƒ½åŠ›ï¼‰å’Œæ–¹æ³•ï¼ˆå³å¦‚æœæ‚¨å¯ä»¥æ„é€ ä¸€ä¸ªå®ç°ç‰¹å¾çš„ç±»å‹ï¼Œåˆ™ä¿è¯æ‚¨æ‹¥æœ‰ç‰¹å¾ä¸­æŒ‡å®šçš„æ–¹æ³•å¯ç”¨çš„ï¼‰ã€‚</p>
<p>å…¸å‹çš„åˆ†å±‚å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/loading.gif" data-original="../images/language/rust_layers.svg" alt=""></p>
<p><strong>åµŒå…¥å¼ hal</strong>ä¸­å®šä¹‰çš„ä¸€äº›ç‰¹å¾æ˜¯ï¼š</p>
<ul>
<li>GPIOï¼ˆè¾“å…¥å’Œè¾“å‡ºå¼•è„šï¼‰</li>
<li>ä¸²è¡Œé€šè®¯</li>
<li>I2C</li>
<li>SPI</li>
<li>è®¡æ—¶å™¨/å€’è®¡æ—¶</li>
<li>æ¨¡æ•°è½¬æ¢</li>
</ul>
<p>å®ç°å’Œä½¿ç”¨<strong>åµŒå…¥å¼ hal</strong>ç‰¹å¾å’Œæ¿æ¡ç®±çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†æ§åˆ¶å¤æ‚æ€§ã€‚å¦‚æœæ‚¨è®¤ä¸ºåº”ç”¨ç¨‹åºå¯èƒ½å¿…é¡»åœ¨ç¡¬ä»¶ä»¥åŠåº”ç”¨ç¨‹åºå’Œå…¶ä»–ç¡¬ä»¶ç»„ä»¶çš„æ½œåœ¨é©±åŠ¨ç¨‹åºä¸­å®ç°å¯¹å¤–å›´è®¾å¤‡çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆåº”è¯¥å¾ˆå®¹æ˜“çœ‹å‡ºå¯é‡ç”¨æ€§éå¸¸æœ‰é™ã€‚ç”¨æ•°å­¦è¡¨ç¤ºï¼Œå¦‚æœ<strong>M</strong>æ˜¯å¤–å›´ HAL å®ç°çš„æ•°é‡ï¼Œ<strong>N</strong>æ˜¯é©±åŠ¨ç¨‹åºçš„æ•°é‡ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºé‡æ–°å‘æ˜è½®å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°<strong>M*N ä¸ª</strong>å®ç°ï¼ŒåŒæ—¶ä½¿ç”¨<strong>åµŒå…¥å¼</strong>HALæä¾›çš„<em>API</em>ç‰¹å¾å°†ä½¿å®ç°å¤æ‚åº¦æ¥è¿‘<strong>M+N</strong>ã€‚å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–å¥½å¤„ï¼Œä¾‹å¦‚ç”±äºå®šä¹‰æ˜ç¡®ä¸”éšæ—¶å¯ç”¨çš„ APIï¼Œå‡å°‘äº†åå¤è¯•éªŒã€‚</p>
<h2 id="åµŒå…¥å¼-hal-çš„ç”¨æˆ·"><a href="#åµŒå…¥å¼-hal-çš„ç”¨æˆ·" class="headerlink" title="åµŒå…¥å¼ hal çš„ç”¨æˆ·"></a>åµŒå…¥å¼ hal çš„ç”¨æˆ·</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒHAL æœ‰ä¸‰ä¸ªä¸»è¦ç”¨æˆ·ï¼š</p>
<h3 id="HAL-å®æ–½"><a href="#HAL-å®æ–½" class="headerlink" title="HAL å®æ–½"></a>HAL å®æ–½</h3><p>HAL å®ç°æä¾›äº†ç¡¬ä»¶å’Œ HAL ç‰¹å¾çš„ç”¨æˆ·ä¹‹é—´çš„æ¥å£ã€‚å…¸å‹çš„å®ç°åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¸€ç§æˆ–å¤šç§ç¡¬ä»¶ç‰¹å®šç±»å‹</li>
<li>åˆ›å»ºå’Œåˆå§‹åŒ–æ­¤ç±»ç±»å‹çš„å‡½æ•°ï¼Œé€šå¸¸æä¾›å„ç§é…ç½®é€‰é¡¹ï¼ˆé€Ÿåº¦ã€æ“ä½œæ¨¡å¼ã€ä½¿ç”¨å¼•è„šç­‰ï¼‰</li>
<li>ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Š<code>trait</code> <code>impl</code>çš„<strong>åµŒ-HAL</strong>æ€§çŠ¶è¯¥ç±»å‹</li>
</ul>
<p>è¿™æ ·çš„<strong>HAL å®ç°</strong>å¯ä»¥æœ‰å¤šç§é£æ ¼ï¼š</p>
<ul>
<li>é€šè¿‡åº•å±‚ç¡¬ä»¶è®¿é—®ï¼Œä¾‹å¦‚é€šè¿‡å¯„å­˜å™¨</li>
<li>é€šè¿‡æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚é€šè¿‡<code>sysfs</code>åœ¨ Linux ä¸‹ä½¿ç”¨</li>
<li>é€šè¿‡é€‚é…å™¨ï¼Œä¾‹å¦‚ç”¨äºå•å…ƒæµ‹è¯•çš„æ¨¡æ‹Ÿç±»å‹</li>
<li>é€šè¿‡ç¡¬ä»¶é€‚é…å™¨çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚ I2C å¤šè·¯å¤ç”¨å™¨æˆ– GPIO æ‰©å±•å™¨</li>
</ul>
<h3 id="é©±åŠ¨"><a href="#é©±åŠ¨" class="headerlink" title="é©±åŠ¨"></a>é©±åŠ¨</h3><p>é©±åŠ¨ç¨‹åºä¸ºå†…éƒ¨æˆ–å¤–éƒ¨ç»„ä»¶å®ç°ä¸€ç»„è‡ªå®šä¹‰åŠŸèƒ½ï¼Œè¿æ¥åˆ°å®ç°åµŒå…¥å¼ hal ç‰¹å¾çš„å¤–è®¾ã€‚æ­¤ç±»é©±åŠ¨å™¨çš„å…¸å‹ç¤ºä¾‹åŒ…æ‹¬å„ç§ä¼ æ„Ÿå™¨ï¼ˆæ¸©åº¦ã€ç£åŠ›è®¡ã€åŠ é€Ÿåº¦è®¡ã€å…‰ï¼‰ã€æ˜¾ç¤ºè®¾å¤‡ï¼ˆLED é˜µåˆ—ã€LCD æ˜¾ç¤ºå™¨ï¼‰å’Œæ‰§è¡Œå™¨ï¼ˆç”µæœºã€å‘å°„å™¨ï¼‰ã€‚</p>
<p>é©±åŠ¨ç¨‹åºå¿…é¡»ä½¿ç”¨ç±»å‹å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ï¼Œè¯¥ç±»å‹å®ä¾‹å®ç°äº†ç‰¹å®š<code>trait</code>çš„åµŒå…¥å¼ halï¼Œè¿™æ˜¯é€šè¿‡ trait bound ç¡®ä¿çš„ï¼Œå¹¶æä¾›å…¶è‡ªå·±çš„ç±»å‹å®ä¾‹å’Œä¸€ç»„å…è®¸ä¸é©±åŠ¨è®¾å¤‡äº¤äº’çš„è‡ªå®šä¹‰æ–¹æ³•ã€‚</p>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>è¯¥åº”ç”¨ç¨‹åºå°†å„ä¸ªéƒ¨åˆ†ç»‘å®šåœ¨ä¸€èµ·å¹¶ç¡®ä¿å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚åœ¨ä¸åŒç³»ç»Ÿä¹‹é—´ç§»æ¤æ—¶ï¼Œè¿™æ˜¯æœ€éœ€è¦é€‚åº”å·¥ä½œçš„éƒ¨åˆ†ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡ HAL å®ç°æ­£ç¡®åˆå§‹åŒ–çœŸå®ç¡¬ä»¶ï¼Œå¹¶ä¸”ä¸åŒç¡¬ä»¶çš„åˆå§‹åŒ–ä¸åŒï¼Œæœ‰æ—¶å·®å¼‚å¾ˆå¤§ã€‚æ­¤å¤–ï¼Œç”¨æˆ·çš„é€‰æ‹©é€šå¸¸ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºç»„ä»¶å¯ä»¥ç‰©ç†è¿æ¥åˆ°ä¸åŒçš„ç»ˆç«¯ï¼Œç¡¬ä»¶æ€»çº¿æœ‰æ—¶éœ€è¦å¤–éƒ¨ç¡¬ä»¶æ¥åŒ¹é…é…ç½®ï¼Œæˆ–è€…åœ¨ä½¿ç”¨å†…éƒ¨å¤–è®¾ï¼ˆä¾‹å¦‚å¤šä¸ªå®šæ—¶å™¨ï¼‰æ—¶éœ€è¦è¿›è¡Œä¸åŒçš„æƒè¡¡å…·æœ‰ä¸åŒçš„åŠŸèƒ½å¯ç”¨æˆ–å¤–å›´è®¾å¤‡ä¸å…¶ä»–è®¾å¤‡å†²çªï¼‰ã€‚</p>
<h1 id="Concurrencyï¼ˆå¹¶å‘ï¼‰"><a href="#Concurrencyï¼ˆå¹¶å‘ï¼‰" class="headerlink" title="Concurrencyï¼ˆå¹¶å‘ï¼‰"></a>Concurrencyï¼ˆå¹¶å‘ï¼‰</h1><p>å½“ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¯èƒ½åœ¨ä¸åŒæ—¶é—´æˆ–æ— åºæ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿå¹¶å‘ã€‚åœ¨åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸­æ–­å¤„ç†ç¨‹åºï¼Œæ¯å½“ç›¸å…³çš„ä¸­æ–­å‘ç”Ÿæ—¶è¿è¡Œï¼Œ</li>
<li>å„ç§å½¢å¼çš„å¤šçº¿ç¨‹ï¼Œæ‚¨çš„å¾®å¤„ç†å™¨å®šæœŸåœ¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´è¿›è¡Œäº¤æ¢ï¼Œ</li>
<li>åœ¨æŸäº›ç³»ç»Ÿä¸­ï¼Œå¤šæ ¸å¾®å¤„ç†å™¨ï¼Œå…¶ä¸­æ¯ä¸ªæ ¸å¯ä»¥åŒæ—¶ç‹¬ç«‹è¿è¡Œç¨‹åºçš„ä¸åŒéƒ¨åˆ†ã€‚</li>
</ul>
<p>ç”±äºå¾ˆå¤šåµŒå…¥å¼ç¨‹åºéœ€è¦å¤„ç†ä¸­æ–­ï¼Œå¹¶å‘é€šå¸¸è¿Ÿæ—©ä¼šå‡ºç°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¾ˆå¤šå¾®å¦™å’Œå›°éš¾çš„é”™è¯¯å‘ç”Ÿçš„åœ°æ–¹ã€‚å¹¸è¿çš„æ˜¯ï¼ŒRust æä¾›äº†è®¸å¤šæŠ½è±¡å’Œå®‰å…¨ä¿è¯æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™æ­£ç¡®çš„ä»£ç ã€‚</p>
<h2 id="æ— å¹¶å‘"><a href="#æ— å¹¶å‘" class="headerlink" title="æ— å¹¶å‘"></a>æ— å¹¶å‘</h2><p>åµŒå…¥å¼ç¨‹åºæœ€ç®€å•çš„å¹¶å‘æ˜¯æ— å¹¶å‘ï¼šä½ çš„è½¯ä»¶ç”±ä¸€ä¸ªä¸»å¾ªç¯ç»„æˆï¼Œå®ƒä¸€ç›´åœ¨è¿è¡Œï¼Œæ ¹æœ¬æ²¡æœ‰ä¸­æ–­ã€‚æœ‰æ—¶è¿™éå¸¸é€‚åˆæ‰‹å¤´çš„é—®é¢˜ï¼é€šå¸¸ï¼Œæ‚¨çš„å¾ªç¯ä¼šè¯»å–ä¸€äº›è¾“å…¥ã€æ‰§è¡Œä¸€äº›å¤„ç†å¹¶å†™å…¥ä¸€äº›è¾“å‡ºã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> <span class="token function">setup_peripherals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> inputs <span class="token operator">=</span> <span class="token function">read_inputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> outputs <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_outputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”±äºæ²¡æœ‰å¹¶å‘ï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒç¨‹åºå„éƒ¨åˆ†ä¹‹é—´çš„æ•°æ®å…±äº«æˆ–å¯¹å¤–å›´è®¾å¤‡çš„åŒæ­¥è®¿é—®ã€‚å¦‚æœæ‚¨å¯ä»¥é€šè¿‡è¿™ç§ç®€å•çš„æ–¹æ³•é€ƒè„±ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="å…¨å±€å¯å˜æ•°æ®"><a href="#å…¨å±€å¯å˜æ•°æ®" class="headerlink" title="å…¨å±€å¯å˜æ•°æ®"></a>å…¨å±€å¯å˜æ•°æ®</h2><p>ä¸éåµŒå…¥å¼ Rust ä¸åŒï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šåˆ›å»ºå †åˆ†é…å¹¶å°†å¯¹è¯¥æ•°æ®çš„å¼•ç”¨ä¼ é€’ç»™æ–°åˆ›å»ºçš„çº¿ç¨‹ã€‚ç›¸åï¼Œæˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½éšæ—¶è¢«è°ƒç”¨ï¼Œå¹¶ä¸”å¿…é¡»çŸ¥é“å¦‚ä½•è®¿é—®æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ä»»ä½•å…±äº«å†…å­˜ã€‚åœ¨æœ€ä½çº§åˆ«ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»<em>é™æ€åˆ†é…</em>å¯å˜å†…å­˜ï¼Œä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸»ä»£ç éƒ½å¯ä»¥å¼•ç”¨è¿™äº›å†…å­˜ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œè¿™æ ·çš„<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable" target="_blank" rel="noopener"><code>static mut</code></a>å˜é‡è¯»æˆ–å†™æ€»æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå¦‚æœä¸ç‰¹åˆ«å°å¿ƒï¼Œä½ å¯èƒ½ä¼šè§¦å‘ç«äº‰æ¡ä»¶ï¼Œä½ å¯¹å˜é‡çš„è®¿é—®åœ¨ä¸­é€”è¢«ä¸€ä¸ªä¹Ÿè®¿é—®è¯¥å˜é‡çš„ä¸­æ–­ä¸­æ–­ã€‚</p>
<p>æœ‰å…³æ­¤è¡Œä¸ºå¦‚ä½•åœ¨æ‚¨çš„ä»£ç ä¸­å¯¼è‡´ç»†å¾®é”™è¯¯çš„ç¤ºä¾‹ï¼Œè¯·è€ƒè™‘ä¸€ä¸ªåµŒå…¥å¼ç¨‹åºï¼Œè¯¥ç¨‹åºåœ¨æ¯ä¸ªä¸€ç§’å‘¨æœŸï¼ˆé¢‘ç‡è®¡æ•°å™¨ï¼‰è®¡ç®—æŸäº›è¾“å…¥ä¿¡å·çš„ä¸Šå‡æ²¿ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DANGER - Not actually safe! Could cause data races.</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¯ä¸€ç§’ï¼Œå®šæ—¶å™¨ä¸­æ–­éƒ½ä¼šå°†è®¡æ•°å™¨è®¾ç½®å› 0ã€‚åŒæ—¶ï¼Œä¸»å¾ªç¯ä¸æ–­æµ‹é‡ä¿¡å·ï¼Œå¹¶åœ¨çœ‹åˆ°ä»ä½åˆ°é«˜çš„å˜åŒ–æ—¶é€’å¢è®¡æ•°å™¨ã€‚æˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨<code>unsafe</code>è®¿é—® <code>COUNTER</code>ï¼Œå› ä¸ºå®ƒæ˜¯<code>static mut</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å‘ç¼–è¯‘å™¨ä¿è¯æˆ‘ä»¬ä¸ä¼šå¯¼è‡´ä»»ä½•æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä½ èƒ½å‘ç°æ¯”èµ›æ¡ä»¶å—ï¼Ÿä¸Šçš„å¢é‡<code>COUNTER</code>æ˜¯<em>ä¸èƒ½</em>ä¿è¯æ˜¯åŸå­-äº‹å®ä¸Šï¼Œåœ¨å¤§å¤šæ•°åµŒå…¥å¼å¹³å°ï¼Œå®ƒå°†è¢«åˆ†æˆäº†è´Ÿè½½ï¼Œåˆ™å¢é‡ï¼Œç„¶åå•†åº—ã€‚å¦‚æœä¸­æ–­åœ¨åŠ è½½ä¹‹åä½†åœ¨å­˜å‚¨ä¹‹å‰è§¦å‘ï¼Œåˆ™åœ¨ä¸­æ–­è¿”å›åå°†å¿½ç•¥é‡ç½®å› 0 - æˆ‘ä»¬å°†åœ¨è¯¥æœŸé—´è®¡ç®—ä¸¤å€çš„è½¬æ¢æ¬¡æ•°ã€‚</p>
<h2 id="ä¸´ç•ŒåŒº"><a href="#ä¸´ç•ŒåŒº" class="headerlink" title="ä¸´ç•ŒåŒº"></a>ä¸´ç•ŒåŒº</h2><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®ç«äº‰åšäº›ä»€ä¹ˆå‘¢ï¼Ÿä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨<em>ä¸´ç•ŒåŒº</em>ï¼Œå³ç¦ç”¨ä¸­æ–­çš„ä¸Šä¸‹æ–‡ã€‚é€šè¿‡å°†<code>COUNTER</code>inçš„è®¿é—®åŒ…è£… <code>main</code>åœ¨ä¸´ç•ŒåŒºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å®šæ—¶å™¨ä¸­æ–­åœ¨æˆ‘ä»¬å®Œæˆé€’å¢ä¹‹å‰ä¸ä¼šè§¦å‘<code>COUNTER</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// New critical section ensures synchronised access to COUNTER</span>
            cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>cortex_m::interrupt::free</code>ï¼Œä½†å…¶ä»–å¹³å°å°†å…·æœ‰ç±»ä¼¼çš„æœºåˆ¶æ¥æ‰§è¡Œä¸´ç•ŒåŒºä¸­çš„ä»£ç ã€‚è¿™ä¹Ÿä¸ç¦ç”¨ä¸­æ–­ã€è¿è¡Œä¸€äº›ä»£ç ï¼Œç„¶åé‡æ–°å¯ç”¨ä¸­æ–­ç›¸åŒã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­æ”¾ç½®ä¸´ç•ŒåŒºï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>å†™å…¥ 0<code>COUNTER</code>ä¸ä¼šå—åˆ°æ¯”èµ›çš„å½±å“ï¼Œå› ä¸ºæˆ‘ä»¬ä¸é˜…è¯»å®ƒ</li>
<li><code>main</code>æ— è®ºå¦‚ä½•å®ƒæ°¸è¿œä¸ä¼šè¢«çº¿ç¨‹ä¸­æ–­</li>
</ul>
<p>å¦‚æœ<code>COUNTER</code>è¢«å¤šä¸ªå¯èƒ½äº’ç›¸<em>æŠ¢å çš„</em>ä¸­æ–­å¤„ç†ç¨‹åºå…±äº«ï¼Œé‚£ä¹ˆæ¯ä¸ªä¸­æ–­å¤„ç†ç¨‹åºä¹Ÿ å¯èƒ½éœ€è¦ä¸€ä¸ªä¸´ç•ŒåŒºã€‚</p>
<p>è¿™è§£å†³äº†æˆ‘ä»¬çœ¼å‰çš„é—®é¢˜ï¼Œä½†æˆ‘ä»¬ä»ç„¶è¦ç¼–å†™è®¸å¤šéœ€è¦ä»”ç»†æ¨ç†çš„ä¸å®‰å…¨ä»£ç ï¼Œè€Œä¸”æˆ‘ä»¬å¯èƒ½ä¼šä¸å¿…è¦åœ°ä½¿ç”¨ä¸´ç•ŒåŒºã€‚ç”±äºæ¯ä¸ªä¸´ç•ŒåŒºéƒ½ä¼šä¸´æ—¶æš‚åœä¸­æ–­å¤„ç†ï¼Œå› æ­¤ä¼šäº§ç”Ÿä¸€äº›é¢å¤–ä»£ç å¤§å°ä»¥åŠæ›´é«˜çš„ä¸­æ–­å»¶è¿Ÿå’ŒæŠ–åŠ¨çš„ç›¸å…³æˆæœ¬ï¼ˆå¤„ç†ä¸­æ–­å¯èƒ½éœ€è¦æ›´é•¿çš„æ—¶é—´ï¼Œå¹¶ä¸”å¤„ç†å®ƒä»¬ä¹‹å‰çš„æ—¶é—´å°†æ›´åŠ å¯å˜ï¼‰ã€‚è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªé—®é¢˜å–å†³äºæ‚¨çš„ç³»ç»Ÿï¼Œä½†æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…å®ƒã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ä¸´ç•ŒåŒºä¿è¯ä¸ä¼šè§¦å‘ä»»ä½•ä¸­æ–­ï¼Œä½†å®ƒä¸æä¾›å¤šæ ¸ç³»ç»Ÿä¸Šçš„æ’ä»–æ€§ä¿è¯ï¼å³ä½¿æ²¡æœ‰ä¸­æ–­ï¼Œå¦ä¸€ä¸ªå†…æ ¸ä¹Ÿå¯ä»¥æ„‰å¿«åœ°è®¿é—®ä¸æ‚¨çš„å†…æ ¸ç›¸åŒçš„å†…å­˜ã€‚å¦‚æœæ‚¨ä½¿ç”¨å¤šæ ¸ï¼Œæ‚¨å°†éœ€è¦æ›´å¼ºçš„åŒæ­¥åŸè¯­ã€‚</p>
<h2 id="åŸå­è®¿é—®"><a href="#åŸå­è®¿é—®" class="headerlink" title="åŸå­è®¿é—®"></a>åŸå­è®¿é—®</h2><p>åœ¨æŸäº›å¹³å°ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„åŸå­æŒ‡ä»¤ï¼Œä¸ºè¯»å–-ä¿®æ”¹-å†™å…¥æ“ä½œæä¾›ä¿è¯ã€‚ä¸“é—¨é’ˆå¯¹ Cortex-Mï¼š<code>thumbv6</code> ï¼ˆCortex-M0ã€Cortex-M0+ï¼‰ä»…æä¾›åŸå­åŠ è½½å’Œå­˜å‚¨æŒ‡ä»¤ï¼Œè€Œ<code>thumbv7</code>ï¼ˆCortex-M3 åŠä»¥ä¸Šï¼‰æä¾›å®Œæ•´çš„æ¯”è¾ƒå’Œäº¤æ¢ï¼ˆCASï¼‰æŒ‡ä»¤ã€‚è¿™äº› CAS æŒ‡ä»¤æä¾›äº†å¯¹æ‰€æœ‰ä¸­æ–­çš„ä¸¥å‰ç¦ç”¨çš„æ›¿ä»£æ–¹æ¡ˆï¼šæˆ‘ä»¬å¯ä»¥å°è¯•é€’å¢ï¼Œå®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šæˆåŠŸï¼Œä½†å¦‚æœè¢«ä¸­æ–­ï¼Œå®ƒå°†è‡ªåŠ¨é‡è¯•æ•´ä¸ªé€’å¢æ“ä½œã€‚å³ä½¿è·¨å¤šä¸ªå†…æ ¸ï¼Œè¿™äº›åŸå­æ“ä½œä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AtomicUsize<span class="token punctuation">,</span> Ordering<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> AtomicUsize <span class="token operator">=</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Use `fetch_add` to atomically add 1 to COUNTER</span>
            COUNTER<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use `store` to write 0 directly to COUNTER</span>
    COUNTER<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªæ—¶é—´<code>COUNTER</code>æ˜¯ä¸€ä¸ªå®‰å…¨<code>static</code>å˜é‡ã€‚ç”±äºå¯ä»¥ä»ä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸»çº¿ç¨‹å®‰å…¨åœ°ä¿®æ”¹<code>AtomicUsize</code> ç±»å‹ï¼Œ<code>COUNTER</code>è€Œæ— éœ€ç¦ç”¨ä¸­æ–­ã€‚å¦‚æœå¯èƒ½ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆ - ä½†æ‚¨çš„å¹³å°å¯èƒ½ä¸æ”¯æŒå®ƒã€‚</p>
<p>æ³¨æ„<a href="https://doc.rust-lang.org/core/sync/atomic/enum.Ordering.html" target="_blank" rel="noopener"><code>Ordering</code></a>ï¼šè¿™ä¼šå½±å“ç¼–è¯‘å™¨å’Œç¡¬ä»¶å¯¹æŒ‡ä»¤é‡æ–°æ’åºçš„æ–¹å¼ï¼Œä¹Ÿä¼šå¯¹ç¼“å­˜å¯è§æ€§äº§ç”Ÿå½±å“ã€‚å‡è®¾ç›®æ ‡æ˜¯å•æ ¸å¹³å°<code>Relaxed</code>å°±è¶³å¤Ÿäº†ï¼Œå¹¶ä¸”åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹æ˜¯æœ€æœ‰æ•ˆçš„é€‰æ‹©ã€‚æ›´ä¸¥æ ¼çš„æ’åºå°†å¯¼è‡´ç¼–è¯‘å™¨å›´ç»•åŸå­æ“ä½œå‘å‡ºå†…å­˜å±éšœï¼›æ ¹æ®æ‚¨ä½¿ç”¨åŸå­çš„å†…å®¹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¹Ÿå¯èƒ½ä¸éœ€è¦è¿™ä¸ªï¼åŸå­æ¨¡å‹çš„ç²¾ç¡®ç»†èŠ‚å¾ˆå¤æ‚ï¼Œæœ€å¥½åœ¨åˆ«å¤„è¿›è¡Œæè¿°ã€‚</p>
<p>æœ‰å…³åŸå­å’Œæ’åºçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://doc.rust-lang.org/nomicon/atomics.html" target="_blank" rel="noopener">nomicon</a>ã€‚</p>
<h2 id="æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥"><a href="#æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥" class="headerlink" title="æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥"></a>æŠ½è±¡ã€å‘é€å’ŒåŒæ­¥</h2><p>ä¸Šè¿°è§£å†³æ–¹æ¡ˆéƒ½ä¸æ˜¯ç‰¹åˆ«ä»¤äººæ»¡æ„ã€‚å®ƒä»¬éœ€è¦<code>unsafe</code> å¿…é¡»éå¸¸ä»”ç»†åœ°æ£€æŸ¥å¹¶ä¸”ä¸ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„ç§¯æœ¨ã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥åœ¨ Rust ä¸­åšå¾—æ›´å¥½ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„è®¡æ•°å™¨æŠ½è±¡æˆä¸€ä¸ªå®‰å…¨çš„æ¥å£ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°åœ¨æˆ‘ä»¬ä»£ç çš„ä»»ä½•å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸´ç•ŒåŒºè®¡æ•°å™¨ï¼Œä½†ä½ å¯ä»¥ç”¨åŸå­åšä¸€äº›éå¸¸ç›¸ä¼¼çš„äº‹æƒ…ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>UnsafeCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Our counter is just a wrapper around UnsafeCell&lt;u32>, which is the heart</span>
<span class="token comment" spellcheck="true">// of interior mutability in Rust. By using interior mutability, we can have</span>
<span class="token comment" spellcheck="true">// COUNTER be `static` instead of `static mut`, but still able to mutate</span>
<span class="token comment" spellcheck="true">// its counter value.</span>
<span class="token keyword">struct</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CS_COUNTER_INIT<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> CSCounter <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// By requiring a CriticalSection be passed in, we know we must</span>
        <span class="token comment" spellcheck="true">// be operating inside a CriticalSection, and so can confidently</span>
        <span class="token comment" spellcheck="true">// use this unsafe block (required to call UnsafeCell::get).</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Required to allow static CSCounter. See explanation below.</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> CSCounter <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// COUNTER is no longer `mut` as it uses interior mutability;</span>
<span class="token comment" spellcheck="true">// therefore it also no longer requires unsafe blocks to access.</span>
<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> CS_COUNTER_INIT<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No unsafe here!</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We do need to enter a critical section here just to obtain a valid</span>
    <span class="token comment" spellcheck="true">// cs token, even though we know no other interrupt could pre-empt</span>
    <span class="token comment" spellcheck="true">// this one.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We could use unsafe code to generate a fake CriticalSection if we</span>
    <span class="token comment" spellcheck="true">// really wanted to, avoiding the overhead:</span>
    <span class="token comment" spellcheck="true">// let cs = unsafe { interrupt::CriticalSection::new() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å·²ç»å°†<code>unsafe</code>ä»£ç ç§»åˆ°ç²¾å¿ƒè§„åˆ’çš„æŠ½è±¡å†…éƒ¨ï¼Œç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç ä¸åŒ…å«ä»»ä½•<code>unsafe</code>å—ã€‚</p>
<p>è¿™ç§è®¾è®¡è¦æ±‚åº”ç”¨ç¨‹åºä¼ å…¥ä¸€ä¸ª<code>CriticalSection</code>ä»¤ç‰Œï¼šè¿™äº›ä»¤ç‰Œä»…ç”± å®‰å…¨ç”Ÿæˆ<code>interrupt::free</code>ï¼Œå› æ­¤é€šè¿‡è¦æ±‚ä¼ å…¥ä¸€ä¸ªä»¤ç‰Œï¼Œæˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬åœ¨ä¸´ç•ŒåŒºä¸­æ“ä½œï¼Œè€Œä¸å¿…è‡ªå·±å®é™…è¿›è¡Œé”å®šã€‚è¿™ç§ä¿è¯æ˜¯ç”±ç¼–è¯‘å™¨é™æ€æä¾›çš„ï¼šä¸ä¼šæœ‰ä»»ä½•ä¸<code>cs</code>. å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªè®¡æ•°å™¨ï¼Œå®ƒä»¬éƒ½å¯ä»¥è¢«èµ‹äºˆç›¸åŒçš„<code>cs</code>ï¼Œè€Œä¸éœ€è¦å¤šä¸ªåµŒå¥—çš„ä¸´ç•ŒåŒºã€‚</p>
<p>è¿™ä¹Ÿå¸¦æ¥äº† Rust å¹¶å‘çš„ä¸€ä¸ªé‡è¦ä¸»é¢˜ï¼š <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html" target="_blank" rel="noopener"><code>Send</code>å’Œ<code>Sync</code></a>ç‰¹å¾ã€‚æ€»ç»“ä¸€ä¸‹ Rust ä¹¦ï¼Œå½“å®ƒå¯ä»¥å®‰å…¨åœ°ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œç±»å‹æ˜¯ Sendï¼Œè€Œå½“å®ƒå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨å…±äº«æ—¶ï¼Œå®ƒæ˜¯ Syncã€‚åœ¨åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºä¸­æ–­åœ¨ä¸åº”ç”¨ç¨‹åºä»£ç ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå› æ­¤è¢«ä¸­æ–­å’Œä¸»ä»£ç è®¿é—®çš„å˜é‡å¿…é¡»æ˜¯åŒæ­¥çš„ã€‚</p>
<p>å¯¹äº Rust ä¸­çš„å¤§å¤šæ•°ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ‚¨æ´¾ç”Ÿè¿™ä¸¤ä¸ªç‰¹å¾ã€‚ä½†æ˜¯ï¼Œå› ä¸º<code>CSCounter</code>åŒ…å«ä¸€ä¸ª<a href="https://doc.rust-lang.org/core/cell/struct.UnsafeCell.html" target="_blank" rel="noopener"><code>UnsafeCell</code></a>ï¼Œå®ƒä¸æ˜¯åŒæ­¥çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ä½¿<code>static CSCounter</code>:<code>static</code> å˜é‡<em>å¿…é¡»</em>æ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ã€‚</p>
<p>ä¸ºäº†å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬å·²ç»æ³¨æ„åˆ°<code>CSCounter</code>åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å®é™…ä¸Šæ˜¯å®‰å…¨çš„ï¼Œæˆ‘ä»¬æ˜¾å¼åœ°å®ç°äº† Sync traitã€‚ä¸ä¹‹å‰ä½¿ç”¨çš„ä¸´ç•ŒåŒºä¸€æ ·ï¼Œè¿™ä»…åœ¨å•æ ¸å¹³å°ä¸Šæ˜¯å®‰å…¨çš„ï¼šå¯¹äºå¤šæ ¸ï¼Œæ‚¨éœ€è¦ä»˜å‡ºæ›´å¤§çš„åŠªåŠ›æ¥ç¡®ä¿å®‰å…¨ã€‚</p>
<h2 id="äº’æ–¥ä½“"><a href="#äº’æ–¥ä½“" class="headerlink" title="äº’æ–¥ä½“"></a>äº’æ–¥ä½“</h2><p>æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç‰¹å®šäºæˆ‘ä»¬çš„è®¡æ•°å™¨é—®é¢˜çš„æœ‰ç”¨æŠ½è±¡ï¼Œä½†æ˜¯æœ‰è®¸å¤šç”¨äºå¹¶å‘çš„é€šç”¨æŠ½è±¡ã€‚</p>
<p>ä¸€ä¸ªè¿™æ ·çš„<em>åŒæ­¥åŸè¯­</em>æ˜¯äº’æ–¥ï¼Œäº’æ–¥çš„ç¼©å†™ã€‚è¿™äº›æ„é€ ç¡®ä¿å¯¹å˜é‡çš„ç‹¬å è®¿é—®ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„è®¡æ•°å™¨ã€‚çº¿ç¨‹å¯ä»¥å°è¯•<em>é”å®š</em>ï¼ˆæˆ–<em>è·å–</em>ï¼‰äº’æ–¥é”ï¼Œå¹¶ä¸”è¦ä¹ˆç«‹å³æˆåŠŸï¼Œè¦ä¹ˆé˜»å¡ç­‰å¾…è·å–é”ï¼Œæˆ–è€…è¿”å›æ— æ³•é”å®šäº’æ–¥é”çš„é”™è¯¯ã€‚å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå®ƒè¢«æˆäºˆè®¿é—®å—ä¿æŠ¤æ•°æ®çš„æƒé™ã€‚å½“çº¿ç¨‹å®Œæˆæ—¶ï¼Œå®ƒ<em>è§£é”</em>ï¼ˆæˆ– <em>é‡Šæ”¾</em>ï¼‰äº’æ–¥é”ï¼Œå…è®¸å¦ä¸€ä¸ªçº¿ç¨‹é”å®šå®ƒã€‚åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨<a href="https://doc.rust-lang.org/core/ops/trait.Drop.html" target="_blank" rel="noopener"><code>Drop</code></a>trait æ¥å®ç°è§£é”ï¼Œä»¥ç¡®ä¿å½“äº’æ–¥é‡è¶…å‡ºèŒƒå›´æ—¶å®ƒæ€»æ˜¯è¢«é‡Šæ”¾ã€‚</p>
<p>å°†äº’æ–¥é”ä¸ä¸­æ–­å¤„ç†ç¨‹åºä¸€èµ·ä½¿ç”¨å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼šä¸­æ–­å¤„ç†ç¨‹åºé˜»å¡é€šå¸¸æ˜¯ä¸å¯æ¥å—çš„ï¼Œå¹¶ä¸”é˜»å¡ç­‰å¾…ä¸»çº¿ç¨‹é‡Šæ”¾é”å°†æ˜¯ç‰¹åˆ«ç¾éš¾æ€§çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¼š<em>æ­»é”</em>ï¼ˆä¸»çº¿ç¨‹ï¼‰çº¿ç¨‹æ°¸è¿œä¸ä¼šé‡Šæ”¾é”ï¼Œå› ä¸ºæ‰§è¡Œåœç•™åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­ï¼‰ã€‚æ­»é”ä¸è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼šå³ä½¿åœ¨å®‰å…¨çš„ Rust ä¸­ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚</p>
<p>ä¸ºäº†å®Œå…¨é¿å…è¿™ç§è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªéœ€è¦é”å®šä¸´ç•ŒåŒºçš„äº’æ–¥é”ï¼Œå°±åƒæˆ‘ä»¬çš„åä¾‹ä¸€æ ·ã€‚åªè¦ä¸´ç•ŒåŒºå¿…é¡»ä¸é”ä¸€æ ·é•¿ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿æˆ‘ä»¬å¯ä»¥ç‹¬å è®¿é—®è¢«åŒ…è£…çš„å˜é‡ï¼Œç”šè‡³ä¸éœ€è¦è·Ÿè¸ªäº’æ–¥é”çš„é”å®š/è§£é”çŠ¶æ€ã€‚</p>
<p>è¿™å®é™…ä¸Šæ˜¯åœ¨<code>cortex_m</code>æ¿æ¡ç®±ä¸­ä¸ºæˆ‘ä»¬å®Œæˆçš„ï¼æˆ‘ä»¬å¯ä»¥ç”¨å®ƒå†™æˆ‘ä»¬çš„è®¡æ•°å™¨ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>Cell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>Mutex<span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>Cell<span class="token operator">&lt;</span>u32<span class="token operator">>></span> <span class="token operator">=</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Cell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span>
                COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We still need to enter a critical section here to satisfy the Mutex.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç°åœ¨ä½¿ç”¨<a href="https://doc.rust-lang.org/core/cell/struct.Cell.html" target="_blank" rel="noopener"><code>Cell</code></a>ï¼Œå®ƒå’Œå®ƒçš„å…„å¼Ÿä¸€èµ·<code>RefCell</code>è¢«ç”¨æ¥æä¾›å®‰å…¨çš„å†…éƒ¨å¯å˜æ€§ã€‚æˆ‘ä»¬å·²ç»çœ‹åˆ°<code>UnsafeCell</code>äº† Rust å†…éƒ¨å¯å˜æ€§çš„åº•å±‚ï¼šå®ƒå…è®¸æ‚¨è·å¾—å¯¹å…¶å€¼çš„å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œä½†åªèƒ½ä½¿ç”¨ä¸å®‰å…¨çš„ä»£ç ã€‚A<code>Cell</code> ç±»ä¼¼äº an<code>UnsafeCell</code>ä½†å®ƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ¥å£ï¼šå®ƒåªå…è®¸è·å–å½“å‰å€¼çš„å‰¯æœ¬æˆ–æ›¿æ¢å®ƒï¼Œè€Œä¸æ˜¯è·å–å¼•ç”¨ï¼Œå¹¶ä¸”ç”±äºå®ƒä¸æ˜¯ Syncï¼Œå› æ­¤ä¸èƒ½åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚è¿™äº›çº¦æŸæ„å‘³ç€å®ƒå¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨<code>static</code>å˜é‡ä¸­ä½¿ç”¨å®ƒï¼Œ å› ä¸º<code>static</code>å¿…é¡»æ˜¯ Syncã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆä¸Šé¢çš„ä¾‹å­æœ‰æ•ˆå‘¢ï¼Ÿ<code>Mutex&lt;T&gt;</code>ä¸ºä»»ä½•<code>T</code>å‘é€çš„å®ç°åŒæ­¥ - ä¾‹å¦‚<code>Cell</code>. å®ƒå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºå®ƒä»…åœ¨å…³é”®éƒ¨åˆ†æœŸé—´æ‰å…è®¸è®¿é—®å…¶å†…å®¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå®Œå…¨æ²¡æœ‰ä¸å®‰å…¨ä»£ç çš„å®‰å…¨è®¡æ•°å™¨ï¼</p>
<p>è¿™å¯¹äºåƒ<code>u32</code>æˆ‘ä»¬çš„è®¡æ•°å™¨è¿™æ ·çš„ç®€å•ç±»å‹éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å¯¹äºä¸æ˜¯ Copy çš„æ›´å¤æ‚çš„ç±»å‹å‘¢ï¼ŸåµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ä¸€ä¸ªæå…¶å¸¸è§çš„ç¤ºä¾‹æ˜¯å¤–è®¾ç»“æ„ï¼Œå®ƒé€šå¸¸ä¸æ˜¯ Copyã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è½¬å‘<code>RefCell</code>.</p>
<h2 id="å…±äº«å¤–è®¾"><a href="#å…±äº«å¤–è®¾" class="headerlink" title="å…±äº«å¤–è®¾"></a>å…±äº«å¤–è®¾</h2><p>ä½¿ç”¨<code>svd2rust</code>å’Œç±»ä¼¼æŠ½è±¡ç”Ÿæˆçš„è®¾å¤‡ç®±é€šè¿‡å¼ºåˆ¶ä¸€æ¬¡åªèƒ½å­˜åœ¨ä¸€ä¸ªå¤–å›´ç»“æ„å®ä¾‹æ¥æä¾›å¯¹å¤–å›´è®¾å¤‡çš„å®‰å…¨è®¿é—®ã€‚è¿™ç¡®ä¿äº†å®‰å…¨æ€§ï¼Œä½†ä½¿å¾—ä»ä¸»çº¿ç¨‹å’Œä¸­æ–­å¤„ç†ç¨‹åºè®¿é—®å¤–è®¾å˜å¾—å›°éš¾ã€‚</p>
<p>ä¸ºäº†å®‰å…¨åœ°å…±äº«å¤–å›´è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Mutex</code>æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨<a href="https://doc.rust-lang.org/core/cell/struct.RefCell.html" target="_blank" rel="noopener"><code>RefCell</code></a>ï¼Œå®ƒä½¿ç”¨è¿è¡Œæ—¶æ£€æŸ¥æ¥ç¡®ä¿ä¸€æ¬¡åªç»™å‡ºä¸€ä¸ªå¯¹å¤–å›´è®¾å¤‡çš„å¼•ç”¨ã€‚è¿™æ¯”æ™®é€šçš„æœ‰æ›´å¤šçš„å¼€é”€<code>Cell</code>ï¼Œä½†ç”±äºæˆ‘ä»¬æä¾›å¼•ç”¨è€Œä¸æ˜¯å‰¯æœ¬ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿ä¸€æ¬¡åªå­˜åœ¨ä¸€ä¸ªã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¿˜å¿…é¡»è€ƒè™‘åœ¨ä¸»ä»£ç ä¸­åˆå§‹åŒ–åä»¥æŸç§æ–¹å¼å°†å¤–å›´è®¾å¤‡ç§»åŠ¨åˆ°å…±äº«å˜é‡ä¸­ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Option</code>ç±»å‹ï¼Œåˆå§‹åŒ–<code>None</code>å¹¶ç¨åè®¾ç½®ä¸ºå¤–å›´è®¾å¤‡çš„å®ä¾‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Obtain the peripheral singletons and configure it.</span>
    <span class="token comment" spellcheck="true">// This example is from an svd2rust-generated crate, but</span>
    <span class="token comment" spellcheck="true">// most embedded device crates will be similar.</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> <span class="token operator">&amp;</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it sets PA0 to an input and PA1 to an output.</span>
    <span class="token function">configure_gpio</span><span class="token punctuation">(</span>gpioa<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Store the GPIOA in the mutex, moving it.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We can no longer use `gpioa` or `dp.GPIOA`, and instead have to</span>
    <span class="token comment" spellcheck="true">// access it via the mutex.</span>

    <span class="token comment" spellcheck="true">// Be careful to enable the interrupt only after setting MY_GPIO:</span>
    <span class="token comment" spellcheck="true">// otherwise the interrupt might fire while it still contains None,</span>
    <span class="token comment" spellcheck="true">// and as-written (with `unwrap()`), it would panic.</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We'll now read state as a digital input, via the mutex</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>idr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">idr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Set PA1 high if we've seen a rising edge on PA0.</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This time in the interrupt we'll just clear PA0.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We can use `unwrap()` because we know the interrupt wasn't enabled</span>
        <span class="token comment" spellcheck="true">// until after MY_GPIO was set; otherwise we should handle the potential</span>
        <span class="token comment" spellcheck="true">// for a None value.</span>
        <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦è€ƒè™‘çš„å†…å®¹å¾ˆå¤šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ†è§£é‡è¦çš„å‡ è¡Œã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬çš„å…±äº«å˜é‡ç°åœ¨æ˜¯ a<code>Mutex</code>å‘¨å›´çš„ a <code>RefCell</code>ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <code>Option</code>ã€‚åœ¨<code>Mutex</code>ç¡®ä¿æˆ‘ä»¬åªæœ‰ä¸€ä¸ªä¸´ç•ŒåŒºä¸­è®¿é—®ï¼Œå¹¶å› æ­¤ä½¿å˜é‡åŒæ­¥ï¼Œå³ä½¿ä¸€ä¸ªæ™®é€šçš„<code>RefCell</code>ä¸ä¼šåŒæ­¥ã€‚è¯¥<code>RefCell</code>ç»™æˆ‘ä»¬å‚è€ƒï¼Œæˆ‘ä»¬å°†éœ€è¦ä½¿ç”¨æˆ‘ä»¬å†…éƒ¨çš„å¯å˜æ€§<code>GPIOA</code>ã€‚è¯¥<code>Option</code>è®©æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªå˜é‡ä¸ºç©ºçš„ä¸œè¥¿ï¼Œåæ¥æ‰çœŸæ­£ç§»åŠ¨çš„å˜é‡ï¼Œæˆ‘ä»¬ä¸èƒ½é™æ€åœ°è®¿é—®å¤–è®¾çš„ç‹¬ç”Ÿå­ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥è¿™æ˜¯å¿…éœ€çš„ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åœ¨ä¸´ç•ŒåŒºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>borrow()</code>äº’æ–¥é”ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†å¯¹<code>RefCell</code>. ç„¶åæˆ‘ä»¬è°ƒç”¨<code>replace()</code>å°†æˆ‘ä»¬çš„æ–°å€¼ç§»åŠ¨åˆ°<code>RefCell</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬<code>MY_GPIO</code>ä»¥å®‰å…¨å’Œå¹¶å‘çš„æ–¹å¼ä½¿ç”¨ã€‚ä¸´ç•ŒåŒºåƒå¾€å¸¸ä¸€æ ·é˜»æ­¢ä¸­æ–­è§¦å‘ï¼Œå¹¶è®©æˆ‘ä»¬å€Ÿç”¨äº’æ–¥é”ã€‚åœ¨ <code>RefCell</code>éšåç»™äº†æˆ‘ä»¬ä¸€ä¸ª<code>&amp;Option&lt;GPIOA&gt;</code>ï¼Œå¹¶è·Ÿè¸ªå®ƒä¿æŒå¤šä¹…å€Ÿæ¥çš„-ä¸€æ—¦è¿›å…¥å‚è€ƒèŒƒå›´çš„é‚£æ ·ï¼Œ<code>RefCell</code>å°†è¢«æ›´æ–°ï¼Œä»¥è¡¨æ˜å®ƒä¸å†æ˜¯å€Ÿæ¥çš„ã€‚</p>
<p>ç”±äºæˆ‘ä»¬æ— æ³•å°†<code>GPIOA</code>ç§»å‡º<code>&amp;Option</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸º<code>&amp;Option&lt;&amp;GPIOA&gt;</code>with <code>as_ref()</code>ï¼Œæˆ‘ä»¬æœ€ç»ˆ<code>unwrap()</code>å¯ä»¥è·å–<code>&amp;GPIOA</code>å®ƒè®©æˆ‘ä»¬ä¿®æ”¹å¤–å›´è®¾å¤‡ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…±äº«èµ„æºçš„å¯å˜å¼•ç”¨<code>borrow_mut</code>ï¼Œ<code>deref_mut</code> åˆ™åº”ä½¿ç”¨andä»£æ›¿ã€‚ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ä½¿ç”¨ TIM2 å®šæ—¶å™¨çš„ç¤ºä¾‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>DerefMut<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">:</span><span class="token punctuation">:</span>wfi<span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> G_TIM<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>Timer<span class="token operator">&lt;</span>stm32<span class="token punctuation">:</span><span class="token punctuation">:</span>TIM2<span class="token operator">>></span><span class="token operator">>></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cp <span class="token operator">=</span> cm<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of timer configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it configures the TIM2 timer, its NVIC interrupt,</span>
    <span class="token comment" spellcheck="true">// and finally starts the timer.</span>
    <span class="token keyword">let</span> tim <span class="token operator">=</span> <span class="token function">configure_timer_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> cp<span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>tim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">wfi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> tim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>  G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tim<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å“‡ï¼è¿™æ˜¯å®‰å…¨çš„ï¼Œä½†ä¹Ÿæœ‰ç‚¹ç¬¨æ‹™ã€‚æˆ‘ä»¬è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ</p>
<h2 id="ä¿¡æ¯ä¸­å¿ƒ"><a href="#ä¿¡æ¯ä¸­å¿ƒ" class="headerlink" title="ä¿¡æ¯ä¸­å¿ƒ"></a>ä¿¡æ¯ä¸­å¿ƒ</h2><p>ä¸€ç§æ›¿ä»£æ–¹æ¡ˆæ˜¯<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener">RTIC æ¡†æ¶</a>ï¼Œå®ƒæ˜¯å®æ—¶ä¸­æ–­é©±åŠ¨å¹¶å‘çš„ç¼©å†™ã€‚å®ƒå¼ºåˆ¶æ‰§è¡Œé™æ€ä¼˜å…ˆçº§å¹¶è·Ÿè¸ªå¯¹<code>static mut</code>å˜é‡ï¼ˆâ€œèµ„æºâ€ï¼‰çš„è®¿é—®ï¼Œä»¥é™æ€åœ°ç¡®ä¿å§‹ç»ˆå®‰å…¨åœ°è®¿é—®å…±äº«èµ„æºï¼Œè€Œæ— éœ€æ€»æ˜¯è¿›å…¥ä¸´ç•ŒåŒºå’Œä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼ˆå¦‚ ä¸­æ‰€ç¤º<code>RefCell</code>ï¼‰çš„å¼€é”€ã€‚è¿™æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œä¾‹å¦‚ä¿è¯æ²¡æœ‰æ­»é”å¹¶æä¾›æä½çš„æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚</p>
<p>è¯¥æ¡†æ¶è¿˜åŒ…æ‹¬å…¶ä»–åŠŸèƒ½ï¼Œå¦‚æ¶ˆæ¯ä¼ é€’ï¼Œè¿™å‡å°‘äº†å¯¹æ˜¾å¼å…±äº«çŠ¶æ€çš„éœ€æ±‚ï¼Œä»¥åŠå®‰æ’ä»»åŠ¡åœ¨ç»™å®šæ—¶é—´è¿è¡Œçš„èƒ½åŠ›ï¼Œå¯ç”¨äºå®ç°å‘¨æœŸæ€§ä»»åŠ¡ã€‚æŸ¥çœ‹<a href="https://rtic.rs/" target="_blank" rel="noopener">æ–‡æ¡£</a>ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼</p>
<h2 id="å®æ—¶æ“ä½œç³»ç»Ÿ"><a href="#å®æ—¶æ“ä½œç³»ç»Ÿ" class="headerlink" title="å®æ—¶æ“ä½œç³»ç»Ÿ"></a>å®æ—¶æ“ä½œç³»ç»Ÿ</h2><p>åµŒå…¥å¼å¹¶å‘çš„å¦ä¸€ä¸ªå¸¸è§æ¨¡å‹æ˜¯å®æ—¶æ“ä½œç³»ç»Ÿ (RTOS)ã€‚è™½ç„¶ç›®å‰åœ¨ Rust ä¸­çš„æ¢ç´¢è¾ƒå°‘ï¼Œä½†å®ƒä»¬å¹¿æ³›ç”¨äºä¼ ç»Ÿçš„åµŒå…¥å¼å¼€å‘ã€‚å¼€æºç¤ºä¾‹åŒ…æ‹¬<a href="https://freertos.org/" target="_blank" rel="noopener">FreeRTOS</a>å’Œ <a href="http://chibios.org/" target="_blank" rel="noopener">ChibiOS</a>ã€‚è¿™äº› RTOS æ”¯æŒè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹ï¼ŒCPU åœ¨è¿™äº›çº¿ç¨‹ä¹‹é—´è¿›è¡Œäº¤æ¢ï¼Œå½“çº¿ç¨‹è®©å‡ºæ§åˆ¶æƒï¼ˆç§°ä¸ºåä½œå¤šä»»åŠ¡å¤„ç†ï¼‰æˆ–åŸºäºå¸¸è§„è®¡æ—¶å™¨æˆ–ä¸­æ–­ï¼ˆæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼‰æ—¶ã€‚RTOS é€šå¸¸æä¾›äº’æ–¥é”å’Œå…¶ä»–åŒæ­¥åŸè¯­ï¼Œå¹¶ä¸”ç»å¸¸ä¸ç¡¬ä»¶åŠŸèƒ½ï¼ˆä¾‹å¦‚ DMA å¼•æ“ï¼‰è¿›è¡Œäº’æ“ä½œã€‚</p>
<p>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¯ä»¥æŒ‡å‡ºçš„ Rust RTOS ç¤ºä¾‹å¹¶ä¸å¤šï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é¢†åŸŸï¼Œå› æ­¤è¯·å…³æ³¨æ­¤ç©ºé—´ï¼</p>
<h2 id="å¤šæ ¸"><a href="#å¤šæ ¸" class="headerlink" title="å¤šæ ¸"></a>å¤šæ ¸</h2><p>åœ¨åµŒå…¥å¼å¤„ç†å™¨ä¸­æ‹¥æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šå†…æ ¸å˜å¾—è¶Šæ¥è¶Šæ™®éï¼Œè¿™ä¸ºå¹¶å‘æ€§å¢åŠ äº†ä¸€å±‚é¢å¤–çš„å¤æ‚æ€§ã€‚æ‰€æœ‰ä½¿ç”¨ä¸´ç•ŒåŒºï¼ˆåŒ…æ‹¬<code>cortex_m::interrupt::Mutex</code>ï¼‰çš„ç¤ºä¾‹éƒ½å‡è®¾å”¯ä¸€çš„å…¶ä»–æ‰§è¡Œçº¿ç¨‹æ˜¯ä¸­æ–­çº¿ç¨‹ï¼Œä½†åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šä¸å†å¦‚æ­¤ã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå¤šæ ¸è®¾è®¡çš„åŒæ­¥åŸè¯­ï¼ˆä¹Ÿç§°ä¸º SMPï¼Œç”¨äºå¯¹ç§°å¤šå¤„ç†ï¼‰ã€‚</p>
<p>è¿™äº›é€šå¸¸ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„åŸå­æŒ‡ä»¤ï¼Œå› ä¸ºå¤„ç†ç³»ç»Ÿå°†ç¡®ä¿åœ¨æ‰€æœ‰å†…æ ¸ä¸Šä¿æŒåŸå­æ€§ã€‚</p>
<p>è¯¦ç»†ä»‹ç»è¿™äº›ä¸»é¢˜ç›®å‰è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ï¼Œä½†ä¸€èˆ¬æ¨¡å¼ä¸å•æ ¸æƒ…å†µç›¸åŒã€‚</p>
<h1 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h1><p>æœ€ç»ˆï¼Œæ‚¨å°†å¸Œæœ›åœ¨ç¨‹åºä¸­ä½¿ç”¨åŠ¨æ€æ•°æ®ç»“æ„ï¼ˆAKA é›†åˆï¼‰ã€‚<code>std</code>æä¾›äº†ä¸€ç»„å…¬å…±é›†åˆï¼š<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html" target="_blank" rel="noopener"><code>Vec</code></a>ã€<a href="https://doc.rust-lang.org/std/string/struct.String.html" target="_blank" rel="noopener"><code>String</code></a>ã€ <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener"><code>HashMap</code></a>ç­‰ã€‚æ‰€æœ‰å®ç°çš„é›†åˆéƒ½<code>std</code>ä½¿ç”¨å…¨å±€åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼ˆä¹Ÿç§°ä¸ºå †ï¼‰ã€‚</p>
<p>æŒ‰ç…§<code>core</code>å®šä¹‰ï¼Œè¿™äº›å®ç°åœ¨æ²¡æœ‰å†…å­˜åˆ†é…çš„æƒ…å†µä¸‹ä¸å¯ç”¨ï¼Œä½†å¯ä»¥<code>alloc</code>åœ¨ç¼–è¯‘å™¨é™„å¸¦çš„crate ä¸­æ‰¾åˆ°ã€‚</p>
<p>å¦‚æœæ‚¨éœ€è¦é›†åˆï¼Œå †åˆ†é…å®ç°ä¸æ˜¯æ‚¨å”¯ä¸€çš„é€‰æ‹©ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<em>å›ºå®šå®¹é‡</em>é›†åˆï¼›åœ¨<a href="https://crates.io/crates/heapless" target="_blank" rel="noopener"><code>heapless</code></a>crate ä¸­å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„å®ç°ã€‚</p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å’Œæ¯”è¾ƒè¿™ä¸¤ç§å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨-alloc"><a href="#ä½¿ç”¨-alloc" class="headerlink" title="ä½¿ç”¨ alloc"></a>ä½¿ç”¨ <code>alloc</code></h2><p>è¯¥<code>alloc</code>ç®±å‡ºå‚æ—¶çš„æ ‡å‡†é”ˆç—…åˆ†å¸ƒã€‚è¦å¯¼å…¥ crateï¼Œæ‚¨å¯ä»¥ç›´æ¥å°†<code>use</code>å…¶å¯¼å…¥ï¼Œ<em>è€Œæ— éœ€</em>åœ¨<code>Cargo.toml</code>æ–‡ä»¶ä¸­å°†å…¶å£°æ˜ä¸ºä¾èµ–é¡¹ ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc)]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> alloc<span class="token punctuation">;</span>

<span class="token keyword">use</span> alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>vec<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ä»»ä½•é›†åˆï¼Œæ‚¨é¦–å…ˆéœ€è¦ä½¿ç”¨è¯¥<code>global_allocator</code> å±æ€§æ¥å£°æ˜æ‚¨çš„ç¨‹åºå°†ä½¿ç”¨çš„å…¨å±€åˆ†é…å™¨ã€‚æ‚¨é€‰æ‹©çš„åˆ†é…å™¨éœ€è¦å®ç°è¯¥<a href="https://doc.rust-lang.org/core/alloc/trait.GlobalAlloc.html" target="_blank" rel="noopener"><code>GlobalAlloc</code></a>ç‰¹å¾ã€‚</p>
<p>ä¸ºå®Œæ•´èµ·è§å¹¶ä¿æŒæœ¬èŠ‚å°½å¯èƒ½ç‹¬ç«‹ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„å‡¹å‡¸æŒ‡é’ˆåˆ†é…å™¨å¹¶å°†å…¶ç”¨ä½œå…¨å±€åˆ†é…å™¨ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬<em>å¼ºçƒˆ</em>å»ºè®®æ‚¨åœ¨ç¨‹åºä¸­ä½¿ç”¨ crates.io ä¸­ç»è¿‡å®æˆ˜æµ‹è¯•çš„åˆ†é…å™¨ï¼Œè€Œä¸æ˜¯è¿™ä¸ªåˆ†é…å™¨ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Bump pointer allocator implementation</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalAlloc<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Bump pointer allocator for *single* core systems</span>
<span class="token keyword">struct</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token operator">&lt;</span>usize<span class="token operator">></span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> usize<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> GlobalAlloc <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">mut</span> u8 <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// `interrupt::free` is a critical section that makes our allocator safe</span>
        <span class="token comment" spellcheck="true">// to use from within interrupts</span>
        interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> head <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> size <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align_mask <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// move start up to the next alignment boundary</span>
            <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>head <span class="token operator">+</span> align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> align_mask<span class="token punctuation">;</span>

            <span class="token keyword">if</span> start <span class="token operator">+</span> size <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>end <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// a null pointer signal an Out Of Memory condition</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">null_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>head <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
                start <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">dealloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8<span class="token punctuation">,</span> _<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this allocator never deallocates memory</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Declaration of the global memory allocator</span>
<span class="token comment" spellcheck="true">// NOTE the user must ensure that the memory region `[0x2000_0100, 0x2000_0200]`</span>
<span class="token comment" spellcheck="true">// is not used by other parts of the program</span>
<span class="token attribute attr-name">#[global_allocator]</span>
<span class="token keyword">static</span> HEAP<span class="token punctuation">:</span> BumpPointerAlloc <span class="token operator">=</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x2000_0100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> <span class="token number">0x2000_0200</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é™¤äº†é€‰æ‹©å…¨å±€åˆ†é…å™¨ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¿…é¡»å®šä¹‰å¦‚ä½•ä½¿ç”¨<em>ä¸ç¨³å®š</em> <code>alloc_error_handler</code>å±æ€§å¤„ç†å†…å­˜ä¸è¶³ (OOM) é”™è¯¯ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc_error_handler)]</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[alloc_error_handler]</span>
<span class="token keyword">fn</span> <span class="token function">on_oom</span><span class="token punctuation">(</span>_layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    asm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸€åˆ‡å°±ç»ªåï¼Œç”¨æˆ·æœ€ç»ˆå¯ä»¥ä½¿ç”¨<code>alloc</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ‚¨ä½¿ç”¨è¿‡<code>std</code>crate ä¸­çš„é›†åˆï¼Œé‚£ä¹ˆè¿™äº›å°†å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å®Œå…¨ç›¸åŒçš„å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨-heapless"><a href="#ä½¿ç”¨-heapless" class="headerlink" title="ä½¿ç”¨ heapless"></a>ä½¿ç”¨ <code>heapless</code></h2><p><code>heapless</code>ä¸éœ€è¦è®¾ç½®ï¼Œå› ä¸ºå®ƒçš„é›†åˆä¸ä¾èµ–äºå…¨å±€å†…å­˜åˆ†é…å™¨ã€‚åªæ˜¯<code>use</code>å®ƒçš„é›†åˆå¹¶ç»§ç»­å®ä¾‹åŒ–å®ƒä»¬ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> heapless<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// v0.4.x</span>

<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token punctuation">,</span> U8<span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‚¨ä¼šæ³¨æ„åˆ°è¿™äº›é›†åˆä¸<code>alloc</code>.</p>
<p>é¦–å…ˆï¼Œæ‚¨å¿…é¡»é¢„å…ˆå£°æ˜é›†åˆçš„å®¹é‡ã€‚<code>heapless</code> é›†åˆæ°¸è¿œä¸ä¼šé‡æ–°åˆ†é…å¹¶å…·æœ‰å›ºå®šå®¹é‡ï¼›æ­¤å®¹é‡æ˜¯é›†åˆç±»å‹ç­¾åçš„ä¸€éƒ¨åˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»å£°æ˜äº†<code>xs</code> å…·æœ‰ 8 ä¸ªå…ƒç´ çš„å®¹é‡ï¼Œå³å‘é‡æœ€å¤šå¯ä»¥å®¹çº³ 8 ä¸ªå…ƒç´ ã€‚è¿™ç”±ç±»å‹ç­¾åä¸­çš„<code>U8</code>ï¼ˆè¯·å‚é˜…<a href="https://crates.io/crates/typenum" target="_blank" rel="noopener"><code>typenum</code></a>ï¼‰æŒ‡ç¤ºã€‚</p>
<p>å…¶æ¬¡ï¼Œè¯¥<code>push</code>æ–¹æ³•å’Œè®¸å¤šå…¶ä»–æ–¹æ³•éƒ½è¿”å›ä¸€ä¸ª<code>Result</code>. ç”±äº <code>heapless</code>é›†åˆå…·æœ‰å›ºå®šå®¹é‡ï¼Œå› æ­¤æ‰€æœ‰å°†å…ƒç´ æ’å…¥åˆ°é›†åˆä¸­çš„æ“ä½œéƒ½å¯èƒ½å¤±è´¥ã€‚API é€šè¿‡è¿”å›ä¸€ä¸ª<code>Result</code>æŒ‡ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸæ¥åæ˜ æ­¤é—®é¢˜ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>alloc</code>é›†åˆå°†åœ¨å †ä¸Šé‡æ–°åˆ†é…è‡ªå·±ä»¥å¢åŠ å…¶å®¹é‡ã€‚</p>
<p>ä» v0.4.x ç‰ˆæœ¬å¼€å§‹ï¼Œæ‰€æœ‰<code>heapless</code>é›†åˆéƒ½å†…è”å­˜å‚¨å…¶æ‰€æœ‰å…ƒç´ ã€‚è¿™æ„å‘³ç€åƒè¿™æ ·çš„æ“ä½œ<code>let x = heapless::Vec::new();</code>å°†åœ¨å †æ ˆä¸Šåˆ†é…é›†åˆï¼Œä½†ä¹Ÿå¯ä»¥åœ¨<code>static</code>å˜é‡ä¸Šåˆ†é…é›†åˆï¼Œç”šè‡³åœ¨å † ( <code>Box&lt;Vec&lt;_, _&gt;&gt;</code>) ä¸Šã€‚</p>
<h2 id="æƒè¡¡"><a href="#æƒè¡¡" class="headerlink" title="æƒè¡¡"></a>æƒè¡¡</h2><p>åœ¨å †åˆ†é…ã€å¯é‡å®šä½é›†åˆå’Œå›ºå®šå®¹é‡é›†åˆä¹‹é—´è¿›è¡Œé€‰æ‹©æ—¶ï¼Œè¯·è®°ä½è¿™äº›ã€‚</p>
<h3 id="å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†"><a href="#å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†" class="headerlink" title="å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†"></a>å†…å­˜ä¸è¶³å’Œé”™è¯¯å¤„ç†</h3><p>å¯¹äºå †åˆ†é…ï¼Œå†…å­˜ä¸è¶³æ€»æ˜¯å¯èƒ½çš„ï¼Œå¹¶ä¸”å¯èƒ½å‘ç”Ÿåœ¨é›†åˆå¯èƒ½éœ€è¦å¢é•¿çš„ä»»ä½•åœ°æ–¹ï¼šä¾‹å¦‚ï¼Œæ‰€æœ‰ <code>alloc::Vec.push</code>è°ƒç”¨éƒ½å¯èƒ½äº§ç”Ÿ OOM æ¡ä»¶ã€‚å› æ­¤ï¼ŒæŸäº›æ“ä½œå¯èƒ½ä¼š<em>éšå¼</em>å¤±è´¥ã€‚ä¸€äº›<code>alloc</code>é›†åˆå…¬å¼€äº† ä¸€äº›<code>try_reserve</code>æ–¹æ³•ï¼Œå¯ä»¥è®©æ‚¨åœ¨å¢åŠ é›†åˆæ—¶æ£€æŸ¥æ½œåœ¨çš„ OOM æ¡ä»¶ï¼Œä½†æ‚¨éœ€è¦ä¸»åŠ¨ä½¿ç”¨å®ƒä»¬ã€‚</p>
<p>å¦‚æœæ‚¨åªä½¿ç”¨<code>heapless</code>é›†åˆå¹¶ä¸”ä¸å°†å†…å­˜åˆ†é…å™¨ç”¨äºå…¶ä»–ä»»ä½•äº‹æƒ…ï¼Œé‚£ä¹ˆ OOM æ¡ä»¶æ˜¯ä¸å¯èƒ½çš„ã€‚ç›¸åï¼Œæ‚¨å¿…é¡»æ ¹æ®å…·ä½“æƒ…å†µå¤„ç†å®¹é‡ä¸è¶³çš„é›†åˆã€‚è¿™å°±æ˜¯ä½ å¿…é¡»å¤„ç†<em>æ‰€æœ‰</em>çš„<code>Result</code>é€šè¿‡ç±»ä¼¼æ–¹æ³•è¿”å›å°å· <code>Vec.push</code>ã€‚</p>
<p>OOM æ•…éšœå¯èƒ½æ¯”<code>unwrap</code>å¯¹æ‰€æœ‰<code>Result</code>è¿”å›çš„ sè¯´-ingæ›´éš¾è°ƒè¯•ï¼Œ<code>heapless::Vec.push</code>å› ä¸ºè§‚å¯Ÿåˆ°çš„æ•…éšœä½ç½®å¯èƒ½ ä¸é—®é¢˜åŸå› çš„ä½ç½®<em>ä¸</em>åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œ<code>vec.reserve(1)</code>å¦‚æœåˆ†é…å™¨å‡ ä¹è€—å°½ï¼Œå› ä¸ºå…¶ä»–ä¸€äº›é›†åˆæ­£åœ¨æ³„æ¼å†…å­˜ï¼ˆåœ¨å®‰å…¨ Rust ä¸­å¯èƒ½å‘ç”Ÿå†…å­˜æ³„æ¼ï¼‰ï¼Œç”šè‡³ å¯ä»¥è§¦å‘ OOMã€‚</p>
<h3 id="å†…å­˜ä½¿ç”¨æƒ…å†µ"><a href="#å†…å­˜ä½¿ç”¨æƒ…å†µ" class="headerlink" title="å†…å­˜ä½¿ç”¨æƒ…å†µ"></a>å†…å­˜ä½¿ç”¨æƒ…å†µ</h3><p>å¯¹å †åˆ†é…é›†åˆçš„å†…å­˜ä½¿ç”¨æƒ…å†µè¿›è¡Œæ¨ç†æ˜¯å¾ˆå›°éš¾çš„ï¼Œå› ä¸ºé•¿å¯¿å‘½é›†åˆçš„å®¹é‡å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶å‘ç”Ÿå˜åŒ–ã€‚æŸäº›æ“ä½œå¯èƒ½ä¼šéšå¼åœ°é‡æ–°åˆ†é…é›†åˆä»¥å¢åŠ å…¶å†…å­˜ä½¿ç”¨é‡ï¼Œè€ŒæŸäº›é›†åˆå…¬å¼€çš„æ–¹æ³•<code>shrink_to_fit</code>å¯èƒ½ä¼šå‡å°‘é›†åˆä½¿ç”¨çš„å†…å­˜â€”â€”æœ€ç»ˆï¼Œç”±åˆ†é…å™¨å†³å®šæ˜¯å¦å®é™…ç¼©å°å†…å­˜åˆ†é…ã€‚æ­¤å¤–ï¼Œåˆ†é…å™¨å¯èƒ½å¿…é¡»å¤„ç†å†…å­˜ç¢ç‰‡ï¼Œè¿™ä¼šå¢åŠ  <em>æ˜æ˜¾çš„</em>å†…å­˜ä½¿ç”¨é‡ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‚¨ä¸“é—¨ä½¿ç”¨å›ºå®šå®¹é‡é›†åˆï¼Œå°†å®ƒä»¬ä¸­çš„å¤§éƒ¨åˆ†å­˜å‚¨åœ¨<code>static</code>å˜é‡ä¸­å¹¶ä¸ºè°ƒç”¨å †æ ˆè®¾ç½®æœ€å¤§å¤§å°ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°†æ£€æµ‹æ‚¨æ˜¯å¦å°è¯•ä½¿ç”¨æ¯”ç‰©ç†å¯ç”¨å†…å­˜æ›´å¤šçš„å†…å­˜ã€‚</p>
<p>æ­¤å¤–ï¼Œå †æ ˆä¸Šåˆ†é…çš„å›ºå®šå®¹é‡é›†åˆå°†é€šè¿‡<a href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/emit-stack-sizes.html" target="_blank" rel="noopener"><code>-Z emit-stack-sizes</code></a>æ ‡å¿—æŠ¥å‘Šï¼Œè¿™æ„å‘³ç€åˆ†æå †æ ˆä½¿ç”¨æƒ…å†µçš„å·¥å…·ï¼ˆå¦‚<a href="https://crates.io/crates/stack-sizes" target="_blank" rel="noopener"><code>stack-sizes</code></a>ï¼‰å°†åœ¨å…¶åˆ†æä¸­åŒ…æ‹¬å®ƒä»¬ã€‚</p>
<p>ä½†æ˜¯ï¼Œå›ºå®šå®¹é‡é›†åˆ<em>æ— æ³•</em>æ”¶ç¼©ï¼Œè¿™ä¼šå¯¼è‡´è´Ÿè½½å› å­ï¼ˆé›†åˆå¤§å°ä¸å…¶å®¹é‡ä¹‹é—´çš„æ¯”ç‡ï¼‰ä½äºå¯é‡å®šä½é›†åˆæ‰€èƒ½è¾¾åˆ°çš„è´Ÿè½½å› å­ã€‚</p>
<h3 id="æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´-WCET"><a href="#æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´-WCET" class="headerlink" title="æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ (WCET)"></a>æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ (WCET)</h3><p>å¦‚æœæ‚¨æ­£åœ¨æ„å»ºå¯¹æ—¶é—´æ•æ„Ÿçš„åº”ç”¨ç¨‹åºæˆ–ç¡¬å®æ—¶åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½éå¸¸å…³å¿ƒç¨‹åºä¸åŒéƒ¨åˆ†çš„æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ã€‚</p>
<p>è¯¥<code>alloc</code>é›†åˆå¯ä»¥é‡æ–°åˆ†é…ï¼Œè¿™æ ·å¯ä»¥å¢åŠ é›†åˆè¿˜å°†åŒ…æ‹¬å®ƒéœ€è¦é‡æ–°åˆ†é…çš„é›†åˆï¼Œå®ƒæœ¬èº«ä¾èµ–äºæ—¶é—´çš„æ“ä½œçš„WCET<em>è¿è¡Œæ—¶</em>æ”¶é›†çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—å¾ˆéš¾ç¡®å®šä¾‹å¦‚<code>alloc::Vec.push</code>æ“ä½œçš„ WCETï¼Œå› ä¸ºå®ƒå–å†³äºæ­£åœ¨ä½¿ç”¨çš„åˆ†é…å™¨åŠå…¶è¿è¡Œæ—¶å®¹é‡ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå›ºå®šå®¹é‡é›†åˆæ°¸è¿œä¸ä¼šé‡æ–°åˆ†é…ï¼Œå› æ­¤æ‰€æœ‰æ“ä½œéƒ½æœ‰å¯é¢„æµ‹çš„æ‰§è¡Œæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ<code>heapless::Vec.push</code>åœ¨æ’å®šæ—¶é—´å†…æ‰§è¡Œã€‚</p>
<h3 id="ä¾¿äºä½¿ç”¨"><a href="#ä¾¿äºä½¿ç”¨" class="headerlink" title="ä¾¿äºä½¿ç”¨"></a>ä¾¿äºä½¿ç”¨</h3><p><code>alloc</code>éœ€è¦è®¾ç½®å…¨å±€åˆ†é…å™¨ï¼Œ<code>heapless</code>è€Œä¸éœ€è¦ã€‚ä½†æ˜¯ï¼Œ<code>heapless</code>éœ€è¦æ‚¨é€‰æ‹©å®ä¾‹åŒ–çš„æ¯ä¸ªé›†åˆçš„å®¹é‡ã€‚</p>
<p><code>alloc</code>å‡ ä¹æ¯ä¸ª Rust å¼€å‘äººå‘˜éƒ½ä¼šç†Ÿæ‚‰è¯¥APIã€‚è¯¥ <code>heapless</code>APIå°è¯•å¯†åˆ‡æ¨¡ä»¿çš„<code>alloc</code>APIï¼Œä½†å®ƒæ°¸è¿œä¸ä¼šæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒæ˜ç¡®çš„é”™è¯¯å¤„ç†-ä¸€äº›å¼€å‘äººå‘˜å¯èƒ½ä¼šè§‰å¾—æ˜ç¡®é”™è¯¯å¤„ç†è¿‡åº¦æˆ–å¤ªéº»çƒ¦äº†ã€‚</p>
<h1 id="Design-Patterns"><a href="#Design-Patterns" class="headerlink" title="Design Patterns"></a>Design Patterns</h1><p>HAL Design Patternsï¼š</p>
<p>è¿™æ˜¯ä¸€ç»„å¸¸ç”¨å’Œæ¨èçš„æ¨¡å¼ï¼Œç”¨äºåœ¨ Rust ä¸­ä¸ºå¾®æ§åˆ¶å™¨ç¼–å†™ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)ã€‚åœ¨ä¸ºå¾®æ§åˆ¶å™¨ç¼–å†™ HAL æ—¶ï¼Œé™¤äº†ç°æœ‰çš„<a href="https://rust-lang.github.io/api-guidelines/" target="_blank" rel="noopener">Rust API æŒ‡å—</a>ä¹‹å¤–ï¼Œè¿˜æ‰“ç®—ä½¿ç”¨è¿™äº›æ¨¡å¼ã€‚</p>
<h2 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h2><ul>
<li><p>å‘½å</p>
<p>ï¼ˆcrate ä¸ Rust å‘½åçº¦å®šä¸€è‡´ï¼‰</p>
<ul>
<li>ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/naming.html#c-crate-name" target="_blank" rel="noopener">C-CRATE-NAME</a>ï¼‰</li>
</ul>
</li>
<li><p>äº’æ“ä½œæ€§</p>
<p>ï¼ˆæ¿æ¡ç®±ä¸å…¶ä»–åº“åŠŸèƒ½å¾ˆå¥½åœ°äº¤äº’ï¼‰</p>
<ul>
<li>åŒ…è£…å™¨ç±»å‹æä¾›ææ„å‡½æ•°æ–¹æ³• ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-free" target="_blank" rel="noopener">C-FREE</a> )</li>
<li>HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-reexport-pac" target="_blank" rel="noopener">C-REEXPORT-PAC</a> )</li>
<li>ç±»å‹å®ç°<code>embedded-hal</code>ç‰¹å¾ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-hal-traits" target="_blank" rel="noopener">C-HAL-TRAITS</a>ï¼‰</li>
</ul>
</li>
<li><p>å¯é¢„æµ‹æ€§</p>
<p>ï¼ˆæ¿æ¡ç®±å¯ç”¨æ¸…æ™°çš„ä»£ç ï¼Œä½¿å…¶çœ‹èµ·æ¥å¦‚ä½•ï¼‰</p>
<ul>
<li>ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/predictability.html#c-ctor" target="_blank" rel="noopener">C-CTOR</a>ï¼‰</li>
</ul>
</li>
<li><p>GPIO æ¥å£</p>
<p>ï¼ˆGPIO æ¥å£éµå¾ªé€šç”¨æ¨¡å¼ï¼‰</p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-zst-pin" target="_blank" rel="noopener">C-ZST-PIN</a> )</li>
<li>å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-erased-pin" target="_blank" rel="noopener">C-ERASED-PIN</a>ï¼‰</li>
<li>å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°ï¼ˆ<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-pin-state" target="_blank" rel="noopener">C-PIN-STATE</a>ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h2><h3 id="ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰"><a href="#ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰" class="headerlink" title="ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰"></a>ç®±å­è¢«é€‚å½“åœ°å‘½åï¼ˆC-CRATE-NAMEï¼‰</h3><p>HAL crate åº”ä»¥å…¶æ—¨åœ¨æ”¯æŒçš„èŠ¯ç‰‡æˆ–èŠ¯ç‰‡ç³»åˆ—å‘½åã€‚å®ƒä»¬çš„åç§°åº”ä»¥ ç»“å°¾ï¼Œ<code>-hal</code>ä»¥å°†å®ƒä»¬ä¸ register access crate åŒºåˆ†å¼€æ¥ã€‚åç§°ä¸åº”åŒ…å«ä¸‹åˆ’çº¿ï¼ˆæ”¹ç”¨ç ´æŠ˜å·ï¼‰ã€‚</p>
<h2 id="Interoperability"><a href="#Interoperability" class="headerlink" title="Interoperability"></a>Interoperability</h2><h3 id="åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰"><a href="#åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰" class="headerlink" title="åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰"></a>åŒ…è£…ç±»å‹æä¾›ææ„æ–¹æ³•ï¼ˆC-FREEï¼‰</h3><p><code>Copy</code>HAL æä¾›çš„ä»»ä½•éåŒ…è£…å™¨ç±»å‹éƒ½åº”è¯¥æä¾›ä¸€ä¸ª<code>free</code>æ–¹æ³•æ¥ä½¿ç”¨åŒ…è£…å™¨å¹¶è¿”å›åˆ›å»ºå®ƒçš„åŸå§‹å¤–å›´è®¾å¤‡ï¼ˆå¯èƒ½è¿˜æœ‰å…¶ä»–å¯¹è±¡ï¼‰ã€‚</p>
<p>å¦‚æœ‰å¿…è¦ï¼Œè¯¥æ–¹æ³•åº”å…³é—­å¹¶é‡ç½®å¤–è®¾ã€‚<code>new</code> ä½¿ç”¨ è¿”å›çš„åŸå§‹å¤–è®¾è°ƒç”¨<code>free</code>ä¸åº”ç”±äºå¤–è®¾çš„æ„å¤–çŠ¶æ€è€Œå¤±è´¥ã€‚</p>
<p>å¦‚æœ HAL ç±»å‹éœ€è¦<code>Copy</code>æ„é€ å…¶ä»–éå¯¹è±¡ï¼ˆä¾‹å¦‚ I/O å¼•è„šï¼‰ï¼Œåˆ™ä»»ä½•æ­¤ç±»å¯¹è±¡ä¹Ÿåº”è¢«é‡Šæ”¾å¹¶è¿”å›<code>free</code>ã€‚ <code>free</code>åœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥è¿”å›ä¸€ä¸ªå…ƒç»„ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token function">Timer</span><span class="token punctuation">(</span>TIMER0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Timer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>periph<span class="token punctuation">:</span> TIMER0<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        <span class="token function">Self</span><span class="token punctuation">(</span>periph<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> TIMER0 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="HAL-é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®±-C-REEXPORT-PAC"><a href="#HAL-é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®±-C-REEXPORT-PAC" class="headerlink" title="HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± (C-REEXPORT-PAC)"></a>HAL é‡æ–°å¯¼å‡ºå…¶æ³¨å†Œè®¿é—®ç®± (C-REEXPORT-PAC)</h3><p>HAL å¯ä»¥å†™åœ¨<a href="https://github.com/rust-embedded/svd2rust" target="_blank" rel="noopener">svd2rust</a>ç”Ÿæˆçš„ PAC ä¹‹ä¸Šï¼Œæˆ–è€…å†™åœ¨æä¾›åŸå§‹å¯„å­˜å™¨è®¿é—®çš„å…¶ä»– crate ä¹‹ä¸Šã€‚HAL åº”å§‹ç»ˆåœ¨å…¶ crate æ ¹ä¸­é‡æ–°å¯¼å‡ºå®ƒä»¬æ‰€åŸºäºçš„ register access crateã€‚</p>
<p>PAC åº”è¯¥ä»¥ name é‡æ–°å¯¼å‡º<code>pac</code>ï¼Œè€Œä¸ç®¡ crate çš„å®é™…åç§°æ˜¯ä»€ä¹ˆï¼Œå› ä¸º HAL çš„åç§°åº”è¯¥å·²ç»æ¸…æ¥šåœ°è¡¨æ˜æ­£åœ¨è®¿é—®ä»€ä¹ˆ PACã€‚</p>
<h3 id="ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰"><a href="#ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰" class="headerlink" title="ç±»å‹å®ç°embedded-halç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰"></a>ç±»å‹å®ç°<code>embedded-hal</code>ç‰¹å¾ï¼ˆC-HAL-TRAITSï¼‰</h3><p>HAL æä¾›çš„ç±»å‹åº”å®ç°<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>crateæä¾›çš„æ‰€æœ‰é€‚ç”¨ç‰¹å¾ ã€‚</p>
<p>å¯ä»¥ä¸ºåŒä¸€ç±»å‹å®ç°å¤šä¸ªç‰¹å¾ã€‚</p>
<h2 id="Predictability"><a href="#Predictability" class="headerlink" title="Predictability"></a>Predictability</h2><h3 id="ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰"><a href="#ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰" class="headerlink" title="ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰"></a>ä½¿ç”¨æ„é€ å‡½æ•°ä»£æ›¿æ‰©å±•ç‰¹å¾ï¼ˆC-CTORï¼‰</h3><p>HAL å‘å…¶æ·»åŠ åŠŸèƒ½çš„æ‰€æœ‰å¤–å›´è®¾å¤‡éƒ½åº”åŒ…å«åœ¨æ–°ç±»å‹ä¸­ï¼Œå³ä½¿è¯¥åŠŸèƒ½ä¸éœ€è¦å…¶ä»–å­—æ®µã€‚</p>
<p>åº”é¿å…ä¸ºåŸå§‹å¤–è®¾å®ç°çš„æ‰©å±•ç‰¹æ€§ã€‚</p>
<h3 id="æ–¹æ³•-inline-åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰"><a href="#æ–¹æ³•-inline-åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰" class="headerlink" title="æ–¹æ³•#[inline\]åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰"></a>æ–¹æ³•<code>#[inline\]</code>åœ¨é€‚å½“çš„åœ°æ–¹è£…é¥°ï¼ˆC-INLINEï¼‰</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust ç¼–è¯‘å™¨ä¸ä¼šè·¨ crate è¾¹ç•Œæ‰§è¡Œå®Œå…¨å†…è”ã€‚ç”±äºåµŒå…¥å¼åº”ç”¨ç¨‹åºå¯¹æ„å¤–çš„ä»£ç å¤§å°å¢åŠ å¾ˆæ•æ„Ÿï¼Œ<code>#[inline]</code>åº”ä½¿ç”¨å¦‚ä¸‹æŒ‡å¯¼ç¼–è¯‘å™¨ï¼š</p>
<ul>
<li>æ‰€æœ‰â€œå°â€åŠŸèƒ½éƒ½åº”è¯¥è¢«æ ‡è®°<code>#[inline]</code>ã€‚ä»€ä¹ˆæ˜¯â€œå°â€æ˜¯ä¸»è§‚çš„ï¼Œä½†é€šå¸¸æ‰€æœ‰é¢„æœŸç¼–è¯‘ä¸ºä¸€ä½æ•°æŒ‡ä»¤åºåˆ—çš„å‡½æ•°éƒ½è¢«è®¤ä¸ºæ˜¯å°ã€‚</li>
<li>å¾ˆå¯èƒ½é‡‡ç”¨å¸¸é‡å€¼ä½œä¸ºå‚æ•°çš„å‡½æ•°åº”æ ‡è®°ä¸º<code>#[inline]</code>. è¿™ä½¿å¾—ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶è®¡ç®—ç”šè‡³å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘ï¼Œå‰ææ˜¯å‡½æ•°è¾“å…¥æ˜¯å·²çŸ¥çš„ã€‚</li>
</ul>
<h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><h3 id="é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å°-C-ZST-PIN"><a href="#é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å°-C-ZST-PIN" class="headerlink" title="é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° (C-ZST-PIN)"></a>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼•è„šç±»å‹ä¸ºé›¶å¤§å° (C-ZST-PIN)</h3><p>HAL å…¬å¼€çš„ GPIO æ¥å£åº”ä¸ºæ¯ä¸ªæ¥å£æˆ–ç«¯å£ä¸Šçš„æ¯ä¸ªå¼•è„šæä¾›ä¸“ç”¨çš„é›¶å¤§å°ç±»å‹ï¼Œä»è€Œåœ¨æ‰€æœ‰å¼•è„šåˆ†é…éƒ½æ˜¯é™æ€å·²çŸ¥çš„æƒ…å†µä¸‹å®ç°é›¶æˆæœ¬çš„ GPIO æŠ½è±¡ã€‚</p>
<p>æ¯ä¸ª GPIO æ¥å£æˆ–ç«¯å£éƒ½åº”è¯¥å®ç°ä¸€ä¸ª<code>split</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå¸¦æœ‰æ¯ä¸ªå¼•è„šçš„ç»“æ„ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortA<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PortA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PortAPins <span class="token punctuation">{</span>
        PortAPins <span class="token punctuation">{</span>
            pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
            pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortAPins <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•-C-ERASED-PIN"><a href="#å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³•-C-ERASED-PIN" class="headerlink" title="å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³• (C-ERASED-PIN)"></a>å¼•è„šç±»å‹æä¾›æ“¦é™¤å¼•è„šå’Œç«¯å£çš„æ–¹æ³• (C-ERASED-PIN)</h3><p>Pin åº”è¯¥æä¾›ç±»å‹æ“¦é™¤æ–¹æ³•ï¼Œå°†å®ƒä»¬çš„å±æ€§ä»ç¼–è¯‘æ—¶ç§»åŠ¨åˆ°è¿è¡Œæ—¶ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºä¸­æä¾›æ›´å¤§çš„çµæ´»æ€§ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// Port A, pin 0.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PA0 <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_pin</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PA <span class="token punctuation">{</span>
        PA <span class="token punctuation">{</span> pin<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A pin on port A.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// The pin number.</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> PA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_port</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Pin <span class="token punctuation">{</span>
        Pin <span class="token punctuation">{</span>
            port<span class="token punctuation">:</span> Port<span class="token punctuation">:</span><span class="token punctuation">:</span>A<span class="token punctuation">,</span>
            pin<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>pin<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Pin <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> Port<span class="token punctuation">,</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// (these fields can be packed to reduce the memory footprint)</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> Port <span class="token punctuation">{</span>
    A<span class="token punctuation">,</span>
    B<span class="token punctuation">,</span>
    C<span class="token punctuation">,</span>
    D<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°-C-PIN-STATE"><a href="#å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•°-C-PIN-STATE" class="headerlink" title="å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•° (C-PIN-STATE)"></a>å¼•è„šçŠ¶æ€åº”ç¼–ç ä¸ºç±»å‹å‚æ•° (C-PIN-STATE)</h3><p>æ ¹æ®èŠ¯ç‰‡æˆ–ç³»åˆ—çš„ä¸åŒï¼Œå¼•è„šå¯ä»¥é…ç½®ä¸ºå…·æœ‰ä¸åŒç‰¹æ€§çš„è¾“å…¥æˆ–è¾“å‡ºã€‚æ­¤çŠ¶æ€åº”åœ¨ç±»å‹ç³»ç»Ÿä¸­è¿›è¡Œç¼–ç ï¼Œä»¥é˜²æ­¢åœ¨é”™è¯¯çŠ¶æ€ä¸‹ä½¿ç”¨å¼•è„šã€‚</p>
<p>é™„åŠ çš„ã€ç‰¹å®šäºèŠ¯ç‰‡çš„çŠ¶æ€ï¼ˆä¾‹å¦‚é©±åŠ¨å¼ºåº¦ï¼‰ä¹Ÿå¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨é™„åŠ ç±»å‹å‚æ•°è¿›è¡Œç¼–ç ã€‚</p>
<p>åº”æä¾›æ›´æ”¹å¼•è„šçŠ¶æ€çš„æ–¹æ³•<code>into_input</code>å’Œ <code>into_output</code>æ–¹æ³•ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>with_{input,output}_state</code>åº”è¯¥æä¾›åœ¨ä¸åŒçŠ¶æ€ä¸‹ä¸´æ—¶é‡æ–°é…ç½®å¼•è„šè€Œä¸ç§»åŠ¨å®ƒçš„æ–¹æ³•ã€‚</p>
<p>åº”ä¸ºæ¯ç§å¼•è„šç±»å‹æä¾›ä»¥ä¸‹æ–¹æ³•ï¼ˆå³æ“¦é™¤å’Œéæ“¦é™¤å¼•è„šç±»å‹åº”æä¾›ç›¸åŒçš„ APIï¼‰ï¼š</p>
<ul>
<li><p><code>pub fn into_input&lt;N: InputState&gt;(self, input: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><p><code>pub fn into_output&lt;N: OutputState&gt;(self, output: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_input_state<N: InputState, R>(
    &mut self,
    input: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_output_state<N: OutputState, R>(
    &mut self,
    output: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>å¼•è„šçŠ¶æ€åº”å—å¯†å°ç‰¹å¾çš„é™åˆ¶ã€‚HAL çš„ç”¨æˆ·åº”è¯¥ä¸éœ€è¦æ·»åŠ ä»–ä»¬è‡ªå·±çš„çŠ¶æ€ã€‚è¿™äº›ç‰¹å¾å¯ä»¥æä¾›å®ç°å¼•è„šçŠ¶æ€ API æ‰€éœ€çš„ç‰¹å®šäº HAL çš„æ–¹æ³•ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">mod</span> sealed <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">trait</span> Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> PinState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> OutputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> InputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Output<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PushPull<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> OpenDrain<span class="token punctuation">;</span>

<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Input<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Floating<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullUp<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullDown<span class="token punctuation">;</span>

<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> PA1<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_input<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Input<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_output<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Output<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_input_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_output_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Same for `PA` and `Pin`, and other pin types.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Tips-for-embedded-C-developers"><a href="#Tips-for-embedded-C-developers" class="headerlink" title="Tips for embedded C developers"></a>Tips for embedded C developers</h1><p>æœ¬ç« æ”¶é›†äº†å„ç§æŠ€å·§ï¼Œå¯èƒ½å¯¹å¸Œæœ›å¼€å§‹ç¼–å†™ Rust çš„æœ‰ç»éªŒçš„åµŒå…¥å¼ C å¼€å‘äººå‘˜æœ‰ç”¨ã€‚å®ƒå°†ç‰¹åˆ«å¼ºè°ƒæ‚¨åœ¨ C ä¸­å¯èƒ½å·²ç»ä¹ æƒ¯çš„ä¸œè¥¿åœ¨ Rust ä¸­çš„ä¸åŒä¹‹å¤„ã€‚</p>
<h2 id="é¢„å¤„ç†å™¨"><a href="#é¢„å¤„ç†å™¨" class="headerlink" title="é¢„å¤„ç†å™¨"></a>é¢„å¤„ç†å™¨</h2><p>åœ¨åµŒå…¥å¼ C ä¸­ï¼Œå°†é¢„å¤„ç†å™¨ç”¨äºå„ç§ç›®çš„æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ä»£ç å—çš„ç¼–è¯‘æ—¶é€‰æ‹© <code>#ifdef</code></li>
<li>ç¼–è¯‘æ—¶æ•°ç»„å¤§å°å’Œè®¡ç®—</li>
<li>ç”¨äºç®€åŒ–å¸¸è§æ¨¡å¼çš„å®ï¼ˆä»¥é¿å…å‡½æ•°è°ƒç”¨å¼€é”€ï¼‰</li>
</ul>
<p>åœ¨ Rust ä¸­æ²¡æœ‰é¢„å¤„ç†å™¨ï¼Œå› æ­¤è®¸å¤šè¿™äº›ç”¨ä¾‹çš„å¤„ç†æ–¹å¼ä¸åŒã€‚åœ¨æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä½¿ç”¨é¢„å¤„ç†å™¨çš„å„ç§æ›¿ä»£æ–¹æ³•ã€‚</p>
<h3 id="Compile-Time-Code-Selection"><a href="#Compile-Time-Code-Selection" class="headerlink" title="Compile-Time Code Selection"></a>Compile-Time Code Selection</h3><p><code>#ifdef ... #endif</code>åœ¨ Rust ä¸­æœ€æ¥è¿‘çš„åŒ¹é…æ˜¯<a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-features-section" target="_blank" rel="noopener">Cargo features</a>ã€‚è¿™äº›æ¯” C é¢„å¤„ç†å™¨æ›´æ­£å¼ä¸€äº›ï¼šæ‰€æœ‰å¯èƒ½çš„åŠŸèƒ½éƒ½æ˜ç¡®åˆ—å‡ºæ¯ä¸ª crateï¼Œå¹¶ä¸”åªèƒ½æ‰“å¼€æˆ–å…³é—­ã€‚å½“æ‚¨å°†ä¸€ä¸ª crate åˆ—ä¸ºä¾èµ–é¡¹æ—¶ï¼ŒåŠŸèƒ½ä¼šè¢«æ‰“å¼€ï¼Œå¹¶ä¸”æ˜¯é™„åŠ çš„ï¼šå¦‚æœæ‚¨çš„ä¾èµ–æ ‘ä¸­çš„ä»»ä½•ä¸€ä¸ª crate ä¸ºå¦ä¸€ä¸ª crate å¯ç”¨äº†ä¸€ä¸ªç‰¹æ€§ï¼Œé‚£ä¹ˆè¯¥ç‰¹æ€§å°†ä¸ºè¯¥ crate çš„æ‰€æœ‰ç”¨æˆ·å¯ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªæä¾›ä¿¡å·å¤„ç†åŸè¯­åº“çš„ crateã€‚æ¯ä¸ªäººéƒ½å¯èƒ½éœ€è¦ä¸€äº›é¢å¤–çš„æ—¶é—´æ¥ç¼–è¯‘æˆ–å£°æ˜ä¸€äº›æ‚¨å¸Œæœ›é¿å…çš„å¤§å‹å¸¸é‡è¡¨ã€‚ä½ å¯ä»¥ä¸ºä½ çš„æ¯ä¸ªç»„ä»¶å£°æ˜ä¸€ä¸ª Cargo ç‰¹æ€§<code>Cargo.toml</code>ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml">[features]
FIR = []
IIR = []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åï¼Œåœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œä½¿ç”¨<code>#[cfg(feature="FIR")]</code>æ¥æ§åˆ¶æ‰€åŒ…å«çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// In your top-level lib.rs</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"FIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> fir<span class="token punctuation">;</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"IIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> iir<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç±»ä¼¼åœ°ï¼Œä»…å½“æŸä¸ªåŠŸèƒ½<em>æœª</em>å¯ç”¨ï¼Œæˆ–è€…åŠŸèƒ½çš„ä»»ä½•ç»„åˆå·²å¯ç”¨æˆ–æœªå¯ç”¨æ—¶ï¼Œæ‚¨æ‰å¯ä»¥åŒ…å«ä»£ç å—ã€‚</p>
<p>æ­¤å¤–ï¼ŒRust æä¾›äº†è®¸å¤šæ‚¨å¯ä»¥ä½¿ç”¨çš„è‡ªåŠ¨è®¾ç½®æ¡ä»¶ï¼Œä¾‹å¦‚<code>target_arch</code>æ ¹æ®æ¶æ„é€‰æ‹©ä¸åŒçš„ä»£ç ã€‚æœ‰å…³æ¡ä»¶ç¼–è¯‘æ”¯æŒçš„å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…Rust å‚è€ƒçš„ <a href="https://doc.rust-lang.org/reference/conditional-compilation.html" target="_blank" rel="noopener">æ¡ä»¶ç¼–è¯‘</a>ç« èŠ‚ã€‚</p>
<p>æ¡ä»¶ç¼–è¯‘ä»…é€‚ç”¨äºä¸‹ä¸€ä¸ªè¯­å¥æˆ–å—ã€‚å¦‚æœä¸€ä¸ªå—ä¸èƒ½åœ¨å½“å‰èŒƒå›´å†…ä½¿ç”¨ï¼Œé‚£ä¹ˆè¯¥<code>cfg</code>å±æ€§å°†éœ€è¦å¤šæ¬¡ä½¿ç”¨ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæœ€å¥½ç®€å•åœ°åŒ…å«æ‰€æœ‰ä»£ç å¹¶å…è®¸ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–æ—¶åˆ é™¤æ­»ä»£ç ï¼šè¿™å¯¹æ‚¨å’Œæ‚¨çš„ç”¨æˆ·æ¥è¯´æ›´ç®€å•ï¼Œå¹¶ä¸”é€šå¸¸ç¼–è¯‘å™¨ä¼šå¾ˆå¥½åœ°åˆ é™¤æœªä½¿ç”¨çš„ä»£ç .</p>
<h3 id="ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—"><a href="#ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—" class="headerlink" title="ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—"></a>ç¼–è¯‘æ—¶å¤§å°å’Œè®¡ç®—</h3><p>Rust æ”¯æŒ<code>const fn</code>, ä¿è¯åœ¨ç¼–è¯‘æ—¶å¯è¯„ä¼°çš„å‡½æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨éœ€è¦å¸¸é‡çš„åœ°æ–¹ä½¿ç”¨ï¼Œä¾‹å¦‚æ•°ç»„çš„å¤§å°ã€‚è¿™å¯ä»¥ä¸ä¸Šè¿°åŠŸèƒ½ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> usize <span class="token punctuation">{</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">1024</span> <span class="token punctuation">}</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">128</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> BUF<span class="token punctuation">:</span> <span class="token punctuation">[</span>u32<span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u32</span><span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä» 1.31 å¼€å§‹ï¼Œè¿™äº›æ˜¯ç¨³å®š Rust çš„æ–°å†…å®¹ï¼Œå› æ­¤æ–‡æ¡£ä»ç„¶å¾ˆå°‘ã€‚<code>const fn</code>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå¯ç”¨çš„åŠŸèƒ½ä¹Ÿéå¸¸æœ‰é™ï¼›åœ¨æœªæ¥çš„ Rust ç‰ˆæœ¬ä¸­ï¼Œé¢„è®¡ä¼šæ‰©å±•<code>const fn</code>.</p>
<h3 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h3><p>Rust æä¾›äº†ä¸€ä¸ªæå…¶å¼ºå¤§çš„<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">å®ç³»ç»Ÿ</a>ã€‚è™½ç„¶ C é¢„å¤„ç†å™¨å‡ ä¹ç›´æ¥å¯¹æºä»£ç çš„æ–‡æœ¬è¿›è¡Œæ“ä½œï¼Œä½† Rust å®ç³»ç»Ÿåœ¨æ›´é«˜çš„çº§åˆ«ä¸Šè¿è¡Œã€‚Rust å®æœ‰ä¸¤ç§å˜ä½“ï¼š<em>ç¤ºä¾‹*</em>å®<em>å’Œ</em>è¿‡ç¨‹å®*ã€‚å‰è€…æ›´ç®€å•ä¹Ÿæœ€å¸¸è§ï¼›å®ƒä»¬çœ‹èµ·æ¥åƒå‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥æ‰©å±•ä¸ºå®Œæ•´çš„è¡¨è¾¾å¼ã€è¯­å¥ã€é¡¹æˆ–æ¨¡å¼ã€‚è¿‡ç¨‹å®æ›´å¤æ‚ï¼Œä½†å…è®¸å¯¹ Rust è¯­è¨€è¿›è¡Œæå…¶å¼ºå¤§çš„æ·»åŠ ï¼šå®ƒä»¬å¯ä»¥å°†ä»»æ„ Rust è¯­æ³•è½¬æ¢ä¸ºæ–°çš„ Rust è¯­æ³•ã€‚</p>
<p>é€šå¸¸ï¼Œåœ¨æ‚¨å¯èƒ½ä½¿ç”¨è¿‡ C é¢„å¤„ç†å™¨å®çš„åœ°æ–¹ï¼Œæ‚¨å¯èƒ½æƒ³æŸ¥çœ‹ä¸€ä¸ªå®ç¤ºä¾‹æ˜¯å¦å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚å®ƒä»¬å¯ä»¥åœ¨æ‚¨çš„ crate ä¸­å®šä¹‰ï¼Œå¹¶ä¸”å¯ä»¥ç”±æ‚¨è‡ªå·±çš„ crate è½»æ¾ä½¿ç”¨æˆ–å¯¼å‡ºç»™å…¶ä»–ç”¨æˆ·ã€‚è¯·æ³¨æ„ï¼Œç”±äºå®ƒä»¬å¿…é¡»æ‰©å±•ä¸ºå®Œæ•´çš„è¡¨è¾¾å¼ã€è¯­å¥ã€é¡¹æˆ–æ¨¡å¼ï¼Œå› æ­¤ C é¢„å¤„ç†å™¨å®çš„æŸäº›ç”¨ä¾‹å°†ä¸èµ·ä½œç”¨ï¼Œä¾‹å¦‚æ‰©å±•ä¸ºå˜é‡åç§°çš„ä¸€éƒ¨åˆ†æˆ–åˆ—è¡¨ä¸­ä¸å®Œæ•´çš„é¡¹é›†çš„å®.</p>
<p>ä¸ Cargo åŠŸèƒ½ä¸€æ ·ï¼Œå¦‚æœæ‚¨ç”šè‡³éœ€è¦å®ï¼Œåˆ™å€¼å¾—è€ƒè™‘ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¸¸è§„å‡½æ•°æ›´å®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”ä¼šè¢«å†…è”åˆ°ä¸å®ç›¸åŒçš„ä»£ç ä¸­ã€‚åœ¨<code>#[inline]</code>å’Œ<code>#[inline(always)]</code> <a href="https://doc.rust-lang.org/reference/attributes.html#inline-attribute" target="_blank" rel="noopener">å±æ€§</a> è®©æ‚¨å¯¹è¿™ä¸€è¿‡ç¨‹çš„è¿›ä¸€æ­¥æ§åˆ¶ï¼Œä½†åº”è°¨æ…åœ¨è¿™é‡Œæ‹æ‘„ï¼Œä»¥åŠ-ç¼–è¯‘å™¨ä¼šä»åŒä¸€åŒ…è£…ç®±è‡ªåŠ¨å†…è”å‡½æ•°åœ¨é€‚å½“æƒ…å†µä¸‹ï¼Œæ‰€ä»¥è¿«ä½¿å®ƒè¿™æ ·åšä¸æ°å½“å®é™…ä¸Šå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
<p>è§£é‡Šæ•´ä¸ª Rust å®ç³»ç»Ÿè¶…å‡ºäº†æœ¬æç¤ºé¡µé¢çš„èŒƒå›´ï¼Œå› æ­¤é¼“åŠ±æ‚¨æŸ¥é˜… Rust æ–‡æ¡£ä»¥è·å–å®Œæ•´è¯¦ç»†ä¿¡æ¯ã€‚</p>
<h2 id="æ„å»ºç³»ç»Ÿ"><a href="#æ„å»ºç³»ç»Ÿ" class="headerlink" title="æ„å»ºç³»ç»Ÿ"></a>æ„å»ºç³»ç»Ÿ</h2><p>å¤§å¤šæ•° Rust crate æ˜¯ä½¿ç”¨ Cargo æ„å»ºçš„ï¼ˆå°½ç®¡ä¸æ˜¯å¿…éœ€çš„ï¼‰ã€‚è¿™è§£å†³äº†ä¼ ç»Ÿæ„å»ºç³»ç»Ÿçš„è®¸å¤šéš¾é¢˜ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½å¸Œæœ›è‡ªå®šä¹‰æ„å»ºè¿‡ç¨‹ã€‚Cargoä¸ºæ­¤æä¾›äº†<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener"><code>build.rs</code> è„šæœ¬</a>ã€‚å®ƒä»¬æ˜¯ Rust è„šæœ¬ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¸ Cargo æ„å»ºç³»ç»Ÿäº¤äº’ã€‚</p>
<p>æ„å»ºè„šæœ¬çš„å¸¸è§ç”¨ä¾‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>æä¾›æ„å»ºæ—¶é—´ä¿¡æ¯ï¼Œä¾‹å¦‚å°†æ„å»ºæ—¥æœŸæˆ– Git æäº¤å“ˆå¸Œé™æ€åµŒå…¥åˆ°æ‚¨çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­</li>
<li>æ ¹æ®æ‰€é€‰åŠŸèƒ½æˆ–å…¶ä»–é€»è¾‘åœ¨æ„å»ºæ—¶ç”Ÿæˆé“¾æ¥å™¨è„šæœ¬</li>
<li>æ›´æ”¹ Cargo æ„å»ºé…ç½®</li>
<li>æ·»åŠ é¢å¤–çš„é™æ€åº“æ¥é“¾æ¥</li>
</ul>
<p>ç›®å‰ä¸æ”¯æŒæ„å»ºåè„šæœ¬ï¼Œæ‚¨å¯èƒ½åœ¨ä¼ ç»Ÿä¸Šå°†å…¶ç”¨äºä»æ„å»ºå¯¹è±¡è‡ªåŠ¨ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶æˆ–æ‰“å°æ„å»ºä¿¡æ¯ç­‰ä»»åŠ¡ã€‚</p>
<h3 id="äº¤å‰ç¼–è¯‘-1"><a href="#äº¤å‰ç¼–è¯‘-1" class="headerlink" title="äº¤å‰ç¼–è¯‘"></a>äº¤å‰ç¼–è¯‘</h3><p>å°† Cargo ç”¨äºæ‚¨çš„æ„å»ºç³»ç»Ÿè¿˜å¯ä»¥ç®€åŒ–äº¤å‰ç¼–è¯‘ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€å‘Šè¯‰ Cargo<code>--target thumbv6m-none-eabi</code>å¹¶åœ¨<code>target/thumbv6m-none-eabi/debug/myapp</code>.</p>
<p>å¯¹äº Rust æœ¬èº«ä¸æ”¯æŒçš„å¹³å°ï¼Œæ‚¨éœ€è¦<code>libcore</code> è‡ªå·±ä¸ºè¯¥ç›®æ ‡æ„å»ºã€‚åœ¨è¿™æ ·çš„å¹³å°ä¸Šï¼Œ<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener">Xargo</a>å¯ä»¥ç”¨ä½œ Cargo çš„æ›¿èº«ï¼Œå®ƒä¼šè‡ªåŠ¨<code>libcore</code>ä¸ºæ‚¨æ„å»ºã€‚</p>
<h2 id="è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®"><a href="#è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®" class="headerlink" title="è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®"></a>è¿­ä»£å™¨ä¸æ•°ç»„è®¿é—®</h2><p>åœ¨ C ä¸­ï¼Œæ‚¨å¯èƒ½ä¹ æƒ¯äºé€šè¿‡ç´¢å¼•ç›´æ¥è®¿é—®æ•°ç»„ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c">int16_t arr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ Rust ä¸­ï¼Œè¿™æ˜¯ä¸€ç§åæ¨¡å¼ï¼šç´¢å¼•è®¿é—®å¯èƒ½ä¼šæ›´æ…¢ï¼ˆå› ä¸ºå®ƒéœ€è¦è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼‰å¹¶ä¸”å¯èƒ½ä¼šé˜»æ­¢å„ç§ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼Œå€¼å¾—é‡å¤ï¼šRust å°†æ£€æŸ¥æ‰‹åŠ¨æ•°ç»„ç´¢å¼•çš„è¶Šç•Œè®¿é—®ä»¥ä¿è¯å†…å­˜å®‰å…¨ï¼Œè€Œ C å°†å¾ˆä¹æ„åœ¨æ•°ç»„å¤–è¿›è¡Œç´¢å¼•ã€‚</p>
<p>ç›¸åï¼Œä½¿ç”¨è¿­ä»£å™¨ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u16</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> element <span class="token keyword">in</span> arr<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">*</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿­ä»£å™¨æä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§çš„åŠŸèƒ½ï¼Œæ‚¨å¿…é¡»åœ¨ C ä¸­æ‰‹åŠ¨å®ç°ï¼Œä¾‹å¦‚é“¾æ¥ã€å‹ç¼©ã€æšä¸¾ã€æŸ¥æ‰¾æœ€å°å€¼æˆ–æœ€å¤§å€¼ã€æ±‚å’Œç­‰ç­‰ã€‚è¿­ä»£å™¨æ–¹æ³•ä¹Ÿå¯ä»¥é“¾æ¥ï¼Œæä¾›éå¸¸æ˜“è¯»çš„æ•°æ®å¤„ç†ä»£ç ã€‚</p>
<h2 id="å¼•ç”¨-vs-æŒ‡é’ˆ"><a href="#å¼•ç”¨-vs-æŒ‡é’ˆ" class="headerlink" title="å¼•ç”¨ vs æŒ‡é’ˆ"></a>å¼•ç”¨ vs æŒ‡é’ˆ</h2><p>åœ¨ Rust ä¸­ï¼ŒæŒ‡é’ˆï¼ˆç§°ä¸º<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener"><em>åŸå§‹æŒ‡é’ˆ</em></a>ï¼‰å­˜åœ¨ä½†ä»…åœ¨ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œå› ä¸ºæ€»æ˜¯è€ƒè™‘å–æ¶ˆå¼•ç”¨å®ƒä»¬<code>unsafe</code>â€”â€”Rust ä¸èƒ½æä¾›å…³äºæŒ‡é’ˆåé¢å¯èƒ½æ˜¯ä»€ä¹ˆçš„é€šå¸¸ä¿è¯ã€‚</p>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ”¹ç”¨<em>å¼•ç”¨</em>ï¼Œç”±æŒ‡å®šçš„<code>&amp;</code>ç¬¦å·ï¼Œæˆ– <em>å¯å˜çš„å¼•ç”¨</em>ï¼Œä»¥è¡¨ç¤º<code>&amp;mut</code>ã€‚å¼•ç”¨çš„è¡Œä¸ºç±»ä¼¼äºæŒ‡é’ˆï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è¢«å–æ¶ˆå¼•ç”¨ä»¥è®¿é—®åº•å±‚å€¼ï¼Œä½†å®ƒä»¬æ˜¯ Rust æ‰€æœ‰æƒç³»ç»Ÿçš„å…³é”®éƒ¨åˆ†ï¼šRust å°†ä¸¥æ ¼å¼ºåˆ¶æ‚¨å¯èƒ½åªæœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨<em>æˆ–</em>å¤šä¸ªéå¯å˜å¼•ç”¨åˆ°åŒä¸€ä¸ªåœ¨ä»»ä½•ç»™å®šæ—¶é—´çš„ä»·å€¼ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€æ‚¨å¿…é¡»æ›´åŠ å°å¿ƒæ˜¯å¦éœ€è¦å¯¹æ•°æ®è¿›è¡Œå¯å˜è®¿é—®ï¼šåœ¨ C ä¸­ï¼Œé»˜è®¤å€¼æ˜¯å¯å˜çš„ï¼Œæ‚¨å¿…é¡»æ˜ç¡®è¯´æ˜<code>const</code>ï¼Œè€Œåœ¨ Rust ä¸­åˆ™ç›¸åã€‚</p>
<p>æ‚¨å¯èƒ½ä»ç„¶ä½¿ç”¨åŸå§‹æŒ‡é’ˆçš„ä¸€ç§æƒ…å†µæ˜¯ç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ï¼ˆä¾‹å¦‚ï¼Œå°†æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆå†™å…¥ DMA å¤–è®¾å¯„å­˜å™¨ï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬ä¹Ÿåœ¨å¹•åç”¨äºæ‰€æœ‰å¤–è®¾è®¿é—®åŒ…ï¼Œä»¥å…è®¸æ‚¨è¯»å–å’Œå†™å†…å­˜æ˜ å°„å¯„å­˜å™¨ã€‚</p>
<h2 id="Volatile-Access"><a href="#Volatile-Access" class="headerlink" title="Volatile Access"></a>Volatile Access</h2><p>åœ¨ C ä¸­ï¼Œä¸ªåˆ«å˜é‡å¯èƒ½è¢«æ ‡è®°ä¸º<code>volatile</code>ï¼Œå‘ç¼–è¯‘å™¨è¡¨æ˜å˜é‡ä¸­çš„å€¼å¯èƒ½ä¼šåœ¨è®¿é—®ä¹‹é—´å‘ç”Ÿå˜åŒ–ã€‚æ˜“å¤±æ€§å˜é‡é€šå¸¸ç”¨äºå†…å­˜æ˜ å°„å¯„å­˜å™¨çš„åµŒå…¥å¼ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å°†å˜é‡æ ‡è®°ä¸º<code>volatile</code>ï¼Œè€Œæ˜¯ä½¿ç”¨ç‰¹å®šçš„æ–¹æ³•æ¥æ‰§è¡Œ volatile è®¿é—®ï¼š<a href="https://doc.rust-lang.org/core/ptr/fn.read_volatile.html" target="_blank" rel="noopener"><code>core::ptr::read_volatile</code></a>å’Œ <a href="https://doc.rust-lang.org/core/ptr/fn.write_volatile.html" target="_blank" rel="noopener"><code>core::ptr::write_volatile</code></a>ã€‚è¿™äº›æ–¹æ³•é‡‡ç”¨ a<code>*const T</code>æˆ– a <code>*mut T</code> ï¼ˆ<em>åŸå§‹æŒ‡é’ˆ</em>ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼‰å¹¶æ‰§è¡Œæ˜“å¤±æ€§è¯»å–æˆ–å†™å…¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ C ä¸­ä½ å¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">volatile</span> bool signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    signalled <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>signalled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Rust ä¸­çš„ç­‰ä»·ç‰©å°†åœ¨æ¯æ¬¡è®¿é—®æ—¶ä½¿ç”¨ volatile æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    <span class="token comment" spellcheck="true">// (In real code, you should consider a higher level primitive,</span>
    <span class="token comment" spellcheck="true">//  such as an atomic type).</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">!</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SIGNALLED<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»£ç ç¤ºä¾‹ä¸­æœ‰å‡ ç‚¹å€¼å¾—æ³¨æ„ï¼š</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥ä¼ é€’<code>&amp;mut SIGNALLED</code>åˆ°å‡½æ•° requires <code>*mut T</code>ï¼Œå› ä¸º <code>&amp;mut T</code>è‡ªåŠ¨è½¬æ¢ä¸º a <code>*mut T</code>ï¼ˆå¯¹äº<code>*const T</code>ï¼‰</li>
<li>æˆ‘ä»¬éœ€è¦/æ–¹æ³•çš„<code>unsafe</code>å—ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å‡½æ•°ã€‚ç¡®ä¿å®‰å…¨ä½¿ç”¨æ˜¯ç¨‹åºå‘˜çš„è´£ä»»ï¼šæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ–¹æ³•æ–‡æ¡£ã€‚<code>read_volatile``write_volatile``unsafe</code></li>
</ul>
<p>åœ¨æ‚¨çš„ä»£ç ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›å‡½æ•°æ˜¯å¾ˆå°‘è§çš„ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸ä¼šç”±æ›´é«˜çº§åˆ«çš„åº“ä¸ºæ‚¨å¤„ç†ã€‚å¯¹äºå†…å­˜æ˜ å°„å¤–è®¾ï¼Œå¤–è®¾è®¿é—® crate å°†è‡ªåŠ¨å®ç°æ˜“å¤±æ€§è®¿é—®ï¼Œè€Œå¯¹äºå¹¶å‘åŸè¯­ï¼Œæœ‰æ›´å¥½çš„æŠ½è±¡å¯ç”¨ã€‚</p>
<h2 id="å‹ç¼©å’Œå¯¹é½ç±»å‹"><a href="#å‹ç¼©å’Œå¯¹é½ç±»å‹" class="headerlink" title="å‹ç¼©å’Œå¯¹é½ç±»å‹"></a>å‹ç¼©å’Œå¯¹é½ç±»å‹</h2><p>åœ¨åµŒå…¥å¼ C ä¸­ï¼Œé€šå¸¸ä¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸€ä¸ªå˜é‡å¿…é¡»æœ‰ä¸€å®šçš„å¯¹é½æ–¹å¼ï¼Œæˆ–è€…ä¸€ä¸ªç»“æ„å¿…é¡»æ‰“åŒ…è€Œä¸æ˜¯å¯¹é½ï¼Œé€šå¸¸æ˜¯ä¸ºäº†æ»¡è¶³ç‰¹å®šçš„ç¡¬ä»¶æˆ–åè®®è¦æ±‚ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œè¿™ç”±<code>repr</code>ç»“æ„æˆ–è”åˆä¸Šçš„å±æ€§æ§åˆ¶ã€‚é»˜è®¤è¡¨ç¤ºä¸æä¾›å¸ƒå±€ä¿è¯ï¼Œå› æ­¤ä¸åº”ç”¨äºä¸ç¡¬ä»¶æˆ– C äº’æ“ä½œçš„ä»£ç ã€‚ç¼–è¯‘å™¨å¯èƒ½ä¼šé‡æ–°æ’åºç»“æ„æˆå‘˜æˆ–æ’å…¥å¡«å……ï¼Œå¹¶ä¸”è¡Œä¸ºå¯èƒ½ä¼šéšç€ Rust çš„æœªæ¥ç‰ˆæœ¬è€Œæ”¹å˜ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffecb3511d0 0x7ffecb3511d4 0x7ffecb3511d2</span>
<span class="token comment" spellcheck="true">// Note ordering has been changed to x, z, y to improve packing.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ºç¡®ä¿å¸ƒå±€å¯ä¸ C äº’æ“ä½œï¼Œè¯·ä½¿ç”¨<code>repr(C)</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7fffd0d84c60 0x7fffd0d84c62 0x7fffd0d84c64</span>
<span class="token comment" spellcheck="true">// Ordering is preserved and the layout will not change over time.</span>
<span class="token comment" spellcheck="true">// `z` is two-byte aligned so a byte of padding exists between `y` and `z`.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¦ç¡®ä¿æ‰“åŒ…è¡¨ç¤ºï¼Œè¯·ä½¿ç”¨<code>repr(packed)</code>ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(packed)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Unsafe is required to borrow a field of a packed struct.</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffd33598490 0x7ffd33598492 0x7ffd33598493</span>
<span class="token comment" spellcheck="true">// No padding has been inserted between `y` and `z`, so now `z` is unaligned.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯·æ³¨æ„ï¼Œ using<code>repr(packed)</code>è¿˜å°†ç±»å‹çš„å¯¹é½æ–¹å¼è®¾ç½®ä¸º<code>1</code>ã€‚</p>
<p>æœ€åï¼Œè¦æŒ‡å®šç‰¹å®šçš„å¯¹é½æ–¹å¼ï¼Œè¯·ä½¿ç”¨<code>repr(align(n))</code>ï¼Œå…¶ä¸­<code>n</code>æ˜¯è¦å¯¹é½çš„å­—èŠ‚æ•°ï¼ˆå¹¶ä¸”å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼‰ï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[repr(align(4096))]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> u <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffec909a000 0x7ffec909a002 0x7ffec909a004</span>
<span class="token comment" spellcheck="true">// 0x7ffec909b000 0x7ffec909b002 0x7ffec909b004</span>
<span class="token comment" spellcheck="true">// The two instances `u` and `v` have been placed on 4096-byte alignments,</span>
<span class="token comment" spellcheck="true">// evidenced by the `000` at the end of their addresses.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆ<code>repr(C)</code>ä½¿ç”¨<code>repr(align(n))</code>ä»¥è·å¾—å¯¹é½ä¸”ä¸ C å…¼å®¹çš„å¸ƒå±€ã€‚è¿™æ˜¯ä¸å…è®¸çš„ç»“åˆ<code>repr(align(n))</code>æœ‰ <code>repr(packed)</code>ï¼Œå› ä¸º<code>repr(packed)</code>å¥—å¯¹é½<code>1</code>ã€‚ä¸€ä¸ª<code>repr(packed)</code>ç±»å‹ä¹Ÿä¸å…è®¸åŒ…å«ä¸€ä¸ª<code>repr(align(n))</code>ç±»å‹ã€‚</p>
<h2 id="å…¶ä»–èµ„æº"><a href="#å…¶ä»–èµ„æº" class="headerlink" title="å…¶ä»–èµ„æº"></a>å…¶ä»–èµ„æº</h2><ul>
<li><a href="https://docs.rust-embedded.org/faq.html" target="_blank" rel="noopener">Rust åµŒå…¥å¼å¸¸è§é—®é¢˜è§£ç­”</a></li>
<li><a href="http://blahg.josefsipek.net/?p=580" target="_blank" rel="noopener">C ç¨‹åºå‘˜çš„ Rust æŒ‡é’ˆ</a></li>
<li><a href="https://github.com/diwic/reffers-rs/blob/master/docs/Pointers.md" target="_blank" rel="noopener">æˆ‘æ›¾ç»ä½¿ç”¨æŒ‡é’ˆ - ç°åœ¨å‘¢ï¼Ÿ</a></li>
</ul>
<h1 id="Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰"><a href="#Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰" class="headerlink" title="Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰"></a>Interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰</h1><p>Rust å’Œ C ä»£ç ä¹‹é—´çš„äº’æ“ä½œæ€§å§‹ç»ˆä¾èµ–äºä¸¤ç§è¯­è¨€ä¹‹é—´çš„æ•°æ®è½¬æ¢ã€‚ä¸ºæ­¤ç›®çš„ï¼Œåœ¨è¢«<code>stdlib</code>è°ƒç”¨ <a href="https://doc.rust-lang.org/std/ffi/index.html" target="_blank" rel="noopener"><code>std::ffi</code></a>å’Œ ä¸­ æœ‰ä¸¤ä¸ªä¸“ç”¨æ¨¡å—<a href="https://doc.rust-lang.org/std/os/raw/index.html" target="_blank" rel="noopener"><code>std::os::raw</code></a>ã€‚</p>
<p><code>std::os::raw</code> å¤„ç†å¯ä»¥ç”±ç¼–è¯‘å™¨éšå¼è½¬æ¢çš„ä½çº§åŸå§‹ç±»å‹ï¼Œå› ä¸º Rust å’Œ C ä¹‹é—´çš„å†…å­˜å¸ƒå±€è¶³å¤Ÿç›¸ä¼¼æˆ–ç›¸åŒã€‚</p>
<p><code>std::ffi</code>æä¾›äº†ä¸€äº›å®ç”¨ç¨‹åºç”¨äºå°†æ›´åŠ å¤æ‚çš„ç±»å‹ï¼Œå¦‚å¼¦ä¹å™¨ï¼Œæ—¢æ˜ å°„<code>&amp;str</code>å’Œ<code>String</code> å¯¹C-ç±»å‹æ˜¯æ›´å®¹æ˜“å’Œæ›´å®‰å…¨çš„å¤„ç†ã€‚</p>
<p>è¿™äº›æ¨¡å—éƒ½æ²¡æœ‰åœ¨ ä¸­å¯ç”¨<code>core</code>ï¼Œä½†æ˜¯æ‚¨å¯ä»¥åœ¨crate ä¸­æ‰¾åˆ°<code>#![no_std]</code> å…¼å®¹ç‰ˆæœ¬ï¼Œ<code>std::ffi::{CStr,CString}</code>ä»¥åŠ<a href="https://crates.io/crates/cstr_core" target="_blank" rel="noopener"><code>cstr_core</code></a>crate ä¸­çš„å¤§å¤šæ•°<code>std::os::raw</code>ç±»å‹<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>ã€‚</p>
<table>
<thead>
<tr>
<th>é”ˆå‹</th>
<th>ä¸­é—´çš„</th>
<th>Cå‹</th>
</tr>
</thead>
<tbody><tr>
<td>ç»†ç»³</td>
<td>å­—ç¬¦ä¸²</td>
<td>*å­—ç¬¦</td>
</tr>
<tr>
<td>&amp;str</td>
<td>CStr</td>
<td>*å¸¸é‡å­—ç¬¦</td>
</tr>
<tr>
<td>()</td>
<td>c_void</td>
<td>ç©ºç™½</td>
</tr>
<tr>
<td>u32 æˆ– u64</td>
<td>c_uint</td>
<td>æ— ç¬¦å·æ•´æ•°</td>
</tr>
<tr>
<td>ç­‰ç­‰</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p>å¦‚ä¸Šæ‰€è¿°ï¼ŒåŸºæœ¬ç±»å‹å¯ä»¥ç”±ç¼–è¯‘å™¨éšå¼è½¬æ¢ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c_num<span class="token punctuation">:</span> c_uint <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r_num<span class="token punctuation">:</span> u32 <span class="token operator">=</span> c_num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§"><a href="#ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§" class="headerlink" title="ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§"></a>ä¸å…¶ä»–æ„å»ºç³»ç»Ÿçš„äº’æ“ä½œæ€§</h3><p>åœ¨æ‚¨çš„åµŒå…¥å¼é¡¹ç›®ä¸­åŒ…å« Rust çš„ä¸€ä¸ªå¸¸è§è¦æ±‚æ˜¯å°† Cargo ä¸æ‚¨ç°æœ‰çš„æ„å»ºç³»ç»Ÿç›¸ç»“åˆï¼Œä¾‹å¦‚ make æˆ– cmakeã€‚</p>
<p>æˆ‘ä»¬æ­£åœ¨<a href="https://github.com/rust-embedded/book/issues/61" target="_blank" rel="noopener">é—®é¢˜ #61 ä¸­çš„</a>é—®é¢˜è·Ÿè¸ªå™¨ä¸Šä¸ºæ­¤æ”¶é›†ç¤ºä¾‹å’Œç”¨ä¾‹ ã€‚</p>
<h3 id="ä¸-RTOS-çš„äº’æ“ä½œæ€§"><a href="#ä¸-RTOS-çš„äº’æ“ä½œæ€§" class="headerlink" title="ä¸ RTOS çš„äº’æ“ä½œæ€§"></a>ä¸ RTOS çš„äº’æ“ä½œæ€§</h3><p>å°† Rust ä¸è¯¸å¦‚ FreeRTOS æˆ– ChibiOS ä¹‹ç±»çš„ RTOS é›†æˆä»åœ¨è¿›è¡Œä¸­ï¼›å°¤å…¶æ˜¯ä» Rust è°ƒç”¨ RTOS å‡½æ•°å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ã€‚</p>
<p>æˆ‘ä»¬æ­£åœ¨<a href="https://github.com/rust-embedded/book/issues/62" target="_blank" rel="noopener">é—®é¢˜ #62 ä¸­çš„</a>é—®é¢˜è·Ÿè¸ªå™¨ä¸Šä¸ºæ­¤æ”¶é›†ç¤ºä¾‹å’Œç”¨ä¾‹ ã€‚</p>
<h2 id="A-little-C-with-your-Rust"><a href="#A-little-C-with-your-Rust" class="headerlink" title="A little C with your Rust"></a>A little C with your Rust</h2><p>åœ¨ Rust é¡¹ç›®ä¸­ä½¿ç”¨ C æˆ– C++ åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>
<ul>
<li>åŒ…è£…æš´éœ²çš„ C API ä»¥ä¸ Rust ä¸€èµ·ä½¿ç”¨</li>
<li>æ„å»ºæ‚¨çš„ C æˆ– C++ ä»£ç ä»¥ä¸ Rust ä»£ç é›†æˆ</li>
</ul>
<p>ç”±äº C++ æ²¡æœ‰ç¨³å®šçš„ ABI ä¾› Rust ç¼–è¯‘å™¨ä½œä¸ºç›®æ ‡ï¼Œå› æ­¤å»ºè®®<code>C</code>åœ¨å°† Rust ä¸ C æˆ– C++ ç»“åˆä½¿ç”¨æ—¶ä½¿ç”¨ABIã€‚</p>
<h3 id="å®šä¹‰æ¥å£"><a href="#å®šä¹‰æ¥å£" class="headerlink" title="å®šä¹‰æ¥å£"></a>å®šä¹‰æ¥å£</h3><p>åœ¨ä» Rust ä½¿ç”¨ C æˆ– C++ ä»£ç ä¹‹å‰ï¼Œæœ‰å¿…è¦å®šä¹‰ï¼ˆåœ¨ Rust ä¸­ï¼‰é“¾æ¥ä»£ç ä¸­å­˜åœ¨å“ªäº›æ•°æ®ç±»å‹å’Œå‡½æ•°ç­¾åã€‚åœ¨ C æˆ– C++ ä¸­ï¼Œæ‚¨å°†åŒ…å«å®šä¹‰æ­¤æ•°æ®çš„å¤´ (<code>.h</code>æˆ–<code>.hpp</code>) æ–‡ä»¶ã€‚åœ¨ Rust ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å°†è¿™äº›å®šä¹‰è½¬æ¢ä¸º Rustï¼Œæˆ–è€…ä½¿ç”¨å·¥å…·ç”Ÿæˆè¿™äº›å®šä¹‰ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»‹ç»å°†è¿™äº›å®šä¹‰ä» C/C++ æ‰‹åŠ¨è½¬æ¢ä¸º Rustã€‚</p>
<h4 id="åŒ…è£…-C-å‡½æ•°å’Œæ•°æ®ç±»å‹"><a href="#åŒ…è£…-C-å‡½æ•°å’Œæ•°æ®ç±»å‹" class="headerlink" title="åŒ…è£… C å‡½æ•°å’Œæ•°æ®ç±»å‹"></a>åŒ…è£… C å‡½æ•°å’Œæ•°æ®ç±»å‹</h4><p>é€šå¸¸ï¼Œç”¨ C æˆ– C++ ç¼–å†™çš„åº“å°†æä¾›ä¸€ä¸ªå®šä¹‰å…¬å…±æ¥å£ä¸­ä½¿ç”¨çš„æ‰€æœ‰ç±»å‹å’Œå‡½æ•°çš„å¤´æ–‡ä»¶ã€‚ç¤ºä¾‹æ–‡ä»¶å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-C"><code class="language-C">/* File: cool.h */
typedef struct CoolStruct {
    int x;
    int y;
} CoolStruct;

void cool_function(int i, char c, CoolStruct* cs);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“è½¬æ¢ä¸º Rust æ—¶ï¼Œæ­¤ç•Œé¢å°†å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/* File: cool_bindings.rs */</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span>
    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è®©æˆ‘ä»¬ä¸€æ¬¡ä¸€ä¸ªåœ°çœ‹ä¸€ä¸‹è¿™ä¸ªå®šä¹‰ï¼Œä»¥è§£é‡Šæ¯ä¸ªéƒ¨åˆ†ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust ä¸ä¿è¯åŒ…å«åœ¨<code>struct</code>. ä¸ºäº†ä¿è¯ä¸ C ä»£ç çš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬åŒ…å«äº†<code>#[repr(C)]</code>å±æ€§ï¼Œå®ƒæŒ‡ç¤º Rust ç¼–è¯‘å™¨å§‹ç»ˆä½¿ç”¨ C åœ¨ç»“æ„ä¸­ç»„ç»‡æ•°æ®çš„ç›¸åŒè§„åˆ™ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç”±äº C æˆ– C++ å®šä¹‰<code>int</code>or çš„æ–¹å¼çš„çµæ´»æ€§ï¼Œ<code>char</code>å»ºè®®ä½¿ç”¨ ä¸­å®šä¹‰çš„åŸå§‹æ•°æ®ç±»å‹<code>cty</code>ï¼Œå®ƒå°†ç±»å‹ä» C æ˜ å°„åˆ° Rust ä¸­çš„ç±»å‹ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span> <span class="token punctuation">...</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ­¤è¯­å¥å®šä¹‰äº†ä½¿ç”¨ C ABI çš„å‡½æ•°çš„ç­¾åï¼Œç§°ä¸º<code>cool_function</code>. é€šè¿‡å®šä¹‰ç­¾åè€Œä¸å®šä¹‰å‡½æ•°ä½“ï¼Œè¿™ä¸ªå‡½æ•°çš„å®šä¹‰éœ€è¦åœ¨åˆ«å¤„æä¾›ï¼Œæˆ–è€…ä»é™æ€åº“é“¾æ¥åˆ°æœ€ç»ˆåº“æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust">    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä¸æˆ‘ä»¬ä¸Šé¢çš„æ•°æ®ç±»å‹ç±»ä¼¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ C å…¼å®¹å®šä¹‰æ¥å®šä¹‰å‡½æ•°å‚æ•°çš„æ•°æ®ç±»å‹ã€‚ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬è¿˜ä¿ç•™äº†ç›¸åŒçš„å‚æ•°åç§°ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œæœ‰ä¸€ç§æ–°ç±»å‹ï¼Œ<code>*mut CoolStruct</code>. ç”±äº C æ²¡æœ‰ Rust å¼•ç”¨çš„æ¦‚å¿µï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š<code>&amp;mut CoolStruct</code>ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå§‹æŒ‡é’ˆã€‚ç”±äºå–æ¶ˆå¼•ç”¨æ­¤æŒ‡é’ˆæ˜¯<code>unsafe</code>ï¼Œå¹¶ä¸”è¯¥æŒ‡é’ˆå®é™…ä¸Šå¯èƒ½æ˜¯ä¸€ä¸ª<code>null</code>æŒ‡é’ˆï¼Œå› æ­¤åœ¨ä¸ C æˆ– C++ ä»£ç äº¤äº’æ—¶å¿…é¡»æ³¨æ„ç¡®ä¿ Rust çš„å…¸å‹ä¿è¯ã€‚</p>
<h4 id="è‡ªåŠ¨ç”Ÿæˆç•Œé¢"><a href="#è‡ªåŠ¨ç”Ÿæˆç•Œé¢" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆç•Œé¢"></a>è‡ªåŠ¨ç”Ÿæˆç•Œé¢</h4><p>æœ‰ä¸€ä¸ªåä¸º<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>çš„å·¥å…·å¯ä»¥è‡ªåŠ¨æ‰§è¡Œè¿™äº›è½¬æ¢ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç”Ÿæˆè¿™äº›æ¥å£ï¼Œè¿™å¯èƒ½å¾ˆä¹å‘³ä¸”å®¹æ˜“å‡ºé”™ã€‚æœ‰å…³<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>çš„ä½¿ç”¨<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">è¯´æ˜</a>ï¼Œè¯·å‚é˜…<a href="https://rust-lang.github.io/rust-bindgen/" target="_blank" rel="noopener">bindgen ç”¨æˆ·æ‰‹å†Œ</a>ï¼Œä½†å…¸å‹çš„è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>æ”¶é›†æ‰€æœ‰ C æˆ– C++ å¤´æ–‡ä»¶ï¼Œå®šä¹‰ä½ æƒ³ä¸ Rust ä¸€èµ·ä½¿ç”¨çš„æ¥å£æˆ–æ•°æ®ç±»å‹ã€‚</li>
<li>ç¼–å†™ä¸€ä¸ª<code>bindings.h</code>æ–‡ä»¶ï¼Œå®ƒ<code>#include "..."</code>æ˜¯æ‚¨åœ¨ç¬¬ä¸€æ­¥ä¸­æ”¶é›†çš„æ¯ä¸ªæ–‡ä»¶ã€‚</li>
<li>æä¾›æ­¤<code>bindings.h</code>æ–‡ä»¶ä»¥åŠç”¨äºå°†ä»£ç ç¼–è¯‘ä¸º<code>bindgen</code>. æç¤ºï¼šä½¿ç”¨<code>Builder.ctypes_prefix("cty")</code>/ <code>--ctypes-prefix=cty</code>å’Œ<code>Builder.use_core()</code>/<code>--use-core</code>ä½¿ç”Ÿæˆçš„ä»£ç <code>#![no_std]</code>å…¼å®¹ã€‚</li>
<li><code>bindgen</code>å°†ç”Ÿæˆç”Ÿæˆçš„ Rust ä»£ç åˆ°ç»ˆç«¯çª—å£çš„è¾“å‡ºã€‚æ­¤æ–‡ä»¶å¯èƒ½ä¼šé€šè¿‡ç®¡é“ä¼ è¾“åˆ°é¡¹ç›®ä¸­çš„æ–‡ä»¶ï¼Œä¾‹å¦‚<code>bindings.rs</code>. ä½ å¯ä»¥åœ¨ä½ çš„ Rust é¡¹ç›®ä¸­ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥ä¸ç¼–è¯‘å’Œé“¾æ¥ä¸ºå¤–éƒ¨åº“çš„ C/C++ ä»£ç äº¤äº’ã€‚æç¤ºï¼š<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>å¦‚æœç”Ÿæˆçš„ç»‘å®šä¸­çš„ç±»å‹å¸¦æœ‰å‰ç¼€ï¼Œè¯·ä¸è¦å¿˜è®°ä½¿ç”¨crate <code>cty</code>ã€‚</li>
</ol>
<h3 id="æ„å»ºæ‚¨çš„-C-C-ä»£ç "><a href="#æ„å»ºæ‚¨çš„-C-C-ä»£ç " class="headerlink" title="æ„å»ºæ‚¨çš„ C/C++ ä»£ç "></a>æ„å»ºæ‚¨çš„ C/C++ ä»£ç </h3><p>ç”±äº Rust ç¼–è¯‘å™¨ä¸ç›´æ¥çŸ¥é“å¦‚ä½•ç¼–è¯‘ C æˆ– C++ ä»£ç ï¼ˆæˆ–æ¥è‡ªä»»ä½•å…¶ä»–è¯­è¨€çš„ä»£ç ï¼Œæä¾› C æ¥å£ï¼‰ï¼Œå› æ­¤æœ‰å¿…è¦æå‰ç¼–è¯‘æ‚¨çš„é Rust ä»£ç ã€‚</p>
<p>å¯¹äºåµŒå…¥å¼é¡¹ç›®ï¼Œè¿™é€šå¸¸æ„å‘³ç€å°† C/C++ ä»£ç ç¼–è¯‘ä¸ºé™æ€å­˜æ¡£ï¼ˆä¾‹å¦‚<code>cool-library.a</code>ï¼‰ï¼Œç„¶åå¯ä»¥åœ¨æœ€åçš„é“¾æ¥æ­¥éª¤ä¸­å°†å…¶ä¸ Rust ä»£ç ç»“åˆã€‚</p>
<p>å¦‚æœæ‚¨è¦ä½¿ç”¨çš„åº“å·²ä½œä¸ºé™æ€å­˜æ¡£åˆ†å‘ï¼Œåˆ™æ— éœ€é‡æ–°æ„å»ºä»£ç ã€‚åªéœ€å¦‚ä¸Šæ‰€è¿°è½¬æ¢æä¾›çš„æ¥å£å¤´æ–‡ä»¶ï¼Œå¹¶åœ¨ç¼–è¯‘/é“¾æ¥æ—¶åŒ…å«é™æ€å­˜æ¡£ã€‚</p>
<p>å¦‚æœä»£ç å­˜åœ¨ä½œä¸ºæºé¡¹ç›®ï¼Œè¿™å°†æ˜¯å¿…è¦ç¼–è¯‘C / C ++ä»£ç åˆ°é™æ€åº“ï¼Œæˆ–è€…é€šè¿‡è§¦å‘ç°æœ‰æ„å»ºç³»ç»Ÿï¼ˆå¦‚<code>make</code>ï¼Œ<code>CMake</code>ç­‰ï¼‰ï¼Œæˆ–é€šè¿‡ç§»æ¤å¿…è¦çš„ç¼–è¯‘æ­¥éª¤ï¼Œä½¿ç”¨ä¸€ç§å«åš<code>cc</code>æ¿æ¡ç®±çš„å·¥å…·ã€‚å¯¹äºè¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œéƒ½éœ€è¦ä½¿ç”¨<code>build.rs</code>è„šæœ¬ã€‚</p>
<h4 id="Rustbuild-rsæ„å»ºè„šæœ¬"><a href="#Rustbuild-rsæ„å»ºè„šæœ¬" class="headerlink" title="Rustbuild.rsæ„å»ºè„šæœ¬"></a>Rust<code>build.rs</code>æ„å»ºè„šæœ¬</h4><p>ä¸€ä¸ª<code>build.rs</code>è„šæœ¬æ˜¯å†™åœ¨é²æ–¯ç‰¹è¯­æ³•çš„æ–‡ä»¶ï¼Œé‚£æ˜¯ä½ çš„ç¼–è¯‘æœºä¸Šè¿è¡Œåï¼Œä½ çš„é¡¹ç›®çš„ä¾èµ–å·²å»ºæˆï¼Œä½†åœ¨æ­¤ä¹‹å‰é¡¹ç›®çš„ç”Ÿæˆã€‚</p>
<p>å®Œæ•´çš„å‚è€ƒå¯ä»¥åœ¨<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚<code>build.rs</code>è„šæœ¬å¯¹äºç”Ÿæˆä»£ç ï¼ˆä¾‹å¦‚é€šè¿‡<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>ï¼‰ã€è°ƒç”¨å¤–éƒ¨æ„å»ºç³»ç»Ÿï¼ˆä¾‹å¦‚<code>Make</code>ï¼‰æˆ–é€šè¿‡ä½¿ç”¨<code>cc</code>crateç›´æ¥ç¼–è¯‘ C/C++ éå¸¸æœ‰ç”¨ã€‚</p>
<h4 id="è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ"><a href="#è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ" class="headerlink" title="è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ"></a>è§¦å‘å¤–éƒ¨æ„å»ºç³»ç»Ÿ</h4><p>å¯¹äºå…·æœ‰å¤æ‚å¤–éƒ¨é¡¹ç›®æˆ–æ„å»ºç³»ç»Ÿçš„é¡¹ç›®ï¼Œ<a href="https://doc.rust-lang.org/std/process/struct.Command.html" target="_blank" rel="noopener"><code>std::process::Command</code></a>é€šè¿‡éå†ç›¸å¯¹è·¯å¾„ã€è°ƒç”¨å›ºå®šå‘½ä»¤ï¼ˆä¾‹å¦‚<code>make library</code>ï¼‰ï¼Œç„¶åå°†ç”Ÿæˆçš„é™æ€åº“å¤åˆ¶åˆ°é€‚å½“çš„åœ¨<code>target</code>æ„å»ºç›®å½•ä¸­çš„ä½ç½®ã€‚</p>
<p>è™½ç„¶æ‚¨çš„ crate å¯èƒ½é’ˆå¯¹<code>no_std</code>åµŒå…¥å¼å¹³å°ï¼Œä½†æ‚¨<code>build.rs</code>åªèƒ½åœ¨ç¼–è¯‘ crate çš„æœºå™¨ä¸Šæ‰§è¡Œã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿ç”¨å°†åœ¨æ‚¨çš„ç¼–è¯‘ä¸»æœºä¸Šè¿è¡Œçš„ä»»ä½• Rust crateã€‚</p>
<h4 id="ä½¿ç”¨cccrateæ„å»º-C-C-ä»£ç "><a href="#ä½¿ç”¨cccrateæ„å»º-C-C-ä»£ç " class="headerlink" title="ä½¿ç”¨cccrateæ„å»º C/C++ ä»£ç "></a>ä½¿ç”¨<code>cc</code>crateæ„å»º C/C++ ä»£ç </h4><p>å¯¹äºä¾èµ–é¡¹æˆ–å¤æ‚æ€§æœ‰é™çš„é¡¹ç›®ï¼Œæˆ–è€…å¯¹äºéš¾ä»¥ä¿®æ”¹æ„å»ºç³»ç»Ÿä»¥ç”Ÿæˆé™æ€åº“ï¼ˆè€Œä¸æ˜¯æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼‰çš„é¡¹ç›®ï¼Œä½¿ç”¨<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>å¯èƒ½æ›´å®¹æ˜“ï¼Œå®ƒæä¾›äº†æƒ¯ç”¨çš„ Rustä¸»æœºæä¾›çš„ç¼–è¯‘å™¨æ¥å£ã€‚</p>
<p>åœ¨å°†å•ä¸ª C æ–‡ä»¶ç¼–è¯‘ä¸ºé™æ€åº“çš„ä¾èµ–é¡¹çš„æœ€ç®€å•æƒ…å†µä¸‹ï¼Œ<code>build.rs</code>ä½¿ç”¨<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>çš„ç¤ºä¾‹è„šæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> cc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cc<span class="token punctuation">:</span><span class="token punctuation">:</span>Build<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"foo.c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"libfoo.a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="A-little-Rust-with-your-C"><a href="#A-little-Rust-with-your-C" class="headerlink" title="A little Rust with your C"></a>A little Rust with your C</h2><p>åœ¨ C æˆ– C++ é¡¹ç›®ä¸­ä½¿ç”¨ Rust ä»£ç ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚</p>
<ul>
<li>åœ¨ Rust ä¸­åˆ›å»ºä¸€ä¸ª C å‹å¥½çš„ API</li>
<li>å°†æ‚¨çš„ Rust é¡¹ç›®åµŒå…¥åˆ°å¤–éƒ¨æ„å»ºç³»ç»Ÿä¸­</li>
</ul>
<p>é™¤äº†<code>cargo</code>andä¹‹å¤–<code>meson</code>ï¼Œå¤§å¤šæ•°æ„å»ºç³»ç»Ÿéƒ½æ²¡æœ‰åŸç”Ÿçš„ Rust æ”¯æŒã€‚å› æ­¤ï¼Œæ‚¨å¾ˆå¯èƒ½æœ€å¥½ä»…<code>cargo</code>ç”¨äºç¼–è¯‘æ‚¨çš„ crate å’Œä»»ä½•ä¾èµ–é¡¹ã€‚</p>
<h3 id="è®¾ç½®é¡¹ç›®"><a href="#è®¾ç½®é¡¹ç›®" class="headerlink" title="è®¾ç½®é¡¹ç›®"></a>è®¾ç½®é¡¹ç›®</h3><p><code>cargo</code>åƒå¾€å¸¸ä¸€æ ·åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚</p>
<p>æœ‰ä¸€äº›æ ‡å¿—å‘Šè¯‰<code>cargo</code>å‘å‡ºä¸€ä¸ªç³»ç»Ÿåº“ï¼Œè€Œä¸æ˜¯å®ƒçš„å¸¸è§„ rust ç›®æ ‡ã€‚è¿™ä¹Ÿå…è®¸æ‚¨ä¸ºåº“è®¾ç½®ä¸åŒçš„è¾“å‡ºåç§°ï¼Œå¦‚æœæ‚¨å¸Œæœ›å®ƒä¸æ‚¨çš„ crate çš„å…¶ä½™éƒ¨åˆ†ä¸åŒã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[lib]
name = "your_crate"
crate-type = ["cdylib"]      # Creates dynamic lib
# crate-type = ["staticlib"] # Creates static lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="æ„å»ºCAPI"><a href="#æ„å»ºCAPI" class="headerlink" title="æ„å»ºCAPI"></a>æ„å»º<code>C</code>API</h3><p>å› ä¸º C++ æ²¡æœ‰ç¨³å®šçš„ ABI ä¾› Rust ç¼–è¯‘å™¨ä½œä¸ºç›®æ ‡ï¼Œæˆ‘ä»¬<code>C</code>ç”¨äºä¸åŒè¯­è¨€ä¹‹é—´çš„ä»»ä½•äº’æ“ä½œæ€§ã€‚åœ¨ C å’Œ C++ ä»£ç ä¸­ä½¿ç”¨ Rust æ—¶ä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<h4 id="no-mangle"><a href="#no-mangle" class="headerlink" title="#[no_mangle\]"></a><code>#[no_mangle\]</code></h4><p>Rust ç¼–è¯‘å™¨å¯¹ç¬¦å·åç§°çš„å¤„ç†ä¸æœ¬æœºä»£ç é“¾æ¥å™¨æ‰€æœŸæœ›çš„ä¸åŒã€‚å› æ­¤ï¼Œä»»ä½• Rust å¯¼å‡ºä»¥åœ¨ Rust ä¹‹å¤–ä½¿ç”¨çš„å‡½æ•°éƒ½éœ€è¦è¢«å‘ŠçŸ¥ä¸è¦è¢«ç¼–è¯‘å™¨ç ´åã€‚</p>
<h4 id="extern-quot-C-quot"><a href="#extern-quot-C-quot" class="headerlink" title="extern &quot;C&quot;"></a><code>extern "C"</code></h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨åœ¨ Rust ä¸­ç¼–å†™çš„ä»»ä½•å‡½æ•°éƒ½å°†ä½¿ç”¨ Rust ABIï¼ˆå®ƒä¹Ÿä¸ç¨³å®šï¼‰ã€‚ç›¸åï¼Œåœ¨æ„å»ºé¢å‘å¤–éƒ¨çš„ FFI API æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨ä½¿ç”¨ç³»ç»Ÿ ABIã€‚</p>
<p>æ ¹æ®æ‚¨çš„å¹³å°ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é’ˆå¯¹ç‰¹å®šçš„ ABI ç‰ˆæœ¬ï¼Œ<a href="https://doc.rust-lang.org/reference/items/external-blocks.html" target="_blank" rel="noopener">æ­¤å¤„</a>è®°å½•äº†è¿™äº›ç‰ˆæœ¬ã€‚</p>
<hr>
<p>å°†è¿™äº›éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ï¼Œæ‚¨ä¼šå¾—åˆ°ä¸€ä¸ªå¤§è‡´å¦‚ä¸‹æ‰€ç¤ºçš„å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°±åƒ<code>C</code>åœ¨æ‚¨çš„ Rust é¡¹ç›®ä¸­ä½¿ç”¨ä»£ç ä¸€æ ·ï¼Œæ‚¨ç°åœ¨éœ€è¦å°†æ•°æ®ä»åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†å¯ä»¥ç†è§£çš„å½¢å¼æ¥å›è½¬æ¢ã€‚</p>
<h3 id="é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯"><a href="#é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯" class="headerlink" title="é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯"></a>é“¾æ¥å’Œæ›´å¤§çš„é¡¹ç›®èƒŒæ™¯</h3><p>é‚£ä¹ˆï¼Œé—®é¢˜å°±è§£å†³äº†ä¸€åŠã€‚ä½ ç°åœ¨æ€ä¹ˆç”¨è¿™ä¸ªï¼Ÿ</p>
<p><strong>è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ‚¨çš„é¡¹ç›®å’Œ/æˆ–æ„å»ºç³»ç»Ÿ</strong></p>
<p><code>cargo</code>å°†åˆ›å»ºä¸€ä¸ª<code>my_lib.so</code>/<code>my_lib.dll</code>æˆ–<code>my_lib.a</code>æ–‡ä»¶ï¼Œå…·ä½“å–å†³äºæ‚¨çš„å¹³å°å’Œè®¾ç½®ã€‚è¿™ä¸ªåº“å¯ä»¥ç®€å•åœ°ç”±ä½ çš„æ„å»ºç³»ç»Ÿé“¾æ¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œä» C è°ƒç”¨ Rust å‡½æ•°éœ€è¦ä¸€ä¸ªå¤´æ–‡ä»¶æ¥å£°æ˜å‡½æ•°ç­¾åã€‚</p>
<p>Rust-ffi API ä¸­çš„æ¯ä¸ªå‡½æ•°éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„å¤´å‡½æ•°ã€‚</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç„¶åä¼šå˜æˆ</p>
<pre class="line-numbers language-C"><code class="language-C">void rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç­‰ç­‰ã€‚</p>
<p>æœ‰ä¸€ä¸ªå·¥å…·å¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ­¤è¿‡ç¨‹ï¼Œç§°ä¸º<a href="https://github.com/eqrion/cbindgen" target="_blank" rel="noopener">cbindgen</a>ï¼Œå®ƒä¼šåˆ†ææ‚¨çš„ Rust ä»£ç ï¼Œç„¶åä»ä¸­ç”Ÿæˆ C å’Œ C++ é¡¹ç›®çš„æ ‡å¤´ã€‚</p>
<p>æ­¤æ—¶ï¼Œä½¿ç”¨ C ä¸­çš„ Rust å‡½æ•°å°±åƒåŒ…å«æ ‡å¤´å¹¶è°ƒç”¨å®ƒä»¬ä¸€æ ·ç®€å•ï¼</p>
<pre class="line-numbers language-C"><code class="language-C">#include "my-rust-project.h"
rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Optimizations-the-speed-size-tradeoff"><a href="#Optimizations-the-speed-size-tradeoff" class="headerlink" title="Optimizations: the speed size tradeoff"></a>Optimizations: the speed size tradeoff</h1><p>æ¯ä¸ªäººéƒ½å¸Œæœ›ä»–ä»¬çš„ç¨‹åºè¶…å¿«å’Œè¶…å°ï¼Œä½†é€šå¸¸ä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰è¿™ä¸¤ç§ç‰¹æ€§ã€‚æœ¬èŠ‚è®¨è®ºæä¾›çš„ä¸åŒä¼˜åŒ–çº§åˆ«<code>rustc</code>ä»¥åŠå®ƒä»¬å¦‚ä½•å½±å“ç¨‹åºçš„æ‰§è¡Œæ—¶é—´å’ŒäºŒè¿›åˆ¶å¤§å°ã€‚</p>
<h2 id="æ²¡æœ‰ä¼˜åŒ–"><a href="#æ²¡æœ‰ä¼˜åŒ–" class="headerlink" title="æ²¡æœ‰ä¼˜åŒ–"></a>æ²¡æœ‰ä¼˜åŒ–</h2><p>è¿™æ˜¯é»˜è®¤è®¾ç½®ã€‚å½“æ‚¨æ‰“ç”µè¯æ—¶ï¼Œ<code>cargo build</code>æ‚¨ä½¿ç”¨å¼€å‘ (AKA <code>dev</code>) é…ç½®æ–‡ä»¶ã€‚æ­¤é…ç½®æ–‡ä»¶é’ˆå¯¹è°ƒè¯•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå› æ­¤å®ƒå¯ç”¨è°ƒè¯•ä¿¡æ¯ï¼Œä½†<em>ä¸</em>å¯ç”¨ä»»ä½•ä¼˜åŒ–ï¼Œå³å®ƒä½¿ç”¨<code>-C opt-level = 0</code>.</p>
<p>è‡³å°‘å¯¹äºè£¸æœºå¼€å‘è€Œè¨€ï¼Œdebuginfo æ˜¯é›¶æˆæœ¬çš„ï¼Œå› ä¸ºå®ƒä¸ä¼šå ç”¨ Flash / ROM ä¸­çš„ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬å®é™…ä¸Šå»ºè®®æ‚¨åœ¨å‘å¸ƒé…ç½®æ–‡ä»¶ä¸­å¯ç”¨ debuginfo â€“ é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨å®ƒã€‚è¿™å°†å…è®¸æ‚¨åœ¨è°ƒè¯•å‘å¸ƒç‰ˆæœ¬æ—¶ä½¿ç”¨æ–­ç‚¹ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# symbols are nice and they don't increase the size on Flash
debug = true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>æ²¡æœ‰ä¼˜åŒ–å¯¹äºè°ƒè¯•æ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œå› ä¸ºå•æ­¥è°ƒè¯•ä»£ç æ„Ÿè§‰å°±åƒä½ åœ¨é€æ¡è¯­å¥æ‰§è¡Œç¨‹åºï¼Œè€Œä¸”ä½ å¯ä»¥<code>print</code> åœ¨ GDB ä¸­å †å å˜é‡å’Œå‡½æ•°å‚æ•°ã€‚ä»£ç ä¼˜åŒ–åï¼Œå°è¯•æ‰“å°å˜é‡ä¼šå¯¼è‡´<code>$0 = &lt;value optimized out&gt;</code>æ‰“å°ã€‚</p>
<p><code>dev</code>é…ç½®æ–‡ä»¶çš„æœ€å¤§ç¼ºç‚¹æ˜¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¼šå¾ˆå¤§è€Œä¸”å¾ˆæ…¢ã€‚å¤§å°é€šå¸¸æ›´æˆé—®é¢˜ï¼Œå› ä¸ºæœªä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½å ç”¨æ•°å KiB çš„é—ªå­˜ï¼Œè€Œæ‚¨çš„ç›®æ ‡è®¾å¤‡å¯èƒ½æ²¡æœ‰â€”â€”ç»“æœï¼šæœªä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸é€‚åˆæ‚¨çš„è®¾å¤‡ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥æœ‰æ›´å°çš„ã€è°ƒè¯•å™¨å‹å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å—ï¼Ÿæ˜¯çš„ï¼Œæœ‰ä¸€ä¸ªæŠ€å·§ã€‚</p>
<h3 id="ä¼˜åŒ–ä¾èµ–"><a href="#ä¼˜åŒ–ä¾èµ–" class="headerlink" title="ä¼˜åŒ–ä¾èµ–"></a>ä¼˜åŒ–ä¾èµ–</h3><p>æœ‰ä¸€ä¸ªåä¸º Cargo çš„åŠŸèƒ½<a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides" target="_blank" rel="noopener"><code>profile-overrides</code></a>ï¼Œå¯è®©æ‚¨è¦†ç›–ä¾èµ–é¡¹çš„ä¼˜åŒ–çº§åˆ«ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¯¥åŠŸèƒ½æ¥ä¼˜åŒ–æ‰€æœ‰ä¾èµ–é¡¹çš„å¤§å°ï¼ŒåŒæ—¶ä¿æŒ top crate æœªä¼˜åŒ–å’Œè°ƒè¯•å™¨å‹å¥½ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml"># Cargo.toml
[package]
name = "app"
# ..

[profile.dev.package."*"] # +
opt-level = "z" # +<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ²¡æœ‰è¦†ç›–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 9060   0x8000400
.rodata               1708   0x8002780
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨è¦†ç›–ï¼š</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 3490   0x8000400
.rodata               1100   0x80011c0
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ„å‘³ç€ Flash ä½¿ç”¨é‡å‡å°‘äº† 6 KiBï¼Œè€Œ top crate çš„å¯è°ƒè¯•æ€§æ²¡æœ‰ä»»ä½•æŸå¤±ã€‚å¦‚æœæ‚¨è¿›å…¥ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆæ‚¨å°†<code>&lt;value optimized out&gt;</code>å†æ¬¡å¼€å§‹çœ‹åˆ°è¿™äº› æ¶ˆæ¯ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨æƒ³è¦è°ƒè¯•é¡¶çº§æ¿æ¡ç®±è€Œä¸æ˜¯ä¾èµ–é¡¹ã€‚å¦‚æœæ‚¨<em>ç¡®å®</em>éœ€è¦è°ƒè¯•ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨è¯¥<code>profile-overrides</code>åŠŸèƒ½ä»ä¼˜åŒ–ä¸­æ’é™¤ç‰¹å®šçš„ä¾èµ–é¡¹ã€‚è¯·å‚é˜…ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-toml"><code class="language-toml"># ..

# don't optimize the `cortex-m-rt` crate
[profile.dev.package.cortex-m-rt] # +
opt-level = 0 # +

# but do optimize all the other dependencies
[profile.dev.package."*"]
codegen-units = 1 # better optimizations
opt-level = "z"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç°åœ¨é¡¶éƒ¨æ¿æ¡ç®±å’Œ<code>cortex-m-rt</code>è°ƒè¯•å™¨å‹å¥½ï¼</p>
<h2 id="ä¼˜åŒ–é€Ÿåº¦"><a href="#ä¼˜åŒ–é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–é€Ÿåº¦"></a>ä¼˜åŒ–é€Ÿåº¦</h2><p>æˆªè‡³ 2018 å¹´ 9 æœˆ 18 æ—¥ï¼Œ<code>rustc</code>æ”¯æŒä¸‰ä¸ªâ€œä¼˜åŒ–é€Ÿåº¦â€çº§åˆ«ï¼š<code>opt-level = 1</code>ã€<code>2</code>å’Œ<code>3</code>ã€‚å½“æ‚¨è¿è¡Œæ—¶ï¼Œ<code>cargo build --release</code>æ‚¨ä½¿ç”¨çš„æ˜¯é»˜è®¤ä¸º<code>opt-level = 3</code>.</p>
<p><code>opt-level = 2</code>å’Œéƒ½<code>3</code>ä»¥ç‰ºç‰²äºŒè¿›åˆ¶å¤§å°ä¸ºä»£ä»·æ¥ä¼˜åŒ–é€Ÿåº¦ï¼Œä½† level<code>3</code>æ¯” level æ‰§è¡Œæ›´å¤šçš„çŸ¢é‡åŒ–å’Œå†…è”<code>2</code>ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‚¨ä¼šçœ‹åˆ° at<code>opt-level</code>ç­‰äºæˆ–å¤§äº<code>2</code>LLVM å°†å±•å¼€å¾ªç¯ã€‚å¾ªç¯å±•å¼€åœ¨ Flash / ROM æ–¹é¢çš„æˆæœ¬ç›¸å½“é«˜ï¼ˆä¾‹å¦‚ï¼Œä» 26 å­—èŠ‚åˆ° 194 ä»¥å®ç°é›¶æ•°ç»„å¾ªç¯ï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨ç»™å®šæ­£ç¡®æ¡ä»¶çš„æƒ…å†µä¸‹å°†æ‰§è¡Œæ—¶é—´å‡åŠï¼ˆä¾‹å¦‚ï¼Œè¿­ä»£æ¬¡æ•°è¶³å¤Ÿå¤§ï¼‰ã€‚</p>
<p>ç›®å‰æ²¡æœ‰åŠæ³•ç¦ç”¨å¾ªç¯å±•å¼€<code>opt-level = 2</code>ï¼Œ<code>3</code>æ‰€ä»¥å¦‚æœä½ è´Ÿæ‹…ä¸èµ·å®ƒçš„æˆæœ¬ï¼Œä½ åº”è¯¥ä¼˜åŒ–ä½ çš„ç¨‹åºçš„å¤§å°ã€‚</p>
<h2 id="ä¼˜åŒ–å°ºå¯¸"><a href="#ä¼˜åŒ–å°ºå¯¸" class="headerlink" title="ä¼˜åŒ–å°ºå¯¸"></a>ä¼˜åŒ–å°ºå¯¸</h2><p>æˆªè‡³ 2018 å¹´ 9 æœˆ 18 æ—¥ï¼Œ<code>rustc</code>æ”¯æŒä¸¤ä¸ªâ€œä¼˜åŒ–å¤§å°â€çº§åˆ«ï¼š<code>opt-level = "s"</code>å’Œ<code>"z"</code>. è¿™äº›åç§°æ˜¯ä» clang/LLVM ç»§æ‰¿è€Œæ¥çš„ï¼Œå¹¶ä¸å¤ªå…·æœ‰æè¿°æ€§ï¼Œä½†<code>"z"</code>æ—¨åœ¨è¯´æ˜å®ƒç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ¯”<code>"s"</code>.</p>
<p>å¦‚æœæ‚¨å¸Œæœ›é’ˆå¯¹å¤§å°ä¼˜åŒ–å‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶<code>profile.release.opt-level</code>ï¼Œè¯·<code>Cargo.toml</code>æŒ‰å¦‚ä¸‹æ‰€ç¤ºæ›´æ”¹ è®¾ç½®ã€‚</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# or "z"
opt-level = "s"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸¤ä¸ªä¼˜åŒ–çº§åˆ«å¤§å¤§é™ä½äº† LLVM çš„å†…è”é˜ˆå€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºå†³å®šæ˜¯å¦å†…è”å‡½æ•°çš„æŒ‡æ ‡ã€‚Rust åŸåˆ™ä¹‹ä¸€æ˜¯é›¶æˆæœ¬æŠ½è±¡ï¼›è¿™äº›æŠ½è±¡å€¾å‘äºä½¿ç”¨è®¸å¤šæ–°ç±»å‹å’Œå°å‡½æ•°æ¥ä¿å­˜ä¸å˜é‡ï¼ˆä¾‹å¦‚ï¼Œå€Ÿç”¨å†…éƒ¨å€¼çš„å‡½æ•°ï¼Œä¾‹å¦‚<code>deref</code>, <code>as_ref</code>ï¼‰ï¼Œå› æ­¤ä½å†…è”é˜ˆå€¼ä¼šä½¿ LLVM é”™è¿‡ä¼˜åŒ–æœºä¼šï¼ˆä¾‹å¦‚æ¶ˆé™¤æ­»åˆ†æ”¯ã€å†…è”è°ƒç”¨é—­åŒ…ï¼‰ã€‚</p>
<p>åœ¨ä¼˜åŒ–å¤§å°æ—¶ï¼Œæ‚¨å¯èƒ½æƒ³å°è¯•å¢åŠ å†…è”é˜ˆå€¼ï¼Œçœ‹çœ‹è¿™æ˜¯å¦å¯¹äºŒè¿›åˆ¶å¤§å°æœ‰ä»»ä½•å½±å“ã€‚æ›´æ”¹å†…è”é˜ˆå€¼çš„æ¨èæ–¹æ³•æ˜¯å°†<code>-C inline-threshold</code>æ ‡å¿—é™„åŠ åˆ°<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-toml"><code class="language-toml"># .cargo/config.toml
# this assumes that you are using the cortex-m-quickstart template
[target.'cfg(all(target_arch = "arm", target_os = "none"))']
rustflags = [
  # ..
  "-C", "inline-threshold=123", # +
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨ä»€ä¹ˆä»·å€¼ï¼Ÿ<a href="https://github.com/rust-lang/rust/blob/1.29.0/src/librustc_codegen_llvm/back/write.rs#L2105-L2122" target="_blank" rel="noopener">ä» 1.29.0 å¼€å§‹ï¼Œè¿™äº›æ˜¯ä¸åŒä¼˜åŒ–çº§åˆ«ä½¿ç”¨çš„å†…è”é˜ˆå€¼</a>ï¼š</p>
<ul>
<li><code>opt-level = 3</code> ä½¿ç”¨ 275</li>
<li><code>opt-level = 2</code> ä½¿ç”¨ 225</li>
<li><code>opt-level = "s"</code> ä½¿ç”¨ 75</li>
<li><code>opt-level = "z"</code> ä½¿ç”¨ 25</li>
</ul>
<p>ä½ åº”è¯¥å°è¯•<code>225</code>å’Œ<code>275</code>ä¼˜åŒ–å¤§å°æ—¶ã€‚</p>
<h1 id="Appendix-A-Glossary"><a href="#Appendix-A-Glossary" class="headerlink" title="Appendix A: Glossary"></a>Appendix A: Glossary</h1><p>The embedded ecosystem is full of different protocols, hardware components and vendor-specific things that use their own terms and abbreviations. This Glossary attempts to list them with pointers for understanding them better.</p>
<h3 id="BSP"><a href="#BSP" class="headerlink" title="BSP"></a>BSP</h3><p>A Board Support Crate provides a high level interface configured for a specific board. It usually depends on a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">HAL</a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="FPU"><a href="#FPU" class="headerlink" title="FPU"></a>FPU</h3><p>Floating-point Unit. A â€˜math processorâ€™ running only operations on floating-point numbers.</p>
<h3 id="HAL"><a href="#HAL" class="headerlink" title="HAL"></a>HAL</h3><p>A Hardware Abstraction Layer crate provides a developer friendly interface to a microcontrollerâ€™s features and peripherals. It is usually implemented on top of a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#pac" target="_blank" rel="noopener">Peripheral Access Crate (PAC)</a>. It may also implement traits from the <a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><p>Sometimes referred to as <code>IÂ²C</code> or Inter-IC. It is a protocol meant for hardware communication within a single integrated circuit. See <a href="https://en.wikipedia.org/wiki/I2c" target="_blank" rel="noopener">here</a> for more details</p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>A Peripheral Access Crate provides access to a microcontrollerâ€™s peripherals. It is one of the lower level crates and is usually generated directly from the provided <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#svd" target="_blank" rel="noopener">SVD</a>, often using <a href="https://github.com/rust-embedded/svd2rust/" target="_blank" rel="noopener">svd2rust</a>. The <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">Hardware Abstraction Layer</a> would usually depend on this crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>Serial Peripheral Interface. See <a href="https://en.wikipedia.org/wiki/Serial_peripheral_interface" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="SVD"><a href="#SVD" class="headerlink" title="SVD"></a>SVD</h3><p>System View Description is an XML file format used to describe the programmers view of a microcontroller device. You can read more about it on <a href="https://www.keil.com/pack/doc/CMSIS/SVD/html/index.html" target="_blank" rel="noopener">the ARM CMSIS documentation site</a>.</p>
<h3 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h3><p>Universal asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="USART"><a href="#USART" class="headerlink" title="USART"></a>USART</h3><p>Universal synchronous and asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_synchronous_and_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<hr>
<h1 id="ğŸ˜ã€ŠDiscoveryã€‹"><a href="#ğŸ˜ã€ŠDiscoveryã€‹" class="headerlink" title="ğŸ˜ã€ŠDiscoveryã€‹"></a>ğŸ˜ã€ŠDiscoveryã€‹</h1><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">æ°å…‹æˆ</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/embedded-rust.html">https://jackhcc.github.io/posts/embedded-rust.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="https://jackhcc.github.io" target="_blank">æ°å…‹æˆ</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Rust/">
                                    <span class="chip bg-color">Rust</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>è¯„è®º</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-09-08T21-32-49',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;æœ¬ç¯‡
            </div>
            <div class="card">
                <a href="/posts/embedded-rust.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg" class="responsive-img" alt="Embedded Rustè¯¦è§£">
                        
                        <span class="card-title">Embedded Rustè¯¦è§£</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            RuståµŒå…¥å¼ç¼–ç¨‹
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Embedded/" class="post-category">
                                    Embedded
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Rust/">
                        <span class="chip bg-color">Rust</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/awesome-bcsd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/22.jpg" class="responsive-img" alt="Awesome BCSD 2021">
                        
                        <span class="card-title">Awesome BCSD 2021</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Binary Code Similarity Detection 2021 æœ€æ–°ç ”ç©¶æ±‡æ€»
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Awesome/" class="post-category">
                                    Awesome
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BCSD/">
                        <span class="chip bg-color">BCSD</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- ä»£ç å—æŠ˜è¡Œ -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">æ°å…‹æˆ</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;ç«™ç‚¹æ€»å­—æ•°:&nbsp;<span
                class="white-color">1343.4k</span>&nbsp;å­—
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <span id="sitetime">è½½å…¥è¿è¡Œæ—¶é—´...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ " + diffDays + " å¤© " + diffHours +
                            " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ " + diffYears + " å¹´ " + diffDays +
                            " å¤© " + diffHours + " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„å¾®åš: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„çŸ¥ä¹: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">çŸ¥</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //åªåœ¨æ¡Œé¢ç‰ˆç½‘é¡µå¯ç”¨ç‰¹æ•ˆ
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

