<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Embedded Rust详解, JackHCC">
    <meta name="description" content="Rust嵌入式编程">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Embedded Rust详解 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Embedded Rust详解</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Rust/">
                                <span class="chip bg-color">Rust</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Embedded/" class="post-category">
                                Embedded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-09-08
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-11
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    85.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    366 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="✔Learning-Resource"><a href="#✔Learning-Resource" class="headerlink" title="✔Learning Resource"></a>✔Learning Resource</h1><ul>
<li><a href="https://kaisery.github.io/trpl-zh-cn/" target="_blank" rel="noopener">Rust 程序设计语言</a></li>
</ul>
<ul>
<li><a href="https://rust-embedded.github.io/book/" target="_blank" rel="noopener">The Embedded Rust Book</a> - An introductory book about using the Rust Programming Language on “Bare Metal” embedded systems, such as Microcontrollers.</li>
<li><a href="https://rust-embedded.github.io/discovery" target="_blank" rel="noopener">Discovery</a> by @rust-embedded — this book is an introductory course on microcontroller-based embedded systems that uses Rust as the teaching language. Original author: @japaric</li>
<li><a href="https://docs.rs/cortex-m-quickstart/0.3.1/cortex_m_quickstart/" target="_blank" rel="noopener">Cortex-M Quickstart</a> by @japaric – a template and introduction to embedded Rust, suitable for developers familiar to embedded development but new to embedded Rust.</li>
<li><a href="https://os.phil-opp.com/" target="_blank" rel="noopener">Writing an OS in rust</a> A blog series creating a small operating system in Rust</li>
<li><a href="https://droogmic.github.io/microrust/" target="_blank" rel="noopener">MicroRust</a> Introductory book for embedded development in Rust on the micro:bit.</li>
<li><a href="https://rahul-thakoor.github.io/physical-computing-rust/" target="_blank" rel="noopener">Physical Computing With Rust</a> A (WIP) guide to physical computing with Rust on the Raspberry Pi.</li>
<li><a href="https://github.com/rust-embedded/rust-raspi3-OS-tutorials" target="_blank" rel="noopener">Writing an embedded OS in Rust on the Raspberry Pi</a> A set of tutorials that give a guided, step-by-step tour of how to write a monolithic Operating System kernel for an embedded system from scratch. Runs on the Raspberry Pi 3 and the Raspberry Pi 4.</li>
<li><a href="https://hboeving.dev/blog/rust-2c-driver-p1/" target="_blank" rel="noopener">Writing embedded drivers in Rust isn’t that hard</a> A guide to building an embedded-hal driver. <a href="https://hboeving.dev/blog/rust-i2c-driver-p2/" target="_blank" rel="noopener">Part 2</a></li>
<li><a href="https://github.com/ferrous-systems/embedded-trainings-2020" target="_blank" rel="noopener">Ferrous Systems’ Embedded Training Courses: 2020-current edition</a> A hands-on training course for beginner and advanced learners of Embedded Rust, based on Nordic Semiconductor’s nRF52840 harware. This training was given at Oxidize Conferences and by <a href="https://ferrous-systems.com/" target="_blank" rel="noopener">Ferrous Systems</a> to corporate customers.</li>
<li><a href="https://knurling.ferrous-systems.com/sessions/" target="_blank" rel="noopener">Ferrous Systems’ Knurling Sessions</a> are hands-on embedded projects that explore specific concepts using generally available hardware, building full systems and components using microcontrollers, sensors, and actuators.</li>
<li><a href="https://github.com/jacobrosenthal/dsp-discoveryf4-rust/" target="_blank" rel="noopener">DSP on STM32F407G-DISC1</a> Unofficial oxidization of the <a href="https://www.amazon.com/Digital-Signal-Processing-Cortex-M-Microcontrollers/dp/1911531166" target="_blank" rel="noopener">Digital Signal Processing using Arm Cortex-M based Microcontrollers: Theory and Practice</a> book. The book isn’t necessary to enjoy the examples and learn a functional DSP Rust coding style.</li>
</ul>
<hr>
<h1 id="😀《The-Embedded-Rust-Book》"><a href="#😀《The-Embedded-Rust-Book》" class="headerlink" title="😀《The Embedded Rust Book》"></a>😀《The Embedded Rust Book》</h1><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="认识硬件"><a href="#认识硬件" class="headerlink" title="认识硬件"></a>认识硬件</h2><p>让我们熟悉一下我们将要使用的硬件。</p>
<h3 id="STM32F3DISCOVERY（“F3”）"><a href="#STM32F3DISCOVERY（“F3”）" class="headerlink" title="STM32F3DISCOVERY（“F3”）"></a>STM32F3DISCOVERY（“F3”）</h3><p><img src="/images/loading.gif" data-original="../images/language/f3-16313292317231.jpg" alt=""></p>
<p>这个板子包含什么？</p>
<ul>
<li>一个<a href="https://www.st.com/en/microcontrollers/stm32f303vc.html" target="_blank" rel="noopener">STM32F303VCT6</a>微控制器。这个微控制器有<ul>
<li>单核 ARM Cortex-M4F 处理器，硬件支持单精度浮点运算，最大时钟频率为 72 MHz。</li>
<li>256 KiB 的“闪存”内存。（1 KiB = 10 <strong>24</strong>字节）</li>
<li>48 KiB 内存。</li>
<li>多种集成外设，如定时器、I2C、SPI 和 USART。</li>
<li>通用输入输出 (GPIO) 和其他类型的引脚可通过板旁边的两排接头访问。</li>
<li>可通过标有“USB USER”的 USB 端口访问的 USB 接口。</li>
</ul>
</li>
<li>一个<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">加速计</a>作为的一部分<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>芯片。</li>
<li>甲<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">磁力</a>作为一部分<a href="https://www.st.com/en/mems-and-sensors/lsm303dlhc.html" target="_blank" rel="noopener">LSM303DLHC</a>芯片。</li>
<li>甲<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">陀螺仪</a>作为一部分<a href="https://www.pololu.com/file/0J563/L3GD20.pdf" target="_blank" rel="noopener">L3GD20</a>芯片。</li>
<li>8 个用户 LED 排列成指南针形状。</li>
<li>第二个微控制器：<a href="https://www.st.com/en/microcontrollers/stm32f103cb.html" target="_blank" rel="noopener">STM32F103</a>。该微控制器实际上是板载编程器/调试器的一部分，并连接到名为“USB ST-LINK”的 USB 端口。</li>
</ul>
<p>如需更详细的功能列表和电路板的进一步规格，请访问<a href="https://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STMicroelectronics</a>网站。</p>
<p>警告：如果您想将外部信号应用于电路板，请务必小心。微控制器 STM32F303VCT6 引脚的标称电压为 3.3 伏。如需更多信息，请参阅手册中的<a href="https://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">6.2 绝对最大额定值部分</a></p>
<h2 id="一个no-std-rust环境"><a href="#一个no-std-rust环境" class="headerlink" title="一个no_std rust环境"></a>一个<code>no_std</code> rust环境</h2><p>术语嵌入式编程用于广泛的不同类别的编程。从编程只有几 KB RAM 和 ROM 的8 位 MCU（如<a href="https://www.st.com/resource/en/datasheet/st72325j6.pdf" target="_blank" rel="noopener">ST72325xx</a>），到具有 32/64 位 4 核 Cortex-A53 @的 Raspberry Pi（<a href="https://en.wikipedia.org/wiki/Raspberry_Pi#Specifications" target="_blank" rel="noopener">B 型 3+</a>）等系统1.4 GHz 和 1GB 内存。编写代码时将应用不同的限制/限制，具体取决于您拥有的目标和用例类型。</p>
<p>有两种通用的嵌入式编程分类：</p>
<h3 id="托管环境"><a href="#托管环境" class="headerlink" title="托管环境"></a>托管环境</h3><p>这些类型的环境接近于正常的 PC 环境。这意味着您提供了一个系统接口<a href="https://en.wikipedia.org/wiki/POSIX" target="_blank" rel="noopener">EG POSIX</a> ，它为您提供了与各种系统交互的原语，例如文件系统、网络、内存管理、线程等。标准库通常又依赖于这些原语来实现他们的功能。您可能还有某种 sysroot 和 RAM/ROM 使用限制，也许还有一些特殊的硬件或 I/O。总体而言，感觉就像在专用 PC 环境中编码。</p>
<h3 id="裸机环境"><a href="#裸机环境" class="headerlink" title="裸机环境"></a>裸机环境</h3><p>在裸机环境中，在您的程序之前没有加载任何代码。如果没有操作系统提供的软件，我们将无法加载标准库。相反，程序及其使用的板条箱只能使用硬件（裸机）来运行。为了防止 Rust 加载标准库，请使用<code>no_std</code>. 标准库的平台无关部分可通过<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore 获得</a>。libcore 还排除了在嵌入式环境中并不总是需要的东西。其中之一是用于动态内存分配的内存分配器。如果您需要此功能或任何其他功能，通常有提供这些功能的板条箱。</p>
<p>libstd 运行时</p>
<p>如前所述，使用<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>需要某种系统集成，但这不仅是因为 <a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener">libstd</a>只是提供一种访问操作系统抽象的通用方法，它还提供了一个运行时。该运行时负责设置堆栈溢出保护、处理命令行参数以及在调用程序的主函数之前生成主线程。此运行时在<code>no_std</code>环境中也不可用。</p>
<h3 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h3><p><code>#![no_std]</code>是一个 crate 级别的属性，表示 crate 将链接到 core-crate 而不是 std-crate。反过来，<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a> crate 是 std crate 与平台无关的子集，它不对程序将在其上运行的系统做任何假设。因此，它为浮点数、字符串和切片等语言原语提供 API，以及公开原子操作和 SIMD 指令等处理器功能的 API。然而，它缺少任何涉及平台集成的 API。由于这些属性，no_std 和<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener">libcore</a>代码可用于任何类型的引导（阶段 0）代码，如引导加载程序、固件或内核。</p>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><table>
<thead>
<tr>
<th>特征</th>
<th>no_std</th>
<th>标准</th>
</tr>
</thead>
<tbody><tr>
<td>堆（动态内存）</td>
<td>*</td>
<td>✓</td>
</tr>
<tr>
<td>集合（Vec、HashMap 等）</td>
<td>**</td>
<td>✓</td>
</tr>
<tr>
<td>堆栈溢出保护</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>在 main 之前运行初始化代码</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>libstd 可用</td>
<td>✘</td>
<td>✓</td>
</tr>
<tr>
<td>libcore 可用</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>编写固件、内核或引导加载程序代码</td>
<td>✓</td>
<td>✘</td>
</tr>
</tbody></table>
<p>* 仅当您使用<code>alloc</code>crate 并使用合适的分配器（如<a href="https://github.com/rust-embedded/alloc-cortex-m" target="_blank" rel="noopener">alloc-cortex-m ）时</a>。</p>
<p>** 仅当您使用<code>collections</code>crate 并配置全局默认分配器时。</p>
<h3 id="也可以看看"><a href="#也可以看看" class="headerlink" title="也可以看看"></a>也可以看看</h3><ul>
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1184-stabilize-no_std.md" target="_blank" rel="noopener">RFC-1184</a></li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>处理微控制器涉及使用几种不同的工具，因为我们将处理与笔记本电脑不同的架构，我们必须在<em>远程</em>设备上运行和调试程序。</p>
<p>我们将使用下面列出的所有工具。当未指定最低版本时，任何最新版本都应该可以工作，但我们已经列出了我们测试过的版本。</p>
<ul>
<li>Rust 1.31、1.31-beta 或更新的工具链加上 ARM Cortex-M 编译支持。</li>
<li><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a> ~0.1.4</li>
<li><a href="https://www.qemu.org/" target="_blank" rel="noopener"><code>qemu-system-arm</code></a>. 测试版本：3.0.0</li>
<li>OpenOCD &gt;=0.8。测试版本：v0.9.0 和 v0.10.0</li>
<li>具有 ARM 支持的 GDB。强烈建议使用 7.12 或更高版本。测试版本：7.10、7.11、7.12 和 8.1</li>
<li><a href="https://github.com/ashleygwilliams/cargo-generate" target="_blank" rel="noopener"><code>cargo-generate</code></a>或<code>git</code>。这些工具是可选的，但可以更轻松地跟随本书进行学习。</li>
</ul>
<p>下面的文字解释了我们使用这些工具的原因。安装说明可以在下一页找到。</p>
<h3 id="cargo-generate-或者-git"><a href="#cargo-generate-或者-git" class="headerlink" title="cargo-generate 或者 git"></a><code>cargo-generate</code> 或者 <code>git</code></h3><p>裸机程序是非标准的 ( <code>no_std</code>) Rust 程序，需要对链接过程进行一些调整才能使程序的内存布局正确。这需要一些额外的文件（如链接器脚本）和设置（如链接器标志）。我们为您打包了一个模板，您只需填写缺少的信息（例如项目名称和目标硬件的特性）。</p>
<p>我们的模板兼容<code>cargo-generate</code>：用于从模板创建新 Cargo 项目的 Cargo 子命令。您还可以使用下载模板<code>git</code>，<code>curl</code>，<code>wget</code>，或Web浏览器。</p>
<h3 id="cargo-binutils"><a href="#cargo-binutils" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><p><code>cargo-binutils</code>是 Cargo 子命令的集合，可以轻松使用 Rust 工具链附带的 LLVM 工具。这些工具包括<code>objdump</code>、<code>nm</code>和的 LLVM 版本，<code>size</code>用于检查二进制文件。</p>
<p>与 GNU binutils 相比，使用这些工具的优势在于 (a) 安装 LLVM 工具是相同的单命令安装 ( <code>rustup component add llvm-tools-preview</code>)，无论您的操作系统如何，以及 (b)<code>objdump</code>支持所有<code>rustc</code>支持架构的工具——从 ARM 到 x86_64—— - 因为它们共享相同的 LLVM 后端。</p>
<h3 id="qemu-system-arm"><a href="#qemu-system-arm" class="headerlink" title="qemu-system-arm"></a><code>qemu-system-arm</code></h3><p>QEMU 是一个模拟器。在这种情况下，我们使用可以完全模拟 ARM 系统的变体。我们使用 QEMU 在主机上运行嵌入式程序。多亏了这一点，即使您没有任何硬件，您也可以遵循本书的某些部分！</p>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><p>调试器是嵌入式开发的一个非常重要的组件，因为您可能并不总是能够将内容记录到主机控制台。在某些情况下，您的硬件甚至可能没有 LED 指示灯闪烁！</p>
<p>总的来说，LLDB 在调试方面的效果与 GDB 一样好，但我们还没有找到 GDB 的<code>load</code>命令的 LLDB 对应项，它将程序上传到目标硬件，因此目前我们建议您使用 GDB。</p>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>GDB 无法直接与 STM32F3DISCOVERY 开发板上的 ST-Link 调试硬件通信。它需要一个转换器，而开放式片上调试器 OpenOCD 就是那个转换器。OpenOCD 是一个在您的笔记本电脑/PC 上运行的程序，可在 GDB 的基于 TCP/IP 的远程调试协议和 ST-Link 的基于 USB 的协议之间进行转换。</p>
<p>OpenOCD 还执行其他重要工作，作为其在 STM32F3DISCOVERY 开发板上调试基于 ARM Cortex-M 的微控制器的翻译的一部分：</p>
<ul>
<li>它知道如何与 ARM CoreSight 调试外设使用的内存映射寄存器进行交互。正是这些 CoreSight 寄存器允许：<ul>
<li>断点/观察点操作</li>
<li>读取和写入 CPU 寄存器</li>
<li>检测 CPU 何时因调试事件而停止</li>
<li>遇到调试事件后继续执行 CPU</li>
<li>等等。</li>
</ul>
</li>
<li>它还知道如何擦除和写入微控制器的 FLASH</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>此页面包含一些工具的与操作系统无关的安装说明：</p>
<h3 id="Rust-工具链"><a href="#Rust-工具链" class="headerlink" title="Rust 工具链"></a>Rust 工具链</h3><p>按照<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs </a>上的说明安装 rustup 。</p>
<p><strong>注意</strong>确保您的编译器版本等于或高于<code>1.31</code>. <code>rustc -V</code>应该返回一个比下面显示的日期新的日期。</p>
<pre class="line-numbers language-text"><code class="language-text">$ rustc -V
rustc 1.31.1 (b6c32da9b 2018-12-18)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于带宽和磁盘使用问题，默认安装仅支持本机编译。要为 ARM Cortex-M 架构添加交叉编译支持，请选择以下编译目标之一。对于本书示例中使用的 STM32F3DISCOVERY 板，请使用<code>thumbv7em-none-eabihf</code>目标。</p>
<p>Cortex-M0、M0+ 和 M1（ARMv6-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M3（ARMv7-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>无硬件浮点的 Cortex-M4 和 M7（ARMv7E-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>带有硬件浮点的 Cortex-M4F 和 M7F（ARMv7E-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M23（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.base-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33 和 M35P（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Cortex-M33F 和 M35PF 带硬件浮点（ARMv8-M 架构）：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv8m.main-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="cargo-binutils-1"><a href="#cargo-binutils-1" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h3><pre class="line-numbers language-text"><code class="language-text">cargo install cargo-binutils

rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-generate"><a href="#cargo-generate" class="headerlink" title="cargo-generate"></a><code>cargo-generate</code></h3><p>稍后我们将使用它从模板生成项目。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>以下是一些 Linux 发行版的安装命令。</p>
<h4 id="套餐"><a href="#套餐" class="headerlink" title="套餐"></a>套餐</h4><ul>
<li>Ubuntu 18.04 或更高版本/Debian 延伸版或更高版本</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>gdb-multiarch</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-multiarch openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Ubuntu 14.04 和 16.04</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt install gdb-arm-none-eabi openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Fedora 27 或更新版本</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo dnf install arm-none-eabi-gdb openocd qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>拱形Linux</li>
</ul>
<blockquote>
<p><strong>注意</strong> <code>arm-none-eabi-gdb</code>是您将用于调试 ARM Cortex-M 程序的 GDB 命令</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S arm-none-eabi-gdb qemu-arch-extra openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="udev-规则"><a href="#udev-规则" class="headerlink" title="udev 规则"></a>udev 规则</h4><p>此规则允许您在没有 root 权限的情况下将 OpenOCD 与 Discovery 板一起使用。</p>
<p><code>/etc/udev/rules.d/70-st-link.rules</code>使用如下所示的内容创建文件。</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY rev A/B - ST-LINK/V2
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="3748", TAG+="uaccess"

# STM32F3DISCOVERY rev C+ - ST-LINK/V2-1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", TAG+="uaccess"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后使用以下命令重新加载所有 udev 规则：</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果您将电路板插入笔记本电脑，请将其拔下，然后再重新插入。</p>
<p>您可以通过运行以下命令来检查权限：</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>哪个应该显示类似</p>
<pre class="line-numbers language-text"><code class="language-text">(..)
Bus 001 Device 018: ID 0483:374b STMicroelectronics ST-LINK/V2.1
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>记下总线和设备编号。使用这些数字创建一个类似 <code>/dev/bus/usb/&lt;bus&gt;/&lt;device&gt;</code>. 然后像这样使用这个路径：</p>
<pre class="line-numbers language-console"><code class="language-console">ls -l /dev/bus/usb/001/018
crw-------+ 1 root root 189, 17 Sep 13 12:34 /dev/bus/usb/001/018
getfacl /dev/bus/usb/001/018 | grep user
user::rw-
user:you:rw-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>+</code>附加到权限指示扩展的许可的存在。该<code>getfacl</code>命令告诉用户<code>you</code>可以使用该设备。</p>
<h3 id="苹果系统"><a href="#苹果系统" class="headerlink" title="苹果系统"></a>苹果系统</h3><p>所有工具都可以使用<a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>安装：</p>
<pre class="line-numbers language-text"><code class="language-text">$ # GDB
$ brew install armmbed/formulae/arm-none-eabi-gcc

$ # OpenOCD
$ brew install openocd

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="arm-none-eabi-gdb"><a href="#arm-none-eabi-gdb" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h4><p>ARM<code>.exe</code>为 Windows提供安装程序。从<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">这里</a>拿一个，然后按照说明操作。就在安装过程完成之前，勾选/选择“添加环境变量路径”选项。然后验证工具是否在您的<code>%PATH%</code>：</p>
<pre class="line-numbers language-text"><code class="language-text">$ arm-none-eabi-gdb -v
GNU gdb (GNU Tools for Arm Embedded Processors 7-2018-q2-update) 8.1.0.20180315-git
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="开放式强迫症"><a href="#开放式强迫症" class="headerlink" title="开放式强迫症"></a>开放式强迫症</h4><p>没有用于 Windows 的 OpenOCD 的官方二进制版本，但如果您不想自己编译它，xPack 项目提供了一个二进制发行版，请<a href="https://xpack.github.io/openocd/" target="_blank" rel="noopener">点击此处</a>。按照提供的安装说明进行操作。然后更新您的<code>%PATH%</code>环境变量以包含安装二进制文件的路径。( <code>C:\Users\USERNAME\AppData\Roaming\xPacks\@xpack-dev-tools\openocd\0.10.0-13.1\.content\bin\</code>, 如果您一直在使用简易安装)</p>
<p>验证 OpenOCD 是否在您的目录<code>%PATH%</code>中：</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="动车组"><a href="#动车组" class="headerlink" title="动车组"></a>动车组</h4><p>从<a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">官方网站获取</a>QEMU 。</p>
<h4 id="ST-LINK-USB-驱动"><a href="#ST-LINK-USB-驱动" class="headerlink" title="ST-LINK USB 驱动"></a>ST-LINK USB 驱动</h4><p>您还需要安装<a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">此 USB 驱动程序</a>，否则 OpenOCD 将无法工作。按照安装程序说明进行操作，并确保安装正确版本（32 位或 64 位）的驱动程序。</p>
<h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><p>在本节中，我们检查一些必需的工具/驱动程序是否已正确安装和配置。</p>
<p>使用微型 USB 电缆将您的笔记本电脑/PC 连接到发现板。发现板有两个 USB 连接器；使用位于电路板边缘中心的标有“USB ST-LINK”的那个。</p>
<p>还要检查是否填充了 ST-LINK 标头。见下图；ST-LINK 标头以红色圈出。</p>
<p><img src="/images/loading.gif" data-original="../images/language/verify.jpeg" alt=""></p>
<p>现在运行以下命令：</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：旧版本的 openocd，包括 2017 年的 0.10.0 版本，不包含新的（和更可取的）<code>interface/stlink.cfg</code>文件；相反，您可能需要使用<code>interface/stlink-v2.cfg</code>或<code>interface/stlink-v2-1.cfg</code>。</p>
</blockquote>
<p>您应该得到以下输出，并且程序应该阻止控制台：</p>
<pre class="line-numbers language-text"><code class="language-text">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.919881
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>内容可能不完全匹配，但您应该得到关于断点和观察点的最后一行。如果您得到它，则终止 OpenOCD 进程并转到<a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">下一部分</a>。</p>
<p>如果您没有得到“断点”行，请尝试以下命令之一。</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2.cfg -f target/stm32f3x.cfg
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果其中一个命令有效，则意味着您获得了发现板的旧硬件版本。这不会成为问题，但请将此事实记入内存，因为您稍后需要以不同的方式配置内容。您可以转到 <a href="https://docs.rust-embedded.org/book/start/index.html" target="_blank" rel="noopener">下一部分</a>。</p>
<p>如果没有任何命令以普通用户身份运行，则尝试以 root 权限（例如<code>sudo openocd ..</code>）运行它们。如果命令确实在 root 权限下工作，则检查<a href="https://docs.rust-embedded.org/book/intro/install/linux.html#udev-rules" target="_blank" rel="noopener">udev 规则</a>是否已正确设置。</p>
<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><h2 id="QUEM"><a href="#QUEM" class="headerlink" title="QUEM"></a>QUEM</h2><p>我们将开始为Cortex-M3 微控制器<a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>编写程序。我们选择它作为我们的初始目标，因为它<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">可以</a>使用 QEMU<a href="https://wiki.qemu.org/Documentation/Platforms/ARM#Supported_in_qemu-system-arm" target="_blank" rel="noopener">进行模拟</a>，因此您无需在本节中摆弄硬件，我们可以专注于工具和开发过程。</p>
<p><strong>重要信息</strong> 在本教程中，我们将使用名称“app”作为项目名称。每当您看到“app”一词时，您都应该将其替换为您为项目选择的名称。或者，您也可以将您的项目命名为“app”并避免替换。</p>
<h3 id="创建一个非标准的-Rust-程序"><a href="#创建一个非标准的-Rust-程序" class="headerlink" title="创建一个非标准的 Rust 程序"></a>创建一个非标准的 Rust 程序</h3><p>我们将使用<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>项目模板从中生成一个新项目。创建的项目将包含一个准系统应用程序：一个新的嵌入式 Rust 应用程序的良好起点。此外，该项目将包含一个<code>examples</code>目录，其中包含几个单独的应用程序，突出显示了一些关键的嵌入式 Rust 功能。</p>
<h4 id="使用-cargo-generate"><a href="#使用-cargo-generate" class="headerlink" title="使用 cargo-generate"></a>使用 <code>cargo-generate</code></h4><p>首先安装货物生成</p>
<pre class="line-numbers language-console"><code class="language-console">cargo install cargo-generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后生成一个新项目</p>
<pre class="line-numbers language-console"><code class="language-console">cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用-git"><a href="#使用-git" class="headerlink" title="使用 git"></a>使用 <code>git</code></h4><p>克隆存储库</p>
<pre class="line-numbers language-console"><code class="language-console">git clone https://github.com/rust-embedded/cortex-m-quickstart app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后填写<code>Cargo.toml</code>文件中的占位符</p>
<pre class="line-numbers language-toml"><code class="language-toml">[package]
authors = ["{{authors}}"] # "{{authors}}" -> "John Smith"
edition = "2018"
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
version = "0.1.0"

# ..

[[bin]]
name = "{{project-name}}" # "{{project-name}}" -> "awesome-app"
test = false
bench = false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用neither"><a href="#使用neither" class="headerlink" title="使用neither"></a>使用<code>neither</code></h4><p>获取<code>cortex-m-quickstart</code>模板的最新快照并提取它。</p>
<pre class="line-numbers language-console"><code class="language-console">curl -LO https://github.com/rust-embedded/cortex-m-quickstart/archive/master.zip
unzip master.zip
mv cortex-m-quickstart-master app
cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者您可以浏览到<a href="https://github.com/rust-embedded/cortex-m-quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>，单击绿色的“克隆或下载”按钮，然后单击“下载 ZIP”。</p>
<p>然后<code>Cargo.toml</code>按照“使用<code>git</code>”版本的第二部分中的方法填写文件中的占位符。</p>
<h3 id="程序概览"><a href="#程序概览" class="headerlink" title="程序概览"></a>程序概览</h3><p>为方便起见，这里是源代码中最重要的部分<code>src/main.rs</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// your code goes here</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个程序与标准的 Rust 程序有点不同，所以让我们仔细看看。</p>
<p><code>#![no_std]</code>表示这个程序<em>不会</em>链接到标准包， <code>std</code>. 相反，它将链接到它的子集：<code>core</code>板条箱。</p>
<p><code>#![no_main]</code>表示这个程序不会使用<code>main</code> 大多数 Rust 程序使用的标准接口。主要（没有双关语）的原因<code>no_main</code>是<code>main</code>在<code>no_std</code>上下文中使用界面需要每晚。</p>
<p><code>use panic_halt as _;</code>. 这个 crate 提供了一个<code>panic_handler</code>定义程序的恐慌行为。</p>
<p><a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.entry.html" target="_blank" rel="noopener"><code>#[entry]</code></a>是<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>crate提供的一个属性，用于标记程序的入口点。由于我们没有使用标准<code>main</code> 接口，我们需要另一种方式来指示程序的入口点，那就是<code>#[entry]</code>.</p>
<p><code>fn main() -&gt; !</code>. 我们的程序将是目标硬件上运行的<em>唯一</em>进程，所以我们不希望它结束！我们使用<a href="https://doc.rust-lang.org/rust-by-example/fn/diverging.html" target="_blank" rel="noopener">发散函数</a>（<code>-&gt; !</code> 函数签名中的位）来确保在编译时就是这种情况。</p>
<h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>下一步是<em>交叉</em>编译 Cortex-M3 架构的程序。<code>cargo build --target $TRIPLE</code>如果您知道编译目标 ( <code>$TRIPLE</code>) 应该是什么，那么这就像运行一样简单。幸运的是，<code>.cargo/config.toml</code>模板中有答案：</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n6 .cargo/config.toml
[build]
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
# target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要交叉编译 Cortex-M3 架构，我们必须使用 <code>thumbv7m-none-eabi</code>. 安装 Rust 工具链时不会自动安装该目标，现在是将该目标添加到工具链的好时机，如果您还没有这样做：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>由于<code>thumbv7m-none-eabi</code>编译目标已在您的<code>.cargo/config.toml</code>文件中设置为默认值，因此下面的两个命令执行相同的操作：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7m-none-eabi
cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><p>现在我们在<code>target/thumbv7m-none-eabi/debug/app</code>. 我们可以使用<code>cargo-binutils</code>.</p>
<p>随着<code>cargo-readobj</code>我们可以打印ELF头，以确认这是一个ARM二进制文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --bin app -- -file-headers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：</p>
<ul>
<li><code>--bin app</code> 是用于检查二进制文件的糖 <code>target/$TRIPLE/debug/app</code></li>
<li><code>--bin app</code> 如有必要，还将（重新）编译二进制文件</li>
</ul>
<pre class="line-numbers language-text"><code class="language-text">ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0x0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x405
  Start of program headers:          52 (bytes into file)
  Start of section headers:          153204 (bytes into file)
  Flags:                             0x5000200
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         19
  Section header string table index: 18<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>cargo-size</code> 可以打印二进制文件的链接器部分的大小。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo size --bin app --release -- -A<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们<code>--release</code>用来检查优化版本</p>
<pre class="line-numbers language-text"><code class="language-text">app  :
section             size        addr
.vector_table       1024         0x0
.text                 92       0x400
.rodata                0       0x45c
.data                  0  0x20000000
.bss                   0  0x20000000
.debug_str          2958         0x0
.debug_loc            19         0x0
.debug_abbrev        567         0x0
.debug_info         4929         0x0
.debug_ranges         40         0x0
.debug_macinfo         1         0x0
.debug_pubnames     2035         0x0
.debug_pubtypes     1892         0x0
.ARM.attributes       46         0x0
.debug_frame         100         0x0
.debug_line          867         0x0
Total              14570<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>ELF 链接器部分的复习</p>
<ul>
<li><code>.text</code> 包含程序指令</li>
<li><code>.rodata</code> 包含常量值，如字符串</li>
<li><code>.data</code>包含初始值<em>不</em>为零的静态分配变量</li>
<li><code>.bss</code>也包含静态分配的变量，其初始值 <em>是</em>零</li>
<li><code>.vector_table</code>是我们用来存储向量（中断）表的<em>非标准</em>部分</li>
<li><code>.ARM.attributes</code>并且这些<code>.debug_*</code>部分包含元数据，并且 在闪烁二进制文件时<em>不会</em>加载到目标上。</li>
</ul>
</blockquote>
<p><strong>重要提示</strong>：ELF 文件包含诸如调试信息之类的元数据，因此它们<em>在磁盘</em>上的<em>大小*</em>不能<em>准确反映程序在设备上闪烁时将占用的空间。</em>始终*使用<code>cargo-size</code>来检查二进制真的有多大。</p>
<p><code>cargo-objdump</code> 可用于反汇编二进制文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin app --release -- --disassemble --no-show-raw-insn --print-imm-hex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果上面的命令抱怨<code>Unknown command line argument</code>看到以下错误报告：<a href="https://github.com/rust-embedded/book/issues/269" target="_blank" rel="noopener">https://github.com/rust-embedded/book/issues/269</a></p>
</blockquote>
<blockquote>
<p><strong>注意</strong>此输出在您的系统上可能会有所不同。新版本的 rustc、LLVM 和库可以生成不同的程序集。我们截断了一些指令以保持代码片段较小。</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">app:  file format ELF32-arm-little

Disassembly of section .text:
main:
     400: bl  #0x256
     404: b #-0x4 <main+0x4>

Reset:
     406: bl  #0x24e
     40a: movw  r0, #0x0
     < .. truncated any more instructions .. >

DefaultHandler_:
     656: b #-0x4 <DefaultHandler_>

UsageFault:
     657: strb  r7, [r4, #0x3]

DefaultPreInit:
     658: bx  lr

__pre_init:
     659: strb  r7, [r0, #0x1]

__nop:
     65a: bx  lr

HardFaultTrampoline:
     65c: mrs r0, msp
     660: b #-0x2 <HardFault_>

HardFault_:
     662: b #-0x4 <HardFault_>

HardFault:
     663: <unknown><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>接下来，让我们看看如何在 QEMU 上运行嵌入式程序！这次我们将使用<code>hello</code>实际执行某些操作的 示例。</p>
<p>为方便起见，这里的源代码<code>examples/hello.rs</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">//! Prints "Hello, world!" on the host console using semihosting</span>

<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该程序使用称为半主机的东西将文本打印到<em>主机</em> 控制台。当使用真正的硬件时，这需要一个调试会话，但当使用 QEMU 时，它就可以工作。</p>
<p>让我们从编译示例开始：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输出二进制文件将位于 <code>target/thumbv7m-none-eabi/debug/examples/hello</code>.</p>
<p>要在 QEMU 上运行此二进制文件，请运行以下命令：</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打印文本后，该命令应成功退出（退出代码 = 0）。在 *nix 上，您可以使用以下命令进行检查：</p>
<pre class="line-numbers language-console"><code class="language-console">echo $?
0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>让我们分解一下 QEMU 命令：</p>
<ul>
<li><code>qemu-system-arm</code>. 这是 QEMU 模拟器。这些 QEMU 二进制文件有几个变体；这个对<em>ARM</em>机器进行完整的<em>系统</em>仿真，因此得名。</li>
<li><code>-cpu cortex-m3</code>. 这告诉 QEMU 模拟 Cortex-M3 CPU。指定 CPU 型号可以让我们捕获一些错误编译错误：例如，运行为 Cortex-M4F 编译的程序，它具有硬件 FPU，在执行过程中会导致 QEMU 错误。</li>
<li><code>-machine lm3s6965evb</code>. 这告诉 QEMU 模拟 LM3S6965EVB，这是一个包含 LM3S6965 微控制器的评估板。</li>
<li><code>-nographic</code>. 这告诉 QEMU 不要启动它的 GUI。</li>
<li><code>-semihosting-config (..)</code>. 这告诉 QEMU 启用半主机。半主机允许模拟设备使用主机 stdout、stderr 和 stdin 并在主机上创建文件。</li>
<li><code>-kernel $file</code>. 这会告诉 QEMU 在模拟机器上加载和运行哪个二进制文件。</li>
</ul>
<p>输入这么长的 QEMU 命令太费力了！我们可以设置自定义运行器来简化流程。<code>.cargo/config.toml</code>有一个被注释掉的调用 QEMU 的运行程序；让我们取消注释：</p>
<pre class="line-numbers language-console"><code class="language-console">head -n3 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此运行程序仅适用于<code>thumbv7m-none-eabi</code>目标，这是我们的默认编译目标。现在<code>cargo run</code>将编译程序并在 QEMU 上运行它：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run --example hello --release
   Compiling app v0.1.0 (file:///tmp/app)
    Finished release [optimized + debuginfo] target(s) in 0.26s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/examples/hello`
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>调试对于嵌入式开发至关重要。让我们看看它是如何完成的。</p>
<p>调试嵌入式设备涉及<em>远程</em>调试，因为我们要调试的程序不会在运行调试器程序（GDB 或 LLDB）的机器上运行。</p>
<p>远程调试涉及客户端和服务器。在 QEMU 设置中，客户端将是一个 GDB（或 LLDB）进程，而服务器将是运行嵌入式程序的 QEMU 进程。</p>
<p>在本节中，我们将使用<code>hello</code>我们已经编译的示例。</p>
<p>调试的第一步是在调试模式下启动 QEMU：</p>
<pre class="line-numbers language-console"><code class="language-console">qemu-system-arm \
  -cpu cortex-m3 \
  -machine lm3s6965evb \
  -nographic \
  -semihosting-config enable=on,target=native \
  -gdb tcp::3333 \
  -S \
  -kernel target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此命令不会向控制台打印任何内容并将阻止终端。这次我们传递了两个额外的标志：</p>
<ul>
<li><code>-gdb tcp::3333</code>. 这告诉 QEMU 等待 TCP 端口 3333 上的 GDB 连接。</li>
<li><code>-S</code>. 这告诉 QEMU 在启动时冻结机器。如果没有这个，程序将在我们有机会启动调试器之前到达 main 的末尾！</li>
</ul>
<p>接下来我们在另一个终端中启动 GDB 并告诉它加载示例的调试符号：</p>
<pre class="line-numbers language-console"><code class="language-console">gdb-multiarch -q target/thumbv7m-none-eabi/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>注意</strong>：您可能需要另一个版本的 gdb 而不是<code>gdb-multiarch</code>取决于您在安装章节中安装的那个版本。这也可以是 <code>arm-none-eabi-gdb</code>或只是<code>gdb</code>.</p>
<p>然后在 GDB shell 中我们连接到 QEMU，它正在等待 TCP 端口 3333 上的连接。</p>
<pre class="line-numbers language-console"><code class="language-console">target remote :3333
Remote debugging using :3333
Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473
473     pub unsafe extern "C" fn Reset() -> ! {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>您将看到该进程已停止，并且程序计数器指向名为<code>Reset</code>. 这就是重置处理程序：Cortex-M 内核在启动时执行的操作。</p>
<blockquote>
<p>请注意，在某些设置<code>Reset () at $REGISTRY/cortex-m-rt-0.6.1/src/lib.rs:473</code>中，gdb 可能会打印一些警告，而不是显示如上所示的行：</p>
<pre><code>core::num::bignum::Big32x40::mul_small () at src/libcore/num/bignum.rs:254` `src/libcore/num/bignum.rs: No such file or directory.</code></pre><p>这是一个众所周知的故障。您可以放心地忽略这些警告，您很可能在 Reset() 处。</p>
</blockquote>
<p>这个重置处理程序最终会调用我们的主函数。让我们使用断点和<code>continue</code>命令一路跳过。要设置断点，让我们首先看看我们想要在代码中中断的位置，使用<code>list</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">list main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这将显示来自文件 examples/hello.rs 的源代码。</p>
<pre class="line-numbers language-text"><code class="language-text">6       use panic_halt as _;
7
8       use cortex_m_rt::entry;
9       use cortex_m_semihosting::{debug, hprintln};
10
11      #[entry]
12      fn main() -> ! {
13          hprintln!("Hello, world!").unwrap();
14
15          // exit QEMU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们想在第 13 行的“Hello, world!”之前添加一个断点。我们使用以下<code>break</code>命令：</p>
<pre class="line-numbers language-console"><code class="language-console">break 13<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们现在可以使用以下<code>continue</code>命令指示 gdb 运行到我们的 main 函数：</p>
<pre class="line-numbers language-console"><code class="language-console">continue
Continuing.

Breakpoint 1, hello::__cortex_m_rt_main () at examples\hello.rs:13
13          hprintln!("Hello, world!").unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们现在接近打印“Hello, world!”的代码。让我们继续使用<code>next</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">next
16          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时您应该看到“Hello, world!” 打印在正在运行的终端上<code>qemu-system-arm</code>。</p>
<pre class="line-numbers language-text"><code class="language-text">$ qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>next</code>再次调用将终止 QEMU 进程。</p>
<pre class="line-numbers language-console"><code class="language-console">next
[Inferior 1 (Remote target) exited normally]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>您现在可以退出 GDB 会话。</p>
<pre class="line-numbers language-console"><code class="language-console">quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Hardware（硬件）"><a href="#Hardware（硬件）" class="headerlink" title="Hardware（硬件）"></a>Hardware（硬件）</h2><h3 id="了解硬件"><a href="#了解硬件" class="headerlink" title="了解硬件"></a>了解硬件</h3><p>在我们开始之前，您需要确定目标设备的一些特征，因为这些特征将用于配置项目：</p>
<ul>
<li>ARM 核心。例如皮质-M3。</li>
<li>ARM 内核是否包含 FPU？Cortex-M4 <strong>F</strong>和 Cortex-M7 <strong>F</strong>内核可以。</li>
<li>目标设备有多少闪存和 RAM？例如 256 KiB 的闪存和 32 KiB 的 RAM。</li>
<li>闪存和 RAM 在地址空间中映射到哪里？例如，RAM 通常位于 address <code>0x2000_0000</code>。</li>
</ul>
<p>您可以在数据表或设备的参考手册中找到此信息。</p>
<p>在本节中，我们将使用我们的参考硬件 STM32F3DISCOVERY。该板包含一个 STM32F303VCT6 微控制器。该微控制器具有：</p>
<ul>
<li>包含单精度 FPU 的 Cortex-M4F 内核</li>
<li>位于地址 0x0800_0000 的 256 KiB 闪存。</li>
<li>位于地址 0x2000_0000 的 40 KiB RAM。（还有另一个 RAM 区域，但为简单起见，我们将忽略它）。</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>我们将从一个新的模板实例开始。请参阅 QEMU关于如何做到这一点没有复习 <code>cargo-generate</code>。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
 Project Name: app
 Creating project called `app`...
 Done! New project created /tmp/app

$ cd app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步是在<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">tail -n5 .cargo/config.toml
# Pick ONE of these compilation targets
# target = "thumbv6m-none-eabi"    # Cortex-M0 and Cortex-M0+
# target = "thumbv7m-none-eabi"    # Cortex-M3
# target = "thumbv7em-none-eabi"   # Cortex-M4 and Cortex-M7 (no FPU)
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将使用<code>thumbv7em-none-eabihf</code>它覆盖 Cortex-M4F 内核。</p>
<p>第二步是将内存区域信息输入到<code>memory.x</code> 文件中。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cat memory.x
/* Linker script for the STM32F303VCT6 */
MEMORY
{
  /* NOTE 1 K = 1 KiBi = 1024 bytes */
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：如果您<code>memory.x</code>在完成特定构建目标的第一次构建后出于某种原因更改了文件，请<code>cargo clean</code>在之前执行 <code>cargo build</code>，因为<code>cargo build</code>可能无法跟踪<code>memory.x</code>.</p>
</blockquote>
<p>我们将再次从 hello 示例开始，但首先我们必须进行一些小的更改。</p>
<p>在 中<code>examples/hello.rs</code>，确保<code>debug::exit()</code>已注释掉或删除该调用。它仅用于在 QEMU 中运行。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// exit QEMU</span>
    <span class="token comment" spellcheck="true">// NOTE do not run this on hardware; it can corrupt OpenOCD state</span>
    <span class="token comment" spellcheck="true">// debug::exit(debug::EXIT_SUCCESS);</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您现在可以像以前一样使用交叉编译程序<code>cargo build</code> 和检查二进制文件<code>cargo-binutils</code>。该 <code>cortex-m-rt</code>箱处理所有的魔法需要得到你的芯片上运行，如有益，几乎所有的Cortex-M CPU的启动以同样的方式。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build --example hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>调试看起来有点不同。事实上，根据目标设备的不同，第一步看起来可能会有所不同。在本节中，我们将展示调试在 STM32F3DISCOVERY 上运行的程序所需的步骤。这是为了作为参考；有关调试的设备特定信息，请查看<a href="https://github.com/rust-embedded/debugonomicon" target="_blank" rel="noopener">Debugonomicon</a>。</p>
<p>和以前一样，我们将进行远程调试，客户端将是一个 GDB 进程。然而，这一次，服务器将是 OpenOCD。</p>
<p>正如在安装验证部分所做的那样，将发现板连接到您的笔记本电脑/PC 并检查 ST-LINK 标头是否已填充。</p>
<p>在终端上运行<code>openocd</code>以连接到发现板上的 ST-LINK。从模板的根目录运行此命令；<code>openocd</code>将拾取 <code>openocd.cfg</code>指示使用哪个接口文件和目标文件的文件。</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.cfg
# Sample OpenOCD configuration for the STM32F3DISCOVERY development board

# Depending on the hardware revision you got you'll have to pick ONE of these
# interfaces. At any time only one interface should be commented out.

# Revision C (newer revision)
source [find interface/stlink.cfg]

# Revision A and B (older revisions)
# source [find interface/stlink-v2.cfg]

source [find target/stm32f3x.cfg]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果您在验证部分发现发现板的版本较旧，则此时应修改<code>openocd.cfg</code> 文件以使用<code>interface/stlink-v2.cfg</code>.</p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.913879
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在另一个终端上运行 GDB，也是从模板的根目录。</p>
<pre class="line-numbers language-text"><code class="language-text">$ <gdb> -q target/thumbv7em-none-eabihf/debug/examples/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来将 GDB 连接到 OpenOCD，它正在等待端口 3333 上的 TCP 连接。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>现在继续使用命令将程序<em>闪存</em>（加载）到微控制器上 <code>load</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) load
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序现在已加载。该程序使用半主机，因此在我们进行任何半主机调用之前，我们必须告诉 OpenOCD 启用半主机。您可以使用命令向 OpenOCD 发送命令<code>monitor</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>您可以通过调用<code>monitor help</code>命令查看所有 OpenOCD 命令。</p>
</blockquote>
<p>像以前一样，我们可以一直跳过<code>main</code>使用断点和 <code>continue</code>命令。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main
Breakpoint 1 at 0x8000d18: file examples/hello.rs, line 15.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, main () at examples/hello.rs:15
15          let mut stdout = hio::hstdout().unwrap();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果在您发出上述<code>continue</code>命令后 GDB 阻塞终端而不是点击断点，您可能需要仔细检查文件中的内存区域信息<code>memory.x</code>是否为您的设备正确设置（开始<em>和</em>长度）。</p>
</blockquote>
<p>推进程序<code>next</code>应该产生与以前相同的结果。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next
16          writeln!(stdout, "Hello, world!").unwrap();

(gdb) next
19          debug::exit(debug::EXIT_SUCCESS);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时您应该看到“Hello, world!” 打印在 OpenOCD 控制台上，等等。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08000e6c
Hello, world!
Info : halted: PC: 0x08000d62
Info : halted: PC: 0x08000d64
Info : halted: PC: 0x08000d66
Info : halted: PC: 0x08000d6a
Info : halted: PC: 0x08000a0c
Info : halted: PC: 0x08000d70
Info : halted: PC: 0x08000d72<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发出另一个<code>next</code>将使处理器执行<code>debug::exit</code>。这充当断点并停止进程：</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) next

Program received signal SIGTRAP, Trace/breakpoint trap.
0x0800141a in __syscall ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>它还会导致将其打印到 OpenOCD 控制台：</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Info : halted: PC: 0x08001188
semihosting: *** application exited ***
Warn : target not halted
Warn : target not halted
target halted due to breakpoint, current mode: Thread
xPSR: 0x21000000 pc: 0x08000d76 msp: 0x20009fc0, semihosting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，在微控制器上运行的进程尚未终止，您可以使用<code>continue</code>或类似命令恢复它。</p>
<p>您现在可以使用该<code>quit</code>命令退出 GDB 。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调试现在需要更多的步骤，因此我们将所有这些步骤打包到一个名为<code>openocd.gdb</code>. 该文件是在该<code>cargo generate</code>步骤中创建的，应该无需任何修改即可工作。让我们有一个高峰：</p>
<pre class="line-numbers language-console"><code class="language-console">cat openocd.gdb
target extended-remote :3333

# print demangled symbols
set print asm-demangle on

# detect unhandled exceptions, hard faults and panics
break DefaultHandler
break HardFault
break rust_begin_unwind

monitor arm semihosting enable

load

# start the process but immediately halt the processor
stepi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在运行<code>&lt;gdb&gt; -x openocd.gdb target/thumbv7em-none-eabihf/debug/examples/hello</code>将立即将 GDB 连接到 OpenOCD，启用半主机，加载程序并启动进程。</p>
<p>或者，您可以变成<code>&lt;gdb&gt; -x openocd.gdb</code>自定义运行<code>cargo run</code>程序来 构建程序<em>并</em>启动 GDB 会话。此运行程序包含在<code>.cargo/config.toml</code>但已注释掉。</p>
<pre class="line-numbers language-console"><code class="language-console">head -n10 .cargo/config.toml
[target.thumbv7m-none-eabi]
# uncomment this to make `cargo run` execute programs on QEMU
# runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"

[target.'cfg(all(target_arch = "arm", target_os = "none"))']
# uncomment ONE of these three option to make `cargo run` start a GDB session
# which option to pick depends on your system
runner = "arm-none-eabi-gdb -x openocd.gdb"
# runner = "gdb-multiarch -x openocd.gdb"
# runner = "gdb -x openocd.gdb"
$ cargo run --example hello
(..)
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x1e70 lma 0x8000400
Loading section .rodata, size 0x61c lma 0x8002270
Start address 0x800144e, load size 10380
Transfer rate: 17 KB/sec, 3460 bytes/write.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Memory-Mapped-Registers"><a href="#Memory-Mapped-Registers" class="headerlink" title="Memory Mapped Registers"></a>Memory Mapped Registers</h2><p>嵌入式系统只能通过执行普通的 Rust 代码并在 RAM 中移动数据来实现。如果我们想将任何信息输入或输出我们的系统（例如闪烁 LED、检测按钮按下或与某种总线上的片外外围设备通信），我们将不得不深入了解外设及其“内存映射寄存器”。</p>
<p>您可能会发现访问微控制器中的外围设备所需的代码已经编写好了，位于以下级别之一：</p>
<p><img src="/images/loading.gif" data-original="../images/language/crates.png" alt=""></p>
<ul>
<li>Micro-architecture Crate - 此类 crate 处理您的微控制器使用的处理器内核通用的任何有用例程，以及使用该特定类型处理器内核的所有微控制器通用的任何外围设备。例如，<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate 为您提供了启用和禁用中断的功能，这些功能对于所有基于 Cortex-M 的微控制器都是相同的。它还允许您访问所有基于 Cortex-M 的微控制器中包含的“SysTick”外设。</li>
<li>外设访问板条箱 (PAC) - 这种板条箱是为您正在使用的微控制器的特定部件号定义的各种内存包装器寄存器的薄包装器。例如，<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>适用于 Texas Instruments Tiva-C TM4C123 系列，或<a href="https://crates.io/crates/stm32f30x" target="_blank" rel="noopener">stm32f30x</a>适用于 ST-Micro STM32F30x 系列。在这里，您将按照微控制器技术参考手册中给出的每个外围设备的操作说明直接与寄存器交互。</li>
<li>HAL Crate - 这些 crate 为您的特定处理器提供更加用户友好的 API，通常通过实现一些在<a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener">Embedded-hal </a>中定义的常见特征。例如，这个 crate 可能提供一个<code>Serial</code>结构体，带有一个构造函数，该构造函数采用一组适当的 GPIO 引脚和波特率，并提供某种<code>write_byte</code>发送数据的功能。</li>
<li>Board Crate - 这些 crate 比 HAL Crate 更进一步，通过预配置各种外设和 GPIO 引脚以适合您正在使用的特定开发人员套件或板，例如<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>用于 STM32F3DISCOVERY 板。</li>
</ul>
<h3 id="板条箱"><a href="#板条箱" class="headerlink" title="板条箱"></a>板条箱</h3><p>如果您不熟悉嵌入式 Rust，板条箱是完美的起点。他们很好地抽象了开始学习这个主题时可能会让人不知所措的硬件细节，并使标准任务变得简单，比如打开或关闭 LED。它们公开的功能因板而异。由于本书旨在保持与硬件无关，因此本书不会涵盖板条箱。</p>
<p>如果您想试用 STM32F3DISCOVERY 板，强烈建议查看<a href="https://crates.io/crates/stm32f3-discovery" target="_blank" rel="noopener">stm32f3-discovery</a>板箱，它提供使板 LED 闪烁、访问指南针、蓝牙等功能。<a href="https://rust-embedded.github.io/discovery/" target="_blank" rel="noopener">discovery</a>提供了一个很好的介绍使用板箱的。</p>
<p>但是，如果您正在使用一个还没有专用板条箱的系统，或者您需要现有板条箱未提供的功能，请继续阅读我们从底部开始的微架构板条箱。</p>
<h3 id="微架构箱"><a href="#微架构箱" class="headerlink" title="微架构箱"></a>微架构箱</h3><p>让我们看看所有基于 Cortex-M 的微控制器通用的 SysTick 外设。我们可以在<a href="https://crates.io/crates/cortex-m" target="_blank" rel="noopener">cortex-m</a> crate 中找到一个非常低级的 API ，我们可以这样使用它：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>syst<span class="token punctuation">,</span> Peripherals<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> systick <span class="token operator">=</span> peripherals<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>systick<span class="token punctuation">.</span><span class="token function">has_wrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Loop</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在功能<code>SYST</code>结构非常紧密映射到由ARM技术参考手册此外设定义的功能。这个 API 中没有关于“延迟 X 毫秒”的内容——我们必须自己使用<code>while</code>循环粗略地实现它。请注意，<code>SYST</code>在调用之前我们无法访问我们的结构<code>Peripherals::take()</code>- 这是一个特殊的例程，可保证<code>SYST</code>我们整个程序中只有一个结构。</p>
<h3 id="使用外设访问箱-PAC"><a href="#使用外设访问箱-PAC" class="headerlink" title="使用外设访问箱 (PAC)"></a>使用外设访问箱 (PAC)</h3><p>如果我们将自己限制在每个 Cortex-M 附带的基本外围设备上，我们的嵌入式软件开发就不会走得太远。在某些时候，我们将需要编写一些特定于我们正在使用的特定微控制器的代码。在这个例子中，我们假设我们有一个 Texas Instruments TM4C123——一个中等的 80MHz Cortex-M4，具有 256 KiB 的闪存。我们将拉入<a href="https://crates.io/crates/tm4c123x" target="_blank" rel="noopener">tm4c123x</a>板条箱以使用该芯片。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> Leds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> tm4c123x<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> pwm <span class="token operator">=</span> p<span class="token punctuation">.</span>PWM0<span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Mode = 1 => Count up/down mode</span>
    pwm<span class="token punctuation">.</span>_2_ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_gena<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">actcmpau</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actcmpad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 528 cycles (264 up and down) = 4 loops per video line (2112 cycles)</span>
    pwm<span class="token punctuation">.</span>_2_load<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">263</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>_2_cmpa<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> w<span class="token punctuation">.</span><span class="token function">compa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwm<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">pwm4en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们访问的<code>PWM0</code>外设完全相同的方式，因为我们访问的<code>SYST</code>外围较早，但我们叫<code>tm4c123x::Peripherals::take()</code>。由于这个 crate 是使用<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>自动生成的，我们寄存器字段的访问函数采用闭包，而不是数字参数。虽然这看起来像很多代码，但 Rust 编译器可以使用它为我们执行一堆检查，然后生成非常接近手写汇编器的机器代码！自动生成的代码无法确定特定访问器函数的所有可能参数都有效（例如，如果 SVD 将寄存器定义为 32 位，但没有说明这些 32 位值中的某些值是否有效）有特殊意义），则该函数被标记为<code>unsafe</code>. 在使用该函数设置<code>load</code>和<code>compa</code>子字段时，我们可以在上面的示例中看到这一点<code>bits()</code>。</p>
<h4 id="读"><a href="#读" class="headerlink" title="读"></a>读</h4><p>该<code>read()</code>函数返回一个对象，该对象提供对该寄存器中各个子字段的只读访问，如该芯片制造商的 SVD 文件所定义。您可以<code>R</code>在<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.R.html" target="_blank" rel="noopener">tm4c123x 文档中</a>找到此特定寄存器的特殊返回类型、此特定外设、此特定芯片上的所有可用函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">if</span> pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Do a thing</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="写"><a href="#写" class="headerlink" title="写"></a>写</h4><p>该<code>write()</code>函数采用带有单个参数的闭包。通常我们称之为<code>w</code>. 然后，此参数提供对该寄存器内的各种子字段的读写访问，如该芯片制造商的 SVD 文件所定义的那样。同样，您可以在<a href="https://docs.rs/tm4c123x/0.7.0/tm4c123x/pwm0/ctl/struct.W.html" target="_blank" rel="noopener">tm4c123x 文档中</a>找到此特定寄存器、此特定外设、此特定芯片上的“w”上可用的所有功能。请注意，我们未设置的所有子字段将为我们设置为默认值 - 寄存器中的任何现有内容都将丢失。</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><p>如果我们只想改变这个寄存器中的一个特定子字段而其他子字段保持不变，我们可以使用该<code>modify</code>函数。这个函数接受一个带有两个参数的闭包——一个用于读取，一个用于写入。通常我们分别称它们为<code>r</code>和<code>w</code>。该<code>r</code>参数可以用来检查所述寄存器的当前内容，并且<code>w</code>参数可以用来修改寄存器的内容。</p>
<pre class="line-numbers language-rust"><code class="language-rust">pwm<span class="token punctuation">.</span>ctl<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">globalsync0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该<code>modify</code>函数在这里真正展示了闭包的威力。在 C 中，我们必须读入一些临时值，修改正确的位，然后将值写回。这意味着存在相当大的错误范围：</p>
<pre class="line-numbers language-C"><code class="language-C">uint32_t temp = pwm0.ctl.read();
temp |= PWM0_CTL_GLOBALSYNC0;
pwm0.ctl.write(temp);
uint32_t temp2 = pwm0.enable.read();
temp2 |= PWM0_ENABLE_PWM4EN;
pwm0.enable.write(temp); // Uh oh! Wrong variable!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用-HAL-板条箱"><a href="#使用-HAL-板条箱" class="headerlink" title="使用 HAL 板条箱"></a>使用 HAL 板条箱</h3><p>芯片的 HAL crate 通常通过为 PAC 公开的原始结构实现自定义 Trait 来工作。通常，此特征会定义一个函数，调用<code>constrain()</code>单个外设或<code>split()</code>具有多个引脚的 GPIO 端口之类的东西。此函数将消耗底层原始外围结构并返回具有更高级别 API 的新对象。这个 API 也可以做一些事情，比如让串口<code>new</code>功能需要借用一些<code>Clock</code>结构，只能通过调用配置 PLL 和设置所有时钟频率的函数来生成。通过这种方式，静态地不可能在没有首先配置时钟速率的情况下创建串行端口对象，或者串行端口对象将波特率错误地转换为时钟滴答。一些 crate 甚至为每个 GPIO 引脚可以处于的状态定义特殊特征，要求用户在将引脚传递到外设之前将引脚置于正确的状态（例如，通过选择适当的备用功能模式）。一切都没有运行时成本！</p>
<p>让我们看一个例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// panic handler</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal <span class="token keyword">as</span> hal<span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>NewlineMode<span class="token punctuation">,</span> Serial<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> tm4c123x_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>sysctl<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cp <span class="token operator">=</span> hal<span class="token punctuation">:</span><span class="token punctuation">:</span>CorePeripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the SYSCTL struct into an object with a higher-layer API</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sc <span class="token operator">=</span> p<span class="token punctuation">.</span>SYSCTL<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Pick our oscillation settings</span>
    sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span>oscillator <span class="token operator">=</span> sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>Oscillator<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Main</span><span class="token punctuation">(</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>CrystalFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_16mhz<span class="token punctuation">,</span>
        sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>SystemClock<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UsePll</span><span class="token punctuation">(</span>sysctl<span class="token punctuation">:</span><span class="token punctuation">:</span>PllOutputFrequency<span class="token punctuation">:</span><span class="token punctuation">:</span>_80_00mhz<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Configure the PLL with those settings</span>
    <span class="token keyword">let</span> clocks <span class="token operator">=</span> sc<span class="token punctuation">.</span>clock_setup<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wrap up the GPIO_PORTA struct into an object with a higher-layer API.</span>
    <span class="token comment" spellcheck="true">// Note it needs to borrow `sc.power_control` so it can power up the GPIO</span>
    <span class="token comment" spellcheck="true">// peripheral automatically.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> porta <span class="token operator">=</span> p<span class="token punctuation">.</span>GPIO_PORTA<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Activate the UART.</span>
    <span class="token keyword">let</span> uart <span class="token operator">=</span> Serial<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">uart0</span><span class="token punctuation">(</span>
        p<span class="token punctuation">.</span>UART0<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The transmit pin</span>
        porta
            <span class="token punctuation">.</span>pa1
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The receive pin</span>
        porta
            <span class="token punctuation">.</span>pa0
            <span class="token punctuation">.</span>into_af_push_pull<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>hal<span class="token punctuation">:</span><span class="token punctuation">:</span>gpio<span class="token punctuation">:</span><span class="token punctuation">:</span>AF1<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> porta<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// No RTS or CTS required</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// The baud rate</span>
        <span class="token number">115200_u32</span><span class="token punctuation">.</span><span class="token function">bps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// Output handling</span>
        NewlineMode<span class="token punctuation">:</span><span class="token punctuation">:</span>SwapLFtoCRLF<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need the clock rates to calculate the baud rate divisors</span>
        <span class="token operator">&amp;</span>clocks<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// We need this to power up the UART peripheral</span>
        <span class="token operator">&amp;</span>sc<span class="token punctuation">.</span>power_control<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>uart<span class="token punctuation">,</span> <span class="token string">"Hello, World!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Semihosting（半主机）"><a href="#Semihosting（半主机）" class="headerlink" title="Semihosting（半主机）"></a>Semihosting（半主机）</h2><p>半主机是一种让嵌入式设备在主机上进行 I/O 的机制，主要用于将消息记录到主机控制台。半主机需要一个调试会话，几乎不需要其他任何东西（没有额外的电线！）所以它使用起来非常方便。缺点是它非常慢：根据您使用的硬件调试器（例如 ST-Link），每个写入操作可能需要几毫秒。</p>
<p>该<a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>箱提供了一个API做的Cortex-M的设备半主机操作。下面的程序是“Hello, world!”的半主机版本：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hprintln<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">hprintln!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你在硬件上运行这个程序，你会看到“Hello, world!” OpenOCD 日志中的消息。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
Hello, world!
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>您确实需要先从 GDB 在 OpenOCD 中启用半主机：</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) monitor arm semihosting enable
semihosting is enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>QEMU 理解半主机操作，因此上述程序也可以运行而 <code>qemu-system-arm</code>无需启动调试会话。请注意，您需要将<code>-semihosting-config</code>标志传递给 QEMU 以启用半主机支持；这些标志已经包含在<code>.cargo/config.toml</code>模板文件中。</p>
<pre class="line-numbers language-text"><code class="language-text">$ # this program will block the terminal
$ cargo run
     Running `qemu-system-arm (..)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有一个<code>exit</code>半主机操作可用于终止 QEMU 进程。重要提示：千万<strong>不能</strong>使用<code>debug::exit</code>硬件; 此功能可能会损坏您的 OpenOCD 会话，并且在您重新启动它之前您将无法调试更多程序。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> roses <span class="token operator">==</span> <span class="token string">"red"</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一个提示：您可以将恐慌行为设置为<code>exit(EXIT_FAILURE)</code>. 这将让您编写<code>no_std</code>可以在 QEMU 上运行的运行通过测试。</p>
<p>为方便起见，<code>panic-semihosting</code>板条箱具有“退出”功能，启用<code>exit(EXIT_FAILURE)</code>后会在将紧急消息记录到主机 stderr 后调用。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// features = ["exit"]</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>debug<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> roses <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>

    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>roses<span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
$ cargo run
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span><span class="token function">arm</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
panicked at 'assertion failed<span class="token punctuation">:</span> `<span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span>`
  left<span class="token punctuation">:</span> `<span class="token string">"blue"</span>`<span class="token punctuation">,</span>
 right<span class="token punctuation">:</span> `<span class="token string">"red"</span>`'<span class="token punctuation">,</span> examples<span class="token operator">/</span>hello<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">5</span>

$ echo $?
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意</strong>：要在 上启用此功能<code>panic-semihosting</code>，请编辑您的 <code>Cargo.toml</code>依赖项部分，其中<code>panic-semihosting</code>指定为：</p>
<pre class="line-numbers language-toml"><code class="language-toml">panic-semihosting = { version = "VERSION", features = ["exit"] }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>VERSION</code>想要的版本在哪里。有关依赖项功能的更多信息，请查看<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html" target="_blank" rel="noopener"><code>specifying dependencies</code></a>Cargo 书的部分。</p>
<h2 id="Panicking（恐慌）"><a href="#Panicking（恐慌）" class="headerlink" title="Panicking（恐慌）"></a>Panicking（恐慌）</h2><p>恐慌是 Rust 语言的核心部分。索引等内置操作会在运行时检查内存安全。当尝试越界索引时，这会导致恐慌。</p>
<p>在标准库中，恐慌有一个定义的行为：它展开恐慌线程的堆栈，除非用户选择在恐慌时中止程序。</p>
<p>然而，在没有标准库的程序中，恐慌行为是未定义的。可以通过声明<code>#[panic_handler]</code>函数来选择行为。该函数必须在程序的依赖图中只出现<em>一次</em>，并且必须具有以下签名：<code>fn(&amp;PanicInfo) -&gt; !</code>，其中<a href="https://doc.rust-lang.org/core/panic/struct.PanicInfo.html" target="_blank" rel="noopener"><code>PanicInfo</code></a> 是一个包含有关恐慌位置信息的结构。</p>
<p>鉴于嵌入式系统的范围从面向用户到安全关键（不能崩溃），没有一种适合所有恐慌行为的尺寸，但有很多常用行为。这些常见的行为已经被打包到定义<code>#[panic_handler]</code>函数的crate 中。一些例子包括：</p>
<ul>
<li><a href="https://crates.io/crates/panic-abort" target="_blank" rel="noopener"><code>panic-abort</code></a>. 恐慌导致中止指令被执行。</li>
<li><a href="https://crates.io/crates/panic-halt" target="_blank" rel="noopener"><code>panic-halt</code></a>. 恐慌导致程序或当前线程通过进入无限循环而停止。</li>
<li><a href="https://crates.io/crates/panic-itm" target="_blank" rel="noopener"><code>panic-itm</code></a>. 使用 ITM（一种 ARM Cortex-M 特定外设）记录紧急消息。</li>
<li><a href="https://crates.io/crates/panic-semihosting" target="_blank" rel="noopener"><code>panic-semihosting</code></a>. 使用半主机技术将恐慌消息记录到主机。</li>
</ul>
<p>您可以<a href="https://crates.io/keywords/panic-handler" target="_blank" rel="noopener"><code>panic-handler</code></a> 在 crates.io 上找到更多搜索关键字的 crate。</p>
<p>程序可以通过链接到相应的 crate 来选择这些行为之一。在应用程序的源代码中将恐慌行为表示为一行代码这一事实不仅可用作文档，而且还可用于根据编译配置文件更改恐慌行为。例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// dev profile: easier to debug panics; can put a breakpoint on `rust_begin_unwind`</span>
<span class="token attribute attr-name">#[cfg(debug_assertions)]</span>
<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// release profile: minimize the binary size of the application</span>
<span class="token attribute attr-name">#[cfg(not(debug_assertions))]</span>
<span class="token keyword">use</span> panic_abort <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此示例中，<code>panic-halt</code>使用 dev 配置文件 ( <code>cargo build</code>)构建时crate 链接到crate ，但<code>panic-abort</code>使用 release 配置文件 ( <code>cargo build --release</code>)构建时链接到crate 。</p>
<blockquote>
<p>语句的<code>use panic_abort as _;</code>形式<code>use</code>用于确保<code>panic_abort</code>恐慌处理程序包含在我们的最终可执行文件中，同时向编译器明确我们不会显式使用 crate 中的任何内容。如果没有<code>as _</code>重命名，编译器会警告我们有一个未使用的导入。有时候，你可能会看到<code>extern crate panic_abort</code>，而不是，这是2018年版的锈之前使用的旧风格，现在应该仅用于“SYSROOT”箱子（那些散发着铁锈本身），例如<code>proc_macro</code>，<code>alloc</code>，<code>std</code>，和<code>test</code>。</p>
</blockquote>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>这是一个尝试对超出其长度的数组进行索引的示例。操作导致恐慌。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_semihosting <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> xs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// out of bounds access</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此示例选择了<code>panic-semihosting</code>使用半主机将紧急消息打印到主机控制台的行为。</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo run
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb (..)
panicked at 'index out of bounds: the len is 3 but the index is 4', src/main.rs:12:13<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>您可以尝试将行为更改为<code>panic-halt</code>并确认在这种情况下不会打印任何消息。</p>
<h2 id="Exceptions（异常）"><a href="#Exceptions（异常）" class="headerlink" title="Exceptions（异常）"></a>Exceptions（异常）</h2><p>异常和中断是处理器处理异步事件和致命错误（例如执行无效指令）的硬件机制。异常意味着抢占并涉及异常处理程序、响应触发事件的信号而执行的子程序。</p>
<p>该<code>cortex-m-rt</code>箱提供了一个<a href="https://docs.rs/cortex-m-rt-macros/latest/cortex_m_rt_macros/attr.exception.html" target="_blank" rel="noopener"><code>exception</code></a>声明异常处理程序属性。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Exception handler for the SysTick (System Timer) exception</span>
<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了<code>exception</code>属性异常处理程序看起来像普通函数之外，还有一个区别：<code>exception</code>处理程序<em>不能</em>被软件调用。按照前面的示例，该语句<code>SysTick();</code> 将导致编译错误。</p>
<p>这种行为几乎是有意为之，它需要提供一个特性： <em>在</em>处理程序中<code>static mut</code>声明的变量可以<em>安全</em>使用。 <code>exception</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has transformed to type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可能知道，<code>static mut</code>在函数中使用变量会使其 <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)" target="_blank" rel="noopener"><em>不可重入</em></a>。从多个异常/中断处理程序或从<code>main</code>一个或多个异常/中断处理程序直接或间接调用不可重入函数是未定义的行为 。</p>
<p>安全 Rust 绝不能导致未定义的行为，因此不可重入函数必须标记为<code>unsafe</code>. 然而我只是告诉<code>exception</code>处理程序可以安全地使用<code>static mut</code>变量。这怎么可能？这是可能的，因为 <code>exception</code>处理程序<em>不能</em>被软件调用，因此重入是不可能的。</p>
<blockquote>
<p>请注意，该<code>exception</code>属性通过将静态变量包装到<code>unsafe</code>块中并为我们提供新的适当类型<code>&amp;mut</code>的同名变量来转换函数内静态变量的定义。因此，我们可以通过<code>*</code>访问变量的值来取消引用引用，而无需将它们包装在一个<code>unsafe</code>块中。</p>
</blockquote>
<h3 id="一个完整的例子"><a href="#一个完整的例子" class="headerlink" title="一个完整的例子"></a>一个完整的例子</h3><p>这是一个使用系统计时器<code>SysTick</code>大约每秒引发一次异常的示例。在<code>SysTick</code>异常处理程序跟踪它已经多少次被称为在<code>COUNT</code>变量，然后打印出的值 <code>COUNT</code>使用半主机主机控制台。</p>
<blockquote>
<p><strong>注意</strong>：您可以在任何 Cortex-M 设备上运行此示例；你也可以在 QEMU 上运行它</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>peripheral<span class="token punctuation">:</span><span class="token punctuation">:</span>syst<span class="token punctuation">:</span><span class="token punctuation">:</span>SystClkSource<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
    debug<span class="token punctuation">,</span>
    hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> HStdout<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> syst <span class="token operator">=</span> p<span class="token punctuation">.</span>SYST<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configures the system timer to trigger a SysTick exception every second</span>
    syst<span class="token punctuation">.</span><span class="token function">set_clock_source</span><span class="token punctuation">(</span>SystClkSource<span class="token punctuation">:</span><span class="token punctuation">:</span>Core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// this is configured for the LM3S6965 which has a default CPU clock of 12 MHz</span>
    syst<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">12_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">clear_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syst<span class="token punctuation">.</span><span class="token function">enable_interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">SysTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> STDOUT<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>HStdout<span class="token operator">></span> <span class="token operator">=</span> None<span class="token punctuation">;</span>

    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Lazy initialization</span>
    <span class="token keyword">if</span> STDOUT<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>STDOUT <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> STDOUT<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// IMPORTANT omit this `if` block if running on real hardware or your</span>
    <span class="token comment" spellcheck="true">// debugger will end in an inconsistent state</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>COUNT <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This will terminate the QEMU process</span>
        debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
tail <span class="token operator">-</span>n5 Cargo<span class="token punctuation">.</span>toml
<span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
cortex<span class="token operator">-</span>m <span class="token operator">=</span> <span class="token string">"0.5.7"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>rt <span class="token operator">=</span> <span class="token string">"0.6.3"</span>
panic<span class="token operator">-</span>halt <span class="token operator">=</span> <span class="token string">"0.2.0"</span>
cortex<span class="token operator">-</span>m<span class="token operator">-</span>semihosting <span class="token operator">=</span> <span class="token string">"0.3.1"</span>
$ cargo run <span class="token operator">-</span><span class="token operator">-</span>release
     Running `qemu<span class="token operator">-</span>system<span class="token operator">-</span>arm <span class="token operator">-</span>cpu cortex<span class="token operator">-</span>m3 <span class="token operator">-</span>machine <span class="token function">lm3s6965evb</span> <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
<span class="token number">123456789</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您在 Discovery 板上运行它，您将在 OpenOCD 控制台上看到输出。此外，当计数达到 9 时，程序<em>不会</em>停止。</p>
<h3 id="默认异常处理程序"><a href="#默认异常处理程序" class="headerlink" title="默认异常处理程序"></a>默认异常处理程序</h3><p>该<code>exception</code>属性的实际作用是<em>覆盖</em>特定异常的默认异常处理程序。如果您不覆盖特定异常的处理程序，它将由<code>DefaultHandler</code>函数处理，该函数默认为：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此函数由<code>cortex-m-rt</code>crate提供并标记为， <code>#[no_mangle]</code>以便您可以在“DefaultHandler”上放置断点并捕获 <em>未处理的</em>异常。</p>
<p>可以<code>DefaultHandler</code>使用<code>exception</code>属性覆盖它：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">DefaultHandler</span><span class="token punctuation">(</span>irqn<span class="token punctuation">:</span> i16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// custom default handler</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>irqn</code>参数指示正在处理哪个异常。负值表示正在处理 Cortex-M 异常；零或正值表示正在处理设备特定异常（AKA 中断）。</p>
<h3 id="硬故障处理程序"><a href="#硬故障处理程序" class="headerlink" title="硬故障处理程序"></a>硬故障处理程序</h3><p>在<code>HardFault</code>例外的情况比较特殊。当程序进入无效状态时会触发此异常，因此其处理程序<em>无法</em>返回，因为这可能导致未定义的行为。此外，运行时 crate 在<code>HardFault</code>调用用户定义的处理程序之前会做一些工作，以提高可调试性。</p>
<p>结果是<code>HardFault</code>处理程序必须具有以下签名： <code>fn(&amp;ExceptionFrame) -&gt; !</code>. 处理程序的参数是一个指向由异常压入堆栈的寄存器的指针。这些寄存器是触发异常时处理器状态的快照，可用于诊断硬故障。</p>
<p>这是一个执行非法操作的示例：读取不存在的内存位置。</p>
<blockquote>
<p><strong>注意</strong>：这个程序在 QEMU<code>qemu-system-arm -machine lm3s6965evb</code>上无法运行，即它不会崩溃，因为 它不检查内存负载，并且会很高兴地<code>0</code>在读取无效内存时返回。</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> panic_halt <span class="token keyword">as</span> _<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> exception<span class="token punctuation">,</span> ExceptionFrame<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span>hio<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// read a nonexistent memory location</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x3FFF_FFFE</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[exception]</span>
<span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>ef<span class="token punctuation">:</span> <span class="token operator">&amp;</span>ExceptionFrame<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">mut</span> hstdout<span class="token punctuation">)</span> <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#?}"</span><span class="token punctuation">,</span> ef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>HardFault</code>处理器打印<code>ExceptionFrame</code>值。如果您运行它，您将在 OpenOCD 控制台上看到类似的内容。</p>
<pre class="line-numbers language-text"><code class="language-text">$ openocd
(..)
ExceptionFrame {
    r0: 0x3ffffffe,
    r1: 0x00f00000,
    r2: 0x20000000,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x080008f7,
    pc: 0x0800094a,
    xpsr: 0x61000000
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>pc</code>值是异常发生时程序计数器的值，它指向触发异常的指令。</p>
<p>如果你看一下程序的反汇编：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo objdump --bin app --release -- -d --no-show-raw-insn --print-imm-hex
(..)
ResetTrampoline:
 8000942:       movw    r0, #0xfffe
 8000946:       movt    r0, #0x3fff
 800094a:       ldr     r0, [r0]
 800094c:       b       #-0x4 <ResetTrampoline+0xa><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可以在反<code>0x0800094a</code>汇编中查找程序计数器的值。您将看到加载操作 ( <code>ldr r0, [r0]</code>) 导致了异常。本<code>r0</code>场<code>ExceptionFrame</code>会告诉你寄存器的值<code>r0</code> 是<code>0x3fff_fffe</code>在那个时候。</p>
<h2 id="Interrupts（中断）"><a href="#Interrupts（中断）" class="headerlink" title="Interrupts（中断）"></a>Interrupts（中断）</h2><p>中断在很多方面与异常不同，但它们的操作和使用大体相似，并且它们也由相同的中断控制器处理。尽管异常由 Cortex-M 架构定义，但中断始终是供应商（通常甚至是芯片）在命名和功能方面的特定实现。</p>
<p>中断确实提供了很大的灵活性，在尝试以高级方式使用它们时需要考虑到这一点。我们不会在本书中介绍这些用途，但记住以下几点是个好主意：</p>
<ul>
<li>中断具有可编程的优先级，这些优先级决定了它们的处理程序的执行顺序</li>
<li>中断可以嵌套和抢占，即中断处理程序的执行可能会被另一个更高优先级的中断中断</li>
<li>一般需要清除导致中断触发的原因，防止无休止地重新进入中断处理程序</li>
</ul>
<p>运行时的一般初始化步骤始终相同：</p>
<ul>
<li>设置外设以在所需场合生成中断请求</li>
<li>在中断控制器中设置中断处理程序所需的优先级</li>
<li>在中断控制器中启用中断处理程序</li>
</ul>
<p>与异常类似，<code>cortex-m-rt</code>crate 提供了一个<a href="https://docs.rs/cortex-m-rt-macros/0.1.5/cortex_m_rt_macros/attr.interrupt.html" target="_blank" rel="noopener"><code>interrupt</code></a> 属性来声明中断处理程序。可用的中断（以及它们在中断处理程序表中的位置）通常是通过<code>svd2rust</code>SVD 描述自动生成的。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Interrupt handler for the Timer2 interrupt</span>
<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
    <span class="token comment" spellcheck="true">// Clear reason for the generated interrupt request</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>中断处理程序看起来像普通函数（除了缺少参数）类似于异常处理程序。然而，由于特殊的调用约定，它们不能被固件的其他部分直接调用。然而，可以在软件中生成中断请求以触发对中断处理程序的转移。</p>
<p>与异常处理程序类似，也可以<code>static mut</code> 在中断处理程序中声明变量以保持<em>安全</em>状态。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">TIM2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">mut</span> COUNT<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// `COUNT` has type `&amp;mut u32` and it's safe to use</span>
    <span class="token operator">*</span>COUNT <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p><strong>TODO</strong> Cover memory mapped I/O using registers.</p>
<h1 id="Peripherals（外设）"><a href="#Peripherals（外设）" class="headerlink" title="Peripherals（外设）"></a>Peripherals（外设）</h1><h3 id="什么是外设？"><a href="#什么是外设？" class="headerlink" title="什么是外设？"></a>什么是外设？</h3><p>大多数微控制器不仅仅是一个 CPU、RAM 或闪存——它们包含硅片部分，用于与微控制器之外的系统进行交互，以及通过传感器、电机控制器直接或间接地与周围环境进行交互，或人机界面，如显示器或键盘。这些组件统称为外围设备。</p>
<p>这些外设很有用，因为它们允许开发人员将处理工作卸载给它们，从而避免必须在软件中处理所有事情。类似于桌面开发人员将图形处理卸载到视频卡的方式，嵌入式开发人员可以将一些任务卸载到外围设备，从而让 CPU 将时间花在做其他重要的事情上，或者什么都不做以节省电量。</p>
<p>如果您查看 1970 年代或 1980 年代的老式家用计算机的主电路板（实际上，昨天的台式 PC 与今天的嵌入式系统相距甚远），您会期望看到：</p>
<ul>
<li>处理器</li>
<li>一个内存芯片</li>
<li>一个ROM芯片</li>
<li>一个 I/O 控制器</li>
</ul>
<p>RAM 芯片、ROM 芯片和 I/O 控制器（该系统中的外围设备）将通过一系列称为“总线”的并行迹线连接到处理器。该总线承载地址信息，它选择处理器希望与总线上的哪个设备进行通信，以及承载实际数据的数据总线。在我们的嵌入式微控制器中，同样的原则适用 - 只是所有东西都封装在一块硅上。</p>
<p>但是，与通常具有 Vulkan、Metal 或 OpenGL 等软件 API 的图形卡不同，外围设备通过硬件接口暴露给我们的微控制器，该接口映射到一块内存。</p>
<h3 id="线性和实内存空间"><a href="#线性和实内存空间" class="headerlink" title="线性和实内存空间"></a>线性和实内存空间</h3><p>在微控制器上，将一些数据写入其他任意地址（例如<code>0x4000_0000</code>或<code>0x0000_0000</code>）也可能是完全有效的操作。</p>
<p>在桌面系统上，对内存的访问由 MMU 或内存管理单元严格控制。该组件有两个主要职责：强制执行对内存部分的访问权限（防止一个进程读取或修改另一个进程的内存）；并将物理内存的段重新映射到软件中使用的虚拟内存范围。微控制器通常没有 MMU，而是仅在软件中使用真实的物理地址。</p>
<p>尽管 32 位微控制器具有来自<code>0x0000_0000</code>, 和的真实线性地址空间<code>0xFFFF_FFFF</code>，但它们通常只使用该范围的几百 KB 用于实际内存。这留下了大量的地址空间。在前面的章节中，我们讨论了 RAM 位于 address <code>0x2000_0000</code>。如果我们的RAM为64昆明植物研究所长（即0xFFFF的最大地址），然后地址<code>0x2000_0000</code>，以<code>0x2000_FFFF</code>将对应于我们的RAM。当我们写入一个位于 address 的变量<code>0x2000_1234</code>时，内部发生的事情是一些逻辑检测地址的高位部分（在本例中为 0x2000），然后激活 RAM 以便它可以对地址的低位部分（0x1234在这种情况下）。在 Cortex-M 上，我们也将闪存 ROM 映射到地址<code>0x0000_0000</code>直到地址<code>0x0007_FFFF</code>（如果我们有 512 KiB 闪存 ROM）。微控制器设计者并没有忽略这两个区域之间的所有剩余空间，而是将外围设备的接口映射到某些存储器位置。这最终看起来像这样：</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-memory-map.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 数据表 (pdf)</a></p>
<h3 id="内存映射外设"><a href="#内存映射外设" class="headerlink" title="内存映射外设"></a>内存映射外设</h3><p>乍一看，与这些外设的交互很简单——将正确的数据写入正确的地址。例如，通过串行端口发送 32 位字可能与将该 32 位字写入某个内存地址一样直接。然后串行端口外围设备将接管并自动发送数据。</p>
<p>这些外设的配置工作类似。不是调用函数来配置外设，而是公开了一块内存，用作硬件 API。写入<code>0x8000_0000</code>SPI 频率配置寄存器，SPI 端口将以每秒 8 兆位的速度发送数据。写入<code>0x0200_0000</code>相同的地址，SPI 端口将以每秒 125 千位的速度发送数据。这些配置寄存器看起来有点像这样：</p>
<p><img src="/images/loading.gif" data-original="../images/language/nrf52-spi-frequency-register.png" alt=""></p>
<p><a href="http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf" target="_blank" rel="noopener">Nordic nRF52832 数据表 (pdf)</a></p>
<p>无论使用何种语言，无论该语言是汇编、C 还是 Rust，此接口都是与硬件进行交互的方式。</p>
<h2 id="A-First-Attempt"><a href="#A-First-Attempt" class="headerlink" title="A First Attempt"></a>A First Attempt</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>让我们看看“SysTick”外设 - 每个 Cortex-M 处理器内核都附带一个简单的计时器。通常，您会在芯片制造商的数据表或<em>技术参考手册中</em>查找这些内容，但此示例适用于所有 ARM Cortex-M 内核，让我们查看<a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0553a/Babieigh.html" target="_blank" rel="noopener">ARM 参考手册</a>。我们看到有四个寄存器：</p>
<table>
<thead>
<tr>
<th>抵消</th>
<th>姓名</th>
<th>描述</th>
<th>宽度</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>SYST_CSR</td>
<td>控制和状态寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x04</td>
<td>SYST_RVR</td>
<td>重载值寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x08</td>
<td>SYST_CVR</td>
<td>当前值寄存器</td>
<td>32位</td>
</tr>
<tr>
<td>0x0C</td>
<td>SYST_CALIB</td>
<td>校准值寄存器</td>
<td>32位</td>
</tr>
</tbody></table>
<h3 id="C-方法"><a href="#C-方法" class="headerlink" title="C 方法"></a>C 方法</h3><p>在 Rust 中，我们可以用与在 C 中完全相同的方式来表示一组寄存器 - 使用<code>struct</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>限定符<code>#[repr(C)]</code>告诉 Rust 编译器像 C 编译器那样布置这个结构。这非常重要，因为 Rust 允许重新排序结构字段，而 C 则不允许。您可以想象如果这些字段被编译器默默地重新排列，我们将不得不进行调试！有了这个限定符，我们就有了与上表相对应的四个 32 位字段。但是当然，这<code>struct</code>本身是没有用的——我们需要一个变量。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token operator">*</span>systick<span class="token punctuation">)</span><span class="token punctuation">.</span>cvr <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="Volatile-Accesses"><a href="#Volatile-Accesses" class="headerlink" title="Volatile Accesses"></a>Volatile Accesses</h3><p>现在，上述方法存在一些问题。</p>
<ol>
<li>每次我们想访问我们的外设时，我们都必须使用 unsafe。</li>
<li>我们无法指定哪些寄存器是只读的或读写的。</li>
<li>程序中任何位置的任何代码都可以通过此结构访问硬件。</li>
<li>最重要的是，它实际上不起作用……</li>
</ol>
<p>现在，问题是编译器很聪明。如果您对同一块 RAM 进行两次写入，一个接一个，编译器会注意到这一点，并且完全跳过第一次写入。在 C 中，我们可以将变量标记为<code>volatile</code>确保每次读取或写入都按预期进行。在 Rust 中，我们将<em>访问</em>标记为 volatile，而不是变量。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> systick<span class="token punctuation">.</span>cvr<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以，我们已经解决了四个问题之一，但现在我们有更多的<code>unsafe</code>代码！幸运的是，有一个第三方板条箱可以提供帮助 - <a href="https://crates.io/crates/volatile_register" target="_blank" rel="noopener"><code>volatile_register</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> SysTick <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> SysTick<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
    <span class="token keyword">let</span> systick <span class="token operator">=</span> <span class="token function">get_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    systick<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，易失性访问是通过<code>read</code>和<code>write</code>方法自动执行的。它仍然<code>unsafe</code>是执行写入，但公平地说，硬件是一堆可变状态，编译器无法知道这些写入是否真正安全，因此这是一个很好的默认位置。</p>
<h3 id="The-Rusty-Wrapper"><a href="#The-Rusty-Wrapper" class="headerlink" title="The Rusty Wrapper"></a>The Rusty Wrapper</h3><p>我们需要将其封装<code>struct</code>到一个更高层的 API 中，以便我们的用户可以安全地调用。作为驱动程序作者，我们手动验证不安全代码是否正确，然后为我们的用户提供一个安全的 API，这样他们就不必担心（前提是他们相信我们会做对！）。</p>
<p>一个例子可能是：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> volatile_register<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>RW<span class="token punctuation">,</span> RO<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> SystemTimer <span class="token punctuation">{</span>
    p<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> RegisterBlock
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> RegisterBlock <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> csr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> rvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> cvr<span class="token punctuation">:</span> RW<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> calib<span class="token punctuation">:</span> RO<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> SystemTimer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SystemTimer <span class="token punctuation">{</span>
        SystemTimer <span class="token punctuation">{</span>
            p<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xE000_E010</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> RegisterBlock<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>cvr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> reload_value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span>rvr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reload_value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">example_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">0x00FF_FFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"Time is now 0x{:08x}"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token function">get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，这种方法的问题是编译器完全可以接受以下代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> st <span class="token operator">=</span> SystemTimer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    st<span class="token punctuation">.</span><span class="token function">set_reload</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们<code>&amp;mut self</code>对该<code>set_reload</code>函数的参数检查是否没有<em>对该</em>特定<code>SystemTimer</code>结构的其他引用，但它们不会阻止用户创建第二个<code>SystemTimer</code>指向完全相同的外围设备！如果作者足够勤奋地发现所有这些“重复”的驱动程序实例，以这种方式编写的代码将起作用，但是一旦代码分布在多个模块、驱动程序、开发人员和数天中，编写这些代码会变得越来越容易各种错误。</p>
<h2 id="The-Borrow-Checker"><a href="#The-Borrow-Checker" class="headerlink" title="The Borrow Checker"></a>The Borrow Checker</h2><h3 id="可变全局状态"><a href="#可变全局状态" class="headerlink" title="可变全局状态"></a>可变全局状态</h3><p>不幸的是，硬件基本上只是可变的全局状态，这对于 Rust 开发人员来说可能会感到非常可怕。硬件独立于我们编写的代码结构而存在，并且可以随时被现实世界修改。</p>
<h3 id="我们的规则应该是什么？"><a href="#我们的规则应该是什么？" class="headerlink" title="我们的规则应该是什么？"></a>我们的规则应该是什么？</h3><p>我们如何才能可靠地与这些外围设备交互？</p>
<ol>
<li>始终使用<code>volatile</code>读取或写入外围存储器的方法，因为它可以随时更改</li>
<li>在软件中，我们应该能够共享对这些外设的任意数量的只读访问</li>
<li>如果某些软件应该具有对外围设备的读写访问权限，则它应该持有对该外围设备的唯一引用</li>
</ol>
<h3 id="借用检查器"><a href="#借用检查器" class="headerlink" title="借用检查器"></a>借用检查器</h3><p>这些规则中的最后两条听起来与 Borrow Checker 已经做的很相似！</p>
<p>想象一下，我们是否可以传递这些外围设备的所有权，或者为它们提供不可变或可变的引用？</p>
<p>嗯，我们可以，但是对于 Borrow Checker，我们需要每个外设正好有一个实例，这样 Rust 才能正确处理这个问题。好吧，幸运的是在硬件中，任何给定的外围设备只有一个实例，但是我们如何在代码结构中公开它？</p>
<h2 id="Singletons"><a href="#Singletons" class="headerlink" title="Singletons"></a>Singletons</h2><blockquote>
<p>在软件工程中，单例模式是一种软件设计模式，它将类的实例化限制为一个对象。</p>
<p><em>维基百科：<a href="https://en.wikipedia.org/wiki/Singleton_pattern" target="_blank" rel="noopener">单例模式</a></em></p>
</blockquote>
<h3 id="但是为什么我们不能只使用全局变量呢？"><a href="#但是为什么我们不能只使用全局变量呢？" class="headerlink" title="但是为什么我们不能只使用全局变量呢？"></a>但是为什么我们不能只使用全局变量呢？</h3><p>我们可以让一切都变成公共静态，就像这样</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> THE_SERIAL_PORT<span class="token punctuation">:</span> SerialPort <span class="token operator">=</span> SerialPort<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        THE_SERIAL_PORT<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但这有几个问题。它是一个可变的全局变量，在 Rust 中，与这些变量交互总是不安全的。这些变量在整个程序中也是可见的，这意味着借用检查器无法帮助您跟踪这些变量的引用和所有权。</p>
<h3 id="我们如何在-Rust-中做到这一点？"><a href="#我们如何在-Rust-中做到这一点？" class="headerlink" title="我们如何在 Rust 中做到这一点？"></a>我们如何在 Rust 中做到这一点？</h3><p>我们不只是让我们的外设成为一个全局变量，而是决定创建一个全局变量，在这种情况下称为<code>PERIPHERALS</code>，它包含<code>Option&lt;T&gt;</code>我们每个外设的 。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>SerialPort<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Peripherals <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> SerialPort <span class="token punctuation">{</span>
        <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> PERIPHERALS<span class="token punctuation">:</span> Peripherals <span class="token operator">=</span> Peripherals <span class="token punctuation">{</span>
    serial<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>SerialPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种结构使我们能够获得外围设备的单个实例。如果我们尝试<code>take_serial()</code>多次调用，我们的代码就会崩溃！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// This panics!</span>
    <span class="token comment" spellcheck="true">// let serial_2 = unsafe { PERIPHERALS.take_serial() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>尽管与这个结构交互是<code>unsafe</code>，但是一旦我们包含了<code>SerialPort</code>它，我们就不再需要使用<code>unsafe</code>，或者根本不需要使用该<code>PERIPHERALS</code>结构。</p>
<p>这有一个小的运行时开销，因为我们必须将<code>SerialPort</code>结构包装在一个选项中，我们需要调用<code>take_serial()</code>一次，但是这个小的前期成本允许我们在我们程序的其余部分中利用借用检查器。</p>
<h3 id="现有库支持"><a href="#现有库支持" class="headerlink" title="现有库支持"></a>现有库支持</h3><p>尽管我们在<code>Peripherals</code>上面创建了自己的结构，但没有必要为您的代码执行此操作。在<code>cortex_m</code>箱子中含有一种叫宏<code>singleton!()</code>，会为你执行此操作。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_use(singleton)]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// OK if `main` is executed only once</span>
    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> bool <span class="token operator">=</span>
        <span class="token function">singleton!</span><span class="token punctuation">(</span><span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://docs.rs/cortex-m/latest/cortex_m/macro.singleton.html" target="_blank" rel="noopener">cortex_m 文档</a></p>
<p>此外，如果您使用<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener"><code>cortex-m-rtic</code></a>，则定义和获取这些外设的整个过程都会为您抽象化，您将获得一个<code>Peripherals</code>结构，其中包含<code>Option&lt;T&gt;</code>您定义的所有项目的非版本。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// cortex-m-rtic v0.5.x</span>
#<span class="token punctuation">[</span>rtic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">app</span><span class="token punctuation">(</span>device <span class="token operator">=</span> lm3s6965<span class="token punctuation">,</span> peripherals <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> APP<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[init]</span>
    <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>cx<span class="token punctuation">:</span> init<span class="token punctuation">:</span><span class="token punctuation">:</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">mut</span> X<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Cortex-M peripherals</span>
        <span class="token keyword">let</span> core<span class="token punctuation">:</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>core<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Device specific peripherals</span>
        <span class="token keyword">let</span> device<span class="token punctuation">:</span> lm3s6965<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals <span class="token operator">=</span> cx<span class="token punctuation">.</span>device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="但为什么？"><a href="#但为什么？" class="headerlink" title="但为什么？"></a>但为什么？</h3><p>但是这些单例如何对我们的 Rust 代码的工作方式产生显着的影响？</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SER_PORT_SPEED_REG<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32 <span class="token operator">=</span> <span class="token number">0x4000_1000</span> <span class="token keyword">as</span> _<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">read_speed</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token comment" spellcheck="true">// &lt;------ This is really, really important</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>SER_PORT_SPEED_REG<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有两个重要因素在起作用：</p>
<ul>
<li>因为我们使用的是单例，所以只有一种方法或地方可以获取<code>SerialPort</code>结构</li>
<li>要调用该<code>read_speed()</code>方法，我们必须拥有所有权或对<code>SerialPort</code>结构的引用</li>
</ul>
<p>这两个因素放在一起意味着只有在我们适当满足借用检查器的情况下才能访问硬件，这意味着我们在任何时候都不会对同一硬件有多个可变引用！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// missing reference to `self`! Won't work.</span>
    <span class="token comment" spellcheck="true">// SerialPort::read_speed();</span>

    <span class="token keyword">let</span> serial_1 <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> PERIPHERALS<span class="token punctuation">.</span><span class="token function">take_serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// you can only read what you have access to</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> serial_1<span class="token punctuation">.</span><span class="token function">read_speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="像对待数据一样对待硬件"><a href="#像对待数据一样对待硬件" class="headerlink" title="像对待数据一样对待硬件"></a>像对待数据一样对待硬件</h3><p>此外，由于一些引用是可变的，而一些引用是不可变的，因此可以查看函数或方法是否有可能修改硬件的状态。例如，</p>
<p>允许更改硬件设置：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">setup_spi_port</span><span class="token punctuation">(</span>
    spi<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> SpiPort<span class="token punctuation">,</span>
    cs_pin<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> GpioPin
<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这不是：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read_button</span><span class="token punctuation">(</span>gpio<span class="token punctuation">:</span> <span class="token operator">&amp;</span>GpioPin<span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这允许我们强制代码是否应该或不应该在<strong>编译时而</strong>不是在运行时对硬件进行更改。请注意，这通常仅适用于一个应用程序，但对于裸机系统，我们的软件将被编译为单个应用程序，因此这通常不是限制。</p>
<h1 id="Static-Guarantees"><a href="#Static-Guarantees" class="headerlink" title="Static Guarantees"></a>Static Guarantees</h1><p>Rust 的类型系统在编译时防止数据竞争（请参阅<a href="https://doc.rust-lang.org/core/marker/trait.Send.html" target="_blank" rel="noopener"><code>Send</code></a>和 <a href="https://doc.rust-lang.org/core/marker/trait.Sync.html" target="_blank" rel="noopener"><code>Sync</code></a>特征）。类型系统还可用于在编译时检查其他属性；在某些情况下减少运行时检查的需要。</p>
<p>例如，当应用于嵌入式程序时，可以使用这些<em>静态检查</em>来强制正确完成 I/O 接口的配置。例如，可以设计一个 API，其中只能通过首先配置接口将使用的引脚来初始化串行接口。</p>
<p>还可以静态检查操作，例如将引脚设置为低电平，只能在正确配置的外设上执行。例如，尝试更改配置为浮动输入模式的引脚的输出状态会引发编译错误。</p>
<p>并且，如前一章所见，所有权的概念可以应用于外设，以确保只有程序的某些部分可以修改外设。与将外围设备视为全局可变状态的替代方案相比，这种<em>访问控制</em>使软件更容易推理。</p>
<h2 id="Typestate-Programming"><a href="#Typestate-Programming" class="headerlink" title="Typestate Programming"></a>Typestate Programming</h2><p><a href="https://en.wikipedia.org/wiki/Typestate_analysis" target="_blank" rel="noopener">typestates</a>的概念描述了将有关对象当前状态的信息编码为该对象的类型。虽然这听起来有点神秘，但如果您在 Rust 中使用过<a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html" target="_blank" rel="noopener">构建器模式</a>，那么您已经开始使用 Typestate Programming！</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">mod</span> foo_module <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[derive(Debug)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
        inner<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">struct</span> FooBuilder <span class="token punctuation">{</span>
        a<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> FooBuilder <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>starter<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> starter<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">double_a</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
            Self <span class="token punctuation">{</span>
                a<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Foo <span class="token punctuation">{</span>
            Foo <span class="token punctuation">{</span>
                inner<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> foo_module<span class="token punctuation">:</span><span class="token punctuation">:</span>FooBuilder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">double_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个例子中，没有直接的方法来创建一个<code>Foo</code>对象。我们必须创建一个<code>FooBuilder</code>，并正确初始化它，然后才能获得<code>Foo</code>我们想要的对象。</p>
<p>这个最小的例子编码了两个状态：</p>
<ul>
<li><code>FooBuilder</code>，表示“未配置”或“配置进行中”状态</li>
<li><code>Foo</code>，表示“已配置”或“准备使用”状态。</li>
</ul>
<h3 id="强类型"><a href="#强类型" class="headerlink" title="强类型"></a>强类型</h3><p>因为 Rust 有一个<a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing" target="_blank" rel="noopener">强类型系统</a>，没有简单的方法可以神奇地创建 的实例<code>Foo</code>，或者在不调用方法<code>FooBuilder</code>的<code>Foo</code>情况下将 a变成 a <code>into_foo()</code>。此外，调用该<code>into_foo()</code>方法会消耗原始<code>FooBuilder</code>结构，这意味着如果不创建新实例就无法重用它。</p>
<p>这允许我们将系统的状态表示为类型，并将状态转换的必要操作包含到将一种类型交换为另一种类型的方法中。通过创建一个<code>FooBuilder</code>并将其交换为一个<code>Foo</code>对象，我们已经完成了基本状态机的步骤。</p>
<h2 id="Peripherals-as-State-Machines"><a href="#Peripherals-as-State-Machines" class="headerlink" title="Peripherals as State Machines"></a>Peripherals as State Machines</h2><p>微控制器的外围设备可以被认为是一组状态机。例如，简化<a href="https://en.wikipedia.org/wiki/General-purpose_input/output" target="_blank" rel="noopener">GPIO 引脚</a>的配置可以表示为以下状态树：</p>
<ul>
<li>已禁用</li>
<li>启用<ul>
<li>配置为输出<ul>
<li>输出：高</li>
<li>输出：低</li>
</ul>
</li>
<li>配置为输入<ul>
<li>输入：高阻</li>
<li>输入：拉低</li>
<li>输入：拉高</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>如果外设在<code>Disabled</code>模式下启动，要移动到<code>Input: High Resistance</code>模式，我们必须执行以下步骤：</p>
<ol>
<li>已禁用</li>
<li>启用</li>
<li>配置为输入</li>
<li>输入：高阻</li>
</ol>
<p>如果我们想从 移动<code>Input: High Resistance</code>到<code>Input: Pulled Low</code>，我们必须执行以下步骤：</p>
<ol>
<li>输入：高阻</li>
<li>输入：拉低</li>
</ol>
<p>同样，如果我们要将 GPIO 引脚从配置为 移动<code>Input: Pulled Low</code>到<code>Output: High</code>，我们必须执行以下步骤：</p>
<ol>
<li>输入：拉低</li>
<li>配置为输入</li>
<li>配置为输出</li>
<li>输出：高</li>
</ol>
<h3 id="硬件表示"><a href="#硬件表示" class="headerlink" title="硬件表示"></a>硬件表示</h3><p>通常，上面列出的状态是通过将值写入映射到 GPIO 外设的给定寄存器来设置的。让我们定义一个虚构的 GPIO 配置寄存器来说明这一点：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>位数</th>
<th>价值</th>
<th>意义</th>
<th>笔记</th>
</tr>
</thead>
<tbody><tr>
<td>使能够</td>
<td>0</td>
<td>0</td>
<td>残疾</td>
<td>禁用 GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>启用</td>
<td>启用 GPIO</td>
</tr>
<tr>
<td>方向</td>
<td>1</td>
<td>0</td>
<td>输入</td>
<td>将方向设置为输入</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>输出</td>
<td>将方向设置为输出</td>
</tr>
<tr>
<td>输入模式</td>
<td>2..3</td>
<td>00</td>
<td>高阻抗</td>
<td>将输入设置为高电阻</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>下拉</td>
<td>输入引脚被拉低</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>拉高</td>
<td>输入引脚被拉高</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>不适用</td>
<td>无效状态。不要设置</td>
</tr>
<tr>
<td>输出模式</td>
<td>4</td>
<td>0</td>
<td>设置低</td>
<td>输出引脚被驱动为低电平</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>设置高</td>
<td>输出引脚被驱动为高电平</td>
</tr>
<tr>
<td>输入状态</td>
<td>5</td>
<td>X</td>
<td>有效值</td>
<td>0 如果输入 &lt; 1.5v，1 如果输入 &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>我们<em>可以</em>在 Rust 中暴露以下结构来控制这个 GPIO：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，这将允许我们修改某些没有意义的寄存器。例如，如果我们<code>output_mode</code>在 GPIO 配置为输入时设置该字段会发生什么？</p>
<p>一般来说，使用这种结构将允许我们达到上面状态机未定义的状态：例如，输出被拉低，或输入被设置为高。对于某些硬件，这可能无关紧要。在其他硬件上，它可能会导致意外或未定义的行为！</p>
<p>虽然这个接口编写起来很方便，但它并没有强制执行我们的硬件实现所规定的设计契约。</p>
<h2 id="Design-Contracts"><a href="#Design-Contracts" class="headerlink" title="Design Contracts"></a>Design Contracts</h2><p>在上一章中，我们编写了一个<em>不</em>强制执行设计契约的接口。让我们再看看我们想象中的 GPIO 配置寄存器：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>位数</th>
<th>价值</th>
<th>意义</th>
<th>笔记</th>
</tr>
</thead>
<tbody><tr>
<td>使能够</td>
<td>0</td>
<td>0</td>
<td>残疾</td>
<td>禁用 GPIO</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>启用</td>
<td>启用 GPIO</td>
</tr>
<tr>
<td>方向</td>
<td>1</td>
<td>0</td>
<td>输入</td>
<td>将方向设置为输入</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>输出</td>
<td>将方向设置为输出</td>
</tr>
<tr>
<td>输入模式</td>
<td>2..3</td>
<td>00</td>
<td>高阻抗</td>
<td>将输入设置为高电阻</td>
</tr>
<tr>
<td></td>
<td></td>
<td>01</td>
<td>下拉</td>
<td>输入引脚被拉低</td>
</tr>
<tr>
<td></td>
<td></td>
<td>10</td>
<td>拉高</td>
<td>输入引脚被拉高</td>
</tr>
<tr>
<td></td>
<td></td>
<td>11</td>
<td>不适用</td>
<td>无效状态。不要设置</td>
</tr>
<tr>
<td>输出模式</td>
<td>4</td>
<td>0</td>
<td>设置低</td>
<td>输出引脚被驱动为低电平</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>设置高</td>
<td>输出引脚被驱动为高电平</td>
</tr>
<tr>
<td>输入状态</td>
<td>5</td>
<td>X</td>
<td>有效值</td>
<td>0 如果输入 &lt; 1.5v，1 如果输入 &gt;= 1.5v</td>
</tr>
</tbody></table>
<p>如果我们在使用底层硬件之前检查状态，在运行时执行我们的设计契约，我们可能会编写如下代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> GpioConfig <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_enabled<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_enabled<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_direction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_output<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set direction</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_output<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_input_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> variant<span class="token punctuation">:</span> InputMode<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set input mode</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">variant</span><span class="token punctuation">(</span>variant<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_output_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> is_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to set output status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be output</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>is_high<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">get_input_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>bool<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must be enabled to get status</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Direction must be input</span>
            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">input_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为我们需要对硬件实施限制，所以我们最终会进行大量的运行时检查，这会浪费时间和资源，而且这些代码对于开发人员来说使用起来会很不愉快。</p>
<h3 id="类型状态"><a href="#类型状态" class="headerlink" title="类型状态"></a>类型状态</h3><p>但是，如果我们使用 Rust 的类型系统来强制执行状态转换规则呢？拿这个例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// GPIO interface</span>
<span class="token keyword">struct</span> GpioConfig<span class="token operator">&lt;</span>ENABLED<span class="token punctuation">,</span> DIRECTION<span class="token punctuation">,</span> MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// GPIO Configuration structure generated by svd2rust</span>
    periph<span class="token punctuation">:</span> GPIO_CONFIG<span class="token punctuation">,</span>
    enabled<span class="token punctuation">:</span> ENABLED<span class="token punctuation">,</span>
    direction<span class="token punctuation">:</span> DIRECTION<span class="token punctuation">,</span>
    mode<span class="token punctuation">:</span> MODE<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Type states for MODE in GpioConfig</span>
<span class="token keyword">struct</span> Disabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Output<span class="token punctuation">;</span>
<span class="token keyword">struct</span> Input<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledLow<span class="token punctuation">;</span>
<span class="token keyword">struct</span> PulledHigh<span class="token punctuation">;</span>
<span class="token keyword">struct</span> HighZ<span class="token punctuation">;</span>
<span class="token keyword">struct</span> DontCare<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/// These functions may be used on any GPIO Pin</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>EN<span class="token punctuation">,</span> DIR<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_disabled</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> DontCare<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Disabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_r<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span>enable<span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>input_mode<span class="token punctuation">.</span><span class="token function">set_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Output<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> DontCare<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// This function may be used on an Output Pin</span>
<span class="token keyword">impl</span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> DontCare<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> set_high<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span>output_mode<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span>set_high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// These methods may be used on any enabled input GPIO</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>IN_MODE<span class="token operator">></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> IN_MODE<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>input_status<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledLow<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_low</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledLow<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_pull_up</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pull_high</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GpioConfig <span class="token punctuation">{</span>
            periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
            enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
            direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
            mode<span class="token punctuation">:</span> PulledHigh<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在让我们看看使用它的代码会是什么样子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/*
 * Example 1: Unconfigured to High-Z input
 */</span>
<span class="token keyword">let</span> pin<span class="token punctuation">:</span> GpioConfig<span class="token operator">&lt;</span>Disabled<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">get_gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, pin isn't enabled!</span>
<span class="token comment" spellcheck="true">// pin.into_input_pull_down();</span>

<span class="token comment" spellcheck="true">// Now turn the pin from unconfigured to a high-z input</span>
<span class="token keyword">let</span> input_pin <span class="token operator">=</span> pin<span class="token punctuation">.</span><span class="token function">into_enabled_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Read from the pin</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, input pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// input_pin.set_bit(true);</span>

<span class="token comment" spellcheck="true">/*
 * Example 2: High-Z input to Pulled Low input
 */</span>
<span class="token keyword">let</span> pulled_low <span class="token operator">=</span> input_pin<span class="token punctuation">.</span><span class="token function">into_input_pull_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pin_state <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Example 3: Pulled Low input to Output, set high
 */</span>
<span class="token keyword">let</span> output_pin <span class="token operator">=</span> pulled_low<span class="token punctuation">.</span><span class="token function">into_enabled_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
output_pin<span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Can't do this, output pins don't have this interface!</span>
<span class="token comment" spellcheck="true">// output_pin.into_input_pull_down();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这绝对是一种存储引脚状态的便捷方式，但为什么要这样做呢？为什么这比将状态存储在<code>enum</code>我们的<code>GpioConfig</code>结构内部更好？</p>
<h3 id="编译时功能安全"><a href="#编译时功能安全" class="headerlink" title="编译时功能安全"></a>编译时功能安全</h3><p>因为我们完全在编译时强制执行我们的设计约束，所以这不会产生运行时成本。当引脚处于输入模式时，无法设置输出模式。相反，您必须通过将其转换为输出引脚来遍历状态，然后设置输出模式。因此，在执行函数之前检查当前状态不会造成运行时损失。</p>
<p>此外，由于这些状态是由类型系统强制执行的，因此该接口的使用者不再有错误的余地。如果他们尝试执行非法的状态转换，代码将无法编译！</p>
<h2 id="Zero-Cost-Abstractions"><a href="#Zero-Cost-Abstractions" class="headerlink" title="Zero Cost Abstractions"></a>Zero Cost Abstractions</h2><p>类型状态也是零成本抽象的一个很好的例子 - 将某些行为移动到编译时执行或分析的能力。这些类型状态不包含实际数据，而是用作标记。由于它们不包含数据，因此它们在运行时在内存中没有实际表示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>mem<span class="token punctuation">:</span><span class="token punctuation">:</span>size_of<span class="token punctuation">;</span>

<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Enabled<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>Input<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>PulledHigh<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span>
<span class="token keyword">let</span> _ <span class="token operator">=</span> size_of<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> PulledHigh<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// == 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="零尺寸类型"><a href="#零尺寸类型" class="headerlink" title="零尺寸类型"></a>零尺寸类型</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Enabled<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>像这样定义的结构称为零大小类型，因为它们不包含实际数据。尽管这些类型在编译时是“真实的”——您可以复制它们、移动它们、引用它们等等，但是优化器将完全剥离它们。</p>
<p>在这段代码中：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">into_input_high_z</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> GpioConfig<span class="token operator">&lt;</span>Enabled<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HighZ<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_r<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">input_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">high_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GpioConfig <span class="token punctuation">{</span>
        periph<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>periph<span class="token punctuation">,</span>
        enabled<span class="token punctuation">:</span> Enabled<span class="token punctuation">,</span>
        direction<span class="token punctuation">:</span> Input<span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span> HighZ<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们返回的 GpioConfig 在运行时从不存在。调用此函数通常归结为单个汇编指令 - 将常量寄存器值存储到寄存器位置。这意味着我们开发的类型状态接口是一种零成本抽象——它不再使用 CPU、RAM 或代码空间来跟踪 的状态<code>GpioConfig</code>，并呈现为与直接寄存器访问相同的机器代码。</p>
<h3 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h3><p>一般而言，这些抽象可以根据您的需要进行嵌套。只要使用的所有组件都是零尺寸类型，整个结构在运行时就不会存在。</p>
<p>对于复杂或深度嵌套的结构，定义所有可能的状态组合可能很乏味。在这些情况下，宏可用于生成所有实现。</p>
<h1 id="Portability（可移植性）"><a href="#Portability（可移植性）" class="headerlink" title="Portability（可移植性）"></a>Portability（可移植性）</h1><p>在嵌入式环境中，可移植性是一个非常重要的话题：每个供应商甚至来自单个制造商的每个系列都提供不同的外围设备和功能，同样，与外围设备交互的方式也会有所不同。</p>
<p>平衡这种差异的常用方法是通过称为硬件抽象层或<strong>HAL 的</strong>层。</p>
<blockquote>
<p>硬件抽象是软件中的一组例程，用于模拟某些特定于平台的细节，使程序可以直接访问硬件资源。</p>
<p>它们通常允许程序员通过向硬件提供标准操作系统 (OS) 调用来编写独立于设备的高性能应用程序。</p>
<p><em>维基百科：<a href="https://en.wikipedia.org/wiki/Hardware_abstraction" target="_blank" rel="noopener">硬件抽象层</a></em></p>
</blockquote>
<p>嵌入式系统在这方面有点特殊，因为我们通常没有操作系统和用户可安装的软件，而是作为一个整体编译的固件映像以及许多其他限制。因此，虽然维基百科定义的传统方法可能有效，但它可能不是确保可移植性的最有效方法。</p>
<p>我们如何在 Rust 中做到这一点？输入<strong>嵌入式哈</strong>…</p>
<h2 id="什么是嵌入式hal？"><a href="#什么是嵌入式hal？" class="headerlink" title="什么是嵌入式hal？"></a>什么是嵌入式hal？</h2><p>简而言之，它是一组特性，定义了<strong>HAL 实现</strong>、<strong>驱动程序</strong>和<strong>应用程序（或固件）</strong>之间的实现契约。这些契约包括能力（即如果为某种类型实现了特征，<strong>HAL 实现</strong>提供了某种能力）和方法（即如果您可以构造一个实现特征的类型，则保证您拥有特征中指定的方法可用的）。</p>
<p>典型的分层可能如下所示：</p>
<p><img src="/images/loading.gif" data-original="../images/language/rust_layers.svg" alt=""></p>
<p><strong>嵌入式 hal</strong>中定义的一些特征是：</p>
<ul>
<li>GPIO（输入和输出引脚）</li>
<li>串行通讯</li>
<li>I2C</li>
<li>SPI</li>
<li>计时器/倒计时</li>
<li>模数转换</li>
</ul>
<p>实现和使用<strong>嵌入式 hal</strong>特征和板条箱的主要原因是为了控制复杂性。如果您认为应用程序可能必须在硬件以及应用程序和其他硬件组件的潜在驱动程序中实现对外围设备的使用，那么应该很容易看出可重用性非常有限。用数学表示，如果<strong>M</strong>是外围 HAL 实现的数量，<strong>N</strong>是驱动程序的数量，那么如果我们要为每个应用程序重新发明轮子，那么我们最终会得到<strong>M*N 个</strong>实现，同时使用<strong>嵌入式</strong>HAL提供的<em>API</em>特征将使实现复杂度接近<strong>M+N</strong>。当然，还有其他好处，例如由于定义明确且随时可用的 API，减少了反复试验。</p>
<h2 id="嵌入式-hal-的用户"><a href="#嵌入式-hal-的用户" class="headerlink" title="嵌入式 hal 的用户"></a>嵌入式 hal 的用户</h2><p>如上所述，HAL 有三个主要用户：</p>
<h3 id="HAL-实施"><a href="#HAL-实施" class="headerlink" title="HAL 实施"></a>HAL 实施</h3><p>HAL 实现提供了硬件和 HAL 特征的用户之间的接口。典型的实现包括三个部分：</p>
<ul>
<li>一种或多种硬件特定类型</li>
<li>创建和初始化此类类型的函数，通常提供各种配置选项（速度、操作模式、使用引脚等）</li>
<li>一个或一个以上<code>trait</code> <code>impl</code>的<strong>嵌-HAL</strong>性状该类型</li>
</ul>
<p>这样的<strong>HAL 实现</strong>可以有多种风格：</p>
<ul>
<li>通过底层硬件访问，例如通过寄存器</li>
<li>通过操作系统，例如通过<code>sysfs</code>在 Linux 下使用</li>
<li>通过适配器，例如用于单元测试的模拟类型</li>
<li>通过硬件适配器的驱动程序，例如 I2C 多路复用器或 GPIO 扩展器</li>
</ul>
<h3 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h3><p>驱动程序为内部或外部组件实现一组自定义功能，连接到实现嵌入式 hal 特征的外设。此类驱动器的典型示例包括各种传感器（温度、磁力计、加速度计、光）、显示设备（LED 阵列、LCD 显示器）和执行器（电机、发射器）。</p>
<p>驱动程序必须使用类型实例进行初始化，该类型实例实现了特定<code>trait</code>的嵌入式 hal，这是通过 trait bound 确保的，并提供其自己的类型实例和一组允许与驱动设备交互的自定义方法。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>该应用程序将各个部分绑定在一起并确保实现所需的功能。在不同系统之间移植时，这是最需要适应工作的部分，因为应用程序需要通过 HAL 实现正确初始化真实硬件，并且不同硬件的初始化不同，有时差异很大。此外，用户的选择通常也很重要，因为组件可以物理连接到不同的终端，硬件总线有时需要外部硬件来匹配配置，或者在使用内部外设（例如多个定时器）时需要进行不同的权衡具有不同的功能可用或外围设备与其他设备冲突）。</p>
<h1 id="Concurrency（并发）"><a href="#Concurrency（并发）" class="headerlink" title="Concurrency（并发）"></a>Concurrency（并发）</h1><p>当程序的不同部分可能在不同时间或无序执行时，就会发生并发。在嵌入式上下文中，这包括：</p>
<ul>
<li>中断处理程序，每当相关的中断发生时运行，</li>
<li>各种形式的多线程，您的微处理器定期在程序的各个部分之间进行交换，</li>
<li>在某些系统中，多核微处理器，其中每个核可以同时独立运行程序的不同部分。</li>
</ul>
<p>由于很多嵌入式程序需要处理中断，并发通常迟早会出现，同时也是很多微妙和困难的错误发生的地方。幸运的是，Rust 提供了许多抽象和安全保证来帮助我们编写正确的代码。</p>
<h2 id="无并发"><a href="#无并发" class="headerlink" title="无并发"></a>无并发</h2><p>嵌入式程序最简单的并发是无并发：你的软件由一个主循环组成，它一直在运行，根本没有中断。有时这非常适合手头的问题！通常，您的循环会读取一些输入、执行一些处理并写入一些输出。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> peripherals <span class="token operator">=</span> <span class="token function">setup_peripherals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> inputs <span class="token operator">=</span> <span class="token function">read_inputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> outputs <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_outputs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peripherals<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于没有并发，因此无需担心程序各部分之间的数据共享或对外围设备的同步访问。如果您可以通过这种简单的方法逃脱，这可能是一个很好的解决方案。</p>
<h2 id="全局可变数据"><a href="#全局可变数据" class="headerlink" title="全局可变数据"></a>全局可变数据</h2><p>与非嵌入式 Rust 不同，我们通常不会创建堆分配并将对该数据的引用传递给新创建的线程。相反，我们的中断处理程序可能随时被调用，并且必须知道如何访问我们正在使用的任何共享内存。在最低级别，这意味着我们必须<em>静态分配</em>可变内存，中断处理程序和主代码都可以引用这些内存。</p>
<p>在 Rust 中，这样的<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable" target="_blank" rel="noopener"><code>static mut</code></a>变量读或写总是不安全的，因为如果不特别小心，你可能会触发竞争条件，你对变量的访问在中途被一个也访问该变量的中断中断。</p>
<p>有关此行为如何在您的代码中导致细微错误的示例，请考虑一个嵌入式程序，该程序在每个一秒周期（频率计数器）计算某些输入信号的上升沿：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DANGER - Not actually safe! Could cause data races.</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每一秒，定时器中断都会将计数器设置回 0。同时，主循环不断测量信号，并在看到从低到高的变化时递增计数器。我们不得不使用<code>unsafe</code>访问 <code>COUNTER</code>，因为它是<code>static mut</code>，这意味着我们向编译器保证我们不会导致任何未定义的行为。你能发现比赛条件吗？上的增量<code>COUNTER</code>是<em>不能</em>保证是原子-事实上，在大多数嵌入式平台，它将被分成了负载，则增量，然后商店。如果中断在加载之后但在存储之前触发，则在中断返回后将忽略重置回 0 - 我们将在该期间计算两倍的转换次数。</p>
<h2 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h2><p>那么，我们可以对数据竞争做些什么呢？一种简单的方法是使用<em>临界区</em>，即禁用中断的上下文。通过将<code>COUNTER</code>in的访问包装 <code>main</code>在临界区中，我们可以确保定时器中断在我们完成递增之前不会触发<code>COUNTER</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// New critical section ensures synchronised access to COUNTER</span>
            cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> COUNTER <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此示例中，我们使用<code>cortex_m::interrupt::free</code>，但其他平台将具有类似的机制来执行临界区中的代码。这也与禁用中断、运行一些代码，然后重新启用中断相同。</p>
<p>请注意，我们不需要在定时器中断中放置临界区，原因有两个：</p>
<ul>
<li>写入 0<code>COUNTER</code>不会受到比赛的影响，因为我们不阅读它</li>
<li><code>main</code>无论如何它永远不会被线程中断</li>
</ul>
<p>如果<code>COUNTER</code>被多个可能互相<em>抢占的</em>中断处理程序共享，那么每个中断处理程序也 可能需要一个临界区。</p>
<p>这解决了我们眼前的问题，但我们仍然要编写许多需要仔细推理的不安全代码，而且我们可能会不必要地使用临界区。由于每个临界区都会临时暂停中断处理，因此会产生一些额外代码大小以及更高的中断延迟和抖动的相关成本（处理中断可能需要更长的时间，并且处理它们之前的时间将更加可变）。这是否是一个问题取决于您的系统，但总的来说，我们希望避免它。</p>
<p>值得注意的是，虽然临界区保证不会触发任何中断，但它不提供多核系统上的排他性保证！即使没有中断，另一个内核也可以愉快地访问与您的内核相同的内存。如果您使用多核，您将需要更强的同步原语。</p>
<h2 id="原子访问"><a href="#原子访问" class="headerlink" title="原子访问"></a>原子访问</h2><p>在某些平台上，可以使用特殊的原子指令，为读取-修改-写入操作提供保证。专门针对 Cortex-M：<code>thumbv6</code> （Cortex-M0、Cortex-M0+）仅提供原子加载和存储指令，而<code>thumbv7</code>（Cortex-M3 及以上）提供完整的比较和交换（CAS）指令。这些 CAS 指令提供了对所有中断的严厉禁用的替代方案：我们可以尝试递增，它在大多数情况下都会成功，但如果被中断，它将自动重试整个递增操作。即使跨多个内核，这些原子操作也是安全的。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AtomicUsize<span class="token punctuation">,</span> Ordering<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> AtomicUsize <span class="token operator">=</span> AtomicUsize<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Use `fetch_add` to atomically add 1 to COUNTER</span>
            COUNTER<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use `store` to write 0 directly to COUNTER</span>
    COUNTER<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Relaxed<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个时间<code>COUNTER</code>是一个安全<code>static</code>变量。由于可以从中断处理程序和主线程安全地修改<code>AtomicUsize</code> 类型，<code>COUNTER</code>而无需禁用中断。如果可能，这是一个更好的解决方案 - 但您的平台可能不支持它。</p>
<p>注意<a href="https://doc.rust-lang.org/core/sync/atomic/enum.Ordering.html" target="_blank" rel="noopener"><code>Ordering</code></a>：这会影响编译器和硬件对指令重新排序的方式，也会对缓存可见性产生影响。假设目标是单核平台<code>Relaxed</code>就足够了，并且在这种特殊情况下是最有效的选择。更严格的排序将导致编译器围绕原子操作发出内存屏障；根据您使用原子的内容，您可能需要也可能不需要这个！原子模型的精确细节很复杂，最好在别处进行描述。</p>
<p>有关原子和排序的更多详细信息，请参阅<a href="https://doc.rust-lang.org/nomicon/atomics.html" target="_blank" rel="noopener">nomicon</a>。</p>
<h2 id="抽象、发送和同步"><a href="#抽象、发送和同步" class="headerlink" title="抽象、发送和同步"></a>抽象、发送和同步</h2><p>上述解决方案都不是特别令人满意。它们需要<code>unsafe</code> 必须非常仔细地检查并且不符合人体工程学的积木。我们当然可以在 Rust 中做得更好！</p>
<p>我们可以将我们的计数器抽象成一个安全的接口，它可以安全地在我们代码的任何其他地方使用。对于这个例子，我们将使用临界区计数器，但你可以用原子做一些非常相似的事情。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>UnsafeCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Our counter is just a wrapper around UnsafeCell&lt;u32>, which is the heart</span>
<span class="token comment" spellcheck="true">// of interior mutability in Rust. By using interior mutability, we can have</span>
<span class="token comment" spellcheck="true">// COUNTER be `static` instead of `static mut`, but still able to mutate</span>
<span class="token comment" spellcheck="true">// its counter value.</span>
<span class="token keyword">struct</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CS_COUNTER_INIT<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> <span class="token function">CSCounter</span><span class="token punctuation">(</span>UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> CSCounter <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// By requiring a CriticalSection be passed in, we know we must</span>
        <span class="token comment" spellcheck="true">// be operating inside a CriticalSection, and so can confidently</span>
        <span class="token comment" spellcheck="true">// use this unsafe block (required to call UnsafeCell::get).</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _cs<span class="token punctuation">:</span> <span class="token operator">&amp;</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>CriticalSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Required to allow static CSCounter. See explanation below.</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> CSCounter <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// COUNTER is no longer `mut` as it uses interior mutability;</span>
<span class="token comment" spellcheck="true">// therefore it also no longer requires unsafe blocks to access.</span>
<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> CSCounter <span class="token operator">=</span> CS_COUNTER_INIT<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No unsafe here!</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We do need to enter a critical section here just to obtain a valid</span>
    <span class="token comment" spellcheck="true">// cs token, even though we know no other interrupt could pre-empt</span>
    <span class="token comment" spellcheck="true">// this one.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We could use unsafe code to generate a fake CriticalSection if we</span>
    <span class="token comment" spellcheck="true">// really wanted to, avoiding the overhead:</span>
    <span class="token comment" spellcheck="true">// let cs = unsafe { interrupt::CriticalSection::new() };</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们已经将<code>unsafe</code>代码移到精心规划的抽象内部，现在我们的应用程序代码不包含任何<code>unsafe</code>块。</p>
<p>这种设计要求应用程序传入一个<code>CriticalSection</code>令牌：这些令牌仅由 安全生成<code>interrupt::free</code>，因此通过要求传入一个令牌，我们确保我们在临界区中操作，而不必自己实际进行锁定。这种保证是由编译器静态提供的：不会有任何与<code>cs</code>. 如果我们有多个计数器，它们都可以被赋予相同的<code>cs</code>，而不需要多个嵌套的临界区。</p>
<p>这也带来了 Rust 并发的一个重要主题： <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html" target="_blank" rel="noopener"><code>Send</code>和<code>Sync</code></a>特征。总结一下 Rust 书，当它可以安全地移动到另一个线程时，类型是 Send，而当它可以在多个线程之间安全共享时，它是 Sync。在嵌入式上下文中，我们认为中断在与应用程序代码不同的线程中执行，因此被中断和主代码访问的变量必须是同步的。</p>
<p>对于 Rust 中的大多数类型，编译器会自动为您派生这两个特征。但是，因为<code>CSCounter</code>包含一个<a href="https://doc.rust-lang.org/core/cell/struct.UnsafeCell.html" target="_blank" rel="noopener"><code>UnsafeCell</code></a>，它不是同步的，因此我们不能使<code>static CSCounter</code>:<code>static</code> 变量<em>必须</em>是同步的，因为它们可以被多个线程访问。</p>
<p>为了告诉编译器我们已经注意到<code>CSCounter</code>在线程之间共享实际上是安全的，我们显式地实现了 Sync trait。与之前使用的临界区一样，这仅在单核平台上是安全的：对于多核，您需要付出更大的努力来确保安全。</p>
<h2 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h2><p>我们已经创建了一个特定于我们的计数器问题的有用抽象，但是有许多用于并发的通用抽象。</p>
<p>一个这样的<em>同步原语</em>是互斥，互斥的缩写。这些构造确保对变量的独占访问，例如我们的计数器。线程可以尝试<em>锁定</em>（或<em>获取</em>）互斥锁，并且要么立即成功，要么阻塞等待获取锁，或者返回无法锁定互斥锁的错误。当该线程持有锁时，它被授予访问受保护数据的权限。当线程完成时，它<em>解锁</em>（或 <em>释放</em>）互斥锁，允许另一个线程锁定它。在 Rust 中，我们通常会使用<a href="https://doc.rust-lang.org/core/ops/trait.Drop.html" target="_blank" rel="noopener"><code>Drop</code></a>trait 来实现解锁，以确保当互斥量超出范围时它总是被释放。</p>
<p>将互斥锁与中断处理程序一起使用可能会很棘手：中断处理程序阻塞通常是不可接受的，并且阻塞等待主线程释放锁将是特别灾难性的，因为我们会<em>死锁</em>（主线程）线程永远不会释放锁，因为执行停留在中断处理程序中）。死锁不被认为是不安全的：即使在安全的 Rust 中也是可能的。</p>
<p>为了完全避免这种行为，我们可以实现一个需要锁定临界区的互斥锁，就像我们的反例一样。只要临界区必须与锁一样长，我们就可以确保我们可以独占访问被包装的变量，甚至不需要跟踪互斥锁的锁定/解锁状态。</p>
<p>这实际上是在<code>cortex_m</code>板条箱中为我们完成的！我们可以用它写我们的计数器：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>Cell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span>Mutex<span class="token punctuation">;</span>

<span class="token keyword">static</span> COUNTER<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>Cell<span class="token operator">&lt;</span>u32<span class="token operator">>></span> <span class="token operator">=</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Cell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">read_signal_level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span>
                COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// We still need to enter a critical section here to satisfy the Mutex.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> COUNTER<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们现在使用<a href="https://doc.rust-lang.org/core/cell/struct.Cell.html" target="_blank" rel="noopener"><code>Cell</code></a>，它和它的兄弟一起<code>RefCell</code>被用来提供安全的内部可变性。我们已经看到<code>UnsafeCell</code>了 Rust 内部可变性的底层：它允许您获得对其值的多个可变引用，但只能使用不安全的代码。A<code>Cell</code> 类似于 an<code>UnsafeCell</code>但它提供了一个安全的接口：它只允许获取当前值的副本或替换它，而不是获取引用，并且由于它不是 Sync，因此不能在线程之间共享。这些约束意味着它可以安全使用，但我们不能直接在<code>static</code>变量中使用它， 因为<code>static</code>必须是 Sync。</p>
<p>那么为什么上面的例子有效呢？<code>Mutex&lt;T&gt;</code>为任何<code>T</code>发送的实现同步 - 例如<code>Cell</code>. 它可以安全地执行此操作，因为它仅在关键部分期间才允许访问其内容。因此，我们能够获得一个完全没有不安全代码的安全计数器！</p>
<p>这对于像<code>u32</code>我们的计数器这样的简单类型非常有用，但是对于不是 Copy 的更复杂的类型呢？嵌入式上下文中一个极其常见的示例是外设结构，它通常不是 Copy。为此，我们可以转向<code>RefCell</code>.</p>
<h2 id="共享外设"><a href="#共享外设" class="headerlink" title="共享外设"></a>共享外设</h2><p>使用<code>svd2rust</code>和类似抽象生成的设备箱通过强制一次只能存在一个外围结构实例来提供对外围设备的安全访问。这确保了安全性，但使得从主线程和中断处理程序访问外设变得困难。</p>
<p>为了安全地共享外围访问，我们可以使用<code>Mutex</code>我们之前看到的。我们还需要使用<a href="https://doc.rust-lang.org/core/cell/struct.RefCell.html" target="_blank" rel="noopener"><code>RefCell</code></a>，它使用运行时检查来确保一次只给出一个对外围设备的引用。这比普通的有更多的开销<code>Cell</code>，但由于我们提供引用而不是副本，我们必须确保一次只存在一个。</p>
<p>最后，我们还必须考虑在主代码中初始化后以某种方式将外围设备移动到共享变量中。为此，我们可以使用<code>Option</code>类型，初始化<code>None</code>并稍后设置为外围设备的实例。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Obtain the peripheral singletons and configure it.</span>
    <span class="token comment" spellcheck="true">// This example is from an svd2rust-generated crate, but</span>
    <span class="token comment" spellcheck="true">// most embedded device crates will be similar.</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> <span class="token operator">&amp;</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it sets PA0 to an input and PA1 to an output.</span>
    <span class="token function">configure_gpio</span><span class="token punctuation">(</span>gpioa<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Store the GPIOA in the mutex, moving it.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We can no longer use `gpioa` or `dp.GPIOA`, and instead have to</span>
    <span class="token comment" spellcheck="true">// access it via the mutex.</span>

    <span class="token comment" spellcheck="true">// Be careful to enable the interrupt only after setting MY_GPIO:</span>
    <span class="token comment" spellcheck="true">// otherwise the interrupt might fire while it still contains None,</span>
    <span class="token comment" spellcheck="true">// and as-written (with `unwrap()`), it would panic.</span>
    <span class="token function">set_timer_1hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> last_state <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We'll now read state as a digital input, via the mutex</span>
        <span class="token keyword">let</span> state <span class="token operator">=</span> interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>idr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">idr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> state <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last_state <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Set PA1 high if we've seen a rising edge on PA0.</span>
            interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        last_state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This time in the interrupt we'll just clear PA0.</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We can use `unwrap()` because we know the interrupt wasn't enabled</span>
        <span class="token comment" spellcheck="true">// until after MY_GPIO was set; otherwise we should handle the potential</span>
        <span class="token comment" spellcheck="true">// for a None value.</span>
        <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要考虑的内容很多，所以让我们分解重要的几行。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> MY_GPIO<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>GPIOA<span class="token operator">>></span><span class="token operator">></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们的共享变量现在是 a<code>Mutex</code>周围的 a <code>RefCell</code>，其中包含一个 <code>Option</code>。在<code>Mutex</code>确保我们只有一个临界区中访问，并因此使变量同步，即使一个普通的<code>RefCell</code>不会同步。该<code>RefCell</code>给我们参考，我们将需要使用我们内部的可变性<code>GPIOA</code>。该<code>Option</code>让我们初始化这个变量为空的东西，后来才真正移动的变量，我们不能静态地访问外设的独生子，在运行时，所以这是必需的。</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">|</span>cs<span class="token operator">|</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>GPIOA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在临界区中，我们可以调用<code>borrow()</code>互斥锁，它为我们提供了对<code>RefCell</code>. 然后我们调用<code>replace()</code>将我们的新值移动到<code>RefCell</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust">interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioa <span class="token operator">=</span> MY_GPIO<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gpioa<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">odr1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，我们<code>MY_GPIO</code>以安全和并发的方式使用。临界区像往常一样阻止中断触发，并让我们借用互斥锁。在 <code>RefCell</code>随后给了我们一个<code>&amp;Option&lt;GPIOA&gt;</code>，并跟踪它保持多久借来的-一旦进入参考范围的那样，<code>RefCell</code>将被更新，以表明它不再是借来的。</p>
<p>由于我们无法将<code>GPIOA</code>移出<code>&amp;Option</code>，我们需要将其转换为<code>&amp;Option&lt;&amp;GPIOA&gt;</code>with <code>as_ref()</code>，我们最终<code>unwrap()</code>可以获取<code>&amp;GPIOA</code>它让我们修改外围设备。</p>
<p>如果我们需要对共享资源的可变引用<code>borrow_mut</code>，<code>deref_mut</code> 则应使用and代替。以下代码显示了使用 TIM2 定时器的示例。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>DerefMut<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Mutex<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">:</span><span class="token punctuation">:</span>wfi<span class="token punctuation">;</span>
<span class="token keyword">use</span> stm32f4<span class="token punctuation">:</span><span class="token punctuation">:</span>stm32f405<span class="token punctuation">;</span>

<span class="token keyword">static</span> G_TIM<span class="token punctuation">:</span> Mutex<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>Option<span class="token operator">&lt;</span>Timer<span class="token operator">&lt;</span>stm32<span class="token punctuation">:</span><span class="token punctuation">:</span>TIM2<span class="token operator">>></span><span class="token operator">>></span> <span class="token operator">=</span>
    Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> cp <span class="token operator">=</span> cm<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dp <span class="token operator">=</span> stm32f405<span class="token punctuation">:</span><span class="token punctuation">:</span>Peripherals<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Some sort of timer configuration function.</span>
    <span class="token comment" spellcheck="true">// Assume it configures the TIM2 timer, its NVIC interrupt,</span>
    <span class="token comment" spellcheck="true">// and finally starts the timer.</span>
    <span class="token keyword">let</span> tim <span class="token operator">=</span> <span class="token function">configure_timer_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> cp<span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>tim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">wfi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>cs<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> tim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>  G_TIM<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tim<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token function">hz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>哇！这是安全的，但也有点笨拙。我们还有什么可以做的吗？</p>
<h2 id="信息中心"><a href="#信息中心" class="headerlink" title="信息中心"></a>信息中心</h2><p>一种替代方案是<a href="https://github.com/rtic-rs/cortex-m-rtic" target="_blank" rel="noopener">RTIC 框架</a>，它是实时中断驱动并发的缩写。它强制执行静态优先级并跟踪对<code>static mut</code>变量（“资源”）的访问，以静态地确保始终安全地访问共享资源，而无需总是进入临界区和使用引用计数（如 中所示<code>RefCell</code>）的开销。这有许多优点，例如保证没有死锁并提供极低的时间和内存开销。</p>
<p>该框架还包括其他功能，如消息传递，这减少了对显式共享状态的需求，以及安排任务在给定时间运行的能力，可用于实现周期性任务。查看<a href="https://rtic.rs/" target="_blank" rel="noopener">文档</a>以获取更多信息！</p>
<h2 id="实时操作系统"><a href="#实时操作系统" class="headerlink" title="实时操作系统"></a>实时操作系统</h2><p>嵌入式并发的另一个常见模型是实时操作系统 (RTOS)。虽然目前在 Rust 中的探索较少，但它们广泛用于传统的嵌入式开发。开源示例包括<a href="https://freertos.org/" target="_blank" rel="noopener">FreeRTOS</a>和 <a href="http://chibios.org/" target="_blank" rel="noopener">ChibiOS</a>。这些 RTOS 支持运行多个应用程序线程，CPU 在这些线程之间进行交换，当线程让出控制权（称为协作多任务处理）或基于常规计时器或中断（抢占式多任务处理）时。RTOS 通常提供互斥锁和其他同步原语，并且经常与硬件功能（例如 DMA 引擎）进行互操作。</p>
<p>在撰写本文时，可以指出的 Rust RTOS 示例并不多，但这是一个有趣的领域，因此请关注此空间！</p>
<h2 id="多核"><a href="#多核" class="headerlink" title="多核"></a>多核</h2><p>在嵌入式处理器中拥有两个或更多内核变得越来越普遍，这为并发性增加了一层额外的复杂性。所有使用临界区（包括<code>cortex_m::interrupt::Mutex</code>）的示例都假设唯一的其他执行线程是中断线程，但在多核系统上不再如此。相反，我们需要为多核设计的同步原语（也称为 SMP，用于对称多处理）。</p>
<p>这些通常使用我们之前看到的原子指令，因为处理系统将确保在所有内核上保持原子性。</p>
<p>详细介绍这些主题目前超出了本书的范围，但一般模式与单核情况相同。</p>
<h1 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h1><p>最终，您将希望在程序中使用动态数据结构（AKA 集合）。<code>std</code>提供了一组公共集合：<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html" target="_blank" rel="noopener"><code>Vec</code></a>、<a href="https://doc.rust-lang.org/std/string/struct.String.html" target="_blank" rel="noopener"><code>String</code></a>、 <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener"><code>HashMap</code></a>等。所有实现的集合都<code>std</code>使用全局动态内存分配器（也称为堆）。</p>
<p>按照<code>core</code>定义，这些实现在没有内存分配的情况下不可用，但可以<code>alloc</code>在编译器附带的crate 中找到。</p>
<p>如果您需要集合，堆分配实现不是您唯一的选择。您还可以使用<em>固定容量</em>集合；在<a href="https://crates.io/crates/heapless" target="_blank" rel="noopener"><code>heapless</code></a>crate 中可以找到一个这样的实现。</p>
<p>在本节中，我们将探索和比较这两种实现。</p>
<h2 id="使用-alloc"><a href="#使用-alloc" class="headerlink" title="使用 alloc"></a>使用 <code>alloc</code></h2><p>该<code>alloc</code>箱出厂时的标准锈病分布。要导入 crate，您可以直接将<code>use</code>其导入，<em>而无需</em>在<code>Cargo.toml</code>文件中将其声明为依赖项 。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc)]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> alloc<span class="token punctuation">;</span>

<span class="token keyword">use</span> alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>vec<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了能够使用任何集合，您首先需要使用该<code>global_allocator</code> 属性来声明您的程序将使用的全局分配器。您选择的分配器需要实现该<a href="https://doc.rust-lang.org/core/alloc/trait.GlobalAlloc.html" target="_blank" rel="noopener"><code>GlobalAlloc</code></a>特征。</p>
<p>为完整起见并保持本节尽可能独立，我们将实现一个简单的凹凸指针分配器并将其用作全局分配器。但是，我们<em>强烈</em>建议您在程序中使用 crates.io 中经过实战测试的分配器，而不是这个分配器。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// Bump pointer allocator implementation</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m<span class="token punctuation">;</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>alloc<span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalAlloc<span class="token punctuation">;</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>interrupt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Bump pointer allocator for *single* core systems</span>
<span class="token keyword">struct</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token operator">&lt;</span>usize<span class="token operator">></span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> usize<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Sync <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> GlobalAlloc <span class="token keyword">for</span> BumpPointerAlloc <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">*</span><span class="token keyword">mut</span> u8 <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// `interrupt::free` is a critical section that makes our allocator safe</span>
        <span class="token comment" spellcheck="true">// to use from within interrupts</span>
        interrupt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> head <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> size <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align <span class="token operator">=</span> layout<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> align_mask <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// move start up to the next alignment boundary</span>
            <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>head <span class="token operator">+</span> align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> align_mask<span class="token punctuation">;</span>

            <span class="token keyword">if</span> start <span class="token operator">+</span> size <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>end <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// a null pointer signal an Out Of Memory condition</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">null_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>head <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
                start <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">dealloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> u8<span class="token punctuation">,</span> _<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this allocator never deallocates memory</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Declaration of the global memory allocator</span>
<span class="token comment" spellcheck="true">// NOTE the user must ensure that the memory region `[0x2000_0100, 0x2000_0200]`</span>
<span class="token comment" spellcheck="true">// is not used by other parts of the program</span>
<span class="token attribute attr-name">#[global_allocator]</span>
<span class="token keyword">static</span> HEAP<span class="token punctuation">:</span> BumpPointerAlloc <span class="token operator">=</span> BumpPointerAlloc <span class="token punctuation">{</span>
    head<span class="token punctuation">:</span> UnsafeCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x2000_0100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    end<span class="token punctuation">:</span> <span class="token number">0x2000_0200</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了选择全局分配器之外，用户还必须定义如何使用<em>不稳定</em> <code>alloc_error_handler</code>属性处理内存不足 (OOM) 错误。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(alloc_error_handler)]</span>

<span class="token keyword">use</span> cortex_m<span class="token punctuation">:</span><span class="token punctuation">:</span>asm<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[alloc_error_handler]</span>
<span class="token keyword">fn</span> <span class="token function">on_oom</span><span class="token punctuation">(</span>_layout<span class="token punctuation">:</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    asm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一切就绪后，用户最终可以使用<code>alloc</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您使用过<code>std</code>crate 中的集合，那么这些将很熟悉，因为它们是完全相同的实现。</p>
<h2 id="使用-heapless"><a href="#使用-heapless" class="headerlink" title="使用 heapless"></a>使用 <code>heapless</code></h2><p><code>heapless</code>不需要设置，因为它的集合不依赖于全局内存分配器。只是<code>use</code>它的集合并继续实例化它们：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> heapless<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// v0.4.x</span>

<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> xs<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token punctuation">,</span> U8<span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>xs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您会注意到这些集合与<code>alloc</code>.</p>
<p>首先，您必须预先声明集合的容量。<code>heapless</code> 集合永远不会重新分配并具有固定容量；此容量是集合类型签名的一部分。在这种情况下，我们已经声明了<code>xs</code> 具有 8 个元素的容量，即向量最多可以容纳 8 个元素。这由类型签名中的<code>U8</code>（请参阅<a href="https://crates.io/crates/typenum" target="_blank" rel="noopener"><code>typenum</code></a>）指示。</p>
<p>其次，该<code>push</code>方法和许多其他方法都返回一个<code>Result</code>. 由于 <code>heapless</code>集合具有固定容量，因此所有将元素插入到集合中的操作都可能失败。API 通过返回一个<code>Result</code>指示操作是否成功来反映此问题。相比之下，<code>alloc</code>集合将在堆上重新分配自己以增加其容量。</p>
<p>从 v0.4.x 版本开始，所有<code>heapless</code>集合都内联存储其所有元素。这意味着像这样的操作<code>let x = heapless::Vec::new();</code>将在堆栈上分配集合，但也可以在<code>static</code>变量上分配集合，甚至在堆 ( <code>Box&lt;Vec&lt;_, _&gt;&gt;</code>) 上。</p>
<h2 id="权衡"><a href="#权衡" class="headerlink" title="权衡"></a>权衡</h2><p>在堆分配、可重定位集合和固定容量集合之间进行选择时，请记住这些。</p>
<h3 id="内存不足和错误处理"><a href="#内存不足和错误处理" class="headerlink" title="内存不足和错误处理"></a>内存不足和错误处理</h3><p>对于堆分配，内存不足总是可能的，并且可能发生在集合可能需要增长的任何地方：例如，所有 <code>alloc::Vec.push</code>调用都可能产生 OOM 条件。因此，某些操作可能会<em>隐式</em>失败。一些<code>alloc</code>集合公开了 一些<code>try_reserve</code>方法，可以让您在增加集合时检查潜在的 OOM 条件，但您需要主动使用它们。</p>
<p>如果您只使用<code>heapless</code>集合并且不将内存分配器用于其他任何事情，那么 OOM 条件是不可能的。相反，您必须根据具体情况处理容量不足的集合。这就是你必须处理<em>所有</em>的<code>Result</code>通过类似方法返回小号 <code>Vec.push</code>。</p>
<p>OOM 故障可能比<code>unwrap</code>对所有<code>Result</code>返回的 s说-ing更难调试，<code>heapless::Vec.push</code>因为观察到的故障位置可能 与问题原因的位置<em>不</em>匹配。例如，<code>vec.reserve(1)</code>如果分配器几乎耗尽，因为其他一些集合正在泄漏内存（在安全 Rust 中可能发生内存泄漏），甚至 可以触发 OOM。</p>
<h3 id="内存使用情况"><a href="#内存使用情况" class="headerlink" title="内存使用情况"></a>内存使用情况</h3><p>对堆分配集合的内存使用情况进行推理是很困难的，因为长寿命集合的容量可能会在运行时发生变化。某些操作可能会隐式地重新分配集合以增加其内存使用量，而某些集合公开的方法<code>shrink_to_fit</code>可能会减少集合使用的内存——最终，由分配器决定是否实际缩小内存分配。此外，分配器可能必须处理内存碎片，这会增加 <em>明显的</em>内存使用量。</p>
<p>另一方面，如果您专门使用固定容量集合，将它们中的大部分存储在<code>static</code>变量中并为调用堆栈设置最大大小，那么链接器将检测您是否尝试使用比物理可用内存更多的内存。</p>
<p>此外，堆栈上分配的固定容量集合将通过<a href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/emit-stack-sizes.html" target="_blank" rel="noopener"><code>-Z emit-stack-sizes</code></a>标志报告，这意味着分析堆栈使用情况的工具（如<a href="https://crates.io/crates/stack-sizes" target="_blank" rel="noopener"><code>stack-sizes</code></a>）将在其分析中包括它们。</p>
<p>但是，固定容量集合<em>无法</em>收缩，这会导致负载因子（集合大小与其容量之间的比率）低于可重定位集合所能达到的负载因子。</p>
<h3 id="最坏情况执行时间-WCET"><a href="#最坏情况执行时间-WCET" class="headerlink" title="最坏情况执行时间 (WCET)"></a>最坏情况执行时间 (WCET)</h3><p>如果您正在构建对时间敏感的应用程序或硬实时应用程序，那么您可能非常关心程序不同部分的最坏情况执行时间。</p>
<p>该<code>alloc</code>集合可以重新分配，这样可以增加集合还将包括它需要重新分配的集合，它本身依赖于时间的操作的WCET<em>运行时</em>收集的能力。这使得很难确定例如<code>alloc::Vec.push</code>操作的 WCET，因为它取决于正在使用的分配器及其运行时容量。</p>
<p>另一方面，固定容量集合永远不会重新分配，因此所有操作都有可预测的执行时间。例如，<code>heapless::Vec.push</code>在恒定时间内执行。</p>
<h3 id="便于使用"><a href="#便于使用" class="headerlink" title="便于使用"></a>便于使用</h3><p><code>alloc</code>需要设置全局分配器，<code>heapless</code>而不需要。但是，<code>heapless</code>需要您选择实例化的每个集合的容量。</p>
<p><code>alloc</code>几乎每个 Rust 开发人员都会熟悉该API。该 <code>heapless</code>API尝试密切模仿的<code>alloc</code>API，但它永远不会是完全一样的，因为它明确的错误处理-一些开发人员可能会觉得明确错误处理过度或太麻烦了。</p>
<h1 id="Design-Patterns"><a href="#Design-Patterns" class="headerlink" title="Design Patterns"></a>Design Patterns</h1><p>HAL Design Patterns：</p>
<p>这是一组常用和推荐的模式，用于在 Rust 中为微控制器编写硬件抽象层 (HAL)。在为微控制器编写 HAL 时，除了现有的<a href="https://rust-lang.github.io/api-guidelines/" target="_blank" rel="noopener">Rust API 指南</a>之外，还打算使用这些模式。</p>
<h2 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h2><ul>
<li><p>命名</p>
<p>（crate 与 Rust 命名约定一致）</p>
<ul>
<li>箱子被适当地命名（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/naming.html#c-crate-name" target="_blank" rel="noopener">C-CRATE-NAME</a>）</li>
</ul>
</li>
<li><p>互操作性</p>
<p>（板条箱与其他库功能很好地交互）</p>
<ul>
<li>包装器类型提供析构函数方法 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-free" target="_blank" rel="noopener">C-FREE</a> )</li>
<li>HAL 重新导出其注册访问箱 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-reexport-pac" target="_blank" rel="noopener">C-REEXPORT-PAC</a> )</li>
<li>类型实现<code>embedded-hal</code>特征（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/interoperability.html#c-hal-traits" target="_blank" rel="noopener">C-HAL-TRAITS</a>）</li>
</ul>
</li>
<li><p>可预测性</p>
<p>（板条箱启用清晰的代码，使其看起来如何）</p>
<ul>
<li>使用构造函数代替扩展特征（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/predictability.html#c-ctor" target="_blank" rel="noopener">C-CTOR</a>）</li>
</ul>
</li>
<li><p>GPIO 接口</p>
<p>（GPIO 接口遵循通用模式）</p>
<ul>
<li>默认情况下，引脚类型为零大小 ( <a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-zst-pin" target="_blank" rel="noopener">C-ZST-PIN</a> )</li>
<li>引脚类型提供擦除引脚和端口的方法（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-erased-pin" target="_blank" rel="noopener">C-ERASED-PIN</a>）</li>
<li>引脚状态应编码为类型参数（<a href="https://docs.rust-embedded.org/book/design-patterns/hal/gpio.html#c-pin-state" target="_blank" rel="noopener">C-PIN-STATE</a>）</li>
</ul>
</li>
</ul>
<h2 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h2><h3 id="箱子被适当地命名（C-CRATE-NAME）"><a href="#箱子被适当地命名（C-CRATE-NAME）" class="headerlink" title="箱子被适当地命名（C-CRATE-NAME）"></a>箱子被适当地命名（C-CRATE-NAME）</h3><p>HAL crate 应以其旨在支持的芯片或芯片系列命名。它们的名称应以 结尾，<code>-hal</code>以将它们与 register access crate 区分开来。名称不应包含下划线（改用破折号）。</p>
<h2 id="Interoperability"><a href="#Interoperability" class="headerlink" title="Interoperability"></a>Interoperability</h2><h3 id="包装类型提供析构方法（C-FREE）"><a href="#包装类型提供析构方法（C-FREE）" class="headerlink" title="包装类型提供析构方法（C-FREE）"></a>包装类型提供析构方法（C-FREE）</h3><p><code>Copy</code>HAL 提供的任何非包装器类型都应该提供一个<code>free</code>方法来使用包装器并返回创建它的原始外围设备（可能还有其他对象）。</p>
<p>如有必要，该方法应关闭并重置外设。<code>new</code> 使用 返回的原始外设调用<code>free</code>不应由于外设的意外状态而失败。</p>
<p>如果 HAL 类型需要<code>Copy</code>构造其他非对象（例如 I/O 引脚），则任何此类对象也应被释放并返回<code>free</code>。 <code>free</code>在这种情况下应该返回一个元组。</p>
<p>例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token function">Timer</span><span class="token punctuation">(</span>TIMER0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Timer <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>periph<span class="token punctuation">:</span> TIMER0<span class="token punctuation">)</span> <span class="token punctuation">-></span> Self <span class="token punctuation">{</span>
        <span class="token function">Self</span><span class="token punctuation">(</span>periph<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> TIMER0 <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="HAL-重新导出其注册访问箱-C-REEXPORT-PAC"><a href="#HAL-重新导出其注册访问箱-C-REEXPORT-PAC" class="headerlink" title="HAL 重新导出其注册访问箱 (C-REEXPORT-PAC)"></a>HAL 重新导出其注册访问箱 (C-REEXPORT-PAC)</h3><p>HAL 可以写在<a href="https://github.com/rust-embedded/svd2rust" target="_blank" rel="noopener">svd2rust</a>生成的 PAC 之上，或者写在提供原始寄存器访问的其他 crate 之上。HAL 应始终在其 crate 根中重新导出它们所基于的 register access crate。</p>
<p>PAC 应该以 name 重新导出<code>pac</code>，而不管 crate 的实际名称是什么，因为 HAL 的名称应该已经清楚地表明正在访问什么 PAC。</p>
<h3 id="类型实现embedded-hal特征（C-HAL-TRAITS）"><a href="#类型实现embedded-hal特征（C-HAL-TRAITS）" class="headerlink" title="类型实现embedded-hal特征（C-HAL-TRAITS）"></a>类型实现<code>embedded-hal</code>特征（C-HAL-TRAITS）</h3><p>HAL 提供的类型应实现<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>crate提供的所有适用特征 。</p>
<p>可以为同一类型实现多个特征。</p>
<h2 id="Predictability"><a href="#Predictability" class="headerlink" title="Predictability"></a>Predictability</h2><h3 id="使用构造函数代替扩展特征（C-CTOR）"><a href="#使用构造函数代替扩展特征（C-CTOR）" class="headerlink" title="使用构造函数代替扩展特征（C-CTOR）"></a>使用构造函数代替扩展特征（C-CTOR）</h3><p>HAL 向其添加功能的所有外围设备都应包含在新类型中，即使该功能不需要其他字段。</p>
<p>应避免为原始外设实现的扩展特性。</p>
<h3 id="方法-inline-在适当的地方装饰（C-INLINE）"><a href="#方法-inline-在适当的地方装饰（C-INLINE）" class="headerlink" title="方法#[inline\]在适当的地方装饰（C-INLINE）"></a>方法<code>#[inline\]</code>在适当的地方装饰（C-INLINE）</h3><p>默认情况下，Rust 编译器不会跨 crate 边界执行完全内联。由于嵌入式应用程序对意外的代码大小增加很敏感，<code>#[inline]</code>应使用如下指导编译器：</p>
<ul>
<li>所有“小”功能都应该被标记<code>#[inline]</code>。什么是“小”是主观的，但通常所有预期编译为一位数指令序列的函数都被认为是小。</li>
<li>很可能采用常量值作为参数的函数应标记为<code>#[inline]</code>. 这使得编译器能够在编译时计算甚至复杂的初始化逻辑，前提是函数输入是已知的。</li>
</ul>
<h2 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h2><h3 id="默认情况下，引脚类型为零大小-C-ZST-PIN"><a href="#默认情况下，引脚类型为零大小-C-ZST-PIN" class="headerlink" title="默认情况下，引脚类型为零大小 (C-ZST-PIN)"></a>默认情况下，引脚类型为零大小 (C-ZST-PIN)</h3><p>HAL 公开的 GPIO 接口应为每个接口或端口上的每个引脚提供专用的零大小类型，从而在所有引脚分配都是静态已知的情况下实现零成本的 GPIO 抽象。</p>
<p>每个 GPIO 接口或端口都应该实现一个<code>split</code>方法，返回一个带有每个引脚的结构。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortA<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PortA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PortAPins <span class="token punctuation">{</span>
        PortAPins <span class="token punctuation">{</span>
            pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
            pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PortAPins <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> pa0<span class="token punctuation">:</span> PA0<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pa1<span class="token punctuation">:</span> PA1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="引脚类型提供擦除引脚和端口的方法-C-ERASED-PIN"><a href="#引脚类型提供擦除引脚和端口的方法-C-ERASED-PIN" class="headerlink" title="引脚类型提供擦除引脚和端口的方法 (C-ERASED-PIN)"></a>引脚类型提供擦除引脚和端口的方法 (C-ERASED-PIN)</h3><p>Pin 应该提供类型擦除方法，将它们的属性从编译时移动到运行时，并在应用程序中提供更大的灵活性。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// Port A, pin 0.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA0<span class="token punctuation">;</span>

<span class="token keyword">impl</span> PA0 <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_pin</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PA <span class="token punctuation">{</span>
        PA <span class="token punctuation">{</span> pin<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A pin on port A.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// The pin number.</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> PA <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">erase_port</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Pin <span class="token punctuation">{</span>
        Pin <span class="token punctuation">{</span>
            port<span class="token punctuation">:</span> Port<span class="token punctuation">:</span><span class="token punctuation">:</span>A<span class="token punctuation">,</span>
            pin<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>pin<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Pin <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> Port<span class="token punctuation">,</span>
    pin<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// (these fields can be packed to reduce the memory footprint)</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> Port <span class="token punctuation">{</span>
    A<span class="token punctuation">,</span>
    B<span class="token punctuation">,</span>
    C<span class="token punctuation">,</span>
    D<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="引脚状态应编码为类型参数-C-PIN-STATE"><a href="#引脚状态应编码为类型参数-C-PIN-STATE" class="headerlink" title="引脚状态应编码为类型参数 (C-PIN-STATE)"></a>引脚状态应编码为类型参数 (C-PIN-STATE)</h3><p>根据芯片或系列的不同，引脚可以配置为具有不同特性的输入或输出。此状态应在类型系统中进行编码，以防止在错误状态下使用引脚。</p>
<p>附加的、特定于芯片的状态（例如驱动强度）也可以以这种方式使用附加类型参数进行编码。</p>
<p>应提供更改引脚状态的方法<code>into_input</code>和 <code>into_output</code>方法。</p>
<p>此外，<code>with_{input,output}_state</code>应该提供在不同状态下临时重新配置引脚而不移动它的方法。</p>
<p>应为每种引脚类型提供以下方法（即擦除和非擦除引脚类型应提供相同的 API）：</p>
<ul>
<li><p><code>pub fn into_input&lt;N: InputState&gt;(self, input: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><p><code>pub fn into_output&lt;N: OutputState&gt;(self, output: N) -&gt; Pin&lt;N&gt;</code></p>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_input_state<N: InputState, R>(
    &mut self,
    input: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><pre class="line-numbers language-ignore"><code class="language-ignore">pub fn with_output_state<N: OutputState, R>(
    &mut self,
    output: N,
    f: impl FnOnce(&mut PA1<N>) -> R,
) -> R<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>引脚状态应受密封特征的限制。HAL 的用户应该不需要添加他们自己的状态。这些特征可以提供实现引脚状态 API 所需的特定于 HAL 的方法。</p>
<p>例子：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">mod</span> sealed <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">trait</span> Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> PinState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> OutputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> InputState<span class="token punctuation">:</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Output<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> OutputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Output<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PushPull<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> OpenDrain<span class="token punctuation">;</span>

<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> OutputState <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PushPull <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> OpenDrain <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Input<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> PinState <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> InputState<span class="token operator">></span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Input<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Floating<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullUp<span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PullDown<span class="token punctuation">;</span>

<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> InputState <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> Floating <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullUp <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> sealed<span class="token punctuation">:</span><span class="token punctuation">:</span>Sealed <span class="token keyword">for</span> PullDown <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> PA1<span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> <span class="token punctuation">{</span>
    _p<span class="token punctuation">:</span> PhantomData<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>S<span class="token punctuation">:</span> PinState<span class="token operator">></span> PA1<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_input<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Input<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> into_output<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> N<span class="token punctuation">)</span> <span class="token punctuation">-></span> PA1<span class="token operator">&lt;</span>Output<span class="token operator">&lt;</span>N<span class="token operator">>></span> <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_input_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> InputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        input<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> with_output_state<span class="token operator">&lt;</span>N<span class="token punctuation">:</span> OutputState<span class="token punctuation">,</span> R<span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        output<span class="token punctuation">:</span> N<span class="token punctuation">,</span>
        f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token function">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> PA1<span class="token operator">&lt;</span>N<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> R<span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> R <span class="token punctuation">{</span>
        <span class="token function">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Same for `PA` and `Pin`, and other pin types.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Tips-for-embedded-C-developers"><a href="#Tips-for-embedded-C-developers" class="headerlink" title="Tips for embedded C developers"></a>Tips for embedded C developers</h1><p>本章收集了各种技巧，可能对希望开始编写 Rust 的有经验的嵌入式 C 开发人员有用。它将特别强调您在 C 中可能已经习惯的东西在 Rust 中的不同之处。</p>
<h2 id="预处理器"><a href="#预处理器" class="headerlink" title="预处理器"></a>预处理器</h2><p>在嵌入式 C 中，将预处理器用于各种目的是很常见的，例如：</p>
<ul>
<li>代码块的编译时选择 <code>#ifdef</code></li>
<li>编译时数组大小和计算</li>
<li>用于简化常见模式的宏（以避免函数调用开销）</li>
</ul>
<p>在 Rust 中没有预处理器，因此许多这些用例的处理方式不同。在本节的其余部分，我们将介绍使用预处理器的各种替代方法。</p>
<h3 id="Compile-Time-Code-Selection"><a href="#Compile-Time-Code-Selection" class="headerlink" title="Compile-Time Code Selection"></a>Compile-Time Code Selection</h3><p><code>#ifdef ... #endif</code>在 Rust 中最接近的匹配是<a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-features-section" target="_blank" rel="noopener">Cargo features</a>。这些比 C 预处理器更正式一些：所有可能的功能都明确列出每个 crate，并且只能打开或关闭。当您将一个 crate 列为依赖项时，功能会被打开，并且是附加的：如果您的依赖树中的任何一个 crate 为另一个 crate 启用了一个特性，那么该特性将为该 crate 的所有用户启用。</p>
<p>例如，您可能有一个提供信号处理原语库的 crate。每个人都可能需要一些额外的时间来编译或声明一些您希望避免的大型常量表。你可以为你的每个组件声明一个 Cargo 特性<code>Cargo.toml</code>：</p>
<pre class="line-numbers language-toml"><code class="language-toml">[features]
FIR = []
IIR = []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后，在您的代码中，使用<code>#[cfg(feature="FIR")]</code>来控制所包含的内容。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// In your top-level lib.rs</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"FIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> fir<span class="token punctuation">;</span>

#<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"IIR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> iir<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>类似地，仅当某个功能<em>未</em>启用，或者功能的任何组合已启用或未启用时，您才可以包含代码块。</p>
<p>此外，Rust 提供了许多您可以使用的自动设置条件，例如<code>target_arch</code>根据架构选择不同的代码。有关条件编译支持的完整详细信息，请参阅Rust 参考的 <a href="https://doc.rust-lang.org/reference/conditional-compilation.html" target="_blank" rel="noopener">条件编译</a>章节。</p>
<p>条件编译仅适用于下一个语句或块。如果一个块不能在当前范围内使用，那么该<code>cfg</code>属性将需要多次使用。值得注意的是，在大多数情况下，最好简单地包含所有代码并允许编译器在优化时删除死代码：这对您和您的用户来说更简单，并且通常编译器会很好地删除未使用的代码.</p>
<h3 id="编译时大小和计算"><a href="#编译时大小和计算" class="headerlink" title="编译时大小和计算"></a>编译时大小和计算</h3><p>Rust 支持<code>const fn</code>, 保证在编译时可评估的函数，因此可以在需要常量的地方使用，例如数组的大小。这可以与上述功能一起使用，例如：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token keyword">fn</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> usize <span class="token punctuation">{</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">1024</span> <span class="token punctuation">}</span>
    #<span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token string">"use_more_ram"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span> <span class="token number">128</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> BUF<span class="token punctuation">:</span> <span class="token punctuation">[</span>u32<span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u32</span><span class="token punctuation">;</span> <span class="token function">array_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从 1.31 开始，这些是稳定 Rust 的新内容，因此文档仍然很少。<code>const fn</code>在撰写本文时，可用的功能也非常有限；在未来的 Rust 版本中，预计会扩展<code>const fn</code>.</p>
<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><p>Rust 提供了一个极其强大的<a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener">宏系统</a>。虽然 C 预处理器几乎直接对源代码的文本进行操作，但 Rust 宏系统在更高的级别上运行。Rust 宏有两种变体：<em>示例*</em>宏<em>和</em>过程宏*。前者更简单也最常见；它们看起来像函数调用，可以扩展为完整的表达式、语句、项或模式。过程宏更复杂，但允许对 Rust 语言进行极其强大的添加：它们可以将任意 Rust 语法转换为新的 Rust 语法。</p>
<p>通常，在您可能使用过 C 预处理器宏的地方，您可能想查看一个宏示例是否可以完成这项工作。它们可以在您的 crate 中定义，并且可以由您自己的 crate 轻松使用或导出给其他用户。请注意，由于它们必须扩展为完整的表达式、语句、项或模式，因此 C 预处理器宏的某些用例将不起作用，例如扩展为变量名称的一部分或列表中不完整的项集的宏.</p>
<p>与 Cargo 功能一样，如果您甚至需要宏，则值得考虑。在许多情况下，常规函数更容易理解，并且会被内联到与宏相同的代码中。在<code>#[inline]</code>和<code>#[inline(always)]</code> <a href="https://doc.rust-lang.org/reference/attributes.html#inline-attribute" target="_blank" rel="noopener">属性</a> 让您对这一过程的进一步控制，但应谨慎在这里拍摄，以及-编译器会从同一包装箱自动内联函数在适当情况下，所以迫使它这样做不恰当实际上可能会导致性能下降。</p>
<p>解释整个 Rust 宏系统超出了本提示页面的范围，因此鼓励您查阅 Rust 文档以获取完整详细信息。</p>
<h2 id="构建系统"><a href="#构建系统" class="headerlink" title="构建系统"></a>构建系统</h2><p>大多数 Rust crate 是使用 Cargo 构建的（尽管不是必需的）。这解决了传统构建系统的许多难题。但是，您可能希望自定义构建过程。Cargo为此提供了<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener"><code>build.rs</code> 脚本</a>。它们是 Rust 脚本，可以根据需要与 Cargo 构建系统交互。</p>
<p>构建脚本的常见用例包括：</p>
<ul>
<li>提供构建时间信息，例如将构建日期或 Git 提交哈希静态嵌入到您的可执行文件中</li>
<li>根据所选功能或其他逻辑在构建时生成链接器脚本</li>
<li>更改 Cargo 构建配置</li>
<li>添加额外的静态库来链接</li>
</ul>
<p>目前不支持构建后脚本，您可能在传统上将其用于从构建对象自动生成二进制文件或打印构建信息等任务。</p>
<h3 id="交叉编译-1"><a href="#交叉编译-1" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>将 Cargo 用于您的构建系统还可以简化交叉编译。在大多数情况下，只需告诉 Cargo<code>--target thumbv6m-none-eabi</code>并在<code>target/thumbv6m-none-eabi/debug/myapp</code>.</p>
<p>对于 Rust 本身不支持的平台，您需要<code>libcore</code> 自己为该目标构建。在这样的平台上，<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener">Xargo</a>可以用作 Cargo 的替身，它会自动<code>libcore</code>为您构建。</p>
<h2 id="迭代器与数组访问"><a href="#迭代器与数组访问" class="headerlink" title="迭代器与数组访问"></a>迭代器与数组访问</h2><p>在 C 中，您可能习惯于通过索引直接访问数组：</p>
<pre class="line-numbers language-c"><code class="language-c">int16_t arr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Rust 中，这是一种反模式：索引访问可能会更慢（因为它需要进行边界检查）并且可能会阻止各种编译器优化。这是一个重要的区别，值得重复：Rust 将检查手动数组索引的越界访问以保证内存安全，而 C 将很乐意在数组外进行索引。</p>
<p>相反，使用迭代器：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u16</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> element <span class="token keyword">in</span> arr<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">*</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>迭代器提供了一系列强大的功能，您必须在 C 中手动实现，例如链接、压缩、枚举、查找最小值或最大值、求和等等。迭代器方法也可以链接，提供非常易读的数据处理代码。</p>
<h2 id="引用-vs-指针"><a href="#引用-vs-指针" class="headerlink" title="引用 vs 指针"></a>引用 vs 指针</h2><p>在 Rust 中，指针（称为<a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer" target="_blank" rel="noopener"><em>原始指针</em></a>）存在但仅在特定情况下使用，因为总是考虑取消引用它们<code>unsafe</code>——Rust 不能提供关于指针后面可能是什么的通常保证。</p>
<p>在大多数情况下，我们改用<em>引用</em>，由指定的<code>&amp;</code>符号，或 <em>可变的引用</em>，以表示<code>&amp;mut</code>。引用的行为类似于指针，因为它们可以被取消引用以访问底层值，但它们是 Rust 所有权系统的关键部分：Rust 将严格强制您可能只有一个可变引用<em>或</em>多个非可变引用到同一个在任何给定时间的价值。</p>
<p>在实践中，这意味着您必须更加小心是否需要对数据进行可变访问：在 C 中，默认值是可变的，您必须明确说明<code>const</code>，而在 Rust 中则相反。</p>
<p>您可能仍然使用原始指针的一种情况是直接与硬件交互（例如，将指向缓冲区的指针写入 DMA 外设寄存器），并且它们也在幕后用于所有外设访问包，以允许您读取和写内存映射寄存器。</p>
<h2 id="Volatile-Access"><a href="#Volatile-Access" class="headerlink" title="Volatile Access"></a>Volatile Access</h2><p>在 C 中，个别变量可能被标记为<code>volatile</code>，向编译器表明变量中的值可能会在访问之间发生变化。易失性变量通常用于内存映射寄存器的嵌入式上下文中。</p>
<p>在 Rust 中，我们没有将变量标记为<code>volatile</code>，而是使用特定的方法来执行 volatile 访问：<a href="https://doc.rust-lang.org/core/ptr/fn.read_volatile.html" target="_blank" rel="noopener"><code>core::ptr::read_volatile</code></a>和 <a href="https://doc.rust-lang.org/core/ptr/fn.write_volatile.html" target="_blank" rel="noopener"><code>core::ptr::write_volatile</code></a>。这些方法采用 a<code>*const T</code>或 a <code>*mut T</code> （<em>原始指针</em>，如上所述）并执行易失性读取或写入。</p>
<p>例如，在 C 中你可以这样写：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">volatile</span> bool signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    signalled <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>signalled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        signalled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Rust 中的等价物将在每次访问时使用 volatile 方法：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[interrupt]</span>
<span class="token keyword">fn</span> <span class="token function">ISR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Signal that the interrupt has occurred</span>
    <span class="token comment" spellcheck="true">// (In real code, you should consider a higher level primitive,</span>
    <span class="token comment" spellcheck="true">//  such as an atomic type).</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Sleep until signalled</span>
        <span class="token keyword">while</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">!</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SIGNALLED<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Reset signalled indicator</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> SIGNALLED<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Perform some task that was waiting for the interrupt</span>
        <span class="token function">run_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码示例中有几点值得注意：</p>
<ul>
<li>我们可以传递<code>&amp;mut SIGNALLED</code>到函数 requires <code>*mut T</code>，因为 <code>&amp;mut T</code>自动转换为 a <code>*mut T</code>（对于<code>*const T</code>）</li>
<li>我们需要/方法的<code>unsafe</code>块，因为它们是函数。确保安全使用是程序员的责任：有关更多详细信息，请参阅方法文档。<code>read_volatile``write_volatile``unsafe</code></li>
</ul>
<p>在您的代码中直接使用这些函数是很少见的，因为它们通常会由更高级别的库为您处理。对于内存映射外设，外设访问 crate 将自动实现易失性访问，而对于并发原语，有更好的抽象可用。</p>
<h2 id="压缩和对齐类型"><a href="#压缩和对齐类型" class="headerlink" title="压缩和对齐类型"></a>压缩和对齐类型</h2><p>在嵌入式 C 中，通常会告诉编译器一个变量必须有一定的对齐方式，或者一个结构必须打包而不是对齐，通常是为了满足特定的硬件或协议要求。</p>
<p>在 Rust 中，这由<code>repr</code>结构或联合上的属性控制。默认表示不提供布局保证，因此不应用于与硬件或 C 互操作的代码。编译器可能会重新排序结构成员或插入填充，并且行为可能会随着 Rust 的未来版本而改变。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffecb3511d0 0x7ffecb3511d4 0x7ffecb3511d2</span>
<span class="token comment" spellcheck="true">// Note ordering has been changed to x, z, y to improve packing.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为确保布局可与 C 互操作，请使用<code>repr(C)</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7fffd0d84c60 0x7fffd0d84c62 0x7fffd0d84c64</span>
<span class="token comment" spellcheck="true">// Ordering is preserved and the layout will not change over time.</span>
<span class="token comment" spellcheck="true">// `z` is two-byte aligned so a byte of padding exists between `y` and `z`.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要确保打包表示，请使用<code>repr(packed)</code>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(packed)]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Unsafe is required to borrow a field of a packed struct.</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffd33598490 0x7ffd33598492 0x7ffd33598493</span>
<span class="token comment" spellcheck="true">// No padding has been inserted between `y` and `z`, so now `z` is unaligned.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意， using<code>repr(packed)</code>还将类型的对齐方式设置为<code>1</code>。</p>
<p>最后，要指定特定的对齐方式，请使用<code>repr(align(n))</code>，其中<code>n</code>是要对齐的字节数（并且必须是 2 的幂）：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[repr(align(4096))]</span>
<span class="token keyword">struct</span> Foo <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> u8<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> u16<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> u <span class="token operator">=</span> Foo <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:p} {:p} {:p}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 0x7ffec909a000 0x7ffec909a002 0x7ffec909a004</span>
<span class="token comment" spellcheck="true">// 0x7ffec909b000 0x7ffec909b002 0x7ffec909b004</span>
<span class="token comment" spellcheck="true">// The two instances `u` and `v` have been placed on 4096-byte alignments,</span>
<span class="token comment" spellcheck="true">// evidenced by the `000` at the end of their addresses.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，我们可以结合<code>repr(C)</code>使用<code>repr(align(n))</code>以获得对齐且与 C 兼容的布局。这是不允许的结合<code>repr(align(n))</code>有 <code>repr(packed)</code>，因为<code>repr(packed)</code>套对齐<code>1</code>。一个<code>repr(packed)</code>类型也不允许包含一个<code>repr(align(n))</code>类型。</p>
<h2 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h2><ul>
<li><a href="https://docs.rust-embedded.org/faq.html" target="_blank" rel="noopener">Rust 嵌入式常见问题解答</a></li>
<li><a href="http://blahg.josefsipek.net/?p=580" target="_blank" rel="noopener">C 程序员的 Rust 指针</a></li>
<li><a href="https://github.com/diwic/reffers-rs/blob/master/docs/Pointers.md" target="_blank" rel="noopener">我曾经使用指针 - 现在呢？</a></li>
</ul>
<h1 id="Interoperability（互操作性）"><a href="#Interoperability（互操作性）" class="headerlink" title="Interoperability（互操作性）"></a>Interoperability（互操作性）</h1><p>Rust 和 C 代码之间的互操作性始终依赖于两种语言之间的数据转换。为此目的，在被<code>stdlib</code>调用 <a href="https://doc.rust-lang.org/std/ffi/index.html" target="_blank" rel="noopener"><code>std::ffi</code></a>和 中 有两个专用模块<a href="https://doc.rust-lang.org/std/os/raw/index.html" target="_blank" rel="noopener"><code>std::os::raw</code></a>。</p>
<p><code>std::os::raw</code> 处理可以由编译器隐式转换的低级原始类型，因为 Rust 和 C 之间的内存布局足够相似或相同。</p>
<p><code>std::ffi</code>提供了一些实用程序用于将更加复杂的类型，如弦乐器，既映射<code>&amp;str</code>和<code>String</code> 对C-类型是更容易和更安全的处理。</p>
<p>这些模块都没有在 中可用<code>core</code>，但是您可以在crate 中找到<code>#![no_std]</code> 兼容版本，<code>std::ffi::{CStr,CString}</code>以及<a href="https://crates.io/crates/cstr_core" target="_blank" rel="noopener"><code>cstr_core</code></a>crate 中的大多数<code>std::os::raw</code>类型<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>。</p>
<table>
<thead>
<tr>
<th>锈型</th>
<th>中间的</th>
<th>C型</th>
</tr>
</thead>
<tbody><tr>
<td>细绳</td>
<td>字符串</td>
<td>*字符</td>
</tr>
<tr>
<td>&amp;str</td>
<td>CStr</td>
<td>*常量字符</td>
</tr>
<tr>
<td>()</td>
<td>c_void</td>
<td>空白</td>
</tr>
<tr>
<td>u32 或 u64</td>
<td>c_uint</td>
<td>无符号整数</td>
</tr>
<tr>
<td>等等</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>如上所述，基本类型可以由编译器隐式转换。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">unsafe</span> <span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>num<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c_num<span class="token punctuation">:</span> c_uint <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token keyword">let</span> r_num<span class="token punctuation">:</span> u32 <span class="token operator">=</span> c_num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="与其他构建系统的互操作性"><a href="#与其他构建系统的互操作性" class="headerlink" title="与其他构建系统的互操作性"></a>与其他构建系统的互操作性</h3><p>在您的嵌入式项目中包含 Rust 的一个常见要求是将 Cargo 与您现有的构建系统相结合，例如 make 或 cmake。</p>
<p>我们正在<a href="https://github.com/rust-embedded/book/issues/61" target="_blank" rel="noopener">问题 #61 中的</a>问题跟踪器上为此收集示例和用例 。</p>
<h3 id="与-RTOS-的互操作性"><a href="#与-RTOS-的互操作性" class="headerlink" title="与 RTOS 的互操作性"></a>与 RTOS 的互操作性</h3><p>将 Rust 与诸如 FreeRTOS 或 ChibiOS 之类的 RTOS 集成仍在进行中；尤其是从 Rust 调用 RTOS 函数可能会很棘手。</p>
<p>我们正在<a href="https://github.com/rust-embedded/book/issues/62" target="_blank" rel="noopener">问题 #62 中的</a>问题跟踪器上为此收集示例和用例 。</p>
<h2 id="A-little-C-with-your-Rust"><a href="#A-little-C-with-your-Rust" class="headerlink" title="A little C with your Rust"></a>A little C with your Rust</h2><p>在 Rust 项目中使用 C 或 C++ 包括两个主要部分：</p>
<ul>
<li>包装暴露的 C API 以与 Rust 一起使用</li>
<li>构建您的 C 或 C++ 代码以与 Rust 代码集成</li>
</ul>
<p>由于 C++ 没有稳定的 ABI 供 Rust 编译器作为目标，因此建议<code>C</code>在将 Rust 与 C 或 C++ 结合使用时使用ABI。</p>
<h3 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h3><p>在从 Rust 使用 C 或 C++ 代码之前，有必要定义（在 Rust 中）链接代码中存在哪些数据类型和函数签名。在 C 或 C++ 中，您将包含定义此数据的头 (<code>.h</code>或<code>.hpp</code>) 文件。在 Rust 中，需要手动将这些定义转换为 Rust，或者使用工具生成这些定义。</p>
<p>首先，我们将介绍将这些定义从 C/C++ 手动转换为 Rust。</p>
<h4 id="包装-C-函数和数据类型"><a href="#包装-C-函数和数据类型" class="headerlink" title="包装 C 函数和数据类型"></a>包装 C 函数和数据类型</h4><p>通常，用 C 或 C++ 编写的库将提供一个定义公共接口中使用的所有类型和函数的头文件。示例文件可能如下所示：</p>
<pre class="line-numbers language-C"><code class="language-C">/* File: cool.h */
typedef struct CoolStruct {
    int x;
    int y;
} CoolStruct;

void cool_function(int i, char c, CoolStruct* cs);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当转换为 Rust 时，此界面将如下所示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/* File: cool_bindings.rs */</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    <span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span>
    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们一次一个地看一下这个定义，以解释每个部分。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> CoolStruct <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>默认情况下，Rust 不保证包含在<code>struct</code>. 为了保证与 C 代码的兼容性，我们包含了<code>#[repr(C)]</code>属性，它指示 Rust 编译器始终使用 C 在结构中组织数据的相同规则。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> x<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
<span class="token keyword">pub</span> y<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>由于 C 或 C++ 定义<code>int</code>or 的方式的灵活性，<code>char</code>建议使用 中定义的原始数据类型<code>cty</code>，它将类型从 C 映射到 Rust 中的类型。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">cool_function</span><span class="token punctuation">(</span> <span class="token punctuation">...</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此语句定义了使用 C ABI 的函数的签名，称为<code>cool_function</code>. 通过定义签名而不定义函数体，这个函数的定义需要在别处提供，或者从静态库链接到最终库或二进制文件。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    i<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_int<span class="token punctuation">,</span>
    c<span class="token punctuation">:</span> cty<span class="token punctuation">:</span><span class="token punctuation">:</span>c_char<span class="token punctuation">,</span>
    cs<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> CoolStruct<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>与我们上面的数据类型类似，我们使用 C 兼容定义来定义函数参数的数据类型。为了清楚起见，我们还保留了相同的参数名称。</p>
<p>我们这里有一种新类型，<code>*mut CoolStruct</code>. 由于 C 没有 Rust 引用的概念，它看起来像这样：<code>&amp;mut CoolStruct</code>，我们有一个原始指针。由于取消引用此指针是<code>unsafe</code>，并且该指针实际上可能是一个<code>null</code>指针，因此在与 C 或 C++ 代码交互时必须注意确保 Rust 的典型保证。</p>
<h4 id="自动生成界面"><a href="#自动生成界面" class="headerlink" title="自动生成界面"></a>自动生成界面</h4><p>有一个名为<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>的工具可以自动执行这些转换，而不是手动生成这些接口，这可能很乏味且容易出错。有关<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>的使用<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">说明</a>，请参阅<a href="https://rust-lang.github.io/rust-bindgen/" target="_blank" rel="noopener">bindgen 用户手册</a>，但典型的过程包括以下内容：</p>
<ol>
<li>收集所有 C 或 C++ 头文件，定义你想与 Rust 一起使用的接口或数据类型。</li>
<li>编写一个<code>bindings.h</code>文件，它<code>#include "..."</code>是您在第一步中收集的每个文件。</li>
<li>提供此<code>bindings.h</code>文件以及用于将代码编译为<code>bindgen</code>. 提示：使用<code>Builder.ctypes_prefix("cty")</code>/ <code>--ctypes-prefix=cty</code>和<code>Builder.use_core()</code>/<code>--use-core</code>使生成的代码<code>#![no_std]</code>兼容。</li>
<li><code>bindgen</code>将生成生成的 Rust 代码到终端窗口的输出。此文件可能会通过管道传输到项目中的文件，例如<code>bindings.rs</code>. 你可以在你的 Rust 项目中使用这个文件来与编译和链接为外部库的 C/C++ 代码交互。提示：<a href="https://crates.io/crates/cty" target="_blank" rel="noopener"><code>cty</code></a>如果生成的绑定中的类型带有前缀，请不要忘记使用crate <code>cty</code>。</li>
</ol>
<h3 id="构建您的-C-C-代码"><a href="#构建您的-C-C-代码" class="headerlink" title="构建您的 C/C++ 代码"></a>构建您的 C/C++ 代码</h3><p>由于 Rust 编译器不直接知道如何编译 C 或 C++ 代码（或来自任何其他语言的代码，提供 C 接口），因此有必要提前编译您的非 Rust 代码。</p>
<p>对于嵌入式项目，这通常意味着将 C/C++ 代码编译为静态存档（例如<code>cool-library.a</code>），然后可以在最后的链接步骤中将其与 Rust 代码结合。</p>
<p>如果您要使用的库已作为静态存档分发，则无需重新构建代码。只需如上所述转换提供的接口头文件，并在编译/链接时包含静态存档。</p>
<p>如果代码存在作为源项目，这将是必要编译C / C ++代码到静态库，或者通过触发现有构建系统（如<code>make</code>，<code>CMake</code>等），或通过移植必要的编译步骤，使用一种叫做<code>cc</code>板条箱的工具。对于这两个步骤，都需要使用<code>build.rs</code>脚本。</p>
<h4 id="Rustbuild-rs构建脚本"><a href="#Rustbuild-rs构建脚本" class="headerlink" title="Rustbuild.rs构建脚本"></a>Rust<code>build.rs</code>构建脚本</h4><p>一个<code>build.rs</code>脚本是写在鲁斯特语法的文件，那是你的编译机上运行后，你的项目的依赖已建成，但在此之前项目的生成。</p>
<p>完整的参考可以在<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">这里</a>找到。<code>build.rs</code>脚本对于生成代码（例如通过<a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noopener">bindgen</a>）、调用外部构建系统（例如<code>Make</code>）或通过使用<code>cc</code>crate直接编译 C/C++ 非常有用。</p>
<h4 id="触发外部构建系统"><a href="#触发外部构建系统" class="headerlink" title="触发外部构建系统"></a>触发外部构建系统</h4><p>对于具有复杂外部项目或构建系统的项目，<a href="https://doc.rust-lang.org/std/process/struct.Command.html" target="_blank" rel="noopener"><code>std::process::Command</code></a>通过遍历相对路径、调用固定命令（例如<code>make library</code>），然后将生成的静态库复制到适当的在<code>target</code>构建目录中的位置。</p>
<p>虽然您的 crate 可能针对<code>no_std</code>嵌入式平台，但您<code>build.rs</code>只能在编译 crate 的机器上执行。这意味着您可以使用将在您的编译主机上运行的任何 Rust crate。</p>
<h4 id="使用cccrate构建-C-C-代码"><a href="#使用cccrate构建-C-C-代码" class="headerlink" title="使用cccrate构建 C/C++ 代码"></a>使用<code>cc</code>crate构建 C/C++ 代码</h4><p>对于依赖项或复杂性有限的项目，或者对于难以修改构建系统以生成静态库（而不是最终的二进制文件或可执行文件）的项目，使用<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>可能更容易，它提供了惯用的 Rust主机提供的编译器接口。</p>
<p>在将单个 C 文件编译为静态库的依赖项的最简单情况下，<code>build.rs</code>使用<a href="https://github.com/alexcrichton/cc-rs" target="_blank" rel="noopener"><code>cc</code>crate</a>的示例脚本如下所示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> cc<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cc<span class="token punctuation">:</span><span class="token punctuation">:</span>Build<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">"foo.c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"libfoo.a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="A-little-Rust-with-your-C"><a href="#A-little-Rust-with-your-C" class="headerlink" title="A little Rust with your C"></a>A little Rust with your C</h2><p>在 C 或 C++ 项目中使用 Rust 代码主要由两部分组成。</p>
<ul>
<li>在 Rust 中创建一个 C 友好的 API</li>
<li>将您的 Rust 项目嵌入到外部构建系统中</li>
</ul>
<p>除了<code>cargo</code>and之外<code>meson</code>，大多数构建系统都没有原生的 Rust 支持。因此，您很可能最好仅<code>cargo</code>用于编译您的 crate 和任何依赖项。</p>
<h3 id="设置项目"><a href="#设置项目" class="headerlink" title="设置项目"></a>设置项目</h3><p><code>cargo</code>像往常一样创建一个新项目。</p>
<p>有一些标志告诉<code>cargo</code>发出一个系统库，而不是它的常规 rust 目标。这也允许您为库设置不同的输出名称，如果您希望它与您的 crate 的其余部分不同。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[lib]
name = "your_crate"
crate-type = ["cdylib"]      # Creates dynamic lib
# crate-type = ["staticlib"] # Creates static lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="构建CAPI"><a href="#构建CAPI" class="headerlink" title="构建CAPI"></a>构建<code>C</code>API</h3><p>因为 C++ 没有稳定的 ABI 供 Rust 编译器作为目标，我们<code>C</code>用于不同语言之间的任何互操作性。在 C 和 C++ 代码中使用 Rust 时也不例外。</p>
<h4 id="no-mangle"><a href="#no-mangle" class="headerlink" title="#[no_mangle\]"></a><code>#[no_mangle\]</code></h4><p>Rust 编译器对符号名称的处理与本机代码链接器所期望的不同。因此，任何 Rust 导出以在 Rust 之外使用的函数都需要被告知不要被编译器破坏。</p>
<h4 id="extern-quot-C-quot"><a href="#extern-quot-C-quot" class="headerlink" title="extern &quot;C&quot;"></a><code>extern "C"</code></h4><p>默认情况下，您在 Rust 中编写的任何函数都将使用 Rust ABI（它也不稳定）。相反，在构建面向外部的 FFI API 时，我们需要告诉编译器使用系统 ABI。</p>
<p>根据您的平台，您可能希望针对特定的 ABI 版本，<a href="https://doc.rust-lang.org/reference/items/external-blocks.html" target="_blank" rel="noopener">此处</a>记录了这些版本。</p>
<hr>
<p>将这些部分放在一起，您会得到一个大致如下所示的函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>就像<code>C</code>在您的 Rust 项目中使用代码一样，您现在需要将数据从应用程序的其余部分可以理解的形式来回转换。</p>
<h3 id="链接和更大的项目背景"><a href="#链接和更大的项目背景" class="headerlink" title="链接和更大的项目背景"></a>链接和更大的项目背景</h3><p>那么，问题就解决了一半。你现在怎么用这个？</p>
<p><strong>这在很大程度上取决于您的项目和/或构建系统</strong></p>
<p><code>cargo</code>将创建一个<code>my_lib.so</code>/<code>my_lib.dll</code>或<code>my_lib.a</code>文件，具体取决于您的平台和设置。这个库可以简单地由你的构建系统链接。</p>
<p>但是，从 C 调用 Rust 函数需要一个头文件来声明函数签名。</p>
<p>Rust-ffi API 中的每个函数都需要有一个对应的头函数。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">rust_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后会变成</p>
<pre class="line-numbers language-C"><code class="language-C">void rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>等等。</p>
<p>有一个工具可以自动执行此过程，称为<a href="https://github.com/eqrion/cbindgen" target="_blank" rel="noopener">cbindgen</a>，它会分析您的 Rust 代码，然后从中生成 C 和 C++ 项目的标头。</p>
<p>此时，使用 C 中的 Rust 函数就像包含标头并调用它们一样简单！</p>
<pre class="line-numbers language-C"><code class="language-C">#include "my-rust-project.h"
rust_function();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Optimizations-the-speed-size-tradeoff"><a href="#Optimizations-the-speed-size-tradeoff" class="headerlink" title="Optimizations: the speed size tradeoff"></a>Optimizations: the speed size tradeoff</h1><p>每个人都希望他们的程序超快和超小，但通常不可能同时拥有这两种特性。本节讨论提供的不同优化级别<code>rustc</code>以及它们如何影响程序的执行时间和二进制大小。</p>
<h2 id="没有优化"><a href="#没有优化" class="headerlink" title="没有优化"></a>没有优化</h2><p>这是默认设置。当您打电话时，<code>cargo build</code>您使用开发 (AKA <code>dev</code>) 配置文件。此配置文件针对调试进行了优化，因此它启用调试信息，但<em>不</em>启用任何优化，即它使用<code>-C opt-level = 0</code>.</p>
<p>至少对于裸机开发而言，debuginfo 是零成本的，因为它不会占用 Flash / ROM 中的空间，因此我们实际上建议您在发布配置文件中启用 debuginfo – 默认情况下禁用它。这将允许您在调试发布版本时使用断点。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# symbols are nice and they don't increase the size on Flash
debug = true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>没有优化对于调试来说是很好的，因为单步调试代码感觉就像你在逐条语句执行程序，而且你可以<code>print</code> 在 GDB 中堆叠变量和函数参数。代码优化后，尝试打印变量会导致<code>$0 = &lt;value optimized out&gt;</code>打印。</p>
<p><code>dev</code>配置文件的最大缺点是生成的二进制文件会很大而且很慢。大小通常更成问题，因为未优化的二进制文件可能占用数十 KiB 的闪存，而您的目标设备可能没有——结果：未优化的二进制文件不适合您的设备！</p>
<p>我们可以有更小的、调试器友好的二进制文件吗？是的，有一个技巧。</p>
<h3 id="优化依赖"><a href="#优化依赖" class="headerlink" title="优化依赖"></a>优化依赖</h3><p>有一个名为 Cargo 的功能<a href="https://doc.rust-lang.org/cargo/reference/profiles.html#overrides" target="_blank" rel="noopener"><code>profile-overrides</code></a>，可让您覆盖依赖项的优化级别。您可以使用该功能来优化所有依赖项的大小，同时保持 top crate 未优化和调试器友好。</p>
<p>下面是一个例子：</p>
<pre class="line-numbers language-toml"><code class="language-toml"># Cargo.toml
[package]
name = "app"
# ..

[profile.dev.package."*"] # +
opt-level = "z" # +<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>没有覆盖：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 9060   0x8000400
.rodata               1708   0x8002780
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用覆盖：</p>
<pre class="line-numbers language-text"><code class="language-text">$ cargo size --bin app -- -A
app  :
section               size        addr
.vector_table         1024   0x8000000
.text                 3490   0x8000400
.rodata               1100   0x80011c0
.data                    0  0x20000000
.bss                     4  0x20000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这意味着 Flash 使用量减少了 6 KiB，而 top crate 的可调试性没有任何损失。如果您进入依赖项，那么您将<code>&lt;value optimized out&gt;</code>再次开始看到这些 消息，但通常情况下，您想要调试顶级板条箱而不是依赖项。如果您<em>确实</em>需要调试依赖项，那么您可以使用该<code>profile-overrides</code>功能从优化中排除特定的依赖项。请参阅下面的示例：</p>
<pre class="line-numbers language-toml"><code class="language-toml"># ..

# don't optimize the `cortex-m-rt` crate
[profile.dev.package.cortex-m-rt] # +
opt-level = 0 # +

# but do optimize all the other dependencies
[profile.dev.package."*"]
codegen-units = 1 # better optimizations
opt-level = "z"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在顶部板条箱和<code>cortex-m-rt</code>调试器友好！</p>
<h2 id="优化速度"><a href="#优化速度" class="headerlink" title="优化速度"></a>优化速度</h2><p>截至 2018 年 9 月 18 日，<code>rustc</code>支持三个“优化速度”级别：<code>opt-level = 1</code>、<code>2</code>和<code>3</code>。当您运行时，<code>cargo build --release</code>您使用的是默认为<code>opt-level = 3</code>.</p>
<p><code>opt-level = 2</code>和都<code>3</code>以牺牲二进制大小为代价来优化速度，但 level<code>3</code>比 level 执行更多的矢量化和内联<code>2</code>。特别是，您会看到 at<code>opt-level</code>等于或大于<code>2</code>LLVM 将展开循环。循环展开在 Flash / ROM 方面的成本相当高（例如，从 26 字节到 194 以实现零数组循环），但也可以在给定正确条件的情况下将执行时间减半（例如，迭代次数足够大）。</p>
<p>目前没有办法禁用循环展开<code>opt-level = 2</code>，<code>3</code>所以如果你负担不起它的成本，你应该优化你的程序的大小。</p>
<h2 id="优化尺寸"><a href="#优化尺寸" class="headerlink" title="优化尺寸"></a>优化尺寸</h2><p>截至 2018 年 9 月 18 日，<code>rustc</code>支持两个“优化大小”级别：<code>opt-level = "s"</code>和<code>"z"</code>. 这些名称是从 clang/LLVM 继承而来的，并不太具有描述性，但<code>"z"</code>旨在说明它生成的二进制文件比<code>"s"</code>.</p>
<p>如果您希望针对大小优化发布二进制文件<code>profile.release.opt-level</code>，请<code>Cargo.toml</code>按如下所示更改 设置。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.release]
# or "z"
opt-level = "s"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这两个优化级别大大降低了 LLVM 的内联阈值，这是一个用于决定是否内联函数的指标。Rust 原则之一是零成本抽象；这些抽象倾向于使用许多新类型和小函数来保存不变量（例如，借用内部值的函数，例如<code>deref</code>, <code>as_ref</code>），因此低内联阈值会使 LLVM 错过优化机会（例如消除死分支、内联调用闭包）。</p>
<p>在优化大小时，您可能想尝试增加内联阈值，看看这是否对二进制大小有任何影响。更改内联阈值的推荐方法是将<code>-C inline-threshold</code>标志附加到<code>.cargo/config.toml</code>.</p>
<pre class="line-numbers language-toml"><code class="language-toml"># .cargo/config.toml
# this assumes that you are using the cortex-m-quickstart template
[target.'cfg(all(target_arch = "arm", target_os = "none"))']
rustflags = [
  # ..
  "-C", "inline-threshold=123", # +
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用什么价值？<a href="https://github.com/rust-lang/rust/blob/1.29.0/src/librustc_codegen_llvm/back/write.rs#L2105-L2122" target="_blank" rel="noopener">从 1.29.0 开始，这些是不同优化级别使用的内联阈值</a>：</p>
<ul>
<li><code>opt-level = 3</code> 使用 275</li>
<li><code>opt-level = 2</code> 使用 225</li>
<li><code>opt-level = "s"</code> 使用 75</li>
<li><code>opt-level = "z"</code> 使用 25</li>
</ul>
<p>你应该尝试<code>225</code>和<code>275</code>优化大小时。</p>
<h1 id="Appendix-A-Glossary"><a href="#Appendix-A-Glossary" class="headerlink" title="Appendix A: Glossary"></a>Appendix A: Glossary</h1><p>The embedded ecosystem is full of different protocols, hardware components and vendor-specific things that use their own terms and abbreviations. This Glossary attempts to list them with pointers for understanding them better.</p>
<h3 id="BSP"><a href="#BSP" class="headerlink" title="BSP"></a>BSP</h3><p>A Board Support Crate provides a high level interface configured for a specific board. It usually depends on a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">HAL</a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="FPU"><a href="#FPU" class="headerlink" title="FPU"></a>FPU</h3><p>Floating-point Unit. A ‘math processor’ running only operations on floating-point numbers.</p>
<h3 id="HAL"><a href="#HAL" class="headerlink" title="HAL"></a>HAL</h3><p>A Hardware Abstraction Layer crate provides a developer friendly interface to a microcontroller’s features and peripherals. It is usually implemented on top of a <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#pac" target="_blank" rel="noopener">Peripheral Access Crate (PAC)</a>. It may also implement traits from the <a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a> crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><p>Sometimes referred to as <code>I²C</code> or Inter-IC. It is a protocol meant for hardware communication within a single integrated circuit. See <a href="https://en.wikipedia.org/wiki/I2c" target="_blank" rel="noopener">here</a> for more details</p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>A Peripheral Access Crate provides access to a microcontroller’s peripherals. It is one of the lower level crates and is usually generated directly from the provided <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#svd" target="_blank" rel="noopener">SVD</a>, often using <a href="https://github.com/rust-embedded/svd2rust/" target="_blank" rel="noopener">svd2rust</a>. The <a href="https://docs.rust-embedded.org/book/appendix/glossary.html#hal" target="_blank" rel="noopener">Hardware Abstraction Layer</a> would usually depend on this crate. There is a more detailed description on the <a href="https://docs.rust-embedded.org/book/start/registers.html" target="_blank" rel="noopener">memory-mapped registers page</a> or for a broader overview see <a href="https://youtu.be/vLYit_HHPaY" target="_blank" rel="noopener">this video</a>.</p>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>Serial Peripheral Interface. See <a href="https://en.wikipedia.org/wiki/Serial_peripheral_interface" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="SVD"><a href="#SVD" class="headerlink" title="SVD"></a>SVD</h3><p>System View Description is an XML file format used to describe the programmers view of a microcontroller device. You can read more about it on <a href="https://www.keil.com/pack/doc/CMSIS/SVD/html/index.html" target="_blank" rel="noopener">the ARM CMSIS documentation site</a>.</p>
<h3 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h3><p>Universal asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<h3 id="USART"><a href="#USART" class="headerlink" title="USART"></a>USART</h3><p>Universal synchronous and asynchronous receiver-transmitter. See <a href="https://en.wikipedia.org/wiki/Universal_synchronous_and_asynchronous_receiver-transmitter" target="_blank" rel="noopener">here</a> for more information.</p>
<hr>
<h1 id="😁《Discovery》"><a href="#😁《Discovery》" class="headerlink" title="😁《Discovery》"></a>😁《Discovery》</h1><h1 id="硬件-知识要求"><a href="#硬件-知识要求" class="headerlink" title="硬件/知识要求"></a>硬件/知识要求</h1><p>由于嵌入式编程的性质，理解值的二进制和十六进制表示如何工作，以及一些按位运算符的使用也将非常有帮助。例如，了解以下程序如何产生其输出会很有用。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">0x4000_0000</span> <span class="token operator">+</span> <span class="token number">0xa2</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Use of the bit shift "&lt;&lt;" operation.</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// {:X} will format values as hexadecimal</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:X}: {:X}"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，要遵循此材料，您将需要以下硬件：</p>
<p>（有些组件是可选的，但建议使用）</p>
<ul>
<li>一个<a href="http://www.st.com/en/evaluation-tools/stm32f3discovery.html" target="_blank" rel="noopener">STM32F3DISCOVERY</a>板。</li>
</ul>
<p>（您可以从“大型”<a href="http://www.mouser.com/ProductDetail/STMicroelectronics/STM32F3DISCOVERY" target="_blank" rel="noopener">电子</a> <a href="http://www.digikey.com/product-detail/en/stmicroelectronics/STM32F3DISCOVERY/497-13192-ND" target="_blank" rel="noopener">供应商</a>或<a href="https://www.aliexpress.com/wholesale?SearchText=stm32f3discovery" target="_blank" rel="noopener">电子商务</a> <a href="http://www.ebay.com/sch/i.html?_nkw=stm32f3discovery" target="_blank" rel="noopener">网站</a>购买此板）</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-16313628370881.jpg" alt=""></p>
<ul>
<li>可选的。一个<strong>3.3V</strong> USB &lt;-&gt; 串行模块。为了详细说明：如果你有发现主板的最新版本中的一个（通常是给出的第一个版本的情况下在数年前发布的），那么你就<em>不会</em>因为主板包括板载这个功能需要这个模块。如果您有旧版电路板，那么第 10 章和第 11 章将需要此模块。为了完整起见，我们将包含使用串行模块的说明。本书将使用<a href="https://www.sparkfun.com/products/9873" target="_blank" rel="noopener">此特定型号</a>，但您可以使用任何其他型号，只要它在 3.3V 下运行即可。您可以从<a href="https://www.aliexpress.com/wholesale?SearchText=CH340G" target="_blank" rel="noopener">电子商务</a>网站购买的 CH340G 模块也可以使用，而且可能更便宜。</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/language/serial-16313628370885.jpg" alt=""></p>
<ul>
<li>可选的。HC-05 蓝牙模块（带接头！）。HC-06 也可以。</li>
</ul>
<p>（与其他中国零件一样，您几乎只能在<a href="http://www.ebay.com/sch/i.html?_nkw=hc-05" target="_blank" rel="noopener">电子商务</a> <a href="https://www.aliexpress.com/wholesale?SearchText=hc-05" target="_blank" rel="noopener">网站</a>上找到这些零件。（美国）电子供应商出于某种原因通常不会库存这些零件）</p>
<p><img src="/images/loading.gif" data-original="../images/language/bluetooth-16313628370887.jpg" alt=""></p>
<ul>
<li>两条 mini-B USB 电缆。需要一个才能使 STM32F3DISCOVERY 板工作。仅当您有串行 &lt;-&gt; USB 模块时才需要另一个。确保电缆都支持数据传输，因为某些电缆仅支持充电设备。</li>
</ul>
<p><img src="/images/loading.gif" data-original="../images/language/usb-cable-16313628370889.jpg" alt=""></p>
<blockquote>
<p><strong>注意</strong>这些<strong>并不是</strong>几乎每部 Android 手机都随附的 USB 电缆；那些是<em>微型</em>USB 电缆。确保你有正确的东西！</p>
</blockquote>
<ul>
<li>主要是可选的。5 根母对母、4 根公对母和 1 根公对公<em>跳线</em>（又名杜邦）。您<em>很可能</em>需要一对一女性才能使 ITM 发挥作用。仅当您使用 USB &lt;-&gt; 串行和蓝牙模块时才需要其他电线。</li>
</ul>
<p>（您可以从电子<a href="https://www.adafruit.com/categories/306" target="_blank" rel="noopener">供应商</a>或<a href="http://www.ebay.com/sch/i.html?_nkw=dupont+wire" target="_blank" rel="noopener">电子商务</a> <a href="https://www.aliexpress.com/wholesale?SearchText=dupont+wire" target="_blank" rel="noopener">网站</a>获得这些）</p>
<p><img src="/images/loading.gif" data-original="../images/language/jumper-wires-16313628370883.jpg" alt=""></p>
<blockquote>
<p><strong>FAQ</strong> : 等等，为什么我需要这个特定的硬件？</p>
</blockquote>
<p>它让我和你的生活更轻松。</p>
<p>如果我们不必担心硬件差异，那么材料会更加平易近人。相信我这一点。</p>
<blockquote>
<p><strong>常见问题</strong>：我可以使用不同的开发板来遵循此材料吗？</p>
</blockquote>
<p>也许？这主要取决于两件事：您之前使用微控制器的经验和/或是否已经存在<a href="https://docs.rs/f3" target="_blank" rel="noopener"><code>f3</code></a>用于您的开发板的高级板条箱，例如。</p>
<p>使用不同的开发板，如果不是所有的初学者友好性和“易于遵循”，IMO，本文将失去大部分。</p>
<p>如果您有不同的开发板，并且您不认为自己完全是初学者，那么最好从<a href="https://rust-embedded.github.io/cortex-m-quickstart/cortex_m_quickstart/" target="_blank" rel="noopener">快速入门</a>项目模板开始。</p>
<h1 id="Setting-up-a-development-environment"><a href="#Setting-up-a-development-environment" class="headerlink" title="Setting up a development environment"></a>Setting up a development environment</h1><h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><p>处理微控制器涉及多种工具，因为我们将处理与您的计算机不同的架构，我们必须在“远程”设备上运行和调试程序。</p>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p>工具不是一切。没有文档，几乎不可能使用微控制器。</p>
<p>我们将在本书中提及所有这些文件：</p>
<p><em>注意</em>所有这些链接都指向 PDF 文件，其中一些文件长达数百页，大小为数 MB。</p>
<ul>
<li><a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">STM32F3DISCOVERY 用户手册</a></li>
<li><a href="http://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">STM32F303VC 数据表</a></li>
<li><a href="http://www.st.com/resource/en/reference_manual/dm00043574.pdf" target="_blank" rel="noopener">STM32F303VC 参考手册</a></li>
<li><a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">LSM303DLHC</a> *</li>
<li><a href="https://www.st.com/content/ccc/resource/technical/document/application_note/2c/d9/a7/f8/43/48/48/64/DM00119036.pdf/files/DM00119036.pdf/jcr:content/translations/en.DM00119036.pdf" target="_blank" rel="noopener">L3GD20</a> *</li>
</ul>
<p><strong>*注意</strong>：较新的（从 2020/09 左右开始）探索板可能有不同的电子罗盘和陀螺仪（请参阅用户手册）。因此，第 14-16 章中的许多内容将不会按原样运行。像<a href="https://github.com/rust-embedded/discovery/issues/274" target="_blank" rel="noopener">这样</a>检查 github 问题。</p>
<h3 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h3><p>我们将使用下面列出的所有工具。在未指定最低版本的情况下，任何最新版本都可以使用，但我们列出了我们测试过的版本。</p>
<ul>
<li><p>Rust 1.31 或更新的工具链。</p>
</li>
<li><p><a href="https://crates.io/crates/itm" target="_blank" rel="noopener"><code>itmdump</code></a>&gt;=0.3.1 ( <code>cargo install itm</code>)。测试版本：0.3.1。</p>
</li>
<li><p>OpenOCD &gt;=0.8。测试版本：v0.9.0 和 v0.10.0</p>
</li>
<li><p><code>arm-none-eabi-gdb</code>. 强烈建议使用 7.12 或更高版本。测试版本：7.10、7.11、7.12 和 8.1</p>
</li>
<li><p><a href="https://github.com/rust-embedded/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a>. 0.1.4 或更新版本。</p>
</li>
<li><p><code>minicom</code>在 Linux 和 macOS 上。测试版本：2.7。读者报告这<code>picocom</code>也有效，但我们将<code>minicom</code>在本文中使用。</p>
</li>
<li><p><code>PuTTY</code> 在 Windows 上。</p>
</li>
</ul>
<p>如果你的电脑有蓝牙功能并且你有蓝牙模块，你可以另外安装这些工具来玩蓝牙模块。所有这些都是可选的：</p>
<ul>
<li>Linux，仅当您没有像 Blueman 这样的蓝牙管理器应用程序时。<ul>
<li><code>bluez</code></li>
<li><code>hcitool</code></li>
<li><code>rfcomm</code></li>
<li><code>rfkill</code></li>
</ul>
</li>
</ul>
<p>macOS / OSX / Windows 用户只需要其操作系统附带的默认蓝牙管理器。</p>
<p>接下来，按照与操作系统无关的安装说明安装一些工具：</p>
<h4 id="rustc-amp-cargo"><a href="#rustc-amp-cargo" class="headerlink" title="rustc &amp; cargo"></a><code>rustc</code> &amp; cargo</h4><p>按照<a href="https://rustup.rs/" target="_blank" rel="noopener">https://rustup.rs 上</a>的说明安装 rustup 。</p>
<p>如果您已经安装了 rustup，请仔细检查您是否在稳定频道上并且您的稳定工具链是最新的。<code>rustc -V</code>应该返回一个比下面显示的日期新的日期：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc -V
rustc 1.31.0 (abe02cefd 2018-12-04)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="itmdump"><a href="#itmdump" class="headerlink" title="itmdump"></a><code>itmdump</code></h4><pre class="line-numbers language-console"><code class="language-console">cargo install itm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>验证版本 &gt;=0.3.1</p>
<pre><code>$ itmdump -V
itmdump 0.3.1</code></pre><h4 id="cargo-binutils-2"><a href="#cargo-binutils-2" class="headerlink" title="cargo-binutils"></a><code>cargo-binutils</code></h4><p>安装 <code>llvm-tools-preview</code></p>
<pre class="line-numbers language-console"><code class="language-console">rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装 <code>cargo-binutils</code></p>
<pre><code>cargo install cargo-binutils</code></pre><p><strong>验证工具是否已安装</strong></p>
<p>在终端运行以下命令</p>
<pre class="line-numbers language-console"><code class="language-console">cargo new test-size
cd test-size
cargo run
cargo size -- -version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果应该是这样的：</p>
<pre><code>~
$ cargo new test-size
     Created binary (application) `test-size` package

~
$ cd test-size

~/test-size (main)
$ cargo run
   Compiling test-size v0.1.0 (~/test-size)
    Finished dev [unoptimized + debuginfo] target(s) in 0.26s
     Running `target/debug/test-size`
Hello, world!

~/test-size (main)
$ cargo size -- -version
    Finished dev [unoptimized + debuginfo] target(s) in 0.00s
LLVM (http://llvm.org/):
  LLVM version 11.0.0-rust-1.50.0-stable
  Optimized build.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: znver2</code></pre><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><p>Here are the installation commands for a few Linux distributions.</p>
<h3 id="REQUIRED-packages"><a href="#REQUIRED-packages" class="headerlink" title="REQUIRED packages"></a>REQUIRED packages</h3><h4 id="Ubuntu-18-04-or-newer-Debian-stretch-or-newer"><a href="#Ubuntu-18-04-or-newer-Debian-stretch-or-newer" class="headerlink" title="Ubuntu 18.04 or newer / Debian stretch or newer"></a>Ubuntu 18.04 or newer / Debian stretch or newer</h4><blockquote>
<p><strong>NOTE</strong> <code>gdb-multiarch</code> is the GDB command you’ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  gdb-multiarch \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-14-04-and-16-04"><a href="#Ubuntu-14-04-and-16-04" class="headerlink" title="Ubuntu 14.04 and 16.04"></a>Ubuntu 14.04 and 16.04</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command you’ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  gdb-arm-none-eabi \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Fedora-23-or-newer"><a href="#Fedora-23-or-newer" class="headerlink" title="Fedora 23 or newer"></a>Fedora 23 or newer</h4><pre class="line-numbers language-console"><code class="language-console">sudo dnf install \
  minicom \
  openocd \
  gdb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Arch-Linux"><a href="#Arch-Linux" class="headerlink" title="Arch Linux"></a>Arch Linux</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command you’ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">sudo pacman -S \
  arm-none-eabi-gdb \
  minicom \
  openocd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Other-distros"><a href="#Other-distros" class="headerlink" title="Other distros"></a>Other distros</h4><blockquote>
<p><strong>NOTE</strong> <code>arm-none-eabi-gdb</code> is the GDB command you’ll use to debug your ARM Cortex-M programs</p>
</blockquote>
<p>For distros that don’t have packages for <a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">ARM’s pre-built toolchain</a>, download the “Linux 64-bit” file and put its <code>bin</code> directory on your path. Here’s one way to do it:</p>
<pre class="line-numbers language-console"><code class="language-console">mkdir -p ~/local && cd ~/local
tar xjf /path/to/downloaded/file/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux.tar.bz2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Then, use your editor of choice to append to your <code>PATH</code> in the appropriate shell init file (e.g. <code>~/.zshrc</code> or <code>~/.bashrc</code>):</p>
<pre><code>PATH=$PATH:$HOME/local/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux/bin</code></pre><h3 id="Optional-packages"><a href="#Optional-packages" class="headerlink" title="Optional packages"></a>Optional packages</h3><h4 id="Ubuntu-Debian"><a href="#Ubuntu-Debian" class="headerlink" title="Ubuntu / Debian"></a>Ubuntu / Debian</h4><pre class="line-numbers language-console"><code class="language-console">sudo apt-get install \
  bluez \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h4><pre class="line-numbers language-console"><code class="language-console">sudo dnf install \
  bluez \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Arch-Linux-1"><a href="#Arch-Linux-1" class="headerlink" title="Arch Linux"></a>Arch Linux</h4><pre class="line-numbers language-console"><code class="language-console">sudo pacman -S \
  bluez \
  bluez-utils \
  rfkill<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="udev-rules"><a href="#udev-rules" class="headerlink" title="udev rules"></a>udev rules</h4><p>These rules let you use USB devices like the F3 and the Serial module without root privilege, i.e. <code>sudo</code>.</p>
<p>Create <code>99-openocd.rules</code> in <code>/etc/udev/rules.d</code> using the <code>idVendor</code> and <code>idProduct</code> from the <code>lsusb</code> output.</p>
<p>For example, connect the STM32F3DISCOVERY to your computer using a USB cable. Be sure to connect the cable to the “USB ST-LINK” port, the USB port in the center of the edge of the board.</p>
<p>Execute <code>lsusb</code>:</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb | grep ST-LINK<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>It should result in something like:</p>
<pre><code>$ lsusb | grep ST-LINK
Bus 003 Device 003: ID 0483:374b STMicroelectronics ST-LINK/V2.1</code></pre><p>So the <code>idVendor</code> is <code>0483</code> and <code>idProduct</code> is <code>374b</code>.</p>
<h4 id="Create-etc-udev-rules-d-99-openocd-rules"><a href="#Create-etc-udev-rules-d-99-openocd-rules" class="headerlink" title="Create /etc/udev/rules.d/99-openocd.rules:"></a>Create <code>/etc/udev/rules.d/99-openocd.rules</code>:</h4><pre class="line-numbers language-console"><code class="language-console">sudo vi /etc/udev/rules.d/99-openocd.rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>With the contents:</p>
<pre class="line-numbers language-text"><code class="language-text"># STM32F3DISCOVERY - ST-LINK/V2.1
ATTRS{idVendor}=="0483", ATTRS{idProduct}=="374b", MODE:="0666"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>For older devices with OPTIONAL USB &lt;-&gt; FT232 based Serial Module</strong></p>
<p>Create <code>/etc/udev/rules.d/99-ftdi.rules</code>:</p>
<pre class="line-numbers language-console"><code class="language-console">sudo vi /etc/udev/rules.d/99-openocd.rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>With the contents:</p>
<pre class="line-numbers language-text"><code class="language-text"># FT232 - USB <-> Serial Converter
ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", MODE:="0666"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Reload-the-udev-rules-with"><a href="#Reload-the-udev-rules-with" class="headerlink" title="Reload the udev rules with:"></a>Reload the udev rules with:</h4><pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>If you had any board plugged to your computer, unplug them and then plug them in again.</p>
<h2 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h2><h3 id="arm-none-eabi-gdb-1"><a href="#arm-none-eabi-gdb-1" class="headerlink" title="arm-none-eabi-gdb"></a><code>arm-none-eabi-gdb</code></h3><p>ARM provides <code>.exe</code> installers for Windows. Grab one from <a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">here</a>, and follow the instructions. Just before the installation process finishes tick/select the “Add path to environment variable” option. Then verify that the tools are in your <code>%PATH%</code>:</p>
<p>Verify gcc is installed:</p>
<pre class="line-numbers language-console"><code class="language-console">arm-none-eabi-gcc -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The results should be something like:</p>
<pre><code>(..)
$ arm-none-eabi-gcc -v
gcc version 5.4.1 20160919 (release) (..)</code></pre><h3 id="OpenOCD-1"><a href="#OpenOCD-1" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><p>There’s no official binary release of OpenOCD for Windows but there are unofficial releases available <a href="https://github.com/xpack-dev-tools/openocd-xpack/releases" target="_blank" rel="noopener">here</a>. Grab the 0.10.x zipfile and extract it somewhere in your drive (I recommend <code>C:\OpenOCD</code> but with the drive letter that makes sense to you) then update your <code>%PATH%</code> environment variable to include the following path: <code>C:\OpenOCD\bin</code> (or the path that you used before).</p>
<p>Verify OpenOCD is installed and in your <code>%PATH%</code> with:</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The results should be something like:</p>
<pre class="line-numbers language-console"><code class="language-console">$ openocd -v
Open On-Chip Debugger 0.10.0
(..)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="PuTTY"><a href="#PuTTY" class="headerlink" title="PuTTY"></a>PuTTY</h3><p>Download the latest <code>putty.exe</code> from <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html" target="_blank" rel="noopener">this site</a> and place it somewhere in your <code>%PATH%</code>.</p>
<h3 id="ST-LINK-USB-driver"><a href="#ST-LINK-USB-driver" class="headerlink" title="ST-LINK USB driver"></a>ST-LINK USB driver</h3><p>You’ll also need to install <a href="http://www.st.com/en/embedded-software/stsw-link009.html" target="_blank" rel="noopener">this USB driver</a> or OpenOCD won’t work. Follow the installer instructions and make sure you install the right (32-bit or 64-bit) version of the driver.</p>
<h2 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h2><p>All the tools can be install using <a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a>:</p>
<p>Install ArmMbed</p>
<pre class="line-numbers language-console"><code class="language-console">brew tap ArmMbed/homebrew-formulae<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Install the ARM GCC toolchain</p>
<pre class="line-numbers language-console"><code class="language-console">brew install arm-none-eabi-gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Install minicom and OpenOCD</p>
<pre class="line-numbers language-console"><code class="language-console">brew install minicom openocd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Verify-the-installation"><a href="#Verify-the-installation" class="headerlink" title="Verify the installation"></a>Verify the installation</h2><p>Let’s verify that all the tools were installed correctly.</p>
<h3 id="Linux-only"><a href="#Linux-only" class="headerlink" title="Linux only"></a>Linux only</h3><h4 id="Verify-permissions"><a href="#Verify-permissions" class="headerlink" title="Verify permissions"></a>Verify permissions</h4><p>Connect the STM32F3DISCOVERY to your computer using an USB cable. Be sure to connect the cable to the “USB ST-LINK” port, the USB port in the center of the edge of the board.</p>
<p>The STM32F3DISCOVERY should now appear as a USB device (file) in <code>/dev/bus/usb</code>. Let’s find out how it got enumerated:</p>
<pre class="line-numbers language-console"><code class="language-console">lsusb | grep -i stm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>This should result in:</p>
<pre class="line-numbers language-console"><code class="language-console">$ lsusb | grep -i stm
Bus 003 Device 004: ID 0483:374b STMicroelectronics ST-LINK/V2.1
$ # ^^^        ^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>In my case, the STM32F3DISCOVERY got connected to the bus #3 and got enumerated as the device #4. This means the file <code>/dev/bus/usb/003/004</code> <em>is</em> the STM32F3DISCOVERY. Let’s check its permissions:</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -la /dev/bus/usb/003/004
crw-rw-rw-+ 1 root root 189, 259 Feb 28 13:32 /dev/bus/usb/003/00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>The permissions should be <code>crw-rw-rw-</code>. If it’s not … then check your <a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">udev rules</a> and try re-loading them with:</p>
<pre class="line-numbers language-console"><code class="language-console">sudo udevadm control --reload-rules<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>For older devices with OPTIONAL USB &lt;-&gt; FT232 based Serial Module</strong></p>
<p>Unplug the STM32F3DISCOVERY and plug the Serial module. Now, figure out what’s its associated file:</p>
<pre class="line-numbers language-console"><code class="language-console">$ lsusb | grep -i ft232
Bus 003 Device 005: ID 0403:6001 Future Technology Devices International, Ltd FT232 Serial (UART) IC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>In my case, it’s the <code>/dev/bus/usb/003/005</code>. Now, check its permissions:</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -l /dev/bus/usb/003/005
crw-rw-rw- 1 root root 189, 21 Sep 13 00:00 /dev/bus/usb/003/005<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>As before, the permissions should be <code>crw-rw-rw-</code>.</p>
<h3 id="Verify-OpenOCD-connection"><a href="#Verify-OpenOCD-connection" class="headerlink" title="Verify OpenOCD connection"></a>Verify OpenOCD connection</h3><p>Connect the STM32F3DISCOVERY using the USB cable to the USB port in the center of edge of the board, the one that’s labeled “USB ST-LINK”.</p>
<p>Two <em>red</em> LEDs should turn on right after connecting the USB cable to the board.</p>
<blockquote>
<p><strong>IMPORTANT</strong> There is more than one hardware revision of the STM32F3DISCOVERY board. For older revisions, you’ll need to change the “interface” argument to <code>-f interface/stlink-v2.cfg</code> (note: no <code>-1</code> at the end). Alternatively, older revisions can use <code>-f board/stm32f3discovery.cfg</code> instead of <code>-f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg</code>.</p>
</blockquote>
<blockquote>
<p><strong>NOTE</strong> OpenOCD v0.11.0 has deprecated <code>interface/stlink-v2.cfg</code> in favor of <code>interface/stlink.cfg</code> which supports ST-LINK/V1, ST-LINK/V2, ST-LINK/V2-1, and ST-LINK/V3.</p>
</blockquote>
<h4 id="Nix"><a href="#Nix" class="headerlink" title="*Nix"></a>*Nix</h4><blockquote>
<p><strong>FYI:</strong> The <code>interface</code> directory is typically located in <code>/usr/share/openocd/scripts/</code>, which is the default location OpenOCD expects these files. If you’ve installed them somewhere else use the <code>-s /path/to/scripts/</code> option to specify your install directory.</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>or</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f interface/stlink.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Windows-2"><a href="#Windows-2" class="headerlink" title="Windows"></a>Windows</h4><p>Below the references to <code>C:\OpenOCD</code> is the directory where OpenOCD is installed.</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -s C:\OpenOCD\share\scripts -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>NOTE</strong> cygwin users have reported problems with the -s flag. If you run into that problem you can add <code>C:\OpenOCD\share\scripts\</code> directory to the parameters.</p>
</blockquote>
<p>cygwin users:</p>
<pre class="line-numbers language-console"><code class="language-console">openocd -f C:\OpenOCD\share\scripts\interface\stlink-v2-1.cfg -f C:\OpenOCD\share\scripts\target\stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="All"><a href="#All" class="headerlink" title="All"></a>All</h4><p>OpenOCD is a service which forwards debug information from the ITM channel to a file, <code>itm.txt</code>, as such it runs forever and does <strong>not</strong> return to the terminal prompt.</p>
<p>The initial output of OpenOCD is something like:</p>
<pre class="line-numbers language-console"><code class="language-console">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v27 API v2 SWIM v15 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.915608
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>(If you don’t … then check the <a href="https://docs.rust-embedded.org/discovery/appendix/1-general-troubleshooting/index.html" target="_blank" rel="noopener">general troubleshooting</a> instructions.)</p>
<p>Also, one of the red LEDs, the one closest to the USB port, should start oscillating between red light and green light.</p>
<p>That’s it! It works. You can now use <code>Ctrl-c</code> to stop OpenOCD or close/kill the terminal.</p>
<h1 id="Meet-your-hardware"><a href="#Meet-your-hardware" class="headerlink" title="Meet your hardware"></a>Meet your hardware</h1><h2 id="STM32F3DISCOVERY（“F3”）-1"><a href="#STM32F3DISCOVERY（“F3”）-1" class="headerlink" title="STM32F3DISCOVERY（“F3”）"></a>STM32F3DISCOVERY（“F3”）</h2><p><img src="/images/loading.gif" data-original="../images/language/f3-163136334180811.jpg" alt=""></p>
<p>我们将在整本书中将此板称为“F3”。以下是板上的许多组件中的一些：</p>
<ul>
<li>一个<a href="https://en.wikipedia.org/wiki/Microcontroller" target="_blank" rel="noopener">微控制器</a>。</li>
<li>许多 LED，包括以“指南针”形式排列的八个 LED。</li>
<li>两个按钮。</li>
<li>两个 USB 端口。</li>
<li>一个<a href="https://en.wikipedia.org/wiki/Accelerometer" target="_blank" rel="noopener">加速度计</a>。</li>
<li>一个<a href="https://en.wikipedia.org/wiki/Magnetometer" target="_blank" rel="noopener">磁力计</a>。</li>
<li>一个<a href="https://en.wikipedia.org/wiki/Gyroscope" target="_blank" rel="noopener">陀螺仪</a>。</li>
</ul>
<p>在这些组件中，最重要的是微控制器（有时缩写为“MCU”代表“微控制器单元”），它是位于电路板中心的黑色大方块。MCU 运行您的代码。您有时可能会读到“对电路板进行编程”，而实际上我们所做的是对安装在电路板上的 MCU 进行编程。</p>
<h2 id="STM32F303VCT6（“STM32F3”）"><a href="#STM32F303VCT6（“STM32F3”）" class="headerlink" title="STM32F303VCT6（“STM32F3”）"></a>STM32F303VCT6（“STM32F3”）</h2><p>由于 MCU 如此重要，让我们仔细看看坐在我们板上的那个。</p>
<p>我们的 MCU 被 100 个微小的金属<strong>引脚</strong>包围着。这些引脚连接到 <strong>迹线</strong>，这些小“道路”充当将电路板上的组件连接在一起的电线。MCU 可以动态改变引脚的电气特性。这类似于改变电流流经电路的电灯开关。通过启用或禁用流过特定引脚的电流，可以打开和关闭连接到该引脚（通过走线）的 LED。</p>
<p>每个制造商使用不同的零件编号方案，但许多制造商允许您通过查看零件编号来确定有关组件的信息。查看我们 MCU 的部件号 ( <code>STM32F303VCT6</code>)，<code>ST</code>前面的 向我们暗示这是由<a href="https://st.com/" target="_blank" rel="noopener">ST Microelectronics</a>制造的部件。通过搜索<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32-mainstream-mcus.html" target="_blank" rel="noopener">ST 的营销材料，</a>我们还可以了解到以下内容：</p>
<ul>
<li>的<code>M32</code>表示，这是一个基于ARM®的32位微控制器。</li>
<li>该<code>F3</code>代表的MCU是ST的“STM32F3系列”。这是一系列基于 Cortex®-M4 处理器设计的 MCU。</li>
<li>部件号的其余部分详细介绍了额外功能和 RAM 大小等内容，目前我们不太关心这些。</li>
</ul>
<blockquote>
<h3 id="Arm-Cortex-M4"><a href="#Arm-Cortex-M4" class="headerlink" title="Arm? Cortex-M4?"></a>Arm? Cortex-M4?</h3><p>如果我们的芯片是 ST 制造的，那么 Arm 是谁？如果我们的芯片是 STM32F3，那么 Cortex-M4 是什么？</p>
<p>您可能会惊讶地发现，虽然“基于 Arm”的芯片非常受欢迎，但“Arm”商标背后的公司 ( <a href="https://www.arm.com/" target="_blank" rel="noopener">Arm Holdings</a> ) 实际上并不制造用于购买的芯片。相反，他们的主要商业模式只是<em>设计</em>芯片的一部分。然后，他们会将这些设计授权给制造商，制造商又会以物理硬件的形式实施这些设计（也许通过他们自己的一些调整）然后可以出售。ARM 在这里的战略与英特尔等公司不同，后者既设计<em>又</em>制造芯片。</p>
<p>Arm 许可了一系列不同的设计。他们的“Cortex-M”系列设计主要用作微控制器的核心。例如，Cortex-M0 专为低成本和低功耗而设计。Cortex-M7 成本更高，但具有更多功能和性能。我们的 STM32F3 的核心是基于 Cortex-M4，它处于中间：比 Cortex-M0 的功能和性能更多，但比 Cortex-M7 便宜。</p>
<p>幸运的是，您不需要为了本书而对不同类型的处理器或 Cortex 设计了解太多。但是，希望您现在对设备的术语有了更多了解。当您专门使用 STM32F3 时，您可能会发现自己正在阅读文档并使用基于 Cortex-M 的芯片的工具，因为 STM32F3 基于 Cortex-M 设计。</p>
</blockquote>
<h2 id="串行模块"><a href="#串行模块" class="headerlink" title="串行模块"></a>串行模块</h2><p><img src="/images/loading.gif" data-original="../images/language/serial-163136334180813.jpg" alt=""></p>
<p>如果您有旧版本的发现板，您可以使用此模块在 F3 中的微控制器和您的计算机之间交换数据。该模块将使用 USB 电缆连接到您的计算机。这个时候我就不多说了。</p>
<p>如果您有较新版本的电路板，则不需要此模块。ST-LINK 将兼作 USB&lt;-&gt; 串行转换器，通过 PC4 和 PC5 引脚连接到微控制器 USART1。</p>
<h2 id="蓝牙模块"><a href="#蓝牙模块" class="headerlink" title="蓝牙模块"></a>蓝牙模块</h2><p><img src="/images/loading.gif" data-original="../images/language/bluetooth-163136334180915.jpg" alt=""></p>
<p>该模块与串行模块的用途完全相同，但它通过蓝牙而不是 USB 发送数据。</p>
<h1 id="LED-roulette（轮盘）"><a href="#LED-roulette（轮盘）" class="headerlink" title="LED roulette（轮盘）"></a>LED roulette（轮盘）</h1><p>好的，让我们从构建以下应用程序开始：</p>
<p><img src="/images/loading.gif" data-original="../images/language/0k1r2Lc.gif" alt=""></p>
<p>我将给你一个高级 API 来实现这个应用程序，但别担心我们稍后会做低级的东西。本章的主要目标是熟悉<em>刷机</em>和调试过程。</p>
<p>在本文中，我们将使用<a href="https://github.com/rust-embedded/discovery" target="_blank" rel="noopener">发现</a>存储库中的入门代码。确保您始终拥有最新版本的 master 分支，因为该网站会跟踪该分支。</p>
<p>起始代码位于该<code>src</code>存储库的目录中。在该目录中，还有更多以本书每一章命名的目录。这些目录中的大多数是入门 Cargo 项目。</p>
<p>现在，跳转到<code>src/05-led-roulette</code>目录。检查<code>src/main.rs</code>文件：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// infinite loop; just so we don't leave this stack frame</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>微控制器程序在两个方面不同于标准程序：<code>#![no_std]</code>和 <code>#![no_main]</code>。</p>
<p>该<code>no_std</code>属性表示该程序不会使用<code>std</code>crate，它假定一个底层操作系统；该程序将改为使用<code>core</code>crate，它的一个子集<code>std</code>可以在裸机系统上运行（即，没有像文件和套接字这样的操作系统抽象的系统）。</p>
<p>该<code>no_main</code>属性表示该程序不会使用标准<code>main</code>接口，该接口是为接收参数的命令行应用程序量身定制的。<code>main</code>我们将使用crate 中的<code>entry</code>属性<a href="https://crates.io/crates/cortex-m-rt" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>来定义自定义入口点，而不是标准。在这个程序中，我们将入口点命名为“main”，但也可以使用任何其他名称。入口点函数必须有签名<code>fn() -&gt; !</code>；这种类型表示函数不能返回——这意味着程序永远不会终止。</p>
<p>如果您细心观察，您还会注意到<code>.cargo</code>Cargo 项目中也有一个目录。该目录包含一个 Cargo 配置文件 ( <code>.cargo/config</code>)，它调整链接过程以根据目标设备的要求定制程序的内存布局。这种修改后的链接过程是<code>cortex-m-rt</code>板条箱的要求。您还将<code>.cargo/config</code>在以后的部分中进行进一步的调整，以使构建和调试更容易。</p>
<p>好的，让我们从构建这个程序开始。</p>
<h2 id="Build-it"><a href="#Build-it" class="headerlink" title="Build it"></a>Build it</h2><p>第一步是构建我们的“二进制”板条箱。因为微控制器的架构与您的计算机不同，所以我们必须进行交叉编译。在 Rust 中交叉编译就像<code>--target</code>向<code>rustc</code>或 Cargo传递一个额外的标志一样简单。复杂的部分是找出该标志的参数：目标的<em>名称</em>。</p>
<p>F3 中的微控制器中有一个 Cortex-M4F 处理器。<code>rustc</code>知道如何交叉编译到 Cortex-M 架构，并提供 4 个不同的目标，涵盖该架构中的不同处理器系列：</p>
<ul>
<li><code>thumbv6m-none-eabi</code>, 对于 Cortex-M0 和 Cortex-M1 处理器</li>
<li><code>thumbv7m-none-eabi</code>, 对于 Cortex-M3 处理器</li>
<li><code>thumbv7em-none-eabi</code>, 适用于 Cortex-M4 和 Cortex-M7 处理器</li>
<li><code>thumbv7em-none-eabihf</code>, 对于 Cortex-M4 <strong>F</strong>和 Cortex-M7 <strong>F</strong>处理器</li>
</ul>
<p>对于 F3，我们将使用<code>thumbv7em-none-eabihf</code>目标。在交叉编译之前，您必须为您的目标下载标准库的预编译版本（实际上是它的简化版本）。这是使用<code>rustup</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>您只需要执行上述步骤一次；每当您更新工具链时，<code>rustup</code>都会重新安装新的标准库（<code>rust-std</code>组件）。</p>
<p>随着<code>rust-std</code>到位组件使用货运您现在可以交叉编译程序。</p>
<blockquote>
<p><strong>注意</strong>确保您在<code>src/05-led-roulette</code>目录中并运行<code>cargo build</code>以下命令以创建可执行文件：</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">cargo build --target thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在您的控制台上，您应该看到如下内容：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build --target thumbv7em-none-eabihf
   Compiling typenum v1.12.0
   Compiling semver-parser v0.7.0
   Compiling version_check v0.9.2
   Compiling nb v1.0.0
   Compiling void v1.0.2
   Compiling autocfg v1.0.1
   Compiling cortex-m v0.7.1
   Compiling proc-macro2 v1.0.24
   Compiling vcell v0.1.3
   Compiling unicode-xid v0.2.1
   Compiling stable_deref_trait v1.2.0
   Compiling syn v1.0.60
   Compiling bitfield v0.13.2
   Compiling cortex-m v0.6.7
   Compiling cortex-m-rt v0.6.13
   Compiling r0 v0.2.2
   Compiling stm32-usbd v0.5.1
   Compiling stm32f3 v0.12.1
   Compiling usb-device v0.2.7
   Compiling cfg-if v1.0.0
   Compiling paste v1.0.4
   Compiling stm32f3-discovery v0.6.0
   Compiling embedded-dma v0.1.2
   Compiling volatile-register v0.2.0
   Compiling nb v0.1.3
   Compiling embedded-hal v0.2.4
   Compiling semver v0.9.0
   Compiling generic-array v0.14.4
   Compiling switch-hal v0.3.2
   Compiling num-traits v0.2.14
   Compiling num-integer v0.1.44
   Compiling rustc_version v0.2.3
   Compiling bare-metal v0.2.5
   Compiling cast v0.2.3
   Compiling quote v1.0.9
   Compiling generic-array v0.13.2
   Compiling generic-array v0.12.3
   Compiling generic-array v0.11.1
   Compiling panic-itm v0.4.2
   Compiling lsm303dlhc v0.2.0
   Compiling as-slice v0.1.4
   Compiling micromath v1.1.0
   Compiling accelerometer v0.12.0
   Compiling chrono v0.4.19
   Compiling aligned v0.3.4
   Compiling rtcc v0.2.0
   Compiling cortex-m-rt-macros v0.1.8
   Compiling stm32f3xx-hal v0.6.1
   Compiling aux5 v0.2.0 (~/embedded-discovery/src/05-led-roulette/auxiliary)
   Compiling led-roulette v0.2.0 (~/embedded-discovery/src/05-led-roulette)
    Finished dev [unoptimized + debuginfo] target(s) in 17.91s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>一定要在<em>没有</em>优化的<em>情况下</em>编译这个 crate 。上面提供的 Cargo.toml 文件和构建命令将确保优化关闭。</p>
</blockquote>
<p>好的，现在我们已经生成了一个可执行文件。这个可执行文件不会使任何 LED 闪烁，它只是我们将在本章后面构建的一个简化版本。作为完整性检查，让我们验证生成的可执行文件实际上是 ARM 二进制文件：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo readobj --target thumbv7em-none-eabihf --bin led-roulette -- --file-header<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在<code>cargo readobj ..</code>上述相当于 <code>readelf -h target/thumbv7em-none-eabihf/debug/led-roulette</code> 而且应该产生类似的东西：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo readobj --target thumbv7em-none-eabihf --bin led-roulette -- --file-header
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x8000195
  Start of program headers:          52 (bytes into file)
  Start of section headers:          818328 (bytes into file)
  Flags:                             0x5000400
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         4
  Size of section headers:           40 (bytes)
  Number of section headers:         22
  Section header string table index: 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来，我们将把程序烧写到我们的微控制器中。</p>
<h2 id="Flash-it"><a href="#Flash-it" class="headerlink" title="Flash it"></a>Flash it</h2><p>闪存是将我们的程序移动到微控制器（持久性）内存中的过程。一旦刷入，微控制器每次上电都会执行刷入的程序。</p>
<p>在这种情况下，我们的<code>led-roulette</code>程序将是微控制器存储器中的<em>唯一</em>程序。我的意思是微控制器上没有其他东西在运行：没有操作系统，没有“守护进程”，什么都没有。<code>led-roulette</code>可以完全控制设备。</p>
<p>进入实际闪烁。我们需要做的第一件事是启动 OpenOCD。我们在上一节中这样做了，但这次我们将在临时目录中运行命令（<code>/tmp</code>在 *nix 上； <code>%TEMP%</code>在 Windows 上）。</p>
<p>确保 F3 已连接到您的计算机并在<strong>新终端中</strong>运行以下命令。</p>
<h3 id="对于-nix-和-MacOS："><a href="#对于-nix-和-MacOS：" class="headerlink" title="对于 *nix 和 MacOS："></a>对于 *nix 和 MacOS：</h3><pre class="line-numbers language-console"><code class="language-console">cd /tmp
openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="对于-Windows注意：替换C-实际的-OpenOCD-路径："><a href="#对于-Windows注意：替换C-实际的-OpenOCD-路径：" class="headerlink" title="对于 Windows注意：替换C:实际的 OpenOCD 路径："></a>对于 Windows<strong>注意</strong>：替换<code>C:</code>实际的 OpenOCD 路径：</h3><pre><code>cd %TEMP%
openocd -s C:\share\scripts -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg</code></pre><blockquote>
<p><strong>注意</strong>电路板的较旧版本需要将稍微不同的参数传递给 <code>openocd</code>。</p>
</blockquote>
<p>程序会阻塞；让那个终端保持打开状态。</p>
<p>现在是解释该<code>openocd</code>命令实际执行的操作的好时机。</p>
<p>我提到 STM32F3DISCOVERY（又名 F3）实际上有两个微控制器。其中之一用作程序员/调试器。用作编程器的电路板部分称为 ST-LINK（意法半导体决定这样称呼它）。此 ST-LINK 使用串行线调试 (SWD) 接口连接到目标微控制器（此接口是 ARM 标准，因此在处理其他基于 Cortex-M 的微控制器时会遇到它）。该 SWD 接口可用于闪存和调试微控制器。ST-LINK 连接到“USB ST-LINK”端口，当您将 F3 连接到计算机时，它会显示为 USB 设备。</p>
<p><img src="/images/loading.gif" data-original="../images/language/st-link.png" alt=""></p>
<p>至于 OpenOCD，它是一种提供一些服务的软件，例如在 USB 设备上提供一些服务，例如公开 SWD 或 JTAG 等调试协议的<em>GDB 服务器</em>。</p>
<p>关于实际命令：<code>.cfg</code>我们使用的那些文件指示 OpenOCD 查找 ST-LINK USB 设备 ( <code>interface/stlink-v2-1.cfg</code>) 并期望 STM32F3XX 微控制器 ( <code>target/stm32f3x.cfg</code>) 连接到 ST-LINK。</p>
<p>OpenOCD 输出如下所示：</p>
<pre class="line-numbers language-console"><code class="language-console">$ openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
none separate
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v37 API v2 SWIM v26 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.888183
Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>“6 个断点，4 个观察点”部分表示处理器可用的调试功能。</p>
<p>保持该<code>openocd</code>进程运行，并在前一个终端或新终端中 <strong>确保您位于项目<code>src/05-led-roulette/</code>目录中</strong>。</p>
<p>我提到 OpenOCD 提供了一个 GDB 服务器，所以让我们现在连接到它：</p>
<h3 id="执行-GDB"><a href="#执行-GDB" class="headerlink" title="执行 GDB"></a>执行 GDB</h3><p>首先，我们需要确定<code>gdb</code>您的哪个版本能够调试 ARM 二进制文件。</p>
<p>这可以是以下任一命令，请尝试每一个：</p>
<pre class="line-numbers language-console"><code class="language-console">arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
gdb-multiarch -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="失败案例"><a href="#失败案例" class="headerlink" title="失败案例"></a><strong>失败案例</strong></h4><p>如果有<code>warning</code>或<code>error</code>在该<code>Remote debugging using :3333</code>行之后，您可以检测到失败案例：</p>
<pre><code>$ gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
warning: Architecture rejected target-supplied description
Truncated register 16 in remote 'g' packet
(gdb)</code></pre><h4 id="成功案例"><a href="#成功案例" class="headerlink" title="成功案例"></a><strong>成功案例</strong></h4><p>成功案例一：</p>
<pre><code>$ arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
cortex_m_rt::Reset () at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:497
497     pub unsafe extern "C" fn Reset() -&gt; ! {
(gdb)</code></pre><p>成功案例2：</p>
<pre><code>~/embedded-discovery/src/05-led-roulette (master)
$ arm-none-eabi-gdb -q -ex "target remote :3333" target/thumbv7em-none-eabihf/debug/led-roulette
Reading symbols from target/thumbv7em-none-eabihf/debug/led-roulette...
Remote debugging using :3333
0x00000000 in ?? ()
(gdb)</code></pre><p>在失败和成功的情况下，您都应该在<strong>OpenOCD 终端中</strong>看到新的输出，如下所示：</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : stm32f3x.cpu: hardware has 6 breakpoints, 4 watchpoints
<span class="token inserted">+Info : accepting 'gdb' connection on tcp/3333</span>
<span class="token inserted">+Info : device id = 0x10036422</span>
<span class="token inserted">+Info : flash size = 256kbytes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果您收到类似的错误<code>undefined debug reason 7 - target needs reset</code>，您可以尝试<code>monitor reset halt</code>按照<a href="https://stackoverflow.com/questions/38994596/reason-7-target-needs-reset-unreliable-debugging-setup" target="_blank" rel="noopener">此处</a>所述运行。</p>
</blockquote>
<p>默认情况下，OpenOCD 的 GDB 服务器侦听 TCP 端口 3333（本地主机）。此命令正在连接到该端口。</p>
<h3 id="更新-cargo-config-toml"><a href="#更新-cargo-config-toml" class="headerlink" title="更新 ../.cargo/config.toml"></a>更新 ../.cargo/config.toml</h3><p>既然您已成功确定需要使用哪个调试器，我们需要进行更改，<code>../.cargo/config.toml</code>以便<code>cargo run</code>命令成功。</p>
<blockquote>
<p><strong>NOTE</strong> <code>cargo</code>是 Rust 包管理器，你可以<a href="https://doc.rust-lang.org/cargo/" target="_blank" rel="noopener">在这里</a>阅读它 。</p>
</blockquote>
<p>回到终端提示符并查看<code>../.cargo/config.toml</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">~/embedded-discovery/src/05-led-roulette
$ cat ../.cargo/config.toml
[target.thumbv7em-none-eabihf]
runner = "arm-none-eabi-gdb -q"
# runner = "gdb-multiarch -q"
# runner = "gdb -q"
rustflags = [
  "-C", "link-arg=-Tlink.x",
]

[build]
target = "thumbv7em-none-eabihf"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用您喜欢的编辑器进行编辑，<code>../.cargo/config.toml</code>以便该 <code>runner</code>行包含该调试器的正确名称：</p>
<pre class="line-numbers language-console"><code class="language-console">nano ../.cargo/config.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>例如，如果您的调试器<code>gdb-multiarch</code>在编辑之后<code>git diff</code>应该是：</p>
<pre class="line-numbers language-diff"><code class="language-diff">$ git diff ../.cargo/config.toml
diff --git a/src/.cargo/config.toml b/src/.cargo/config.toml
index ddff17f..8512cfe 100644
<span class="token coord">--- a/src/.cargo/config.toml</span>
<span class="token coord">+++ b/src/.cargo/config.toml</span>
<span class="token coord">@@ -1,6 +1,6 @@</span>
 [target.thumbv7em-none-eabihf]
<span class="token deleted">-runner = "arm-none-eabi-gdb -q"</span>
<span class="token deleted">-# runner = "gdb-multiarch -q"</span>
<span class="token inserted">+# runner = "arm-none-eabi-gdb -q"</span>
<span class="token inserted">+runner = "gdb-multiarch -q"</span>
 # runner = "gdb -q"
 rustflags = [
   "-C", "link-arg=-Tlink.x",<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在您已经<code>../.cargo/config.toml</code>设置好了，让我们使用<code>cargo run</code>启动调试会话来测试它。</p>
<blockquote>
<p><strong>注：</strong>该<code>--target thumbv7em-none-eabihf</code>定义哪些架构来构建和运行。在我们的<code>../.cargo/config.toml</code>文件中，我们 <code>target = "thumbv7em-none-eabihf"</code>实际上没有必要在<code>--target</code>此处指定我们这样做，只是为了让您知道可以使用命令行上的参数并且它们会覆盖<code>config.toml</code>文件中的参数。</p>
</blockquote>
<pre><code>cargo run --target thumbv7em-none-eabihf</code></pre><p>结果是：</p>
<pre><code>~/embedded-discovery/src/05-led-roulette
$ cargo run --target thumbv7em-none-eabihf
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...</code></pre><p>现在发出<code>target remote :3333</code>连接到 OpenOCD 服务器并连接到 F3 的命令：</p>
<pre><code>(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()</code></pre><p>太棒了，我们将来会修改<code>../.cargo/config.toml</code>。<strong>但是</strong>，由于此文件与所有章节共享，因此应考虑到这一点进行更改。如果您想要或我们需要进行仅与特定章节有关的更改，则创建<code>.cargo/config.toml</code>该章节目录的本地目录。</p>
<h3 id="烧录设备"><a href="#烧录设备" class="headerlink" title="烧录设备"></a>烧录设备</h3><p>假设您运行了 GDB，如果没有按照上一节中的建议启动它。</p>
<p>现在使用<code>load</code>命令 in<code>gdb</code>将程序实际刷入设备：</p>
<pre><code>(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x20ec lma 0x8000194
Loading section .rodata, size 0x514 lma 0x8002280
Start address 0x08000194, load size 10132
Transfer rate: 17 KB/sec, 3377 bytes/write.</code></pre><p>您还将在 OpenOCD 终端中看到新的输出，例如：</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : flash size = 256kbytes
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+adapter speed: 4000 kHz</span>
<span class="token inserted">+target halted due to breakpoint, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x61000000 pc: 0x2000003a msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们的程序已经加载完毕，让我们调试一下吧！</p>
<h2 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h2><p>我们已经在调试会话中，所以让我们调试我们的程序。</p>
<p>在<code>load</code>命令之后，我们的程序在它的<em>入口点</em>停止。这由 GDB 输出的“起始地址 0x8000XXX”部分指示。入口点是处理器/CPU 将首先执行的程序的一部分。</p>
<p>我提供给您的入门项目有一些在函数<em>之前</em>运行的额外代码<code>main</code>。此时，我们对“pre-main”部分不感兴趣，所以让我们直接跳到<code>main</code>函数的开头。我们将使用断点来做到这一点。<code>break main</code>在<code>(gdb)</code>提示符下发出：</p>
<blockquote>
<p><strong>注意</strong>对于这些 GDB 命令，我通常不会提供可复制的代码块，因为它们很短，而且自己输入它们会更快。此外，大多数可以缩短。例如<code>b</code>for<code>break</code>或<code>s</code>for <code>step</code>，请参阅<a href="https://users.ece.utexas.edu/~adnan/gdb-refcard.pdf" target="_blank" rel="noopener">GDB 快速参考</a> 以获取更多信息或使用 Google 查找您的其他人。此外，您可以通过键入前几个字母而不是一个选项卡来完成或两个选项卡来查看所有可能的命令来使用选项卡完成。</p>
<blockquote>
<p>最后，<code>help xxxx</code>其中 xxxx 是命令，将提供短名称和其他信息：</p>
<pre><code>(gdb) help s
step, s
Step program until it reaches a different source line.
Usage: step [N]
Argument N means step N times (or till program stops for another reason).</code></pre></blockquote>
</blockquote>
<pre><code>(gdb) break main
Breakpoint 1 at 0x80001f0: file src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.</code></pre><p>接下来发出<code>continue</code>命令：</p>
<pre><code>(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7
7       #[entry]</code></pre><p>断点可用于停止程序的正常流程。该<code>continue</code>命令将使程序自由运行，<em>直到</em>到达断点。在这种情况下，直到它到达<code>#[entry]</code> main 函数的蹦床和<code>break main</code>设置断点的位置。</p>
<blockquote>
<p><strong>请注意</strong>，GDB 输出显示“断点 1”。请记住，我们的处理器只能使用其中的六个断点，因此最好注意这些消息。</p>
</blockquote>
<p>好的。由于我们停在<code>#[entry]</code>并使用了，<code>disassemble /m</code>我们看到了进入的代码，这是一个蹦床到主。这意味着它会设置堆栈，然后<code>main</code>使用 ARM 分支和链接指令调用对该函数的子例程调用<code>bl</code>。</p>
<pre><code>(gdb) disassemble /m
Dump of assembler code for function main:
7       #[entry]
   0x080001ec &lt;+0&gt;:     push    {r7, lr}
   0x080001ee &lt;+2&gt;:     mov     r7, sp
=&gt; 0x080001f0 &lt;+4&gt;:     bl      0x80001f6 &lt;_ZN12led_roulette18__cortex_m_rt_main17he61ef18c060014a5E&gt;
   0x080001f4 &lt;+8&gt;:     udf     #254    ; 0xfe

End of assembler dump.</code></pre><p>接下来，我们需要发出一个<code>step</code>GDB 命令，该命令将通过语句步进到函数/过程中来推进程序语句。所以在第一个<code>step</code>命令之后，我们在里面<code>main</code>并定位在第一个可执行<code>rust</code>语句，第 10 行，但它 <strong>没有</strong>被执行：</p>
<pre><code>(gdb) step
led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:10
10          let x = 42;</code></pre><p>接下来，我们将发出第二个<code>step</code>，它执行第 10 行并在第 1 行停止<code>11 _y = x;</code>，同样<strong>不</strong>执行第 11 行。</p>
<blockquote>
<p><strong>注意</strong>我们可以在第二个<code>(gdb)</code>提示符下按 Enter 键，它会重新发出之前的语句<code>step</code>，但是为了在本教程中清晰起见，我们通常会重新键入命令。</p>
</blockquote>
<pre><code>(gdb) step
11          _y = x;</code></pre><p>如您所见，在这种模式下，在每个<code>step</code>命令上，GDB 将打印当前语句及其行号。正如您稍后将在 TUI 模式中看到的那样，您将不会在命令区域中看到该语句。</p>
<p>我们现在“在”<code>_y = x</code>声明；该语句尚未执行。这意味着<code>x</code> 已初始化但未初始化<code>_y</code>。让我们使用<code>print</code> 命令检查那些堆栈/局部变量，<code>p</code>简称：</p>
<pre><code>(gdb) print x
$1 = 42
(gdb) p &amp;x
$2 = (*mut i32) 0x20009fe0
(gdb) p _y
$3 = 536870912
(gdb) p &amp;_y
$4 = (*mut i32) 0x20009fe4</code></pre><p>正如预期的那样，<code>x</code>包含值<code>42</code>。<code>_y</code>，但是，包含值<code>536870912</code>(?)。这是因为<code>_y</code>尚未初始化，它包含一些垃圾值。</p>
<p>该命令<code>print &amp;x</code>打印变量的地址<code>x</code>。这里有趣的一点是 GDB 输出显示了引用的类型：<code>*mut i32</code>，一个指向<code>i32</code>值的可变指针。另一个有趣的事情是，地址<code>x</code>和<code>_y</code>非常接近对方：他们的地址只是<code>4</code>个字节分开。</p>
<p>也可以使用以下<code>info locals</code>命令，而不是一一打印局部变量：</p>
<pre><code>(gdb) info locals
x = 42
_y = 536870912</code></pre><p>好的。使用 another <code>step</code>，我们将在<code>loop {}</code>语句之上：</p>
<pre><code>(gdb) step
14          loop {}</code></pre><p>并且<code>_y</code>现在应该被初始化。</p>
<pre><code>(gdb) print _y
$5 = 42</code></pre><p>如果我们<code>step</code>再次在<code>loop {}</code>语句之上使用，我们会卡住，因为程序永远不会通过该语句。</p>
<blockquote>
<p><strong>注意</strong>如果您<code>step</code>错误地使用了或任何其他命令并且 GDB 卡住了，您可以通过按 来解除卡住<code>Ctrl+C</code>。</p>
</blockquote>
<p>如上所述，该<code>disassemble /m</code>命令可用于围绕您当前所在的行反汇编程序。您可能还希望对<code>set print asm-demangle on</code> 名称进行乱码处理，这只需要在调试会话中完成一次。稍后这个和其他命令将被放置在一个初始化文件中，这将简化启动调试会话。</p>
<pre><code>(gdb) set print asm-demangle on
(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17h51e7c3daad2af251E:
8       fn main() -&gt; ! {
   0x080001f6 &lt;+0&gt;:     sub     sp, #8
   0x080001f8 &lt;+2&gt;:     movs    r0, #42 ; 0x2a

9           let _y;
10          let x = 42;
   0x080001fa &lt;+4&gt;:     str     r0, [sp, #0]

11          _y = x;
   0x080001fc &lt;+6&gt;:     str     r0, [sp, #4]

12
13          // infinite loop; just so we don't leave this stack frame
14          loop {}
=&gt; 0x080001fe &lt;+8&gt;:     b.n     0x8000200 &lt;led_roulette::__cortex_m_rt_main+10&gt;
   0x08000200 &lt;+10&gt;:    b.n     0x8000200 &lt;led_roulette::__cortex_m_rt_main+10&gt;

End of assembler dump.</code></pre><p>看到<code>=&gt;</code>左侧的粗箭头了吗？它显示了处理器接下来将执行的指令。</p>
<p>此外，如上所述，如果您要执行<code>step</code>命令 GDB 会卡住，因为它正在执行一条指向自身的分支指令并且永远不会越过它。所以你需要使用 <code>Ctrl+C</code>来重新获得控制权。另一种方法是使用<code>stepi</code>( <code>si</code>) GDB 命令，该命令执行一条 asm 指令，GDB 将打印处理器接下来将执行的语句的地址<strong>和</strong>行号，并且不会卡住。</p>
<pre><code>(gdb) stepi
0x08000194      14          loop {}

(gdb) si
0x08000194      14          loop {}</code></pre><p>在我们转向更有趣的事情之前的最后一个技巧。在 GDB 中输入以下命令：</p>
<pre><code>(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) disassemble /m
Dump of assembler code for function main:
7       #[entry]
   0x080001ec &lt;+0&gt;:     push    {r7, lr}
   0x080001ee &lt;+2&gt;:     mov     r7, sp
=&gt; 0x080001f0 &lt;+4&gt;:     bl      0x80001f6 &lt;led_roulette::__cortex_m_rt_main&gt;
   0x080001f4 &lt;+8&gt;:     udf     #254    ; 0xfe

End of assembler dump.</code></pre><p>我们现在回到了开头<code>#[entry]</code>！</p>
<p><code>monitor reset halt</code>将重置微控制器并在程序开始时停止它。<code>continue</code>然后，该命令将让程序自由运行，直到它到达断点，在这种情况下，它是在 处的断点<code>#[entry]</code>。</p>
<p>当您错误地跳过您有兴趣检查的程序部分时，此组合非常方便。您可以轻松地将程序的状态回滚到最初的状态。</p>
<blockquote>
<p><strong>细则</strong>：此<code>reset</code>命令不会清除或触摸 RAM。该内存将保留其上次运行的值。不过，这应该不是问题，除非您的程序行为取决于<em>未初始化</em>变量的值，但这就是未定义行为 (UB) 的定义。</p>
</blockquote>
<p>我们完成了这个调试会话。你可以用<code>quit</code>命令结束它。</p>
<pre><code>(gdb) quit
A debugging session is active.

        Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: $PWD/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.</code></pre><p>为了获得更好的调试体验，您可以使用 GDB 的文本用户界面 (TUI)。要进入该模式，请在 GDB shell 中输入以下命令之一：</p>
<pre><code>(gdb) layout src
(gdb) layout asm
(gdb) layout split</code></pre><blockquote>
<p><strong>注意</strong>向 Windows 用户道歉，GNU ARM Embedded Toolchain 附带的 GDB 可能不支持此 TUI 模式<code>:-(</code>。</p>
</blockquote>
<p>以下是<code>layout split</code>通过执行以下命令设置 a 的示例。正如你所看到的，我们已经放弃了传递<code>--target</code>参数：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
(gdb) target remote :3333
(gdb) load
(gdb) set print asm-demangle on
(gdb) set style sources off
(gdb) break main
(gdb) continue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个以上述命令为<code>-ex</code>参数的命令行，以节省您的一些输入，很快我们将提供一种更简单的方法来执行初始命令集：</p>
<pre><code>cargo run -- -q -ex 'target remote :3333' -ex 'load' -ex 'set print asm-demangle on' -ex 'set style sources off' -ex 'b main' -ex 'c' target/thumbv7em-none-eabihf/debug/led-roulette</code></pre><p>结果如下：</p>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-1.png" alt=""></p>
<p>现在我们将向下滚动顶部源窗口，以便我们看到整个文件并执行<code>layout split</code>，然后<code>step</code>：</p>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-2.png" alt=""></p>
<p>然后我们将执行一些<code>info locals</code>and<code>step</code>的：</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) info locals
(gdb) step
(gdb) info locals
(gdb) step
(gdb) info locals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-3.png" alt=""></p>
<p>您可以随时使用以下命令退出 TUI 模式：</p>
<pre><code>(gdb) tui disable</code></pre><p><img src="/images/loading.gif" data-original="../images/language/gdb-layout-split-4.png" alt=""></p>
<blockquote>
<p><strong>注意</strong>如果您不喜欢默认的 GDB CLI，请查看<a href="https://github.com/cyrus-and/gdb-dashboard#gdb-dashboard" target="_blank" rel="noopener">gdb-dashboard</a>。它使用 Python 将默认的 GDB CLI 转换为显示寄存器、源代码视图、程序集视图和其他内容的仪表板。</p>
</blockquote>
<p>不过不要关闭 OpenOCD！以后我们会一次又一次地使用它。最好让它继续运行。</p>
<h2 id="The-Led-and-Delay-abstractions"><a href="#The-Led-and-Delay-abstractions" class="headerlink" title="The Led and Delay abstractions"></a>The <code>Led</code> and <code>Delay</code> abstractions</h2><p>现在，我将介绍两个高级抽象，我们将使用它们来实现 LED 轮盘赌应用程序。</p>
<p>辅助 crate<code>aux5</code>公开了一个名为 的初始化函数<code>init</code>。调用此函数时，返回两个打包在元组中的<code>Delay</code>值：一个值和一个<code>LedArray</code>值。</p>
<p><code>Delay</code> 可用于在指定的毫秒数内阻止您的程序。</p>
<p><code>LedArray</code>是一个包含 8 个<code>Led</code>s的数组。每个<code>Led</code>代表 F3 板上的一个 LED，并公开两种方法：<code>on</code>和<code>off</code>可分别用于打开或关闭 LED。</p>
<p>让我们通过将起始代码修改为如下所示来尝试这两种抽象：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> Delay<span class="token punctuation">,</span> DelayMs<span class="token punctuation">,</span> LedArray<span class="token punctuation">,</span> OutputSwitch<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> leds<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> LedArray<span class="token punctuation">)</span> <span class="token operator">=</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> half_period <span class="token operator">=</span> <span class="token number">500_u16</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        leds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>half_period<span class="token punctuation">)</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>half_period<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在构建它：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意*</strong>在<em>启动 GDB 会话</em>之前<em>忘记重新构建程序是可能的；这种遗漏会导致非常混乱的调试会话。为了避免这个问题，你可以调用 just<code>cargo run</code> 而不是<code>cargo build</code>; <code>cargo run</code>. 该<code>cargo run</code>命令将构建</em>并*启动调试会话，确保您永远不会忘记重新编译您的程序。</p>
</blockquote>
<p>现在我们将运行并重复我们在上一节中所做的闪烁过程，但使用新程序。我会让你输入<code>cargo run</code>，<em>这很快就会变得更容易</em>。:)</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...

(gdb) target remote :3333
Remote debugging using :3333
led_roulette::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x52c0 lma 0x8000194
Loading section .rodata, size 0xb50 lma 0x8005454
Start address 0x08000194, load size 24484
Transfer rate: 21 KB/sec, 6121 bytes/write.

(gdb) break main
Breakpoint 1 at 0x8000202: file ~/embedded-discovery/src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline ()
    at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]

(gdb) step
led_roulette::__cortex_m_rt_main () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:9
9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>好的。让我们逐步完成代码。这一次，我们将使用<code>next</code>命令而不是<code>step</code>。不同之处在于该<code>next</code>命令将<em>跳过</em>函数调用而不是进入它们内部。</p>
<pre><code>(gdb) next
11          let half_period = 500_u16;

(gdb) next
13          loop {

(gdb) next
14              leds[0].on().ok();

(gdb) next
15              delay.delay_ms(half_period);</code></pre><p>执行该<code>leds[0].on().ok()</code>语句后，您应该看到一个红色 LED，指向北方的 LED 亮起。</p>
<p>让我们继续遍历程序：</p>
<pre><code>(gdb) next
17              leds[0].off().ok();

(gdb) next
18              delay.delay_ms(half_period);</code></pre><p>该<code>delay_ms</code>调用将阻塞程序半秒，但您可能不会注意到，因为该 <code>next</code>命令也需要一些时间来执行。但是，在跳过<code>leds[0].off()</code> 语句后，您应该会看到红色 LED 熄灭。</p>
<p>你已经可以猜到这个程序做了什么。使用<code>continue</code>命令让它不间断地运行。</p>
<pre><code>(gdb) continue
Continuing.</code></pre><p>现在，让我们做一些更有趣的事情。我们将使用 GDB 修改我们程序的行为。</p>
<p>首先，让我们通过点击 来停止无限循环<code>Ctrl+C</code>。你可能最终会在里面的某个地方 <code>Led::on</code>，<code>Led::off</code>或者<code>delay_ms</code>：</p>
<pre><code>^C
Program received signal SIGINT, Interrupt.
0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053</code></pre><p>在我的例子中，程序停止了它在<code>read_volatile</code>函数内的执行。GDB输出结果显示，一些有趣的信息：<code>core::ptr::read_volatile (src=0xe000e010)</code>。这意味着该函数来自<code>core</code>crate 并且它是用参数调用的<code>src = 0xe000e010</code>。</p>
<p>正如您所知，显示函数参数的一种更明确的方法是使用以下<code>info args</code> 命令：</p>
<pre><code>(gdb) info args
src = 0xe000e010</code></pre><p>无论您的程序在哪里停止，您都可以随时查看<code>backtrace</code>命令的输出 （<code>bt</code>简称）以了解它是如何到达那里的：</p>
<pre><code>(gdb) backtrace
#0  0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053
#1  0x08002d66 in vcell::VolatileCell&lt;u32&gt;::get&lt;u32&gt; (self=0xe000e010) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/vcell-0.1.3/src/lib.rs:33
#2  volatile_register::RW&lt;u32&gt;::read&lt;u32&gt; (self=0xe000e010) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/volatile-register-0.2.0/src/lib.rs:75
#3  cortex_m::peripheral::SYST::has_wrapped (self=0x20009fa4)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-0.6.4/src/peripheral/syst.rs:136
#4  0x08003004 in stm32f3xx_hal::delay::{{impl}}::delay_us (self=0x20009fa4, us=500000)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:58
#5  0x08002f3e in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:32
#6  0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
#7  0x0800024c in led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:15
#8  0x08000206 in led_roulette::__cortex_m_rt_main_trampoline () at src/05-led-roulette/src/main.rs:7</code></pre><p><code>backtrace</code> 将打印从当前函数到 main 的函数调用跟踪。</p>
<p>回到我们的话题。为了做我们所追求的，首先，我们必须返回到<code>main</code>函数。我们可以使用<code>finish</code>命令来做到这一点。该命令恢复程序执行并在程序从当前函数返回后立即停止执行。我们将不得不多次调用它。</p>
<pre><code>(gdb) finish
Run till exit from #0  0x08003434 in core::ptr::read_volatile&lt;u32&gt; (src=0xe000e010)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1053
cortex_m::peripheral::SYST::has_wrapped (self=0x20009fa4)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-0.6.4/src/peripheral/syst.rs:136
136             self.csr.read() &amp; SYST_CSR_COUNTFLAG != 0
Value returned is $1 = 5

(..)

(gdb) finish
Run till exit from #0  0x08002f3e in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:32
0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
38              self.delay_ms(u32(ms));

(gdb) finish
Run till exit from #0  0x08002f80 in stm32f3xx_hal::delay::{{impl}}::delay_ms (self=0x20009fa4, ms=500)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/stm32f3xx-hal-0.5.0/src/delay.rs:38
0x0800024c in led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:15
15              delay.delay_ms(half_period);</code></pre><p>我们回来了<code>main</code>。我们在这里有一个局部变量：<code>half_period</code></p>
<pre><code>(gdb) print half_period
$3 = 500</code></pre><p>现在，我们将使用以下<code>set</code>命令修改此变量：</p>
<pre><code>(gdb) set half_period = 100

(gdb) print half_period
$5 = 100</code></pre><p>如果您使用该<code>continue</code>命令再次让程序自由运行，您<strong>可能会</strong>看到 LED 现在将以更快的速度闪烁，但更有可能的是闪烁率没有改变。<strong>发生了什么？</strong></p>
<p>让我们用 停止程序，<code>Ctrl+C</code>然后在 处设置一个断点<code>main:14</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
core::cell::UnsafeCell<u32>::get<u32> (self=0x20009fa4)
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/cell.rs:1711
1711        pub const fn get(&self) -> *mut T {<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在<code>main.rs:14</code>和设置一个断点<code>continue</code></p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) break main.rs:14
Breakpoint 2 at 0x8000236: file src/05-led-roulette/src/main.rs, line 14.
(gdb) continue
Continuing.

Breakpoint 2, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:14
14              leds[0].on().ok();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在打开你的终端窗口，如果可能的话，它大约有 80 行长和 170 个字符。</p>
<blockquote>
<p><strong>注意</strong>如果你不能打开那么大的终端，没问题你会看到 <code>--Type &lt;RET&gt; for more, q to quit, c to continue without paging--</code>所以只需输入 return 直到你看到<code>(gdb)</code>提示。然后滚动终端窗口以查看结果。</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17h51e7c3daad2af251E:
8       fn main() -> ! {
   0x08000208 <+0>:     push    {r7, lr}
   0x0800020a <+2>:     mov     r7, sp
   0x0800020c <+4>:     sub     sp, #64 ; 0x40
   0x0800020e <+6>:     add     r0, sp, #32

9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();
   0x08000210 <+8>:     bl      0x8000302 <aux5::init>
   0x08000214 <+12>:    b.n     0x8000216 <led_roulette::__cortex_m_rt_main+14>
   0x08000216 <+14>:    add     r0, sp, #32
   0x08000218 <+16>:    add     r1, sp, #4
   0x0800021a <+18>:    ldmia.w r0, {r2, r3, r4, r12, lr}
   0x0800021e <+22>:    stmia.w r1, {r2, r3, r4, r12, lr}
   0x08000222 <+26>:    ldr     r0, [sp, #52]   ; 0x34
   0x08000224 <+28>:    ldr     r1, [sp, #56]   ; 0x38
   0x08000226 <+30>:    str     r1, [sp, #28]
   0x08000228 <+32>:    str     r0, [sp, #24]
   0x0800022a <+34>:    mov.w   r0, #500        ; 0x1f4

10
11          let half_period = 500_u16;
   0x0800022e <+38>:    strh.w  r0, [r7, #-2]

12
13          loop {
   0x08000232 <+42>:    b.n     0x8000234 <led_roulette::__cortex_m_rt_main+44>
   0x08000234 <+44>:    add     r0, sp, #24
   0x08000268 <+96>:    b.n     0x8000234 <led_roulette::__cortex_m_rt_main+44>

14              leds[0].on().ok();
=> 0x08000236 <+46>:    bl      0x80001ec <switch_hal::output::{{impl}}::on<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800023a <+50>:    b.n     0x800023c <led_roulette::__cortex_m_rt_main+52>
   0x0800023c <+52>:    bl      0x8000594 <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000240 <+56>:    b.n     0x8000242 <led_roulette::__cortex_m_rt_main+58>
   0x08000242 <+58>:    add     r0, sp, #4
   0x08000244 <+60>:    mov.w   r1, #500        ; 0x1f4

15              delay.delay_ms(half_period);
   0x08000248 <+64>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x0800024c <+68>:    b.n     0x800024e <led_roulette::__cortex_m_rt_main+70>
   0x0800024e <+70>:    add     r0, sp, #24

16
17              leds[0].off().ok();
   0x08000250 <+72>:    bl      0x800081a <switch_hal::output::{{impl}}::off<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x08000254 <+76>:    b.n     0x8000256 <led_roulette::__cortex_m_rt_main+78>
   0x08000256 <+78>:    bl      0x8000594 <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x0800025a <+82>:    b.n     0x800025c <led_roulette::__cortex_m_rt_main+84>
   0x0800025c <+84>:    add     r0, sp, #4
   0x0800025e <+86>:    mov.w   r1, #500        ; 0x1f4

18              delay.delay_ms(half_period);
   0x08000262 <+90>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000266 <+94>:    b.n     0x8000268 <led_roulette::__cortex_m_rt_main+96>

End of assembler dump.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的转储中，延迟没有改变的原因是因为编译器认识到 half_period 没有改变，而是在<code>delay.delay_ms(half_period);</code>被调用的两个地方 我们看到了<code>mov.w r1, #500</code>。所以改变 的值<code>half_period</code>没有任何作用！</p>
<pre class="line-numbers language-console"><code class="language-console">   0x08000244 <+60>:    mov.w   r1, #500        ; 0x1f4

15              delay.delay_ms(half_period);
   0x08000248 <+64>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms>

(..)

   0x0800025e <+86>:    mov.w   r1, #500        ; 0x1f4

18              delay.delay_ms(half_period);
   0x08000262 <+90>:    bl      0x8002f5c <stm32f3xx_hal::delay::{{impl}}::delay_ms><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该问题的一种解决方案是包装<code>half_period</code>在 a 中<code>Volatile</code>，如下所示。</p>
<pre class="line-numbers language-console"><code class="language-console">#![deny(unsafe_code)]
#![no_main]
#![no_std]

use volatile::Volatile;
use aux5::{Delay, DelayMs, LedArray, OutputSwitch, entry};

#[entry]
fn main() -> ! {
    let (mut delay, mut leds): (Delay, LedArray) = aux5::init();

    let mut half_period = 500_u16;
    let v_half_period = Volatile::new(&mut half_period);

    loop {
        leds[0].on().ok();
        delay.delay_ms(v_half_period.read());

        leds[0].off().ok();
        delay.delay_ms(v_half_period.read());
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在该部分编辑<code>Cargo.toml</code>添加。<code>volatile = "0.4.3"``[dependencies]</code></p>
<pre class="line-numbers language-console"><code class="language-console">[dependencies]
aux5 = { path = "auxiliary" }
volatile = "0.4.3"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用上面的代码，<code>Volatile</code>您现在可以进行更改，<code>half_period</code>并且可以尝试不同的值。这是命令列表和解释；<code># xxxx</code>展示。</p>
<pre><code>$ cargo run --target thumbv7em-none-eabihf   # Compile and load the program into gdb
(gdb) target remote :3333           # Connect to STM32F3DISCOVERY board from PC
(gdb) load                          # Flash program
(gdb) break main.rs:16              # Set breakpoint 1 at top of loop
(gdb) continue                      # Continue, will stop at main.rs:16
(gdb) disable 1                     # Disable breakpoint 1
(gdb) set print asm-demangle on     # Enable asm-demangle
(gdb) disassemble /m                # Disassemble main function
(gdb) continue                      # Led blinking on for 1/2 sec then off 1/2 sec
^C                                  # Stop with Ctrl+C
(gdb) enable 1                      # Enable breakpiont 1
(gdb) continue                      # Continue, will stop at main.rs:16
(gdb) print half_period             # Print half_period result is 500
(gdb) set half_period = 2000        # Set half_period to 2000ms
(gdb) print half_period             # Print half_period and result is 2000
(gdb) disable 1                     # Disable breakpoint 1
(gdb) continue                      # Led blinking on for 2 secs then off 2 sec
^C                                  # Stop with Ctrl+C
(gdb) quit                          # Quit gdb</code></pre><p>关键更改位于源代码的第 13、17 和 20 行，您可以在反汇编中看到。在 13 我们创建<code>v_half_period</code>然后 <code>read()</code>它的值在第 17 和 20 行。这意味着当我们<code>set half_period = 2000</code> 现在 LED 将打开 2 秒然后关闭 2 秒。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run --target thumbv7em-none-eabihf
   Compiling led-roulette v0.2.0 (~/embedded-discovery/src/05-led-roulette)
    Finished dev [unoptimized + debuginfo] target(s) in 0.18s
     Running `arm-none-eabi-gdb -q ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...

(gdb) target remote :3333
Remote debugging using :3333
led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) load
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x5258 lma 0x8000194
Loading section .rodata, size 0xbd8 lma 0x80053ec
Start address 0x08000194, load size 24516
Transfer rate: 21 KB/sec, 6129 bytes/write.

(gdb) break main.rs:16
Breakpoint 1 at 0x8000246: file src/05-led-roulette/src/main.rs, line 16.
Note: automatically using hardware breakpoints for read-only addresses.

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) disable 1

(gdb) set print asm-demangle on

(gdb) disassemble /m
Dump of assembler code for function _ZN12led_roulette18__cortex_m_rt_main17he1f2bc7990b13731E:
9       fn main() -> ! {
   0x0800020e <+0>:     push    {r7, lr}
   0x08000210 <+2>:     mov     r7, sp
   0x08000212 <+4>:     sub     sp, #72 ; 0x48
   0x08000214 <+6>:     add     r0, sp, #36     ; 0x24

10          let (mut delay, mut leds): (Delay, LedArray) = aux5::init();
   0x08000216 <+8>:     bl      0x800036a <aux5::init>
   0x0800021a <+12>:    b.n     0x800021c <led_roulette::__cortex_m_rt_main+14>
   0x0800021c <+14>:    add     r0, sp, #36     ; 0x24
   0x0800021e <+16>:    add     r1, sp, #8
   0x08000220 <+18>:    ldmia.w r0, {r2, r3, r4, r12, lr}
   0x08000224 <+22>:    stmia.w r1, {r2, r3, r4, r12, lr}
   0x08000228 <+26>:    ldr     r0, [sp, #56]   ; 0x38
   0x0800022a <+28>:    ldr     r1, [sp, #60]   ; 0x3c
   0x0800022c <+30>:    str     r1, [sp, #32]
   0x0800022e <+32>:    str     r0, [sp, #28]
   0x08000230 <+34>:    mov.w   r0, #500        ; 0x1f4

11
12          let mut half_period = 500_u16;
   0x08000234 <+38>:    strh.w  r0, [r7, #-6]
   0x08000238 <+42>:    subs    r0, r7, #6

13          let v_half_period = Volatile::new(&mut half_period);
   0x0800023a <+44>:    bl      0x800033e <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::new<&mut u16>>
   0x0800023e <+48>:    str     r0, [sp, #68]   ; 0x44
   0x08000240 <+50>:    b.n     0x8000242 <led_roulette::__cortex_m_rt_main+52>

14
15          loop {
   0x08000242 <+52>:    b.n     0x8000244 <led_roulette::__cortex_m_rt_main+54>
   0x08000244 <+54>:    add     r0, sp, #28
   0x08000288 <+122>:   b.n     0x8000244 <led_roulette::__cortex_m_rt_main+54>

16              leds[0].on().ok();
=> 0x08000246 <+56>:    bl      0x800032c <switch_hal::output::{{impl}}::on<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800024a <+60>:    b.n     0x800024c <led_roulette::__cortex_m_rt_main+62>
   0x0800024c <+62>:    bl      0x80005fc <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000250 <+66>:    b.n     0x8000252 <led_roulette::__cortex_m_rt_main+68>
   0x08000252 <+68>:    add     r0, sp, #68     ; 0x44

17              delay.delay_ms(v_half_period.read());
   0x08000254 <+70>:    bl      0x800034a <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::read<&mut u16,u16,volatile::access::ReadWrite>>
   0x08000258 <+74>:    str     r0, [sp, #4]
   0x0800025a <+76>:    b.n     0x800025c <led_roulette::__cortex_m_rt_main+78>
   0x0800025c <+78>:    add     r0, sp, #8
   0x0800025e <+80>:    ldr     r1, [sp, #4]
   0x08000260 <+82>:    bl      0x8002fc4 <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000264 <+86>:    b.n     0x8000266 <led_roulette::__cortex_m_rt_main+88>
   0x08000266 <+88>:    add     r0, sp, #28

18
19              leds[0].off().ok();
   0x08000268 <+90>:    bl      0x8000882 <switch_hal::output::{{impl}}::off<stm32f3xx_hal::gpio::gpioe::PEx<stm32f3xx_hal::gpio::Output<stm32f3xx_hal::gpio::PushPull>>>>
   0x0800026c <+94>:    b.n     0x800026e <led_roulette::__cortex_m_rt_main+96>
   0x0800026e <+96>:    bl      0x80005fc <core::result::Result<(), core::convert::Infallible>::ok<(),core::convert::Infallible>>
   0x08000272 <+100>:   b.n     0x8000274 <led_roulette::__cortex_m_rt_main+102>
   0x08000274 <+102>:   add     r0, sp, #68     ; 0x44

20              delay.delay_ms(v_half_period.read());
   0x08000276 <+104>:   bl      0x800034a <volatile::Volatile<&mut u16, volatile::access::ReadWrite>::read<&mut u16,u16,volatile::access::ReadWrite>>
   0x0800027a <+108>:   str     r0, [sp, #0]
   0x0800027c <+110>:   b.n     0x800027e <led_roulette::__cortex_m_rt_main+112>
   0x0800027e <+112>:   add     r0, sp, #8
   0x08000280 <+114>:   ldr     r1, [sp, #0]
   0x08000282 <+116>:   bl      0x8002fc4 <stm32f3xx_hal::delay::{{impl}}::delay_ms>
   0x08000286 <+120>:   b.n     0x8000288 <led_roulette::__cortex_m_rt_main+122>

End of assembler dump.

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x080037b2 in core::cell::UnsafeCell<u32>::get<u32> (self=0x20009fa0) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/cell.rs:1716
1716        }

(gdb) enable 1

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) print half_period
$2 = 500

(gdb) disable 1

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x08003498 in core::ptr::read_volatile<u32> (src=0xe000e010) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1052
1052        unsafe { intrinsics::volatile_load(src) }

(gdb) enable 1

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::__cortex_m_rt_main () at src/05-led-roulette/src/main.rs:16
16              leds[0].on().ok();

(gdb) print half_period
$3 = 500

(gdb) set half_period = 2000

(gdb) print half_period
$4 = 2000

(gdb) disable 1

(gdb) continue
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x0800348e in core::ptr::read_volatile<u32> (src=0xe000e010) at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1046
1046    pub unsafe fn read_volatile<T>(src: *const T) -> T {

(gdb) q
Detaching from program: ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>题！如果您开始降低 的值会发生什么<code>half_period</code>？在什么值下 <code>half_period</code>您不能再看到 LED 闪烁？</p>
<h2 id="The-challenge"><a href="#The-challenge" class="headerlink" title="The challenge"></a>The challenge</h2><p>你现在装备齐全，可以迎接挑战！您的任务是实现我在本章开头向您展示的应用程序。</p>
<p>这里又是GIF：</p>
<p><img src="/images/loading.gif" data-original="../images/language/0k1r2Lc-163136409093323.gif" alt=""></p>
<p>此外，这可能有助于：</p>
<p><img src="/images/loading.gif" data-original="../images/language/timing-diagram.png" alt=""></p>
<p>这是时序图。它指示在任何给定时刻哪个 LED 亮起，以及每个 LED 亮起的时间。在 X 轴上，我们有以毫秒为单位的时间。时序图显示了一个周期。此模式将每 800 毫秒重复一次。Y 轴用基点标记每个 LED：北、东等。作为挑战的一部分，您必须弄清楚<code>Leds</code>阵列中的每个元素如何映射到这些基点（提示：）<code>cargo doc --open</code> <code>;-)</code>。</p>
<p>在你尝试这个挑战之前，让我给你一个额外的提示。我们的 GDB 会话总是在开始时输入相同的命令。我们可以使用一个<code>.gdb</code>文件在 GDB 启动后立即执行一些命令。通过这种方式，您可以省去在每个 GDB 会话中手动输入它们的工作。</p>
<p>事实证明，我们已经创建了<code>../openocd.gdb</code>，您可以看到它的功能与我们在上一节中所做的差不多，另外还有一些其他命令。查看评论以获取更多信息：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../openocd.gdb
# Connect to gdb remote server
target remote :3333

# Load will flash the code
load

# Eanble demangling asm names on disassembly
set print asm-demangle on

# Enable pretty printing
set print pretty on

# Disable style sources as the default colors can be hard to read
set style sources off

# Initialize monitoring so iprintln! macro output
# is sent from the itm port to itm.txt
monitor tpiu config internal itm.txt uart off 8000000

# Turn on the itm port
monitor itm port 0 on

# Set a breakpoint at main, aka entry
break main

# Set a breakpiont at DefaultHandler
break DefaultHandler

# Set a breakpiont at HardFault
break HardFault

# Continue running and until we hit the main breakpoint
continue

# Step from the trampoline code in entry into main
step<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我们需要修改<code>../.cargo/config.toml</code>文件来执行<code>../openocd.gdb</code></p>
<pre class="line-numbers language-console"><code class="language-console">nano ../.cargo/config.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑您的<code>runner</code>命令<code>-x ../openocd.gdb</code>。假设您使用<code>arm-none-eabi-gdb</code>的差异是：</p>
<pre class="line-numbers language-diff"><code class="language-diff">~/embedded-discovery/src/05-led-roulette
$ git diff ../.cargo/config.toml
diff --git a/src/.cargo/config.toml b/src/.cargo/config.toml
index ddff17f..02ac952 100644
<span class="token coord">--- a/src/.cargo/config.toml</span>
<span class="token coord">+++ b/src/.cargo/config.toml</span>
<span class="token coord">@@ -1,5 +1,5 @@</span>
 [target.thumbv7em-none-eabihf]
<span class="token deleted">-runner = "arm-none-eabi-gdb -q"</span>
<span class="token inserted">+runner = "arm-none-eabi-gdb -q -x ../openocd.gdb"</span>
 # runner = "gdb-multiarch -q"
 # runner = "gdb -q"
 rustflags = [<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>的全部内容<code>../.cargo/config.toml</code>，再次假设<code>arm-none-eabi-gdb</code>，是：</p>
<pre class="line-numbers language-toml"><code class="language-toml">[target.thumbv7em-none-eabihf]
runner = "arm-none-eabi-gdb -q -x ../openocd.gdb"
# runner = "gdb-multiarch -q"
# runner = "gdb -q"
rustflags = [
  "-C", "link-arg=-Tlink.x",
]

[build]
target = "thumbv7em-none-eabihf"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了它，您现在可以使用一个简单的<code>cargo run</code>命令来构建代码的 ARM 版本并运行<code>gdb</code>会话。该<code>gdb</code>会议会自动闪烁程序并跳转到的开始<code>main</code>，因为它<code>step</code>的通过进入蹦床：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo run
~/embedded-discovery/src/05-led-roulette (Update-05-led-roulette-WIP)
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q -x openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/led-roulette...
led_roulette::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x52c0 lma 0x8000194
Loading section .rodata, size 0xb50 lma 0x8005454
Start address 0x08000194, load size 24484
Transfer rate: 21 KB/sec, 6121 bytes/write.
Breakpoint 1 at 0x8000202: file ~/embedded-discovery/src/05-led-roulette/src/main.rs, line 7.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, led_roulette::__cortex_m_rt_main_trampoline ()
    at ~/embedded-discovery/src/05-led-roulette/src/main.rs:7
7       #[entry]
led_roulette::__cortex_m_rt_main () at ~/embedded-discovery/src/05-led-roulette/src/main.rs:9
9           let (mut delay, mut leds): (Delay, LedArray) = aux5::init();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="My-solution"><a href="#My-solution" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Delay<span class="token punctuation">,</span> DelayMs<span class="token punctuation">,</span> LedArray<span class="token punctuation">,</span> OutputSwitch<span class="token punctuation">,</span> entry<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> leds<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Delay<span class="token punctuation">,</span> LedArray<span class="token punctuation">)</span> <span class="token operator">=</span> aux5<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50_u8</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有一件事！检查您的解决方案在“发布”模式下编译时是否也有效：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build --target thumbv7em-none-eabihf --release<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>您可以使用以下<code>gdb</code>命令对其进行测试：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # or, you could simply call `cargo run --target thumbv7em-none-eabihf --release`
$ arm-none-eabi-gdb target/thumbv7em-none-eabihf/release/led-roulette
$ #                                              ~~~~~~~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>二进制大小是我们应该时刻关注的东西！你的解决方案有多大？您可以使用<code>size</code>发布二进制文件上的命令来检查：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # equivalent to size target/thumbv7em-none-eabihf/debug/led-roulette
$ cargo size --target thumbv7em-none-eabihf --bin led-roulette -- -A
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
led-roulette  :
section               size        addr
.vector_table          404   0x8000000
.text                21144   0x8000194
.rodata               3144   0x800542c
.data                    0  0x20000000
.bss                     4  0x20000000
.uninit                  0  0x20000004
.debug_abbrev        19160         0x0
.debug_info         471239         0x0
.debug_aranges       18376         0x0
.debug_ranges       102536         0x0
.debug_str          508618         0x0
.debug_pubnames      76975         0x0
.debug_pubtypes     112797         0x0
.ARM.attributes         58         0x0
.debug_frame         55848         0x0
.debug_line         282067         0x0
.debug_loc             845         0x0
.comment               147         0x0
Total              1673362


$ cargo size --target thumbv7em-none-eabihf --bin led-roulette --release -- -A
    Finished release [optimized + debuginfo] target(s) in 0.03s
led-roulette  :
section              size        addr
.vector_table         404   0x8000000
.text                5380   0x8000194
.rodata               564   0x8001698
.data                   0  0x20000000
.bss                    4  0x20000000
.uninit                 0  0x20000004
.debug_loc           9994         0x0
.debug_abbrev        1821         0x0
.debug_info         74974         0x0
.debug_aranges        600         0x0
.debug_ranges        6848         0x0
.debug_str          52828         0x0
.debug_pubnames     20821         0x0
.debug_pubtypes     18891         0x0
.ARM.attributes        58         0x0
.debug_frame         1088         0x0
.debug_line         15307         0x0
.comment               19         0x0
Total              209601<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>Cargo 项目已配置为使用 LTO 构建发布二进制文件。</p>
</blockquote>
<p>知道如何读取这个输出吗？该<code>text</code>部分包含程序指令。就我而言，它大约为 5.25KB。另一方面，<code>data</code>和<code>bss</code>部分包含在 RAM 中静态分配的<code>static</code>变量（变量）。<code>static</code>正在使用一个变量<code>aux5::init</code>；这就是为什么它显示 4 个字节的<code>bss</code>.</p>
<p>最后一件事！我们一直在 GDB 中运行我们的程序，但我们的程序根本不依赖于 GDB。您可以确认这是关闭 GDB 和 OpenOCD，然后通过按下板上的黑色按钮重置板。LED 轮盘应用程序将在没有 GDB 干预的情况下运行。</p>
<h1 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello, world!"></a>Hello, world!</h1><blockquote>
<p><strong>注意事项 STM32F3DISCOVERY 上</strong>的“焊桥”SB10（参见电路板背面）是使用 ITM 和<code>iprint!</code>如下所示的宏所必需的，默认情况下<strong>未</strong>焊接（参见<a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">用户手册的</a>第 21 页）。（更准确地说：这实际上取决于电路板版本。如果您有旧版本的电路板，如<a href="https://docs.rs-online.com/5192/0900766b814876f9.pdf" target="_blank" rel="noopener">旧用户手册</a>所述，SB10 已焊接。检查您的电路板以确定是否需要修复它。）</p>
</blockquote>
<blockquote>
<p><strong>TL;DR</strong>您有两种选择来解决这个问题：<strong>焊接</strong>焊桥 SB10 或在 SWO 和 PB3 之间连接母对母跳线，如下图所示。</p>
</blockquote>
<p><img src="/images/loading.gif" data-original="../images/language/f3-swd.png" alt=""></p>
<hr>
<p>在我们开始做低级的东西之前，再多一点有用的魔法。</p>
<p>闪烁 LED 就像嵌入式世界的“你好，世界”。</p>
<p>但在本节中，我们将运行一个适当的“Hello, world”程序，将内容打印到您的计算机控制台。</p>
<p>进入<code>06-hello-world</code>目录。里面有一些入门代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux6<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> itm <span class="token operator">=</span> aux6<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>iprintln</code>宏将格式化消息，并将其输出到微控制器的<em>ITM</em>。ITM 代表 Instrumentation Trace Macrocell，它是一种基于 SWD（串行线调试）的通信协议，可用于将消息从微控制器发送到调试主机。这种通信只是<em>一种方式</em>：调试主机不能向微控制器发送数据。</p>
<p>管理调试会话的 OpenOCD 可以接收通过此 ITM<em>通道</em>发送的数据并将其重定向到文件。</p>
<p>ITM 协议处理<em>帧</em>（您可以将它们视为以太网帧）。每个帧都有一个报头和一个可变长度的有效载荷。OpenOCD 将接收这些帧并将它们直接写入文件而不进行解析。所以，如果微控制器发送字符串“Hello, world!” 使用 <code>iprintln</code>宏，OpenOCD 的输出文件不会完全包含该字符串。</p>
<p>要检索原始字符串，必须解析 OpenOCD 的输出文件。我们将使用该 <code>itmdump</code>程序在新数据到达时执行解析。</p>
<p>您应该已经<code>itmdump</code>在安装章节中安装了该程序。</p>
<p>在新终端中，<code>/tmp</code>如果您使用的是 *nix 操作系统，请在目录内运行此命令<code>%TEMP%</code>，如果您运行的是 Windows ，则从目录内运行此命令。这应该与您运行 OpenOCD 的目录相同。</p>
<blockquote>
<p><strong>注意</strong><code>itmdump</code>和<code>openocd</code>都从同一目录运行非常重要！</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal

$ # *nix
$ cd /tmp && touch itm.txt

$ # Windows
$ cd %TEMP% && type nul >> itm.txt

$ # both
$ itmdump -F -f itm.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此命令将像<code>itmdump</code>现在一样阻止<code>itm.txt</code>文件。保持这个终端打开。</p>
<p>确保 STM32F3DISCOVERY 板已连接到您的计算机。从<code>/tmp</code>目录中打开另一个终端（在 Windows 上<code>%TEMP%</code>）以启动 OpenOCD。</p>
<p>好吧。现在，让我们构建入门代码并将其闪存到微控制器中。</p>
<p>我们现在将构建并运行应用程序<code>cargo run</code>. 并使用<code>next</code>. 因为<code>openocd.gdb</code>包含OpenOCD中的<code>monitor</code>命令<code>openocd.gdb</code>会将 ITM 输出重定向到 itm.txt 并将<code>itmdump</code>其写入其终端窗口。此外，它设置断点并逐步通过我们在第一个可执行语句处的蹦床<code>fn main()</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">~/embedded-discovery/src/06-hello-world
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `arm-none-eabi-gdb -q -x ../openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world...
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:14
14          loop {}
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x2828 lma 0x8000194
Loading section .rodata, size 0x638 lma 0x80029bc
Start address 0x08000194, load size 12276
Transfer rate: 18 KB/sec, 4092 bytes/write.
Breakpoint 1 at 0x80001f0: file ~/embedded-discovery/src/06-hello-world/src/main.rs, line 8.
Note: automatically using hardware breakpoints for read-only addresses.
Breakpoint 2 at 0x800092a: file /home/wink/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 570.
Breakpoint 3 at 0x80029a8: file /home/wink/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 560.

Breakpoint 1, hello_world::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/06-hello-world/src/main.rs:8
8       #[entry]
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          let mut itm = aux6::init();

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在发出一个<code>next</code>命令，该命令将<code>aux6::init()</code>在 中的下一个可执行语句处执行并停止<code>main.rs</code>，它将我们定位在第 12 行：</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) next
12        iprintln!(&mut itm.stim[0], "Hello, world!");<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后发出另一个<code>next</code>将执行第 12 行的命令，执行<code>iprintln</code>并在第 14 行停止：</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) next
14        loop {}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在既然<code>iprintln</code>已经执行，<code>itmdump</code> 终端窗口上的输出应该是<code>Hello, world!</code>字符串：</p>
<pre class="line-numbers language-console"><code class="language-console">$ itmdump -F -f itm.txt
(...)
Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很棒，对吧？<code>iprintln</code>在接下来的部分中随意用作日志记录工具。</p>
<h2 id="panic"><a href="#panic" class="headerlink" title="panic!"></a><code>panic!</code></h2><p>该<code>panic!</code>宏也将其输出到ITM！</p>
<p>将<code>main</code>函数更改为如下所示：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在运行另一个建议之前，我发现退出 gdb 时必须确认很不方便。将以下文件添加到您的主目录中，<code>~/.gdbinit</code>以便它立即退出：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ~/.gdbinit
define hook-quit
  set confirm off
end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>好的，现在使用<code>cargo run</code>，它停在第一行<code>fn main()</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
   Compiling hello-world v0.2.0 (~/embedded-discovery/src/06-hello-world)
    Finished dev [unoptimized + debuginfo] target(s) in 0.11s
     Running `arm-none-eabi-gdb -q -x ../openocd.gdb ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world`
Reading symbols from ~/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world...
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          panic!("Hello, world!");
Loading section .vector_table, size 0x194 lma 0x8000000
Loading section .text, size 0x20fc lma 0x8000194
Loading section .rodata, size 0x554 lma 0x8002290
Start address 0x08000194, load size 10212
Transfer rate: 17 KB/sec, 3404 bytes/write.
Breakpoint 1 at 0x80001f0: file ~/embedded-discovery/src/06-hello-world/src/main.rs, line 8.
Note: automatically using hardware breakpoints for read-only addresses.
Breakpoint 2 at 0x8000222: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 570.
Breakpoint 3 at 0x800227a: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs, line 560.

Breakpoint 1, hello_world::__cortex_m_rt_main_trampoline () at ~/embedded-discovery/src/06-hello-world/src/main.rs:8
8       #[entry]
hello_world::__cortex_m_rt_main () at ~/embedded-discovery/src/06-hello-world/src/main.rs:10
10          panic!("Hello, world!");
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将使用简短的命令名称来保存输入，<code>c</code>然后输入<code>Enter</code>或<code>Return</code>键：</p>
<pre><code>(gdb) c
Continuing.</code></pre><p>如果一切顺利，您将在<code>itmdump</code>终端中看到一些新的输出。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
panicked at 'Hello, world!', src/06-hello-world/src/main.rs:10:5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后键入<code>Ctrl-c</code>which 在运行时跳出循环：</p>
<pre class="line-numbers language-text"><code class="language-text">^C
Program received signal SIGINT, Interrupt.
0x0800115c in panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:57
57            atomic::compiler_fence(Ordering::SeqCst);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终，<code>panic!</code>这只是另一个函数调用，因此您可以看到它留下了函数调用的痕迹。这允许您使用<code>backtrace</code>或只是<code>bt</code>查看导致恐慌的调用堆栈：</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) bt
#0  panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47
#1  0x080005c2 in core::panicking::panic_fmt () at library/core/src/panicking.rs:92
#2  0x0800055a in core::panicking::panic () at library/core/src/panicking.rs:50
#3  0x08000210 in hello_world::__cortex_m_rt_main () at src/06-hello-world/src/main.rs:10
#4  0x080001f4 in hello_world::__cortex_m_rt_main_trampoline () at src/06-hello-world/src/main.rs:8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以做的另一件事是在记录<em>之前</em>捕捉恐慌。所以我们会做几件事；重置到开头，禁用断点 1，在 处设置一个新断点<code>rust_begin_unwind</code>，列出断点，然后继续：</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000

(gdb) disable 1

(gdb) break rust_begin_unwind 
Breakpoint 4 at 0x800106c: file ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs, line 47.

(gdb) info break
Num     Type           Disp Enb Address    What
1       breakpoint     keep n   0x080001f0 in hello_world::__cortex_m_rt_main_trampoline 
                                           at ~/prgs/rust/tutorial/embedded-discovery/src/06-hello-world/src/main.rs:8
        breakpoint already hit 1 time
2       breakpoint     keep y   0x08000222 in cortex_m_rt::DefaultHandler_ 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:570
3       breakpoint     keep y   0x0800227a in cortex_m_rt::HardFault_ 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:560
4       breakpoint     keep y   0x0800106c in panic_itm::panic 
                                           at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47

(gdb) c
Continuing.

Breakpoint 4, panic_itm::panic (info=0x20009fa0) at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-itm-0.4.2/src/lib.rs:47
47          interrupt::disable();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您会注意到这次<code>itmdump</code>控制台上没有打印任何内容。如果您使用恢复程序，<code>continue</code>则将打印一个新行。</p>
<p>在后面的部分中，我们将研究其他更简单的通信协议。</p>
<p>最后，输入<code>q</code>退出命令，它立即退出而不要求确认：</p>
<pre class="line-numbers language-text"><code class="language-text">(gdb) q
Detaching from program: ~/prgs/rust/tutorial/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>作为一个更短的序列，您可以键入<code>Ctrl-d</code>，这消除了一次击键！</p>
<blockquote>
<p><strong>注意</strong>在这种情况下，<code>(gdb)</code>提示被覆盖<code>quit)</code></p>
</blockquote>
<pre class="line-numbers language-text"><code class="language-text">quit)
Detaching from program: ~/prgs/rust/tutorial/embedded-discovery/target/thumbv7em-none-eabihf/debug/hello-world, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a>Registers</h1><p>是时候探索<code>Led</code>API 在幕后做了什么了。</p>
<p>简而言之，它只是写入一些特殊的内存区域。进入<code>07-registers</code>目录，让我们逐句运行启动代码。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic address!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x48001018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是什么魔法？</p>
<p>地址<code>0x48001018</code>指向一个<em>寄存器</em>。寄存器是控制<em>外围设备</em>的特殊内存区域。外围设备是一种电子元件，它紧邻微控制器封装中的处理器，为处理器提供额外的功能。毕竟，处理器本身只能做数学和逻辑。</p>
<p>此特定寄存器控制通用输入/输出 (GPIO)<em>引脚</em>（GPIO<em>是</em>外设）并可用于将这些引脚中的每一个<em>驱动</em>为<em>低电平</em>或<em>高电平</em>。</p>
<p><strong>旁白：LED、数字输出和电压电平</strong></p>
<p>驾驶？别针？低的？高的？</p>
<p>引脚是电触点。我们的微控制器有几个，其中一些连接到 LED。LED，即发光二极管，只有在施加具有特定极性的电压时才会发光。</p>
<p><img src="/images/loading.gif" data-original="../images/language/LED_circuit.svg" alt=""></p>
<p>幸运的是，微控制器的引脚以正确的极性连接到 LED。我们所要做的就是通过引脚<em>输出</em>一些非零电压来打开 LED。连接到 LED 的引脚配置为<em>数字输出</em>，只能输出两种不同的电压电平：“低”，0 伏，或“高”，3 伏。“高”（电压）电平将打开 LED，而“低”（电压）电平将关闭它。</p>
<p>这些“低”和“高”状态直接映射到数字逻辑的概念。“低”是<code>0</code>或<code>false</code> ，“高”是<code>1</code>或<code>true</code>。这就是该引脚配置被称为数字输出的原因。</p>
<h2 id="RTRM-Reading-The-Reference-Manual"><a href="#RTRM-Reading-The-Reference-Manual" class="headerlink" title="RTRM: Reading The Reference Manual"></a>RTRM: Reading The Reference Manual</h2><p>我提到微控制器有几个引脚。为方便起见，这些引脚被分组 为 16 个引脚的<em>端口</em>。每个端口都以字母命名：端口 A、端口 B 等，每个端口内的引脚以 0 到 15 的数字命名。</p>
<p>我们必须找出的第一件事是哪个引脚连接到哪个 LED。此信息在 STM32F3DISCOVERY<a href="http://www.st.com/resource/en/user_manual/dm00063382.pdf" target="_blank" rel="noopener">用户手册中</a>（您下载了副本，对吗？）。在这个特定部分：</p>
<blockquote>
<p>第 6.4 节 LED - 第 18 页</p>
</blockquote>
<p>手册上说：</p>
<ul>
<li><code>LD3</code>，北 LED，连接到引脚<code>PE9</code>。<code>PE9</code>是以下的缩写形式：端口 E 上的引脚 9。</li>
<li><code>LD7</code>，东 LED，连接到引脚<code>PE11</code>。</li>
</ul>
<p>到目前为止，我们知道我们要更改引脚 PE9 和 PE11 的状态以打开/关闭北/东 LED。这些引脚是端口 E 的一部分，因此我们必须处理<code>GPIOE</code> 外围设备。</p>
<p>每个外设都有一个与之关联的寄存器<em>块</em>。寄存器块是分配在连续内存中的寄存器集合。寄存器块开始的地址称为基地址。我们需要弄清楚<code>GPIOE</code>外围设备的基地址是什么。该信息位于微控制器<a href="http://www.st.com/resource/en/reference_manual/dm00043574.pdf" target="_blank" rel="noopener">参考手册</a>的以下部分：</p>
<blockquote>
<p>第 3.2.2 节内存映射和寄存器边界地址 - 第 51 页</p>
</blockquote>
<p>该表表示<code>GPIOE</code>寄存器块的基地址是<code>0x4800_1000</code>。</p>
<p>每个外设在文档中也有自己的部分。这些部分中的每一个都以外设寄存器块包含的寄存器表结束。对于<code>GPIO</code>外围设备系列，该表位于：</p>
<blockquote>
<p>第 11.4.12 节 GPIO 寄存器映射 - 第 243 页</p>
</blockquote>
<p>“BSRR”是我们将用于设置/复位的寄存器。它的偏移值是“GPIOE”基地址的“0x18”。我们可以在参考手册中查找 BSRR。GPIO 寄存器 -&gt; GPIO 端口位设置/复位寄存器 (GPIOx_BSRR)。</p>
<p>现在我们需要跳转到该特定寄存器的文档。这是上面的几页：</p>
<blockquote>
<p>第 11.4.7 节 GPIO 端口位设置/复位寄存器 (GPIOx_BSRR) - 第 240 页</p>
</blockquote>
<p>最后！</p>
<p>这是我们要写入的寄存器。文档说了一些有趣的事情。首先，这个寄存器是只写的……所以让我们尝试读取它的值<code>:-)</code>。</p>
<p>我们将使用GDB的<code>examine</code>命令：<code>x</code>。</p>
<pre><code>(gdb) next
16              *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 9;

(gdb) x 0x48001018
0x48001018:     0x00000000

(gdb) # the next command will turn the North LED on
(gdb) next
19              *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 11;

(gdb) x 0x48001018
0x48001018:     0x00000000</code></pre><p>读取寄存器返回<code>0</code>。这与文档所说的相符。</p>
<p>文档说的另一件事是位 0 到 15 可用于<em>设置</em>相应的引脚。即位 0 设置引脚 0。这里，<em>设置</em>意味着在引脚上输出<em>高</em>值。</p>
<p>该文档还说，第 16 到 31 位可用于<em>重置</em>相应的引脚。在这种情况下，第 16 位重置引脚编号 0。正如您可能猜到的，<em>重置</em>意味着在引脚上输出一个<em>低值</em>。</p>
<p>将这些信息与我们的程序相关联，似乎都一致：</p>
<ul>
<li>写<code>1 &lt;&lt; 9</code>( <code>BS9 = 1</code>)<code>BSRR</code> 设置<code>PE9</code> <em>高</em>。那会使北方LED<em>上</em>。</li>
<li>写<code>1 &lt;&lt; 11</code>( <code>BS11 = 1</code>)<code>BSRR</code>设置<code>PE11</code> <em>高</em>。那会使东LED<em>上</em>。</li>
<li>写<code>1 &lt;&lt; 25</code>( <code>BR9 = 1</code>)<code>BSRR</code>设置<code>PE9</code> <em>低</em>。这将<em>关闭</em>北方 LED 。</li>
<li>最后，将<code>1 &lt;&lt; 27</code>( <code>BR11 = 1</code>)写入<code>BSRR</code>设置为<code>PE11</code> <em>low</em>。这会<em>关闭</em>东 LED 。</li>
</ul>
<h2 id="mis-Optimization"><a href="#mis-Optimization" class="headerlink" title="(mis)Optimization"></a>(mis)Optimization</h2><p>对寄存器的读/写非常特殊。我什至敢说它们是副作用的体现。在前面的例子中，我们将四个不同的值写入同一个寄存器。如果你不知道地址是一个寄存器，你可能已经简化了逻辑，只是将最终值<code>1 &lt;&lt; (11 + 16)</code>写入寄存器。</p>
<p>实际上，编译器的后端/优化器 LLVM 不知道我们正在处理寄存器，并且会合并写入从而改变我们程序的行为。让我们快速检查一下。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run --release
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:7
7       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:9
9           aux7::init();

(gdb) next
25              *(GPIOE_BSRR as *mut u32) = 1 << (11 + 16);

(gdb) disassemble /m
Dump of assembler code for function _ZN9registers18__cortex_m_rt_main17h45b1ef53e18aa8d0E:
8       fn main() -> ! {
   0x08000248 <+0>:     push    {r7, lr}
   0x0800024a <+2>:     mov     r7, sp

9           aux7::init();
   0x0800024c <+4>:     bl      0x8000260 <aux7::init>
   0x08000250 <+8>:     movw    r0, #4120       ; 0x1018
   0x08000254 <+12>:    mov.w   r1, #134217728  ; 0x8000000
   0x08000258 <+16>:    movt    r0, #18432      ; 0x4800

10
11          unsafe {
12              // A magic address!
13              const GPIOE_BSRR: u32 = 0x48001018;
14
15              // Turn on the "North" LED (red)
16              *(GPIOE_BSRR as *mut u32) = 1 << 9;
17
18              // Turn on the "East" LED (green)
19              *(GPIOE_BSRR as *mut u32) = 1 << 11;
20
21              // Turn off the "North" LED
22              *(GPIOE_BSRR as *mut u32) = 1 << (9 + 16);
23
24              // Turn off the "East" LED
25              *(GPIOE_BSRR as *mut u32) = 1 << (11 + 16);
=> 0x0800025c <+20>:    str     r1, [r0, #0]
   0x0800025e <+22>:    b.n     0x800025e <registers::__cortex_m_rt_main+22>

End of assembler dump.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次 LED 的状态没有改变！该<code>str</code>指令是将值写入寄存器的指令。我们的<em>调试</em>（未优化）程序有四个，每次写入寄存器一个，但<em>发布</em>（优化）程序只有一个。</p>
<p>我们可以检查使用<code>objdump</code>并将输出捕获到<code>out.asm</code>：</p>
<pre class="line-numbers language-console"><code class="language-console"># same as cargo objdump -- -d --no-show-raw-insn --print-imm-hex --source target/thumbv7em-none-eabihf/debug/registers
cargo objdump --bin registers -- -d --no-show-raw-insn --print-imm-hex --source > debug.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后检查<code>debug.txt</code>查找<code>main</code>，我们看到4<code>str</code>条指令：</p>
<pre><code>080001ec &lt;main&gt;:
; #[entry]
 80001ec:       push    {r7, lr}
 80001ee:       mov     r7, sp
 80001f0:       bl      #0x2
 80001f4:       trap

080001f6 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2&gt;:
; fn main() -&gt; ! {
 80001f6:       push    {r7, lr}
 80001f8:       mov     r7, sp
;     aux7::init();
 80001fa:       bl      #0x3e
 80001fe:       b       #-0x2 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0xa&gt;
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 9;
 8000200:       movw    r0, #0x2640
 8000204:       movt    r0, #0x800
 8000208:       ldr     r0, [r0]
 800020a:       movw    r1, #0x1018
 800020e:       movt    r1, #0x4800
 8000212:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; 11;
 8000214:       movw    r0, #0x2648
 8000218:       movt    r0, #0x800
 800021c:       ldr     r0, [r0]
 800021e:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; (9 + 16);
 8000220:       movw    r0, #0x2650
 8000224:       movt    r0, #0x800
 8000228:       ldr     r0, [r0]
 800022a:       str     r0, [r1]
;         *(GPIOE_BSRR as *mut u32) = 1 &lt;&lt; (11 + 16);
 800022c:       movw    r0, #0x2638
 8000230:       movt    r0, #0x800
 8000234:       ldr     r0, [r0]
 8000236:       str     r0, [r1]
;     loop {}
 8000238:       b       #-0x2 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0x44&gt;
 800023a:       b       #-0x4 &lt;registers::__cortex_m_rt_main::hc2e3436fa38cd6f2+0x44&gt;
 (..)</code></pre><p>我们如何防止 LLVM 错误优化我们的程序？我们使用<em>volatile</em>操作而不是普通的读/写：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic address!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x48001018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>release.txt</code>使用 with<code>--release</code>模式生成。</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --release --bin registers -- -d --no-show-raw-insn --print-imm-hex --source > release.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在找到<code>main</code>例程<code>release.txt</code>，我们看到了 4<code>str</code>条指令。</p>
<pre><code>0800023e &lt;main&gt;:
; #[entry]
 800023e:       push    {r7, lr}
 8000240:       mov     r7, sp
 8000242:       bl      #0x2
 8000246:       trap

08000248 &lt;registers::__cortex_m_rt_main::h45b1ef53e18aa8d0&gt;:
; fn main() -&gt; ! {
 8000248:       push    {r7, lr}
 800024a:       mov     r7, sp
;     aux7::init();
 800024c:       bl      #0x22
 8000250:       movw    r0, #0x1018
 8000254:       mov.w   r1, #0x200
 8000258:       movt    r0, #0x4800
;         intrinsics::volatile_store(dst, src);
 800025c:       str     r1, [r0]
 800025e:       mov.w   r1, #0x800
 8000262:       str     r1, [r0]
 8000264:       mov.w   r1, #0x2000000
 8000268:       str     r1, [r0]
 800026a:       mov.w   r1, #0x8000000
 800026e:       str     r1, [r0]
 8000270:       b       #-0x4 &lt;registers::__cortex_m_rt_main::h45b1ef53e18aa8d0+0x28&gt;
 (..)</code></pre><p>我们看到四个写（<code>str</code>指令）被保留了下来。如果您使用它运行它， <code>gdb</code>您还会看到我们得到了预期的行为。</p>
<blockquote>
<p>注意：最后一个<code>next</code>将无限执行<code>loop {}</code>，用于<code>Ctrl-c</code>返回<code>(gdb)</code>提示。</p>
</blockquote>
<pre><code>$ cargo run --release
(..)

Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:9
9       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:11
11          aux7::init();

(gdb) next
18              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; 9);

(gdb) next
21              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; 11);

(gdb) next
24              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; (9 + 16));

(gdb) next
27              ptr::write_volatile(GPIOE_BSRR as *mut u32, 1 &lt;&lt; (11 + 16));

(gdb) next
^C
Program received signal SIGINT, Interrupt.
0x08000270 in registers::__cortex_m_rt_main ()
    at ~/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:1124
1124            intrinsics::volatile_store(dst, src);
(gdb) </code></pre><h2 id="0xBAAAAAAD-address"><a href="#0xBAAAAAAD-address" class="headerlink" title="0xBAAAAAAD address"></a><code>0xBAAAAAAD</code> address</h2><p>并非所有外围存储器都可以访问。看看这个程序。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token number">0x4800_1800</span> <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个地址与<code>GPIOE_BSRR</code>我们之前使用的地址很接近，但是这个地址是<em>无效的</em>。在这个地址没有寄存器的意义上是无效的。</p>
<p>现在，让我们尝试一下。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:9
9       #[entry]

(gdb) continue
Continuing.

Breakpoint 3, cortex_m_rt::HardFault_ (ef=0x20009fb0)
    at ~/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.13/src/lib.rs:560
560         loop {

(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们试图做一个无效的操作，读取不存在的内存，所以处理器引发了一个 <em>异常</em>，一个<em>硬件</em>异常。</p>
<p>在大多数情况下，当处理器尝试执行无效操作时会引发异常。异常会破坏程序的正常流程并强制处理器执行<em>异常处理程序</em>，它只是一个函数/子例程。</p>
<p>有不同类型的例外。每种异常由不同的条件引发，每种异常由不同的异常处理程序处理。</p>
<p>该<code>aux7</code>箱子依赖于<code>cortex-m-rt</code>它定义了默认箱 <em>硬故障</em>处理程序，命名<code>HardFault</code>，处理该“无效的内存地址”异常。<code>openocd.gdb</code>在 上放置一个断点<code>HardFault</code>；这就是调试器在执行异常处理程序时停止程序的原因。我们可以从调试器中获取有关异常的更多信息。让我们来看看：</p>
<pre><code>(gdb) list
555     #[allow(unused_variables)]
556     #[doc(hidden)]
557     #[link_section = ".HardFault.default"]
558     #[no_mangle]
559     pub unsafe extern "C" fn HardFault_(ef: &amp;ExceptionFrame) -&gt; ! {
560         loop {
561             // add some side effect to prevent this from turning into a UDF instruction
562             // see rust-lang/rust#28728 for details
563             atomic::compiler_fence(Ordering::SeqCst);
564         }</code></pre><p><code>ef</code>是发生异常之前程序状态的快照。让我们检查一下：</p>
<pre><code>(gdb) print/x *ef
$1 = cortex_m_rt::ExceptionFrame {
  r0: 0x48001800,
  r1: 0x80036b0,
  r2: 0x1,
  r3: 0x80000000,
  r12: 0xb,
  lr: 0x800020d,
  pc: 0x8001750,
  xpsr: 0xa1000200
}</code></pre><p>这里有几个字段，但最重要的一个是<code>pc</code>程序计数器寄存器。该寄存器中的地址指向产生异常的指令。让我们围绕坏指令反汇编程序。</p>
<pre><code>(gdb) disassemble /m ef.pc
Dump of assembler code for function core::ptr::read_volatile&lt;u32&gt;:
1046    pub unsafe fn read_volatile&lt;T&gt;(src: *const T) -&gt; T {
   0x0800174c &lt;+0&gt;:     sub     sp, #12
   0x0800174e &lt;+2&gt;:     str     r0, [sp, #4]

1047        if cfg!(debug_assertions) &amp;&amp; !is_aligned_and_not_null(src) {
1048            // Not panicking to keep codegen impact smaller.
1049            abort();
1050        }
1051        // SAFETY: the caller must uphold the safety contract for `volatile_load`.
1052        unsafe { intrinsics::volatile_load(src) }
   0x08001750 &lt;+4&gt;:     ldr     r0, [r0, #0]
   0x08001752 &lt;+6&gt;:     str     r0, [sp, #8]
   0x08001754 &lt;+8&gt;:     ldr     r0, [sp, #8]
   0x08001756 &lt;+10&gt;:    str     r0, [sp, #0]
   0x08001758 &lt;+12&gt;:    b.n     0x800175a &lt;core::ptr::read_volatile&lt;u32&gt;+14&gt;

1053    }
   0x0800175a &lt;+14&gt;:    ldr     r0, [sp, #0]
   0x0800175c &lt;+16&gt;:    add     sp, #12
   0x0800175e &lt;+18&gt;:    bx      lr

End of assembler dump.</code></pre><p>异常是由<code>ldr r0, [r0, #0]</code>指令引起的，一条读指令。该指令试图读取<code>r0</code>寄存器指示地址处的内存。顺便说一句，<code>r0</code>是CPU（处理器）寄存器不是内存映射寄存器；它没有关联的地址，例如， <code>GPIO_BSRR</code>。</p>
<p>如果我们能<code>r0</code>在引发异常的那一刻检查寄存器的值是正确的，那不是很好吗？好吧，我们已经做到了！我们之前打印<code>r0</code>的<code>ef</code>值中的字段<code>r0</code>是引发异常时 register的值。又来了：</p>
<pre><code>(gdb) print/x *ef
$1 = cortex_m_rt::ExceptionFrame {
  r0: 0x48001800,
  r1: 0x80036b0,
  r2: 0x1,
  r3: 0x80000000,
  r12: 0xb,
  lr: 0x800020d,
  pc: 0x8001750,
  xpsr: 0xa1000200
}</code></pre><p><code>r0</code>包含<code>0x4800_1800</code>我们调用<code>read_volatile</code> 函数的无效地址的值。</p>
<h2 id="Spooky-action-at-a-distance"><a href="#Spooky-action-at-a-distance" class="headerlink" title="Spooky action at a distance"></a>Spooky action at a distance</h2><p><code>BSRR</code>不是唯一可以控制端口 E 引脚的<code>ODR</code>寄存器。该寄存器还可以让您更改引脚的值。此外，<code>ODR</code>还可以让您检索端口 E 的当前输出状态。</p>
<p><code>ODR</code> 记录在：</p>
<blockquote>
<p>第 11.4.6 节 GPIO 端口输出数据寄存器 - 第 239 页</p>
</blockquote>
<p>我们来看看这个程序。这个程序的关键是<code>fn iprint_odr</code>. 此函数将当前值打印<code>ODR</code>到<code>ITM</code>控制台</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>ptr<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> ITM<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Print the current contents of odr</span>
<span class="token keyword">fn</span> <span class="token function">iprint_odr</span><span class="token punctuation">(</span>itm<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ITM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> GPIOE_ODR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x4800_1014</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">iprintln!</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"ODR = 0x{:04x}"</span><span class="token punctuation">,</span>
            ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span>GPIOE_ODR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u16<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> itm<span class="token operator">=</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// A magic addresses!</span>
        <span class="token keyword">const</span> GPIOE_BSRR<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0x4800_1018</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Print the initial contents of ODR</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "North" LED (red)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn on the "East" LED (green)</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "North" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Turn off the "East" LED</span>
        ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">write_volatile</span><span class="token punctuation">(</span>GPIOE_BSRR <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> u32<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">11</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">iprint_odr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你运行这个程序</p>
<pre><code>$ cargo run
(..)
Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:22
22      #[entry]

(gdb) continue
Continuing.</code></pre><p>您将在 itmdump 的控制台上看到：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump's console
(..)
ODR = 0x0000
ODR = 0x0200
ODR = 0x0a00
ODR = 0x0800
ODR = 0x0000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>副作用！尽管我们多次读取同一个地址而没有实际修改它，但每次<code>BSRR</code>写入时我们仍然看到它的值变化。</p>
<h2 id="Type-safe-manipulation"><a href="#Type-safe-manipulation" class="headerlink" title="Type safe manipulation"></a>Type safe manipulation</h2><p>我们使用的最后一个寄存器<code>ODR</code>，在其文档中包含以下内容：</p>
<blockquote>
<p>位 31:16 保留，必须保持在复位值</p>
</blockquote>
<p>我们不应该写入寄存器的那些位，否则可能会发生坏事。</p>
<p>还有一个事实是寄存器具有不同的读/写权限。其中一些是只写的，另一些可以读取和写入，并且必须有一些是只读的。</p>
<p>最后，直接使用十六进制地址容易出错。您已经看到尝试访问无效的内存地址会导致异常，从而中断我们程序的执行。</p>
<p>如果我们有一个 API 来以“安全”的方式操作寄存器不是很好吗？理想情况下，API 应该对我提到的这三点进行编码：不要弄乱实际地址，应该尊重读/写权限，并应该防止修改寄存器的保留部分。</p>
<p>好吧，我们愿意！<code>aux7::init()</code>实际上返回一个值，该值提供了一个类型安全的 API 来操作<code>GPIOE</code>外围设备的寄存器 。</p>
<p>您可能还记得：与外围设备关联的一组寄存器称为寄存器块，它位于内存的连续区域中。在这种类型安全的 API 中，每个寄存器块都被建模为一个<code>struct</code>其中的每个字段代表一个寄存器。每个寄存器字段都是不同的新类型，例如<code>u32</code>公开以下方法的组合：<code>read</code>，<code>write</code>或 <code>modify</code>根据其读/写权限。最后，这些方法不采用像 那样的原始值<code>u32</code>，而是采用另一种可以使用构建器模式构造的新类型，并防止修改寄存器的保留部分。</p>
<p>熟悉这个 API 的最好方法是将我们的运行示例移植到它。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> ITM<span class="token punctuation">,</span> RegisterBlock<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> gpioe <span class="token operator">=</span> aux7<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on the North LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">bs9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on the East LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">bs11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn off the North LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">br9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn off the East LED</span>
    gpioe<span class="token punctuation">.</span>bsrr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">br11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您注意到的第一件事：不涉及魔术地址。相反，我们使用更人性化的方式，例如<code>gpioe.bsrr</code>，<code>BSRR</code>在<code>GPIOE</code>寄存器块中引用寄存器。</p>
<p>然后我们有这个<code>write</code>接受闭包的方法。如果使用身份闭包 ( <code>|w| w</code>)，此方法会将寄存器设置为其<em>默认</em>（重置）值，即在微控制器上电/重置后立即具有的值。该值<code>0x0</code>用于<code>BSRR</code>寄存器。由于我们想向寄存器写入一个非零值，我们使用像<code>bs9</code>和 之类的构建器方法<code>br9</code>来设置默认值的一些位。</p>
<p>让我们运行这个程序！<em>在</em>调试程序时，我们可以做一些有趣的事情。</p>
<p><code>gpioe</code>是对<code>GPIOE</code>寄存器块的引用。<code>print gpioe</code>将返回寄存器块的基地址。</p>
<pre><code>$ cargo run
(..)

Breakpoint 1, registers::__cortex_m_rt_main_trampoline () at src/07-registers/src/main.rs:7
7       #[entry]

(gdb) step
registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:9
9           let gpioe = aux7::init().1;

(gdb) next
12          gpioe.bsrr.write(|w| w.bs9().set_bit());

(gdb) print gpioe
$1 = (*mut stm32f3::stm32f303::gpioc::RegisterBlock) 0x48001000</code></pre><p>但是如果我们改为<code>print *gpioe</code>，我们将获得寄存器块的<em>完整视图</em>：将打印其每个寄存器的值。</p>
<pre><code>(gdb) print *gpioe
$2 = stm32f3::stm32f303::gpioc::RegisterBlock {
  moder: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_MODER&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 1431633920
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_MODER&gt;
  },
  otyper: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_OTYPER&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_OTYPER&gt;
  },
  ospeedr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_OSPEEDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_OSPEEDR&gt;
  },
  pupdr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_PUPDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_PUPDR&gt;
  },
  idr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_IDR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 204
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_IDR&gt;
  },
  odr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_ODR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_ODR&gt;
  },
  bsrr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_BSRR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_BSRR&gt;
  },
  lckr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_LCKR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_LCKR&gt;
  },
  afrl: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_AFRL&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_AFRL&gt;
  },
  afrh: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_AFRH&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_AFRH&gt;
  },
  brr: stm32f3::generic::Reg&lt;u32, stm32f3::stm32f303::gpioc::_BRR&gt; {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0
      }
    },
    _marker: core::marker::PhantomData&lt;stm32f3::stm32f303::gpioc::_BRR&gt;
  }
}</code></pre><p>所有这些新类型和闭包听起来像是会生成大型、臃肿的程序，但是，如果您在启用<a href="https://en.wikipedia.org/wiki/Interprocedural_optimization" target="_blank" rel="noopener">LTO 的情况</a>下在发布模式下实际编译程序，您将看到它生成的指令与使用的“不安全”版本完全相同，<code>write_volatile</code>并且十六进制地址做到了！</p>
<p>用<code>cargo objdump</code>抢的汇编代码<code>release.txt</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">cargo objdump --bin registers --release -- -d --no-show-raw-insn --print-imm-hex > release.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后搜索<code>main</code>中<code>release.txt</code></p>
<pre><code>0800023e &lt;main&gt;:
 800023e:          push    {r7, lr}
 8000240:          mov    r7, sp
 8000242:          bl    #0x2
 8000246:          trap

08000248 &lt;registers::__cortex_m_rt_main::h199f1359501d5c71&gt;:
 8000248:          push    {r7, lr}
 800024a:          mov    r7, sp
 800024c:          bl    #0x22
 8000250:          movw    r0, #0x1018
 8000254:          mov.w    r1, #0x200
 8000258:          movt    r0, #0x4800
 800025c:          str    r1, [r0]
 800025e:          mov.w    r1, #0x800
 8000262:          str    r1, [r0]
 8000264:          mov.w    r1, #0x2000000
 8000268:          str    r1, [r0]
 800026a:          mov.w    r1, #0x8000000
 800026e:          str    r1, [r0]
 8000270:          b    #-0x4 &lt;registers::__cortex_m_rt_main::h199f1359501d5c71+0x28&gt;</code></pre><p>最好的部分是没有人必须编写一行代码来实现 GPIOE API。所有代码都是使用<a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener">svd2rust</a>工具从系统视图描述 (SVD) 文件自动生成的 。此 SVD 文件实际上是微控制器供应商提供的 XML 文件，其中包含其微控制器的寄存器映射。该文件包含寄存器块的布局、基地址、每个寄存器的读/写权限、寄存器的布局、寄存器是否具有保留位以及许多其他有用信息。</p>
<h1 id="LEDs-again"><a href="#LEDs-again" class="headerlink" title="LEDs, again"></a>LEDs, again</h1><p>在上一节中，我为您提供了<em>初始化</em>（配置）的外围设备（我在 中初始化了它们 <code>aux7::init</code>）。这就是为什么仅仅写入<code>BSRR</code>就足以控制 LED 的原因。但是，外设不会在微控制器启动后立即<em>初始化</em>。</p>
<p>在本节中，您将获得更多关于寄存器的乐趣。我不会做任何初始化，您必须将配置<code>GPIOE</code>引脚初始化为数字输出引脚，以便您能够再次驱动 LED。</p>
<p>这是入门代码。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>gpioe<span class="token punctuation">,</span> rcc<span class="token punctuation">)</span> <span class="token operator">=</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO initialize GPIOE</span>

    <span class="token comment" spellcheck="true">// Turn on all the LEDs in the compass</span>
    gpioe<span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">odr8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果您运行启动代码，您将看到这次没有任何反应。此外，如果您打印<code>GPIOE</code>寄存器块，您会看到即使在<code>gpioe.odr.write</code>执行语句之后，每个寄存器的读数都为零 ！</p>
<pre><code>$ cargo run
Breakpoint 1, main () at src/08-leds-again/src/main.rs:9
9           let (gpioe, rcc) = aux8::init();

(gdb) continue
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
0x08000f3c in __bkpt ()

(gdb) finish
Run till exit from #0  0x08000f3c in __bkpt ()
main () at src/08-leds-again/src/main.rs:25
25          aux8::bkpt();

(gdb) p/x *gpioe
$1 = stm32f30x::gpioc::RegisterBlock {
  moder: stm32f30x::gpioc::MODER {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  otyper: stm32f30x::gpioc::OTYPER {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  ospeedr: stm32f30x::gpioc::OSPEEDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  pupdr: stm32f30x::gpioc::PUPDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  idr: stm32f30x::gpioc::IDR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  odr: stm32f30x::gpioc::ODR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  bsrr: stm32f30x::gpioc::BSRR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  lckr: stm32f30x::gpioc::LCKR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  afrl: stm32f30x::gpioc::AFRL {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  afrh: stm32f30x::gpioc::AFRH {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  },
  brr: stm32f30x::gpioc::BRR {
    register: vcell::VolatileCell&lt;u32&gt; {
      value: core::cell::UnsafeCell&lt;u32&gt; {
        value: 0x0
      }
    }
  }
}</code></pre><h2 id="Power"><a href="#Power" class="headerlink" title="Power"></a>Power</h2><p>事实证明，为了省电，大多数外围设备都以断电状态启动——这是它们在微控制器启动后的状态。</p>
<p>复位和时钟控制 ( <code>RCC</code>) 外设可用于打开或关闭所有其他外设。</p>
<p>您可以在以下位置的<code>RCC</code>寄存器块中找到寄存器列表：</p>
<blockquote>
<p>第 9.4.14 节 - RCC 寄存器映射 - 第 166 页 - 参考手册</p>
</blockquote>
<p>控制其他外设电源状态的寄存器有：</p>
<ul>
<li><code>AHBENR</code></li>
<li><code>APB1ENR</code></li>
<li><code>APB2ENR</code></li>
</ul>
<p>这些寄存器中的每一位控制单个外设的电源状态，包括<code>GPIOE</code>.</p>
<p>您在本节中的任务是打开<code>GPIOE</code>外围设备的电源。你必须：</p>
<ul>
<li>找出我之前提到的三个寄存器中的哪一个具有控制电源状态的位。</li>
<li>弄清楚该位必须设置为什么值，<code>0</code>或者<code>1</code>，才能打开<code>GPIOE</code>外设。</li>
<li>最后，您必须更改启动代码以<em>修改</em>正确的寄存器以打开 <code>GPIOE</code>外设。</li>
</ul>
<p>如果成功，您将看到该<code>gpioe.odr.write</code>语句现在可以修改<code>ODR</code>寄存器的值。</p>
<p>请注意，这不足以实际打开 LED。</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>开启GPIOE外设后，还需要进行配置。在这种情况下，我们希望将引脚配置为数字<em>输出，</em>以便它们可以驱动 LED；默认情况下，大多数引脚配置为数字<em>输入</em>。</p>
<p>您可以在以下位置的<code>GPIOE</code>寄存器块中找到寄存器列表：</p>
<blockquote>
<p>第 11.4.12 节 - GPIO 寄存器 - 第 243 页 - 参考手册</p>
</blockquote>
<p>我们必须处理的寄存器是：<code>MODER</code>。</p>
<p>本节的任务是进一步更新启动器代码以将<em>正确的</em> <code>GPIOE</code> 引脚配置为数字输出。你必须：</p>
<ul>
<li>找出您需要将<em>哪些</em>引脚配置为数字输出。（提示：检查<em>用户手册</em>（第 18 页）的第 6.4 节 LED ）。</li>
<li>阅读文档以了解<code>MODER</code>寄存器中的位的作用。</li>
<li>修改<code>MODER</code>寄存器以将引脚配置为数字输出。</li>
</ul>
<p>如果成功，您将在运行程序时看到 8 个 LED 亮起。</p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>gpioe<span class="token punctuation">,</span> rcc<span class="token punctuation">)</span> <span class="token operator">=</span> aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// enable the GPIOE peripheral</span>
    rcc<span class="token punctuation">.</span>ahbenr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">iopeen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// configure the pins as outputs</span>
    gpioe<span class="token punctuation">.</span>moder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">moder8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">moder15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Turn on all the LEDs in the compass</span>
    gpioe<span class="token punctuation">.</span>odr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">odr8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr12</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr13</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr14</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">odr15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aux8<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Clocks-and-timers"><a href="#Clocks-and-timers" class="headerlink" title="Clocks and timers"></a>Clocks and timers</h1><p>在本节中，我们将重新实现 LED 轮盘赌应用程序。我将把<code>Led</code>抽象还给你， 但这次我要拿走<code>Delay</code>抽象<code>:-)</code>。</p>
<p>这是入门代码。该<code>delay</code>功能未实现，因此如果您运行该程序，LED 将闪烁得如此之快，以至于它们似乎总是亮着。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> tim6<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// TODO implement this</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> rcc<span class="token punctuation">,</span> tim6<span class="token punctuation">)</span> <span class="token operator">=</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO initialize TIM6</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="for-loop-delays"><a href="#for-loop-delays" class="headerlink" title="for loop delays"></a><code>for</code> loop delays</h2><p>第一个挑战是在<code>delay</code>不使用任何外设的情况下实现该功能，显而易见的解决方案是将其实现为<code>for</code>循环延迟：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然，上面的实现是错误的，因为它对于 的任何值总是产生相同的延迟<code>ms</code>。</p>
<p>在本节中，您必须：</p>
<ul>
<li>修复<code>delay</code>函数以生成与其输入成比例的延迟<code>ms</code>。</li>
<li>调整该<code>delay</code>功能，使 LED 轮盘赌以 4 秒（800 毫秒周期）内大约 5 个周期的速度旋转。</li>
<li>微控制器内部的处理器时钟频率为 72 MHz，并在一个“滴答”（一个时钟周期）内执行大多数指令。<code>for</code>您<em>认为</em>该<code>delay</code>函数必须执行多少 ( ) 个循环才能产生 1 秒的延迟？</li>
<li>实际上有多少个<code>for</code>循环<code>delay(1000)</code>？</li>
<li>如果在发布模式下编译您的程序并运行它会发生什么？</li>
</ul>
<h2 id="NOP"><a href="#NOP" class="headerlink" title="NOP"></a>NOP</h2><p>如果在上一节中您在发布模式下编译程序并实际查看了反汇编，您可能会注意到该<code>delay</code>函数已被优化掉并且永远不会在<code>main</code>.</p>
<p>LLVM 认为该函数没有做任何有价值的事情，只是将其删除。</p>
<p>有一种方法可以防止 LLVM 优化<code>for</code>循环延迟：添加<em>易失性</em>汇编指令。任何指令都可以，但在这种情况下 NOP（无操作）是一个特别好的选择，因为它没有副作用。</p>
<p>您的<code>for</code>循环延迟将变为：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>_tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> K<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// this value needs to be tweaked</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">(</span>K <span class="token operator">*</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>delay</code>当你在发布模式下编译你的程序时，这个时间不会被 LLVM 编译掉：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin clocks-and-timers --release -- -d --no-show-raw-insn
clocks-and-timers:      file format ELF32-arm-little

Disassembly of section .text:
clocks_and_timers::delay::h711ce9bd68a6328f:
 8000188:       push    {r4, r5, r7, lr}
 800018a:       movs    r4, #0
 800018c:       adds    r4, #1
 800018e:       uxth    r5, r4
 8000190:       bl      #4666
 8000194:       cmp     r5, #150
 8000196:       blo     #-14 <clocks_and_timers::delay::h711ce9bd68a6328f+0x4>
 8000198:       pop     {r4, r5, r7, pc}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，测试一下：在调试模式下编译程序并运行它，然后在发布模式下编译程序并运行它。它们之间有什么区别？您认为造成差异的主要原因是什么？你能想出一种方法让它们再次相等或至少更相似吗？</p>
<h2 id="One-shot-timer"><a href="#One-shot-timer" class="headerlink" title="One-shot timer"></a>One-shot timer</h2><p>我希望，到目前为止，我已经让您确信<code>for</code>循环延迟是实现延迟的一种糟糕方式。</p>
<p>现在，我们将使用<em>硬件计时器</em>实现延迟。（硬件）计时器的基本功能是……精确跟踪时间。定时器是另一个可供微控制器使用的外设。因此它可以使用寄存器进行控制。</p>
<p>我们使用的微控制器有几个（实际上超过 10 个）不同类型（基本、通用和高级定时器）的定时器可供使用。有些计时器 比其他计时器具有更高的<em>分辨率</em>（位数），而有些计时器不仅可以用于跟踪时间。</p>
<p>我们将使用其中一种<em>基本</em>计时器：<code>TIM6</code>. 这是我们微控制器中可用的最简单的定时器之一。基本计时器的文档在以下部分：</p>
<blockquote>
<p>第 22 节定时器 - 第 670 页 - 参考手册</p>
</blockquote>
<p>其寄存器记录在：</p>
<blockquote>
<p>第 22.4.9 节 TIM6/TIM7 寄存器映射 - 第 682 页 - 参考手册</p>
</blockquote>
<p>我们将在本节中使用的寄存器是：</p>
<ul>
<li><code>SR</code>，状态寄存器。</li>
<li><code>EGR</code>，事件生成寄存器。</li>
<li><code>CNT</code>，计数器寄存器。</li>
<li><code>PSC</code>，预分频寄存器。</li>
<li><code>ARR</code>，自动重载寄存器。</li>
</ul>
<p>我们将使用计时器作为<em>一次性</em>计时器。它有点像闹钟。我们将计时器设置为在一段时间后关闭，然后我们将等到计时器关闭。该文档将这种操作模式称为<em>单脉冲模式</em>。</p>
<p>以下是对基本定时器在单脉冲模式下配置时如何工作的描述：</p>
<ul>
<li>计数器由用户启用 ( <code>CR1.CEN = 1</code>)。</li>
<li>该<code>CNT</code>寄存器复位其值为零，并且，在每个刻度，其值被加一。</li>
<li>一旦<code>CNT</code>寄存器达到寄存器的值<code>ARR</code>，计数器将被硬件 ( <code>CR1.CEN = 0</code>)禁用并引发<em>更新事件</em>( <code>SR.UIF = 1</code>)。</li>
</ul>
<p><code>TIM6</code>由 APB1 时钟驱动，其频率不必与处理器频率匹配。也就是说，APB1 时钟可以运行得更快或更慢。但是，默认设置是 APB1 和处理器的时钟频率均为 8 MHz。</p>
<p>在单脉冲模式的功能描述中提到的刻度是<em>不</em>一样的APB1时钟的一个刻度。的<code>CNT</code>在频率寄存器增加<code>apb1 / (psc + 1)</code> 每秒，其中倍<code>apb1</code>是APB1时钟的频率和<code>psc</code>在预分频寄存器的值，<code>PSC</code>。</p>
<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><p>与其他所有外设一样，我们必须先初始化此计时器，然后才能使用它。和上一节一样，初始化将涉及两个步骤：启动定时器，然后配置它。</p>
<p>启动定时器很容易：我们只需将<code>TIM6EN</code>位设置为 1。该位位于寄存器块<code>APB1ENR</code> 的<code>RCC</code>寄存器中。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Power on the TIM6 timer</span>
    rcc<span class="token punctuation">.</span>apb1enr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tim6en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>配置部分稍微复杂一些。</p>
<p>首先，我们必须将定时器配置为以单脉冲模式运行。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// OPM Select one pulse mode</span>
    <span class="token comment" spellcheck="true">// CEN Keep the counter disabled for now</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">opm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后，我们希望<code>CNT</code>计数器以 1 KHz 的频率运行，因为我们的<code>delay</code> 函数将毫秒数作为参数，而 1 KHz 会产生 1 毫秒的周期。为此，我们必须配置预分频器。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Configure the prescaler to have the counter operate at 1 KHz</span>
    tim6<span class="token punctuation">.</span>psc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">psc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>psc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我会让你弄清楚预分频器的值，<code>psc</code>. 请记住，计数器的频率是<code>apb1 / (psc + 1)</code>和该<code>apb1</code>是8MHz。</p>
<h2 id="Busy-waiting"><a href="#Busy-waiting" class="headerlink" title="Busy waiting"></a>Busy waiting</h2><p>计时器现在应该正确初始化。剩下的就是<code>delay</code>使用定时器来实现该功能。</p>
<p>我们要做的第一件事是设置自动重载寄存器 ( <code>ARR</code>) 以使计时器以<code>ms</code> 毫秒为单位结束。由于计数器以 1 KHz 运行，因此自动重载值将与 相同<code>ms</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Set the timer to go off in `ms` ticks</span>
    <span class="token comment" spellcheck="true">// 1 tick = 1 ms</span>
    tim6<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接下来，我们需要启用计数器。它将立即开始计数。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// CEN: Enable the counter</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在我们需要等到计数器达到自动重载寄存器的值<code>ms</code>，然后我们就会知道<code>ms</code>毫秒已经过去了。这种情况称为<em>更新事件</em>，它由<code>UIF</code>状态寄存器 ( <code>SR</code>)的位指示。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Wait until the alarm goes off (until the update event occurs)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这种只等待直到满足某些条件（在这种情况下<code>UIF</code>变为<code>1</code>）的模式称为<em>忙等待</em>，您将在本文中多次看到它<code>:-)</code>。</p>
<p>最后，我们必须清除（设置为<code>0</code>）该<code>UIF</code>位。如果我们不这样做，下次我们进入该<code>delay</code> 函数时，我们会认为更新事件已经发生并跳过忙等待部分。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Clear the update event flag</span>
    tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在，将所有这些放在一起并检查它是否按预期工作。</p>
<h2 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> tim6<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tim6<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span> ms<span class="token punctuation">:</span> u16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set the timer to go off in `ms` ticks</span>
    <span class="token comment" spellcheck="true">// 1 tick = 1 ms</span>
    tim6<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// CEN: Enable the counter</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Wait until the alarm goes off (until the update event occurs)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Clear the update event flag</span>
    tim6<span class="token punctuation">.</span>sr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">uif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> rcc<span class="token punctuation">,</span> tim6<span class="token punctuation">)</span> <span class="token operator">=</span> aux9<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Power on the TIM6 timer</span>
    rcc<span class="token punctuation">.</span>apb1enr<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token punctuation">,</span> w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tim6en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// OPM Select one pulse mode</span>
    <span class="token comment" spellcheck="true">// CEN Keep the counter disabled for now</span>
    tim6<span class="token punctuation">.</span>cr1<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">opm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Configure the prescaler to have the counter operate at 1 KHz</span>
    <span class="token comment" spellcheck="true">// APB1_CLOCK = 8 MHz</span>
    <span class="token comment" spellcheck="true">// PSC = 7999</span>
    <span class="token comment" spellcheck="true">// 8 MHz / (7999 + 1) = 1 KHz</span>
    <span class="token comment" spellcheck="true">// The counter (CNT) will increase on every millisecond</span>
    tim6<span class="token punctuation">.</span>psc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">psc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">7_999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> curr <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">8</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>

            leds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
            leds<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>tim6<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Serial-communication"><a href="#Serial-communication" class="headerlink" title="Serial communication"></a>Serial communication</h1><p><img src="/images/loading.gif" data-original="../images/language/800px-Serial_port.jpg" alt=""></p>
<p><em>这就是我们将要使用的。我希望你的电脑有一个！</em></p>
<p>呐，别担心。这种连接器 DE-9 很久以前在 PC 上已经过时了。它被通用串行总线 (USB) 取代。我们不会处理 DE-9 连接器本身，而是处理该电缆通常用于/通常用于的通信协议。</p>
<p>那么这个<a href="https://en.wikipedia.org/wiki/Asynchronous_serial_communication" target="_blank" rel="noopener"><em>串行通信</em></a>是什么？它是一种<em>异步</em>通信协议，其中两个设备使用两条数据线（加上一个公共接地）<em>串行</em>交换数据，就像一次一位一样。该协议是异步的，因为共享线路都不携带时钟信号。相反，双方必须在通信发生<em>之前</em>就沿线路发送数据的速度达成一致。该协议允许<em>双工</em>通信，因为数据可以同时从 A 发送到 B 和从 B 发送到 A。</p>
<p>我们将使用此协议在微控制器和您的计算机之间交换数据。与我们之前使用的 ITM 协议相比，通过串行通信协议，您可以将数据从计算机发送到微控制器。</p>
<p>您可能要问的下一个实际问题是：我们通过该协议发送数据的速度有多快？</p>
<p>该协议适用于帧。每个帧有一个<em>起始</em>位、5 到 9 位有效载荷（数据）和 1 到 2 个<em>停止位</em>。协议的速度称为<em>波特率</em>，以每秒位数 (bps) 为单位。常见的波特率有：9600、19200、38400、57600 和 115200 bps。</p>
<p>实际回答这个问题：使用 1 个起始位、8 个数据位、1 个停止位和 115200 bps 的波特率的常见配置，理论上可以每秒发送 11,520 帧。由于每一帧都携带一个字节的数据，因此数据速率为 11.52 KB/s。实际上，由于通信较慢端（微控制器）的处理时间，数据速率可能会较低。</p>
<p>今天的计算机不支持串行通信协议。所以你不能直接将计算机连接到微控制器。但这就是串行模块的用武之地。该模块将位于两者之间，并为微控制器提供一个串行接口，并为您的计算机提供一个 USB 接口。微控制器会将您的计算机视为另一个串行设备，而您的计算机会将微控制器视为虚拟串行设备。</p>
<h2 id="nix-tooling"><a href="#nix-tooling" class="headerlink" title="*nix tooling"></a>*nix tooling</h2><h3 id="发现板的更新版本"><a href="#发现板的更新版本" class="headerlink" title="发现板的更新版本"></a>发现板的更新版本</h3><p>在更新版本中，如果您将发现板连接到您的计算机，您应该会看到一个新的 TTY 设备出现在<code>/dev</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Linux
$ dmesg | tail | grep -i tty
[13560.675310] cdc_acm 1-1.1:1.2: ttyACM0: USB ACM device<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这是 USB &lt;-&gt; 串行设备。在 Linux 上，它被命名为<code>tty*</code>（通常为 <code>ttyACM*</code>或<code>ttyUSB*</code>）。</p>
<p>如果您没有看到设备出现，那么您可能有一个较旧的电路板版本；检查下一节，其中包含有关旧版本的说明。如果您有较新的修订版，请跳过下一部分并移至“minicom”部分。</p>
<h3 id="发现板-外部串行模块的旧版本"><a href="#发现板-外部串行模块的旧版本" class="headerlink" title="发现板/外部串行模块的旧版本"></a>发现板/外部串行模块的旧版本</h3><p>将串行模块连接到您的计算机，让我们找出操作系统为其分配的名称。</p>
<blockquote>
<p><strong>注意</strong>在 Mac 上，USB 设备将命名为：<code>/dev/cu.usbserial-*</code>. 您不会使用 找到它<code>dmesg</code>，而是相应地使用<code>ls -l /dev | grep cu.usb</code>和调整以下命令！</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ dmesg | grep -i tty
(..)
[  +0.000155] usb 3-2: FTDI USB Serial Device converter now attached to ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>但这是什么<code>ttyUSB0</code>东西？当然是文件啦！一切都是 *nix 中的文件：</p>
<pre class="line-numbers language-console"><code class="language-console">$ ls -l /dev/ttyUSB0
crw-rw-rw- 1 root uucp 188, 0 Oct 27 00:00 /dev/ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>如果上述权限是<code>crw-rw----</code>udev 规则未正确设置请参阅<a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">udev 规则</a></p>
</blockquote>
<p>您可以通过简单地写入此文件来发送数据：</p>
<pre class="line-numbers language-console"><code class="language-console">$ echo 'Hello, world!' > /dev/ttyUSB0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>您应该看到串行模块上的 TX（红色）LED 闪烁一次，而且速度非常快！</p>
<h3 id="所有版本：minicom"><a href="#所有版本：minicom" class="headerlink" title="所有版本：minicom"></a>所有版本：minicom</h3><p>处理使用的串行设备<code>echo</code>远非符合人体工程学。因此，我们将使用该程序<code>minicom</code> 通过键盘与串行设备进行交互。</p>
<p>我们必须<code>minicom</code>在使用之前进行配置。有很多方法可以做到这一点，但我们将使用<code>.minirc.dfl</code>主目录中的 文件。<code>~/.minirc.dfl</code>使用以下内容创建一个文件：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ~/.minirc.dfl
pu baudrate 115200
pu bits 8
pu parity N
pu stopbits 1
pu rtscts No
pu xonxoff No<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>确保此文件以换行符结尾！否则，<code>minicom</code>将无法阅读。</p>
</blockquote>
<p>该文件应该很容易阅读（除了最后两行），但让我们逐行阅读：</p>
<ul>
<li><code>pu baudrate 115200</code>. 将波特率设置为 115200 bps。</li>
<li><code>pu bits 8</code>. 每帧 8 位。</li>
<li><code>pu parity N</code>. 没有奇偶校验。</li>
<li><code>pu stopbits 1</code>. 1 个停止位。</li>
<li><code>pu rtscts No</code>. 没有硬件控制流。</li>
<li><code>pu xonxoff No</code>. 没有软件控制流程。</li>
</ul>
<p>一旦到位，我们就可以启动<code>minicom</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ # NOTE you may need to use a different device here
$ minicom -D /dev/ttyACM0 -b 115200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这告诉<code>minicom</code>打开串行设备<code>/dev/ttyACM0</code>并将其波特率设置为 115200。基于文本的用户界面 (TUI) 将弹出。</p>
<p><img src="/images/loading.gif" data-original="../images/language/minicom.png" alt=""></p>
<p>您现在可以使用键盘发送数据了！继续输入一些东西。请注意，TUI<em>不会</em>回显您键入的内容，但是，如果您使用的是外部模块，您<em>可能会</em>看到模块上的一些 LED 随每次按键而闪烁。</p>
<h3 id="minicom-命令"><a href="#minicom-命令" class="headerlink" title="minicom 命令"></a><code>minicom</code> 命令</h3><p><code>minicom</code>通过键盘快捷键公开命令。在 Linux 上，快捷方式以<code>Ctrl+A</code>. 在 Mac 上，快捷键以键开头<code>Meta</code>。一些有用的命令如下：</p>
<ul>
<li><code>Ctrl+A</code>+ <code>Z</code>。Minicom 命令总结</li>
<li><code>Ctrl+A</code>+ <code>C</code>。清屏</li>
<li><code>Ctrl+A</code>+ <code>X</code>。退出并重置</li>
<li><code>Ctrl+A</code>+ <code>Q</code>。退出而不重置</li>
</ul>
<blockquote>
<p><strong>注意</strong>mac 用户：在上面的命令中，替换<code>Ctrl+A</code>为<code>Meta</code>.</p>
</blockquote>
<h2 id="Windows-tooling"><a href="#Windows-tooling" class="headerlink" title="Windows tooling"></a>Windows tooling</h2><p>首先拔下您的发现板。</p>
<p>在插入发现板或串口模块之前，请在终端上运行以下命令：</p>
<pre class="line-numbers language-console"><code class="language-console">$ mode<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>它将打印连接到您的计算机的设备列表。与启动的人<code>COM</code>在他们的名字是串口设备。这是我们将使用的设备类型。<em>在</em>插入串行模块<em>之前，*请记下所有<code>COM</code> *端口</em> <code>mode</code>输出。</p>
<p>现在，插入发现板并<code>mode</code>再次运行命令。如果您看到<code>COM</code>列表中出现了一个新 端口，那么您就有了一个较新的发现版本，这是分配给发现中串行功能的 COM 端口。你可以跳过下一段。</p>
<p>如果您没有获得新的 COM 端口，那么您可能有一个较旧的发现版本。现在插入串口模块；您应该会看到新的 COM 端口出现；那是串行模块的COM端口。</p>
<p>现在启动<code>putty</code>。将弹出一个 GUI。</p>
<p><img src="/images/loading.gif" data-original="../images/language/putty-settings.png" alt=""></p>
<p>在应该打开“会话”类别的启动屏幕上，选择“串行”作为“连接类型”。在“串行线路”字段中输入<code>COM</code>您在上一步中获得的设备，例如<code>COM3</code>。</p>
<p>接下来，从左侧菜单中选择“连接/串行”类别。在这个新视图中，确保串口配置如下：</p>
<ul>
<li>“速度（波特）”：115200</li>
<li>“数据位”：8</li>
<li>“停止位”：1</li>
<li>“奇偶校验”：无</li>
<li>“流量控制”：无</li>
</ul>
<p>最后，点击打开按钮。现在会出现一个控制台：</p>
<p><img src="/images/loading.gif" data-original="../images/language/putty-console.png" alt=""></p>
<p>如果您在此控制台上键入，串行模块上的 TX（红色）LED 应闪烁。每次击键都应使 LED 闪烁一次。请注意，控制台不会回显您键入的内容，因此屏幕将保持空白。</p>
<h2 id="Loopbacks"><a href="#Loopbacks" class="headerlink" title="Loopbacks"></a>Loopbacks</h2><p>我们已经测试了发送数据。是时候测试接收它了。除了没有其他设备可以向我们发送一些数据……或者有吗？</p>
<p>输入：环回</p>
<p><img src="/images/loading.gif" data-original="../images/language/serial-loopback.png" alt="串行模块环回"></p>
<p>您可以向自己发送数据！在生产中不是很有用，但对调试非常有用。</p>
<h3 id="旧板修订版-外部串行模块"><a href="#旧板修订版-外部串行模块" class="headerlink" title="旧板修订版/外部串行模块"></a>旧板修订版/外部串行模块</h3><p>如上图所示，使用公对公跳线将串行模块的<code>TXO</code>和<code>RXI</code>引脚连接在一起。</p>
<p>现在在 minicom/PuTTY 中输入一些文本并观察。发生什么了？</p>
<p>你应该看到三件事：</p>
<ul>
<li>和以前一样，每次按下按键时 TX（红色）LED 都会闪烁。</li>
<li>但现在 RX（绿色）LED 也会在每次按键时闪烁！这表示串口模块正在接收一些数据；它刚刚发送的那个。</li>
<li>最后，在 minicom/PuTTY 控制台上，您应该看到您键入的内容回显到控制台。</li>
</ul>
<h3 id="Newer-board-revision"><a href="#Newer-board-revision" class="headerlink" title="Newer board revision"></a>Newer board revision</h3><p>如果您有较新版本的电路板，您可以通过使用母对母跳线将 PC4 和 PC5 引脚短路来设置环回，就像您对 SWO 引脚所做的那样。</p>
<p>您现在应该可以向自己发送数据了。</p>
<p>现在尝试在 minicom/PuTTY 中输入一些文本并观察。</p>
<blockquote>
<p><strong>注意</strong>：为了排除现有固件对串行引脚（PC4 和 PC5）执行奇怪操作的可能性，我们建议您在向 minicom/PuTTY 中输入文本时<em>按住</em>重置按钮。</p>
</blockquote>
<p>如果一切正常，您应该看到您键入的内容回显到 minicom/PuTTY 控制台。</p>
<h1 id="USART-1"><a href="#USART-1" class="headerlink" title="USART"></a>USART</h1><p>微控制器有一个称为 USART 的外设，它代表通用同步/异步接收器/发送器。该外设可以配置为使用多种通信协议，如串行通信协议。</p>
<p>在本章中，我们将使用串行通信在微控制器和计算机之间交换信息。但在我们这样做之前，我们必须把所有东西都连接起来。</p>
<p>我之前提到过，这个协议涉及两条数据线：TX 和 RX。TX代表发射器，RX代表接收器。发射器和接收器虽然是相对术语；哪条线路是发送器，哪条线路是接收器，取决于您从通信的哪一侧查看线路。</p>
<h3 id="Newer-board-revisions"><a href="#Newer-board-revisions" class="headerlink" title="Newer board revisions"></a>Newer board revisions</h3><p>如果您有较新版本的电路板并使用板载 USB &lt;-&gt; 串行功能，那么<code>auxiliary</code>板条箱会将引脚设置<code>PC4</code>为 TX 线，将引脚设置<code>PC5</code>为 RX 线。</p>
<p>板上的所有东西都已经接线，因此您无需自己接线。</p>
<h3 id="较旧的电路板修订版-外部串行模块"><a href="#较旧的电路板修订版-外部串行模块" class="headerlink" title="较旧的电路板修订版/外部串行模块"></a>较旧的电路板修订版/外部串行模块</h3><p>如果您使用的是外部USB &lt; - &gt;串行模块，那么你将<strong>需要</strong>启用<code>adapter</code>的特征<code>aux11</code>在箱子的依赖<code>Cargo.toml</code>。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies.aux11]
path = "auxiliary"
# enable this if you are going to use an external serial adapter
features = ["adapter"] # <- uncomment this<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将使用该引脚<code>PA9</code>作为微控制器的 TX 线和<code>PA10</code>它的 RX 线。换句话说，引脚将<code>PA9</code>数据输出到其线路上，而引脚<code>PA10</code>在其线路上侦听数据。</p>
<p>我们可以使用不同的引脚对作为 TX 和 RX 引脚。<a href="http://www.st.com/resource/en/datasheet/stm32f303vc.pdf" target="_blank" rel="noopener">数据表</a>第 44 页中有一个表格 ，列出了我们可以使用的所有其他可能的引脚。</p>
<p>串行模块也有 TX 和 RX 引脚。我们必须<em>交叉</em>这些引脚：即将微控制器的 TX 引脚连接到串行模块的 RX 引脚，将微控制器的 RX 引脚连接到串行模块的 TX 引脚。下面的接线图显示了所有必要的连接。</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-serial.png" alt=""></p>
<p>这些是连接微控制器和串行模块的推荐步骤：</p>
<ul>
<li>关闭 OpenOCD 和 <code>itmdump</code></li>
<li>断开 USB 电缆与 F3 和串行模块的连接。</li>
<li>使用母对公 (F/M) 线将 F3 GND 引脚之一连接到串行模块的 GND 引脚。最好是黑色的。</li>
<li>使用 F/M 线将 F3 背面的 PA9 引脚连接到串行模块的 RXI 引脚。</li>
<li>使用 F/M 线将 F3 背面的 PA10 引脚连接到串行模块的 TXO 引脚。</li>
<li>现在将 USB 电缆连接到 F3。</li>
<li>最后将 USB 电缆连接到串行模块。</li>
<li>重新启动 OpenOCD 和 <code>itmdump</code></li>
</ul>
<p>一切都已接好！让我们继续来回发送数据。</p>
<h2 id="Send-a-single-byte"><a href="#Send-a-single-byte" class="headerlink" title="Send a single byte"></a>Send a single byte</h2><p>我们的第一个任务是通过串行连接从微控制器向计算机发送一个字节。</p>
<p>这一次，我将为您提供一个已经初始化的 USART 外设。您只需使用负责发送和接收数据的寄存器。</p>
<p>进入<code>11-usart</code>目录，让我们在其中运行启动代码。确保您已打开 minicom/PuTTY。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send a single character</span>
    usart1
        <span class="token punctuation">.</span>tdr
        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">b'X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该程序写入<code>TDR</code>寄存器。这会导致<code>USART</code>外设通过串行接口发送一个字节的信息。</p>
<p>在接收端，您的计算机上，您应该看到显示字符<code>X</code>出现在 minicom/PuTTY 的终端上。</p>
<h2 id="Send-a-string"><a href="#Send-a-string" class="headerlink" title="Send a string"></a>Send a string</h2><p>下一个任务是将整个字符串从微控制器发送到您的计算机。</p>
<p>我希望您将字符串<code>"The quick brown fox jumps over the lazy dog."</code>从微控制器发送到您的计算机。</p>
<p>轮到你编写程序了。</p>
<p>在调试器中逐句执行您的程序。你看到了什么？</p>
<p>然后再次执行该程序，但<em>一次性</em>使用该<code>continue</code>命令。这次会发生什么？</p>
<p>最后，在<em>发布</em>模式下构建程序，并再次一次性运行它。这次会发生什么？</p>
<h2 id="Overruns"><a href="#Overruns" class="headerlink" title="Overruns"></a>Overruns</h2><p>如果你这样写你的程序：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usart1
            <span class="token punctuation">.</span>tdr
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当您执行在调试模式下编译的程序时，您可能会在计算机上收到类似的信息。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom's terminal
(..)
The uic brwn oxjums oer helaz do.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果你在发布模式下编译，你可能只会得到这样的东西：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom's terminal
(..)
T<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>什么地方出了错？</p>
<p>您会看到，通过线路发送字节需要相对大量的时间。我已经做了数学，所以让我引用自己的话：</p>
<blockquote>
<p>使用 1 个起始位、8 个数据位、1 个停止位和 115200 bps 的波特率的常见配置，理论上可以每秒发送 11,520 帧。由于每一帧都携带一个字节的数据，因此数据速率为 11.52 KB/s</p>
</blockquote>
<p>我们的 pangram 有 45 个字节的长度。这意味着<code>45 bytes / (11,520 bytes/s) = 3,906 us</code>发送字符串至少需要 3,900 微秒 ( )。处理器的工作频率为 8 MHz，执行一条指令需要 125 纳秒，因此很可能<code>for</code> 在不到 3,900 微秒的时间内完成循环。</p>
<p>我们实际上可以计算执行<code>for</code>循环所需的时间。<code>aux11::init()</code>返回一个 <code>MonoTimer</code>（单调计时器）值，该值公开一个<code>Instant</code>类似于 <code>std::time</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> instant <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usart1<span class="token punctuation">.</span>tdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> elapsed <span class="token operator">=</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in ticks</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"`for` loop took {} ticks ({} us)"</span><span class="token punctuation">,</span>
        elapsed<span class="token punctuation">,</span>
        elapsed <span class="token keyword">as</span> f32 <span class="token operator">/</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">1e6</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在调试模式下，我得到：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
`for` loop took 22415 ticks (2801.875 us)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这不到 3,900 微秒，但相距不远，这就是为什么只有几个字节的信息丢失的原因。</p>
<p>总之，处理器试图以比硬件实际处理速度更快的速度发送字节，这会导致数据丢失。这种情况称为缓冲区<em>溢出</em>。</p>
<p>我们如何避免这种情况？状态寄存器 ( <code>ISR</code>) 有一个标志 ，<code>TXE</code>指示写入<code>TDR</code>寄存器是否“安全”而不会导致数据丢失。</p>
<p>让我们用它来减慢处理器的速度。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> instant <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Send a string</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"The quick brown fox jumps over the lazy dog."</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// wait until it's safe to write to TDR</span>
        <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>

        usart1
            <span class="token punctuation">.</span>tdr
            <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> elapsed <span class="token operator">=</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in ticks</span>

    <span class="token function">iprintln!</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"`for` loop took {} ticks ({} us)"</span><span class="token punctuation">,</span>
        elapsed<span class="token punctuation">,</span>
        elapsed <span class="token keyword">as</span> f32 <span class="token operator">/</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">1e6</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一次，在调试或发布模式下运行程序应该会在接收端产生一个完整的字符串。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # minicom/PuTTY's console
(..)
The quick brown fox jumps over the lazy dog.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>for</code>循环的时间也应该更接近理论的 3,900 微秒。下面的时间是针对调试版本的。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
`for` loop took 30499 ticks (3812.375 us)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="uprintln"><a href="#uprintln" class="headerlink" title="uprintln!"></a><code>uprintln!</code></h2><p>在下一个练习中，我们将实现<code>uprint!</code>宏系列。你的目标是让这行代码工作：</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token function">uprintln!</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span> <span class="token string">"The answer is {}"</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中必须<code>"The answer is 42"</code>通过串行接口发送字符串。</p>
<p>我们该怎么做？这是信息寻找到<code>std</code>的执行<code>println!</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/libstd/macros.rs</span>
<span class="token macro-rules function">macro_rules!</span> print <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>$<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>io<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">_print</span><span class="token punctuation">(</span><span class="token function">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>到目前为止看起来很简单。我们需要内置<code>format_args!</code>宏（它在编译器中实现，所以我们看不到它实际做了什么）。我们必须以完全相同的方式使用该宏。这个 <code>_print</code>函数有什么作用？</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/libstd/io/stdio.rs</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">_print</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">match</span> LOCAL_STDOUT<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Uninitialized <span class="token operator">|</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Destroyed <span class="token operator">=</span><span class="token operator">></span> <span class="token function">stdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span>
        LocalKeyState<span class="token punctuation">:</span><span class="token punctuation">:</span>Valid <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            LOCAL_STDOUT<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>s<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">borrow_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BorrowState<span class="token punctuation">:</span><span class="token punctuation">:</span>Unused <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> w<span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">stdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> result <span class="token punctuation">{</span>
        <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"failed printing to stdout: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这<em>看起来很</em>复杂，但我们唯一感兴趣的部分是：<code>w.write_fmt(args)</code>和 <code>stdout().write_fmt(args)</code>。是什么<code>print!</code>最终所做的就是调用<code>fmt::Write::write_fmt</code>方法与输出<code>format_args!</code>作为它的参数。</p>
<p>幸运的是，我们也不必实现该<code>fmt::Write::write_fmt</code>方法，因为它是默认方法。我们只需要实现这个<code>fmt::Write::write_str</code>方法。</p>
<p>让我们这样做。</p>
<p>这就是等式的宏观方面的样子。剩下要做的就是提供<code>write_str</code>方法的实现。</p>
<p>在上面我们看到<code>Write</code>在<code>std::fmt</code>. 我们无法访问<code>std</code>但<code>Write</code>也可以在<code>core::fmt</code>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> Write<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> usart1<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro-rules function">macro_rules!</span> uprint <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        $serial<span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span><span class="token function">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro-rules function">macro_rules!</span> uprintln <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $fmt<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">uprint!</span><span class="token punctuation">(</span>$serial<span class="token punctuation">,</span> <span class="token function">concat!</span><span class="token punctuation">(</span>$fmt<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$serial<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $fmt<span class="token punctuation">:</span>expr<span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">:</span>tt<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">uprint!</span><span class="token punctuation">(</span>$serial<span class="token punctuation">,</span> <span class="token function">concat!</span><span class="token punctuation">(</span>$fmt<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span>$arg<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> SerialPort <span class="token punctuation">{</span>
    usart1<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> usart1<span class="token punctuation">:</span><span class="token punctuation">:</span>RegisterBlock<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write <span class="token keyword">for</span> SerialPort <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">write_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">-></span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Result <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO implement this</span>
        <span class="token comment" spellcheck="true">// hint: this will look very similar to the previous program</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> serial <span class="token operator">=</span> SerialPort <span class="token punctuation">{</span> usart1 <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">uprintln!</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span> <span class="token string">"The answer is {}"</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Receive-a-single-byte"><a href="#Receive-a-single-byte" class="headerlink" title="Receive a single byte"></a>Receive a single byte</h2><p>到目前为止，我们已经将数据从微控制器发送到您的计算机。是时候尝试相反的方法了：从您的计算机接收数据。</p>
<p>有一个<code>RDR</code>寄存器将填充来自 RX 线的数据。如果我们读取该寄存器，我们将检索通道另一端发送的数据。问题是：我们怎么知道我们收到了（新的）数据？状态寄存器 ，<code>ISR</code>，有一个用于此目的的位： <code>RXNE</code>。我们可以忙着等待那面旗帜。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Wait until there's data available</span>
        <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Retrieve the data</span>
        <span class="token keyword">let</span> _byte <span class="token operator">=</span> usart1<span class="token punctuation">.</span>rdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u8<span class="token punctuation">;</span>

        aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们试试这个程序吧！让它自由运行<code>continue</code>，然后在 minicom/PuTTY 的控制台中输入一个字符。发生什么了？<code>_byte</code>变量的内容是什么？</p>
<pre><code>(gdb) continue
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
0x8003d48 in __bkpt ()

(gdb) finish
Run till exit from #0  0x8003d48 in __bkpt ()
usart::main () at src/11-usart/src/main.rs:19
19              aux11::bkpt();

(gdb) p/c _byte
$1 = 97 'a'</code></pre><h2 id="Echo-server"><a href="#Echo-server" class="headerlink" title="Echo server"></a>Echo server</h2><p>让我们将传输和接收合并到一个程序中并编写一个回显服务器。回显服务器将它发送的相同文本发送回客户端。对于此应用程序，微控制器将作为服务器，而您和您的计算机将作为客户端。</p>
<p>这应该很容易实现。（提示：逐字节执行）</p>
<h2 id="Reverse-a-string"><a href="#Reverse-a-string" class="headerlink" title="Reverse a string"></a>Reverse a string</h2><p>好的，接下来让我们让服务器更有趣，让服务器用客户端发送的文本的反向响应客户端。每次他们按下 ENTER 键时，服务器都会响应客户端。每个服务器响应将在一个新行中。</p>
<p>这次你需要一个缓冲区；你可以使用<a href="https://docs.rs/heapless/0.2.1/heapless/struct.Vec.html" target="_blank" rel="noopener"><code>heapless::Vec</code></a>. 这是入门代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A buffer with 32 bytes of capacity</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// TODO Receive a user request. Each user request ends with ENTER</span>
        <span class="token comment" spellcheck="true">// NOTE `buffer.push` returns a `Result`. Handle the error by responding</span>
        <span class="token comment" spellcheck="true">// with an error message.</span>

        <span class="token comment" spellcheck="true">// TODO Send back the reversed string</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="My-solution-1"><a href="#My-solution-1" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> heapless<span class="token punctuation">:</span><span class="token punctuation">:</span>Vec<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>usart1<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux11<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A buffer with 32 bytes of capacity</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">></span> <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">let</span> byte <span class="token operator">=</span> usart1<span class="token punctuation">.</span>rdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u8<span class="token punctuation">;</span>

            <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// buffer full</span>
                <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token string">b"error: buffer full\n\r"</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                    usart1
                        <span class="token punctuation">.</span>tdr
                        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Carriage return</span>
            <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token number">13</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Respond</span>
                <span class="token keyword">for</span> byte <span class="token keyword">in</span> buffer<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">b'\n'</span><span class="token punctuation">,</span> <span class="token string">b'\r'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">while</span> usart1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                    usart1
                        <span class="token punctuation">.</span>tdr
                        <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">tdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">*</span>byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Bluetooth-setup"><a href="#Bluetooth-setup" class="headerlink" title="Bluetooth setup"></a>Bluetooth setup</h1><p>是时候摆脱一些电线了。串行通信不仅可以在 USB 协议之上进行仿真；它也可以在蓝牙协议之上进行模拟。这种串行蓝牙协议称为 RFCOMM。</p>
<p>在我们将蓝牙模块与微控制器一起使用之前，让我们首先使用 minicom/PuTTY 与它进行交互。</p>
<p>我们需要做的第一件事是：打开蓝牙模块。我们将不得不使用以下连接向它分享一些 F3 功能：</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth-power-only.png" alt=""></p>
<p>连接它的推荐步骤是：</p>
<ul>
<li>关闭 OpenOCD 和 <code>itmdump</code></li>
<li>断开 USB 电缆与 F3 和串行模块的连接。</li>
<li>使用母对母 (F/F) 线将 F3 的 GND 引脚连接到蓝牙的 GND 引脚。最好是黑色的。</li>
<li>使用 F/F 线将 F3 的 5V 引脚连接到蓝牙的 VCC 引脚。最好是红色的。</li>
<li>然后，将 USB 电缆连接回 F3。</li>
<li>重新启动 OpenOCD 和 <code>itmdump</code></li>
</ul>
<p>在您打开 F3 板的电源后，蓝牙模块上的两个 LED（一个蓝色和一个红色）应立即开始闪烁。</p>
<p>接下来要做的是配对您的计算机和蓝牙模块。AFAIK、Windows 和 mac 用户可以简单地使用他们的操作系统默认蓝牙管理器进行配对。蓝牙模块默认引脚为 1234。</p>
<p>Linux 用户必须遵循（部分）<a href="https://docs.rust-embedded.org/discovery/12-bluetooth-setup/linux.html" target="_blank" rel="noopener">这些说明</a>。</p>
<h2 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h2><p>如果您有图形蓝牙管理器，您可以使用它来将您的计算机与蓝牙模块配对并跳过这些步骤中的大部分。</p>
<p>首先，您计算机的蓝牙收发器可能已关闭。检查其状态<code>hciconfig</code>并在必要时将其打开：</p>
<pre class="line-numbers language-console"><code class="language-console">$ hciconfig
hci0:   Type: Primary  Bus: USB
        BD Address: 68:17:29:XX:XX:XX  ACL MTU: 310:10  SCO MTU: 64:8
        DOWN  <--
        RX bytes:580 acl:0 sco:0 events:31 errors:0
        TX bytes:368 acl:0 sco:0 commands:30 errors:0

$ sudo hciconfig hci0 up

$ hciconfig
hci0:   Type: Primary  Bus: USB
        BD Address: 68:17:29:XX:XX:XX  ACL MTU: 310:10  SCO MTU: 64:8
        UP RUNNING  <--
        RX bytes:1190 acl:0 sco:0 events:67 errors:0
        TX bytes:1072 acl:0 sco:0 commands:66 errors:0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后你需要启动 BlueZ（蓝牙）守护进程：</p>
<ul>
<li>在基于 systemd 的 Linux 发行版上，使用：</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ sudo systemctl start bluetooth<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>在 Ubuntu（或基于新贵的 Linux 发行版）上，使用：</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ sudo /etc/init.d/bluetooth start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>您可能还需要解锁蓝牙，具体取决于以下内容<code>rfkill list</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rfkill list
9: hci0: Bluetooth
        Soft blocked: yes # <--
        Hard blocked: no

$ sudo rfkill unblock bluetooth

$ rfkill list
9: hci0: Bluetooth
        Soft blocked: no  # <--
        Hard blocked: no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><pre class="line-numbers language-console"><code class="language-console">$ hcitool scan
Scanning ...
        20:16:05:XX:XX:XX       Ferris
$ #                             ^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="一对"><a href="#一对" class="headerlink" title="一对"></a>一对</h3><pre class="line-numbers language-console"><code class="language-console">$ bluetoothctl
[bluetooth]# scan on
[bluetooth]# agent on
[bluetooth]# pair 20:16:05:XX:XX:XX
Attempting to pair with 20:16:05:XX:XX:XX
[CHG] Device 20:16:05:XX:XX:XX Connected: yes
Request PIN code
[agent] Enter PIN code: 1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="射频通信设备"><a href="#射频通信设备" class="headerlink" title="射频通信设备"></a>射频通信设备</h3><p>我们将为我们的蓝牙模块创建一个设备文件<code>/dev</code>。然后我们就可以像使用<code>/dev/ttyUSB0</code>.</p>
<pre class="line-numbers language-console"><code class="language-console">$ sudo rfcomm bind 0 20:16:05:XX:XX:XX<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>因为我们用作<code>0</code>参数<code>bind</code>,<code>/dev/rfcomm0</code>将是分配给我们的蓝牙模块的设备文件。</p>
<p>您可以随时使用以下命令释放（销毁）设备文件：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Don't actually run this command right now!
$ sudo rfcomm release 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="Loopback-again"><a href="#Loopback-again" class="headerlink" title="Loopback, again"></a>Loopback, again</h2><p>将您的计算机与蓝牙模块配对后，您的操作系统应该已经为您创建了一个设备文件/COM 端口。在 Linux 上，它应该是<code>/dev/rfcomm*</code>; 在 mac 上，应该是<code>/dev/cu.*</code>；在 Windows 上，它应该是一个新的 COM 端口。</p>
<p>我们现在可以使用 minicom/PuTTY 测试蓝牙模块。由于该模块没有像串行模块那样用于传输和接收事件的 LED 指示灯，我们将使用环回连接测试该模块：</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth-loopback.png" alt=""></p>
<p>只需使用 F/F 线将模块的 TXD 引脚连接到其 RXD 引脚即可。</p>
<p>现在，使用<code>minicom</code>/连接到设备<code>PuTTY</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">$ minicom -D /dev/rfcomm0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>连接后，蓝牙模块的闪烁模式应变为：长时间暂停然后快速闪烁两次。</p>
<p>在 minicom/PuTTY 终端内输入应该回显您输入的内容。</p>
<h2 id="AT-commands"><a href="#AT-commands" class="headerlink" title="AT commands"></a>AT commands</h2><p>蓝牙模块和 F3 需要配置为以相同的波特率进行通信。教程代码将UART1串口设备初始化为115200波特率。HC-05蓝牙模块默认配置为9600波特率。</p>
<p>蓝牙模块支持 AT 模式，允许您检查和更改其配置和设置。要使用 AT 模式，请将蓝牙模块连接到 F3 和 FTDI，如下图所示。</p>
<p><img src="/images/loading.gif" data-original="../images/language/bluetooth-serial.png" alt=""></p>
<p>进入AT模式的推荐步骤：</p>
<ul>
<li>断开 F3 和 FTDI 与计算机的连接。</li>
<li>使用母/母 (F/F) 线（最好是黑色的）将 F3 的 GND 引脚连接到蓝牙的 GND 引脚。</li>
<li>使用 F/F 线（最好是红色的）将 F3 的 5V 引脚连接到蓝牙的 VCC 引脚。</li>
<li>使用母/公 (F/M) 线将 FTDI RXI 引脚连接到蓝牙的 TXD 引脚。</li>
<li>使用母/公 (F/M) 线将 FTDI TXO 引脚连接到蓝牙的 RXD 引脚。</li>
<li>现在通过 USB 电缆将 FTDI 连接到您的计算机。</li>
<li>接下来通过 USB 电缆将 F3 连接到您的计算机，同时按住蓝牙模块上的按钮（有点棘手）。</li>
<li>现在，松开按钮，蓝牙模块将进入 AT 模式。您可以通过观察蓝牙模块上的红色 LED 缓慢闪烁（大约 1-2 秒开/关）来确认这一点。</li>
</ul>
<p>AT 模式始终以 38400 的波特率运行，因此请为该波特率配置您的终端程序并连接到 FTDI 设备。</p>
<p>当您的串行连接建立后，您可能会<code>ERROR: (0)</code>重复显示一堆。如果发生这种情况，只需按 ENTER 即可停止错误。</p>
<h3 id="完整性检查"><a href="#完整性检查" class="headerlink" title="完整性检查"></a>完整性检查</h3><pre><code>$ at
OK
OK
(etc...)</code></pre><p><code>OK</code>重复回答，直到您再次按 ENTER。</p>
<h3 id="重命名设备"><a href="#重命名设备" class="headerlink" title="重命名设备"></a>重命名设备</h3><pre><code>$ at+name=ferris
OK</code></pre><h3 id="查询蓝牙模块当前波特率"><a href="#查询蓝牙模块当前波特率" class="headerlink" title="查询蓝牙模块当前波特率"></a>查询蓝牙模块当前波特率</h3><pre><code>at+uart?
+UART:9600,0,0
OK
+UART:9600,0,0
OK
(etc ...)</code></pre><h3 id="更改波特率"><a href="#更改波特率" class="headerlink" title="更改波特率"></a>更改波特率</h3><pre><code>$ at+uart=115200,0,0
OK</code></pre><h1 id="Serial-over-Bluetooth"><a href="#Serial-over-Bluetooth" class="headerlink" title="Serial over Bluetooth"></a>Serial over Bluetooth</h1><p>现在我们验证了蓝牙模块与 minicom/PuTTY 兼容，让我们将其连接到微控制器：</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-bluetooth.png" alt=""></p>
<p>连接它的推荐步骤：</p>
<ul>
<li>关闭 OpenOCD 和<code>itmdump</code>.</li>
<li>断开 F3 与计算机的连接。</li>
<li>使用母对母 (F/F) 线（最好是黑色的）将 F3 的 GND 引脚连接到模块的 GND 引脚。</li>
<li>使用 F/F 线（最好是红色的）将 F3 的 5V 引脚连接到模块的 VCC 引脚。</li>
<li>使用 F/F 线将 F3 背面的 PA9 (TX) 引脚连接到蓝牙的 RXD 引脚。</li>
<li>使用 F/F 线将 F3 背面的 PA10 (RX) 引脚连接到蓝牙的 TXD 引脚。</li>
<li>现在使用 USB 电缆连接 F3 和您的计算机。</li>
<li>重新启动 OpenOCD 和<code>itmdump</code>.</li>
</ul>
<p>就是这样！您应该可以不加修改地运行您在USART章节中编写的所有程序！只要确保您打开了正确的串行设备/COM 端口。</p>
<p><strong>注意</strong>如果您在与蓝牙设备通信时遇到问题，您可能需要以较低的波特率初始化 USART1。从等于115200为9600bps降低它可能会帮助，如所描述<a href="https://github.com/rust-embedded/discovery/blob/master/src/11-usart/auxiliary/src/lib.rs#L31" target="_blank" rel="noopener">这里</a></p>
<h1 id="I2C-1"><a href="#I2C-1" class="headerlink" title="I2C"></a>I2C</h1><p>我们刚刚看到了串行通信协议。它是一种广泛使用的协议，因为它非常简单，而且这种简单性使其易于在蓝牙和 USB 等其他协议之上实现。</p>
<p>然而，它的简单性也是一个缺点。更复杂的数据交换，如读取数字传感器，需要传感器供应商在其之上提出另一种协议。</p>
<p>(Un)对我们来说幸运的是，嵌入式领域还有<em>很多</em>其他的通信协议。其中一些被广泛用于数字传感器。</p>
<p>我们使用的 F3 板有三个运动传感器：加速度计、磁力计和陀螺仪。加速度计和磁力计封装在单个组件中，可通过 I2C 总线进行访问。</p>
<p>I2C 代表内部集成电路，是一种<em>同步</em> <em>串行</em>通信协议。它使用两条线来交换数据：一条数据线（SDA）和一条时钟线（SCL）。因为使用时钟线来同步通信，所以这是一个<em>同步</em>协议。</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C.svg" alt=""></p>
<p>该协议使用<em>主</em> <em>从</em>模型，其中主是<em>启动</em>和驱动与从设备通信的设备。多个设备，包括主设备和从设备，可以同时连接到同一条总线。主设备可以通过首先向总线广播其<em>地址</em>来与特定从设备通信。该地址可以是 7 位或 10 位长。一旦主机<em>开始</em>与从机通信，在主机<em>停止</em>通信之前，其他设备都不能使用总线。</p>
<p>时钟线决定了数据交换的速度，它通常以 100 KHz（标准模式）或 400 KHz（快速模式）的频率运行。</p>
<h2 id="General-protocol"><a href="#General-protocol" class="headerlink" title="General protocol"></a>General protocol</h2><p>I2C 协议比串行通信协议更复杂，因为它必须支持多个设备之间的通信。让我们使用示例来看看它是如何工作的：</p>
<h3 id="主-gt-从"><a href="#主-gt-从" class="headerlink" title="主 -> 从"></a>主 -&gt; 从</h3><p>如果主站要向从站发送数据：</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C-163136770520141.svg" alt=""></p>
<ol>
<li>主：广播开始</li>
<li>M：广播从地址（7 位）+ R/W（第 8 位）设置为 WRITE</li>
<li>从机：响应 ACK（确认）</li>
<li>M：发送一个字节</li>
<li>S：响应 ACK</li>
<li>重复步骤 4 和 5 零次或更多次</li>
<li>M：广播停止或（广播重新启动并返回（2））</li>
</ol>
<blockquote>
<p><strong>注意</strong>从地址可以是 10 位而不是 7 位长。其他都不会改变。</p>
</blockquote>
<h3 id="主-lt-从"><a href="#主-lt-从" class="headerlink" title="主 <- 从"></a>主 &lt;- 从</h3><p>如果master想从slave读取数据：</p>
<p><img src="/images/loading.gif" data-original="../images/language/I2C-163136770520141.svg" alt=""></p>
<ol>
<li>M：广播开始</li>
<li>M：广播从地址（7 位）+ R/W（第 8 位）设置为 READ</li>
<li>S：以 ACK 响应</li>
<li>S：发送字节</li>
<li>M：以 ACK 响应</li>
<li>重复步骤 4 和 5 零次或更多次</li>
<li>M：广播停止或（广播重新启动并返回（2））</li>
</ol>
<blockquote>
<p><strong>注意</strong>从地址可以是 10 位而不是 7 位长。其他都不会改变。</p>
</blockquote>
<h2 id="LSM303DLHC"><a href="#LSM303DLHC" class="headerlink" title="LSM303DLHC"></a>LSM303DLHC</h2><p><strong>*注意</strong>：较新的（从 2020/09 左右开始）探索板可能有<a href="https://www.st.com/resource/en/datasheet/lsm303agr.pdf" target="_blank" rel="noopener">LSM303AGR</a> 而不是<a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">LSM303DLHC</a>。查看像<a href="https://github.com/rust-embedded/discovery/issues/274" target="_blank" rel="noopener">这样</a>的 github 问题以获取更多详细信息。</p>
<p>F3 中的两个传感器，磁力计和加速度计，封装在单个组件中：LSM303DLHC 集成电路。这两个传感器可以通过 I2C 总线访问。每个传感器的行为类似于 I2C 从设备，并具有<em>不同的</em>地址。</p>
<p>每个传感器都有自己的存储器，用于存储感知环境的结果。我们与这些传感器的交互将主要涉及读取它们的记忆。</p>
<p>这些传感器的存储器被建模为字节可寻址寄存器。这些传感器也可以配置；这是通过写入他们的寄存器来完成的。因此，从某种意义上说，这些传感器与微控制器<em>内部</em>的外围设备非常相似。不同之处在于它们的寄存器没有映射到微控制器的存储器中。相反，它们的寄存器必须通过 I2C 总线访问。</p>
<p>有关 LSM303DLHC 的主要信息来源是其<a href="http://www.st.com/resource/en/datasheet/lsm303dlhc.pdf" target="_blank" rel="noopener">数据表</a>。通读它以了解如何读取传感器的寄存器。那部分在：</p>
<blockquote>
<p>第 5.1.1 节 I2C 操作 - 第 20 页 - LSM303DLHC 数据表</p>
</blockquote>
<p>与本书相关的文档的另一部分是寄存器的描述。那部分在：</p>
<blockquote>
<p>第 7 节寄存器描述 - 第 25 页 - LSM303DLHC 数据表</p>
</blockquote>
<h2 id="Read-a-single-register"><a href="#Read-a-single-register" class="headerlink" title="Read a single register"></a>Read a single register</h2><p>让我们将所有这些理论付诸实践！</p>
<p>就像使用 USART 外设一样，我已经负责在您到达之前初始化所有内容， <code>main</code>因此您只需要处理以下寄存器：</p>
<ul>
<li><code>CR2</code>. 控制寄存器 2。</li>
<li><code>ISR</code>. 中断和状态寄存器。</li>
<li><code>TXDR</code>. 发送数据寄存器。</li>
<li><code>RXDR</code>. 接收数据寄存器。</li>
</ul>
<p>这些寄存器记录在参考手册的以下部分：</p>
<blockquote>
<p>第 28.7 节 I2C 寄存器 - 第 868 页 - 参考手册</p>
</blockquote>
<p>我们将把<code>I2C1</code>外围设备与引脚<code>PB6</code>( <code>SCL</code>) 和<code>PB7</code>( <code>SDA</code>)结合使用。</p>
<p>这次您无需连接任何东西，因为传感器在板上并且已经连接到微控制器。但是，我建议您将串行/蓝牙模块与 F3 断开连接，以使其更易于操作。稍后，我们将移动电路板相当多。</p>
<p>您的任务是编写一个程序来读取磁力计<code>IRA_REG_M</code>寄存器的内容。该寄存器是只读的并且始终包含值<code>0b01001000</code>。</p>
<p>微控制器将扮演 I2C 主设备的角色，而 LSM303DLHC 内部的磁力计将成为 I2C 从设备。</p>
<p>这是入门代码。你必须实现<code>TODO</code>s。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> _delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Stage 1: Send the address of the register we want to read to the</span>
    <span class="token comment" spellcheck="true">// magnetometer</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO Broadcast START</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>

        <span class="token comment" spellcheck="true">// TODO Send the address of the register that we want to read: IRA_REG_M</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Stage 2: Receive the contents of the register we asked for</span>
    <span class="token keyword">let</span> byte <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO Broadcast RESTART</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>

        <span class="token comment" spellcheck="true">// TODO Receive the contents of the register</span>

        <span class="token comment" spellcheck="true">// TODO Broadcast STOP</span>
        <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Expected output: 0x0A - 0b01001000</span>
    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"0x{:02X} - 0b{:08b}"</span><span class="token punctuation">,</span> IRA_REG_M<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了给您一些额外的帮助，这些是您将要使用的确切位域：</p>
<ul>
<li><code>CR2</code>: <code>SADD1</code>, <code>RD_WRN</code>, <code>NBYTES</code>, <code>START</code>,<code>AUTOEND</code></li>
<li><code>ISR</code>: <code>TXIS</code>, <code>RXNE</code>,<code>TC</code></li>
<li><code>TXDR</code>： <code>TXDATA</code></li>
<li><code>RXDR</code>： <code>RXDATA</code></li>
</ul>
<h2 id="The-solution-1"><a href="#The-solution-1" class="headerlink" title="The solution"></a>The solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> _delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Stage 1: Send the address of the register we want to read to the</span>
    <span class="token comment" spellcheck="true">// magnetometer</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast START</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>MAGNETOMETER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we can send more data</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: IRA_REG_M</span>
        i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>IRA_REG_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until the previous byte has been transmitted</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Stage 2: Receive the contents of the register we asked for</span>
    <span class="token keyword">let</span> byte <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we have received the contents of the register</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span>

        i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Expected output: 0x0A - 0b01001000</span>
    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"0x{:02X} - 0b{:08b}"</span><span class="token punctuation">,</span> IRA_REG_M<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Read-several-registers"><a href="#Read-several-registers" class="headerlink" title="Read several registers"></a>Read several registers</h2><p>读取<code>IRA_REG_M</code>寄存器很好地测试了我们对 I2C 协议的理解，但该寄存器包含无趣的信息。</p>
<p>这一次，我们将读取实际暴露传感器读数的磁力计寄存器。涉及六个连续的寄存器，它们<code>OUT_X_H_M</code>以地址开头<code>0x03</code>。</p>
<p>我们将修改我们之前的程序来读取这六个寄存器。只需要进行一些修改。</p>
<p>我们需要将我们从磁力计请求的地址从 更改<code>IRA_REG_M</code>为<code>OUT_X_H_M</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: OUT_X_H_M</span>
    i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>OUT_X_H_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们必须向从站请求六个字节而不是一个字节。</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
    <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
    i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并填充缓冲区而不是仅读取一个字节：</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Wait until we have received the contents of the register</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token operator">*</span>byte <span class="token operator">=</span> i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将它们全部放在一个循环中并延迟以降低数据吞吐量：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Slave address</span>
<span class="token keyword">const</span> MAGNETOMETER<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">0b0011_1100</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Addresses of the magnetometer's registers</span>
<span class="token keyword">const</span> OUT_X_H_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> IRA_REG_M<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0x0A</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>i2c1<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux14<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broadcast START</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Write</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>MAGNETOMETER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until we can send more data</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Send the address of the register that we want to read: OUT_X_H_M</span>
        i2c1<span class="token punctuation">.</span>txdr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">|</span>w<span class="token operator">|</span> w<span class="token punctuation">.</span><span class="token function">txdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span>OUT_X_H_M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Wait until the previous byte has been transmitted</span>
        <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Broadcast RESTART</span>
        <span class="token comment" spellcheck="true">// Broadcast the MAGNETOMETER address with the R/W bit set to Read</span>
        i2c1<span class="token punctuation">.</span>cr2<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">,</span> w<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">nbytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">rd_wrn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            w<span class="token punctuation">.</span><span class="token function">autoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Wait until we have received something</span>
            <span class="token keyword">while</span> i2c1<span class="token punctuation">.</span>isr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bit_is_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token operator">*</span>byte <span class="token operator">=</span> i2c1<span class="token punctuation">.</span>rxdr<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Broadcast STOP (automatic because of `AUTOEND = 1`)</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你运行它，你应该在<code>itmdump</code>‘s 的控制台中每秒打印一个 6 个字节的新数组。如果您在板上移动，数组中的值应该会发生变化。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
[0, 45, 255, 251, 0, 193]
[0, 44, 255, 249, 0, 193]
[0, 49, 255, 250, 0, 195]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是这些字节没有多大意义。让我们把它们变成实际的读数：</p>
<pre class="line-numbers language-rust"><code class="language-rust">        <span class="token keyword">let</span> x_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> x_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y_h <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y_l <span class="token operator">=</span> u16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> x_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> y_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>z_h <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> z_l<span class="token punctuation">)</span> <span class="token keyword">as</span> i16<span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在它应该看起来更好：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # `itmdump terminal
(..)
(44, 196, -7)
(45, 195, -6)
(46, 196, -9)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是沿磁力计的 XYZ 轴分解的地球磁场。</p>
<h1 id="LED-compass"><a href="#LED-compass" class="headerlink" title="LED compass"></a>LED compass</h1><p>在本节中，我们将使用 F3 上的 LED 实现指南针。就像正确的指南针一样，我们的 LED 指南针必须以某种方式指向北方。它会通过打开八个 LED 中的一个来实现这一点。打开的 LED 应指向北方。</p>
<p>磁场有大小（以高斯或特斯拉为单位）和<em>方向</em>。F3 上的磁力计测量外部磁场的大小和方向，但它会报告所述磁场沿<em>其轴</em>的<em>分解</em>。</p>
<p>见下文，磁力计有三个与之关联的轴。</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-lsm303dlhc.png" alt=""></p>
<p>上面只显示了 X 和 Y 轴。Z 轴指向屏幕的“外部”。</p>
<p>让我们通过运行以下启动代码来熟悉磁力计的读数：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>lsm303dlhc</code>模块通过 LSM303DLHC 提供高级 API。在底层，它执行与您在上一节中实现的相同的 I2C 例程，但它在<code>I16x3</code>结构而不是元组中报告 X、Y 和 Z 值 。</p>
<p>定位北在您当前位置的位置。然后旋转电路板，使其“朝北”对齐：北方 LED (LD3) 应指向北方。</p>
<p>现在运行启动代码并观察输出。你看到什么 X、Y 和 Z 值？</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump terminal
(..)
I16x3 { x: 45, y: 194, z: -3 }
I16x3 { x: 46, y: 195, z: -8 }
I16x3 { x: 47, y: 197, z: -2 }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在将板旋转 90 度，同时保持它与地面平行。这次你看到了什么 X、Y 和 Z 值？然后再次将其旋转 90 度。你看到了什么价值观？</p>
<h2 id="Take-1"><a href="#Take-1" class="headerlink" title="Take 1"></a>Take 1</h2><p>我们可以实现 LED 指南针的最简单方法是什么？即使它并不完美。</p>
<p>首先，我们只关心磁场的 X 和 Y 分量，因为当您查看指南针时，您总是将其保持在水平位置，因此指南针位于 XY 平面内。</p>
<p>例如，在以下情况下您会打开什么 LED。EMF 代表地球磁场，绿色箭头表示 EMF 的方向（指向北方）。</p>
<p><img src="/images/loading.gif" data-original="../images/language/quadrant-i.png" alt=""></p>
<p>该<code>Southeast</code>LED，对不对？</p>
<p>在这种情况下，磁场的 X 和 Y 分量有什么<em>迹象</em>？两者都是积极的。</p>
<p>如果我们只看 X 和 Y 分量的符号，我们就可以确定磁场属于哪个象限。</p>
<p><img src="/images/loading.gif" data-original="../images/language/quadrants.png" alt=""></p>
<p>在前面的示例中，磁场位于第一象限（x 和 y 为正），因此打开<code>SouthEast</code>LED是有意义的。同样，如果磁场位于不同的象限，我们可以打开不同的 LED。</p>
<p>让我们试试这个逻辑。这是入门代码：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Look at the signs of the X and Y components to determine in which</span>
        <span class="token comment" spellcheck="true">// quadrant the magnetic field is</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant ???</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">"TODO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有一个<code>Direction</code>在枚举<code>led</code>有8个变种东南西北命名的模块： <code>North</code>，<code>East</code>，<code>Southwest</code>等。这些变体代表了指南针的8个LED之一。该<code>Leds</code>值可以使用<code>Direction</code> <code>enum</code>;进行索引。索引的结果是指向那个的 LED <code>Direction</code>。</p>
<h2 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1"></a>Solution 1</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Look at the signs of the X and Y components to determine in which</span>
        <span class="token comment" spellcheck="true">// quadrant the magnetic field is</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Quadrant I</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant II</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northeast<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant III</span>
            <span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northwest<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// Quadrant IV</span>
            <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southwest<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Take-2"><a href="#Take-2" class="headerlink" title="Take 2"></a>Take 2</h2><p>这一次，我们将使用数学来获得磁场与磁力计的 X 轴和 Y 轴形成的精确角度。</p>
<p>我们将使用该<code>atan2</code>功能。此函数返回<code>-PI</code>to<code>PI</code>范围内的角度。下图显示了如何测量该角度：</p>
<p><img src="/images/loading.gif" data-original="../images/language/Atan2_60.svg" alt=""></p>
<p>尽管此图中未明确显示，但 X 轴指向右侧，Y 轴指向上方。</p>
<p>这是入门代码。<code>theta</code>，以弧度表示，已经被计算出来。您需要根据 的值选择要打开的 LED <code>theta</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// You'll find this useful ;-)</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>f32<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span>PI<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// this trait provides the `atan2` method</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> _theta <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>x <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in radians</span>

        <span class="token comment" spellcheck="true">// FIXME pick a direction to point to based on `theta`</span>
        <span class="token keyword">let</span> dir <span class="token operator">=</span> Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast<span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>建议/提示：</p>
<ul>
<li>一整圈旋转等于 360 度。</li>
<li><code>PI</code> 弧度相当于 180 度。</li>
<li>如果<code>theta</code>为零，你会打开什么 LED？</li>
<li><code>theta</code>相反，如果非常接近于零，您会打开什么 LED？</li>
<li>如果<code>theta</code>继续增加，您会在什么值下打开不同的 LED？</li>
</ul>
<h2 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2"></a>Solution 2</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token comment" spellcheck="true">// You'll find this useful ;-)</span>
<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>f32<span class="token punctuation">:</span><span class="token punctuation">:</span>consts<span class="token punctuation">:</span><span class="token punctuation">:</span>PI<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> switch_hal<span class="token punctuation">:</span><span class="token punctuation">:</span>OutputSwitch<span class="token punctuation">,</span> Direction<span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> leds <span class="token operator">=</span> leds<span class="token punctuation">.</span><span class="token function">into_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> theta <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>x <span class="token keyword">as</span> f32<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in radians</span>

        <span class="token keyword">let</span> dir <span class="token operator">=</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>North
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northwest
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>West
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span>PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southwest
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>South
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Southeast
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>East
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> theta <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">.</span> <span class="token operator">*</span> PI <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>Northeast
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Direction<span class="token punctuation">:</span><span class="token punctuation">:</span>North
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        leds<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>led<span class="token operator">|</span> led<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        leds<span class="token punctuation">[</span>dir <span class="token keyword">as</span> usize<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Magnitude"><a href="#Magnitude" class="headerlink" title="Magnitude"></a>Magnitude</h2><p>我们一直在研究磁场的方向，但它的实际大小是多少？<code>magnetic_field</code>函数报告的数字是无单位的。我们如何将这些值转换为高斯？</p>
<p>文档将回答这个问题。</p>
<blockquote>
<p>第 2.1 节传感器特性 - 第 10 页 - LSM303DLHC 数据表</p>
</blockquote>
<p>该页面中的表格显示了根据 GN 位的值具有不同值的<em>磁增益设置</em>。默认情况下，这些 GN 位设置为<code>001</code>。这意味着 X 轴和 Y 轴<code>1100 LSB / Gauss</code>的磁增益为 ，Z 轴的磁增益为<code>980 LSB / Gauss</code>。LSB 代表最低有效位，<code>1100 LSB / Gauss</code>数字表示读数 <code>1100</code>等于<code>1 Gauss</code>，读数<code>2200</code>等于 2 高斯，依此类推。</p>
<p>因此，我们需要做的是将传感器输出的 X、Y 和 Z 值除以其相应的 <em>增益</em>。然后，我们将获得以高斯为单位的磁场的 X、Y 和 Z 分量。</p>
<p>通过一些额外的数学运算，我们可以从 X、Y 和 Z 分量中检索磁场的大小：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> magnitude <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将所有这些放在一个程序中：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> XY_GAIN<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">1100</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LSB / G</span>
    <span class="token keyword">const</span> Z_GAIN<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">980</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LSB / G</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> XY_GAIN<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> XY_GAIN<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token operator">/</span> Z_GAIN<span class="token punctuation">;</span>

        <span class="token keyword">let</span> mag <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y <span class="token operator">+</span> z <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{} mG"</span><span class="token punctuation">,</span> mag <span class="token operator">*</span> <span class="token number">1_000</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该程序将以毫高斯 ( <code>mG</code>)为单位报告磁场的大小（强度）。地球磁场的幅度是在范围内<code>250 mG</code>，以<code>650 mG</code>（幅度取决于您的地理位置），所以你应该在这个范围内看到的值或接近该范围-我看到周围210毫克的幅度。</p>
<p>一些问题：</p>
<p>不移动板子，你看到了什么价值？你总是看到相同的值吗？</p>
<p>如果你旋转木板，幅度会改变吗？应该改变吗？</p>
<h2 id="Calibration"><a href="#Calibration" class="headerlink" title="Calibration"></a>Calibration</h2><p>如果我们旋转板子，地球磁场相对于磁力计的方向应该改变，但它的大小不应该！然而，磁力计表明磁场的大小会随着电路板的旋转而变化。</p>
<p>为什么会这样？事实证明，磁力计需要校准才能返回正确的答案。</p>
<p>校准涉及相当多的数学（矩阵），因此我们不会在这里介绍它，但如果您有兴趣，本 <a href="https://www.nxp.com/docs/en/application-note/AN4246.pdf" target="_blank" rel="noopener">应用说明</a>会介绍该过程。相反，我们将在本节中做的是<em>可视化</em>我们的状态。</p>
<p>让我们来试试这个实验：让我们记录磁力计的读数，同时我们慢慢地向不同方向旋转板。我们将使用<code>iprintln</code>宏将读数格式化为制表符分隔值 (TSV)。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>_leds<span class="token punctuation">,</span> <span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux15<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">mag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{}\t{}\t{}"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您应该在控制台中获得如下所示的输出：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump console
-76     213     -54
-76     213     -54
-76     213     -54
-76     213     -54
-73     213     -55<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可以使用管道将其传输到文件：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Careful! Exit any running other `itmdump` instance that may be running
$ itmdump -F -f itm.txt > emf.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在记录数据几秒钟的同时，沿许多不同的方向旋转板。</p>
<p>然后将该 TSV 文件导入电子表格程序（或使用如下所示的 Python 脚本）并将前两列绘制为散点图。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>

<span class="token keyword">import</span> csv
<span class="token keyword">import</span> math
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token keyword">import</span> sys

<span class="token comment" spellcheck="true"># apply plot style</span>
sns<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token punctuation">)</span>

x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> open<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    rows <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># discard rows that are missing data</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">or</span> <span class="token operator">not</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">or</span> <span class="token operator">not</span> row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

r <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>max<span class="token punctuation">(</span>max<span class="token punctuation">(</span>np<span class="token punctuation">.</span>abs<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>np<span class="token punctuation">.</span>abs<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token operator">-</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token operator">-</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_aspect<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'emf.svg'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="../images/language/emf.svg" alt=""></p>
<p>如果您在平坦的水平面上旋转电路板，磁场的 Z 分量应该保持相对恒定，并且该图应该是以原点为中心的圆周（而不是椭圆）。如果您以随机方向旋转棋盘，这就是上面的情节，那么您应该得到一个由以原点为中心的一堆点组成的圆。与圆形的偏差表明需要校准磁力计。</p>
<p>带回家的信息：不要只相信传感器的读数。验证它正在输出合理的值。如果不是，则校准它。</p>
<h1 id="Punch-o-meter（打孔计）"><a href="#Punch-o-meter（打孔计）" class="headerlink" title="Punch-o-meter（打孔计）"></a>Punch-o-meter（打孔计）</h1><p>在本节中，我们将使用板上的加速度计。</p>
<p>这次我们要建造什么？打孔计！我们将测量你的刺戳的力量。嗯，实际上你可以达到的最大加速度，因为加速度是加速度计测量的。强度和加速度是成比例的，所以这是一个很好的近似值。</p>
<p>加速度计也内置在 LSM303DLHC 封装内。就像磁力计一样，它也可以使用 I2C 总线进行访问。它还具有与磁力计相同的坐标系。这里又是坐标系：</p>
<p><img src="/images/loading.gif" data-original="../images/language/f3-lsm303dlhc-163136835024848.png" alt=""></p>
<p>就像在上一个单元中一样，我们将使用高级 API 直接获取封装良好的<code>struct</code>.</p>
<h2 id="Gravity-is-up"><a href="#Gravity-is-up" class="headerlink" title="Gravity is up?"></a>Gravity is up?</h2><p>我们要做的第一件事是什么？</p>
<p>执行健全性检查！</p>
<p>启动器代码打印加速度计测量的加速度的 X、Y 和 Z 分量。这些值已经被“缩放”并且单位为<code>g</code>s。其中<code>1 g</code>等于重力加速度，约<code>9.8</code>米每秒的平方。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">,</span> Sensitivity<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> _mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// extend sensing range to `[-12g, +12g]`</span>
    lsm303dlhc<span class="token punctuation">.</span><span class="token function">set_accel_sensitivity</span><span class="token punctuation">(</span>Sensitivity<span class="token punctuation">:</span><span class="token punctuation">:</span>G12<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> SENSITIVITY<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f32<span class="token punctuation">;</span>

        <span class="token keyword">let</span> I16x3 <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span> lsm303dlhc<span class="token punctuation">.</span><span class="token function">accel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>

        <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1_000_u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个程序在董事会静止时的输出将是这样的：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # itmdump console
(..)
(0.0, 0.0, 1.078125)
(0.0, 0.0, 1.078125)
(0.0, 0.0, 1.171875)
(0.0, 0.0, 1.03125)
(0.0, 0.0, 1.078125)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这很奇怪，因为板没有移动，但它的加速度不为零。这是怎么回事？这一定和重力有关吧？因为重力加速度是<code>1 g</code>。但是重力将物体向下拉，所以沿 Z 轴的加速度应该是负的而不是正的……</p>
<p>程序是否使 Z 轴向后？不，您可以测试旋转板以使重力与 X 或 Y 轴对齐，但加速度计测量的加速度始终指向上方。</p>
<p>这里发生的情况是，加速度计测量的是电路板的<em>正确加速度</em>，而不是<em>您</em>观察到的加速度。这个适当的加速度是从自由落体的观察者那里看到的板的加速度。自由落体的观察者正以 的加速度向地球中心移动<code>1g</code>；从它的角度来看，棋盘实际上是以 的加速度向上移动（远离地球中心）<code>1g</code>。这就是为什么正确的加速度指向上方的原因。这也意味着如果电路板处于自由落体状态，加速度计会报告正确的零加速度。请不要在家里尝试。</p>
<h2 id="The-challenge-1"><a href="#The-challenge-1" class="headerlink" title="The challenge"></a>The challenge</h2><p>为简单起见，我们将仅在板保持水平时测量 X 轴上的加速度。这样我们就不必处理减去我们之前观察到的<em>虚构的</em> <code>1g</code>事情，这会很困难，因为<code>1g</code>根据电路板的方向，这可能会有 XYZ 组件。</p>
<p>以下是打孔机必须执行的操作：</p>
<ul>
<li>默认情况下，应用程序不会“观察”板的加速度。</li>
<li>当检测到显着的 X 加速度时（即加速度超过某个阈值），应用程序应开始新的测量。</li>
<li>在该测量间隔期间，应用程序应跟踪观察到的最大加速度</li>
<li>测量间隔结束后，应用程序必须报告观察到的最大加速度。您可以使用<code>iprintln</code>宏报告该值。</li>
</ul>
<p>试一试，让我知道你能打出多用力<code>;-)</code>。</p>
<h2 id="My-solution-2"><a href="#My-solution-2" class="headerlink" title="My solution"></a>My solution</h2><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![deny(unsafe_code)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token attribute attr-name">#[allow(unused_imports)]</span>
<span class="token keyword">use</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>entry<span class="token punctuation">,</span> iprint<span class="token punctuation">,</span> iprintln<span class="token punctuation">,</span> prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> I16x3<span class="token punctuation">,</span> Sensitivity<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> m<span class="token punctuation">:</span><span class="token punctuation">:</span>Float<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SENSITIVITY<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">.</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f32<span class="token punctuation">;</span>
    <span class="token keyword">const</span> THRESHOLD<span class="token punctuation">:</span> f32 <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> lsm303dlhc<span class="token punctuation">,</span> <span class="token keyword">mut</span> delay<span class="token punctuation">,</span> mono_timer<span class="token punctuation">,</span> <span class="token keyword">mut</span> itm<span class="token punctuation">)</span> <span class="token operator">=</span> aux16<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    lsm303dlhc<span class="token punctuation">.</span><span class="token function">set_accel_sensitivity</span><span class="token punctuation">(</span>Sensitivity<span class="token punctuation">:</span><span class="token punctuation">:</span>G12<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> measurement_time <span class="token operator">=</span> mono_timer<span class="token punctuation">.</span><span class="token function">frequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1 second in ticks</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> instant <span class="token operator">=</span> None<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> max_g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> g_x <span class="token operator">=</span> f32<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span>lsm303dlhc<span class="token punctuation">.</span><span class="token function">accel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> SENSITIVITY<span class="token punctuation">;</span>

        <span class="token keyword">match</span> instant <span class="token punctuation">{</span>
            None <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// If acceleration goes above a threshold, we start measuring</span>
                <span class="token keyword">if</span> g_x <span class="token operator">></span> THRESHOLD <span class="token punctuation">{</span>
                    <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"START!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    max_g <span class="token operator">=</span> g_x<span class="token punctuation">;</span>
                    instant <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>mono_timer<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Still measuring</span>
            <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> instant<span class="token punctuation">)</span> <span class="token keyword">if</span> instant<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> measurement_time <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> g_x <span class="token operator">></span> max_g <span class="token punctuation">{</span>
                    max_g <span class="token operator">=</span> g_x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Report max value</span>
                <span class="token function">iprintln!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> itm<span class="token punctuation">.</span>stim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Max acceleration: {}g"</span><span class="token punctuation">,</span> max_g<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Measurement done</span>
                instant <span class="token operator">=</span> None<span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Reset</span>
                max_g <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        delay<span class="token punctuation">.</span><span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">50_u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="What’s-left-for-you-to-explore"><a href="#What’s-left-for-you-to-explore" class="headerlink" title="What’s left for you to explore"></a>What’s left for you to explore</h1><p>我们几乎没有触及表面！还有很多东西等你去探索。</p>
<blockquote>
<p><strong>注意：</strong>如果您正在阅读本文，并且希望帮助在 Discovery 书中添加以下任何项目的示例或练习，或任何其他相关的嵌入主题，我们很乐意得到您的帮助！</p>
<p>如果您想提供帮助，请<a href="https://github.com/rust-embedded/discovery/issues/new" target="_blank" rel="noopener">打开一个问题</a>，但需要帮助或指导如何将其贡献给本书，或者打开一个添加信息的拉取请求！</p>
</blockquote>
<h2 id="关于嵌入式软件的话题"><a href="#关于嵌入式软件的话题" class="headerlink" title="关于嵌入式软件的话题"></a>关于嵌入式软件的话题</h2><p>这些主题讨论编写嵌入式软件的策略。尽管可以通过不同的方式解决许多问题，但这些部分讨论了一些策略，以及何时使用它们有意义（或没有意义）。</p>
<h3 id="多任务处理"><a href="#多任务处理" class="headerlink" title="多任务处理"></a>多任务处理</h3><p>我们所有的程序都执行了一个任务。我们如何在没有操作系统的系统中实现多任务处理，因此没有线程。多任务处理有两种主要方法：抢占式多任务处理和协作多任务处理。</p>
<p>在抢占式多任务处理中，当前正在执行的任务可以在任何时间点 被另一个任务<em>抢占</em>（中断）。在抢占时，第一个任务将被挂起，处理器将转而执行第二个任务。在某个时候，第一个任务将恢复。微控制器以<em>中断</em>的形式为抢占提供硬件支持。</p>
<p>在协作多任务处理中，正在执行的任务将一直运行，直到到达<em>暂停点<em>。当处理器到达该暂停点时，它将停止执行当前任务并转而执行不同的任务。在某个时候，第一个任务将恢复。这两种多任务处理方法之间的主要区别在于，在协作多任务处理中，在</em>已知的<em>暂停点</em>产生</em> 执行控制，而不是在其执行的任何点被强行抢占。</p>
<h3 id="睡眠"><a href="#睡眠" class="headerlink" title="睡眠"></a>睡眠</h3><p>我们所有的程序都在不断地轮询外围设备，看看是否有什么需要做的。然而，有时没有什么可做的！在那个时候，微控制器应该“休眠”。</p>
<p>当处理器休眠时，它会停止执行指令，从而节省电量。节省电量几乎总是一个好主意，因此您的微控制器应该尽可能多地休眠。但是，它如何知道何时必须醒来才能执行某些操作？“中断”是唤醒微控制器的事件之一，但还有其他事件，<code>wfi</code>并且<code>wfe</code>是使处理器“休眠”的指令。</p>
<h2 id="与微控制器功能相关的主题"><a href="#与微控制器功能相关的主题" class="headerlink" title="与微控制器功能相关的主题"></a>与微控制器功能相关的主题</h2><p>微控制器（如我们的 STM32F3）具有许多不同的功能。然而，许多共享类似的功能，可用于解决各种不同的问题。</p>
<p>这些主题讨论了其中的一些功能，以及如何在嵌入式开发中有效地使用它们。</p>
<h3 id="直接内存访问-DMA"><a href="#直接内存访问-DMA" class="headerlink" title="直接内存访问 (DMA)"></a>直接内存访问 (DMA)</h3><p>这个外设是一种<em>异步的</em> <code>memcpy</code>。到目前为止，我们的程序一直在逐字节地将数据泵送到 UART 和 I2C 等外设中。该 DMA 外设可用于执行批量数据传输。从 RAM 到 RAM，从外围设备（如 UART）到 RAM 或从 RAM 到外围设备。您可以安排 DMA 传输，例如从 USART1 读取 256 个字节到此缓冲区中，让它在后台运行，然后轮询某个寄存器以查看它是否已完成，以便您可以在传输过程中执行其他操作。</p>
<h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><p>为了与现实世界进行交互，微控制器通常需要在发生某种事件时<em>立即</em>做出响应。</p>
<p>微控制器具有被中断的能力，这意味着当某个事件发生时，它会停止当前正在执行的任何操作，转而响应该事件。当我们想在按下按钮时停止电机或在计时器完成倒计时时测量传感器时，这非常有用。</p>
<p>尽管这些中断可能非常有用，但它们也可能有点难以正确使用。我们希望确保快速响应事件，同时也允许其他工作继续进行。</p>
<p>在 Rust 中，我们对中断进行建模，类似于桌面 Rust 程序上的线程概念。这意味着我们还必须考虑 Rust 概念<code>Send</code>以及<code>Sync</code> 在我们的主应用程序和作为处理中断事件的一部分执行的代码之间共享数据时。</p>
<h3 id="脉宽调制-PWM"><a href="#脉宽调制-PWM" class="headerlink" title="脉宽调制 (PWM)"></a>脉宽调制 (PWM)</h3><p>简而言之，PWM 会打开某些东西，然后定期将其关闭，同时在“开启时间”和“关闭时间”之间保持一定比例（“占空比”）。当用于具有足够高频率的 LED 时，这可用于使 LED 变暗。低占空比，比如 10% 的时间和 90% 的关闭时间，会使 LED 非常暗，而高占空比，比如 90% 的时间和 10% 的关闭时间，会使 LED 更亮（几乎好像它已完全通电）。</p>
<p>通常，PWM 可用于控制向某些电子设备提供多少<em>功率</em>。通过微控制器和电动机之间的适当（功率）电子设备，PWM 可用于控制向电动机提供多少功率，从而可用于控制其扭矩和速度。然后你可以添加一个角位置传感器，你就得到了一个闭环控制器，可以控制电机在不同负载下的位置。</p>
<h3 id="数字输入"><a href="#数字输入" class="headerlink" title="数字输入"></a>数字输入</h3><p>我们使用微控制器引脚作为数字输出来驱动 LED。但这些引脚也可以配置为数字输入。作为数字输入，这些引脚可以读取开关（开/关）或按钮（按下/未按下）的二进制状态。</p>
<p>（<em>剧透</em>阅读开关/按钮的二进制状态并不像听起来那么简单;-)</p>
<h3 id="模数转换器-ADC"><a href="#模数转换器-ADC" class="headerlink" title="模数转换器 (ADC)"></a>模数转换器 (ADC)</h3><p>那里有很多数字传感器。您可以使用 I2C 和 SPI 之类的协议来读取它们。但模拟传感器也存在！这些传感器只是输出一个与它们感测的幅度成正比的电压电平。</p>
<p>ADC 外设可用于将该“模拟”电压电平（例如<code>1.25</code> 伏特）转换为<code>[0, 65535]</code>处理器可用于其计算的范围内的“数字”数字。</p>
<h3 id="数模转换器-DAC"><a href="#数模转换器-DAC" class="headerlink" title="数模转换器 (DAC)"></a>数模转换器 (DAC)</h3><p>正如您所期望的那样，DAC 与 ADC 完全相反。您可以将一些数字值写入寄存器以在某个“模拟”引脚上产生<code>[0, 3.3V]</code>范围内的电压（假设有<code>3.3V</code>电源）。当这个模拟引脚连接到一些合适的电子设备并且寄存器以某个恒定的、快速的速率（频率）和正确的值被写入时，你可以产生声音甚至音乐！</p>
<h3 id="实时时钟-RTC"><a href="#实时时钟-RTC" class="headerlink" title="实时时钟 (RTC)"></a>实时时钟 (RTC)</h3><p>该外围设备可用于以“人类格式”跟踪时间。秒、分钟、小时、天、月和年。这个外围设备处理从“滴答”到这些人类友好的时间单位的转换。它甚至可以为您处理闰年和夏令时！</p>
<h3 id="其他通讯协议"><a href="#其他通讯协议" class="headerlink" title="其他通讯协议"></a>其他通讯协议</h3><p>SPI、I2S、SMBUS、CAN、IrDA、以太网、USB、蓝牙等。</p>
<p>不同的应用程序使用不同的通信协议。面向用户的应用程序通常有一个 USB 连接器，因为 USB 是 PC 和智能手机中无处不在的协议。而在汽车内，您会发现很多 CAN“总线”。一些数字传感器使用 SPI，其他使用 I2C，其他使用 SMBUS。</p>
<h2 id="一般嵌入式相关主题"><a href="#一般嵌入式相关主题" class="headerlink" title="一般嵌入式相关主题"></a>一般嵌入式相关主题</h2><p>这些主题涵盖了不特定于我们的设备或其上的硬件的项目。相反，他们讨论了可用于嵌入式系统的有用技术。</p>
<h3 id="陀螺仪"><a href="#陀螺仪" class="headerlink" title="陀螺仪"></a>陀螺仪</h3><p>作为我们的 Punch-o-meter 练习的一部分，我们使用加速度计来测量三个维度的加速度变化。我们的电路板还配备了一个称为陀螺仪的传感器，它使我们能够测量三个维度的“自旋”变化。</p>
<p>这在尝试构建某些系统时非常有用，例如想要避免翻倒的机器人。此外，来自陀螺仪等传感器的数据也可以使用称为传感器融合的技术与来自加速度计的数据相结合（有关更多信息，请参见下文）。</p>
<h3 id="伺服和步进电机"><a href="#伺服和步进电机" class="headerlink" title="伺服和步进电机"></a>伺服和步进电机</h3><p>虽然有些电机主要用于向一个方向或另一个方向旋转，例如向前或向后驱动遥控车，但有时更精确地测量电机的旋转方式很有用。</p>
<p>我们的微控制器可用于驱动伺服或步进电机，从而可以更精确地控制电机转动的圈数，甚至可以将电机定位在一个特定位置，例如，如果我们想移动指向特定方向的时钟。</p>
<h3 id="传感器融合"><a href="#传感器融合" class="headerlink" title="传感器融合"></a>传感器融合</h3><p>STM32F3DISCOVERY 包含三个运动传感器：加速度计、陀螺仪和磁力计。这些措施本身就是：（适当的）加速度、角速度和（地球的）磁场。但是这些量级可以“融合”成更有用的东西：电路板方向的“稳健”测量。具有比单个传感器更少的测量误差的稳健手段将能够做到。</p>
<p>这种从不同来源获取更可靠数据的想法被称为传感器融合。</p>
<hr>
<p>那么下一步去哪里？有几种选择：</p>
<ul>
<li><p>您可以查看<a href="https://docs.rs/f3" target="_blank" rel="noopener"><code>f3</code></a>董事会支持箱中的示例。所有这些示例都适用于您拥有的 STM32F3DISCOVERY 板。</p>
</li>
<li><p>你可以试试<a href="https://mobile.twitter.com/japaricious/status/962770003325005824" target="_blank" rel="noopener">这个运动传感器演示</a>。<a href="http://blog.japaric.io/wd-1-2-l3gd20-lsm303dlhc-madgwick/" target="_blank" rel="noopener">这篇博文</a>中提供了有关实现和源代码的详细<a href="http://blog.japaric.io/wd-1-2-l3gd20-lsm303dlhc-madgwick/" target="_blank" rel="noopener">信息</a>。</p>
</li>
<li><p>你可以查看<a href="https://docs.rs/cortex-m-rtfm" target="_blank" rel="noopener">群众实时</a>。一个非常高效的抢占式多任务框架，支持任务优先级和无死锁执行。</p>
</li>
<li><p>您可以尝试在不同的开发板上运行 Rust。最简单的入门方法是使用<a href="https://docs.rs/cortex-m-quickstart/0.2.4/cortex_m_quickstart" target="_blank" rel="noopener"><code>cortex-m-quickstart</code></a>Cargo 项目模板。</p>
</li>
<li><p>你可以查看<a href="http://blog.japaric.io/brave-new-io/" target="_blank" rel="noopener">这篇博客文章</a>，它描述了 Rust 类型系统如何防止 I/O 配置中的错误。</p>
</li>
<li><p>您可以查看我的<a href="http://blog.japaric.io/" target="_blank" rel="noopener">博客</a>，了解有关使用 Rust 进行嵌入式开发的其他主题。</p>
</li>
<li><p>您可以查看<a href="https://github.com/rust-embedded/embedded-hal" target="_blank" rel="noopener"><code>embedded-hal</code></a>旨在为微控制器上常见的所有嵌入式 I/O 功能构建抽象（特征）的项目。</p>
</li>
<li><p>您可以加入<a href="https://github.com/rust-lang-nursery/embedded-wg/issues/39" target="_blank" rel="noopener">Weekly driver 计划</a>并帮助我们在<code>embedded-hal</code>特征之上编写通用驱动程序， 并适用于各种平台（ARM Cortex-M、AVR、MSP430、RISCV 等）</p>
</li>
</ul>
<h1 id="General-troubleshooting"><a href="#General-troubleshooting" class="headerlink" title="General troubleshooting"></a>General troubleshooting</h1><h2 id="OpenOCD-问题"><a href="#OpenOCD-问题" class="headerlink" title="OpenOCD 问题"></a>OpenOCD 问题</h2><h3 id="无法连接到-OpenOCD-“错误：打开失败”"><a href="#无法连接到-OpenOCD-“错误：打开失败”" class="headerlink" title="无法连接到 OpenOCD - “错误：打开失败”"></a>无法连接到 OpenOCD - “错误：打开失败”</h3><h4 id="症状"><a href="#症状" class="headerlink" title="症状"></a>症状</h4><p>在尝试与设备建立<em>新连接</em>时，您会收到如下所示的错误：</p>
<pre><code>$ openocd -f (..)
(..)
Error: open failed
in procedure 'init'
in procedure 'ocd_bouncer'</code></pre><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>设备未（正确）连接或未使用正确的 ST-LINK 接口配置。</p>
<h4 id="使固定"><a href="#使固定" class="headerlink" title="使固定"></a>使固定</h4><p>Linux：</p>
<ul>
<li>使用 来检查 USB 连接<code>lsusb</code>。</li>
<li>您可能没有足够的权限打开设备。再试一次<code>sudo</code>。如果可行，您可以使用<a href="https://docs.rust-embedded.org/discovery/03-setup/linux.html#udev-rules" target="_blank" rel="noopener">这些说明</a>使 OpenOCD 在没有 root 权限的情况下工作。</li>
<li>您可能为 ST-LINK 使用了错误的接口配置。尝试<code>interface/stlink-v2.cfg</code>代替<code>interface/stlink-v2-1.cfg</code>.</li>
</ul>
<p>视窗：</p>
<ul>
<li>您可能缺少 ST-LINK USB 驱动程序。安装说明 <a href="https://docs.rust-embedded.org/discovery/03-setup/windows.html#st-link-usb-driver" target="_blank" rel="noopener">在这里</a>。</li>
</ul>
<h3 id="无法连接到-OpenOCD-“X00ms-后再次轮询”"><a href="#无法连接到-OpenOCD-“X00ms-后再次轮询”" class="headerlink" title="无法连接到 OpenOCD - “X00ms 后再次轮询”"></a>无法连接到 OpenOCD - “X00ms 后再次轮询”</h3><h4 id="症状-1"><a href="#症状-1" class="headerlink" title="症状"></a>症状</h4><p>在尝试与设备建立<em>新连接</em>时，您会收到如下所示的错误：</p>
<pre><code>$ openocd -f (..)
(..)
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 100ms
Info : Previous state query failed, trying to reconnect
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 300ms
Info : Previous state query failed, trying to reconnect</code></pre><h4 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h4><p>微控制器可能陷入了某种紧密的无限循环中，或者它可能不断引发异常，例如异常处理程序正在引发异常。</p>
<h4 id="使固定-1"><a href="#使固定-1" class="headerlink" title="使固定"></a>使固定</h4><ul>
<li>关闭 OpenOCD，如果正在运行</li>
<li>按住重置（黑色）按钮</li>
<li>启动 OpenOCD 命令</li>
<li>现在，松开重置按钮</li>
</ul>
<h3 id="OpenOCD-连接丢失-“在-X00-毫秒内再次轮询”"><a href="#OpenOCD-连接丢失-“在-X00-毫秒内再次轮询”" class="headerlink" title="OpenOCD 连接丢失 - “在 X00 毫秒内再次轮询”"></a>OpenOCD 连接丢失 - “在 X00 毫秒内再次轮询”</h3><h4 id="症状-2"><a href="#症状-2" class="headerlink" title="症状"></a>症状</h4><p>一个<em>运行</em>OpenOCD的会话突然错误有：</p>
<pre><code># openocd -f (..)
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 100ms
Info : Previous state query failed, trying to reconnect
Error: jtag status contains invalid mode value - communication failure
Polling target stm32f3x.cpu failed, trying to reexamine
Examination failed, GDB will be halted. Polling again in 300ms
Info : Previous state query failed, trying to reconnect</code></pre><h4 id="原因-2"><a href="#原因-2" class="headerlink" title="原因"></a>原因</h4><p>USB 连接丢失。</p>
<h4 id="使固定-2"><a href="#使固定-2" class="headerlink" title="使固定"></a>使固定</h4><ul>
<li>关闭 OpenOCD</li>
<li>断开并重新连接 USB 电缆。</li>
<li>重新启动 OpenOCD</li>
</ul>
<h3 id="无法刷新设备-“忽略数据包错误，继续…”"><a href="#无法刷新设备-“忽略数据包错误，继续…”" class="headerlink" title="无法刷新设备 - “忽略数据包错误，继续…”"></a>无法刷新设备 - “忽略数据包错误，继续…”</h3><h4 id="症状-3"><a href="#症状-3" class="headerlink" title="症状"></a>症状</h4><p>刷新设备时，您将获得：</p>
<pre><code>$ arm-none-eabi-gdb $file
Start address 0x8000194, load size 31588
Transfer rate: 22 KB/sec, 5264 bytes/write.
Ignoring packet error, continuing...
Ignoring packet error, continuing...</code></pre><h4 id="原因-3"><a href="#原因-3" class="headerlink" title="原因"></a>原因</h4><p><code>itmdump</code>在“打印”到 ITM 的程序运行时关闭。当前 GDB 会话将显示正常工作，只是没有 ITM 输出，但下一个 GDB 会话将出现错误，并显示上一节中显示的消息。</p>
<p>或者，<code>itmdump</code>被称为<strong>后，</strong>将<code>monitor tpiu</code>发出从而使 <code>itmdump</code>删除的文件/文件命名管道是OpenOCD的被写入。</p>
<h4 id="使固定-3"><a href="#使固定-3" class="headerlink" title="使固定"></a>使固定</h4><ul>
<li>关闭/杀死 GDB、OpenOCD 和 <code>itmdump</code></li>
<li>删除<code>itmdump</code>正在使用的文件/命名管道（例如， <code>itm.txt</code>）。</li>
<li>启动 OpenOCD</li>
<li>然后，启动 <code>itmdump</code></li>
<li>然后，启动执行<code>monitor tpiu</code>命令的 GDB 会话。</li>
</ul>
<h3 id="无法连接到-OpenOCD-“错误：无法将-telnet-绑定到套接字：地址已在使用中”"><a href="#无法连接到-OpenOCD-“错误：无法将-telnet-绑定到套接字：地址已在使用中”" class="headerlink" title="无法连接到 OpenOCD - “错误：无法将 telnet 绑定到套接字：地址已在使用中”"></a>无法连接到 OpenOCD - “错误：无法将 telnet 绑定到套接字：地址已在使用中”</h3><h4 id="症状-4"><a href="#症状-4" class="headerlink" title="症状"></a>症状</h4><p>在尝试与设备建立<em>新连接</em>时，您会收到如下所示的错误：</p>
<pre><code>$ openocd -f (..)
(..)
Error: couldn't bind telnet to socket: Address already in use</code></pre><h4 id="原因-4"><a href="#原因-4" class="headerlink" title="原因"></a>原因</h4><p>OpenOCD 需要访问的一个或多个端口 3333、4444 或 6666 正被另一个进程使用。这些端口中的每一个都用于另一个方面：3333 用于 gdb，4444 用于 telnet，6666 用于 TCL 的远程过程调用 (RPC) 命令</p>
<h4 id="使固定-4"><a href="#使固定-4" class="headerlink" title="使固定"></a>使固定</h4><p>你可以走两条路线来解决这个问题。A) 终止使用这些端口之一的任何进程。B) 指定您知道可供 OpenOCD 免费使用的不同端口。</p>
<p>方案一</p>
<p>苹果电脑：</p>
<ul>
<li>通过运行获取使用端口的进程列表 <code>sudo lsof -PiTCP -sTCP:LISTEN</code></li>
<li>通过记录它们的 pid 并<code>kill [pid]</code>为每个进程运行来终止阻塞关键端口的进程。（假设您可以确认他们没有在您的机器上运行任何关键任务！）</li>
</ul>
<p>方案B</p>
<p>全部：</p>
<ul>
<li>启动时将配置详细信息发送到 OpenOCD，以便它对任何进程使用与默认端口不同的端口。</li>
<li>例如，要在 4441 而不是默认的 4444 上执行其 telnet 功能，您将运行 <code>openocd -f interface/stlink-v2-1.cfg -f target/stm32f3x.cfg -c "telnet_port 4441"</code></li>
<li>更多关于 OpenOCD 配置阶段的细节可以在他们的 [official docs online] 中找到：<a href="http://openocd.org/doc/html/Server-Configuration.html" target="_blank" rel="noopener">http://openocd.org/doc/html/Server-Configuration.html</a></li>
</ul>
<h2 id="Cargo问题"><a href="#Cargo问题" class="headerlink" title="Cargo问题"></a>Cargo问题</h2><h3 id="“找不到Crate-core”"><a href="#“找不到Crate-core”" class="headerlink" title="“找不到Crate core”"></a>“找不到Crate <code>core</code>”</h3><h4 id="症状-5"><a href="#症状-5" class="headerlink" title="症状"></a>症状</h4><pre><code>   Compiling volatile-register v0.1.2
   Compiling rlibc v1.0.0
   Compiling r0 v0.1.0
error[E0463]: can't find crate for `core`

error: aborting due to previous error

error[E0463]: can't find crate for `core`

error: aborting due to previous error

error[E0463]: can't find crate for `core`

error: aborting due to previous error

Build failed, waiting for other jobs to finish...
Build failed, waiting for other jobs to finish...
error: Could not compile `r0`.

To learn more, run the command again with --verbose.</code></pre><h4 id="原因-5"><a href="#原因-5" class="headerlink" title="原因"></a>原因</h4><p>您使用的工具链早于<code>nightly-2018-04-08</code>并且忘记调用<code>rustup target add thumbv7em-none-eabihf</code>.</p>
<h4 id="使固定-5"><a href="#使固定-5" class="headerlink" title="使固定"></a>使固定</h4><p>每晚更新并安装<code>thumbv7em-none-eabihf</code>目标。</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup update nightly

$ rustup target add thumbv7em-none-eabihf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="How-to-use-GDB"><a href="#How-to-use-GDB" class="headerlink" title="How to use GDB"></a>How to use GDB</h1><p>下面是一些有用的 GDB 命令，可以帮助我们调试我们的程序。这假设您已将<a href="https://docs.rust-embedded.org/discovery/05-led-roulette/flash-it.html" target="_blank" rel="noopener">程序</a>刷入微控制器并连接到 OpenOCD 会话。</p>
<h2 id="一般调试"><a href="#一般调试" class="headerlink" title="一般调试"></a>一般调试</h2><blockquote>
<p><strong>注意：</strong>您在下面看到的许多命令都可以使用简短的形式执行。例如，<code>continue</code>可以简单地用作<code>c</code>，或者<code>break $location</code>可以用作<code>b $location</code>。一旦您对下面的命令有了经验，请尝试看看在 GDB 无法识别它们之前，您可以让这些命令运行多短！</p>
</blockquote>
<h3 id="处理断点"><a href="#处理断点" class="headerlink" title="处理断点"></a>处理断点</h3><ul>
<li><pre><code>break $location</code></pre><p>: 在代码中的某个位置设置断点。的值</p>
<pre><code>$location</code></pre><p>可以包括：</p>
<ul>
<li><code>break *main</code> - 中断函数的确切地址 <code>main</code></li>
<li><code>break *0x080012f2</code> - 打破确切的内存位置 <code>0x080012f2</code></li>
<li><code>break 123</code> - 在当前显示文件的第 123 行中断</li>
<li><code>break main.rs:123</code> - 在文件的第 123 行中断 <code>main.rs</code></li>
</ul>
</li>
<li><p><code>info break</code>: 显示当前断点</p>
</li>
<li><pre><code>delete</code></pre><p>: 删除所有断点</p>
<ul>
<li><code>delete $n</code>：删除断点<code>$n</code>（<code>n</code>是一个数，例如：<code>delete $2</code>）</li>
</ul>
</li>
<li><pre><code>clear</code></pre><p>: 删除下一条指令的断点</p>
<ul>
<li><code>clear main.rs:$function</code>: 删除<code>$function</code>in入口处的断点<code>main.rs</code></li>
<li><code>clear main.rs:123</code>: 删除第 123 行的断点 <code>main.rs</code></li>
</ul>
</li>
<li><pre><code>enable</code></pre><p>: 启用所有设置的断点</p>
<ul>
<li><code>enable $n</code>: 启用断点 <code>$n</code></li>
</ul>
</li>
<li><pre><code>disable</code></pre><p>: 禁用所有设置的断点</p>
<ul>
<li><code>disable $n</code>: 禁用断点 <code>$n</code></li>
</ul>
</li>
</ul>
<h3 id="控制执行"><a href="#控制执行" class="headerlink" title="控制执行"></a>控制执行</h3><ul>
<li><p><code>continue</code>: 开始或继续执行你的程序</p>
</li>
<li><pre><code>next</code></pre><p>: 执行程序的下一行</p>
<ul>
<li><code>next $n</code>: 重复<code>next</code> <code>$n</code>数次</li>
</ul>
</li>
<li><p><code>nexti</code>: 同，<code>next</code>但用机器指令代替</p>
</li>
<li><pre><code>step</code></pre><p>: 执行下一行，如果下一行包含对另一个函数的调用，则单步执行该代码</p>
<ul>
<li><code>step $n</code>: 重复<code>step</code> <code>$n</code>数次</li>
</ul>
</li>
<li><p><code>stepi</code>: 同，<code>step</code>但用机器指令代替</p>
</li>
<li><pre><code>jump $location</code></pre><p>：在指定位置恢复执行：</p>
<ul>
<li><code>jump 123</code>: 在第 123 行恢复执行</li>
<li><code>jump 0x080012f2</code>: 在地址 0x080012f2 处恢复执行</li>
</ul>
</li>
</ul>
<h3 id="印刷信息"><a href="#印刷信息" class="headerlink" title="印刷信息"></a>印刷信息</h3><ul>
<li><pre><code>print /$f $data</code></pre><p>- 打印变量包含的值</p>
<pre><code>$data</code></pre><p>。可以选择使用 格式化输出</p>
<pre><code>$f</code></pre><p>，其中可以包括：</p>
<pre class="line-numbers language-txt"><code class="language-txt">x: hexadecimal 
d: signed decimal
u: unsigned decimal
o: octal
t: binary
a: address
c: character
f: floating point<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>print /t 0xA</code>: 将十六进制值打印<code>0xA</code>为二进制 (0b1010)</li>
</ul>
</li>
<li><pre><code>x /$n$u$f $address</code></pre><p>: 检查内存在</p>
<pre><code>$address</code></pre><p>。可选地，</p>
<pre><code>$n</code></pre><p>定义要显示的单位数、</p>
<pre><code>$u</code></pre><p>单位大小（字节、半字、字等）、上面定义的</p>
<pre><code>$f</code></pre><p>任何</p>
<pre><code>print</code></pre><p>格式</p>
<ul>
<li><code>x /5i 0x080012c4</code>: 打印5条机器指令盯着地址 <code>0x080012c4</code></li>
<li><code>x/4xb $pc</code>: 从<code>$pc</code>当前指向的位置开始打印 4 个字节的内存</li>
</ul>
</li>
<li><pre><code>disassemble $location</code></pre><ul>
<li><code>disassemble /r main</code>：反汇编函数<code>main</code>，<code>/r</code>用于显示组成每条指令的字节</li>
</ul>
</li>
</ul>
<h3 id="查看符号表"><a href="#查看符号表" class="headerlink" title="查看符号表"></a>查看符号表</h3><ul>
<li><pre><code>info functions $regex</code></pre><p>: 打印匹配的函数的名称和数据类型</p>
<pre><code>$regex</code></pre><p>，省略</p>
<pre><code>$regex</code></pre><p>打印所有函数</p>
<ul>
<li><code>info functions main</code>: 打印包含单词的已定义函数的名称和类型 <code>main</code></li>
</ul>
</li>
<li><pre><code>info address $symbol</code></pre><p>: 打印</p>
<pre><code>$symbol</code></pre><p>内存中的存储位置</p>
<ul>
<li><code>info address GPIOC</code>: 打印变量的内存地址 <code>GPIOC</code></li>
</ul>
</li>
<li><p><code>info variables $regex</code>: 打印匹配的全局变量的名称和类型<code>$regex</code>，省略<code>$regex</code>打印所有全局变量</p>
</li>
<li><pre><code>ptype $data</code></pre><p>: 打印更多详细信息 </p>
<pre><code>$data</code></pre><ul>
<li><code>ptype cp</code>: 打印变量的详细类型信息 <code>cp</code></li>
</ul>
</li>
</ul>
<h3 id="浏览程序堆栈"><a href="#浏览程序堆栈" class="headerlink" title="浏览程序堆栈"></a>浏览程序堆栈</h3><ul>
<li><pre><code>backtrace $n</code></pre><p>: 打印</p>
<pre><code>$n</code></pre><p>帧轨迹，或省略</p>
<pre><code>$n</code></pre><p>打印所有帧</p>
<ul>
<li><code>backtrace 2</code>: 打印前 2 帧的轨迹</li>
</ul>
</li>
<li><p><code>frame $n</code>: 选择带编号或地址的帧<code>$n</code>，省略<code>$n</code>显示当前帧</p>
</li>
<li><p><code>up $n</code>: 选择帧<code>$n</code>帧向上</p>
</li>
<li><p><code>down $n</code>:<code>$n</code>向下选择帧帧</p>
</li>
<li><p><code>info frame $address</code>: 描述帧处<code>$address</code>，省略<code>$address</code>当前选定的帧</p>
</li>
<li><p><code>info args</code>: 打印选定帧的参数</p>
</li>
<li><pre><code>info registers $r</code></pre><p>: 打印</p>
<pre><code>$r</code></pre><p>选定帧中寄存器的值，</p>
<pre><code>$r</code></pre><p>所有寄存器 省略</p>
<ul>
<li><code>info registers $sp</code>: 打印<code>$sp</code>当前帧中栈指针寄存器的值</li>
</ul>
</li>
</ul>
<h3 id="远程控制-OpenOCD"><a href="#远程控制-OpenOCD" class="headerlink" title="远程控制 OpenOCD"></a>远程控制 OpenOCD</h3><ul>
<li><pre><code>monitor reset run</code></pre><p>：重置CPU，重新开始执行</p>
<ul>
<li><code>monitor reset</code>: 和上面一样</li>
</ul>
</li>
<li><p><code>monitor reset init</code>: 重置 CPU，在开始时停止执行</p>
</li>
<li><p><code>monitor targets</code>: 显示当前目标的信息和状态</p>
</li>
</ul>
<h1 id="😎《The-Embedonomicon》"><a href="#😎《The-Embedonomicon》" class="headerlink" title="😎《The Embedonomicon》"></a>😎《The Embedonomicon》</h1><h1 id="The-embedonomicon"><a href="#The-embedonomicon" class="headerlink" title="The embedonomicon"></a>The embedonomicon</h1><p>embedonomion 将引导您完成<code>#![no_std]</code>从头开始创建应用程序的过程，以及为 Cortex-M 微控制器构建特定于架构的功能的迭代过程。</p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><p>这本书是自包含的。读者不需要熟悉 Cortex-M 架构，也不需要访问 Cortex-M 微控制器——本书中包含的所有示例都可以在 QEMU 中进行测试。但是，您需要安装以下工具来运行和检查本书中的示例：</p>
<ul>
<li>本书所有代码均使用2018版。如果您不熟悉 2018 年的功能和习惯用法，请查看<a href="https://rust-lang-nursery.github.io/edition-guide/" target="_blank" rel="noopener"><code>edition guide</code></a>.</li>
<li>Rust 1.31 或更新的工具链加上 ARM Cortex-M 编译支持。</li>
<li><a href="https://github.com/japaric/cargo-binutils" target="_blank" rel="noopener"><code>cargo-binutils</code></a>. v0.1.4 或更新版本。</li>
<li><a href="https://crates.io/crates/cargo-edit" target="_blank" rel="noopener"><code>cargo-edit</code></a>.</li>
<li>QEMU 支持 ARM 仿真。该<code>qemu-system-arm</code>程序必须安装在您的计算机上。</li>
<li>具有 ARM 支持的 GDB。</li>
</ul>
<h3 id="示例设置"><a href="#示例设置" class="headerlink" title="示例设置"></a>示例设置</h3><p>所有操作系统通用的指令</p>
<pre class="line-numbers language-console"><code class="language-console">$ # Rust toolchain
$ # If you start from scratch, get rustup from https://rustup.rs/
$ rustup default stable

$ # toolchain should be newer than this one
$ rustc -V
rustc 1.31.0 (abe02cefd 2018-12-04)

$ rustup target add thumbv7m-none-eabi

$ # cargo-binutils
$ cargo install cargo-binutils

$ rustup component add llvm-tools-preview<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="苹果系统-1"><a href="#苹果系统-1" class="headerlink" title="苹果系统"></a>苹果系统</h4><pre class="line-numbers language-console"><code class="language-console">$ # arm-none-eabi-gdb
$ # you may need to run `brew tap Caskroom/tap` first
$ brew cask install gcc-arm-embedded

$ # QEMU
$ brew install qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-16-04"><a href="#Ubuntu-16-04" class="headerlink" title="Ubuntu 16.04"></a>Ubuntu 16.04</h4><pre class="line-numbers language-console"><code class="language-console">$ # arm-none-eabi-gdb
$ sudo apt install gdb-arm-none-eabi

$ # QEMU
$ sudo apt install qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Ubuntu-18-04-或-Debian"><a href="#Ubuntu-18-04-或-Debian" class="headerlink" title="Ubuntu 18.04 或 Debian"></a>Ubuntu 18.04 或 Debian</h4><pre class="line-numbers language-console"><code class="language-console">$ # gdb-multiarch -- use `gdb-multiarch` when you wish to invoke gdb
$ sudo apt install gdb-multiarch

$ # QEMU
$ sudo apt install qemu-system-arm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="视窗"><a href="#视窗" class="headerlink" title="视窗"></a>视窗</h4><ul>
<li><a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">arm-none-eabi-gdb</a>。GNU Arm 嵌入式工具链包括 GDB。</li>
<li><a href="https://www.qemu.org/download/#windows" target="_blank" rel="noopener">qemu</a></li>
</ul>
<h2 id="从-ARM-安装工具链包（可选步骤）（在-Ubuntu-18-04-上测试）"><a href="#从-ARM-安装工具链包（可选步骤）（在-Ubuntu-18-04-上测试）" class="headerlink" title="从 ARM 安装工具链包（可选步骤）（在 Ubuntu 18.04 上测试）"></a>从 ARM 安装工具链包（可选步骤）（在 Ubuntu 18.04 上测试）</h2><ul>
<li>随着 2018 年底从<a href="https://rust-embedded.github.io/blog/2018-08-2x-psa-cortex-m-breakage/" target="_blank" rel="noopener">GCC 的链接器</a>切换 到Cortex-M 微控制器的<a href="https://rust-embedded.github.io/blog/2018-08-2x-psa-cortex-m-breakage/" target="_blank" rel="noopener">LLD</a>，不再需要<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">gcc-arm-none-eabi</a>。但是对于那些希望使用工具链的人来说，从<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">这里</a>安装并按照下面列出的步骤操作：</li>
</ul>
<pre class="line-numbers language-console"><code class="language-console">$ tar xvjf gcc-arm-none-eabi-8-2018-q4-major-linux.tar.bz2
$ mv gcc-arm-none-eabi-<version_downloaded> <your_desired_path> # optional
$ export PATH=${PATH}:<path_to_arm_none_eabi_folder>/bin # add this line to .bashrc to make persisten<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="The-smallest-no-std-program"><a href="#The-smallest-no-std-program" class="headerlink" title="The smallest #![no_std] program"></a>The smallest <code>#![no_std]</code> program</h1><p>在本节中，我们将编写最小的<code>#![no_std]</code>程序来<em>编译</em>.</p>
<h2 id="什么-no-std-意思？"><a href="#什么-no-std-意思？" class="headerlink" title="什么#![no_std]意思？"></a>什么<code>#![no_std]</code>意思？</h2><p><code>#![no_std]</code>是一个 crate 级别属性，表示 crate 将链接到<a href="https://doc.rust-lang.org/core/" target="_blank" rel="noopener"><code>core</code></a> crate 而不是<a href="https://doc.rust-lang.org/std/" target="_blank" rel="noopener"><code>std</code></a>crate，但这对应用程序意味着什么？</p>
<p>该<code>std</code>箱是除锈的标准库。它包含假定程序将在操作系统上运行而不是<a href="https://en.wikipedia.org/wiki/Bare_machine" target="_blank" rel="noopener"><em>直接在金属上运行的功能</em></a>。<code>std</code>还假设操作系统是通用操作系统，就像在服务器和台式机中找到的操作系统一样。出于这个原因，<code>std</code>提供了一个标准 API，而不是通常在以下操作系统中可以找到的功能：线程、文件、套接字、文件系统、进程等。</p>
<p>另一方面，<code>core</code>包是包的子集，<code>std</code>它对程序将在其上运行的系统做出零假设。因此，它为浮点数、字符串和切片等语言原语提供 API，以及公开原子操作和 SIMD 指令等处理器功能的 API。然而，它缺少任何涉及堆内存分配和 I/O 的 API。</p>
<p>对于应用程序来说，<code>std</code>不仅仅是提供一种访问操作系统抽象的方法。<code>std</code>它还负责设置堆栈溢出保护、处理命令行参数以及在<code>main</code>调用程序函数之前生成主线程等。一个<code>#![no_std]</code> 应用程序缺乏所有标准运行，所以它必须初始化它自己的运行时，如果有需要。</p>
<p>由于这些属性，<code>#![no_std]</code>应用程序可以是系统上运行的第一个和/或唯一的代码。它可以是标准 Rust 应用程序永远无法做到的许多事情，例如：</p>
<ul>
<li>操作系统的内核。</li>
<li>固件。</li>
<li>一个引导程序。</li>
</ul>
<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>有了这个，我们可以继续<code>#![no_std]</code>编译最小的程序：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --edition 2018 --bin app

$ cd app
$ # modify main.rs so it has these contents
$ cat src/main.rs
#![no_main]
#![no_std]

use core::panic::PanicInfo;

#[panic_handler]
fn panic(_panic: &PanicInfo<'_>) -> ! {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个程序包含一些你在标准 Rust 程序中看不到的东西：</p>
<p><code>#![no_std]</code>我们已经广泛涵盖的属性。</p>
<p>该<code>#![no_main]</code>属性意味着程序不会使用标准<code>main</code>函数作为其入口点。在撰写本文时，Rust 的<code>main</code>接口对程序执行的环境做了一些假设：例如，它假设存在命令行参数，因此一般来说，它不适用于<code>#![no_std]</code>程序。</p>
<p>该<code>#[panic_handler]</code>属性。标有此属性的函数定义了恐慌的行为，包括库级恐慌 ( <code>core::panic!</code>) 和语言级恐慌（越界索引）。</p>
<p>这个程序不会产生任何有用的东西。事实上，它会产生一个空的二进制文件。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # equivalent to `size target/thumbv7m-none-eabi/debug/app`
$ cargo size --target thumbv7m-none-eabi --bin app
   text       data        bss        dec        hex    filename
      0          0          0          0          0    app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在链接板条箱之前确实包含恐慌符号。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo rustc --target thumbv7m-none-eabi -- --emit=obj

$ cargo nm -- target/thumbv7m-none-eabi/debug/deps/app-*.o | grep '[0-9]* [^N] '
00000000 T rust_begin_unwind<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然而，这是我们的起点。在下一节中，我们将构建一些有用的东西。但在继续之前，让我们设置一个默认构建目标，以避免必须将<code>--target</code>标志传递给每个 Cargo 调用。</p>
<pre class="line-numbers language-console"><code class="language-console">$ mkdir .cargo

$ # modify .cargo/config so it has these contents
$ cat .cargo/config
[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="eh-personality"><a href="#eh-personality" class="headerlink" title="eh_personality"></a>eh_personality</h2><p>如果您的配置没有因恐慌而无条件中止，而完整操作系统的大多数目标都没有（或者如果您的<a href="https://docs.rust-embedded.org/embedonomicon/custom-target.html" target="_blank" rel="noopener">自定义目标</a>不包含 <code>"panic-strategy": "abort"</code>），那么您必须告诉 Cargo 这样做或添加一个<code>eh_personality</code>函数，这需要每晚编译器。<a href="https://doc.rust-lang.org/unstable-book/language-features/lang-items.html#more-about-the-language-items" target="_blank" rel="noopener">这是 Rust 关于它的文档</a>，<a href="https://www.reddit.com/r/rust/comments/estvau/til_why_the_eh_personality_language_item_is/" target="_blank" rel="noopener">这里有一些关于它的讨论</a>。</p>
<p>在 Cargo.toml 中，添加：</p>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者，声明<code>eh_personality</code>函数。一个在展开时不做任何特殊事情的简单实现如下：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(lang_items)]</span>

#<span class="token punctuation">[</span>lang <span class="token operator">=</span> <span class="token string">"eh_personality"</span><span class="token punctuation">]</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">eh_personality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>language item required, but not found: 'eh_personality'</code>如果不包括在内，您将收到错误消息。</p>
<h1 id="Memory-layout"><a href="#Memory-layout" class="headerlink" title="Memory layout"></a>Memory layout</h1><p>下一步是确保程序具有正确的内存布局，以便目标系统能够执行它。在我们的示例中，我们将使用虚拟 Cortex-M3 微控制器： <a href="http://www.ti.com/product/LM3S6965" target="_blank" rel="noopener">LM3S6965</a>。我们的程序将是设备上运行的唯一进程，因此它还必须负责初始化设备。</p>
<h2 id="背景资料"><a href="#背景资料" class="headerlink" title="背景资料"></a>背景资料</h2><p>Cortex-M 设备要求在其<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/memory-model" target="_blank" rel="noopener">代码存储区</a>的开头存在一个<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/exception-model/vector-table" target="_blank" rel="noopener">向量表</a>。向量表是一个指针数组；启动设备需要前两个指针，其余指针与异常有关。我们暂时忽略它们。</p>
<p>链接器决定程序的最终内存布局，但我们可以使用<a href="https://sourceware.org/binutils/docs/ld/Scripts.html" target="_blank" rel="noopener">链接器脚本</a>对其进行一些控制。链接器脚本为我们提供的布局控制粒度是在<em>部分</em>级别。节是在连续内存中布置的<em>符号</em>集合。反过来，符号可以是数据（静态变量）或指令（Rust 函数）。</p>
<p>每个符号都有一个由编译器分配的名称。作为防锈1.28的，名称，该锈编译受让人以符号的形式为：<code>_ZN5krate6module8function17he1dfc17c86fe16daE</code>，其中demangles到 <code>krate::module::function::he1dfc17c86fe16da</code>哪里<code>krate::module::function</code>是函数或变量的路径和<code>he1dfc17c86fe16da</code>是某种散列。Rust 编译器会将每个符号放入自己唯一的部分；例如，前面提到的符号将放置在名为<code>.text._ZN5krate6module8function17he1dfc17c86fe16daE</code>.</p>
<p>这些编译器生成的符号和节名称不能保证在 Rust 编译器的不同版本中保持不变。但是，该语言允许我们通过以下属性控制符号名称和部分位置：</p>
<ul>
<li><code>#[export_name = "foo"]</code>将符号名称设置为<code>foo</code>.</li>
<li><code>#[no_mangle]</code>意思是：使用函数或变量名（不是它的完整路径）作为它的符号名。 <code>#[no_mangle] fn bar()</code>将产生一个名为 的符号<code>bar</code>。</li>
<li><code>#[link_section = ".bar"]</code>将符号放在名为 的部分中<code>.bar</code>。</li>
</ul>
<p>通过这些属性，我们可以公开程序的稳定 ABI 并在链接描述文件中使用它。</p>
<h2 id="The-Rust-side"><a href="#The-Rust-side" class="headerlink" title="The Rust side"></a>The Rust side</h2><p>如上所述，对于 Cortex-M 设备，我们需要填充向量表的前两个条目。第一个，堆栈指针的初始值，可以仅使用链接描述文件填充。第二个是重置向量，需要在 Rust 代码中创建并使用链接描述文件正确放置。</p>
<p>重置向量是指向重置处理程序的指针。复位处理程序是设备在系统复位后或第一次上电后将执行的函数。重置处理程序始终是硬件调用堆栈中的第一个堆栈帧；从它返回是未定义的行为，因为没有其他堆栈帧要返回。我们可以通过使其成为一个发散函数来强制重置处理程序永远不会返回，这是一个带有签名的函数<code>fn(/* .. */) -&gt; !</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// can't return so we go into an infinite loop here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// The reset vector, a pointer into the reset handler</span>
#<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".vector_table.reset_vector"</span><span class="token punctuation">]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">static</span> RESET_VECTOR<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token operator">=</span> Reset<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>硬件在这里需要某种格式，我们坚持使用它<code>extern "C"</code>来告诉编译器使用 C ABI 降低函数，而不是不稳定的 Rust ABI。</p>
<p>要从链接描述文件中引用重置处理程序和重置向量，我们需要它们有一个稳定的符号名称，因此我们使用<code>#[no_mangle]</code>. 我们需要对 的位置进行精细控制<code>RESET_VECTOR</code>，因此我们将其放置在已知部分 中<code>.vector_table.reset_vector</code>。重置处理程序本身的确切位置<code>Reset</code>并不重要。我们只是坚持使用默认的编译器生成部分。</p>
<p>链接器在遍历输入目标文件列表时将忽略具有内部链接的符号（也称为内部符号），因此我们需要我们的两个符号具有外部链接。在 Rust 中将符号设为外部的唯一方法是将其对应的项目设为公开 ( <code>pub</code>) 且<em>可访问</em>（项目和 crate 的根之间没有私有模块）。</p>
<h2 id="链接器脚本端"><a href="#链接器脚本端" class="headerlink" title="链接器脚本端"></a>链接器脚本端</h2><p>将向量表放置在正确位置的最小链接描述文件如下所示。让我们来看看它。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat link.x
/* Memory layout of the LM3S6965 microcontroller */
/* 1K = 1 KiBi = 1024 bytes */
MEMORY
{
  FLASH : ORIGIN = 0x00000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 64K
}

/* The entry point is the reset handler */
ENTRY(Reset);

EXTERN(RESET_VECTOR);

SECTIONS
{
  .vector_table ORIGIN(FLASH) :
  {
    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));
  } > FLASH

  .text :
  {
    *(.text .text.*);
  } > FLASH

  /DISCARD/ :
  {
    *(.ARM.exidx .ARM.exidx.*);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="MEMORY"><a href="#MEMORY" class="headerlink" title="MEMORY"></a><code>MEMORY</code></h3><p>链接描述文件的这一部分描述了目标内存块的位置和大小。定义了两个内存块：<code>FLASH</code>和<code>RAM</code>; 它们对应于目标中可用的物理内存。此处使用的值对应于 LM3S6965 微控制器。</p>
<h3 id="ENTRY"><a href="#ENTRY" class="headerlink" title="ENTRY"></a><code>ENTRY</code></h3><p>这里我们向链接器指示符号名称为 的重置处理程序<code>Reset</code>是程序的 <em>入口点</em>。链接器积极丢弃未使用的部分。链接器将入口点和从中调用的函数视为已<em>使用，</em>因此不会丢弃它们。如果没有这一行，链接器将丢弃该<code>Reset</code>函数以及从它调用的所有后续函数。</p>
<h3 id="EXTERN"><a href="#EXTERN" class="headerlink" title="EXTERN"></a><code>EXTERN</code></h3><p>链接器是懒惰的；一旦他们找到了从入口点递归引用的所有符号，他们将停止查看输入目标文件。即使在找到所有其他引用的符号之后，也<code>EXTERN</code>强制链接器查找<code>EXTERN</code>的参数。根据经验，如果您需要一个未从入口点调用的符号始终出现在输出二进制文件中，则应<code>EXTERN</code>与<code>KEEP</code>.</p>
<h3 id="SECTIONS"><a href="#SECTIONS" class="headerlink" title="SECTIONS"></a><code>SECTIONS</code></h3><p>这部分描述了输入目标文件中的节（也称为<em>输入节</em>）如何安排在输出目标文件的节（也称为输出节）中，或者它们是否应该被丢弃。这里我们定义了两个输出部分：</p>
<pre class="line-numbers language-text"><code class="language-text">  .vector_table ORIGIN(FLASH) : { /* .. */ } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>.vector_table</code>包含向量表并位于<code>FLASH</code>内存的开头。</p>
<pre class="line-numbers language-text"><code class="language-text">  .text : { /* .. */ } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>.text</code>包含程序子程序并位于<code>FLASH</code>. 它的起始地址没有指定，但链接器将把它放在前一个输出段之后 <code>.vector_table</code>。</p>
<p>输出<code>.vector_table</code>部分包含：</p>
<pre class="line-numbers language-text"><code class="language-text">    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们将（调用）堆栈放在 RAM 的末尾（堆栈<em>已满降序</em>；它向更小的地址增长），因此 RAM 的结束地址将用作初始堆栈指针 (SP) 值。该地址是使用我们为<code>RAM</code> 内存块输入的信息在链接描述文件中计算出来的。</p>
<pre><code>    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));</code></pre><p>接下来，我们使用<code>KEEP</code>强制链接器<code>.vector_table.reset_vector</code>在初始 SP 值之后插入所有命名的输入节 。位于该部分的唯一符号是<code>RESET_VECTOR</code>，因此这将有效地<code>RESET_VECTOR</code>排在向量表中的第二位。</p>
<p>输出<code>.text</code>部分包含：</p>
<pre class="line-numbers language-text"><code class="language-text">    *(.text .text.*);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这包括所有名为<code>.text</code>和的输入部分<code>.text.*</code>。请注意，我们<code>KEEP</code> 在此处不使用让链接器丢弃未使用的部分。</p>
<p>最后，我们使用特殊<code>/DISCARD/</code>部分丢弃</p>
<pre class="line-numbers language-text"><code class="language-text">    *(.ARM.exidx .ARM.exidx.*);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>名为<code>.ARM.exidx.*</code>. 这些部分与异常处理有关，但我们不会对恐慌进行堆栈展开，它们会占用闪存中的空间，因此我们只是将它们丢弃。</p>
<h2 id="把这一切放在一起"><a href="#把这一切放在一起" class="headerlink" title="把这一切放在一起"></a>把这一切放在一起</h2><p>现在我们可以链接应用程序。作为参考，这里是完整的 Rust 程序：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>panic<span class="token punctuation">:</span><span class="token punctuation">:</span>PanicInfo<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// The reset handler</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// can't return so we go into an infinite loop here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// The reset vector, a pointer into the reset handler</span>
#<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".vector_table.reset_vector"</span><span class="token punctuation">]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">static</span> RESET_VECTOR<span class="token punctuation">:</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token operator">=</span> Reset<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[panic_handler]</span>
<span class="token keyword">fn</span> <span class="token function">panic</span><span class="token punctuation">(</span>_panic<span class="token punctuation">:</span> <span class="token operator">&amp;</span>PanicInfo<span class="token operator">&lt;</span>'_<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们必须调整链接器进程以使其使用我们的链接器脚本。这是通过将<code>-C link-arg</code>标志传递给<code>rustc</code>. 这可以通过<code>cargo-rustc</code>或 来完成<code>cargo-build</code>。</p>
<p><strong>重要提示</strong>：<code>.cargo/config</code>在运行此命令之前，请确保您拥有在最后一节末尾添加的文件。</p>
<p>使用<code>cargo-rustc</code>子命令：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo rustc -- -C link-arg=-Tlink.x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者您可以设置 rustflags<code>.cargo/config</code>并继续使用 <code>cargo-build</code>子命令。我们会做后者，因为它可以更好地与 <code>cargo-binutils</code>.</p>
<pre class="line-numbers language-console"><code class="language-console"># modify .cargo/config so it has these contents
$ cat .cargo/config
[target.thumbv7m-none-eabi]
rustflags = ["-C", "link-arg=-Tlink.x"]

[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>[target.thumbv7m-none-eabi]</code>部分表示这些标志仅在交叉编译到该目标时才会使用。</p>
<h2 id="检查它"><a href="#检查它" class="headerlink" title="检查它"></a>检查它</h2><p>现在让我们检查输出二进制文件以确认内存布局看起来像我们想要的那样（这需要<a href="https://github.com/rust-embedded/cargo-binutils#readme" target="_blank" rel="noopener"><code>cargo-binutils</code></a>）：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -d -no-show-raw-insn
app:    file format elf32-littlearm


Disassembly of section .text:

<Reset>:
                   sub    sp, #4
                   movs    r0, #42
                   str    r0, [sp]
                   b    #-2 <Reset+0x8>
                   b    #-4 <Reset+0x8><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是该<code>.text</code>部分的拆解。我们看到名为 的重置处理程序<code>Reset</code>位于 address <code>0x8</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -s -section .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 09000000                    ... ....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这显示了该<code>.vector_table</code>部分的内容。我们可以看到该部分从地址开始，<code>0x0</code>并且该部分的第一个字是<code>0x2001_0000</code>（<code>objdump</code>输出为小端格式）。这是初始 SP 值并匹配 RAM 的结束地址。第二个字是<code>0x9</code>; 这是重置处理程序的<em>拇指模式</em>地址。当要在拇指模式下执行功能时，其地址的第一位设置为 1。</p>
<h2 id="测试它"><a href="#测试它" class="headerlink" title="测试它"></a>测试它</h2><p>该程序是有效的LM3S6965程序；我们可以在虚拟微控制器 (QEMU) 中执行它来测试它。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # this program will block
$ qemu-system-arm \
      -cpu cortex-m3 \
      -machine lm3s6965evb \
      -gdb tcp::3333 \
      -S \
      -nographic \
      -kernel target/thumbv7m-none-eabi/debug/app
$ # on a different terminal
$ arm-none-eabi-gdb -q target/thumbv7m-none-eabi/debug/app
Reading symbols from target/thumbv7m-none-eabi/debug/app...done.

(gdb) target remote :3333
Remote debugging using :3333
Reset () at src/main.rs:8
8       pub unsafe extern "C" fn Reset() -> ! {

(gdb) # the SP has the initial value we programmed in the vector table
(gdb) print/x $sp
$1 = 0x20010000

(gdb) step
9           let _x = 42;

(gdb) step
12          loop {}

(gdb) # next we inspect the stack variable `_x`
(gdb) print _x
$2 = 42

(gdb) print &_x
$3 = (i32 *) 0x2000fffc

(gdb) quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="A-main-interface"><a href="#A-main-interface" class="headerlink" title="A main interface"></a>A <code>main</code> interface</h1><p>我们现在有一个最小的工作程序，但我们需要以最终用户可以在其上构建安全程序的方式对其进行打包。在本节中，我们将实现一个<code>main</code>类似于标准 Rust 程序使用的接口。</p>
<p>首先，我们将二进制 crate 转换为 library crate：</p>
<pre class="line-numbers language-console"><code class="language-console">$ mv src/main.rs src/lib.rs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后将其重命名为<code>rt</code>代表“运行时”的名称。</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -i s/app/rt/ Cargo.toml

$ head -n4 Cargo.toml
[package]
edition = "2018"
name = "rt" # <-
version = "0.1.0"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个更改是让重置处理程序调用外部<code>main</code>函数：</p>
<pre class="line-numbers language-console"><code class="language-console">$ head -n13 src/lib.rs
#![no_std]

use core::panic::PanicInfo;

// CHANGED!
#[no_mangle]
pub unsafe extern "C" fn Reset() -> ! {
    extern "Rust" {
        fn main() -> !;
    }

    main()
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们还删除了该<code>#![no_main]</code>属性，因为它对库箱没有影响。</p>
<blockquote>
<p>有这么出现在这个阶段正交问题：如若<code>rt</code> 库提供了一个标准恐慌行为，还是应该<em>不是</em>提供一个 <code>#[panic_handler]</code>功能，让最终用户选择恐慌行为？本文档不会深入研究该问题，并且为简单起见，将<code>#[panic_handler]</code>在<code>rt</code>crate 中保留虚拟函数。但是，我们想通知读者还有其他选择。</p>
</blockquote>
<p>第二个更改涉及将我们之前编写的链接描述文件提供给应用程序包。链接器将在库搜索路径 ( <code>-L</code>) 和调用它的目录中搜索链接器脚本。应用程序包不需要携带 的副本，<code>link.x</code>因此我们将<code>rt</code>使用<a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener">构建脚本</a>将链接器脚本放在库搜索路径中。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # create a build.rs file in the root of `rt` with these contents
$ cat build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，用户可以编写一个应用程序来公开<code>main</code>符号并将其链接到<code>rt</code>crate。在<code>rt</code>将给予该节目内存布局护理。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cd ..

$ cargo new --edition 2018 --bin app

$ cd app

$ # modify Cargo.toml to include the `rt` crate as a dependency
$ tail -n2 Cargo.toml
[dependencies]
rt = { path = "../rt" }
$ # copy over the config file that sets a default target and tweaks the linker invocation
$ cp -r ../rt/.cargo .

$ # change the contents of `main.rs` to
$ cat src/main.rs
#![no_std]
#![no_main]

extern crate rt;

#[no_mangle]
pub fn main() -> ! {
    let _x = 42;

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>反汇编将类似，但现在将包括用户<code>main</code>功能。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -d -no-show-raw-insn
app:    file format elf32-littlearm


Disassembly of section .text:

<main>:
                   sub    sp, #4
                   movs    r0, #42
                   str    r0, [sp]
                   b    #-2 <main+0x8>
                   b    #-4 <main+0x8>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-18
                   trap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="使其类型安全"><a href="#使其类型安全" class="headerlink" title="使其类型安全"></a>使其类型安全</h2><p>该<code>main</code>接口的工作原理，但它很容易理解错误。例如，用户可以编写<code>main</code> 为非发散函数，并且不会出现编译时错误和未定义的行为（编译器会错误优化程序）。</p>
<p>我们可以通过向用户公开宏而不是符号接口来添加类型安全性。在 <code>rt</code>crate 中，我们可以编写这个宏：</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n12 ../rt/src/lib.rs
#[macro_export]
macro_rules! entry {
    ($path:path) => {
        #[export_name = "main"]
        pub unsafe fn __main() -> ! {
            // type check the given path
            let f: fn() -> ! = $path;

            f()
        }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后应用程序编写者可以像这样调用它：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_std]
#![no_main]

use rt::entry;

entry!(main);

fn main() -> ! {
    let _x = 42;

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，如果作者将 的签名更改<code>main</code>为非发散函数，例如<code>fn()</code>.</p>
<h2 id="主线前的生活"><a href="#主线前的生活" class="headerlink" title="主线前的生活"></a>主线前的生活</h2><p><code>rt</code>看起来不错，但功能不完整！针对它编写的应用程序不能使用 <code>static</code>变量或字符串文字，因为<code>rt</code>的链接器脚本没有定义标准的 <code>.bss</code>,<code>.data</code>和<code>.rodata</code>部分。让我们解决这个问题！</p>
<p>第一步是在链接描述文件中定义这些部分：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,46p ../rt/link.x
  .text :
  {
    *(.text .text.*);
  } > FLASH

  /* NEW! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } > FLASH

  .bss :
  {
    *(.bss .bss.*);
  } > RAM

  .data :
  {
    *(.data .data.*);
  } > RAM

  /DISCARD/ :<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>他们只是重新导出输入部分并指定每个输出部分将位于哪个内存区域。</p>
<p>通过这些更改，将编译以下程序：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> RODATA<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">b"Hello, world!"</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> BSS<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">mut</span> DATA<span class="token punctuation">:</span> u16 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> RODATA<span class="token punctuation">;</span>
    <span class="token keyword">let</span> _y <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span>BSS <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _z <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span>DATA <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，如果您在真实硬件上运行此程序并对其进行调试，您将观察到<code>static</code> 变量<code>BSS</code>和<code>DATA</code>没有值<code>0</code>并且<code>1</code>到了时间<code>main</code>。相反，这些变量将具有垃圾值。问题是在设备上电后 RAM 的内容是随机的。如果您在 QEMU 中运行程序，您将无法观察到这种效果。</p>
<p>事实上，如果您的程序<code>static</code>在执行写入之前读取任何变量，那么您的程序具有未定义的行为。让我们通过<code>static</code>在调用之前初始化所有变量来解决这个问题<code>main</code>。</p>
<p>我们需要稍微调整链接器脚本以进行 RAM 初始化：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,52p ../rt/link.x
  .text :
  {
    *(.text .text.*);
  } > FLASH

  /* CHANGED! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } > FLASH

  .bss :
  {
    _sbss = .;
    *(.bss .bss.*);
    _ebss = .;
  } > RAM

  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
  {
    _sdata = .;
    *(.data .data.*);
    _edata = .;
  } > RAM

  _sidata = LOADADDR(.data);

  /DISCARD/ :<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们来看看这些变化的细节：</p>
<pre class="line-numbers language-text"><code class="language-text">    _sbss = .;
    _ebss = .;
    _sdata = .;
    _edata = .;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将符号与<code>.bss</code>和<code>.data</code>节的开始和结束地址相关联，稍后我们将在 Rust 代码中使用它们。</p>
<pre class="line-numbers language-text"><code class="language-text">  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们将节的加载内存地址 (LMA) 设置为<code>.data</code>节的末尾<code>.rodata</code> 。该<code>.data</code>包含<code>static</code>具有非零初始值变量; 该部分的虚拟内存地址 (VMA)<code>.data</code>位于 RAM 中的某个位置——这是<code>static</code>变量所在的位置。<code>static</code>但是，这些变量的初始值必须分配在非易失性存储器 (Flash) 中；LMA 是闪存中存储这些初始值的位置。</p>
<pre class="line-numbers language-text"><code class="language-text">  _sidata = LOADADDR(.data);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后，我们将一个符号与 的 LMA 相关联<code>.data</code>。</p>
<p>在 Rust 方面，我们将<code>.bss</code>部分归零并初始化<code>.data</code>部分。我们可以从 Rust 代码中引用我们在链接描述文件中创建的符号。这些符号的<em>地址</em><a href="https://docs.rust-embedded.org/embedonomicon/main.html#1" target="_blank" rel="noopener">1</a>是<code>.bss</code>和<code>.data</code>段的边界。</p>
<p>更新后的重置处理程序如下所示：</p>
<pre class="line-numbers language-console"><code class="language-console">$ head -n32 ../rt/src/lib.rs
#![no_std]

use core::panic::PanicInfo;
use core::ptr;

#[no_mangle]
pub unsafe extern "C" fn Reset() -> ! {
    // NEW!
    // Initialize RAM
    extern "C" {
        static mut _sbss: u8;
        static mut _ebss: u8;

        static mut _sdata: u8;
        static mut _edata: u8;
        static _sidata: u8;
    }

    let count = &_ebss as *const u8 as usize - &_sbss as *const u8 as usize;
    ptr::write_bytes(&mut _sbss as *mut u8, 0, count);

    let count = &_edata as *const u8 as usize - &_sdata as *const u8 as usize;
    ptr::copy_nonoverlapping(&_sidata as *const u8, &mut _sdata as *mut u8, count);

    // Call user entry point
    extern "Rust" {
        fn main() -> !;
    }

    main()
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在最终用户可以直接或间接地使用<code>static</code>变量而不会遇到未定义的行为！</p>
<blockquote>
<p>在上面的代码中，我们以字节方式执行了内存初始化。可以强制将<code>.bss</code>和<code>.data</code>部分对齐到 4 个字节。然后可以在 Rust 代码中使用这个事实来执行逐字初始化，同时省略对齐检查。如果您有兴趣了解如何实现这一点，请查看<a href="https://github.com/japaric/cortex-m-rt/tree/v0.5.1" target="_blank" rel="noopener"><code>cortex-m-rt</code></a>板条箱。</p>
</blockquote>
<h1 id="Exception-handling"><a href="#Exception-handling" class="headerlink" title="Exception handling"></a>Exception handling</h1><p>在“内存布局”部分，我们决定从简单开始，忽略异常处理。在本节中，我们将添加对处理它们的支持；这是如何在稳定的 Rust 中实现编译时可覆盖行为的示例（即不依赖不稳定的<code>#[linkage = "weak"]</code>属性，这会使符号变弱）。</p>
<h2 id="背景资料-1"><a href="#背景资料-1" class="headerlink" title="背景资料"></a>背景资料</h2><p>简而言之，<em>异常</em>是 Cortex-M 和其他架构提供的一种机制，用于让应用程序响应异步事件，通常是外部事件。大多数人都知道的最突出的异常类型是经典（硬件）中断。</p>
<p>Cortex-M 异常机制的工作原理是这样的：当处理器接收到与某种异常相关的信号或事件时，它会暂停当前子程序的执行（通过将状态存储在调用堆栈中），然后继续执行相应的子程序异常处理程序，另一个子程序，在一个新的堆栈帧中。在完成异常处理程序的执行（即从它返回）后，处理器恢复执行挂起的子程序。</p>
<p>处理器使用向量表来决定要执行的处理程序。表中的每个条目都包含一个指向处理程序的指针，每个条目对应不同的异常类型。例如，第二个条目是重置处理程序，第三个条目是 NMI（不可屏蔽中断）处理程序，依此类推。</p>
<p>如前所述，处理器期望向量表位于内存中的某个特定位置，并且其中的每个条目都可能在运行时被处理器使用。因此，条目必须始终包含有效值。此外，我们希望<code>rt</code>crate 是灵活的，以便最终用户可以自定义每个异常处理程序的行为。最后，向量表驻留在只读内存中，或者更确切地说是在不容易修改的内存中，因此用户必须静态注册处理程序，而不是在运行时。</p>
<p>为了满足所有这些约束，我们将为crate 中向量表的所有条目分配一个<em>默认</em>值<code>rt</code>，但使这些值有点<em>弱，</em>以便最终用户在编译时覆盖它们。</p>
<h2 id="Rust-side"><a href="#Rust-side" class="headerlink" title="Rust side"></a>Rust side</h2><p>让我们看看如何实现所有这些。为简单起见，我们将只处理向量表的前 16 个条目；这些条目不是特定于设备的，因此它们在任何类型的 Cortex-M 微控制器上都具有相同的功能。</p>
<p>我们要做的第一件事是在<code>rt</code>crate 的代码中创建一个向量数组（指向异常处理程序的指针） ：</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -n 56,91p ../rt/src/lib.rs
pub union Vector {
    reserved: u32,
    handler: unsafe extern "C" fn(),
}

extern "C" {
    fn NMI();
    fn HardFault();
    fn MemManage();
    fn BusFault();
    fn UsageFault();
    fn SVCall();
    fn PendSV();
    fn SysTick();
}

#[link_section = ".vector_table.exceptions"]
#[no_mangle]
pub static EXCEPTIONS: [Vector; 14] = [
    Vector { handler: NMI },
    Vector { handler: HardFault },
    Vector { handler: MemManage },
    Vector { handler: BusFault },
    Vector {
        handler: UsageFault,
    },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: SVCall },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: PendSV },
    Vector { handler: SysTick },
];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>向量表中的一些条目是<em>保留的</em>；ARM 文档指出应该为它们分配值，<code>0</code>因此我们使用联合来做到这一点。必须指向处理程序的条目使用<em>外部</em>函数；这很重要，因为它让最终用户 <em>提供</em>实际的函数定义。</p>
<p>接下来，我们在 Rust 代码中定义一个默认的异常处理程序。最终用户未分配处理程序的异常将使用此默认处理程序。</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n4 ../rt/src/lib.rs
#[no_mangle]
pub extern "C" fn DefaultExceptionHandler() {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="链接器脚本端-1"><a href="#链接器脚本端-1" class="headerlink" title="链接器脚本端"></a>链接器脚本端</h2><p>在链接描述文件端，我们将这些新的异常向量放在重置向量之后。</p>
<pre class="line-numbers language-console"><code class="language-console">$ sed -n 12,25p ../rt/link.x
EXTERN(RESET_VECTOR);
EXTERN(EXCEPTIONS); /* <- NEW */

SECTIONS
{
  .vector_table ORIGIN(FLASH) :
  {
    /* First entry: initial Stack Pointer value */
    LONG(ORIGIN(RAM) + LENGTH(RAM));

    /* Second entry: reset vector */
    KEEP(*(.vector_table.reset_vector));

    /* The next 14 entries are exception vectors */
    KEEP(*(.vector_table.exceptions)); /* <- NEW */
  } > FLASH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们用来<code>PROVIDE</code>为我们在<code>rt</code>（<code>NMI</code> 和上面的其他人）中未定义的处理程序提供默认值：</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n8 ../rt/link.x
PROVIDE(NMI = DefaultExceptionHandler);
PROVIDE(HardFault = DefaultExceptionHandler);
PROVIDE(MemManage = DefaultExceptionHandler);
PROVIDE(BusFault = DefaultExceptionHandler);
PROVIDE(UsageFault = DefaultExceptionHandler);
PROVIDE(SVCall = DefaultExceptionHandler);
PROVIDE(PendSV = DefaultExceptionHandler);
PROVIDE(SysTick = DefaultExceptionHandler);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>PROVIDE</code>仅当检查所有输入目标文件后等号左侧的符号仍未定义时才生效。在这种情况下，用户没有为相应的异常实现处理程序。</p>
<h2 id="测试它-1"><a href="#测试它-1" class="headerlink" title="测试它"></a>测试它</h2><p>就是这样！该<code>rt</code>箱子现在有异常处理程序的支持。我们可以使用以下应用程序对其进行测试：</p>
<blockquote>
<p><strong>注意</strong>：事实证明在 QEMU 中很难产生异常。在真实硬件上，读取无效的内存地址（即在 Flash 和 RAM 区域之外）就足够了，但 QEMU 很乐意接受该操作并返回零。陷阱指令适用于 QEMU 和硬件，但不幸的是它在稳定版上不可用，因此您必须暂时切换到 nightly 才能运行此示例和下一个示例。</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(core_intrinsics)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>intrinsics<span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// this executes the undefined instruction (UDF) and causes a HardFault exception</span>
    intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> target remote <span class="token punctuation">:</span><span class="token number">3333</span>
Remote debugging using <span class="token punctuation">:</span><span class="token number">3333</span>
<span class="token function">Reset</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">7</span>
<span class="token number">7</span>       <span class="token keyword">pub</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b DefaultExceptionHandler
Breakpoint <span class="token number">1</span> at <span class="token number">0xec</span><span class="token punctuation">:</span> file <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">,</span> line <span class="token number">95</span><span class="token punctuation">.</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token keyword">continue</span>
Continuing<span class="token punctuation">.</span>

Breakpoint <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">DefaultExceptionHandler</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    at <span class="token punctuation">..</span><span class="token operator">/</span>rt<span class="token operator">/</span>src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">95</span>
<span class="token number">95</span>          <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> list
<span class="token number">90</span>          Vector <span class="token punctuation">{</span> handler<span class="token punctuation">:</span> SysTick <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">91</span>      <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">92</span>
<span class="token number">93</span>      <span class="token attribute attr-name">#[no_mangle]</span>
<span class="token number">94</span>      <span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">DefaultExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">95</span>          <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token number">96</span>      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了完整起见，这里是程序优化版本的反汇编：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<main>:
                   trap
                   trap

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   movw    r1, #0x0
                   movw    r0, #0x0
                   movt    r1, #0x2000
                   movt    r0, #0x2000
                   subs    r1, r1, r0
                   bl    #0x34
                   movw    r1, #0x0
                   movw    r0, #0x0
                   movt    r1, #0x2000
                   movt    r0, #0x2000
                   subs    r2, r1, r0
                   movw    r1, #0x16c
                   movt    r1, #0x0
                   bl    #0x8
                   bl    #-0x40
                   trap
$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 83000000 83000000  ... E...........
 0010 83000000 83000000 83000000 00000000  ................
 0020 00000000 00000000 00000000 83000000  ................
 0030 00000000 00000000 83000000 83000000  ................<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>向量表现在类似于本书迄今为止所有代码片段的结果。总结一下：</p>
<ul>
<li><p>在前面内存章节的</p>
<p><em>检查</em></p>
<p>部分中，我们了解到：</p>
<ul>
<li><p>向量表中的第一个条目包含堆栈指针的初始值。</p>
</li>
<li><p>Objdump 以<code>little endian</code>格式打印，因此堆栈从 <code>0x2001_0000</code>.</p>
</li>
<li><p>第二个入口指向 address </p>
<pre><code>0x0000_0045</code></pre><p>，即重置处理程序。</p>
<ul>
<li>重置处理程序的地址可以在上面的反汇编中看到，是<code>0x44</code>.</li>
<li>由于对齐要求，设置为 1 的第一位不会改变地址。相反，它会导致函数以<em>拇指模式</em>执行。</li>
</ul>
</li>
</ul>
</li>
<li><p>之后，可以看到在</p>
<pre><code>0x7f</code></pre><p>和之间交替的地址模式</p>
<pre><code>0x00</code></pre><p>。</p>
<ul>
<li>看上面的反汇编，很明显<code>0x7f</code>指的是 <code>DefaultExceptionHandler</code>（<code>0x7e</code>以拇指模式执行）。</li>
<li>将模式与本章前面设置的向量表（参见 的定义<code>pub static EXCEPTIONS</code>）与<a href="https://developer.arm.com/docs/dui0552/latest/the-cortex-m3-processor/exception-model/vector-table" target="_blank" rel="noopener">Cortex-M 的向量表布局</a>交叉引用，很明显<code>DefaultExceptionHandler</code>每次出现相应的处理程序条目时都会出现的地址 出现在表中。</li>
<li>反过来，也可以看出，Rust 代码中向量表数据结构的布局与 Cortex-M 向量表中的所有保留槽对齐。因此，所有保留时隙都正确设置为零值。</li>
</ul>
</li>
</ul>
<h2 id="覆盖处理程序"><a href="#覆盖处理程序" class="headerlink" title="覆盖处理程序"></a>覆盖处理程序</h2><p>要覆盖异常处理程序，用户必须提供一个函数，其符号名称与我们在 中使用的名称完全匹配<code>EXCEPTIONS</code>。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![feature(core_intrinsics)]</span>
<span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>intrinsics<span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something interesting here</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你可以在 QEMU 中测试</p>
<pre class="line-numbers language-console"><code class="language-console">(gdb) target remote :3333
Remote debugging using :3333
Reset () at /home/japaric/rust/embedonomicon/ci/exceptions/rt/src/lib.rs:7
7       pub unsafe extern "C" fn Reset() -> ! {

(gdb) b HardFault
Breakpoint 1 at 0x44: file src/main.rs, line 18.

(gdb) continue
Continuing.

Breakpoint 1, HardFault () at src/main.rs:18
18          loop {}

(gdb) list
13      }
14
15      #[no_mangle]
16      pub extern "C" fn HardFault() -> ! {
17          // do something interesting here
18          loop {}
19      }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序现在执行用户定义的<code>HardFault</code>函数，而不是 <code>DefaultExceptionHandler</code>在<code>rt</code>crate 中。</p>
<p>就像我们对<code>main</code>接口的第一次尝试一样，这个第一个实现存在没有类型安全的问题。错误输入异常的名称也很容易，但这不会产生错误或警告。相反，用户定义的处理程序被简单地忽略。这些问题可以通过象的宏被固定<a href="https://github.com/japaric/cortex-m-rt/blob/v0.5.1/src/lib.rs#L792" target="_blank" rel="noopener"><code>exception!</code></a>在定义的宏<code>cortex-m-rt</code>v0.5.x或 <a href="https://github.com/rust-embedded/cortex-m-rt/blob/v0.6.3/macros/src/lib.rs#L254" target="_blank" rel="noopener"><code>exception</code></a>在属性<code>cortex-m-rt</code>v0.6.x.</p>
<h1 id="Assembly-on-stable"><a href="#Assembly-on-stable" class="headerlink" title="Assembly on stable"></a>Assembly on stable</h1><p>到目前为止，我们已经设法启动设备并处理中断，而无需一行汇编。这真是一个壮举！但是根据您所针对的架构，您可能需要一些组装才能达到这一点。还有一些操作，比如需要汇编的上下文切换等。</p>
<p>问题是<em>内联</em>汇编 ( <code>asm!</code>) 和<em>自由形式</em>汇编 ( <code>global_asm!</code>) 都不稳定，并且无法估计它们何时会稳定下来，因此您不能在 stable 上使用它们。这不是一个大问题，因为我们将在此处记录一些解决方法。</p>
<p>为了激发本节的内容，我们将调整<code>HardFault</code>处理程序以提供有关生成异常的堆栈帧的信息。</p>
<p>这是我们想要做的：</p>
<p>我们不会让用户直接将他们的<code>HardFault</code>处理程序放在向量表中，而是让<code>rt</code>crate 将一个蹦床放到向量表中的用户定义的<code>HardFault</code> 处理程序中。</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n36 ../rt/src/lib.rs
extern "C" {
    fn NMI();
    fn HardFaultTrampoline(); // <- CHANGED!
    fn MemManage();
    fn BusFault();
    fn UsageFault();
    fn SVCall();
    fn PendSV();
    fn SysTick();
}

#[link_section = ".vector_table.exceptions"]
#[no_mangle]
pub static EXCEPTIONS: [Vector; 14] = [
    Vector { handler: NMI },
    Vector { handler: HardFaultTrampoline }, // <- CHANGED!
    Vector { handler: MemManage },
    Vector { handler: BusFault },
    Vector {
        handler: UsageFault,
    },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: SVCall },
    Vector { reserved: 0 },
    Vector { reserved: 0 },
    Vector { handler: PendSV },
    Vector { handler: SysTick },
];

#[no_mangle]
pub extern "C" fn DefaultExceptionHandler() {
    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个蹦床将读取堆栈指针，然后调用用户<code>HardFault</code> 处理程序。蹦床必须用汇编编写：</p>
<pre class="line-numbers language-armasm"><code class="language-armasm">  mrs r0, MSP
  b HardFault<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>由于 ARM ABI 的工作方式，这将主堆栈指针 (MSP) 设置为<code>HardFault</code>函数/例程的第一个参数。这个 MSP 值也恰好是一个指向由异常压入堆栈的寄存器的指针。通过这些更改，用户<code>HardFault</code>处理程序现在必须具有签名 <code>fn(&amp;StackedRegisters) -&gt; !</code>。</p>
<h2 id="s-档案"><a href="#s-档案" class="headerlink" title=".s 档案"></a><code>.s</code> 档案</h2><p>稳定程序集的一种方法是将程序集写入外部文件：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/asm.s
  .section .text.HardFaultTrampoline
  .global HardFaultTrampoline
  .thumb_func
HardFaultTrampoline:
  mrs r0, MSP
  b HardFault<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并使用<code>cc</code>crate 的构建脚本中的<code>rt</code>crate 将该文件组装成目标文件 ( <code>.o</code>)，然后组装成存档 ( <code>.a</code>)。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

use cc::Build;

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    // assemble the `asm.s` file
    Build::new().file("asm.s").compile("asm"); // <- NEW!

    // rebuild if `asm.s` changed
    println!("cargo:rerun-if-changed=asm.s"); // <- NEW!

    Ok(())
}
$ tail -n2 ../rt/Cargo.toml
[build-dependencies]
cc = "1.0.25"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是这样！</p>
<p>我们可以<code>HardFaultTrampoline</code> 通过编写一个非常简单的程序来确认向量表包含一个指向的指针。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[allow(non_snake_case)]</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">HardFault</span><span class="token punctuation">(</span>_ef<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面是拆解。看看地址<code>HardFaultTrampoline</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<HardFault>:
                   b    #-0x4 <HardFault>

<main>:
                   b    #-0x4 <main>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-0xa
                   trap

<UsageFault>:
                   b    #-0x4 <UsageFault>

<HardFaultTrampoline>:
                   mrs    r0, msp
                   b    #-0x18 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意：</strong>为了使这个反汇编更小，我注释掉了 RAM 的初始化</p>
</blockquote>
<p>现在看看向量表。第四个条目应该是<code>HardFaultTrampoline</code>加一的地址 。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 4f000000 51000000  ... E...O...Q...
 0010 4f000000 4f000000 4f000000 00000000  O...O...O.......
 0020 00000000 00000000 00000000 4f000000  ............O...
 0030 00000000 00000000 4f000000 4f000000  ........O...O...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="o-a文件"><a href="#o-a文件" class="headerlink" title=".o/.a文件"></a><code>.o</code>/<code>.a</code>文件</h2><p>使用<code>cc</code>crate的缺点是它需要在构建机器上安装一些汇编程序。例如，当以 ARM Cortex-M 为目标时，<code>cc</code>crate<code>arm-none-eabi-gcc</code>用作汇编器。</p>
<p>我们可以用<code>rt</code>crate运送一个预组装的文件，而不是在构建机器上组装文件。这样，构建机器上就不需要汇编程序。但是，您仍然需要在打包和发布 crate 的机器上安装一个汇编程序。</p>
<p>程序集 ( <code>.s</code>) 文件与其<em>编译</em> 版本之间没有太大区别：对象 ( <code>.o</code>) 文件。汇编器不做任何优化；它只是为目标架构选择正确的目标文件格式。</p>
<p>Cargo 支持将档案 ( <code>.a</code>) 与 crate捆绑在一起。我们可以使用该<code>ar</code>命令将目标文件打包成档案，然后将档案与 crate 捆绑在一起。事实上，这就是<code>cc</code>板条箱的作用；你可以看到它调用通过搜索指定文件中的命令<code>output</code>在<code>target</code>目录中。</p>
<pre class="line-numbers language-console"><code class="language-console">$ grep running $(find target -name output)
running: "arm-none-eabi-gcc" "-O0" "-ffunction-sections" "-fdata-sections" "-fPIC" "-g" "-fno-omit-frame-pointer" "-mthumb" "-march=armv7-m" "-Wall" "-Wextra" "-o" "/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/asm.o" "-c" "asm.s"
running: "ar" "crs" "/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/libasm.a" "/home/japaric/rust-embedded/embedonomicon/ci/asm/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out/asm.o"
$ grep cargo $(find target -name output)
cargo:rustc-link-search=/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out
cargo:rustc-link-lib=static=asm
cargo:rustc-link-search=native=/tmp/app/target/thumbv7m-none-eabi/debug/build/rt-6ee84e54724f2044/out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们会做一些类似的事情来生成一个存档。</p>
<pre class="line-numbers language-console"><code class="language-console">$ # most of flags `cc` uses have no effect when assembling so we drop them
$ arm-none-eabi-as -march=armv7-m asm.s -o asm.o

$ ar crs librt.a asm.o

$ arm-none-eabi-objdump -Cd librt.a
In archive librt.a:

asm.o:     file format elf32-littlearm


Disassembly of section .text.HardFaultTrampoline:

00000000 <HardFaultTrampoline>:
   0:    f3ef 8008     mrs    r0, MSP
   4:    e7fe          b.n    0 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来我们修改构建脚本以将此存档与<code>rt</code>rlib捆绑在一起。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../rt/build.rs
use std::{
    env,
    error::Error,
    fs::{self, File},
    io::Write,
    path::PathBuf,
};

fn main() -> Result<(), Box<dyn Error>> {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os("OUT_DIR").unwrap());

    // extend the library search path
    println!("cargo:rustc-link-search={}", out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join("link.x"))?.write_all(include_bytes!("link.x"))?;

    // link to `librt.a`
    fs::copy("librt.a", out_dir.join("librt.a"))?; // <- NEW!
    println!("cargo:rustc-link-lib=static=rt"); // <- NEW!

    // rebuild if `librt.a` changed
    println!("cargo:rerun-if-changed=librt.a"); // <- NEW!

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我们可以用之前的简单程序测试这个新版本，我们将得到相同的输出。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -d -no-show-raw-insn -print-imm-hex
app:    file format elf32-littlearm


Disassembly of section .text:

<HardFault>:
                   b    #-0x4 <HardFault>

<main>:
                   b    #-0x4 <main>

<Reset>:
                   push    {r7, lr}
                   mov    r7, sp
                   bl    #-0xa
                   trap

<UsageFault>:
                   b    #-0x4 <UsageFault>

<HardFaultTrampoline>:
                   mrs    r0, msp
                   b    #-0x18 <HardFault><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：和之前一样，我已经注释掉了 RAM 初始化以使反汇编更小。</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -s -j .vector_table
app:    file format elf32-littlearm

Contents of section .vector_table:
 0000 00000120 45000000 4f000000 51000000  ... E...O...Q...
 0010 4f000000 4f000000 4f000000 00000000  O...O...O.......
 0020 00000000 00000000 00000000 4f000000  ............O...
 0030 00000000 00000000 4f000000 4f000000  ........O...O...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运送预组装档案的缺点是，在最坏的情况下，您需要为您的库支持的每个编译目标运送一个构建工件。</p>
<h1 id="Logging-with-symbols"><a href="#Logging-with-symbols" class="headerlink" title="Logging with symbols"></a>Logging with symbols</h1><p>本节将向您展示如何利用符号和 ELF 格式来实现超廉价的日志记录。</p>
<h2 id="任意符号"><a href="#任意符号" class="headerlink" title="任意符号"></a>任意符号</h2><p>每当我们需要在 crate 之间使用稳定的符号接口时，我们主要使用<code>no_mangle</code>属性，有时使用<code>export_name</code>属性。该 <code>export_name</code>属性采用一个字符串，该字符串成为符号的名称，而<code>#[no_mangle]</code>基本上是<code>#[export_name = &lt;item-name&gt;]</code>.</p>
<p>事实证明，我们不仅限于单个单词名称；我们可以使用任意字符串，例如句子，作为<code>export_name</code>属性的参数。至少当输出格式是 ELF 时，任何不包含空字节的东西都可以。</p>
<p>让我们来看看：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --lib foo

$ cat foo/src/lib.rs
#[export_name = "Hello, world!"]
#[used]
static A: u8 = 0;

#[export_name = "こんにちは"]
#[used]
static B: u8 = 0;
$ ( cd foo && cargo nm --lib )
foo-d26a39c34b4e80ce.3lnzqy0jbpxj4pld.rcgu.o:
0000000000000000 r Hello, world!
0000000000000000 V __rustc_debug_gdb_scripts_section__
0000000000000000 r こんにちは<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你能看出这是怎么回事吗？</p>
<h2 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h2><p>这是我们要做的：我们将为<code>static</code>每个日志消息创建一个变量，但不是将消息存储<em>在</em>变量中，而是将消息存储在变量的<em>符号名称中</em>。我们将记录的不是<code>static</code>变量的内容，而是它们的地址。</p>
<p>只要<code>static</code>变量不是零大小，每个变量都会有不同的地址。我们在这里所做的是有效地将每条消息编码为一个唯一标识符，这恰好是变量地址。日志系统的某些部分必须将此 ID 解码回消息中。</p>
<p>让我们写一些代码来说明这个想法。</p>
<p>在这个例子中，我们需要某种方式来进行 I/O，因此我们将使用 <a href="https://crates.io/crates/cortex-m-semihosting" target="_blank" rel="noopener"><code>cortex-m-semihosting</code></a>crate 来实现。半主机是一种让目标设备借用主机 I/O 功能的技术；这里的主机通常是指正在调试目标设备的机器。在我们的例子中，QEMU 支持开箱即用的半主机，因此不需要调试器。在真实设备上，您将有其他方式进行 I/O，如串行端口；在这种情况下，我们使用半主机，因为这是在 QEMU 上进行 I/O 的最简单方法。</p>
<p>这是代码</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> core<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Write<span class="token punctuation">;</span>
<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hio<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> hstdout <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> A<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#x}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>A <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Goodbye"</span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> B<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token function">writeln!</span><span class="token punctuation">(</span>hstdout<span class="token punctuation">,</span> <span class="token string">"{:#x}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>B <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们还使用<code>debug::exit</code>API 来让程序终止 QEMU 进程。这很方便，因此我们不必手动终止 QEMU 进程。</p>
<p>这<code>dependencies</code>是 Cargo.toml的部分：</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
cortex-m-semihosting = "0.3.1"
rt = { path = "../rt" }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>现在我们可以构建程序</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>要运行它，我们必须将<code>--semihosting-config</code>标志添加到我们的 QEMU 调用中：</p>
<pre class="line-numbers language-console"><code class="language-console">$ qemu-system-arm \
      -cpu cortex-m3 \
      -machine lm3s6965evb \
      -nographic \
      -semihosting-config enable=on,target=native \
      -kernel target/thumbv7m-none-eabi/debug/app
0x1fe0
0x1fe1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong>：这些地址可能不是您在本地获得的地址，因为<code>static</code>在更改工具链时不能保证变量的地址保持不变（例如优化可能已经改进）。</p>
</blockquote>
<p>现在我们有两个地址打印到控制台。</p>
<h2 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h2><p>我们如何将这些地址转换为字符串？答案在 ELF 文件的符号表中。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.rodata\s*0*1\b'
00001fe1 g       .rodata         00000001 Goodbye
00001fe0 g       .rodata         00000001 Hello, world!
$ # first column is the symbol address; last column is the symbol name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>objdump -t</code>打印符号表。该表包含<em>所有</em>符号，但我们只在该<code>.rodata</code>部分中查找大小为 1 个字节的符号（我们的变量具有 type <code>u8</code>）。</p>
<p>需要注意的是，在优化程序时，符号的地址可能会发生变化。让我们检查一下。</p>
<blockquote>
<p><strong>普罗蒂普</strong>您可以设置<code>target.thumbv7m-none-eabi.runner</code>从之前的长QEMU命令（<code>qemu-system-arm -cpu (..) -kernel</code>）的货物配置文件（中<code>.cargo/conifg</code>）有<code>cargo run</code>使用该<em>亚军</em>执行二进制输出。</p>
</blockquote>
<pre class="line-numbers language-console"><code class="language-console">$ head -n2 .cargo/config
[target.thumbv7m-none-eabi]
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"
$ cargo run --release
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/app`
0xb9c
0xb9d
$ cargo objdump --bin app --release -- -t | grep '\.rodata\s*0*1\b'
00000b9d g     O .rodata    00000001 Goodbye
00000b9c g     O .rodata    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此，请确保始终在您执行的 ELF 文件中查找字符串。</p>
<p>当然，在 ELF 文件中查找字符串的过程可以使用解析<code>.symtab</code>ELF 文件中包含的符号表（节）的工具来自动化。实现这样的工具超出了本书的范围，留给读者作为练习。</p>
<h2 id="实现零成本"><a href="#实现零成本" class="headerlink" title="实现零成本"></a>实现零成本</h2><p>我们能做得更好吗？我们可以！</p>
<p>当前的实现将<code>static</code>变量放在 中<code>.rodata</code>，这意味着即使我们从不使用它们的内容，它们也占用 Flash 中的大小。使用一点链接脚本魔法，我们可以让它们在 Flash 中占据<em>零</em>空间。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat log.x
SECTIONS
{
  .log 0 (INFO) : {
    *(.log);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将把<code>static</code>变量放在这个新的输出<code>.log</code>部分。此链接描述文件将收集<code>.log</code>输入目标文件部分中的所有符号，并将它们放入输出<code>.log</code>部分。我们已经在<a href="https://docs.rust-embedded.org/embedonomicon/memory-layout.html" target="_blank" rel="noopener">内存布局</a>章节中看到了这种模式。</p>
<p>这里的新<code>(INFO)</code>部分是零件；这告诉链接器这个部分是一个不可分配的部分。不可分配的部分作为元数据保存在 ELF 二进制文件中，但它们不会加载到目标设备上。</p>
<p>我们还指定了这个输出部分的起始地址：<code>0</code>in <code>.log 0 (INFO)</code>。</p>
<p>我们可以做的另一个改进是从格式化 I/O ( <code>fmt::Write</code>) 切换到二进制 I/O，即将地址作为字节而不是字符串发送到主机。</p>
<p>二进制序列化可能很困难，但我们将通过将每个地址序列化为单个字节来使事情变得非常简单。使用这种方法，我们不必担心字节序或框架。这种格式的缺点是单个字节最多只能表示 256 个不同的地址。</p>
<p>让我们进行这些更改：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_main]</span>
<span class="token attribute attr-name">#![no_std]</span>

<span class="token keyword">use</span> cortex_m_semihosting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>debug<span class="token punctuation">,</span> hio<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> hstdout <span class="token operator">=</span> hio<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hstdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">]</span>
    #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>
    <span class="token keyword">static</span> A<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token operator">&amp;</span>A <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">;</span>
    hstdout<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt;- CHANGED!</span>

    #<span class="token punctuation">[</span>export_name <span class="token operator">=</span> <span class="token string">"Goodbye"</span><span class="token punctuation">]</span>
    #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// &lt;- NEW!</span>
    <span class="token keyword">static</span> B<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token operator">&amp;</span>B <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">;</span>
    hstdout<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// &lt;- CHANGED!</span>

    debug<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span>debug<span class="token punctuation">:</span><span class="token punctuation">:</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在运行之前，您必须附加<code>-Tlog.x</code>到传递给链接器的参数。这可以在 Cargo 配置文件中完成。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat .cargo/config
[target.thumbv7m-none-eabi]
runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"
rustflags = [
  "-C", "link-arg=-Tlink.x",
  "-C", "link-arg=-Tlog.x", # <- NEW!
]

[build]
target = "thumbv7m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在你可以运行它了！由于输出现在具有二进制格式，我们将通过<code>xxd</code>命令将其通过管道将其重新格式化为十六进制字符串。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>地址是<code>0x00</code>和<code>0x01</code>。现在让我们看看符号表。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>有我们的字符串。你会注意到他们的地址现在从零开始；这是因为我们为输出<code>.log</code>部分设置了起始地址。</p>
<p>每个变量的大小为 1 个字节，因为我们将<code>u8</code>其用作它们的类型。如果我们使用类似的东西，<code>u16</code>那么所有地址都会是偶数，我们将无法有效地使用所有地址空间 ( <code>0...255</code>)。</p>
<h2 id="包装起来"><a href="#包装起来" class="headerlink" title="包装起来"></a>包装起来</h2><p>您已经注意到记录字符串的步骤总是相同的，因此我们可以将它们重构为一个存在于其自己的 crate 中的宏。此外，我们可以通过抽象特征背后的 I/O 部分来使日志库更可重用。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo new --lib log

$ cat log/src/lib.rs
#![no_std]

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

#[macro_export]
macro_rules! log {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log"]
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>鉴于这个库依赖于<code>.log</code>部分，它应该负责提供<code>log.x</code>链接描述文件，所以让我们实现这一点。</p>
<pre class="line-numbers language-console"><code class="language-console">$ mv log.x ../log/
$ cat ../log/build.rs
use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

fn main() -> Result<(), Box<dyn Error>> {
    // Put the linker script somewhere the linker can find it
    let out = PathBuf::from(env::var("OUT_DIR")?);

    File::create(out.join("log.x"))?.write_all(include_bytes!("log.x"))?;

    println!("cargo:rustc-link-search={}", out.display());

    Ok(())
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我们可以重构我们的应用程序以使用<code>log!</code>宏：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{log, Log};
use rt::entry;

struct Logger {
    hstdout: HStdout,
}

impl Log for Logger {
    type Error = ();

    fn log(&mut self, address: u8) -> Result<(), ()> {
        self.hstdout.write_all(&[address])
    }
}

entry!(main);

fn main() -> ! {
    let hstdout = hio::hstdout().unwrap();
    let mut logger = Logger { hstdout };

    let _ = log!(logger, "Hello, world!");

    let _ = log!(logger, "Goodbye");

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不要忘记更新<code>Cargo.toml</code>文件以依赖新的<code>log</code>crate。</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n4 Cargo.toml
[dependencies]
cortex-m-semihosting = "0.3.1"
log = { path = "../log" }
rt = { path = "../rt" }
$ cargo run | xxd -p
0001
$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和以前一样的输出！</p>
<h2 id="奖励：多个日志级别"><a href="#奖励：多个日志级别" class="headerlink" title="奖励：多个日志级别"></a>奖励：多个日志级别</h2><p>许多日志框架提供了在不同<em>日志级别</em>记录消息的方法。这些日志级别传达了消息的严重性：“这是一个错误”、“这只是一个警告”等。这些日志级别可用于在搜索例如错误消息时过滤掉不重要的消息。</p>
<p>我们可以扩展我们的日志库以支持日志级别，而不会增加其占用空间。下面是我们将如何做到这一点：</p>
<p>我们有一个用于消息的平面地址空间：从<code>0</code>到<code>255</code>（包括）。为了简单起见，假设我们只想区分错误消息和警告消息。我们可以把在地址空间的开始所有的错误消息，并且所有的警告消息<em>后</em>的错误消息。如果解码器知道第一条警告消息的地址，则它可以对消息进行分类。这个想法可以扩展到支持两个以上的日志级别。</p>
<p>让我们通过用<code>log</code>两个新宏替换宏来测试这个想法：<code>error!</code> 和<code>warn!</code>。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/src/lib.rs
#![no_std]

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

/// Logs messages at the ERROR log level
#[macro_export]
macro_rules! error {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log.error"] // <- CHANGED!
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}

/// Logs messages at the WARNING log level
#[macro_export]
macro_rules! warn {
    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log.warning"] // <- CHANGED!
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们通过将消息放在不同的链接部分来区分错误和警告。</p>
<p>接下来我们要做的是更新链接描述文件，将错误信息放在警告信息之前。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/log.x
SECTIONS
{
  .log 0 (INFO) : {
    *(.log.error);
    __log_warning_start__ = .;
    *(.log.warning);
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们还为<code>__log_warning_start__</code>错误和警告之间的边界命名为 。该符号的地址将是第一条警告消息的地址。</p>
<p>我们现在可以更新应用程序以使用这些新的宏。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{error, warn, Log};
use rt::entry;

entry!(main);

fn main() -> ! {
    let hstdout = hio::hstdout().unwrap();
    let mut logger = Logger { hstdout };

    let _ = warn!(logger, "Hello, world!"); // <- CHANGED!

    let _ = error!(logger, "Goodbye"); // <- CHANGED!

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}

struct Logger {
    hstdout: HStdout,
}

impl Log for Logger {
    type Error = ();

    fn log(&mut self, address: u8) -> Result<(), ()> {
        self.hstdout.write_all(&[address])
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出不会有太大变化：</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们仍然在输出中得到两个字节，但错误的地址为 0，警告的地址为 1，即使警告是最先记录的。</p>
<p>现在看看符号表。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app -- -t | grep '\.log'
00000000 g     O .log    00000001 Goodbye
00000001 g     O .log    00000001 Hello, world!
00000001 g       .log    00000000 __log_warning_start__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在<code>__log_warning_start__</code>，该<code>.log</code>部分中有一个额外的符号。这个符号的地址是第一条警告信息的地址。地址低于此值的符号是错误，其余符号是警告。</p>
<p>使用适当的解码器，您可以从所有这些信息中获得以下人类可读的输出：</p>
<pre class="line-numbers language-text"><code class="language-text">WARNING Hello, world!
ERROR Goodbye<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Global-singletons（单例）"><a href="#Global-singletons（单例）" class="headerlink" title="Global singletons（单例）"></a>Global singletons（单例）</h1><p>在本节中，我们将介绍如何实现全局共享单例。嵌入式 Rust 书籍涵盖了 Rust 非常独特的本地拥有的单身人士。全局单例本质上是您在 C 和 C++ 中看到的单例模式；它们并非特定于嵌入式开发，但由于它们涉及符号，因此它们似乎非常适合嵌入式开发。</p>
<blockquote>
<p><strong>TODO</strong>（资源团队）在启动时将“嵌入式 Rust 书”链接到单例部分</p>
</blockquote>
<p>为了说明本节，我们将扩展我们在上一节中开发的记录器以支持全局日志记录。结果将<code>#[global_allocator]</code>与嵌入式 Rust 书中涵盖的功能非常相似 。</p>
<blockquote>
<p><strong>TODO</strong>（资源团队）<code>#[global_allocator]</code>在更稳定的位置链接到本书的收藏章节。</p>
</blockquote>
<p>以下是我们想要做的总结：</p>
<p>在上一节中，我们创建了一个<code>log!</code>宏来通过特定的记录器记录消息，这是一个实现<code>Log</code>trait的值。<code>log!</code>宏的语法是<code>log!(logger, "String")</code>. 我们想扩展宏，使其 <code>log!("String")</code>也能工作。使用<code>logger</code>-less 版本应该通过全局记录器记录消息；这就是<code>std::println!</code>工作原理。我们还需要一种机制来声明全局记录器是什么；这是类似于<code>#[global_allocator]</code>.</p>
<p>可能是全局记录器是在 top crate 中声明的，也可能是全局记录器的类型是在 top crate 中定义的。在这种情况下，依赖项<em>无法</em>知道全局记录器的确切类型。为了支持这种情况，我们需要一些间接性。</p>
<p><code>log</code>我们不会在crate中对全局记录器的类型进行硬编码，而是在该crate 中仅声明全局记录器的<em>接口</em>。这就是我们将添加一个新的特点，<code>GlobalLog</code>到<code>log</code>箱子。该<code>log!</code>宏还必须利用该性状。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat ../log/src/lib.rs
#![no_std]

// NEW!
pub trait GlobalLog: Sync {
    fn log(&self, address: u8);
}

pub trait Log {
    type Error;

    fn log(&mut self, address: u8) -> Result<(), Self::Error>;
}

#[macro_export]
macro_rules! log {
    // NEW!
    ($string:expr) => {
        unsafe {
            extern "Rust" {
                static LOGGER: &'static dyn $crate::GlobalLog;
            }

            #[export_name = $string]
            #[link_section = ".log"]
            static SYMBOL: u8 = 0;

            $crate::GlobalLog::log(LOGGER, &SYMBOL as *const u8 as usize as u8)
        }
    };

    ($logger:expr, $string:expr) => {{
        #[export_name = $string]
        #[link_section = ".log"]
        static SYMBOL: u8 = 0;

        $crate::Log::log(&mut $logger, &SYMBOL as *const u8 as usize as u8)
    }};
}

// NEW!
#[macro_export]
macro_rules! global_logger {
    ($logger:expr) => {
        #[no_mangle]
        pub static LOGGER: &dyn $crate::GlobalLog = &$logger;
    };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有很多东西要解开。</p>
<p>让我们从特征开始。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> GlobalLog<span class="token punctuation">:</span> Sync <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> u8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>双方<code>GlobalLog</code>并<code>Log</code>有一个<code>log</code>方法。不同之处在于它 <code>GlobalLog.log</code>采用对接收者的共享引用 ( <code>&amp;self</code>)。这是必要的，因为全局记录器将是一个<code>static</code>变量。稍后再谈。</p>
<p>另一个区别是<code>GlobalLog.log</code>不返回 a <code>Result</code>。这意味着它<em>不能</em>向调用者报告错误。这不是对用于实现全局单例的特征的严格要求。全局单例中的错误处理很好，但是<code>log!</code> 宏的全局版本的所有用户都必须就错误类型达成一致。在这里，我们通过让<code>GlobalLog</code>实现者处理错误来稍微简化接口。</p>
<p>另一个区别是<code>GlobalLog</code>要求实现者是 <code>Sync</code>，即它可以在线程之间共享。这是对放置在<code>static</code>变量中的值的要求；它们的类型必须实现<code>Sync</code> trait。</p>
<p>在这一点上，可能不完全清楚为什么界面必须这样。板条箱的其他部分将使这一点更清楚，所以请继续阅读。</p>
<p>接下来是<code>log!</code>宏：</p>
<pre class="line-numbers language-rust"><code class="language-rust">    <span class="token punctuation">(</span>$string<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token keyword">extern</span> <span class="token string">"Rust"</span> <span class="token punctuation">{</span>
                <span class="token keyword">static</span> LOGGER<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> dyn $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token attribute attr-name">#[export_name = $string]</span>
            #<span class="token punctuation">[</span>link_section <span class="token operator">=</span> <span class="token string">".log"</span><span class="token punctuation">]</span>
            <span class="token keyword">static</span> SYMBOL<span class="token punctuation">:</span> u8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">log</span><span class="token punctuation">(</span>LOGGER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SYMBOL <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> u8 <span class="token keyword">as</span> usize <span class="token keyword">as</span> u8<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当没有特定<code>$logger</code>的调用时，宏使用一个<code>extern</code> <code>static</code> 被调用的变量<code>LOGGER</code>来记录消息。这个变量<em>是</em>在别处定义的全局记录器；这就是我们使用<code>extern</code>块的原因。</p>
<p>我们需要声明一个类型，<code>LOGGER</code>否则代码不会进行类型检查。目前我们不知道 的具体类型，<code>LOGGER</code>但我们知道，或者更确切地说，它实现了<code>GlobalLog</code>trait，因此我们可以在这里使用 trait 对象。</p>
<p>宏扩展的其余部分看起来与宏的本地版本的扩展非常相似，<code>log!</code>因此我不会在这里解释，因为它在前一章中解释 <a href="https://docs.rust-embedded.org/embedonomicon/logging.html" target="_blank" rel="noopener">过</a>。</p>
<p>现在我们知道它<code>LOGGER</code>必须是一个 trait 对象，所以我们更清楚为什么我们<code>Error</code>在<code>GlobalLog</code>. 如果我们没有省略，那么我们将需要<code>Error</code>在<code>LOGGER</code>. 这就是我之前所说的“所有用户<code>log!</code>都需要就错误类型达成一致”的意思。</p>
<p>现在是最后一块：<code>global_logger!</code>宏。它可能是一个 proc 宏属性，但编写<code>macro_rules!</code>宏更容易。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro-rules function">macro_rules!</span> global_logger <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$logger<span class="token punctuation">:</span>expr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token attribute attr-name">#[no_mangle]</span>
        <span class="token keyword">pub</span> <span class="token keyword">static</span> LOGGER<span class="token punctuation">:</span> <span class="token operator">&amp;</span>dyn $<span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>GlobalLog <span class="token operator">=</span> <span class="token operator">&amp;</span>$logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此宏创建使用的<code>LOGGER</code>变量<code>log!</code>。因为我们需要一个稳定的 ABI 接口，所以我们使用该<code>no_mangle</code>属性。这样，符号名称<code>LOGGER</code>将是“LOGGER”，这是<code>log!</code>宏所期望的。</p>
<p>另一个重要的一点是这个静态变量的类型必须与<code>log!</code>宏扩展中使用的类型完全匹配。如果它们不匹配，则会由于 ABI 不匹配而发生 Bad Stuff。</p>
<p>让我们编写一个使用此新全局记录器功能的示例。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cat src/main.rs
#![no_main]
#![no_std]

use cortex_m::interrupt;
use cortex_m_semihosting::{
    debug,
    hio::{self, HStdout},
};

use log::{global_logger, log, GlobalLog};
use rt::entry;

struct Logger;

global_logger!(Logger);

entry!(main);

fn main() -> ! {
    log!("Hello, world!");

    log!("Goodbye");

    debug::exit(debug::EXIT_SUCCESS);

    loop {}
}

impl GlobalLog for Logger {
    fn log(&self, address: u8) {
        // we use a critical section (`interrupt::free`) to make the access to the
        // `static mut` variable interrupt safe which is required for memory safety
        interrupt::free(|_| unsafe {
            static mut HSTDOUT: Option<HStdout> = None;

            // lazy initialization
            if HSTDOUT.is_none() {
                HSTDOUT = Some(hio::hstdout()?);
            }

            let hstdout = HSTDOUT.as_mut().unwrap();

            hstdout.write_all(&[address])
        }).ok(); // `.ok()` = ignore errors
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>TODO</strong>（资源团队） 在稳定时使用<code>cortex_m::Mutex</code>而不是<code>static mut</code>变量<code>const fn</code>。</p>
</blockquote>
<p>我们必须添加<code>cortex-m</code>依赖项。</p>
<pre class="line-numbers language-console"><code class="language-console">$ tail -n5 Cargo.toml
[dependencies]
cortex-m = "0.5.7"
cortex-m-semihosting = "0.3.1"
log = { path = "../log" }
rt = { path = "../rt" }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是上一节中编写的示例之一的移植。输出与我们回到那里的输出相同。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo run | xxd -p
0001
$ cargo objdump --bin app -- -t | grep '\.log'
00000001 g     O .log    00000001 Goodbye
00000000 g     O .log    00000001 Hello, world!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p>一些读者可能会担心全局单例的这种实现不是零成本，因为它使用涉及动态调度的 trait 对象，即通过 vtable 查找执行方法调用。</p>
<p>但是，LLVM 似乎足够聪明，可以在使用优化 / LTO 进行编译时消除动态调度。这可以通过在<code>LOGGER</code>符号表中搜索来确认 。</p>
<pre class="line-numbers language-console"><code class="language-console">$ cargo objdump --bin app --release -- -t | grep LOGGER
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果<code>static</code>缺少，则意味着没有 vtable 并且 LLVM 能够将所有<code>LOGGER.log</code>调用转换为<code>Logger.log</code>调用。</p>
<h1 id="Direct-Memory-Access-DMA"><a href="#Direct-Memory-Access-DMA" class="headerlink" title="Direct Memory Access (DMA)"></a>Direct Memory Access (DMA)</h1><p>本节涵盖围绕 DMA 传输构建内存安全 API 的核心要求。</p>
<p>DMA 外设用于与处理器的工作（主程序的执行）并行执行内存传输。DMA 传输或多或少相当于生成一个线程（请参阅<a href="https://doc.rust-lang.org/std/thread/fn.spawn.html" target="_blank" rel="noopener"><code>thread::spawn</code></a>）来执行<code>memcpy</code>. 我们将使用 fork-join 模型来说明内存安全 API 的要求。</p>
<p>考虑以下 DMA 原语：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents a single DMA channel (channel 1 in this case)</span>
<span class="token comment" spellcheck="true">///</span>
<span class="token comment" spellcheck="true">/// This singleton has exclusive access to the registers of the DMA channel 1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Dma1Channel1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Dma1Channel1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Data will be written to this `address`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// `inc` indicates whether the address will be incremented after every byte transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_destination_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> usize<span class="token punctuation">,</span> inc<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Data will be read from this `address`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// `inc` indicates whether the address will be incremented after every byte transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_source_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> address<span class="token punctuation">:</span> usize<span class="token punctuation">,</span> inc<span class="token punctuation">:</span> bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Number of bytes to transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_transfer_length</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> len<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Starts the DMA transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Stops the DMA transfer</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile write</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Returns `true` if there's a transfer in progress</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE this performs a volatile read</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">in_progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设<code>Dma1Channel1</code>静态配置为<code>Serial1</code>在一次性模式（即非循环模式）下与串行端口（AKA UART 或 USART）#1 一起使用。 <code>Serial1</code>提供以下<em>阻塞</em>API：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents serial port #1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Reads out a single byte</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE: blocks if no byte is available to be read</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>u8<span class="token punctuation">,</span> Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out a single byte</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// NOTE: blocks if the output FIFO buffer is full</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> byte<span class="token punctuation">:</span> u8<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设我们想将<code>Serial1</code>API扩展为 (a) 异步发送缓冲区和 (b) 异步填充缓冲区。</p>
<p>我们将从一个内存不安全的 API 开始，我们将对其进行迭代，直到它完全内存安全。在每个步骤中，我们将向您展示如何破坏 API，让您了解在处理异步内存操作时需要解决的问题。</p>
<h2 id="A-first-stab"><a href="#A-first-stab" class="headerlink" title="A first stab"></a>A first stab</h2><p>首先，让我们尝试使用<a href="https://doc.rust-lang.org/std/io/trait.Write.html#method.write_all" target="_blank" rel="noopener"><code>Write::write_all</code></a>API 作为参考。为了简单起见，让我们忽略所有错误处理。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A singleton that represents serial port #1</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: we extend this struct by adding the DMA channel singleton</span>
    dma<span class="token punctuation">:</span> Dma1Channel1<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span><span class="token string">'a>(mut self, buffer: &amp;'</span>a <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> B<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Returns `true` if the DMA transfer has finished</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">is_done</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> bool <span class="token punctuation">{</span>
        <span class="token operator">!</span>Dma1Channel1<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">in_progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> B <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Busy wait until the transfer is done</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>buffer
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意：</strong> <code>Transfer</code>可以公开基于期货或生成器的 API，而不是上面显示的 API。这是一个 API 设计问题，与整个 API 的内存安全性关系不大，因此我们不会在本文中深入研究。</p>
</blockquote>
<p>我们还可以实现<a href="https://doc.rust-lang.org/std/io/trait.Read.html#method.read_exact" target="_blank" rel="noopener"><code>Read::read_exact</code></a>.</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span><span class="token string">'a>(&amp;mut self, buffer: &amp;'</span>a <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma
            <span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span> buffer <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>write_all</code>API的使用方法如下：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">write</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// fire and forget</span>
    serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// do other stuff</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是使用<code>read_exact</code>API的示例：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// do other stuff</span>

    t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> buf<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token operator">|</span>b<span class="token operator">|</span> <span class="token operator">*</span>b <span class="token operator">==</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">b"some-command"</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* do something */</span> <span class="token punctuation">}</span>
        _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* do something else */</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="mem-forget"><a href="#mem-forget" class="headerlink" title="mem::forget"></a><code>mem::forget</code></h2><p><a href="https://doc.rust-lang.org/std/mem/fn.forget.html" target="_blank" rel="noopener"><code>mem::forget</code></a>是一个安全的 API。如果我们的 API 真的安全，那么我们应该能够同时使用两者而不会遇到未定义的行为。然而，事实并非如此。考虑以下示例：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">unsound</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// start a DMA transfer and forget the returned `Transfer` value</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里，我们开始 DMA 传输 in <code>start</code>，以填充在堆栈上分配的数组，然后<code>mem::forget</code>是返回<code>Transfer</code>值。然后我们继续返回<code>start</code>并执行函数<code>bar</code>。</p>
<p>这一系列操作会导致未定义的行为。DMA 传输写入堆栈内存，但该内存在<code>start</code>返回时被释放，然后被重新<code>bar</code>用于分配变量，如<code>x</code>和<code>y</code>。在运行时，这可能会导致变量<code>x</code>并<code>y</code>随机更改其值。DMA 传输还可以覆盖由函数的序言推入堆栈的状态（例如链接寄存器）<code>bar</code>。</p>
<p>请注意，如果我们没有使用<code>mem::forget</code>, but <code>mem::drop</code>，则有可能使 make<code>Transfer</code>的析构函数停止 DMA 传输，然后程序就会是安全的。但是<em>不能</em>依靠运行的析构函数来强制执行内存安全，因为<code>mem::forget</code>内存泄漏（参见 RC 循环）在 Rust 中是安全的。</p>
<p>我们可以通过改变缓冲区的生存期解决这方面的问题 <code>'a</code>，以<code>'static</code>在这两个API。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果我们尝试复制之前的问题，我们会注意到它<code>mem::forget</code>不再引起问题。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[allow(dead_code)]</span>
<span class="token keyword">fn</span> <span class="token function">sound</span><span class="token punctuation">(</span><span class="token keyword">mut</span> serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE `buf` is moved into `foo`</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> serial<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// start a DMA transfer and forget the returned `Transfer` value</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和以前一样，DMA 传输<code>mem::forget</code>在<code>Transfer</code> 值之后继续。这一次不是问题，因为它<code>buf</code>是静态分配的（例如<code>static mut</code>变量）而不是在堆栈上。</p>
<h2 id="重叠使用"><a href="#重叠使用" class="headerlink" title="重叠使用"></a>重叠使用</h2><p>我们的 API 不会阻止用户<code>Serial</code>在 DMA 传输过程中使用该接口。这可能会导致传输失败或数据丢失。</p>
<p>有几种方法可以防止重叠使用。一种方法是<code>Transfer</code> 取得所有权<code>Serial1</code>并在<code>wait</code>被调用时将其归还。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> B<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// NOTE: added</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token comment" spellcheck="true">// NOTE: the return value has changed</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>B<span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Busy wait until the transfer is done</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token comment" spellcheck="true">// NOTE we now take `self` by value</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// NOTE: added</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token comment" spellcheck="true">// NOTE we now take `self` by value</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// NOTE: added</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>移动语义<code>Serial1</code>在传输过程中静态地阻止访问。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">read</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// let byte = serial.read(); //~ ERROR: `serial` has been moved</span>

    <span class="token comment" spellcheck="true">// .. do stuff ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>serial<span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do more stuff ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有其他方法可以防止重叠使用。例如，可以<code>Cell</code>将指示 DMA 传输是否正在进行的 ( ) 标志添加到 <code>Serial1</code>. 当设置标志时<code>read</code>，<code>write</code>,<code>read_exact</code>和<code>write_all</code> 都将<code>Error::InUse</code>在运行时返回错误（例如）。该标志将在使用<code>write_all</code>/时设置<code>read_exact</code>并在<code>Transfer.wait</code>.</p>
<h2 id="编译器（错误）优化"><a href="#编译器（错误）优化" class="headerlink" title="编译器（错误）优化"></a>编译器（错误）优化</h2><p>编译器可以自由地重新排序和合并非易失性存储器操作以更好地优化程序。使用我们当前的 API，这种自由可能会导致未定义的行为。考虑以下示例：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reorder</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// zero the buffer (for no particular reason)</span>
    buf<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>byte<span class="token operator">|</span> <span class="token operator">*</span>byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ... do other stuff ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    buf<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里，编译器可自由移动<code>buf.reverse()</code>之前<code>t.wait()</code>，这会导致数据争用：两个处理器和DMA最终会修改 <code>buf</code>在同一时间。类似地，编译器可以将归零操作移到 after <code>read_exact</code>，这也会导致数据竞争。</p>
<p>为了防止这些有问题的重新排序，我们可以使用 <a href="https://doc.rust-lang.org/core/sync/atomic/fn.compiler_fence.html" target="_blank" rel="noopener"><code>compiler_fence</code></a></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static mut [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma
            <span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *write*</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">write_all</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'static [u8]) -> Transfer&lt;&amp;'</span><span class="token keyword">static</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *write*</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>B<span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: this is a volatile *read*</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// NOTE: added</span>
        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们使用<code>Ordering::Release</code>in<code>read_exact</code>和<code>write_all</code>来防止所有前面的内存操作被移动到<em>之后</em> <code>self.dma.start()</code>，它执行易失性写入。</p>
<p>同样，我们使用<code>Ordering::Acquire</code>in<code>Transfer.wait</code>来防止所有后续内存操作被移动到<em>之前</em> <code>self.is_done()</code>，它执行易失性读取。</p>
<p>为了更好地可视化围栏的效果，这里是上一节示例的稍微调整版本。我们在评论中添加了围栏及其顺序。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reorder</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// zero the buffer (for no particular reason)</span>
    buf<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token operator">|</span>byte<span class="token operator">|</span> <span class="token operator">*</span>byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Release) ▲</span>

    <span class="token comment" spellcheck="true">// NOTE: the processor can't access `buf` between the fences</span>
    <span class="token comment" spellcheck="true">// ... do other stuff ..</span>
    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Acquire) ▼</span>

    <span class="token operator">*</span>x <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    buf<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于有 围栏，调零操作<em>后*</em>不能<em>移动。同样，</em>之前<em>由于围栏</em>无法<em>移动操作。两个围栏 *之间</em>的内存操作<em>可以</em>跨围栏自由重新排序，但这些操作都没有涉及，因此此类重新排序<em>不会</em>导致未定义的行为。 <code>read_exact``Release``reverse</code> <code>wait``Acquire``buf</code></p>
<p>请注意，这<code>compiler_fence</code>比所需的要强一些。例如，<code>x</code>即使我们知道<code>buf</code>不与<code>x</code>（由于 Rust 别名规则）重叠，围栏也会阻止操作被合并。但是，不存在比<code>compiler_fence</code>.</p>
<h3 id="我们不需要内存屏障吗？"><a href="#我们不需要内存屏障吗？" class="headerlink" title="我们不需要内存屏障吗？"></a>我们不需要内存屏障吗？</h3><p>这取决于目标架构。对于 Cortex M0 到 M4F 内核， <a href="https://static.docs.arm.com/dai0321/a/DAI0321A_programming_guide_memory_barriers_for_m_profile.pdf" target="_blank" rel="noopener">AN321</a>表示：</p>
<blockquote>
<p>3.2 典型用法</p>
<p>(..)</p>
<p>在 Cortex-M 处理器中很少需要使用 DMB，因为它们不会重新排序内存事务。但是，如果要在其他 ARM 处理器上重用该软件，尤其是多主系统，则需要它。例如：</p>
<ul>
<li>DMA 控制器配置。CPU 内存访问和 DMA 操作之间需要一个屏障。</li>
</ul>
<p>(..)</p>
<p>4.18 多主系统</p>
<p>(..)</p>
<p>在第 47 页的图 41 和图 42 的示例中省略 DMB 或 DSB 指令不会导致任何错误，因为 Cortex-M 处理器：</p>
<ul>
<li>不要重新排序内存传输</li>
<li>不允许两个写传输重叠。</li>
</ul>
</blockquote>
<p>其中图 41 显示了在开始 DMA 事务之前使用的 DMB（内存屏障）指令。</p>
<p>对于 Cortex-M7 内核，如果您使用数据缓存 (DCache)，您将需要内存屏障 (DMB/DSB)，除非您手动使 DMA 使用的缓冲区无效。即使禁用了数据缓存，仍可能需要内存屏障来避免在存储缓冲区中重新排序。</p>
<p>如果您的目标是多核系统，那么您很可能需要内存屏障。</p>
<p>如果确实需要内存屏障，则需要使用<a href="https://doc.rust-lang.org/core/sync/atomic/fn.fence.html" target="_blank" rel="noopener"><code>atomic::fence</code></a>而不是<code>compiler_fence</code>. 这应该会在 Cortex-M 设备上生成一条 DMB 指令。</p>
<h2 id="Generic-buffer"><a href="#Generic-buffer" class="headerlink" title="Generic buffer"></a>Generic buffer</h2><p>我们的 API 比它需要的更具限制性。例如，以下程序即使有效也不会被接受。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reuse</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// send a message</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t1<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// `msg` is now `&amp;'static [u8]`</span>

    msg<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// now send it in reverse</span>
    <span class="token keyword">let</span> t2 <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t2<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了接受这样的程序，我们可以使缓冲区参数通用。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// as-slice = "0.1.0"</span>
<span class="token keyword">use</span> as_slice<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>AsMutSlice<span class="token punctuation">,</span> AsSlice<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> B<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: added</span>
        <span class="token keyword">let</span> slice <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">as_mut_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>slice<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>USART1_RX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: tweaked</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>ptr <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> B<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// NOTE: added</span>
        <span class="token keyword">let</span> slice <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>slice<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_destination_address</span><span class="token punctuation">(</span>USART1_TX<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// NOTE: tweaked</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_source_address</span><span class="token punctuation">(</span>ptr <span class="token keyword">as</span> usize<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">set_transfer_length</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Release<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Transfer <span class="token punctuation">{</span>
            buffer<span class="token punctuation">,</span>
            serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注：</strong> <code>AsRef&lt;[u8]&gt;</code>（<code>AsMut&lt;[u8]&gt;</code>）可能已被使用，而不是 <code>AsSlice&lt;Element = u8&gt;</code>（<code>AsMutSlice&lt;Element = u8</code>）。</p>
</blockquote>
<p>现在该<code>reuse</code>计划将被接受。</p>
<h2 id="不可移动的缓冲区"><a href="#不可移动的缓冲区" class="headerlink" title="不可移动的缓冲区"></a>不可移动的缓冲区</h2><p>通过此修改，API 还将按值接受数组（例如<code>[u8; 16]</code>）。但是，使用数组会导致指针失效。考虑以下程序。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">invalidate</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span><span class="token punctuation">[</span>u8<span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// array allocated in this frame</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该<code>read_exact</code>操作将使用函数的<code>buffer</code>本地 地址<code>start</code>。返回<code>buffer</code>时该本地将被释放，<code>start</code>并且使用的指针<code>read_exact</code>将失效。您最终会遇到与<a href="https://docs.rust-embedded.org/embedonomicon/dma.html#dealing-with-memforget" target="_blank" rel="noopener"><code>unsound</code></a>示例类似的情况。</p>
<p>为了避免这个问题，我们要求与我们的 API 一起使用的缓冲区即使在移动时也保留其内存位置。该<a href="https://doc.rust-lang.org/nightly/std/pin/index.html" target="_blank" rel="noopener"><code>Pin</code></a>NEWTYPE提供这样的保证。我们可以更新我们的 API 以要求所有缓冲区首先“固定”。</p>
<blockquote>
<p><strong>注意：</strong>要编译此点以下的所有程序，您将需要 Rust <code>&gt;=1.33.0</code>。截至撰写本文时 (2019-01-04)，这意味着使用夜间频道。</p>
</blockquote>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: changed</span>
    buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: bounds changed</span>
        B<span class="token punctuation">:</span> DerefMut<span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: bounds changed</span>
        B<span class="token punctuation">:</span> Deref<span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意：</strong>我们本可以使用<a href="https://crates.io/crates/stable_deref_trait" target="_blank" rel="noopener"><code>StableDeref</code></a>trait 而不是<code>Pin</code> newtype 但选择了<code>Pin</code>它，因为它是在标准库中提供的。</p>
</blockquote>
<p>通过这个新 API，我们可以使用<code>&amp;'static mut</code>引用、<code>Box</code>-ed 切片、<code>Rc</code>-ed 切片等。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">static_mut</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">boxed</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span> buf<span class="token punctuation">:</span> Box<span class="token operator">&lt;</span><span class="token punctuation">[</span>u8<span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> serial<span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="39-static-边界"><a href="#39-static-边界" class="headerlink" title="'static 边界"></a><code>'static</code> 边界</h2><p>固定是否让我们安全地使用堆栈分配的数组？答案是<em>否定的</em>。考虑以下示例。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">unsound</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// pin-utils = "0.1.0-alpha.4"</span>
<span class="token keyword">use</span> pin_utils<span class="token punctuation">:</span><span class="token punctuation">:</span>pin_mut<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">start</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// pin the `buffer` to this stack frame</span>
    <span class="token comment" spellcheck="true">// `buffer` now has type `Pin&lt;&amp;mut [u8; 16]>`</span>
    <span class="token function">pin_mut!</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forget</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// stack variables</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// use `x` and `y`</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如前所述，由于堆栈帧损坏，上述程序会遇到未定义的行为。</p>
<p>该API不健全类型的缓冲区<code>Pin&lt;&amp;'a mut [u8]&gt;</code>，其中<code>'a</code>是<em>不是</em> <code>'static</code>。为了防止出现问题，我们必须<code>'static</code>在某些地方添加一个边界。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: added 'static bound</span>
        B<span class="token punctuation">:</span> DerefMut <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        <span class="token comment" spellcheck="true">// NOTE: added 'static bound</span>
        B<span class="token punctuation">:</span> Deref <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在有问题的程序将被拒绝。</p>
<h2 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h2><p>现在 API 接受<code>Box</code>-es 和其他具有析构函数的类型，我们需要决定在<code>Transfer</code>提前删除时做什么。</p>
<p>通常，<code>Transfer</code>使用该<code>wait</code>方法使用值，但也可以隐式或显式地<code>drop</code>在传输结束之前使用该值。例如，删除一个<code>Transfer&lt;Box&lt;[u8]&gt;&gt;</code>值将导致缓冲区被释放。如果传输仍在进行中，这可能会导致未定义的行为，因为 DMA 最终会写入已释放的内存。</p>
<p>在这种情况下，一种选择是<code>Transfer.drop</code>停止 DMA 传输。另一种选择是<code>Transfer.drop</code>等待传输完成。我们会选择前者，因为它更便宜。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// A DMA transfer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// NOTE: always `Some` variant</span>
    inner<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Inner<span class="token operator">&lt;</span>B<span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// NOTE: previously named `Transfer&lt;B>`</span>
<span class="token keyword">struct</span> Inner<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span>
    serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Blocks until the transfer is done and returns the buffer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span>Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">,</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">is_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> inner <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>inner
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token operator">||</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> hint<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">unreachable_unchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>inner<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> inner<span class="token punctuation">.</span>serial<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>B<span class="token operator">></span> Drop <span class="token keyword">for</span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// NOTE: this is a volatile write</span>
            inner<span class="token punctuation">.</span>serial<span class="token punctuation">.</span>dma<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// we need a read here to make the Acquire fence effective</span>
            <span class="token comment" spellcheck="true">// we do *not* need this if `dma.stop` does a RMW operation</span>
            <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                ptr<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_volatile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// we need a fence here for the same reason we need one in `Transfer.wait`</span>
            atomic<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">compiler_fence</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">:</span><span class="token punctuation">:</span>Acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Serial1 <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// Receives data into the given `buffer` until it's filled</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> read_exact<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> DerefMut <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsMutSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span> <span class="token operator">+</span> Unpin<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Inner <span class="token punctuation">{</span>
                buffer<span class="token punctuation">,</span>
                serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// Sends out the given `buffer`</span>
    <span class="token comment" spellcheck="true">///</span>
    <span class="token comment" spellcheck="true">/// Returns a value that represents the in-progress DMA transfer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> write_all<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> buffer<span class="token punctuation">:</span> Pin<span class="token operator">&lt;</span>B<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Transfer<span class="token operator">&lt;</span>B<span class="token operator">></span>
    <span class="token keyword">where</span>
        B<span class="token punctuation">:</span> Deref <span class="token operator">+</span> '<span class="token keyword">static</span><span class="token punctuation">,</span>
        B<span class="token punctuation">:</span><span class="token punctuation">:</span>Target<span class="token punctuation">:</span> AsSlice<span class="token operator">&lt;</span>Element <span class="token operator">=</span> u8<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// .. same as before ..</span>

        Transfer <span class="token punctuation">{</span>
            inner<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Inner <span class="token punctuation">{</span>
                buffer<span class="token punctuation">,</span>
                serial<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在 DMA 传输将在释放缓冲区之前停止。</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">reuse</span><span class="token punctuation">(</span>serial<span class="token punctuation">:</span> Serial1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf <span class="token operator">=</span> Pin<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t <span class="token operator">=</span> serial<span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Release) ▲</span>

    <span class="token comment" spellcheck="true">// ..</span>

    <span class="token comment" spellcheck="true">// this stops the DMA transfer and frees memory</span>
    mem<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">drop</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// compiler_fence(Ordering::Acquire) ▼</span>

    <span class="token comment" spellcheck="true">// this likely reuses the previous memory allocation</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// .. do stuff with `buf` ..</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="概括-1"><a href="#概括-1" class="headerlink" title="概括"></a>概括</h2><p>综上所述，实现内存安全的DMA传输需要考虑以下几点：</p>
<ul>
<li>使用不可移动的缓冲区加上间接：<code>Pin&lt;B&gt;</code>。或者，您可以使用<code>StableDeref</code>trait。</li>
<li>缓冲区的所有权必须传递给 DMA : <code>B: 'static</code>。</li>
<li>不要<em>不</em>依赖于存储安全运行析构函数。考虑如果<code>mem::forget</code>与您的 API 一起使用会发生什么。</li>
<li><em>不要</em>为它添加自定义的析构停止DMA传输，或者等待到结束。考虑如果<code>mem::drop</code>与您的 API 一起使用会发生什么。</li>
</ul>
<hr>
<p>本文省略了构建生产级 DMA 抽象所需的几个细节，例如配置 DMA 通道（例如流、循环与单次模式等）、缓冲区对齐、错误处理、如何制作抽象设备 -不可知论等。所有这些方面都留给读者/社区作为练习（<code>:P</code>）。</p>
<h1 id="关于编译器支持的说明"><a href="#关于编译器支持的说明" class="headerlink" title="关于编译器支持的说明"></a>关于编译器支持的说明</h1><p>本书使用了一个内置的<em>编译器</em>目标 ，<code>thumbv7m-none-eabi</code>Rust 团队为其分发了一个<code>rust-std</code>组件，这是一个预编译的 crate 集合，如<a href="https://doc.rust-lang.org/core/index.html" target="_blank" rel="noopener"><code>core</code></a> 和<a href="https://doc.rust-lang.org/std/index.html" target="_blank" rel="noopener"><code>std</code></a>。</p>
<p>如果您想尝试为不同的目标架构复制本书的内容，您需要考虑 Rust 为（编译）目标提供的不同级别的支持。</p>
<h2 id="LLVM-支持"><a href="#LLVM-支持" class="headerlink" title="LLVM 支持"></a>LLVM 支持</h2><p>从 Rust 1.28 开始，官方的 Rust 编译器<code>rustc</code>使用 LLVM 来生成（机器）代码。Rust 为架构提供的最低级别支持是在 <code>rustc</code>. 您可以<code>rustc</code>通过运行以下命令，通过 LLVM查看所有支持的架构：</p>
<pre class="line-numbers language-console"><code class="language-console">$ # you need to have `cargo-binutils` installed to run this command
$ cargo objdump -- -version
LLVM (http://llvm.org/):
  LLVM version 7.0.0svn
  Optimized build.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: skylake

  Registered Targets:
    aarch64    - AArch64 (little endian)
    aarch64_be - AArch64 (big endian)
    arm        - ARM
    arm64      - ARM64 (little endian)
    armeb      - ARM (big endian)
    hexagon    - Hexagon
    mips       - Mips
    mips64     - Mips64 [experimental]
    mips64el   - Mips64el [experimental]
    mipsel     - Mipsel
    msp430     - MSP430 [experimental]
    nvptx      - NVIDIA PTX 32-bit
    nvptx64    - NVIDIA PTX 64-bit
    ppc32      - PowerPC 32
    ppc64      - PowerPC 64
    ppc64le    - PowerPC 64 LE
    sparc      - Sparc
    sparcel    - Sparc LE
    sparcv9    - Sparc V9
    systemz    - SystemZ
    thumb      - Thumb
    thumbeb    - Thumb (big endian)
    wasm32     - WebAssembly 32-bit
    wasm64     - WebAssembly 64-bit
    x86        - 32-bit X86: Pentium-Pro and above
    x86-64     - 64-bit X86: EM64T and AMD64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果 LLVM 支持您感兴趣的架构，但<code>rustc</code>构建时禁用了后端（这是 Rust 1.28 中的 AVR 的情况），那么您将需要修改 Rust 源以启用它。PR <a href="https://github.com/rust-lang/rust/pull/52787" target="_blank" rel="noopener">rust-lang/rust#52787</a>的前两次提交让您了解所需的更改。</p>
<p>另一方面，如果 LLVM 不支持该架构，但 LLVM 的一个分支支持，则在构建<code>rustc</code>. Rust 构建系统允许这样做，原则上它应该只需要更改<code>llvm</code>子模块以指向 fork。</p>
<p>如果您的目标架构仅由某些供应商提供的 GCC 支持，您可以选择使用<a href="https://github.com/thepowersgang/mrustc" target="_blank" rel="noopener"><code>mrustc</code></a>，一个非官方的 Rust 编译器，将您的 Rust 程序转换为 C 代码，然后使用 GCC 编译它。</p>
<h2 id="内置目标"><a href="#内置目标" class="headerlink" title="内置目标"></a>内置目标</h2><p>编译目标不仅仅是它的架构。每个目标都有一个 与其相关联的<a href="https://github.com/rust-lang/rfcs/blob/master/text/0131-target-specification.md" target="_blank" rel="noopener">规范</a>，其中描述了其体系结构、操作系统和默认链接器。</p>
<p>Rust 编译器知道几个目标。这些<em>内置</em>在编译器中，可以通过运行以下命令列出：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc --print target-list | column
aarch64-fuchsia                   mipsisa32r6el-unknown-linux-gnu
aarch64-linux-android             mipsisa64r6-unknown-linux-gnuabi64
aarch64-pc-windows-msvc           mipsisa64r6el-unknown-linux-gnuabi64
aarch64-unknown-cloudabi          msp430-none-elf
aarch64-unknown-freebsd           nvptx64-nvidia-cuda
aarch64-unknown-hermit            powerpc-unknown-linux-gnu
aarch64-unknown-linux-gnu         powerpc-unknown-linux-gnuspe
aarch64-unknown-linux-musl        powerpc-unknown-linux-musl
aarch64-unknown-netbsd            powerpc-unknown-netbsd
aarch64-unknown-none              powerpc-wrs-vxworks
aarch64-unknown-none-softfloat    powerpc-wrs-vxworks-spe
aarch64-unknown-openbsd           powerpc64-unknown-freebsd
aarch64-unknown-redox             powerpc64-unknown-linux-gnu
aarch64-uwp-windows-msvc          powerpc64-unknown-linux-musl
aarch64-wrs-vxworks               powerpc64-wrs-vxworks
arm-linux-androideabi             powerpc64le-unknown-linux-gnu
arm-unknown-linux-gnueabi         powerpc64le-unknown-linux-musl
arm-unknown-linux-gnueabihf       riscv32i-unknown-none-elf
arm-unknown-linux-musleabi        riscv32imac-unknown-none-elf
arm-unknown-linux-musleabihf      riscv32imc-unknown-none-elf
armebv7r-none-eabi                riscv64gc-unknown-linux-gnu
armebv7r-none-eabihf              riscv64gc-unknown-none-elf
armv4t-unknown-linux-gnueabi      riscv64imac-unknown-none-elf
armv5te-unknown-linux-gnueabi     s390x-unknown-linux-gnu
armv5te-unknown-linux-musleabi    sparc-unknown-linux-gnu
armv6-unknown-freebsd             sparc64-unknown-linux-gnu
armv6-unknown-netbsd-eabihf       sparc64-unknown-netbsd
armv7-linux-androideabi           sparc64-unknown-openbsd
armv7-unknown-cloudabi-eabihf     sparcv9-sun-solaris
armv7-unknown-freebsd             thumbv6m-none-eabi
armv7-unknown-linux-gnueabi       thumbv7a-pc-windows-msvc
armv7-unknown-linux-gnueabihf     thumbv7em-none-eabi
armv7-unknown-linux-musleabi      thumbv7em-none-eabihf
armv7-unknown-linux-musleabihf    thumbv7m-none-eabi
armv7-unknown-netbsd-eabihf       thumbv7neon-linux-androideabi
armv7-wrs-vxworks-eabihf          thumbv7neon-unknown-linux-gnueabihf
armv7a-none-eabi                  thumbv7neon-unknown-linux-musleabihf
armv7a-none-eabihf                thumbv8m.base-none-eabi
armv7r-none-eabi                  thumbv8m.main-none-eabi
armv7r-none-eabihf                thumbv8m.main-none-eabihf
asmjs-unknown-emscripten          wasm32-unknown-emscripten
hexagon-unknown-linux-musl        wasm32-unknown-unknown
i586-pc-windows-msvc              wasm32-wasi
i586-unknown-linux-gnu            x86_64-apple-darwin
i586-unknown-linux-musl           x86_64-fortanix-unknown-sgx
i686-apple-darwin                 x86_64-fuchsia
i686-linux-android                x86_64-linux-android
i686-pc-windows-gnu               x86_64-linux-kernel
i686-pc-windows-msvc              x86_64-pc-solaris
i686-unknown-cloudabi             x86_64-pc-windows-gnu
i686-unknown-freebsd              x86_64-pc-windows-msvc
i686-unknown-haiku                x86_64-rumprun-netbsd
i686-unknown-linux-gnu            x86_64-sun-solaris
i686-unknown-linux-musl           x86_64-unknown-cloudabi
i686-unknown-netbsd               x86_64-unknown-dragonfly
i686-unknown-openbsd              x86_64-unknown-freebsd
i686-unknown-uefi                 x86_64-unknown-haiku
i686-uwp-windows-gnu              x86_64-unknown-hermit
i686-uwp-windows-msvc             x86_64-unknown-hermit-kernel
i686-wrs-vxworks                  x86_64-unknown-illumos
mips-unknown-linux-gnu            x86_64-unknown-l4re-uclibc
mips-unknown-linux-musl           x86_64-unknown-linux-gnu
mips-unknown-linux-uclibc         x86_64-unknown-linux-gnux32
mips64-unknown-linux-gnuabi64     x86_64-unknown-linux-musl
mips64-unknown-linux-muslabi64    x86_64-unknown-netbsd
mips64el-unknown-linux-gnuabi64   x86_64-unknown-openbsd
mips64el-unknown-linux-muslabi64  x86_64-unknown-redox
mipsel-unknown-linux-gnu          x86_64-unknown-uefi
mipsel-unknown-linux-musl         x86_64-uwp-windows-gnu
mipsel-unknown-linux-uclibc       x86_64-uwp-windows-msvc
mipsisa32r6-unknown-linux-gnu     x86_64-wrs-vxworks<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可以使用以下命令打印这些目标之一的规范：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustc +nightly -Z unstable-options --print target-spec-json --target thumbv7m-none-eabi
{
  "abi-blacklist": [
    "stdcall",
    "fastcall",
    "vectorcall",
    "thiscall",
    "win64",
    "sysv64"
  ],
  "arch": "arm",
  "data-layout": "e-m:e-p:32:32-i64:64-v128:64:128-a:0:32-n32-S64",
  "emit-debug-gdb-scripts": false,
  "env": "",
  "executables": true,
  "is-builtin": true,
  "linker": "arm-none-eabi-gcc",
  "linker-flavor": "gcc",
  "llvm-target": "thumbv7m-none-eabi",
  "max-atomic-width": 32,
  "os": "none",
  "panic-strategy": "abort",
  "relocation-model": "static",
  "target-c-int-width": "32",
  "target-endian": "little",
  "target-pointer-width": "32",
  "vendor": ""
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果这些内置目标似乎都不适合您的目标系统，则必须通过编写自己的 JSON 格式的目标规范文件来创建自定义目标，<a href="https://docs.rust-embedded.org/embedonomicon/custom-target.html" target="_blank" rel="noopener">下一节</a>将对此进行介绍 。</p>
<h2 id="rust-std-成分"><a href="#rust-std-成分" class="headerlink" title="rust-std 成分"></a><code>rust-std</code> 成分</h2><p>对于一些内置目标，Rust 团队<code>rust-std</code>通过<code>rustup</code>. 这个组件是一个预编译的 crate 的集合，比如<code>core</code>和<code>std</code>，交叉编译需要它。</p>
<p>您可以通过运行以下命令找到具有<code>rust-std</code>可用组件的目标列表<code>rustup</code>：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup target list | column
aarch64-apple-ios                       mipsel-unknown-linux-musl
aarch64-fuchsia                         nvptx64-nvidia-cuda
aarch64-linux-android                   powerpc-unknown-linux-gnu
aarch64-pc-windows-msvc                 powerpc64-unknown-linux-gnu
aarch64-unknown-linux-gnu               powerpc64le-unknown-linux-gnu
aarch64-unknown-linux-musl              riscv32i-unknown-none-elf
aarch64-unknown-none                    riscv32imac-unknown-none-elf
aarch64-unknown-none-softfloat          riscv32imc-unknown-none-elf
arm-linux-androideabi                   riscv64gc-unknown-linux-gnu
arm-unknown-linux-gnueabi               riscv64gc-unknown-none-elf
arm-unknown-linux-gnueabihf             riscv64imac-unknown-none-elf
arm-unknown-linux-musleabi              s390x-unknown-linux-gnu
arm-unknown-linux-musleabihf            sparc64-unknown-linux-gnu
armebv7r-none-eabi                      sparcv9-sun-solaris
armebv7r-none-eabihf                    thumbv6m-none-eabi
armv5te-unknown-linux-gnueabi           thumbv7em-none-eabi
armv5te-unknown-linux-musleabi          thumbv7em-none-eabihf
armv7-linux-androideabi                 thumbv7m-none-eabi
armv7-unknown-linux-gnueabi             thumbv7neon-linux-androideabi
armv7-unknown-linux-gnueabihf           thumbv7neon-unknown-linux-gnueabihf
armv7-unknown-linux-musleabi            thumbv8m.base-none-eabi
armv7-unknown-linux-musleabihf          thumbv8m.main-none-eabi
armv7a-none-eabi                        thumbv8m.main-none-eabihf
armv7r-none-eabi                        wasm32-unknown-emscripten
armv7r-none-eabihf                      wasm32-unknown-unknown
asmjs-unknown-emscripten                wasm32-wasi
i586-pc-windows-msvc                    x86_64-apple-darwin
i586-unknown-linux-gnu                  x86_64-apple-ios
i586-unknown-linux-musl                 x86_64-fortanix-unknown-sgx
i686-linux-android                      x86_64-fuchsia
i686-pc-windows-gnu                     x86_64-linux-android
i686-pc-windows-msvc                    x86_64-pc-windows-gnu
i686-unknown-freebsd                    x86_64-pc-windows-msvc
i686-unknown-linux-gnu                  x86_64-rumprun-netbsd
i686-unknown-linux-musl                 x86_64-sun-solaris
mips-unknown-linux-gnu                  x86_64-unknown-cloudabi
mips-unknown-linux-musl                 x86_64-unknown-freebsd
mips64-unknown-linux-gnuabi64           x86_64-unknown-linux-gnu (default)
mips64-unknown-linux-muslabi64          x86_64-unknown-linux-gnux32
mips64el-unknown-linux-gnuabi64         x86_64-unknown-linux-musl
mips64el-unknown-linux-muslabi64        x86_64-unknown-netbsd
mipsel-unknown-linux-gnu                x86_64-unknown-redox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果<code>rust-std</code>您的目标没有组件，或者您使用的是自定义目标，那么您将不得不使用夜间工具链来构建标准库。</p>
<h1 id="创建自定义目标"><a href="#创建自定义目标" class="headerlink" title="创建自定义目标"></a>创建自定义目标</h1><p>如果自定义目标三元组不适用于您的平台，您必须创建一个自定义目标文件，将您的目标描述为 rustc。</p>
<p>请记住，需要使用夜间编译器来构建核心库，这必须针对 rustc 未知的目标完成。</p>
<h2 id="确定目标三元组"><a href="#确定目标三元组" class="headerlink" title="确定目标三元组"></a>确定目标三元组</h2><p>许多目标已经有一个已知的三元组来描述它们，通常采用 ARCH-VENDOR-SYS-ABI 的形式。你的目标应该是使用与<a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple" target="_blank" rel="noopener">LLVM</a>相同的三元组；但是，如果您需要向 Rust 指定 LLVM 不知道的其他信息，则可能会有所不同。虽然三元组在技术上仅供人类使用，但它的独特性和描述性很重要，尤其是如果目标将来会被上游。</p>
<p>ARCH 部分通常只是架构名称，32 位 ARM 除外。例如，您可能会为这些处理器使用 x86_64，但要指定确切的 ARM 架构版本。典型值可能是<code>armv7</code>，<code>armv5te</code>或<code>thumbv7neon</code>。查看<a href="https://docs.rust-embedded.org/embedonomicon/compiler-support.html#built-in-target" target="_blank" rel="noopener">内置目标</a>的名称以获得灵感。</p>
<p>VENDOR 部分是可选的，它描述了制造商。省略此字段与使用<code>unknown</code>.</p>
<p>SYS 部分描述了所使用的操作系统。 对于桌面平台，典型值包括<code>win32</code>、<code>linux</code>和<code>darwin</code>。<code>none</code>用于裸机使用。</p>
<p>ABI 部分描述了流程是如何启动的。<code>eabi</code>用于裸机，而<code>gnu</code>用于 glibc、<code>musl</code>musl 等。</p>
<p>现在您有了一个目标三元组，创建一个包含三元组名称和<code>.json</code> 扩展名的文件。例如，描述的文件<code>armv7a-none-eabi</code>将具有文件名 <code>armv7a-none-eabi.json</code>。</p>
<h2 id="填充目标文件"><a href="#填充目标文件" class="headerlink" title="填充目标文件"></a>填充目标文件</h2><p>目标文件必须是有效的 JSON。有两个地方描述了它的内容： <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.Target.html" target="_blank" rel="noopener"><code>Target</code></a>，其中每个字段都是必需的，以及<a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.TargetOptions.html" target="_blank" rel="noopener"><code>TargetOptions</code></a>，每个字段都是可选的。 <strong>所有下划线都替换为连字符</strong>。</p>
<p>推荐的方法是将目标文件基于与目标系统相似的内置目标的规范，然后调整它以匹配目标系统的属性。为此，请使用命令 <code>rustc +nightly -Z unstable-options --print target-spec-json --target $SOME_SIMILAR_TARGET</code>，使用 <a href="https://docs.rust-embedded.org/embedonomicon/compiler-support.html#built-in-target" target="_blank" rel="noopener">编译器中已内置的目标</a>。</p>
<p>您几乎可以将该输出复制到您的文件中。从一些修改开始：</p>
<ul>
<li><p>消除 <code>"is-builtin": true</code></p>
</li>
<li><p>填充<code>llvm-target</code>用的<a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple" target="_blank" rel="noopener">三倍LLVM预期</a></p>
</li>
<li><p>决定一个恐慌的策略。裸机实现可能会使用 <code>"panic-strategy": "abort"</code>. 如果你决定不<code>abort</code>恐慌，除非你<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html#eh_personality" target="_blank" rel="noopener">告诉 Cargo</a>每个项目，你必须定义一个<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html#eh_personality" target="_blank" rel="noopener">eh_personality</a>函数。</p>
</li>
<li><p>配置原子。选择描述您的目标的第一个选项：</p>
<ul>
<li>我有一个单核处理器，没有线程，<a href="https://github.com/rust-lang/rust/issues/58500#issuecomment-654341233" target="_blank" rel="noopener"><strong>没有中断</strong></a>，或者以任何方式并行发生多种事情：如果您<strong>确定</strong>是这种情况，例如 WASM（目前），您可以设置<code>"singlethread": true</code>. 这将配置 LLVM 以将所有原子操作转换为使用它们的单线程对应项。如果使用线程或中断，错误地使用此选项可能会导致 UB。</li>
<li>我有本机原子操作：设置<code>max-atomic-width</code>为您的目标可以原子操作的最大位类型。例如，许多 ARM 内核具有 32 位原子操作。<code>"max-atomic-width": 32</code>在这种情况下你可以设置。</li>
<li>我没有本机原子操作，但我可以自己模拟它们：设置<code>max-atomic-width</code>为最多可以模拟 128 位的最高位数，然后将 LLVM 期望的所有<a href="http://llvm.org/docs/Atomics.html#libcalls-atomic" target="_blank" rel="noopener">原子</a>和<a href="http://llvm.org/docs/Atomics.html#libcalls-atomic" target="_blank" rel="noopener">同步</a>功能实现 为 <code>#[no_mangle] unsafe extern "C"</code>. 这些函数已经被gcc标准化了，所以<a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html" target="_blank" rel="noopener">gcc的文档</a>可能有更多的注释。缺少函数会导致链接器错误，而错误实现的函数可能会导致 UB。例如，如果您有一个带中断的单核、单线程处理器，您可以实现这些函数来禁用中断，执行常规操作，然后重新启用它们。</li>
<li>我没有本机原子操作：您必须做一些不安全的工作来手动确保代码中的同步。您必须设置<code>"max-atomic-width": 0</code>.</li>
</ul>
</li>
<li><p>如果与现有工具链集成，请更改链接器。例如，如果您使用的工具链使用 gcc 的自定义构建，请将</p>
<pre><code>"linker-flavor": "gcc"</code></pre><p>和设置</p>
<pre><code>linker</code></pre><p>为链接器的命令名称。如果您需要额外的链接器参数，请使用</p>
<pre><code>pre-link-args</code></pre><p>and </p>
<pre><code>post-link-args</code></pre><p>：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"pre-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--as-needed"</span><span class="token punctuation">,</span>
        <span class="token string">"-Wl,-z,noexecstack"</span><span class="token punctuation">,</span>
        <span class="token string">"-m64"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token property">"post-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--allow-multiple-definition"</span><span class="token punctuation">,</span>
        <span class="token string">"-Wl,--start-group,-lc,-lm,-lgcc,-lstdc++,-lsupc++,--end-group"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>确保链接器类型是</p>
<pre><code>link-args</code></pre><p>.</p>
</li>
<li><p>配置 LLVM 功能。<code>llc -march=ARCH -mattr=help</code>在 ARCH 是基本架构的地方运行（不包括 ARM 的版本）以列出可用功能及其描述。<strong>如果您的目标需要严格的内存对齐访问（例如<code>armv5te</code>），请确保启用<code>strict-align</code></strong>. 要启用某个功能，请在它之前放置一个加号。同样，要禁用某个功能，请在它之前放置一个减号。功能应该像这样用逗号分隔： <code>"features": "+soft-float,+neon</code>. 请注意，如果 LLVM 根据提供的三元组和 CPU 对您的目标有足够的了解，则这可能没有必要。</p>
</li>
<li><p>如果您知道，请配置 LLVM 使用的 CPU。这将启用特定于 CPU 的优化和功能。在上一步命令输出的顶部，有一个已知 CPU 的列表。如果您知道将针对特定 CPU，则可以<code>cpu</code>在 JSON 目标文件的字段中进行设置。</p>
</li>
</ul>
<h2 id="使用目标文件"><a href="#使用目标文件" class="headerlink" title="使用目标文件"></a>使用目标文件</h2><p>一旦你有了一个目标规范文件，<code>.json</code>如果它在当前目录或<code>$RUST_TARGET_PATH</code>.</p>
<p>验证它是否可以被 rustc 读取：</p>
<pre class="line-numbers language-sh"><code class="language-sh">❱ rustc --print cfg --target foo.json # or just foo if in the current directory
debug_assertions
target_arch="arm"
target_endian="little"
target_env=""
target_feature="mclass"
target_feature="v7"
target_has_atomic="16"
target_has_atomic="32"
target_has_atomic="8"
target_has_atomic="cas"
target_has_atomic="ptr"
target_os="none"
target_pointer_width="32"
target_vendor=""<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，您终于可以使用它了！许多资源一直在推荐<a href="https://github.com/japaric/xargo" target="_blank" rel="noopener"><code>xargo</code></a>或<a href="https://github.com/rust-osdev/cargo-xbuild" target="_blank" rel="noopener"><code>cargo-xbuild</code></a>. 然而，它的继任者，cargo 的<code>build-std</code>功能，最近收到了很多工作，并且很快就达到了与其他选项相同的功能。因此，本指南将仅涵盖该选项。</p>
<p>从一个最低限度的<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html" target="_blank" rel="noopener"><code>no_std</code>程序开始</a>。现在，<code>cargo build -Z build-std=core --target foo.json</code>再次使用上述有关引用路径的规则运行 。希望您现在应该在目标目录中有一个二进制文件。</p>
<p>您可以选择将货物配置为始终使用您的目标。请参阅页面末尾关于<a href="https://docs.rust-embedded.org/embedonomicon/smallest-no-std.html" target="_blank" rel="noopener">最小<code>no_std</code>程序的建议</a>。但是，您目前必须使用该标志，<code>-Z build-std=core</code>因为该选项不稳定。</p>
<h3 id="构建额外的内置crate"><a href="#构建额外的内置crate" class="headerlink" title="构建额外的内置crate"></a>构建额外的内置crate</h3><p>在使用cargo 的<code>build-std</code>特性时，你可以选择在哪个 crate 中编译。默认情况下，当只传递<code>-Z build-std</code>, <code>std</code>, <code>core</code>, 和<code>alloc</code>被编译时。但是，您可能希望<code>std</code>在为裸机编译时排除。为此，请在 之后指定您想要的板条箱 <code>build-std</code>。例如，要包含<code>core</code>和<code>alloc</code>，通过<code>-Z build-std=core,alloc</code>。</p>
<h2 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h2><h3 id="需要语言项，但未找到：-eh-personality"><a href="#需要语言项，但未找到：-eh-personality" class="headerlink" title="需要语言项，但未找到： eh_personality"></a>需要语言项，但未找到： <code>eh_personality</code></h3><p>添加<code>"panic-strategy": "abort"</code>到您的目标文件，或定义一个eh_personality函数。或者，告诉 Cargo 忽略它。</p>
<h3 id="未定义的引用-sync-val-compare-and-swap"><a href="#未定义的引用-sync-val-compare-and-swap" class="headerlink" title="未定义的引用 __sync_val_compare_and_swap_#"></a>未定义的引用 <code>__sync_val_compare_and_swap_#</code></h3><p>Rust 认为您的目标具有原子指令，但 LLVM 没有。回到关于配置原子的步骤 。您将需要减少 中的数量<code>max-atomic-width</code>。有关更多详细信息，请参阅<a href="https://github.com/rust-lang/rust/issues/58500" target="_blank" rel="noopener">#58500</a>。</p>
<h3 id="找不到sync在alloc"><a href="#找不到sync在alloc" class="headerlink" title="找不到sync在alloc"></a>找不到<code>sync</code>在<code>alloc</code></h3><p>与上述情况类似，Rust 不认为你有原子。你必须自己实现它们或者告诉 Rust 你有原子指令。</p>
<h3 id="多重定义-something"><a href="#多重定义-something" class="headerlink" title="多重定义 __(something)"></a>多重定义 <code>__(something)</code></h3><p>您可能会将 Rust 程序与从另一种语言构建的代码相关联，而另一种语言包括 Rust 也创建的编译器内置程序。要解决此问题，您需要告诉链接器允许多个定义。如果使用 gcc，您可以添加：</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token property">"post-link-args"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gcc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-Wl,--allow-multiple-definition"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加符号时出错：无法识别文件格式"><a href="#添加符号时出错：无法识别文件格式" class="headerlink" title="添加符号时出错：无法识别文件格式"></a>添加符号时出错：无法识别文件格式</h3><p>切换到货物的<code>build-std</code>功能并更新您的编译器。这是为一些试图将内部 Rust 对象传递给外部链接器的编译器构建引入<a href="https://github.com/rust-lang/cargo/issues/8239" target="_blank" rel="noopener">的错误</a>。</p>
<h1 id="😄《MicroRust》"><a href="#😄《MicroRust》" class="headerlink" title="😄《MicroRust》"></a>😄《MicroRust》</h1><h1 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h1><p>好的，让我们像往常一样开始使用 Rust。</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>让您的工具链保持最新总是好的。</p>
<p>现在让我们创建一个新的二进制项目。你可能不经常这样做，所以忘记是可以理解的。如果你运行<code>$ cargo</code>，你会得到一个提示。</p>
<h2 id="Buiding"><a href="#Buiding" class="headerlink" title="Buiding"></a>Buiding</h2><pre class="line-numbers language-shell"><code class="language-shell">$ cargo new microrust-start
     Created binary (application) `microrust-start` project
$ cd microrust-start
Cargo.toml  src<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这已经创建了一个二进制板条箱。</p>
<p>现在我们可以<code>$ cargo build</code>这样做，甚至<code>$ cargo run</code>可以，但是一切都在为您的计算机编译和运行。</p>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>micro:bit 的架构与您的计算机不同，因此第一步将是针对 micro:bit 的架构进行交叉编译。如果您进行 Internet 搜索，您会找到Rust的<a href="https://forge.rust-lang.org/platform-support.html" target="_blank" rel="noopener">平台支持列表</a>。查看此页面，您会发现 micro:bit 的 nRF51822 Cortex-M0 微处理器：</p>
<blockquote>
<pre><code>thumbv6m-none-eabi [*] [ ] [ ] Bare Cortex-M0, M0+, M1</code></pre></blockquote>
<p>“thumbv6m-none-eabi”是已知的目标三元组。注意星星代表什么：</p>
<blockquote>
<p>这些是裸机微控制器目标，只能访问核心库，不能访问 std。</p>
</blockquote>
<p>要安装此目标：</p>
<pre class="line-numbers language-console"><code class="language-console">$ rustup target add thumbv6m-none-eabi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="构建-1"><a href="#构建-1" class="headerlink" title="构建 1"></a>构建 1</h3><p>现在我们应该如何使用它？好吧，如果您要查看<code>$ cargo build -h</code>，您会尝试：</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error[E0463]: can't find crate for `std`
  |
  = note: the `thumbv6m-none-eabi` target may not be installed

error: aborting due to previous error

For more information about this error, try `rustc --explain E0463`.
error: Could not compile `microrust-start`.

To learn more, run the command again with --verbose.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>帮助说明相当无用，因为我们刚刚安装了该目标。我们还注意到，thumbv6m-none-eabi 目标不包括 std，只有核心 crate，它具有与平台无关的 std 功能子集。为什么在我们构建时它仍然在寻找 std crate？</p>
<h4 id="no-std"><a href="#no-std" class="headerlink" title="no_std"></a><code>no_std</code></h4><p>事实证明，除非明确禁用，否则 rust 将始终寻找 std crate，因此我们将添加 no_std 属性</p>
<pre><code>src/main.rs
#![no_std]

fn main() {
    println!("Hello, world!");
}</code></pre><h3 id="构建-2"><a href="#构建-2" class="headerlink" title="构建 2"></a>构建 2</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: cannot find macro `println!` in this scope
 --> src/main.rs:4:5
  |
4 |     println!("Hello, world!");
  |     ^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>println</code>是在 std crate 中找到的宏。我们目前不需要它，所以我们可以删除它并尝试重新构建。</p>
<h3 id="构建-3"><a href="#构建-3" class="headerlink" title="构建 3"></a>构建 3</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: `#[panic_handler]` function required, but not found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个错误是因为 rustc 需要实现一个恐慌处理程序。</p>
<h4 id="panic-impl"><a href="#panic-impl" class="headerlink" title="panic_impl"></a><code>panic_impl</code></h4><p>我们可以尝试自己实现 panic 宏，但是使用一个为我们完成它的 crate 更容易和更便携。</p>
<p>如果我们在<a href="https://crates.io/keywords/panic-impl" target="_blank" rel="noopener">crates.io 上查看 panic-impl 关键字，</a>我们会找到一些例子。让我们画一个最简单的，并将它添加到我们的 Cargo.toml。如果您忘记了如何执行此操作，请尝试查看<a href="https://doc.rust-lang.org/stable/cargo/" target="_blank" rel="noopener">货物手册</a>。</p>
<pre><code>Cargo.toml
[dependencies]
panic-halt = "~0.2"
src/main.rs
#![no_std]

extern crate panic_halt;

fn main() {
}</code></pre><h3 id="建造-4"><a href="#建造-4" class="headerlink" title="建造 4"></a>建造 4</h3><pre class="line-numbers language-shell"><code class="language-shell">$ cargo build --target thumbv6m-none-eabi
error: requires `start` lang_item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="no-main"><a href="#no-main" class="headerlink" title="no_main"></a><code>no_main</code></h4><p>在您习惯制作的普通命令行 rust 二进制文件中，执行二进制文件通常会通过执行 C 运行时库 (crt0) 来启动操作系统。这又会调用 Rust 运行时，如<code>start</code>语言项所标记，后者又会调用 main 函数。</p>
<p>启用后<code>no_std</code>，因为我们的目标是微控制器，crt0 和 rust 运行时都不可用，所以即使实现<code>start</code>也无济于事。我们需要更换操作系统入口点。</p>
<p>例如，您可以在默认入口点之后命名一个函数，对于 linux 是<code>_start</code>，并以这种方式启动。请注意，您还需要禁用<a href="https://en.wikipedia.org/wiki/Name_mangling" target="_blank" rel="noopener">name mangling</a>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是尝试让我们自己工作的道路的尽头。在这一点上，我们需要特定于板的支持箱和一些货物调整的帮助才能使其正常工作。</p>
<h4 id="microbit-crate"><a href="#microbit-crate" class="headerlink" title="microbit-crate"></a>microbit-crate</h4><p>让我们为 micro:bit 添加对板条箱的依赖。</p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
panic-halt = "~0.2"
microbit="~0.7"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>microbit crate 有两个值得注意的依赖项：</p>
<h4 id="embedded-hal"><a href="#embedded-hal" class="headerlink" title="embedded-hal"></a><code>embedded-hal</code></h4><p>这个 crate 是一个 HAL 实现 crate，其中 HAL 代表<em>硬件抽象层</em>。随着 Rust 在嵌入式开发中变得越来越流行，希望尽可能少的硬件特定实现。</p>
<p>出于这个原因，<code>embedded-hal</code>板条箱包含一系列硬件抽象特征，可以由板特定的板条箱实现。</p>
<h4 id="cortex-m-rt"><a href="#cortex-m-rt" class="headerlink" title="cortex-m-rt"></a><code>cortex-m-rt</code></h4><p>这个 crate 实现了 Cortex-M 微控制器的最小启动/运行时间。除其他外，这个板条箱提供：</p>
<ul>
<li>的<code>#[entry]</code>属性，来定义程序的入口点。</li>
<li>硬故障处理程序的定义</li>
<li>默认异常处理程序的定义</li>
</ul>
<p>这个箱子需要：</p>
<ul>
<li>将特定微控制器的存储器布局定义为 memory.x 文件。幸运的是，这通常由董事会支持箱提供</li>
</ul>
<p>要使用该<code>#[entry]</code>属性，我们需要将其添加为依赖项。</p>
<p>有关详细信息，您可以使用有用的<a href="https://docs.rs/crate/cortex-m-quickstart" target="_blank" rel="noopener">Cortex-M的，快速启动箱</a>和<a href="https://docs.rs/cortex-m-quickstart" target="_blank" rel="noopener">它的文档</a>。</p>
<h4 id="cargo-config"><a href="#cargo-config" class="headerlink" title="cargo-config"></a>cargo-config</h4><p>在我们继续之前，我们将通过编辑来调整货物的配置<code>microrust-start/.cargo/config</code>。有关更多信息，您可以<a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener">在此处</a>阅读<a href="https://doc.rust-lang.org/cargo/reference/config.html" target="_blank" rel="noopener">文档</a>。</p>
<p><a href="https://droogmic.github.io/microrust/getting-started/01.00.BUILD.html#cargoconfig" target="_blank" rel="noopener"><code>.cargo/config</code></a></p>
<pre class="line-numbers language-toml"><code class="language-toml"># Configure builds for our target, the micro:bit's architecture
[target.thumbv6m-none-eabi]
# Execute binary using gdb when calling cargo run
runner = "arm-none-eabi-gdb"
# Tweak to the linking process required by the cortex-m-rt crate
rustflags = [
    "-C", "link-arg=-Tlink.x",
    # The LLD linker is selected by default
    #"-C", "linker=arm-none-eabi-ld",
]

# Automatically select this target when cargo building this project
[build]
target = "thumbv6m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="arm-none-eabi-gdb-2"><a href="#arm-none-eabi-gdb-2" class="headerlink" title="arm-none-eabi-gdb"></a>arm-none-eabi-gdb</h4><p>这是用于 ARM EABI（嵌入式应用程序二进制接口）的 gdb（GNU 调试器）版本。它将允许我们从您的计算机调试在我们的 micro:bit 上运行的代码。</p>
<h3 id="构建目标"><a href="#构建目标" class="headerlink" title="构建目标"></a>构建目标</h3><p>现在，您需要做的就是运行<code>$ cargo build</code>，cargo 会自动添加<code>--target thumbv6m-none-eabi</code>.</p>
<h3 id="建造-5"><a href="#建造-5" class="headerlink" title="建造 5"></a>建造 5</h3><p><code>Cargo.toml</code></p>
<pre class="line-numbers language-toml"><code class="language-toml">[dependencies]
panic-halt = "~0.2"
microbit="~0.7"
cortex-m-rt="~0.6"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>src/main.rs</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
$ cargo build
error<span class="token punctuation">:</span> custom attribute panicked
 <span class="token operator">-</span><span class="token punctuation">-></span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">1</span>
  <span class="token operator">|</span>
<span class="token number">7</span> <span class="token operator">|</span> <span class="token attribute attr-name">#[entry]</span>
  <span class="token operator">|</span> <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span>
  <span class="token operator">|</span>
  <span class="token operator">=</span> help<span class="token punctuation">:</span> message<span class="token punctuation">:</span> `<span class="token attribute attr-name">#[entry]</span>` function must have signature `<span class="token punctuation">[</span><span class="token keyword">unsafe</span><span class="token punctuation">]</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span>`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>!</code> 返回类型</p>
<p>一个鲜为人知的锈功能，所以如果你不知道这意味着什么，我会原谅你。返回类型为的<code>!</code>意味着函数不能返回。实现这一点的一种简单方法是使用无限循环。</p>
<p><code>src/main.rs</code></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="建造-6"><a href="#建造-6" class="headerlink" title="建造 6"></a>建造 6</h3><p>如果您现在尝试构建，您应该最终会受到欢迎<code>Finished</code>！</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ cargo build
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="构建完成"><a href="#构建完成" class="headerlink" title="构建完成"></a>构建完成</h3><p>作为完整性检查，让我们验证生成的可执行文件实际上是 ARM 二进制文件：</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ file target/thumbv6m-none-eabi/debug/microrust-start
target/thumbv6m-none-eabi/debug/microrust-start: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped
                                                                            ^^^  ^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Flashing"><a href="#Flashing" class="headerlink" title="Flashing"></a>Flashing</h2><p>Flashing is the process of moving our program into the microcontroller’s (persistent) memory. Once flashed, the microcontroller will execute the flashed program every time it is powered on.</p>
<p>In this case, our <code>rustled</code> program will be the only program in the microcontroller memory. By this I mean that there’s nothing else running on the microcontroller: no OS, no daemon, nothing. <code>rustled</code> has full control over the device. This is what is meant by <em>bare-metal</em> programming.</p>
<ul>
<li><p>OS</p>
<p>operating system</p>
</li>
<li><p>Daemon</p>
<p>program running in the background</p>
</li>
</ul>
<p>Connect the micro:bit to your computer and run the following commands on a new terminal.</p>
<p>We need to give OCD the name of the interfaces we are using:</p>
<pre class="line-numbers language-console"><code class="language-console">$ # All
$ # Windows: remember that you need an extra `-s %PATH_TO_OPENOCD%\<version>\scripts`
$ openocd -f interface/cmsis-dap.cfg -f target/nrf51.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>The program will block; leave that terminal open.</p>
<p>Now it’s a good time to explain what this command is actually doing.</p>
<p>I mentioned that the micro:bit actually has two microcontrollers. One of them is used as a USB interface and programmer/debugger. This microcontroller is connected to the target microcontroller using a Serial Wire Debug (SWD) interface (this interface is an ARM standard so you’ll run into it when dealing with other Cortex-M based microcontrollers). This SWD interface can be used to flash and debug a microcontroller. It uses the CMSIS-DAP protocol for host debugging of application programs. It will appear as a USB device when you connect the micro:bit to your laptop.</p>
<p>As for OpenOCD, it’s software that provides some services like a <em>GDB server</em> on top of USB devices that expose a debugging protocol like SWD or JTAG.</p>
<blockquote>
<p>GDB: The <strong>G</strong>NU <strong>d</strong>e<strong>b</strong>ugger will allow us to debug our software by controlling the execution of our program. We will learn more about this a little bit later.</p>
</blockquote>
<p>Onto the actual command: those <code>.cfg</code> files we are using instruct OpenOCD to look for</p>
<ul>
<li>a CMSIS-DAP USB interface device (<code>interface/cmsis-dap.cfg</code>)</li>
<li>a nRF51XXX microcontroller target (<code>target/nrf51.cfg</code>) to be connected to the USB interface.</li>
</ul>
<p>The OpenOCD output looks like this:</p>
<pre class="line-numbers language-console"><code class="language-console">Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
    http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "swd". To override use 'transport select <transport>'.
cortex_m reset_config sysresetreq
adapter speed: 1000 kHz
Info : CMSIS-DAP: SWD  Supported
Info : CMSIS-DAP: Interface Initialised (SWD)
Info : CMSIS-DAP: FW Version = 1.0
Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1
Info : CMSIS-DAP: Interface ready
Info : clock speed 1000 kHz
Info : SWD DPIDR 0x0bb11477
Info : nrf51.cpu: hardware has 4 breakpoints, 2 watchpoints<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The “4 breakpoints, 2 watchpoints” part indicates the debugging features the processor has available.</p>
<p>I mentioned that OpenOCD provides a GDB server so let’s connect to that right now:</p>
<pre class="line-numbers language-console"><code class="language-console">$ arm-none-eabi-gdb -q target/thumbv6m-none-eabi/debug/rustled
Reading symbols from target/thumbv6m-none-eabi/debug/rustled...done.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>This only opens a GDB shell. To actually connect to the OpenOCD GDB server, use the following command within the GDB shell:</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>By default OpenOCD’s GDB server listens on TCP port 3333 (localhost). This command is connecting to that port.</p>
<p>After entering this command, you’ll see new output in the OpenOCD terminal:</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : stm32f3x.cpu: hardware has 4 breakpoints, 2 watchpoints
<span class="token inserted">+Info : accepting 'gdb' connection on tcp/3333</span>
<span class="token inserted">+Info : nRF51822-QFAA(build code: H0) 256kB Flash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Almost there. To flash the device, we’ll use the <code>load</code> command inside the GDB shell:</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) load
Loading section .vector_table, size 0x188 lma 0x8000000
Loading section .text, size 0x38a lma 0x8000188
Loading section .rodata, size 0x8 lma 0x8000514
Start address 0x8000188, load size 1306
Transfer rate: 6 KB/sec, 435 bytes/write.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>And that’s it. You’ll also see new output in the OpenOCD terminal.</p>
<pre class="line-numbers language-diff"><code class="language-diff"> Info : flash size = 256kbytes
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 8000 kHz, using 4000 kHz</span>
<span class="token inserted">+adapter speed: 4000 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to breakpoint, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x61000000 pc: 0x2000003a msp: 0x2000a000</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+Info : Unable to match requested speed 1000 kHz, using 950 kHz</span>
<span class="token inserted">+adapter speed: 950 kHz</span>
<span class="token inserted">+target state: halted</span>
<span class="token inserted">+target halted due to debug-request, current mode: Thread</span>
<span class="token inserted">+xPSR: 0x01000000 pc: 0x08000194 msp: 0x2000a000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Our program is loaded, we can now run it!</p>
<pre class="line-numbers language-gdb"><code class="language-gdb">(gdb) continue
Continuing.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Continue runs the program until the next breakpoint. This time it blocks, nothing happens. This is because all we have in our code is a loop!</p>
<h3 id="gdbinit"><a href="#gdbinit" class="headerlink" title=".gdbinit"></a><code>.gdbinit</code></h3><p>Before we move on though, we are going to add one more file to our project. This will automate the last few steps so we don’t need to repeatedly do the same actions in gdb:</p>
<pre><code>.gdbinit
# Connects GDB to OpenOCD server port
target remote :3333
# (optional) Unmangle function names when debugging
set print asm-demangle on
# Load your program, breaks at entry
load
# (optional) Add breakpoint at function
break rustled::main
# Continue with execution
continue</code></pre><p>Now we can learn how to debug code on the micro:bit.</p>
<h2 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h2><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>在开始之前，让我们添加一些代码进行调试：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// -- snip --</span>
<span class="token function">entry!</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="GDB-会话"><a href="#GDB-会话" class="headerlink" title="GDB 会话"></a>GDB 会话</h3><p>我们已经在调试会话中，所以让我们调试我们的程序。</p>
<p>在<code>load</code>命令之后，我们的程序在它的<em>入口点</em>停止。这由 GDB 输出的“起始地址 0x8000XXX”部分指示。入口点是处理器/CPU 将首先执行的程序的一部分。</p>
<p>我提供给您的入门项目有一些在函数<em>之前</em>运行的额外代码<code>main</code>。此时，我们对“pre-main”部分不感兴趣，所以让我们直接跳到<code>main</code>函数的开头。我们将使用断点来做到这一点：</p>
<pre><code>(gdb) break rustled::main
Breakpoint 1 at 0x8000218: file src/main.rs, line 8.

(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, rustled::main () at src/rustled/src/main.rs:13
13          let x = 42;</code></pre><p>断点可用于停止程序的正常流程。该<code>continue</code>命令将使程序自由运行，<em>直到</em>到达断点。在这种情况下，直到它到达<code>main</code>函数，因为那里有一个断点。</p>
<p>请注意，GDB 输出显示“断点 1”。请记住，我们的处理器只能使用其中的四个断点，因此最好注意这些消息。</p>
<p>为了获得更好的调试体验，我们将使用 GDB 的文本用户界面 (TUI)。要进入该模式，请在 GDB shell 上输入以下命令：</p>
<pre><code>(gdb) layout src</code></pre><blockquote>
<p><strong>注意 向</strong>Windows 用户道歉。GNU ARM Embedded Toolchain 附带的 GDB 不支持此 TUI 模式<code>:(</code>。</p>
</blockquote>
<p>您可以随时使用以下命令退出 TUI 模式：</p>
<pre><code>(gdb) tui disable</code></pre><p>好的。我们现在处于<code>main</code>. 我们可以使用<code>step</code>命令逐句推进程序语句。所以让我们使用它两次来达到<code>y = x</code>语句。输入<code>step</code>一次后，您只需按 Enter 即可再次运行它。</p>
<pre><code>(gdb) step
14           _y = x;</code></pre><p>如果您没有使用 TUI 模式，则在每次<code>step</code>调用时 GDB 都会打印回当前语句及其行号。</p>
<p>我们现在“在”<code>y = x</code>声明；该语句尚未执行。这意味着<code>x</code> 已初始化但未初始化<code>y</code>。让我们使用以下<code>print</code>命令检查这些堆栈/局部变量：</p>
<pre><code>(gdb) print x
$1 = 42

(gdb) print &amp;x
$2 = (i32 *) 0x10001fdc

(gdb) print _y
$3 = 134219052

(gdb) print &amp;_y
$4 = (i32 *) 0x10001fd8</code></pre><p>正如预期的那样，<code>x</code>包含值<code>42</code>。 <code>_y</code>但是，包含值<code>134219052</code>(?)。因为<code>_y</code>还没有被初始化，所以包含了一些垃圾值。</p>
<p>该命令<code>print &amp;x</code>打印变量的地址<code>x</code>。这里有趣的一点是 GDB 输出显示了引用的类型： <code>i32*</code>，一个指向<code>i32</code>值的指针。另一个有趣的事情是，地址<code>x</code>和<code>_y</code>非常接近对方：他们的地址只是<code>4</code>个字节分开。</p>
<p>也可以使用以下<code>info locals</code>命令，而不是一一打印局部变量：</p>
<pre><code>(gdb) info locals
x = 42
_y = 134219052</code></pre><p>好的。使用 another <code>step</code>，我们将在<code>loop {}</code>语句之上：</p>
<pre><code>(gdb) step
17          loop {}</code></pre><p>并且<code>_y</code>现在应该被初始化。</p>
<pre><code>(gdb) print _y
$5 = 42</code></pre><p>如果我们<code>step</code>再次在<code>loop {}</code>语句之上使用，我们会卡住，因为程序永远不会通过该语句。相反，我们将使用<code>layout asm</code> 命令切换到反汇编视图，并使用 一次推进一条指令<code>stepi</code>。</p>
<blockquote>
<p><strong>注意</strong>如果您<code>step</code>错误地使用了该命令并且 GDB 卡住了，您可以通过点击 来解除卡住<code>Ctrl+C</code>。</p>
</blockquote>
<pre><code>(gdb) layout asm</code></pre><p>如果您没有使用 TUI 模式，您可以使用该<code>disassemble /m</code>命令在您当前所在的行周围反汇编程序。</p>
<pre><code>(gdb) disassemble /m
Dump of assembler code for function led_roulette::main:
11      fn main() -&gt; ! {
   0x08000188 &lt;+0&gt;:     sub     sp, #8

12          let _y;
13          let x = 42;
   0x0800018a &lt;+2&gt;:     movs    r0, #42 ; 0x2a
   0x0800018c &lt;+4&gt;:     str     r0, [sp, #4]

14          _y = x;
   0x0800018e &lt;+6&gt;:     ldr     r0, [sp, #4]
   0x08000190 &lt;+8&gt;:     str     r0, [sp, #0]

15
16          // infinite loop; just so we don't leave this stack frame
17          loop {}
=&gt; 0x08000192 &lt;+10&gt;:    b.n     0x8000194 &lt;led_roulette::main+12&gt;
   0x08000194 &lt;+12&gt;:    b.n     0x8000194 &lt;led_roulette::main+12&gt;

End of assembler dump.</code></pre><p>看到<code>=&gt;</code>左侧的粗箭头了吗？它显示了处理器接下来将执行的指令。</p>
<p>如果不在每个<code>stepi</code>命令的 TUI 模式内，GDB 将打印语句、行号<em>和</em>处理器接下来将执行的指令的地址。</p>
<pre><code>(gdb) stepi
0x08000194      17          loop {}

(gdb) stepi
0x08000194      17          loop {}</code></pre><p>在我们转向更有趣的事情之前的最后一个技巧。在 GDB 中输入以下命令：</p>
<pre><code>(gdb) monitor reset halt
Unable to match requested speed 1000 kHz, using 950 kHz
Unable to match requested speed 1000 kHz, using 950 kHz
adapter speed: 950 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08000188 msp: 0x10002000

(gdb) continue
Continuing.

Breakpoint 1, led_roulette::main () at src/main.rs:8
8           let x = 42;</code></pre><p>我们现在回到了开头<code>main</code>！</p>
<p><code>monitor reset halt</code>将重置微控制器并在程序入口点停止它。下面的<code>continue</code>命令将让程序自由运行，直到它到达<code>main</code>有断点的函数。</p>
<p>当您错误地跳过您有兴趣检查的程序部分时，此组合非常方便。您可以轻松地将程序的状态回滚到最初的状态。</p>
<blockquote>
<p><strong>细则</strong>：此<code>reset</code>命令不会清除或触摸 RAM。该内存将保留其上次运行的值。不过，这应该不是问题，除非您的程序行为取决于<em>未初始化<em>变量的值，但这就是</em>未定义行为</em>(UB)的定义。</p>
</blockquote>
<p>我们完成了这个调试会话。你可以用<code>quit</code>命令结束它。</p>
<pre><code>(gdb) quit
A debugging session is active.

        Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: $PWD/target/thumbv7em-none-eabihf/debug/led-roulette, Remote target
Ending remote debugging.</code></pre><blockquote>
<p><strong>注意</strong>如果您不喜欢默认的 GDB CLI，请查看<a href="https://github.com/cyrus-and/gdb-dashboard#gdb-dashboard" target="_blank" rel="noopener">gdb-dashboard</a>。它使用 Python 将默认的 GDB CLI 转换为显示寄存器、源代码视图、程序集视图和其他内容的仪表板。</p>
</blockquote>
<p>但是不要关闭 OpenOCD！以后我们会一次又一次地使用它。最好让它继续运行。</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>这是我们迄今为止所做工作的回顾。</p>
<h3 id="Cargo-toml"><a href="#Cargo-toml" class="headerlink" title="Cargo.toml"></a>Cargo.toml</h3><pre class="line-numbers language-toml"><code class="language-toml">[package]
name = "start"
version = "0.2.0"

[dependencies]
panic-halt = "~0.2"
microbit="~0.7"
cortex-m-rt="~0.6"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h3><pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#![no_std]</span>
<span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> cortex_m_rt<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> microbit<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> panic_halt<span class="token punctuation">;</span>

<span class="token keyword">use</span> cortex_m_rt<span class="token punctuation">:</span><span class="token punctuation">:</span>entry<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[entry]</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _y<span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _y <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="cargo-config-1"><a href="#cargo-config-1" class="headerlink" title=".cargo/config"></a><code>.cargo/config</code></h3><pre class="line-numbers language-toml"><code class="language-toml"># Configure builds for our target, the micro:bit's architecture
[target.thumbv6m-none-eabi]
# Execute binary using gdb when calling cargo run
runner = "arm-none-eabi-gdb"
# Tweak to the linking process required by the cortex-m-rt crate
rustflags = [
    "-C", "link-arg=-Tlink.x",
    # The LLD linker is selected by default
    #"-C", "linker=arm-none-eabi-ld",
]

# Automatically select this target when cargo building this project
[build]
target = "thumbv6m-none-eabi"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="gdbinit-1"><a href="#gdbinit-1" class="headerlink" title=".gdbinit"></a><code>.gdbinit</code></h3><pre class="line-numbers language-gdb"><code class="language-gdb"># Connects GDB to OpenOCD server port
target remote :3333
# (optional) Unmangle function names when debugging
set print asm-demangle on
# Load your program, breaks at entry
load
# (optional) Add breakpoint at function
break main
# Continue with execution
continue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/embedded-rust.html">https://jackhcc.github.io/posts/embedded-rust.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Rust/">
                                    <span class="chip bg-color">Rust</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-09-08T21-32-49',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/ml-algorithm.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/2.jpg" class="responsive-img" alt="Machine Learning Algorithm">
                        
                        <span class="card-title">Machine Learning Algorithm</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            机器学习经典算法
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-09-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Algorithm/" class="post-category">
                                    Algorithm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Machine-Learning/">
                        <span class="chip bg-color">Machine Learning</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/awesome-bcsd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/22.jpg" class="responsive-img" alt="Awesome BCSD 2021">
                        
                        <span class="card-title">Awesome BCSD 2021</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Binary Code Similarity Detection 2021 研究汇总
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Awesome/" class="post-category">
                                    Awesome
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/BCSD/">
                        <span class="chip bg-color">BCSD</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

