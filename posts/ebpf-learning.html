<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="EBPF（Berkeley Packet Filter）学习记录, JackHCC">
    <meta name="description" content="EBPF学习笔记与实战应用">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EBPF（Berkeley Packet Filter）学习记录 | JackHCC</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my.css">
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="JackHCC" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-hopscotch.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">JackHCC</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Tools</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Creative工具导航</span>
        </a>
      </li>
      
      <li>
        <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/" target="_blank" rel="noopener">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>NLP每日论文</span>
        </a>
      </li>
      
      <li>
        <a href="http://chat.creativecc.cn/" target="_blank" rel="noopener">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>RocketChat聊天室</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Contact留言板</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/me.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">JackHCC</div>
        <div class="logo-desc">
            
            Make the world betterrrr!!!
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Tools
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="https://creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Creative工具导航</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="https://blog.creativecc.cn/Arxiv-NLP-Reporter/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>NLP每日论文</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="http://chat.creativecc.cn/ " target="_blank" rel="noopener" style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>RocketChat聊天室</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact " style="margin-left:75px";>
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Contact留言板</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JackHCC/JackHCC.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JackHCC/JackHCC.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">EBPF（Berkeley Packet Filter）学习记录</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 30px;
        bottom: 146px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/EBPF/">
                                <span class="chip bg-color">EBPF</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Linux-Kernel/" class="post-category">
                                Linux Kernel
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-28
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    12.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    62 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a><strong>相关资料</strong></h2><ul>
<li><p><a href="https://blog.csdn.net/21cnbao/article/details/95585483" target="_blank" rel="noopener">深入理解 Linux eBPF：阅读清单</a></p>
</li>
<li><p><a href="https://github.com/DavadDi/bpf_study" target="_blank" rel="noopener">BPF内核观测技术学习</a></p>
</li>
</ul>
<h2 id="EBPF相关要点介绍"><a href="#EBPF相关要点介绍" class="headerlink" title="EBPF相关要点介绍"></a>EBPF相关要点介绍</h2><h4 id="在内核中的-BPF-代码"><a href="#在内核中的-BPF-代码" class="headerlink" title="在内核中的 BPF 代码"></a>在内核中的 BPF 代码</h4><ul>
<li><p>文件 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h" target="_blank" rel="noopener">linux/include/linux/bpf.h</a>及其相对的 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/bpf.h" target="_blank" rel="noopener">linux/include/uapi/bpf.h</a>包含有关 eBPF 的 <strong>定义</strong>，它们分别用在内核中和用户空间程序的接口。</p>
<p><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/bpf.h" target="_blank" rel="noopener">linux/include/uapi/bpf.h</a>  bpf虚拟机参数</p>
</li>
<li><p>寄存器：</p>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Register numbers */</span>
<span class="token keyword">enum</span> <span class="token punctuation">{</span>
        BPF_REG_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        BPF_REG_1<span class="token punctuation">,</span>
        BPF_REG_2<span class="token punctuation">,</span>
        BPF_REG_3<span class="token punctuation">,</span>
        BPF_REG_4<span class="token punctuation">,</span>
        BPF_REG_5<span class="token punctuation">,</span>
        BPF_REG_6<span class="token punctuation">,</span>
        BPF_REG_7<span class="token punctuation">,</span>
        BPF_REG_8<span class="token punctuation">,</span>
        BPF_REG_9<span class="token punctuation">,</span>
        BPF_REG_10<span class="token punctuation">,</span>
        __MAX_BPF_REG<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>指令格式：</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> bpf_insn <span class="token punctuation">{</span>
        __u8        code<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* opcode */</span>
        __u8        dst_reg<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* dest register */</span>
        __u8        src_reg<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* source register */</span>
        __s16        off<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* signed offset */</span>
        __s32        imm<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/* signed immediate constant */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>指令宏：</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* instruction classes */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JMP32        0x06        </span><span class="token comment" spellcheck="true">/* jmp mode in word width */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_ALU64        0x07        </span><span class="token comment" spellcheck="true">/* alu mode in double word width */</span>
<span class="token comment" spellcheck="true">/* ld/ldx fields */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_DW                0x18        </span><span class="token comment" spellcheck="true">/* double word (64-bit) */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_ATOMIC        0xc0        </span><span class="token comment" spellcheck="true">/* atomic memory ops - op type in immediate */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_XADD        0xc0        </span><span class="token comment" spellcheck="true">/* exclusive add - legacy name */</span>
<span class="token comment" spellcheck="true">/* alu/jmp fields */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_MOV                0xb0        </span><span class="token comment" spellcheck="true">/* mov reg to reg */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_ARSH        0xc0        </span><span class="token comment" spellcheck="true">/* sign extending arithmetic shift right */</span>
<span class="token comment" spellcheck="true">/* change endianness of a register */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_END                0xd0        </span><span class="token comment" spellcheck="true">/* flags for endianness conversion: */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_TO_LE        0x00        </span><span class="token comment" spellcheck="true">/* convert to little-endian */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_TO_BE        0x08        </span><span class="token comment" spellcheck="true">/* convert to big-endian */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_FROM_LE        BPF_TO_LE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_FROM_BE        BPF_TO_BE</span>
<span class="token comment" spellcheck="true">/* jmp encodings */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JNE                0x50        </span><span class="token comment" spellcheck="true">/* jump != */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JLT                0xa0        </span><span class="token comment" spellcheck="true">/* LT is unsigned, '&lt;' */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JLE                0xb0        </span><span class="token comment" spellcheck="true">/* LE is unsigned, '&lt;=' */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JSGT        0x60        </span><span class="token comment" spellcheck="true">/* SGT is signed '>', GT in x86 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JSGE        0x70        </span><span class="token comment" spellcheck="true">/* SGE is signed '>=', GE in x86 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JSLT        0xc0        </span><span class="token comment" spellcheck="true">/* SLT is signed, '&lt;' */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_JSLE        0xd0        </span><span class="token comment" spellcheck="true">/* SLE is signed, '&lt;=' */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_CALL        0x80        </span><span class="token comment" spellcheck="true">/* function call */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_EXIT        0x90        </span><span class="token comment" spellcheck="true">/* function return */</span>
<span class="token comment" spellcheck="true">/* atomic op type fields (stored in immediate) */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_FETCH        0x01        </span><span class="token comment" spellcheck="true">/* not an opcode on its own, used to build others */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_XCHG        (0xe0 | BPF_FETCH)        </span><span class="token comment" spellcheck="true">/* atomic exchange */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_CMPXCHG        (0xf0 | BPF_FETCH)        </span><span class="token comment" spellcheck="true">/* atomic compare-and-write */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>指令码：</li>
</ul>
<p>64-bit</p>
<table>
<thead>
<tr>
<th>Opcode 操作码</th>
<th>Mnemonic 助记符</th>
<th>Pseudocode 伪代码</th>
</tr>
</thead>
<tbody><tr>
<td>0x07</td>
<td>add dst, imm</td>
<td>dst += imm</td>
</tr>
<tr>
<td>0x0f</td>
<td>add dst, src</td>
<td>dst += src</td>
</tr>
<tr>
<td>0x17</td>
<td>sub dst, imm</td>
<td>dst -= imm</td>
</tr>
<tr>
<td>0x1f</td>
<td>sub dst, src</td>
<td>dst -= src</td>
</tr>
<tr>
<td>0x27</td>
<td>mul dst, imm</td>
<td>dst *= imm</td>
</tr>
<tr>
<td>0x2f</td>
<td>mul dst, src</td>
<td>dst *= src</td>
</tr>
<tr>
<td>0x37</td>
<td>div dst, imm</td>
<td>dst /= imm</td>
</tr>
<tr>
<td>0x3f</td>
<td>div dst, src</td>
<td>dst /= src</td>
</tr>
<tr>
<td>0x47</td>
<td>or dst, imm</td>
<td>dst |= imm</td>
</tr>
<tr>
<td>0x4f</td>
<td>or dst, src</td>
<td>dst |= src</td>
</tr>
<tr>
<td>0x57</td>
<td>and dst, imm</td>
<td>dst &amp;= imm</td>
</tr>
<tr>
<td>0x5f</td>
<td>and dst, src</td>
<td>dst &amp;= src</td>
</tr>
<tr>
<td>0x67</td>
<td>lsh dst, imm</td>
<td>dst &lt;&lt;= imm</td>
</tr>
<tr>
<td>0x6f</td>
<td>lsh dst, src</td>
<td>dst &lt;&lt;= src</td>
</tr>
<tr>
<td>0x77</td>
<td>rsh dst, imm</td>
<td>dst &gt;&gt;= imm (logical)</td>
</tr>
<tr>
<td>0x7f</td>
<td>rsh dst, src</td>
<td>dst &gt;&gt;= src (logical)</td>
</tr>
<tr>
<td>0x87</td>
<td>neg dst</td>
<td>dst = -dst</td>
</tr>
<tr>
<td>0x97</td>
<td>mod dst, imm</td>
<td>dst %= imm</td>
</tr>
<tr>
<td>0x9f</td>
<td>mod dst, src</td>
<td>dst %= src</td>
</tr>
<tr>
<td>0xa7</td>
<td>xor dst, imm</td>
<td>dst ^= imm</td>
</tr>
<tr>
<td>0xaf</td>
<td>xor dst, src</td>
<td>dst ^= src</td>
</tr>
<tr>
<td>0xb7</td>
<td>mov dst, imm</td>
<td>dst = imm</td>
</tr>
<tr>
<td>0xbf</td>
<td>mov dst, src</td>
<td>dst = src</td>
</tr>
<tr>
<td>0xc7</td>
<td>arsh dst, imm</td>
<td>dst &gt;&gt;= imm (arithmetic)</td>
</tr>
<tr>
<td>0xcf</td>
<td>arsh dst, src</td>
<td>dst &gt;&gt;= src (arithmetic)</td>
</tr>
</tbody></table>
<p>32-bit</p>
<p>这些指令只对low 32位有效，会把high 32位清空</p>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Mnemonic</th>
<th>Pseudocode</th>
</tr>
</thead>
<tbody><tr>
<td>0x04</td>
<td>add32 dst, imm</td>
<td>dst += imm</td>
</tr>
<tr>
<td>0x0c</td>
<td>add32 dst, src</td>
<td>dst += src</td>
</tr>
<tr>
<td>0x14</td>
<td>sub32 dst, imm</td>
<td>dst -= imm</td>
</tr>
<tr>
<td>0x1c</td>
<td>sub32 dst, src</td>
<td>dst -= src</td>
</tr>
<tr>
<td>0x24</td>
<td>mul32 dst, imm</td>
<td>dst *= imm</td>
</tr>
<tr>
<td>0x2c</td>
<td>mul32 dst, src</td>
<td>dst *= src</td>
</tr>
<tr>
<td>0x34</td>
<td>div32 dst, imm</td>
<td>dst /= imm</td>
</tr>
<tr>
<td>0x3c</td>
<td>div32 dst, src</td>
<td>dst /= src</td>
</tr>
<tr>
<td>0x44</td>
<td>or32 dst, imm</td>
<td>dst |= imm</td>
</tr>
<tr>
<td>0x4c</td>
<td>or32 dst, src</td>
<td>dst |= src</td>
</tr>
<tr>
<td>0x54</td>
<td>and32 dst, imm</td>
<td>dst &amp;= imm</td>
</tr>
<tr>
<td>0x5c</td>
<td>and32 dst, src</td>
<td>dst &amp;= src</td>
</tr>
<tr>
<td>0x64</td>
<td>lsh32 dst, imm</td>
<td>dst &lt;&lt;= imm</td>
</tr>
<tr>
<td>0x6c</td>
<td>lsh32 dst, src</td>
<td>dst &lt;&lt;= src</td>
</tr>
<tr>
<td>0x74</td>
<td>rsh32 dst, imm</td>
<td>dst &gt;&gt;= imm (logical)</td>
</tr>
<tr>
<td>0x7c</td>
<td>rsh32 dst, src</td>
<td>dst &gt;&gt;= src (logical)</td>
</tr>
<tr>
<td>0x84</td>
<td>neg32 dst</td>
<td>dst = -dst</td>
</tr>
<tr>
<td>0x94</td>
<td>mod32 dst, imm</td>
<td>dst %= imm</td>
</tr>
<tr>
<td>0x9c</td>
<td>mod32 dst, src</td>
<td>dst %= src</td>
</tr>
<tr>
<td>0xa4</td>
<td>xor32 dst, imm</td>
<td>dst ^= imm</td>
</tr>
<tr>
<td>0xac</td>
<td>xor32 dst, src</td>
<td>dst ^= src</td>
</tr>
<tr>
<td>0xb4</td>
<td>mov32 dst, imm</td>
<td>dst = imm</td>
</tr>
<tr>
<td>0xbc</td>
<td>mov32 dst, src</td>
<td>dst = src</td>
</tr>
<tr>
<td>0xc4</td>
<td>arsh32 dst, imm</td>
<td>dst &gt;&gt;= imm (arithmetic)</td>
</tr>
<tr>
<td>0xcc</td>
<td>arsh32 dst, src</td>
<td>dst &gt;&gt;= src (arithmetic)</td>
</tr>
</tbody></table>
<p>Byteswap instructions</p>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Mnemonic</th>
<th>Pseudocode</th>
</tr>
</thead>
<tbody><tr>
<td>0xd4 (imm == 16)</td>
<td>le16 dst</td>
<td>dst = htole16(dst)</td>
</tr>
<tr>
<td>0xd4 (imm == 32)</td>
<td>le32 dst</td>
<td>dst = htole32(dst)</td>
</tr>
<tr>
<td>0xd4 (imm == 64)</td>
<td>le64 dst</td>
<td>dst = htole64(dst)</td>
</tr>
<tr>
<td>0xdc (imm == 16)</td>
<td>be16 dst</td>
<td>dst = htobe16(dst)</td>
</tr>
<tr>
<td>0xdc (imm == 32)</td>
<td>be32 dst</td>
<td>dst = htobe32(dst)</td>
</tr>
<tr>
<td>0xdc (imm == 64)</td>
<td>be64 dst</td>
<td>dst = htobe64(dst)</td>
</tr>
</tbody></table>
<p>Memory Instructions</p>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Mnemonic</th>
<th>Pseudocode</th>
</tr>
</thead>
<tbody><tr>
<td>0x18</td>
<td>lddw dst, imm</td>
<td>dst = imm</td>
</tr>
<tr>
<td>0x20</td>
<td>ldabsw src, dst, imm</td>
<td>See kernel documentation</td>
</tr>
<tr>
<td>0x28</td>
<td>ldabsh src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x30</td>
<td>ldabsb src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x38</td>
<td>ldabsdw src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x40</td>
<td>ldindw src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x48</td>
<td>ldindh src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x50</td>
<td>ldindb src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x58</td>
<td>ldinddw src, dst, imm</td>
<td>…</td>
</tr>
<tr>
<td>0x61</td>
<td>ldxw dst, [src+off]</td>
<td>dst = *(uint32_t *) (src + off)</td>
</tr>
<tr>
<td>0x69</td>
<td>ldxh dst, [src+off]</td>
<td>dst = *(uint16_t *) (src + off)</td>
</tr>
<tr>
<td>0x71</td>
<td>ldxb dst, [src+off]</td>
<td>dst = *(uint8_t *) (src + off)</td>
</tr>
<tr>
<td>0x79</td>
<td>ldxdw dst, [src+off]</td>
<td>dst = *(uint64_t *) (src + off)</td>
</tr>
<tr>
<td>0x62</td>
<td>stw [dst+off], imm</td>
<td>*(uint32_t *) (dst + off) = imm</td>
</tr>
<tr>
<td>0x6a</td>
<td>sth [dst+off], imm</td>
<td>*(uint16_t *) (dst + off) = imm</td>
</tr>
<tr>
<td>0x72</td>
<td>stb [dst+off], imm</td>
<td>*(uint8_t *) (dst + off) = imm</td>
</tr>
<tr>
<td>0x7a</td>
<td>stdw [dst+off], imm</td>
<td>*(uint64_t *) (dst + off) = imm</td>
</tr>
<tr>
<td>0x63</td>
<td>stxw [dst+off], src</td>
<td>*(uint32_t *) (dst + off) = src</td>
</tr>
<tr>
<td>0x6b</td>
<td>stxh [dst+off], src</td>
<td>*(uint16_t *) (dst + off) = src</td>
</tr>
<tr>
<td>0x73</td>
<td>stxb [dst+off], src</td>
<td>*(uint8_t *) (dst + off) = src</td>
</tr>
<tr>
<td>0x7b</td>
<td>stxdw [dst+off], src</td>
<td>*(uint64_t *) (dst + off) = src</td>
</tr>
</tbody></table>
<p>Branch Instructions</p>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Mnemonic</th>
<th>Pseudocode</th>
</tr>
</thead>
<tbody><tr>
<td>0x05</td>
<td>ja +off</td>
<td>PC += off</td>
</tr>
<tr>
<td>0x15</td>
<td>jeq dst, imm, +off</td>
<td>PC += off if dst == imm</td>
</tr>
<tr>
<td>0x1d</td>
<td>jeq dst, src, +off</td>
<td>PC += off if dst == src</td>
</tr>
<tr>
<td>0x25</td>
<td>jgt dst, imm, +off</td>
<td>PC += off if dst &gt; imm</td>
</tr>
<tr>
<td>0x2d</td>
<td>jgt dst, src, +off</td>
<td>PC += off if dst &gt; src</td>
</tr>
<tr>
<td>0x35</td>
<td>jge dst, imm, +off</td>
<td>PC += off if dst &gt;= imm</td>
</tr>
<tr>
<td>0x3d</td>
<td>jge dst, src, +off</td>
<td>PC += off if dst &gt;= src</td>
</tr>
<tr>
<td>0xa5</td>
<td>jlt dst, imm, +off</td>
<td>PC += off if dst &lt; imm</td>
</tr>
<tr>
<td>0xad</td>
<td>jlt dst, src, +off</td>
<td>PC += off if dst &lt; src</td>
</tr>
<tr>
<td>0xb5</td>
<td>jle dst, imm, +off</td>
<td>PC += off if dst &lt;= imm</td>
</tr>
<tr>
<td>0xbd</td>
<td>jle dst, src, +off</td>
<td>PC += off if dst &lt;= src</td>
</tr>
<tr>
<td>0x45</td>
<td>jset dst, imm, +off</td>
<td>PC += off if dst &amp; imm</td>
</tr>
<tr>
<td>0x4d</td>
<td>jset dst, src, +off</td>
<td>PC += off if dst &amp; src</td>
</tr>
<tr>
<td>0x55</td>
<td>jne dst, imm, +off</td>
<td>PC += off if dst != imm</td>
</tr>
<tr>
<td>0x5d</td>
<td>jne dst, src, +off</td>
<td>PC += off if dst != src</td>
</tr>
<tr>
<td>0x65</td>
<td>jsgt dst, imm, +off</td>
<td>PC += off if dst &gt; imm (signed)</td>
</tr>
<tr>
<td>0x6d</td>
<td>jsgt dst, src, +off</td>
<td>PC += off if dst &gt; src (signed)</td>
</tr>
<tr>
<td>0x75</td>
<td>jsge dst, imm, +off</td>
<td>PC += off if dst &gt;= imm (signed)</td>
</tr>
<tr>
<td>0x7d</td>
<td>jsge dst, src, +off</td>
<td>PC += off if dst &gt;= src (signed)</td>
</tr>
<tr>
<td>0xc5</td>
<td>jslt dst, imm, +off</td>
<td>PC += off if dst &lt; imm (signed)</td>
</tr>
<tr>
<td>0xcd</td>
<td>jslt dst, src, +off</td>
<td>PC += off if dst &lt; src (signed)</td>
</tr>
<tr>
<td>0xd5</td>
<td>jsle dst, imm, +off</td>
<td>PC += off if dst &lt;= imm (signed)</td>
</tr>
<tr>
<td>0xdd</td>
<td>jsle dst, src, +off</td>
<td>PC += off if dst &lt;= src (signed)</td>
</tr>
<tr>
<td>0x85</td>
<td>call imm</td>
<td>Function call</td>
</tr>
<tr>
<td>0x95</td>
<td>exit</td>
<td>return r0</td>
</tr>
</tbody></table>
<ul>
<li><p>相同的方式，文件 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/linux/filter.h" target="_blank" rel="noopener">linux/include/linux/filter.h</a>和 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/filter.h" target="_blank" rel="noopener">linux/include/uapi/filter.h</a>包含了用于 <strong>运行 BPF 程序</strong> 的信息。</p>
<p><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/include/linux/filter.h" target="_blank" rel="noopener">linux/include/linux/filter.h</a> 内核run bpf程序</p>
</li>
<li><p>Bpf_prog_run宏:</p>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> __BPF_PROG_RUN(prog, ctx, dfunc)        ({                        \
        u32 __ret;                                                        \
        cant_migrate();                                                        \
        if (static_branch_unlikely(&amp;bpf_stats_enabled_key)) {                \
                struct bpf_prog_stats *__stats;                                \
                u64 __start = sched_clock();                                \
                __ret = dfunc(ctx, (prog)->insnsi, (prog)->bpf_func);        \
                __stats = this_cpu_ptr(prog->stats);                        \
                u64_stats_update_begin(&amp;__stats->syncp);                \
                __stats->cnt++;                                                \
                __stats->nsecs += sched_clock() - __start;                \
                u64_stats_update_end(&amp;__stats->syncp);                        \
        } else {                                                        \
                __ret = dfunc(ctx, (prog)->insnsi, (prog)->bpf_func);        \
        }                                                                \
        __ret; })</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BPF_PROG_RUN(prog, ctx)                                                \
        __BPF_PROG_RUN(prog, ctx, bpf_dispatcher_nop_func)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>BPF 相关的 <strong>主要的代码片断</strong> 在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf" target="_blank" rel="noopener">linux/kernel/bpf/</a>目录下面。<strong>系统调用的不同操作许可</strong>，比如，程序加载或者映射管理是在文件 <code>syscall.c</code> 中实现，而 <code>core.c</code> 包含了 <strong>解析器</strong>。其它文件的命名显而易见：<code>verifier.c</code> 包含 <strong>校验器</strong>，<code>arraymap.c</code> 的代码用于与数组类型的 <strong>映射</strong> 交互，等等。</li>
</ul>
<p><code>syscall.c</code>：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bpf_prog_load</span><span class="token punctuation">(</span><span class="token keyword">union</span> bpf_attr <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">union</span> bpf_attr __user <span class="token operator">*</span>uattr<span class="token punctuation">)</span>
<span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>bpf<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token keyword">union</span> bpf_attr __user <span class="token operator">*</span><span class="token punctuation">,</span> uattr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><p>有几个与网络（及 tc、XDP ）相关的函数和 <strong>helpers</strong> 是用户可用，其实现在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/filter.c" target="_blank" rel="noopener">linux/net/core/filter.c</a>中。它也包含了移植 cBPF 字节码到 eBPF 的代码（因为在运行之前，内核中的所有的 cBPF 程序被转换成 eBPF）。</p>
</li>
<li><p>相关于 <strong>事件跟踪</strong> 的函数和 <strong>helpers</strong> 都在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/trace/bpf_trace.c" target="_blank" rel="noopener">linux/kernel/trace/bpf_trace.c</a> 中。</p>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/**
 * trace_call_bpf - invoke BPF program
 * @call: tracepoint event
 * @ctx: opaque context pointer
 *
 * kprobe handlers execute BPF programs via this helper.
 * Can be used from static tracepoints in the future.
 *
 * Return: BPF programs always return an integer which is interpreted by
 * kprobe handler as:
 * 0 - return from kprobe (event is filtered out)
 * 1 - store kprobe event into ring buffer
 * Other values are reserved and currently alias to 1
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">trace_call_bpf</span><span class="token punctuation">(</span><span class="token keyword">struct</span> trace_event_call <span class="token operator">*</span>call<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token function">cant_sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">__this_cpu_inc_return</span><span class="token punctuation">(</span>bpf_prog_active<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/*
                 * since some bpf program is already running on this cpu,
                 * don't call into another bpf program (same or different)
                 * and don't send kprobe event into ring-buffer,
                 * so return zero here
                 */</span>
                ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * Instead of moving rcu_read_lock/rcu_dereference/rcu_read_unlock
         * to all call sites, we did a bpf_prog_array_valid() there to check
         * whether call->prog_array is empty or not, which is
         * a heuristic to speed up execution.
         *
         * If bpf_prog_array_valid() fetched prog_array was
         * non-NULL, we go into trace_call_bpf() and do the actual
         * proper rcu_dereference() under RCU lock.
         * If it turns out that prog_array is NULL then, we bail out.
         * For the opposite, if the bpf_prog_array_valid() fetched pointer
         * was NULL, you'll skip the prog_array with the risk of missing
         * out of events when it was updated in between this and the
         * rcu_dereference() which is accepted risk.
         */</span>
        ret <span class="token operator">=</span> <span class="token function">BPF_PROG_RUN_ARRAY_CHECK</span><span class="token punctuation">(</span>call<span class="token operator">-></span>prog_array<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> BPF_PROG_RUN<span class="token punctuation">)</span><span class="token punctuation">;</span>

 out<span class="token punctuation">:</span>
        <span class="token function">__this_cpu_dec</span><span class="token punctuation">(</span>bpf_prog_active<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bpf_tracing_func_proto</span><span class="token punctuation">(</span><span class="token keyword">enum</span> bpf_func_id func_id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> bpf_prog <span class="token operator">*</span>prog<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p><strong>JIT 编译器</strong> 在它们各自的架构目录下面，比如，x86 架构的在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/arch/x86/net/bpf_jit_comp.c" target="_blank" rel="noopener">linux/arch/x86/net/bpf</a><em><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/arch/x86/net/bpf_jit_comp.c" target="_blank" rel="noopener">jit</a></em><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/arch/x86/net/bpf_jit_comp.c" target="_blank" rel="noopener">comp.c</a>中。例外是用于硬件卸载的 JIT 编译器，它们放在它们的驱动程序下，例如 Netronome NFP 网卡的就放在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/ethernet/netronome/nfp/bpf/jit.c" target="_blank" rel="noopener">linux/drivers/net/ethernet/netronome/nfp/bpf/jit.c</a> 。</p>
</li>
<li><p>在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/sched" target="_blank" rel="noopener">linux/net/sched/</a>目录下，你可以找到 <strong>tc 的 BPF 组件</strong> 相关的代码，尤其是在文件 <code>act_bpf.c</code> （action）和 <code>cls_bpf.c</code>（filter）中。</p>
</li>
<li><p>我并没有在 BPF 上深入到 <strong>事件跟踪</strong> 中，因此，我并不真正了解这些程序的钩子。在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/trace/bpf_trace.c" target="_blank" rel="noopener">linux/kernel/trace/bpf_trace.c</a>那里有一些东西。如果你对它感兴趣，并且想去了解更多，你可以在 Brendan Gregg 的演示或者博客文章上去深入挖掘。</p>
</li>
<li><p>我也没有使用过 <strong>seccomp-BPF</strong>，不过你能在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/seccomp.c" target="_blank" rel="noopener">linux/kernel/seccomp.c</a>找到它的代码，并且可以在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/seccomp/seccomp_bpf.c" target="_blank" rel="noopener">linux/tools/testing/selftests/seccomp/seccomp_bpf.c</a>中找到一些它的使用示例。</p>
</li>
</ul>
<h4 id="XDP-钩子代码"><a href="#XDP-钩子代码" class="headerlink" title="XDP 钩子代码"></a>XDP 钩子代码</h4><p>一旦装载进内核的 BPF 虚拟机，由一个 Netlink 命令将 <strong>XDP</strong> 程序从用户空间钩入到内核网络路径中。接收它的是在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/net/core/dev.c" target="_blank" rel="noopener">linux/net/core/dev.c</a> 文件中的 <code>dev_change_xdp_fd()</code> 函数，它被调用并设置一个 XDP 钩子。钩子被放在支持的网卡的驱动程序中。例如，用于 Netronome 硬件钩子的 ntp 驱动程序实现放在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/ethernet/netronome/nfp/" target="_blank" rel="noopener">drivers/net/ethernet/netronome/nfp/</a> 中。文件 <code>nfp_net_common.c</code> 接受 Netlink 命令，并调用 <code>nfp_net_xdp_setup()</code>，它会转而调用 <code>nfp_net_xdp_setup_drv()</code> 实例来安装该程序。</p>
<h4 id="在-bcc-中的-BPF-逻辑"><a href="#在-bcc-中的-BPF-逻辑" class="headerlink" title="在 bcc 中的 BPF 逻辑"></a>在 bcc 中的 BPF 逻辑</h4><p><a href="https://github.com/iovisor/bcc/" target="_blank" rel="noopener">在 bcc 的 GitHub 仓库</a>能找到的 <strong>bcc</strong> 工具集的代码。其 <strong>Python 代码</strong>，包含在 <code>BPF</code> 类中，最初它在文件 <a href="https://github.com/iovisor/bcc/blob/master/src/python/bcc/__init__.py" target="_blank" rel="noopener">bcc/src/python/bcc/<strong>init</strong>.py</a> 中。但是许多我觉得有意思的东西，比如，加载 BPF 程序到内核中，出现在 <a href="https://github.com/iovisor/bcc/blob/master/src/cc/libbpf.c" target="_blank" rel="noopener">libbcc 的 C 库</a>中。</p>
<h4 id="使用-tc-去管理-BPF-的代码"><a href="#使用-tc-去管理-BPF-的代码" class="headerlink" title="使用 tc 去管理 BPF 的代码"></a>使用 tc 去管理 BPF 的代码</h4><p>当然，这些代码与 iproute2 包中的 <strong>tc 中的</strong> BPF 相关。其中的一些在 <a href="https://git.kernel.org/cgit/linux/kernel/git/shemminger/iproute2.git/tree/tc" target="_blank" rel="noopener">iproute2/tc/</a> 目录中。文件 <code>f_bpf.c</code> 和 <code>m_bpf.c</code>（和 <code>e_bpf.c</code>）各自用于处理 BPF 的过滤器和动作的（和 tc <code>exec</code> 命令，等等）。文件 <code>q_clsact.c</code> 定义了为 BPF 特别创建的 <code>clsact</code> qdisc。但是，<strong>大多数的 BPF 用户空间逻辑</strong> 是在 <a href="https://git.kernel.org/cgit/linux/kernel/git/shemminger/iproute2.git/tree/lib/bpf.c" target="_blank" rel="noopener">iproute2/lib/bpf.c</a>库中实现的，因此，如果你想去使用 BPF 和 tc，这里可能是会将你搞混乱的地方（它是从文件 iproute2/tc/tc_bpf.c 中移动而来的，你也可以在旧版本的包中找到相同的代码）。</p>
<h4 id="BPF-实用工具"><a href="#BPF-实用工具" class="headerlink" title="BPF 实用工具"></a>BPF 实用工具</h4><p>内核中也带有 BPF 相关的三个工具的源代码（<code>bpf_asm.c</code>、 <code>bpf_dbg.c</code>、 <code>bpf_jit_disasm.c</code>），根据你的版本不同，在 <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/tools/net" target="_blank" rel="noopener">linux/tools/net/</a>（直到 Linux 4.14）或者 <a href="https://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git/tree/tools/bpf" target="_blank" rel="noopener">linux/tools/bpf/</a>目录下面：</p>
<ul>
<li><p><code>bpf_asm</code> 是一个极小的 cBPF 汇编程序。</p>
</li>
<li><p><code>bpf_dbg</code> 是一个很小的 cBPF 程序调试器。</p>
</li>
<li><p><code>bpf_jit_disasm</code> 对于两种 BPF 都是通用的，并且对于 JIT 调试来说非常有用。</p>
</li>
<li><p><code>bpftool</code> 是由 Jakub Kicinski 写的通用工具，它可以与 eBPF 程序交互并从用户空间的映射，例如，去展示、转储、pin 程序、或者去展示、创建、pin、更新、删除映射。</p>
</li>
</ul>
<p>阅读在源文件顶部的注释可以得到一个它们使用方法的概述。</p>
<p>与 eBPF 一起工作的其它必需的文件是来自内核树的两个<strong>用户空间库</strong>，它们可以用于管理 eBPF 程序或者映射来自外部的程序。这个函数可以通过 <a href="https://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git/tree/tools/lib/bpf" target="_blank" rel="noopener">linux/tools/lib/bpf/</a> 目录中的头文件 <code>bpf.h</code> 和 <code>libbpf.h</code>（更高层面封装）来访问。比如，工具 <code>bpftool</code> 主要依赖这些库。</p>
<h4 id="eBPF程序类型"><a href="#eBPF程序类型" class="headerlink" title="eBPF程序类型"></a>eBPF程序类型</h4><p>加载BPF_PROG_LOAD的程序的类型决定了四件事：可以在何处附加程序，可以调用验证程序的内核内辅助函数，是否可以直接访问网络数据包数据，以及作为第一个传递的对象的类型该程序的参数。实际上，程序类型本质上定义了一个API。甚至纯粹是创建新程序类型来区分允许的可调用函数的不同列表（例如，BPF_PROG_TYPE_CGROUP_SKB与 BPF_PROG_TYPE_SOCKET_FILTER）。</p>
<p>内核支持的当前eBPF程序类型集为：</p>
<ul>
<li><p>BPF_PROG_TYPE_SOCKET_FILTER：网络数据包过滤器</p>
</li>
<li><p>BPF_PROG_TYPE_KPROBE：确定是否应触发kprobe</p>
</li>
<li><p>BPF_PROG_TYPE_SCHED_CLS：网络流量控制分类器</p>
</li>
<li><p>BPF_PROG_TYPE_SCHED_ACT：网络流量控制操作</p>
</li>
<li><p>BPF_PROG_TYPE_TRACEPOINT：确定是否应触发跟踪点</p>
</li>
<li><p>BPF_PROG_TYPE_XDP：从设备驱动程序接收路径运行的网络数据包筛选器</p>
</li>
<li><p>BPF_PROG_TYPE_PERF_EVENT：确定是否应该触发性能事件处理程序</p>
</li>
<li><p>BPF_PROG_TYPE_CGROUP_SKB：用于控制组的网络数据包过滤器</p>
</li>
<li><p>BPF_PROG_TYPE_CGROUP_SOCK：用于控制组的网络数据包筛选器，允许修改套接字选项</p>
</li>
<li><p>BPF_PROG_TYPE_LWT_ *：用于轻型隧道的网络数据包过滤器</p>
</li>
<li><p>BPF_PROG_TYPE_SOCK_OPS：用于设置套接字参数的程序</p>
</li>
<li><p>BPF_PROG_TYPE_SK_SKB：网络数据包过滤器，用于在套接字之间转发数据包</p>
</li>
<li><p>BPF_PROG_CGROUP_DEVICE：确定是否应该允许设备操作</p>
</li>
</ul>
<p>随着添加了新的程序类型，内核开发人员也发现也需要添加新的数据结构。</p>
<h4 id="eBPF数据结构"><a href="#eBPF数据结构" class="headerlink" title="eBPF数据结构"></a>eBPF数据结构</h4><p>eBPF程序使用的主要数据结构是eBPF映射，eBPF映射是一种通用数据结构，它允许在内核内或内核与用户空间之间来回传递数据。顾名思义，“map”使用键存储和检索数据。</p>
<p>使用bpf（）系统调用创建和处理map。成功创建映射后，将返回与该映射关联的文件描述符。通常，通过关闭关联的文件描述符来销毁map。每个映射由四个值定义：类型，最大元素数，值大小（以字节为单位）和键大小（以字节为单位）。有不同的map类型，每种map类型提供不同的行为和权衡方案：</p>
<ul>
<li><p>BPF_MAP_TYPE_HASH：哈希表</p>
</li>
<li><p>BPF_MAP_TYPE_ARRAY：数组映射，已针对快速查找速度进行了优化，通常用于计数器</p>
</li>
<li><p>BPF_MAP_TYPE_PROG_ARRAY：对应于eBPF程序的文件描述符数组；用于实现跳转表和子程序以处理特定的数据包协议</p>
</li>
<li><p>BPF_MAP_TYPE_PERCPU_ARRAY：每个CPU的阵列，用于实现延迟的直方图</p>
</li>
<li><p>BPF_MAP_TYPE_PERF_EVENT_ARRAY：存储指向struct perf_event的指针，用于读取和存储perf事件计数器</p>
</li>
<li><p>BPF_MAP_TYPE_CGROUP_ARRAY：存储指向控制组的指针</p>
</li>
<li><p>BPF_MAP_TYPE_PERCPU_HASH：每个CPU的哈希表</p>
</li>
<li><p>BPF_MAP_TYPE_LRU_HASH：仅保留最近使用项目的哈希表</p>
</li>
<li><p>BPF_MAP_TYPE_LRU_PERCPU_HASH：每个CPU的哈希表，仅保留最近使用的项目</p>
</li>
<li><p>BPF_MAP_TYPE_LPM_TRIE：最长前缀匹配树，适用于将IP地址匹配到某个范围</p>
</li>
<li><p>BPF_MAP_TYPE_STACK_TRACE：存储堆栈跟踪</p>
</li>
<li><p>BPF_MAP_TYPE_ARRAY_OF_MAPS：map中map数据结构</p>
</li>
<li><p>BPF_MAP_TYPE_HASH_OF_MAPS：map中map数据结构</p>
</li>
<li><p>BPF_MAP_TYPE_DEVICE_MAP：用于存储和查找网络设备引用</p>
</li>
<li><p>BPF_MAP_TYPE_SOCKET_MAP：存储和查找套接字，并允许使用BPF帮助函数进行套接字重定向</p>
</li>
</ul>
<p>可以使用bpf_map_lookup_elem（）和 bpf_map_update_elem（）函数从eBPF或用户空间程序访问所有map 。某些映射类型（例如套接字映射）可以与执行特殊任务的其他eBPF帮助器功能一起使用。</p>
<h4 id="如何编写eBPF程序"><a href="#如何编写eBPF程序" class="headerlink" title="如何编写eBPF程序"></a>如何编写eBPF程序</h4><p>从历史上看，有必要手动编写eBPF汇编并使用内核的bpf_asm汇编器生成BPF字节码。幸运的是，LLVM Clang编译器已经增加了对eBPF后端的支持，该后端将C编译为字节码。然后可以使用bpf（）系统调用和 BPF_PROG_LOAD命令直接加载包含该字节码的目标文件。</p>
<p>您可以使用-march = bpf参数与Clang一起编译，从而用C编写自己的eBPF程序。内核的<a href="http://elixir.free-electrons.com/linux/v4.14.2/source/samples/bpf" target="_blank" rel="noopener">samples / bpf /</a> 目录中有许多eBPF程序示例；大多数文件名的后缀为“ _kern.c ”。Clang发出的目标文件（eBPF字节码）需要由计算机上本地运行的程序加载（这些示例的文件名通常带有“ _user.c ”）。为了使编写eBPF程序更容易，内核提供了libbpf库，该库包括用于加载程序以及创建和操作eBPF对象的帮助程序函数。例如，使用libbpf的eBPF程序和用户程序的高级流程 可能会像这样：</p>
<ul>
<li><p>将eBPF字节码读取到用户应用程序的缓冲区中，并将其传递给bpf_load_program（）。</p>
</li>
<li><p>eBPF程序在由内核运行时，将调用 bpf_map_lookup_elem（）在地图中查找元素并将其存储新值。</p>
</li>
<li><p>用户应用程序调用bpf_map_lookup_elem（）来读取eBPF程序存储在内核中的值。</p>
</li>
</ul>
<p>但是，所有示例代码都有一个主要缺点：您需要从内核源代码树中编译eBPF程序。幸运的是，创建了BCC项目来解决此问题。它包括一个完整的工具链，用于编写eBPF程序并加载它们，而无需链接内核源代码树。</p>
<h2 id="《BPF内核观测技术》笔录"><a href="#《BPF内核观测技术》笔录" class="headerlink" title="《BPF内核观测技术》笔录"></a>《BPF内核观测技术》笔录</h2><h3 id="BPF跟踪"><a href="#BPF跟踪" class="headerlink" title="BPF跟踪"></a>BPF跟踪</h3><h4 id="探针"><a href="#探针" class="headerlink" title="探针"></a>探针</h4><p>内核探针：提供内核中内部组件的动态访问</p>
<p>跟踪点：提供内核中内部组件的静态访问</p>
<p>用户空间探针：提供用户空间运行的程序的动态访问</p>
<p>用户静态定义跟踪点：提供用户空间运行的程序的静态访问</p>
<h5 id="内核探针"><a href="#内核探针" class="headerlink" title="内核探针"></a>内核探针</h5><p>kprobes–允许执行任何内核指令之前插入BPF程序</p>
<p>kretprobes–在内核指令有返回值时插入BPF程序</p>
<p>kprobes 探针在内核函数入口被调用，示例程序如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF 

bpf_source <span class="token operator">=</span> <span class="token triple-quoted-string string">""" 
#include &lt;uapi/linux/ptrace.h>                                                                                                                                               

int do_sys_execve(struct pt_regs *ctx) {
  char comm[16];
  bpf_get_current_comm(&amp;comm, sizeof(comm));
  bpf_trace_printk("executing program: %s\\n", comm);
  return 0;
}
"""</span>

bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>bpf_source<span class="token punctuation">)</span>
execve_function <span class="token operator">=</span> bpf<span class="token punctuation">.</span>get_syscall_fnname<span class="token punctuation">(</span><span class="token string">"execve"</span><span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>attach_kprobe<span class="token punctuation">(</span>event<span class="token operator">=</span>execve_function<span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"do_sys_execve"</span><span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>trace_print<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">[</span>longyu@debian<span class="token number">-10</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">]</span> kprobes $ sudo python example<span class="token punctuation">.</span>py 
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> longyu 的密码：
           guake<span class="token number">-21900</span> <span class="token punctuation">[</span><span class="token number">003</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19913.271490</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> executing program<span class="token punctuation">:</span> guake
           guake<span class="token number">-21901</span> <span class="token punctuation">[</span><span class="token number">001</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19913.273462</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> executing program<span class="token punctuation">:</span> guake
            bash<span class="token number">-21902</span> <span class="token punctuation">[</span><span class="token number">000</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19913.274109</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> executing program<span class="token punctuation">:</span> bash
            bash<span class="token number">-21903</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19913.277194</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> executing program<span class="token punctuation">:</span> bash
            bash<span class="token number">-21906</span> <span class="token punctuation">[</span><span class="token number">002</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19913.279022</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> executing <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>kretprobes 探测点在内核函数返回的时候被调用，示例程序如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> bcc <span class="token keyword">import</span> BPF

bpf_source <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
#include &lt;uapi/linux/ptrace.h>

int ret_sys_execve(struct pt_regs *ctx) {
  int return_value;
  char comm[16];
  bpf_get_current_comm(&amp;comm, sizeof(comm));
  return_value = PT_REGS_RC(ctx);

  bpf_trace_printk("program: %s, return: %d\\n", comm, return_value);
  return 0;
}
"""</span>

bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text<span class="token operator">=</span>bpf_source<span class="token punctuation">)</span>
execve_function <span class="token operator">=</span> bpf<span class="token punctuation">.</span>get_syscall_fnname<span class="token punctuation">(</span><span class="token string">"execve"</span><span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>attach_kretprobe<span class="token punctuation">(</span>event<span class="token operator">=</span>execve_function<span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">"ret_sys_execve"</span><span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>trace_print<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>longyu@debian<span class="token number">-10</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">35</span><span class="token punctuation">]</span> kretprobes $ sudo python example<span class="token punctuation">.</span>py 
            bash<span class="token number">-22471</span> <span class="token punctuation">[</span><span class="token number">007</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.730870</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> bash<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span>
              id<span class="token number">-22472</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.732045</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> id<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span>
        utempter<span class="token number">-22473</span> <span class="token punctuation">[</span><span class="token number">004</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.732546</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> utempter<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span>
       dircolors<span class="token number">-22474</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.733757</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> dircolors<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span>
       dircolors<span class="token number">-22475</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.735221</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> dircolors<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span>
             lua<span class="token number">-22476</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> d<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20099.736689</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> program<span class="token punctuation">:</span> lua<span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">:</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="跟踪点"><a href="#跟踪点" class="headerlink" title="跟踪点"></a>跟踪点</h5><p>tracepoints 跟踪点是内核代码的静态标记，用于将代码附加到运行内核中，它由内核开发人员在内核中编写与修改，内核探针与跟踪点都提供了在用户空间的完全访问</p>
<p>查看 <strong>/sys/kernel/debug/tracing/events</strong> 目录下的内容可以获取系统中所有可用的跟踪点。</p>
<h5 id="用户空间探针"><a href="#用户空间探针" class="headerlink" title="用户空间探针"></a>用户空间探针</h5><p>uprobes–内核在程序特定指令执行之前插入该指令集的钩子</p>
<p>uretprobes–与kretprobes并行探针，适用于用户空间使用，在将bpf程序附加到指令返回值之上，允许通过bpf代码从寄存器中访问返回值</p>
<p>一个示例 patch 内容如下：</p>
<pre class="line-numbers language-python"><code class="language-python">diff <span class="token operator">-</span><span class="token operator">-</span>git a<span class="token operator">/</span>code<span class="token operator">/</span>chapter<span class="token number">-4</span><span class="token operator">/</span>uprobes<span class="token operator">/</span>example<span class="token punctuation">.</span>py b<span class="token operator">/</span>code<span class="token operator">/</span>chapter<span class="token number">-4</span><span class="token operator">/</span>uprobes<span class="token operator">/</span>example<span class="token punctuation">.</span>py
old mode <span class="token number">100644</span>
new mode <span class="token number">100755</span>
index <span class="token number">4f2c76f</span><span class="token punctuation">.</span><span class="token punctuation">.</span>c0a93de
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> a<span class="token operator">/</span>code<span class="token operator">/</span>chapter<span class="token number">-4</span><span class="token operator">/</span>uprobes<span class="token operator">/</span>example<span class="token punctuation">.</span>py
<span class="token operator">+</span><span class="token operator">+</span><span class="token operator">+</span> b<span class="token operator">/</span>code<span class="token operator">/</span>chapter<span class="token number">-4</span><span class="token operator">/</span>uprobes<span class="token operator">/</span>example<span class="token punctuation">.</span>py
@@ <span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span> @@ int trace_go_main<span class="token punctuation">(</span>struct pt_regs <span class="token operator">*</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token string">""</span>"

 bpf <span class="token operator">=</span> BPF<span class="token punctuation">(</span>text <span class="token operator">=</span> bpf_source<span class="token punctuation">)</span>
<span class="token operator">-</span>bpf<span class="token punctuation">.</span>attach_uprobe<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"hello-bpf"</span><span class="token punctuation">,</span> sym <span class="token operator">=</span> <span class="token string">"main.main"</span><span class="token punctuation">,</span> fn_name <span class="token operator">=</span> <span class="token string">"trace_go_main"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>bpf<span class="token punctuation">.</span>attach_uprobe<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"/home/longyu/linux-observability-with-bpf/code/chapter-4/uprobes/hello-bpf"</span><span class="token punctuation">,</span> sym <span class="token operator">=</span> <span class="token string">"main.main"</span><span class="token punctuation">,</span> fn_name <span class="token operator">=</span> <span class="token string">"trace_go_main"</span><span class="token punctuation">)</span>
 bpf<span class="token punctuation">.</span>trace_print<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>longyu@debian<span class="token number">-10</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">]</span> uprobes $ sudo python <span class="token punctuation">.</span><span class="token operator">/</span>example<span class="token punctuation">.</span>py 
       hello<span class="token operator">-</span>bpf<span class="token number">-25911</span> <span class="token punctuation">[</span><span class="token number">005</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">22341.336969</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> New hello<span class="token operator">-</span>bpf process running <span class="token keyword">with</span> PID<span class="token punctuation">:</span> <span class="token number">25911</span>
       hello<span class="token operator">-</span>bpf<span class="token number">-25927</span> <span class="token punctuation">[</span><span class="token number">001</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">22354.651541</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">:</span> New hello<span class="token operator">-</span>bpf process running <span class="token keyword">with</span> PID<span class="token punctuation">:</span> <span class="token number">25927</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="用户静态定义跟踪点"><a href="#用户静态定义跟踪点" class="headerlink" title="用户静态定义跟踪点"></a>用户静态定义跟踪点</h5><p>USDT为用户应用程序提供静态跟踪点，是检测应用程序的便捷方法</p>
<p>USDT 是用户态程序静态定义的跟踪点，类似于内核中的 tracepoint，它需要在程序的源代码中添加代码</p>
<p>示例 demo 源码如下：</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#include &lt;sys/sdt.h></span>

int main<span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char const <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DTRACE_PROBE<span class="token punctuation">(</span><span class="token string">"hello-usdt"</span><span class="token punctuation">,</span> <span class="token string">"probe-main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接编译，发现会报 sys/sdt.h 头文件不存在的问题。可以通过执行如下命令来解决：</p>
<pre><code>sudo apt-get install systemtap-sdt-dev</code></pre><p>修改 example.py 后执行有如下信息：</p>
<pre><code>[longyu@debian-10:18:36:53] usdt $ sudo python example.py 
/virtual/main.c:7:1: warning: control reaches end of non-void function [-Wreturn-type]
}
^
1 warning generated. </code></pre><h4 id="跟踪数据可视化"><a href="#跟踪数据可视化" class="headerlink" title="跟踪数据可视化"></a>跟踪数据可视化</h4><h5 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h5><p>对系统耗时进行可视化的图表</p>
<h5 id="直方图"><a href="#直方图" class="headerlink" title="直方图"></a>直方图</h5><h5 id="Perf事件"><a href="#Perf事件" class="headerlink" title="Perf事件"></a>Perf事件</h5><p>Perf事件的数组映射，允许将数据放入环形缓存区，以便实现用户空间实时同步</p>
<h3 id="BPF运行时的体系架构"><a href="#BPF运行时的体系架构" class="headerlink" title="BPF运行时的体系架构"></a>BPF运行时的体系架构</h3><p><img src="/images/loading.gif" data-original="../images/basic/-1627232750432996" alt=""></p>
<h3 id="BPF-API"><a href="#BPF-API" class="headerlink" title="BPF API"></a>BPF API</h3><p>include/uapi/linux/bpf.h</p>
<h4 id="Some-Graph"><a href="#Some-Graph" class="headerlink" title="Some Graph"></a>Some Graph</h4><h5 id="BPF-helper-function："><a href="#BPF-helper-function：" class="headerlink" title="BPF helper function："></a>BPF helper function：</h5><p><img src="/images/loading.gif" data-original="../images/basic/-1627232783797998" alt=""></p>
<h5 id="BPF-Syscall"><a href="#BPF-Syscall" class="headerlink" title="BPF Syscall"></a>BPF Syscall</h5><p><img src="/images/loading.gif" data-original="../images/basic/-16272328148591000" alt=""></p>
<p>BPF tracing program types</p>
<p><img src="/images/loading.gif" data-original="../images/basic/-16272328327081002" alt=""></p>
<p>注：BPF Type Format (BTF)</p>
<h2 id="EBPF程序运行流程案例分析"><a href="#EBPF程序运行流程案例分析" class="headerlink" title="EBPF程序运行流程案例分析"></a>EBPF程序运行流程案例分析</h2><h3 id="EBPF程序运行"><a href="#EBPF程序运行" class="headerlink" title="EBPF程序运行"></a>EBPF程序运行</h3><p>eBPF 在 Linux 内核中将 C 代码编译成 BPF 字节码，挂在 <code>kprobe/tracepoint</code> 等 hook 上，当 <code>hook</code> 触发时，Linux 内核运行字节码来追踪性能。</p>
<h3 id="EBPF框架"><a href="#EBPF框架" class="headerlink" title="EBPF框架"></a>EBPF框架</h3><p>在 Linux 内核中的 <code>sample/bpf</code> 目录存在许多 bpf 程序的样例，以 <code>tracex4_kern.c</code> 和 <code>tracex4_user.c</code> 为例。</p>
<p>下图是 eBPF 程序的框架，分为程序执行流和数据通信流。</p>
<p><img src="/images/loading.gif" data-original="../images/basic/-16272328471171004" alt=""></p>
<p>对于程序执行流来说，</p>
<ul>
<li><p><code>trace_kern.c</code> 是分配 slab，释放 slab 时调用的代码，其中申明了 hook 处理函数和数据 map，数据 map 用于内核态和用户态之间的数据通信，使用 LLVM/clang 编译器编译成 bpf 字节码</p>
</li>
<li><p><code>trace_user.c</code> 用来加载 bpf 字节码，陷入内核态，通过 JIT(just in time) 编译器将 bpf 字节码转换成机器汇编码，当 kprobe 或 tracepoint 追踪到某类事件时执行上述申明的 hook 处理函数并获取数据 map，将数据传到 userspace</p>
</li>
</ul>
<h4 id="tracex4-kern-c"><a href="#tracex4-kern-c" class="headerlink" title="tracex4_kern.c"></a>tracex4_kern.c</h4><p>其中定义了 “my_map” 的一个数据 map，数据 map 由 <code>key/value</code> 键值对组成，这里的 value 是一个结构体的变量，用于获得当前运行时间和 ip 寄存器，数据 map 由<code>__attribute__</code> 声明，是一个单独的 section，编译成 ELF 格式的文件时该结构体变量存在 “maps” 段中。</p>
<p>接下来申明的是分配 slab（内存分配），释放 slab 的钩子处理函数，并单独放在 <code>kprobe/kmem_cache_free</code>，<code>kretprobe/kmem_cache_alloc_node</code> 两个代码段中。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uapi/linux/bpf.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"bpf_helpers.h"</span></span>

<span class="token keyword">struct</span> pair <span class="token punctuation">{</span>
        u64 val<span class="token punctuation">;</span>
        u64 ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> bpf_map_def <span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"maps"</span><span class="token punctuation">)</span> my_map <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>type <span class="token operator">=</span> BPF_MAP_TYPE_HASH<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pair<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"kprobe/kmem_cache_free"</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">bpf_prog1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pt_regs <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">long</span> ptr <span class="token operator">=</span> <span class="token function">PT_REGS_PARM2</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">bpf_map_delete_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"kretprobe/kmem_cache_alloc_node"</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">bpf_prog2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pt_regs <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">long</span> ptr <span class="token operator">=</span> <span class="token function">PT_REGS_RC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> ip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* get ip address of kmem_cache_alloc_node() caller */</span>
        <span class="token function">BPF_KRETPROBE_READ_RET_IP</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">struct</span> pair v <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token function">bpf_ktime_get_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span>ip <span class="token operator">=</span> ip<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token function">bpf_map_update_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">,</span> BPF_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span> _license<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"license"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"GPL"</span><span class="token punctuation">;</span>
u32 _version <span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span> <span class="token operator">=</span> LINUX_VERSION_CODE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 clang 编译出 <code>.o</code> 文件，同样属于 ELF 文件，可以使用 llvm dump 出各个 section table，如上述自定义的几个段，用 <code>SEC</code> 就可自定义一个 section：</p>
<pre><code>#define SEC(NAME) __attribute__((section(NAME), used))</code></pre><h4 id="tracex4-user-c"><a href="#tracex4-user-c" class="headerlink" title="tracex4_user.c"></a>tracex4_user.c</h4><p>其中定义了一个 pair 结构体用来接受 hook 处理函数的数据，首先加载 <code>tracex4_kern.o</code>，然后在死循环中轮询获取数据，然后用 <code>printf</code> 打印出来：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/bpf.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;bpf/bpf.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"bpf_load.h"</span></span>

<span class="token keyword">struct</span> pair <span class="token punctuation">{</span>
        <span class="token keyword">long</span> <span class="token keyword">long</span> val<span class="token punctuation">;</span>
        __u64 ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> __u64 <span class="token function">time_get_ns</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> timespec ts<span class="token punctuation">;</span>

        <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ts<span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> <span class="token number">1000000000ull</span> <span class="token operator">+</span> ts<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print_old_objects</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">long</span> <span class="token keyword">long</span> val <span class="token operator">=</span> <span class="token function">time_get_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        __u64 key<span class="token punctuation">,</span> next_key<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> pair v<span class="token punctuation">;</span>

        key <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"\e[1;1H\e[2J"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* clear screen */</span>

        key <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">bpf_map_get_next_key</span><span class="token punctuation">(</span>map_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span>map_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                key <span class="token operator">=</span> next_key<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">-</span> v<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> <span class="token number">1000000000ll</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">/* object was allocated more then 1 sec ago */</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"obj 0x%llx is %2lldsec old was allocated at ip %llx\n"</span><span class="token punctuation">,</span>
                       next_key<span class="token punctuation">,</span> <span class="token punctuation">(</span>val <span class="token operator">-</span> v<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000000ll</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> ac<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> rlimit r <span class="token operator">=</span> <span class="token punctuation">{</span>RLIM_INFINITY<span class="token punctuation">,</span> RLIM_INFINITY<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token function">snprintf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s_kern.o"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_MEMLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">load_bpf_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> bpf_log_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">print_old_objects</span><span class="token punctuation">(</span>map_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="通过-readelf-和-llvm-objdump-解析目标文件"><a href="#通过-readelf-和-llvm-objdump-解析目标文件" class="headerlink" title="通过 readelf 和 llvm-objdump 解析目标文件"></a>通过 readelf 和 llvm-objdump 解析目标文件</h4><h5 id="读取-ELF-文件头"><a href="#读取-ELF-文件头" class="headerlink" title="读取 ELF 文件头"></a>读取 ELF 文件头</h5><pre><code>wu@ubuntu:~/linux/samples/bpf$ readelf -h tracex4_kern.o
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              2's complement, little endian
Version: 1 (current)
OS/ABI: UNIX - System V
ABI Version: 0
Type: REL (Relocatable file)
Machine: Linux BPF
Version: 0x1
Entry point address: 0x0
Start of program headers: 0 (bytes into file)
Start of section headers: 8344 (bytes into file)
Flags: 0x0
Size of this header: 64 (bytes)
Size of program headers: 0 (bytes)
Number of program headers: 0
Size of section headers: 64 (bytes)
Number of section headers: 27
Section header string table index: 1</code></pre><p>在 readelf 的输出中：</p>
<p>第 1 行，ELF Header: 指名 ELF 文件头开始。 第 2 行，Magic 魔数，用来指名该文件是一个 ELF 目标文件。第一个字节 7F 是个固定的数；后面的 3 个字节正是 E, L, F 三个字母的 ASCII 形式。 第 3 行，CLASS 表示文件类型，这里是 64位的 ELF 格式。 第 4 行，Data 表示文件中的数据是按照什么格式组织(大端或小端)的，不同处理器平台数据组织格式可能就不同，如x86平台为小端存储格式。 第 5 行，当前 ELF 文件头版本号，这里版本号为 1 。 第 6 行，OS/ABI ，指出操作系统类型，ABI 是 Application Binary Interface 的缩写。 第 7 行，ABI 版本号，当前为 0 。 第 8 行，Type 表示文件类型。ELF 文件有 3 种类型，一种是如上所示的 Relocatable file 可重定位目标文件，一种是可执行文件(Executable)，另外一种是共享库(Shared Library) 。 第 9 行，机器平台类型。 这里是bpf虚拟机 第 10 行，当前目标文件的版本号。 第 11 行，程序的虚拟地址入口点，因为这还不是可运行的程序，故而这里为零。 第 12 行，与 11 行同理，这个目标文件没有 Program Headers。 第 13 行，sections 头开始处，这里 8344 是十进制，表示从地址偏移 0x2098 处开始。 第 14 行，是一个与处理器相关联的标志，x86 平台上该处为 0 。 第 15 行，ELF 文件头的字节数。 第 16 行，因为这个不是可执行程序，故此处大小为 0 第 19 行，一共有多少个 section 头，这里是 27个。</p>
<h5 id="打印各个段的内容"><a href="#打印各个段的内容" class="headerlink" title="打印各个段的内容"></a>打印各个段的内容</h5><pre><code>wu@ubuntu:~/linux/samples/bpf$ readelf -S tracex4_kern.o
There are 27 section headers, starting at offset 0x2098:

Section Headers:
  [Nr] Name                 Type                  Address            Offset
       Size                 EntSize          Flags  Link  Info  Align
  [ 0]                         NULL                  0000000000000000  00000000
       0000000000000000  0000000000000000            0          0        0
  [ 1] .strtab                 STRTAB           0000000000000000  00001f80
       0000000000000115  0000000000000000            0          0        1
  [ 2] .text                 PROGBITS          0000000000000000  00000040
       0000000000000000  0000000000000000  AX            0          0        4
  [ 3] kprobe/kmem_cache PROGBITS          0000000000000000  00000040
       0000000000000048  0000000000000000  AX            0          0        8
  [ 4] .relkprobe/kmem_c REL                  0000000000000000  00001870
       0000000000000010  0000000000000010           26          3        8
  [ 5] kretprobe/kmem_ca PROGBITS          0000000000000000  00000088
       00000000000000c0  0000000000000000  AX            0          0        8
  [ 6] .relkretprobe/kme REL                  0000000000000000  00001880
       0000000000000010  0000000000000010           26          5        8
  [ 7] maps                 PROGBITS          0000000000000000  00000148
       000000000000001c  0000000000000000  WA            0          0        4
  [ 8] license                 PROGBITS          0000000000000000  00000164
       0000000000000004  0000000000000000  WA            0          0        1
  [ 9] version                 PROGBITS          0000000000000000  00000168
       0000000000000004  0000000000000000  WA            0          0        4
  [10] .debug_str         PROGBITS          0000000000000000  0000016c
       00000000000001e9  0000000000000001  MS            0          0        1
  [11] .debug_loc         PROGBITS          0000000000000000  00000355
       0000000000000150  0000000000000000            0          0        1
  [12] .rel.debug_loc         REL                  0000000000000000  00001890
       0000000000000050  0000000000000010           26         11        8
  [13] .debug_abbrev         PROGBITS          0000000000000000  000004a5
       0000000000000101  0000000000000000            0          0        1
  [14] .debug_info         PROGBITS          0000000000000000  000005a6
       0000000000000376  0000000000000000            0          0        1
  [15] .rel.debug_info         REL                  0000000000000000  000018e0
       00000000000004b0  0000000000000010           26         14        8
  [16] .debug_ranges         PROGBITS          0000000000000000  0000091c
       0000000000000030  0000000000000000            0          0        1
  [17] .rel.debug_ranges REL                  0000000000000000  00001d90
       0000000000000040  0000000000000010           26         16        8
  [18] .BTF                 PROGBITS          0000000000000000  0000094c
       0000000000000569  0000000000000000            0          0        1
  [19] .rel.BTF          REL                  0000000000000000  00001dd0
       0000000000000030  0000000000000010           26         18        8
  [20] .BTF.ext          PROGBITS          0000000000000000  00000eb5
       0000000000000178  0000000000000000            0          0        1
  [21] .rel.BTF.ext         REL                  0000000000000000  00001e00
       0000000000000140  0000000000000010           26         20        8
  [22] .eh_frame         PROGBITS          0000000000000000  00001030
       0000000000000050  0000000000000000   A            0          0        8
  [23] .rel.eh_frame         REL                  0000000000000000  00001f40
       0000000000000020  0000000000000010           26         22        8
  [24] .debug_line         PROGBITS          0000000000000000  00001080
       0000000000000147  0000000000000000            0          0        1
  [25] .rel.debug_line         REL                  0000000000000000  00001f60
       0000000000000020  0000000000000010           26         24        8
  [26] .symtab                 SYMTAB           0000000000000000  000011c8
       00000000000006a8  0000000000000018            1         66        8</code></pre><p>其中，第三列代表类型（Type）：</p>
<ul>
<li><p>”NULL”：未使用，如段表的第一个空段</p>
</li>
<li><p>“PROGBITS”：程序数据，如 .text、.data、.rodata;</p>
</li>
<li><p>“REL”：重定位表，如 .rel.text;</p>
</li>
<li><p>“NOBITS”：暂时没有数据的程序空间，如 .bss;</p>
</li>
<li><p>“STRTAB”：字符串表，如 .strtab、.shstrtab;</p>
</li>
<li><p>“SYMTAB”：符号表，如 .symtab，包括所有用到的相关符号信息，如函数名、变量名。</p>
</li>
</ul>
<h5 id="通过-llvm-objdump-解析-BPF-ELF-格式文件"><a href="#通过-llvm-objdump-解析-BPF-ELF-格式文件" class="headerlink" title="通过 llvm-objdump 解析 BPF ELF 格式文件"></a>通过 llvm-objdump 解析 BPF ELF 格式文件</h5><pre><code>wu@ubuntu:~/linux/samples/bpf$ llvm-objdump -h tracex4_kern.o

tracex4_kern.o: file format ELF64-BPF

Sections:
Idx Name                                Size         VMA                  Type
  0                                        00000000 0000000000000000
  1 .strtab                                00000115 0000000000000000
  2 .text                                00000000 0000000000000000 TEXT
  3 kprobe/kmem_cache_free                00000048 0000000000000000 TEXT
  4 .relkprobe/kmem_cache_free                00000010 0000000000000000
  5 kretprobe/kmem_cache_alloc_node        000000c0 0000000000000000 TEXT
  6 .relkretprobe/kmem_cache_alloc_node 00000010 0000000000000000
  7 maps                                0000001c 0000000000000000 DATA
  8 license                                00000004 0000000000000000 DATA
  9 version                                00000004 0000000000000000 DATA
... ...</code></pre><p>可以使用 llvm 工具为 eBPF 程序进行反编译，<code>tracex4_kern.o</code> 是 ELF 格式的文件，分为两个代码段，如下所示 ：</p>
<pre><code>wu@ubuntu:~/linux/samples/bpf$ llvm-objdump -d -r -print-imm-hex tracex4_kern.o

tracex4_kern.o: file format ELF64-BPF


Disassembly of section kprobe/kmem_cache_free:

0000000000000000 bpf_prog1:
       0:        79 11 68 00 00 00 00 00 r1 = *(u64 *)(r1 + 0x68)
       1:        7b 1a f8 ff 00 00 00 00 *(u64 *)(r10 - 0x8) = r1
       2:        bf a2 00 00 00 00 00 00 r2 = r10
       3:        07 02 00 00 f8 ff ff ff r2 += -0x8
       4:        18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0x0 ll
                0000000000000020:  R_BPF_64_64        my_map
       6:        85 00 00 00 03 00 00 00 call 0x3
       7:        b7 00 00 00 00 00 00 00 r0 = 0x0
       8:        95 00 00 00 00 00 00 00 exit

Disassembly of section kretprobe/kmem_cache_alloc_node:

0000000000000000 bpf_prog2:
       0:        79 12 50 00 00 00 00 00 r2 = *(u64 *)(r1 + 0x50)
       1:        7b 2a f8 ff 00 00 00 00 *(u64 *)(r10 - 0x8) = r2
       2:        b7 02 00 00 00 00 00 00 r2 = 0x0
       3:        7b 2a f0 ff 00 00 00 00 *(u64 *)(r10 - 0x10) = r2
       4:        79 13 20 00 00 00 00 00 r3 = *(u64 *)(r1 + 0x20)
       5:        07 03 00 00 08 00 00 00 r3 += 0x8
       6:        bf a1 00 00 00 00 00 00 r1 = r10
       7:        07 01 00 00 f0 ff ff ff r1 += -0x10
       8:        b7 02 00 00 08 00 00 00 r2 = 0x8
       9:        85 00 00 00 04 00 00 00 call 0x4
      10:        85 00 00 00 05 00 00 00 call 0x5
      11:        7b 0a e0 ff 00 00 00 00 *(u64 *)(r10 - 0x20) = r0
      12:        79 a1 f0 ff 00 00 00 00 r1 = *(u64 *)(r10 - 0x10)
      13:        7b 1a e8 ff 00 00 00 00 *(u64 *)(r10 - 0x18) = r1
      14:        bf a2 00 00 00 00 00 00 r2 = r10
      15:        07 02 00 00 f8 ff ff ff r2 += -0x8
      16:        bf a3 00 00 00 00 00 00 r3 = r10
      17:        07 03 00 00 e0 ff ff ff r3 += -0x20
      18:        18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0x0 ll
                0000000000000090:  R_BPF_64_64        my_map
      20:        b7 04 00 00 00 00 00 00 r4 = 0x0
      21:        85 00 00 00 02 00 00 00 call 0x2
      22:        b7 00 00 00 00 00 00 00 r0 = 0x0
      23:        95 00 00 00 00 00 00 00 exit

             ........</code></pre><p>接下来查看其他段的内容,比如 maps 段和 license 段：</p>
<pre><code>wu@ubuntu:~/linux/samples/bpf$ llvm-objdump --section=maps  -s tracex4_kern.o

tracex4_kern.o: file format ELF64-BPF

Contents of section maps:
 0000 01000000 08000000 10000000 40420f00  ............@B..
 0010 00000000 00000000 00000000           ............
wu@ubuntu:~/linux/samples/bpf$ llvm-objdump --section=license  -s tracex4_kern.o

tracex4_kern.o: file format ELF64-BPF

Contents of section license:
 0000 47504c00                                   GPL.</code></pre><p>上述 bpf 程序的字节码，是不能在 x86_64 平台上直接执行的，当加载 bpf 程序时需要使用 JIT(just in time) 编译器将 bpf 字节码翻译成主机能识别的汇编码，然而对于大多数操作码，eBPF 指令集可以和 x86 或 aarch64 指令集一一映射。</p>
<p>bpf 程序自定义了一套指令，有别于 x86，ARM64 等，而且指令集没这两者丰富，没有浮点计算等。但寄存器功能大同小异， 功能如下所示：</p>
<p>无法复制加载中的内容</p>
<h4 id="通过-strace-工具追踪分析-eBPF-程序行为"><a href="#通过-strace-工具追踪分析-eBPF-程序行为" class="headerlink" title="通过 strace 工具追踪分析 eBPF 程序行为"></a>通过 strace 工具追踪分析 eBPF 程序行为</h4><p>执行如下命令可以看到 slab 对象的分配地址以及分配时间：</p>
<pre><code>wu@ubuntu:~/linux/samples/bpf$ sudo strace -v -f -s 128 -o tracex4.txt ./tracex4
obj 0xffff9637e3175cc0 is  1sec old was allocated at ip ffffffff99679a9a
obj 0xffff9637e31750c0 is  1sec old was allocated at ip ffffffff99679a9a
obj 0xffff9637e3175e00 is  1sec old was allocated at ip ffffffff99679a9a
obj 0xffff9637e3175780 is  1sec old was allocated at ip ffffffff99679a9a
... ...</code></pre><p>strace 追踪到的关键系统调用如下：</p>
<pre><code>execve("./tracex4", ["./tracex4"], ["LANG=en_US.UTF-8", "LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca"..., "TERM=xterm", "DISPLAY=localhost:12.0", "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin", "MAIL=/var/mail/root", "LOGNAME=root", "USER=root", "HOME=/root", "SHELL=/bin/bash", "SUDO_COMMAND=/usr/bin/strace -v -f -s 128 -o tracex4.txt ./tracex4", "SUDO_USER=wu", "SUDO_UID=1000", "SUDO_GID=1000"]) = 0
... ...
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_HASH, key_size=8, value_size=16, max_entries=1000000, map_flags=0, inner_map_fd=0, map_name="my_map", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0}, 112) = 4

bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_KPROBE, insn_cnt=9, insns=[{code=BPF_LDX|BPF_DW|BPF_MEM, dst_reg=BPF_REG_1, src_reg=BPF_REG_1, off=104, imm=0}, {code=BPF_STX|BPF_DW|BPF_MEM, dst_reg=BPF_REG_10, src_reg=BPF_REG_1, off=-8, imm=0}, {code=BPF_ALU64|BPF_X|BPF_MOV, dst_reg=BPF_REG_2, src_reg=BPF_REG_10, off=0, imm=0}, {code=BPF_ALU64|BPF_K|BPF_ADD, dst_reg=BPF_REG_2, src_reg=BPF_REG_0, off=0, imm=0xfffffff8}, {code=BPF_LD|BPF_DW|BPF_IMM, dst_reg=BPF_REG_1, src_reg=BPF_REG_1, off=0, imm=0x4}, {code=BPF_LD|BPF_W|BPF_IMM, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0}, {code=BPF_JMP|BPF_K|BPF_CALL, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0x3}, {code=BPF_ALU64|BPF_K|BPF_MOV, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0}, {code=BPF_JMP|BPF_K|BPF_EXIT, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0}], license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(5, 4, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0}, 112) = 5

openat(AT_FDCWD, "/sys/kernel/debug/tracing/kprobe_events", O_WRONLY|O_APPEND) = 6
write(6, "p:kmem_cache_free kmem_cache_free", 33) = 33
close(6)
openat(AT_FDCWD, "/sys/kernel/debug/tracing/events/kprobes/kmem_cache_free/id", O_RDONLY) = 6
read(6, "2145\n", 256)                 = 5
close(6)
perf_event_open({type=PERF_TYPE_TRACEPOINT, size=0 /* PERF_ATTR_SIZE_??? */, config=2145, sample_period=1, sample_type=PERF_SAMPLE_RAW, read_format=0, disabled=0, inherit=0, pinned=0, exclusive=0, exclusive_user=0, exclude_kernel=0, exclude_hv=0, exclude_idle=0, mmap=0, comm=0, freq=0, inherit_stat=0, enable_on_exec=0, task=0, watermark=0, precise_ip=0 /* arbitrary skid */, mmap_data=0, sample_id_all=0, exclude_host=0, exclude_guest=0, exclude_callchain_kernel=0, exclude_callchain_user=0, mmap2=0, comm_exec=0, use_clockid=0, context_switch=0, write_backward=0, namespaces=0, wakeup_events=1, config1=0}, -1, 0, -1, 0) = 6
... ...
openat(AT_FDCWD, "/sys/kernel/debug/tracing/kprobe_events", O_WRONLY|O_APPEND) = 8
write(8, "r:kmem_cache_alloc_node kmem_cache_alloc_node", 45) = 45
openat(AT_FDCWD, "/sys/kernel/debug/tracing/events/kprobes/kmem_cache_alloc_node/id", O_RDONLY) = 8
read(8, "2146\n", 256)                 = 5
close(8)                         = 0
perf_event_open({type=PERF_TYPE_TRACEPOINT, size=0 /* PERF_ATTR_SIZE_??? */, config=2146, sample_period=1, sample_type=PERF_SAMPLE_RAW, read_format=0, disabled=0, inherit=0, pinned=0, exclusive=0, exclusive_user=0, exclude_kernel=0, exclude_hv=0, exclude_idle=0, mmap=0, comm=0, freq=0, inherit_stat=0, enable_on_exec=0, task=0, watermark=0, precise_ip=0 /* arbitrary skid */, mmap_data=0, sample_id_all=0, exclude_host=0, exclude_guest=0, exclude_callchain_kernel=0, exclude_callchain_user=0, mmap2=0, comm_exec=0, use_clockid=0, context_switch=0, write_backward=0, namespaces=0, wakeup_events=1, config1=0}, -1, 0, -1, 0) = 8
ioctl(8, PERF_EVENT_IOC_ENABLE, 0) = 0
ioctl(8, PERF_EVENT_IOC_SET_BPF, 7) = 0
write(1, "\33[1;1H\33[2J\0\0", 12) = 12
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=4, key=0x7ffffaf162b0, next_key=0x7ffffaf162b8}, 112) = 0
bpf(BPF_MAP_LOOKUP_ELEM, {map_fd=4, key=0x7ffffaf162b8, value=0x7ffffaf162d0, flags=BPF_ANY}, 112) = 0
... ...</code></pre><h5 id="BPF-字节码加载分析"><a href="#BPF-字节码加载分析" class="headerlink" title="BPF 字节码加载分析"></a>BPF 字节码加载分析</h5><p>当 bpf 系统第一个参数 <code>cmds=BPF_PROG_LOAD</code> 时，表示加载 <code>ELF64-BPF</code> 格式的文件，仔细分析下第二个参数 <code>attr</code>，这个结构体的原型如下，发现就是保存了 bpf 字节码：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Used by BPF_PROG_LOAD */</span>
        __u32              prog_type<span class="token punctuation">;</span>
        __u32              insn_cnt<span class="token punctuation">;</span>
        __aligned_u64 insns<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* 'const struct bpf_insn *' */</span>
        __aligned_u64 license<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* 'const char *' */</span>
        __u32              log_level<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* verbosity level of verifier */</span>
        __u32              log_size<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* size of user buffer */</span>
        __aligned_u64 log_buf<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* user supplied 'char *'
buffer */</span>
        __u32              kern_version<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">/* checked when prog_type=kprobe
(since Linux 4.1) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当加载 bpf 程序时，<code>BPF_PROG_LOAD</code> 表示的是该程序的具体 bpf 指令，对应 <code>bpf_prog1</code> 这个代码段。</p>
<p>strace 追踪到的指令如下所示，每条指令的操作码由六部分组成：</p>
<ul>
<li><p>code(操作码)</p>
</li>
<li><p>dst_reg(目标寄存器)</p>
</li>
<li><p>src_reg(源寄存器)</p>
</li>
<li><p>off(偏移)</p>
</li>
<li><p>imm(立即数)</p>
</li>
</ul>
<p>详见：</p>
<pre class="line-numbers language-c"><code class="language-c">insns<span class="token operator">=</span><span class="token punctuation">[</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_LDX<span class="token operator">|</span>BPF_DW<span class="token operator">|</span>BPF_MEM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">104</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_STX<span class="token operator">|</span>BPF_DW<span class="token operator">|</span>BPF_MEM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_X<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_2<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_10<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_ADD<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_2<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0xfffffff8</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_LD<span class="token operator">|</span>BPF_DW<span class="token operator">|</span>BPF_IMM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_1<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_LD<span class="token operator">|</span>BPF_W<span class="token operator">|</span>BPF_IMM<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_JMP<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_CALL<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0x3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_ALU64<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_MOV<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>code<span class="token operator">=</span>BPF_JMP<span class="token operator">|</span>BPF_K<span class="token operator">|</span>BPF_EXIT<span class="token punctuation">,</span> dst_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> src_reg<span class="token operator">=</span>BPF_REG_0<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> imm<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>指令格式如下图所示，BPF 当前拥有 102 个指令，主要包括三大类：</p>
<ul>
<li><p>ALU (64bit and 32bit)</p>
</li>
<li><p>内存操作</p>
</li>
<li><p>分支操作</p>
</li>
</ul>
<p>其中指令的格式主要由下面这几部分组成：</p>
<p><img src="/images/loading.gif" data-original="../images/basic/-163031660118832.png" alt=""></p>
<p>opcode 的低 3 位表示指令类型，<code>BPF_LDX</code>，<code>BPF_REG_10</code> 等这些宏在 kernel 目录 <code>tools/include/uapi/linux/bpf.h</code> 中定义：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span>         BPF_LDX         0x01</span>
<span class="token macro property">#<span class="token directive keyword">define</span>         BPF_MEM         0x60</span>
<span class="token macro property">#<span class="token directive keyword">define</span>         BPF_DW                0x18</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>以第一条 bpf 指令为例子：</p>
<pre><code>{code=BPF_LDX|BPF_DW|BPF_MEM, dst_reg=BPF_REG_1, src_reg=BPF_REG_1, off=104, imm=0}</code></pre><p>正好对应 llvm-objdump 解析出来的第一条指令，为内存访问指令：</p>
<pre><code>0:       79 11 68 00 00 00 00 00 r1 = *(u64 *)(r1 + 0x68)
BPF_LDX|BPF_MEM|BPF_DW=0x79</code></pre><p>该条指令在 kernel 中的定义为：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)                        \
        ((struct bpf_insn) {                                        \
                .code  = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM,        \
                .dst_reg = DST,                                 \
                .src_reg = SRC,                                 \
                .off   = OFF,                                        \
                .imm   = 0 })</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="MAP-数据通信分析"><a href="#MAP-数据通信分析" class="headerlink" title="MAP 数据通信分析"></a>MAP 数据通信分析</h5><p>当 bpf 系统第一个参数 <code>cmds=BPF_MAP_CREATE</code> 时，表示创建一个数据 map，仔细分析下第二个参数 <code>attr</code>，这个结构体的原型包含了 map 类型，key 的大小，valu e大小等：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">union</span> bpf_attr <span class="token punctuation">{</span>
<span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Used by BPF_MAP_CREATE */</span>
        __u32              map_type<span class="token punctuation">;</span>
        __u32              key_size<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* size of key in bytes */</span>
        __u32              value_size<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* size of value in bytes */</span>
        __u32              max_entries<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* maximum number of entries
in a map */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用 strace 抓取的 log 分析来看 map 的类型为 <code>BPF_MAP_TYPE_HASH</code>，key 的大小为 8，value大小为 16，访问 map 是 <code>bpf_prog1</code> 第5条字节码，其中的 imm 立即数为 4 代表 map_fd，这是一条伪指令，这条指令是可重定位指令：</p>
<pre><code>bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_HASH, key_size=8, value_size=16, max_entries=1000000, map_flags=0, inner_map_fd=0, map_name="my_map", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0}, 112) = 4

 0000000000000020:  R_BPF_64_64  my_map
{code=BPF_LD|BPF_DW|BPF_IMM, dst_reg=BPF_REG_1, src_reg=BPF_REG_1, off=0, imm=0x4}</code></pre><p>bpf 程序访问所有类型的 map 都可以使用 <code>bpf_map_lookup_elem()</code> 和 <code>bpf_map_update_elem()</code> 函数，socket maps 和一些其他额外的 map 当作特殊用途。</p>
<p>当 bpf 系统第一个参数 <code>cmds=BPF_MAP_GET_NEXT_KEY</code> 或 <code>BPF_MAP_LOOKUP_ELEM</code> 时，表示遍历 map，仔细分析下第二个参数 <code>attr</code>，这个结构体的原型包含了 map_fd，是 bpf 系统调用第一个参数 <code>cmd=BPF_MAP_CREATE</code> 返回值，key 值，value 值等：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* Used by BPF_MAP_*_ELEM and BPF_MAP_GET_NEXT_KEY
commands */</span>
        __u32              map_fd<span class="token punctuation">;</span>
        __aligned_u64 key<span class="token punctuation">;</span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
        __aligned_u64 value<span class="token punctuation">;</span>
        __aligned_u64 next_key<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        __u64              flags<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">bpf</span><span class="token punctuation">(</span>BPF_MAP_GET_NEXT_KEY<span class="token punctuation">,</span> <span class="token punctuation">{</span>map_fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token number">0x7ffffaf162b0</span><span class="token punctuation">,</span> next_key<span class="token operator">=</span><span class="token number">0x7ffffaf162b8</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">bpf</span><span class="token punctuation">(</span>BPF_MAP_LOOKUP_ELEM<span class="token punctuation">,</span> <span class="token punctuation">{</span>map_fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token number">0x7ffffaf162b8</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">0x7ffffaf162d0</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>BPF_ANY<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="bpftool-用法简介"><a href="#bpftool-用法简介" class="headerlink" title="bpftool 用法简介"></a>bpftool 用法简介</h4><p>bpftool 在内核的 <code>tools/bpf/bpftool/</code> 目录下，使用 make 编译就可使用，查看当前运行的 bpf 程序，如下所示，可以看到当前运行的是 <code>kprobe event</code> 还有 <code>map id</code>：</p>
<pre><code>wu@ubuntu:~/linux/samples/bpf$ sudo bpftool prog show
[sudo] password for wu:
... ...
205: kprobe  tag a6cfc4a29f52a193  gpl
        loaded_at 2021-01-19T11:51:26+0000  uid 0
        xlated 72B  jited 62B  memlock 4096B  map_ids 72
206: kprobe  tag d16c41919f3b767a  gpl
        loaded_at 2021-01-19T11:51:26+0000  uid 0
        xlated 192B  jited 119B  memlock 4096B        map_ids 72</code></pre><p>查看 map 的id，可以看到当前使用的是 hash map：</p>
<pre><code>wu@ubuntu:~/linux$ sudo bpftool map show
72: hash  name my_map  flags 0x0
        key 8B        value 16B  max_entries 1000000        memlock 88788992B</code></pre><p>查看 map 的所有的内容，并查看对应 key 的value：</p>
<pre><code>wu@ubuntu:~/linux$ sudo bpftool map dump id 72
key: 80 35 43 e5 26 95 ff ff  value: b9 f3 f3 9e 87 6b 00 00  9a 9a c7 86 ff ff ff ff
key: 80 9c 5f f6 25 95 ff ff  value: 98 85 ac c7 8c 6b 00 00  9a 9a c7 86 ff ff ff ff
key: 00 4c 9b e4 25 95 ff ff  value: e6 8d c2 b7 7e 6b 00 00  9a 9a c7 86 ff ff ff ff
key: 80 21 15 f8 26 95 ff ff  value: 60 df 01 fc 5c 6b 00 00  9a 9a c7 86 ff ff ff ff
key: 80 f5 46 5f 26 95 ff ff  value: 5e e1 73 7b 8d 6b 00 00  9a 9a c7 86 ff ff ff ff
... ...
wu@ubuntu:~/linux$ sudo bpftool map lookup id 72 key 0x80 0x35 0x43 0xe5 0x26 0x95 0xff 0xff
key: 80 35 43 e5 26 95 ff ff  value: b9 f3 f3 9e 87 6b 00 00  9a 9a c7 86 ff ff ff ff</code></pre><h2 id="eBPF-程序装载、翻译与运行过程详解"><a href="#eBPF-程序装载、翻译与运行过程详解" class="headerlink" title="eBPF 程序装载、翻译与运行过程详解"></a>eBPF 程序装载、翻译与运行过程详解</h2><h4 id="BPF-程序格式为-ELF"><a href="#BPF-程序格式为-ELF" class="headerlink" title="BPF 程序格式为 ELF"></a>BPF 程序格式为 ELF</h4><p>加载 bpf 程序实质上是加载 ELF 格式文件，Linux 加载普通 ELF 格式的文件在通过 <code>load_elf_binary</code> 来实现，而 Linux 加载 bpf elf 其实在用户态实现的，使用的是开源的 libelf 库实现的，调用过程不太一样，而且只是把 ELF 格式的指令 dump 出来，接下来还需要 JIT 编译器翻译出机器汇编码才能执行，这个调用过程比 Linux 加载普通 ELF 格式文件简单。</p>
<p>libelf 库实现的各个 API 可参考如下 <a href="https://www.zybuluo.com/devilogic/note/139554" target="_blank" rel="noopener">链接</a> 以及我们专门为此准备的 <a href="http://tinylab.org/libelf" target="_blank" rel="noopener">libelf 开源库用法详解</a>。</p>
<p>ELF 格式的详解可参考社区创始人撰写的开源书籍 <a href="https://tinylab.gitbooks.io/cbook" target="_blank" rel="noopener">C 语言编程透视</a> 和配套视频课程<a href="https://www.cctalk.com/m/group/88089283" target="_blank" rel="noopener">《360° 剖析 Linux ELF》</a>。</p>
<h5 id="ELF-文件大体结构"><a href="#ELF-文件大体结构" class="headerlink" title="ELF 文件大体结构"></a>ELF 文件大体结构</h5><p>ELF 文件大体结构如下所示，包含 ELF 头部，程序头表，各个段和程序段表：</p>
<pre><code>ELF Header                 #程序头，有该文件的Magic number(参考man magic)，类型等
Program Header Table         #对可执行文件和共享库有效，它描述下面各个节(section)组成的段
Section1
Section2
Section3
.....
Program Section Table        #仅对可重定位目标文件和静态库有效，用于描述各个Section的重定位信息等。</code></pre><h4 id="BPF-程序-Section-解析：get-sec"><a href="#BPF-程序-Section-解析：get-sec" class="headerlink" title="BPF 程序 Section 解析：get_sec"></a>BPF 程序 Section 解析：get_sec</h4><p><code>samples/bpf/bpf_load.c</code> 中通过 <code>get_sec</code> 函数调用 libelf 库的 API 获取 section 内容，其中第四个参数是传入段的名字，最后一个参数获得的是该段的数据：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">get_sec</span><span class="token punctuation">(</span>Elf <span class="token operator">*</span>elf<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> GElf_Ehdr <span class="token operator">*</span>ehdr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>shname<span class="token punctuation">,</span>
                   GElf_Shdr <span class="token operator">*</span>shdr<span class="token punctuation">,</span> Elf_Data <span class="token operator">*</span><span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        Elf_Scn <span class="token operator">*</span>scn<span class="token punctuation">;</span>

        scn <span class="token operator">=</span> <span class="token function">elf_getscn</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//从elf描述符获取按照节索引获取节接口</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scn<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gelf_getshdr</span><span class="token punctuation">(</span>scn<span class="token punctuation">,</span> shdr<span class="token punctuation">)</span> <span class="token operator">!=</span> shdr<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通过节结构复制节表头</span>
                <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>shname <span class="token operator">=</span> <span class="token function">elf_strptr</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> ehdr<span class="token operator">-></span>e_shstrndx<span class="token punctuation">,</span> shdr<span class="token operator">-></span>sh_name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从指定的字符串表中通过偏移获取字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>shname <span class="token operator">||</span> <span class="token operator">!</span>shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">elf_getdata</span><span class="token punctuation">(</span>scn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//从节中获取节数据（经过了字节序的转换）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>data <span class="token operator">||</span> <span class="token function">elf_getdata</span><span class="token punctuation">(</span>scn<span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="BPF-程序装载与解析：load-bpf-file"><a href="#BPF-程序装载与解析：load-bpf-file" class="headerlink" title="BPF 程序装载与解析：load_bpf_file"></a>BPF 程序装载与解析：load_bpf_file</h4><p><code>tracex4_user.c</code> 通过 <code>load_bpf_file</code> 加载 <code>.o</code> 文件，我们来分析一下。</p>
<p><code>load_bpf_file</code> 实质是调用 <code>do_load_bpf_file</code>，在这个函数里首先打开 <code>.o</code> 文件，<code>do_load_bpf_file</code> 会将输入的 <code>.o</code> 文件作为 ELF 格式文件，逐个 section 进行分析：</p>
<ul>
<li><p>如 section 的名字是特殊的(比如 ‘kprobe’)，那么就会将这个 section 的内容作为 <code>load_and_attach</code> 的参数。</p>
</li>
<li><p>如 section 的名字是 “license” 或 “version” 则保存 license 或 version。</p>
</li>
<li><p>如 section 是 map 则解析出 map 段</p>
</li>
</ul>
<p><code>samples/bpf/bpfload.c</code> 中的相关代码如下：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_load_bpf_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> fixup_map_cb fixup_map<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> fd<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> maps_shndx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> strtabidx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        Elf <span class="token operator">*</span>elf<span class="token punctuation">;</span>
        GElf_Ehdr ehdr<span class="token punctuation">;</span>
        GElf_Shdr shdr<span class="token punctuation">,</span> shdr_prog<span class="token punctuation">;</span>
        Elf_Data <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token operator">*</span>data_prog<span class="token punctuation">,</span> <span class="token operator">*</span>data_maps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>symbols <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>shname<span class="token punctuation">,</span> <span class="token operator">*</span>shname_prog<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nr_maps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//打开elf文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

        elf <span class="token operator">=</span> <span class="token function">elf_begin</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ELF_C_READ<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取elf描述符,使用‘读取’的方式</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gelf_getehdr</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//获取elf文件头副本</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">/* scan over all elf sections to get license and map info */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ehdr<span class="token punctuation">.</span>e_shnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token comment" spellcheck="true">//遍历各个section</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_sec</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// shname 为"section"的名字</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* helpful for llvm debugging */</span>        <span class="token comment" spellcheck="true">//打印各个section 对应的数据保存在data->d_buf中</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"section %d:%s data %p size %zd link %d flags %d\n"</span><span class="token punctuation">,</span>
                        i<span class="token punctuation">,</span> shname<span class="token punctuation">,</span> data<span class="token operator">-></span>d_buf<span class="token punctuation">,</span> data<span class="token operator">-></span>d_size<span class="token punctuation">,</span>
                        shdr<span class="token punctuation">.</span>sh_link<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> shdr<span class="token punctuation">.</span>sh_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"license"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">//如果是"license"段</span>
                        processed_sec<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> true<span class="token punctuation">;</span>
                        <span class="token function">memcpy</span><span class="token punctuation">(</span>license<span class="token punctuation">,</span> data<span class="token operator">-></span>d_buf<span class="token punctuation">,</span> data<span class="token operator">-></span>d_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//把 data->d_buf 拷贝到license数组</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//如果是"version"段</span>
                        processed_sec<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> true<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>d_size <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"invalid size of version section %zd\n"</span><span class="token punctuation">,</span>
                                data<span class="token operator">-></span>d_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kern_version<span class="token punctuation">,</span> data<span class="token operator">-></span>d_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//把 data->d_buf 拷贝到kern_version变量</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"maps"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//如果是map 段</span>
                <span class="token keyword">int</span> j<span class="token punctuation">;</span>

                maps_shndx <span class="token operator">=</span> i<span class="token punctuation">;</span>
                data_maps <span class="token operator">=</span> data<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> MAX_MAPS<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                        map_data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shdr<span class="token punctuation">.</span>sh_type <span class="token operator">==</span> SHT_SYMTAB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                strtabidx <span class="token operator">=</span> shdr<span class="token punctuation">.</span>sh_link<span class="token punctuation">;</span>
                symbols <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>data_maps<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//对map段的处理</span>
                nr_maps <span class="token operator">=</span> <span class="token function">load_elf_maps_section</span><span class="token punctuation">(</span>map_data<span class="token punctuation">,</span> maps_shndx<span class="token punctuation">,</span>elf<span class="token punctuation">,</span> symbols<span class="token punctuation">,</span> strtabidx<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//获取map段内容</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nr_maps <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error: Failed loading ELF maps (errno:%d):%s\n"</span><span class="token punctuation">,</span>
                        nr_maps<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>nr_maps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">load_maps</span><span class="token punctuation">(</span>map_data<span class="token punctuation">,</span> nr_maps<span class="token punctuation">,</span> fixup_map<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//这里加载map</span>
                        <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
                map_data_count <span class="token operator">=</span> nr_maps<span class="token punctuation">;</span>

                processed_sec<span class="token punctuation">[</span>maps_shndx<span class="token punctuation">]</span> <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/* process all relo sections, and rewrite bpf insns for maps */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ehdr<span class="token punctuation">.</span>e_shnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//遍历所有的重定向段，</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processed_sec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">////flag 置位表示已经是处理了的段 ，跳过去</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_sec</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>shdr<span class="token punctuation">.</span>sh_type <span class="token operator">==</span> SHT_REL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">struct</span> bpf_insn <span class="token operator">*</span>insns<span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">/* locate prog sec that need map fixup (relocations) */</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_sec</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> shdr<span class="token punctuation">.</span>sh_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shname_prog<span class="token punctuation">,</span>
                                <span class="token operator">&amp;</span>shdr_prog<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_prog<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//该段保存到data_prog</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>shdr_prog<span class="token punctuation">.</span>sh_type <span class="token operator">!=</span> SHT_PROGBITS <span class="token operator">||</span>
                        <span class="token operator">!</span><span class="token punctuation">(</span>shdr_prog<span class="token punctuation">.</span>sh_flags <span class="token operator">&amp;</span> SHF_EXECINSTR<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>

                        insns <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> bpf_insn <span class="token operator">*</span><span class="token punctuation">)</span> data_prog<span class="token operator">-></span>d_buf<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//得到bpf字节码对应的结构体</span>
                        processed_sec<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> true<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* relo section */</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parse_relo_and_apply</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> symbols<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shdr<span class="token punctuation">,</span> insns<span class="token punctuation">,</span>
                                                map_data<span class="token punctuation">,</span> nr_maps<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/* load programs */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ehdr<span class="token punctuation">.</span>e_shnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processed_sec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//flag 置位表示已经是处理了的段 ，跳过去</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_sec</span><span class="token punctuation">(</span>elf<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ehdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shdr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"kprobe/"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"kretprobe/"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"tracepoint/"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"raw_tracepoint/"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"xdp"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"perf_event"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"socket"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"cgroup/"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"sockops"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"sk_skb"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                        <span class="token function">memcmp</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> <span class="token string">"sk_msg"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ret <span class="token operator">=</span> <span class="token function">load_and_attach</span><span class="token punctuation">(</span>shname<span class="token punctuation">,</span> data<span class="token operator">-></span>d_buf<span class="token punctuation">,</span>
                                        data<span class="token operator">-></span>d_size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//事件类型 字节码 字节码大小</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                <span class="token keyword">goto</span> done<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

done<span class="token punctuation">:</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打开 ELF 调试 log，可以得到该 ELF 文件各个段的内容首地址，大小，属性等信息。</p>
<pre><code>wu@ubuntu:~/linux/samples/bpf$ sudo ./tracex4
[sudo] password for wu:
section 1:.strtab data 0x556034a3d070 size 277 link 0 flags 0
section 3:kprobe/kmem_cache_free data 0x556034a3d5a0 size 72 link 0 flags 6
section 4:.relkprobe/kmem_cache_free data 0x556034a3d5f0 size 16 link 26 flags 0
section 5:kretprobe/kmem_cache_alloc_node data 0x556034a3d610 size 192 link 0 flags 6
section 6:.relkretprobe/kmem_cache_alloc_node data 0x556034a3d6e0 size 16 link 26 flags 0
section 7:maps data 0x556034a3d700 size 28 link 0 flags 3
section 8:license data 0x556034a3d730 size 4 link 0 flags 3
section 9:version data 0x556034a3d750 size 4 link 0 flags 3
section 10:.debug_str data 0x556034a3d770 size 489 link 0 flags 48
section 11:.debug_loc data 0x556034a3d970 size 336 link 0 flags 0
section 12:.rel.debug_loc data 0x556034a3dad0 size 80 link 26 flags 0
section 13:.debug_abbrev data 0x556034a3db30 size 257 link 0 flags 0
section 14:.debug_info data 0x556034a3dc40 size 886 link 0 flags 0
section 15:.rel.debug_info data 0x556034a3dfc0 size 1200 link 26 flags 0
section 16:.debug_ranges data 0x556034a3e480 size 48 link 0 flags 0
section 17:.rel.debug_ranges data 0x556034a3e4c0 size 64 link 26 flags 0
section 18:.BTF data 0x556034a3e510 size 1384 link 0 flags 0
section 19:.rel.BTF data 0x556034a3ea80 size 48 link 26 flags 0
section 20:.BTF.ext data 0x556034a3eac0 size 376 link 0 flags 0
section 21:.rel.BTF.ext data 0x556034a3ec40 size 320 link 26 flags 0
section 22:.eh_frame data 0x556034a3ed90 size 80 link 0 flags 2
section 23:.rel.eh_frame data 0x556034a3edf0 size 32 link 26 flags 0
section 24:.debug_line data 0x556034a3ee20 size 327 link 0 flags 0
section 25:.rel.debug_line data 0x556034a3ef70 size 32 link 26 flags 0
section 26:.symtab data 0x556034a3efa0 size 1704 link 1 flags 0</code></pre><h4 id="BPF-字节码加载过程"><a href="#BPF-字节码加载过程" class="headerlink" title="BPF 字节码加载过程"></a>BPF 字节码加载过程</h4><p>接下来调用 <code>load_and_attach</code>，第一个参数是 event，本例就是 “kprobe/” ，第二个参数是 bpf 字节码，第三个参数是字节码大小。</p>
<h5 id="BPF-指令结构"><a href="#BPF-指令结构" class="headerlink" title="BPF 指令结构"></a>BPF 指令结构</h5><p><code>bpf_insn</code> 是一个结构体，代表一条 eBPF 指令，包含 5 个字段组成：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> bpf_insn <span class="token punctuation">{</span>
    __u8    code<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* opcode */</span>
    __u8    dst_reg<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* dest register */</span>
    __u8    src_reg<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">/* source register */</span>
    __s16    off<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* signed offset */</span>
    __s32    imm<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/* signed immediate constant */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每一个 eBPF 程序都是由若干个 bpf 指令构成，就是一个一个 <code>bpf_insn</code> 数组，使用 bpf 系统调用将其载入内核。</p>
<h5 id="把-BPF-字节码装载到内核空间"><a href="#把-BPF-字节码装载到内核空间" class="headerlink" title="把 BPF 字节码装载到内核空间"></a>把 BPF 字节码装载到内核空间</h5><p>接着调用 <code>bpf_load_program</code>，填入的参数为程序类型 <code>prog_type</code>, 和虚拟机指令 <code>insns_cnt</code> 等。</p>
<p>如果判断 events 是 <code>kprobe/kretprobe</code>，那么填充 buf 为 debugfs 相关路径。打开该路径，然后调用 <code>sys_perf_event_open ioctl</code> 设置等，这个和 strace 追踪到的调用过程基本一致。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">load_and_attach</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> <span class="token keyword">struct</span> bpf_insn <span class="token operator">*</span>prog<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool is_socket <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"socket"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    fd <span class="token operator">=</span> <span class="token function">bpf_load_program</span><span class="token punctuation">(</span>prog_type<span class="token punctuation">,</span> prog<span class="token punctuation">,</span> insns_cnt<span class="token punctuation">,</span> license<span class="token punctuation">,</span> kern_version<span class="token punctuation">,</span>
                            bpf_log_buf<span class="token punctuation">,</span> BPF_LOG_BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>is_kprobe <span class="token operator">||</span> is_kretprobe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                bool need_normal_check <span class="token operator">=</span> true<span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>event_prefix <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>is_kprobe<span class="token punctuation">)</span>
                        event <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                        event <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>event <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"event name cannot be empty\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span><span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token function">populate_prog_array</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __x86_64__</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"sys_"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%c:__x64_%s __x64_%s"</span><span class="token punctuation">,</span>
                                is_kprobe <span class="token operator">?</span> <span class="token string">'p'</span> <span class="token punctuation">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        err <span class="token operator">=</span> <span class="token function">write_kprobe_events</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                need_normal_check <span class="token operator">=</span> false<span class="token punctuation">;</span>
                                event_prefix <span class="token operator">=</span> <span class="token string">"__x64_"</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>need_normal_check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%c:%s %s"</span><span class="token punctuation">,</span>
                                is_kprobe <span class="token operator">?</span> <span class="token string">'p'</span> <span class="token punctuation">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        err <span class="token operator">=</span> <span class="token function">write_kprobe_events</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed to create kprobe '%s' error '%s'\n"</span><span class="token punctuation">,</span>
                                       event<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> DEBUGFS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"events/kprobes/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> event_prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"/id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        efd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>efd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed to open event %s\n"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>efd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> err <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read from '%s' failed '%s'\n"</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">close</span><span class="token punctuation">(</span>efd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        buf<span class="token punctuation">[</span>err<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        attr<span class="token punctuation">.</span>config <span class="token operator">=</span> id<span class="token punctuation">;</span>

        efd <span class="token operator">=</span> <span class="token function">sys_perf_event_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token comment" spellcheck="true">/*pid*/</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token comment" spellcheck="true">/*cpu*/</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token comment" spellcheck="true">/*group_fd*/</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        event_fd<span class="token punctuation">[</span>prog_cnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> efd<span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>efd<span class="token punctuation">,</span> PERF_EVENT_IOC_ENABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        err <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>efd<span class="token punctuation">,</span> PERF_EVENT_IOC_SET_BPF<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>bpf_load_program</code> 会通过 <code>BPF_PROG_LOAD</code> 系统调用，将字节码传入内核，返回一个文件描述符 <code>fd</code>，<code>attr-&gt;insns</code> 就是下面这种 bpf 字节码：</p>
<pre><code>code=BPF_ALU64|BPF_X|BPF_MOV, dst_reg=BPF_REG_6, src_reg=BPF_REG_1, off=0, imm=0</code></pre><p><code>kernel/bpf/syscall.c</code> 中定义的相应系统调用如下：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>bpf<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token keyword">union</span> bpf_attr __user <span class="token operator">*</span><span class="token punctuation">,</span> uattr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BPF_MAP_CREATE<span class="token punctuation">:</span>
                err <span class="token operator">=</span> <span class="token function">map_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> BPF_PROG_LOAD<span class="token punctuation">:</span>
        err <span class="token operator">=</span> <span class="token function">bpf_prog_load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//attr包含字节码</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而 <code>bpf_prog_load</code> 真正的加载 bpf 字节码，首先从 bpf 字节码中获得 license，判断是不是 GPL license。</p>
<p>然后分配内核 <code>bpf_prog</code> 程序数据结构空间，将 bpf 虚拟机指令从用户空间拷贝到内核空间，把指令保存在 <code>struct bpf_prog</code> 结构体中。</p>
<p>然后运行 <code>bpf_check</code> 验证 bpf 指令在注入内核是否安全，比如检查栈是否会溢出，除数是否为零，否则不检测安不安全容易造成内核 panic 等严重问题，这一部分内容很多，就暂时不分析了。</p>
<h4 id="把-BPF-字节码翻译为机器码"><a href="#把-BPF-字节码翻译为机器码" class="headerlink" title="把 BPF 字节码翻译为机器码"></a>把 BPF 字节码翻译为机器码</h4><p>验证通过之后，核心调用是运行 <code>bpf_prog_select_runtime</code> 里的 <code>do_jit</code> 把 bpf 字节码转换成机器汇编码，最后运行 <code>bpf_prog_kallsyms_add</code> 将机器汇编码添加到 <code>kallsyms</code>，在 <code>/proc/kallsyms</code> 中会看到 bpf 程序的符号表：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bpf_prog_load</span><span class="token punctuation">(</span><span class="token keyword">union</span> bpf_attr <span class="token operator">*</span>attr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">enum</span> bpf_prog_type type <span class="token operator">=</span> attr<span class="token operator">-></span>prog_type<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> bpf_prog <span class="token operator">*</span>prog<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>
        <span class="token keyword">char</span> license<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        bool is_gpl<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">/* copy eBPF program license from user space */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncpy_from_user</span><span class="token punctuation">(</span>license<span class="token punctuation">,</span> <span class="token function">u64_to_user_ptr</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>license<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>license<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//拷贝license attr->license</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        license<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>license<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//最后一位设空字符</span>

        <span class="token comment" spellcheck="true">/* eBPF programs must be GPL compatible to use GPL-ed functions */</span>
        is_gpl <span class="token operator">=</span> <span class="token function">license_is_gpl_compatible</span><span class="token punctuation">(</span>license<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* plain bpf_prog allocation */</span>
        prog <span class="token operator">=</span> <span class="token function">bpf_prog_alloc</span><span class="token punctuation">(</span><span class="token function">bpf_prog_size</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>insn_cnt<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_USER<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 分配内核 bpf_prog 程序数据结构空间 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prog<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

        prog<span class="token operator">-></span>expected_attach_type <span class="token operator">=</span> attr<span class="token operator">-></span>expected_attach_type<span class="token punctuation">;</span>

        prog<span class="token operator">-></span>aux<span class="token operator">-></span>offload_requested <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>attr<span class="token operator">-></span>prog_ifindex<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">security_bpf_prog_alloc</span><span class="token punctuation">(</span>prog<span class="token operator">-></span>aux<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> free_prog_nouncharge<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">bpf_prog_charge_memlock</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> free_prog_sec<span class="token punctuation">;</span>

        prog<span class="token operator">-></span>len <span class="token operator">=</span> attr<span class="token operator">-></span>insn_cnt<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>prog<span class="token operator">-></span>insns<span class="token punctuation">,</span> <span class="token function">u64_to_user_ptr</span><span class="token punctuation">(</span>attr<span class="token operator">-></span>insns<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">bpf_prog_insn_size</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//将若干指令从用户态拷贝到内核态</span>
                <span class="token keyword">goto</span> free_prog<span class="token punctuation">;</span>

        prog<span class="token operator">-></span>orig_prog <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        prog<span class="token operator">-></span>jited <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prog<span class="token operator">-></span>aux<span class="token operator">-></span>refcnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prog<span class="token operator">-></span>gpl_compatible <span class="token operator">=</span> is_gpl <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置gpl_compatible字段</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">/* run eBPF verifier */</span>
        err <span class="token operator">=</span> <span class="token function">bpf_check</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prog<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//运行verifier 检查字节码安全性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> free_used_maps<span class="token punctuation">;</span>

        prog <span class="token operator">=</span> <span class="token function">bpf_prog_select_runtime</span><span class="token punctuation">(</span>prog<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//这里调用do_jit 将bpf字节码转换成汇编码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> free_used_maps<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">bpf_prog_alloc_id</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> free_used_maps<span class="token punctuation">;</span>

        <span class="token function">bpf_prog_kallsyms_add</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//添加kallsyms</span>

        err <span class="token operator">=</span> <span class="token function">bpf_prog_new_fd</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">bpf_prog_put</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="运行-BPF-机器码"><a href="#运行-BPF-机器码" class="headerlink" title="运行 BPF 机器码"></a>运行 BPF 机器码</h4><p>JIT 编译器将机器汇编码的首地址转换成一个函数指针，保存到 <code>prog-&gt;bpf_func</code>，再看看哪里调用 <code>prog-&gt;bpf_func</code> 这个函数指针的呢？</p>
<p>在 debugfs 中创建 kprobe events，执行 <code>init_kprobe_trace</code> 加载 BPF 字节码的时候就调用了 <code>trace_kprobe_create</code> 继而调用 <code>kprobe_dispatcher</code>，因为定义了 <code>CONFIG_PERF_EVENTS</code> 而后调用 kprobe_perf_func，相关代码如下：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> dyn_event_operations trace_kprobe_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>create <span class="token operator">=</span> trace_kprobe_create<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>show <span class="token operator">=</span> trace_kprobe_show<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>is_busy <span class="token operator">=</span> trace_kprobe_is_busy<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>free <span class="token operator">=</span> trace_kprobe_release<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>match <span class="token operator">=</span> trace_kprobe_match<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* Make a tracefs interface for controlling probe points */</span>
<span class="token keyword">static</span> __init <span class="token keyword">int</span> <span class="token function">init_kprobe_trace</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        ret <span class="token operator">=</span> <span class="token function">dyn_event_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trace_kprobe_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">register_module_notifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trace_kprobe_module_nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        d_tracer <span class="token operator">=</span> <span class="token function">tracing_init_dentry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>d_tracer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        entry <span class="token operator">=</span> <span class="token function">tracefs_create_file</span><span class="token punctuation">(</span><span class="token string">"kprobe_events"</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">,</span> d_tracer<span class="token punctuation">,</span>
                                <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>kprobe_events_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">fs_initcall</span><span class="token punctuation">(</span>init_kprobe_trace<span class="token punctuation">)</span><span class="token punctuation">;</span>

trace_kprobe_create
<span class="token punctuation">{</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   kprobe_dispatcher
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">kprobe_dispatcher</span><span class="token punctuation">(</span><span class="token keyword">struct</span> kprobe <span class="token operator">*</span>kp<span class="token punctuation">,</span> <span class="token keyword">struct</span> pt_regs <span class="token operator">*</span>regs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> trace_kprobe <span class="token operator">*</span>tk <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>kp<span class="token punctuation">,</span> <span class="token keyword">struct</span> trace_kprobe<span class="token punctuation">,</span> rp<span class="token punctuation">.</span>kp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">raw_cpu_inc</span><span class="token punctuation">(</span><span class="token operator">*</span>tk<span class="token operator">-></span>nhit<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trace_probe_test_flag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tk<span class="token operator">-></span>tp<span class="token punctuation">,</span> TP_FLAG_TRACE<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">kprobe_trace_func</span><span class="token punctuation">(</span>tk<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PERF_EVENTS</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trace_probe_test_flag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tk<span class="token operator">-></span>tp<span class="token punctuation">,</span> TP_FLAG_PROFILE<span class="token punctuation">)</span><span class="token punctuation">)</span>
                ret <span class="token operator">=</span> <span class="token function">kprobe_perf_func</span><span class="token punctuation">(</span>tk<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>kprobe_perf_func</code> 会调用 <code>trace_call_bpf</code>，在这里会执行 bpf 程序。<code>BPF_PROG_RUN_ARRAY_CHECK</code> 是一个宏，其实质上执行 <code>BPF_PROG_RUN</code> 里的一个函数：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Kprobe profile handler */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">kprobe_perf_func</span><span class="token punctuation">(</span><span class="token keyword">struct</span> trace_kprobe <span class="token operator">*</span>tk<span class="token punctuation">,</span> <span class="token keyword">struct</span> pt_regs <span class="token operator">*</span>regs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bpf_prog_array_valid</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> orig_ip <span class="token operator">=</span> <span class="token function">instruction_pointer</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

                ret <span class="token operator">=</span> <span class="token function">trace_call_bpf</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">/*
* We need to check and see if we modified the pc of the
* pt_regs, and if so return 1 so that we don't do the
* single stepping.
*/</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>orig_ip <span class="token operator">!=</span> <span class="token function">instruction_pointer</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token operator">/</span> <span class="token operator">*</span> trace_call_bpf <span class="token operator">-</span> invoke BPF program
 <span class="token operator">*</span> @call<span class="token punctuation">:</span> tracepoint event
 <span class="token operator">*</span> @ctx<span class="token punctuation">:</span> opaque context pointer
 <span class="token operator">*</span>
 <span class="token operator">*</span> kprobe handlers execute BPF programs via this helper<span class="token punctuation">.</span>
 <span class="token operator">*</span> Can be used from <span class="token keyword">static</span> tracepoints in the future<span class="token punctuation">.</span>
 <span class="token operator">*</span>
 <span class="token operator">*</span> Return<span class="token punctuation">:</span> BPF programs always <span class="token keyword">return</span> an integer which is interpreted by
 <span class="token operator">*</span> kprobe handler as<span class="token punctuation">:</span>
 <span class="token operator">*</span> <span class="token number">0</span> <span class="token operator">-</span> <span class="token keyword">return</span> from <span class="token function">kprobe</span> <span class="token punctuation">(</span>event is filtered out<span class="token punctuation">)</span>
 <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">-</span> store kprobe event into ring buffer
 <span class="token operator">*</span> Other values are reserved and currently alias to <span class="token number">1</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">trace_call_bpf</span><span class="token punctuation">(</span><span class="token keyword">struct</span> trace_event_call <span class="token operator">*</span>call<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ret <span class="token operator">=</span> <span class="token function">BPF_PROG_RUN_ARRAY_CHECK</span><span class="token punctuation">(</span>call<span class="token operator">-></span>prog_array<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> BPF_PROG_RUN<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//运行bpf程序</span>

out<span class="token punctuation">:</span>
        <span class="token function">__this_cpu_dec</span><span class="token punctuation">(</span>bpf_prog_active<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中的 <code>trace_event_call</code> 结构体定义了 <code>bpf_prog_array</code>，该结构体数组中包含了要执行的函数指针：</p>
<pre><code>struct trace_event_call {
        struct list_head        list;
        struct trace_event_class *class;
        union {
                char                        *name;
                /* Set TRACE_EVENT_FL_TRACEPOINT flag when using "tp" */
                struct tracepoint        *tp;
        };
        ... ...
#ifdef CONFIG_PERF_EVENTS
        int                                perf_refcount;
        struct hlist_head __percpu        *perf_events;
        struct bpf_prog_array __rcu        *prog_array;

        int        (*perf_perm)(struct trace_event_call *,
                                struct perf_event *);
#endif
};

struct bpf_prog_array {
        struct rcu_head rcu;
        struct bpf_prog_array_item items[0];
};

struct bpf_prog_array_item {
        struct bpf_prog *prog;
        struct bpf_cgroup_storage *cgroup_storage[MAX_BPF_CGROUP_STORAGE_TYPE];
};</code></pre><p><code>BPF_PROG_RUN_ARRAY_CHECK</code>， <code>BPF_PROG_RUN</code> 宏展开如下所示，实质是在 <code>BPF_PROG_RUN</code> 中调用 <code>ret = (*(prog)-&gt;bpf_func)(ctx, (prog)-&gt;insnsi)</code> 这个函数指针来执行 bpf 指令：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> BPF_PROG_RUN_ARRAY_CHECK(array, ctx, func)        \
        __BPF_PROG_RUN_ARRAY(array, ctx, func, true)</span>


<span class="token macro property">#<span class="token directive keyword">define</span> __BPF_PROG_RUN_ARRAY(array, ctx, func, check_non_null)        \
        ({                                                \
                struct bpf_prog_array_item *_item;        \
                struct bpf_prog *_prog;                 \
                struct bpf_prog_array *_array;                \
                u32 _ret = 1;                                \
                preempt_disable();                        \
                rcu_read_lock();                        \
                _array = rcu_dereference(array);        \
                if (unlikely(check_non_null &amp;&amp; !_array))\
                        goto _out;                        \
                _item = &amp;_array->items[0];                \
                while ((_prog = READ_ONCE(_item->prog))) {                \
                        bpf_cgroup_storage_set(_item->cgroup_storage);        \
                        _ret &amp;= func(_prog, ctx);        \
                        _item++;                        \
                }                                        \
_out:                                                        \
                rcu_read_unlock();                        \
                preempt_enable();                        \
                _ret;                                        \
         })</span>



<span class="token macro property">#<span class="token directive keyword">define</span> BPF_PROG_RUN(prog, ctx) ({                                \
        u32 ret;                                                \
        cant_sleep();                                                \
        if (static_branch_unlikely(&amp;bpf_stats_enabled_key)) {        \
                struct bpf_prog_stats *stats;                        \
                u64 start = sched_clock();                        \
                ret = (*(prog)->bpf_func)(ctx, (prog)->insnsi); \
                stats = this_cpu_ptr(prog->aux->stats);         \
                u64_stats_update_begin(&amp;stats->syncp);                \
                stats->cnt++;                                        \
                stats->nsecs += sched_clock() - start;                \
                u64_stats_update_end(&amp;stats->syncp);                \
        } else {                                                \
                ret = (*(prog)->bpf_func)(ctx, (prog)->insnsi); \
        }                                                        \
        ret; })</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io" rel="external nofollow noreferrer">杰克成</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jackhcc.github.io/posts/ebpf-learning.html">https://jackhcc.github.io/posts/ebpf-learning.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/EBPF/">
                                    <span class="chip bg-color">EBPF</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/aliqr.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/reward/wxqr.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '3821a0bbb773038a51fc',
        clientSecret: '4b30b507d67ec5497ec0e77f43f80cb3e0d7dd3a',
        repo: 'JackHCC.github.io',
        owner: 'JackHCC',
        admin: "JackHCC",
        id: '2021-07-28T01-45-56',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/blog-python13.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/14.jpg" class="responsive-img" alt="Python-Scipy详解">
                        
                        <span class="card-title">Python-Scipy详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            SciPy基本使用
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Python/" class="post-category">
                                    Python
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/SciPy/">
                        <span class="chip bg-color">SciPy</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/ebpf-plan.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/medias/featureimages/2.jpg" class="responsive-img" alt="从零开始的内核ebpf开发之旅">
                        
                        <span class="card-title">从零开始的内核ebpf开发之旅</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            从零开始的学习内核ebpf
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux-Kernel/" class="post-category">
                                    Linux Kernel
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/EBPF/">
                        <span class="chip bg-color">EBPF</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://jackhcc.github.io" target="_blank">杰克成</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">3591.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "2";
                    var startDate = "27";
                    var startHour = "6";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/JackHCC" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jackcc0701@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100046343443643" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100046343443643" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/JackChe66021834" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/JackChe66021834" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2508074836" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2508074836" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/6885584679" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/6885584679" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/8f8482f01f0d6a04e844efe32e0f0710" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/js/matery.js"></script>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); }
    </script>

    <!-- weather -->
	<script type="text/javascript">
	WIDGET = {FID: 'TToslpmkVO'}
	</script>
	<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

    
    
    <script async src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/kqhlkxviiccyoa0czpfpu4ijuey9hfre.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JackHCC/JackHCC.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'your_domain' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>

